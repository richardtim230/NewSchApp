<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Saved AI Lectures | OAU ExamGuard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- Tailwind & Flowbite -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdn.jsdelivr.net/npm/flowbite@2.3.0/dist/flowbite.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/flowbite@2.3.0/dist/flowbite.min.js"></script>
  <link rel="icon" href="logo.png">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
  <style>
    body {
      background: linear-gradient(135deg, #eef2ff 0%, #e0e7ff 100%);
      min-height: 100vh;
      font-family: 'Segoe UI', 'Arial', sans-serif;
    }
    .topic-chip {
      transition: background 0.2s, color 0.2s, box-shadow 0.2s;
      cursor: pointer;
      user-select: none;
      background: #6366f1;
      color: #fff;
      border-radius: .85rem;
      padding: 0.7em 1.2em;
      margin-bottom: 0.6em;
      font-weight: 600;
      box-shadow: 0 2px 8px #6366f133;
      display: flex;
      align-items: center;
      gap: 0.7em;
    }
    .topic-chip:hover, .topic-chip.active {
      background: linear-gradient(90deg,#6366f1,#3b82f6);
      color: #fff;
      box-shadow: 0 4px 20px #6366f144;
    }
    .note-modal-content {
      max-width: 720px;
      margin: auto;
      background: #fff;
      border-radius: 1.25rem;
      box-shadow: 0 8px 36px #6366f133;
      padding: 2em;
      overflow-y: auto;
    }
    @media (max-width: 600px) {
      .note-modal-content {
        max-width: 98vw;
        padding: 1em 0.3em;
      }
    }
    .note-label {
      background: linear-gradient(90deg, #e0e7ff 60%, #fff 100%);
      padding: 0.3em 1em;
      border-radius: 0.8em;
      font-size: 1.1em;
      margin-bottom: 1em;
      color: #6366f1;
      font-weight: 600;
      box-shadow: 0 1px 6px #6366f124;
      display: inline-block;
    }
    .meta-data {
      font-size: 0.95em;
      color: #64748b;
      margin-bottom: 1.2em;
    }
  </style>
</head>
<body>
  <nav class="bg-white border-b border-indigo-100 py-4 shadow sticky top-0 z-40">
    <div class="max-w-5xl mx-auto flex items-center justify-between px-4">
      <a href="student_dashoard.html" class="flex items-center gap-2 text-indigo-700 font-bold text-lg">
        <i class="fas fa-arrow-left"></i> Dashboard
      </a>
      <h1 class="text-2xl font-extrabold text-indigo-900 tracking-tight drop-shadow-lg">Saved AI Lectures</h1>
      <div></div>
    </div>
  </nav>
  <main class="max-w-5xl mx-auto p-4 pt-6">
    <div id="lectureList" class="mt-6"></div>
  </main>
  <!-- Modal for showing full note -->
  <div id="noteModal" tabindex="-1" aria-hidden="true" class="fixed top-0 left-0 right-0 z-50 hidden w-full h-full items-center justify-center bg-black bg-opacity-30">
    <div class="note-modal-content">
      <div class="flex justify-between items-center mb-3">
        <h2 id="modalTopic" class="text-2xl font-bold text-indigo-800"></h2>
        <button type="button" id="closeModalBtn" class="text-2xl text-indigo-400 hover:text-indigo-700 bg-indigo-50 rounded-full w-8 h-8 flex items-center justify-center shadow-sm" aria-label="Close">
          &times;
        </button>
      </div>
      <div id="modalMeta" class="meta-data"></div>
      <div id="modalLabel" class="note-label"></div>
      <div id="modalIntro" class="mt-3 mb-5 text-indigo-900 font-medium"></div>
      <div id="modalQuote" class="mb-5 italic text-indigo-600"></div>
      <div id="modalFlashcards" class="mb-6"></div>
      <div id="modalOutlines"></div>
      <div id="modalSummary" class="mt-8"></div>
      <div id="modalExamTips" class="mt-2"></div>
      <div id="modalQuestions" class="mt-2"></div>
    </div>
  </div>
  <script>
    // --- Authentication check ---
    function ensureLoggedIn() {
      // Example: check for token (adapt to your auth system)
      const token = localStorage.getItem("token");
      if (!token) {
        window.location.href = "/mock-icthallb";
      }
    }
    ensureLoggedIn();

    // --- Utility for formatting ---
    function formatDate(dateStr) {
      if (!dateStr) return "";
      const d = new Date(dateStr);
      return d.toLocaleDateString() + " " + d.toLocaleTimeString();
    }

    // --- Load saved lectures ---
    function getSavedLectures() {
      try {
        return JSON.parse(localStorage.getItem("savedLectures")) || [];
      } catch {
        return [];
      }
    }

    // --- Render topic chips ---
    function renderLectureList() {
      const listDiv = document.getElementById("lectureList");
      const lectures = getSavedLectures();
      if (!lectures.length) {
        listDiv.innerHTML = `
          <div class="bg-white border border-indigo-200 rounded-xl p-8 text-center shadow text-indigo-700 font-medium">
            <i class="fas fa-book-open text-3xl mb-2 text-indigo-400"></i><br>
            No saved AI lectures yet.<br>
            Go to <a href="ai-lecture.html" class="text-indigo-600 underline">AI Study Assistant</a> to save notes!
          </div>
        `;
        return;
      }
      // Group by topic (latest first)
      const uniqueTopics = [];
      const topicMap = {};
      for (let i = lectures.length-1; i >=0; i--) {
        const lec = lectures[i];
        if (!topicMap[lec.topic]) {
          topicMap[lec.topic] = lec;
          uniqueTopics.push(lec.topic);
        }
      }
      listDiv.innerHTML = `<div class="mb-4 font-semibold text-indigo-900 text-lg">Click a topic to view your note:</div>`;
      uniqueTopics.forEach(topic => {
        const lec = topicMap[topic];
        // Get a nice icon for topic (randomly pick or use AI)
        const icon = '<i class="fas fa-lightbulb"></i>';
        listDiv.innerHTML += `
          <button class="topic-chip w-full text-left" data-topic="${encodeURIComponent(topic)}">
            ${icon}
            <span class="flex-1">${topic}</span>
            <span class="text-xs bg-indigo-100 text-indigo-700 rounded px-2 py-1">${lec.date} ${lec.time}</span>
          </button>
        `;
      });
      // Attach listeners
      setTimeout(() => {
        document.querySelectorAll('.topic-chip').forEach(btn => {
          btn.onclick = () => {
            const topic = decodeURIComponent(btn.getAttribute('data-topic'));
            showLectureModal(topic);
          };
        });
      }, 80);
    }

    // --- Modal logic ---
    function showLectureModal(topic) {
      const lectures = getSavedLectures();
      const record = lectures.reverse().find(l => l.topic === topic);
      if (!record) return;
      const data = record.lecture;

      document.getElementById("modalTopic").textContent = record.topic;
      document.getElementById("modalMeta").textContent = `Saved on: ${record.date} ${record.time}`;
      document.getElementById("modalLabel").textContent = "AI Lecture Note";
      document.getElementById("modalIntro").textContent = data.introduction || "";
      document.getElementById("modalQuote").textContent = data.introQuote ? `“${data.introQuote}”` : "";

      // Flashcards (if any)
      const flashDiv = document.getElementById("modalFlashcards");
      if (data.flashcards && data.flashcards.length) {
        flashDiv.innerHTML = `<div class="font-bold text-indigo-900 mb-2">Flashcards:</div>
          <div class="flex flex-wrap gap-2 mb-3">` +
          data.flashcards.map(card =>
            `<div class="bg-indigo-50 border border-indigo-200 rounded-lg px-3 py-2 shadow text-indigo-900 font-semibold mb-2">
              <span>${card.term}</span>
              <span class="block text-indigo-600 text-sm">${card.def}</span>
            </div>`
          ).join('')
          + '</div>';
      } else {
        flashDiv.innerHTML = '';
      }

      // Outlines & Notes
      const outlinesDiv = document.getElementById("modalOutlines");
      outlinesDiv.innerHTML = '';
      if (data.outlines && data.notes) {
        data.outlines.forEach((outline, idx) => {
          outlinesDiv.innerHTML += `
            <div class="mt-5">
              <div class="font-bold text-lg text-indigo-700 mb-2 flex items-center gap-2">
                <i class="fas fa-circle-dot text-xs text-indigo-400"></i>
                ${outline}
              </div>
              <div class="bg-white border border-indigo-100 rounded-lg p-4 note-content shadow">
                ${data.notes[outline]}
              </div>
            </div>
          `;
        });
      }

      // Summary
      document.getElementById("modalSummary").innerHTML = data.summary ?
        `<div class="font-bold text-indigo-900 mb-1 mt-5">Summary:</div>
         <div class="bg-indigo-50 rounded-lg p-3 text-indigo-800">${data.summary}</div>` : "";

      // Exam Tips
      document.getElementById("modalExamTips").innerHTML = (data.examTips && data.examTips.length) ?
        `<div class="font-bold text-indigo-900 mb-1 mt-4">Exam Tips:</div>
         <ul class="list-disc pl-5 text-indigo-700 mb-2">${data.examTips.map(tip => `<li>${tip}</li>`).join('')}</ul>` : "";

      // Likely exam questions
      document.getElementById("modalQuestions").innerHTML = (data.likelyExamQuestions && data.likelyExamQuestions.length) ?
        `<div class="font-bold text-indigo-900 mb-1 mt-4">Likely Exam Questions:</div>
         <ul class="list-decimal pl-6 text-indigo-700 mb-2">${data.likelyExamQuestions.map(q => `<li>${q}</li>`).join('')}</ul>` : "";

      // Show modal
      const modal = document.getElementById("noteModal");
      modal.classList.remove("hidden");
      modal.classList.add("flex");
      document.body.style.overflow = "hidden";
    }
    document.getElementById("closeModalBtn").onclick = function() {
      document.getElementById("noteModal").classList.add("hidden");
      document.getElementById("noteModal").classList.remove("flex");
      document.body.style.overflow = "";
    };
    // Hide modal on outside click
    document.getElementById("noteModal").addEventListener("click", function(e) {
      if (e.target === this) {
        this.classList.add("hidden");
        this.classList.remove("flex");
        document.body.style.overflow = "";
      }
    });

    // --- INIT ---
    window.addEventListener("DOMContentLoaded", renderLectureList);
  </script>
</body>
</html>
