<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Past Questions Uploader Admin | ExamGuard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://fonts.googleapis.com/css?family=Inter:400,500,700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.quilljs.com/1.3.7/quill.snow.css">
  <link rel="icon" href="logo.png">
  <style>
    html, body {
      min-height: 100%;
      height: 100%;
      margin: 0;
      padding: 0;
      font-family: 'Inter', Arial, sans-serif;
      background: linear-gradient(135deg, #f3f4f6 0%, #e0e7ff 100%);
      color: #23366e;
      font-size: 1rem;
      letter-spacing: 0.01em;
      box-sizing: border-box;
      width: 100vw;
      overflow-x: hidden;
    }
    * {
      box-sizing: inherit;
      max-width: 100%;
    }
    a { color: #6366f1; text-decoration: none; }

    /* Sidebar styles */
    .sidebar {
      background: linear-gradient(180deg, #1e3a8a, #3b82f6);
      width: 240px;
      height: 100vh;
      position: fixed;
      left: 0; top: 0; bottom: 0;
      display: flex; flex-direction: column;
      z-index: 20;
      box-shadow: 2px 0 12px #3b82f144;
      color: #fff;
      transition: left 0.3s;
    }
    .sidebar.closed {
      left: -260px;
    }
    .sidebar-header {
      display: flex; align-items: center;
      padding: 30px 20px 20px 20px;
      border-bottom: 1px solid #23366e;
    }
    .sidebar-header img {
      width: 48px; height: 48px; border-radius: 11px; margin-right: 12px;
      background: #fff;
      object-fit: contain;
      border: 2px solid #ffe06677;
      box-shadow: 0 4px 16px #001c3c33;
    }
    .sidebar-header .brand {
      font-weight: bold; font-size: 1.23em; color: #ffe066;
      letter-spacing: 0.04em;
      text-shadow: 0 2px 7px #ffe06628;
    }
    .sidebar-nav {
      flex: 1 1 auto;
      display: flex; flex-direction: column;
      padding: 18px 0;
      gap: 2px;
    }
    @media (max-width: 650px) {
  .sidebar.closed {
    left: -100vw !important;
  }
    }
    .sidebar-nav a {
      color: #bdeaff;
      text-decoration: none;
      padding: 13px 26px 13px 24px;
      font-size: 1em;
      border-left: 4px solid transparent;
      transition: background 0.18s, color 0.18s, border 0.18s;
      display: flex; align-items: center; gap: 14px;
      border-radius: 0 18px 18px 0;
      margin-right: 8px;
      font-weight: 500;
    }
    .sidebar-nav a.active, .sidebar-nav a:hover {
      background: linear-gradient(90deg, #172559 80%, #1d2b68 100%);
      color: #ffe066;
      border-left: 4px solid #ffe066;
      box-shadow: 0 1.5px 7px #ffe06622;
      font-weight: 700;
    }
    .sidebar-footer {
      padding: 18px 22px 16px 22px;
      border-top: 1px solid #23366e;
      font-size: 1em;
      color: #ffe066;
      background: #1e3a8a;
      letter-spacing: 0.02em;
    }
    /* Hamburger */
    .hamburger {
      display: none;
      position: fixed;
      right: 12px; top: 18px;
      background: #1e3a8a;
      border: none;
      color: #ffe066;
      font-size: 2em;
      z-index: 15;
      cursor: pointer;
      border-radius: 7px;
      width: 44px;
      height: 44px;
      align-items: center;
      justify-content: center;
      transition: background 0.2s;
    }
    .hamburger:active, .hamburger:hover {
      background: #6366f1;
      color: #fff;
    }

    /* Main content styles */
    .main-content {
      margin-left: 240px;
      min-height: 100vh;
      background: linear-gradient(135deg, #f3f4f6 0%, #e0e7ff 100%);
      transition: margin-left 0.3s;
      padding-bottom: 30px;
      width: calc(100vw - 240px);
      overflow-x: hidden;
    }
    .main-content.full {
      margin-left: 0;
      width: 100vw;
    }

    .topbar {
      background: linear-gradient(90deg,#1e3a8a 0%,#6366f1 100%);
      display: flex; align-items: center; justify-content: space-between;
      padding: 22px 32px 16px 32px;
      box-shadow: 0 2px 18px #3b82f144;
      width: 100%;
      position: sticky; top: 0; z-index: 10;
      min-height: 70px;
      box-sizing: border-box;
    }
    .page-title {
      font-size: 1.35em; font-weight: bold;
      color: #ffe066;
      letter-spacing: 0.04em;
      text-shadow: 0 3px 10px #ffe06615;
      margin-right: 22px;
      white-space: nowrap;
      overflow: hidden;
    }
    .admin-avatar {
      display: flex; align-items: center; gap: 14px;
    }
    .admin-avatar img {
      width: 44px; height: 44px; border-radius: 50%; object-fit: cover; border: 2.5px solid #ffe066;
      box-shadow: 0 2px 12px #ffe06633;
    }
    .admin-avatar span {
      font-size: 1.09em;
      font-weight: 600;
      color: #fff;
    }
    /* Section */
    .section {
      background: #fff;
      border-radius: 18px;
      box-shadow: 0 2px 16px #3a86ff18;
      padding: 38px 32px 38px 32px;
      margin-bottom: 34px;
      margin-right: 14px;
      margin-left: 14px;
      position: relative;
      width: 96vw;
      max-width: 1200px;
      overflow-x: auto;
      box-sizing: border-box;
    }
    .section-title {
      font-size: 1.21em;
      font-weight: 650;
      color: #6366f1;
      margin-bottom: 20px;
      letter-spacing: 0.03em;
      word-break: break-word;
    }
    .btn {
      padding: 11px 21px; background: linear-gradient(90deg,#6366f1 0%,#3b82f6 100%);
      color: #fff; border: none; border-radius: 8px;
      font-size: 1.07em; cursor: pointer; font-weight: 600;
      box-shadow: 0 2px 8px #6366f155;
      transition: background 0.17s, color 0.17s, box-shadow 0.18s;
      outline: none;
      margin: 3px 0;
      width: auto;
      max-width: 100%;
      white-space: nowrap;
      position: relative;
    }
    .btn:hover {
      background: linear-gradient(90deg,#ffe066 0%,#ffc300 100%);
      color: #1e3a8a;
      box-shadow: 0 4px 16px #ffe06644;
    }
    .btn .spinner {
      display: inline-block;
      vertical-align: middle;
      width: 18px;
      height: 18px;
      border: 2.5px solid #fff;
      border-top: 2.5px solid #6366f1;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-left: 10px;
      margin-bottom: 2px;
    }
    @keyframes spin {
      0% { transform: rotate(0deg);}
      100% { transform: rotate(360deg);}
    }
    .data-table {
      width: 100%; border-collapse: collapse; margin-top: 12px;
      font-size: 1em; background: #e0e7ff;
      border-radius: 8px; overflow: hidden;
      box-shadow: 0 2px 12px #6366f122;
      min-width: 600px;
      max-width: 100%;
      word-break: break-word;
    }
    .data-table th, .data-table td {
      padding: 13px 10px; text-align: left; border-bottom: 1px solid #6366f1;
      vertical-align: top;
      word-break: break-word;
      max-width: 300px;
    }
    .data-table th { background: #6366f1; color: #fff; font-weight: 600; font-size: 1.01em; }
    .data-table tr:last-child td { border-bottom: none; }
    .data-table tbody tr:hover { background: #e0e7ff; transition: background 0.13s; }
    .modal-backdrop {
      position: fixed; top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(99,102,241,0.15); z-index: 5000;
      display: flex; align-items: center; justify-content: center;
      transition: background 0.2s;
      padding: 2vw;
      overflow-y: auto;
      width: 100vw;
      height: 100vh;
    }
    .modal {
      background: #fff; color: #23366e; border-radius: 16px;
      box-shadow: 0 10px 40px 0 #6366f133;
      max-width: 560px; width: 98vw; padding: 33px 28px 18px 28px;
      text-align: left; position: relative;
      border: 2.5px solid #6366f166;
      max-height: 97vh;
      display: flex; flex-direction: column;
      gap: 17px;
      overflow-y: auto;
      box-sizing: border-box;
    }
    .close-modal {
      position: absolute; top: 11px; right: 17px; border: none;
      background: none; color: #6366f1; font-size: 2em; cursor: pointer; font-weight: bold;
      opacity: 0.67; transition: opacity 0.18s;
    }
    .close-modal:hover { opacity: 1; color: #ff4e55; }
    .modal h2 {
      font-size: 1.17em; color: #3b82f6; margin-bottom: 9px; font-weight: 700;
      letter-spacing: 0.02em;
    }
    .modal label {
      font-size: 0.97em; color: #23366e; margin-top: 7px; margin-bottom: 3px; font-weight: 500;
      display: block;
    }
    .modal input, .modal select, .modal textarea {
      padding: 10px 12px; border-radius: 8px; border: 1.5px solid #dde2ee;
      font-size: 1em; color: #23366e; background: #f3f4f6;
      margin-bottom: 11px; width: 100%; box-sizing: border-box;
      transition: border 0.19s, background 0.19s;
      outline: none;
    }
    .modal input:focus, .modal select:focus, .modal textarea:focus {
      border: 1.5px solid #6366f1; background: #fff;
    }
    .modal textarea { min-height: 45px; resize: vertical; }
    .modal .btn {
      margin-top: 9px;
      width: 100%;
    }
    .quill-editor {
      background: #fff;
      border-radius: 8px;
      box-shadow: 0 2px 8px #6366f122;
      margin-bottom: 9px;
      min-width: 0;
    }
    .quill-toolbar {
      background: #f3f4f6;
      border-radius: 8px 8px 0 0;
    }
    .success-msg { color: #22c55e; font-weight: 600; }
    .error-msg { color: #d32f2f; font-weight: 600; }
    /* Responsive styles */
    @media (max-width: 900px) {
      .sidebar { width: 180px; min-width: 100px; }
      .main-content { margin-left: 0; width: 100vw; }
      .topbar { padding: 16px 6vw 12px 6vw; flex-direction: column; align-items: flex-start; gap: 11px;}
      .section { margin-right: 0; margin-left: 2px; padding: 20px 2vw 18px 2vw; width: 98vw;}
      .modal { max-width: 96vw; }
      .data-table { min-width: 320px; font-size: 0.97em;}
    }
    @media (max-width: 650px) {
      .sidebar {
        position: fixed; left: -100vw; width: 88vw; min-width: 0; transition: left 0.3s;
        height: 100vh;
      }
      .sidebar.open { left: 0; }
      .main-content { margin-left: 0; width: 100vw; }
      .topbar { padding: 12px 4vw 9px 4vw; font-size: 1em;}
      .section { margin-right: 0; margin-left: 0; padding: 12px 1vw 12px 1vw; width: 99vw;}
      .modal { max-width: 99vw; }
      .hamburger { display: flex; }
    }
    @media (max-width: 480px) {
      .sidebar { width: 100vw; left: -100vw;}
      .sidebar.open { left: 0; }
      .main-content { margin-left: 0; width: 100vw;}
      .topbar { flex-direction: column; padding: 10px 2vw 8px 2vw;}
      .section { margin-left: 0; margin-right: 0; padding: 8px 1vw 8px 1vw; max-width: 100vw;}
      .modal { max-width: 100vw;}
      .data-table { font-size: 0.93em;}
    }
    /* Hide scrollbars on mobile for aesthetics */
    ::-webkit-scrollbar { width: 6px; background: #e0e7ff; }
    ::-webkit-scrollbar-thumb { background: #6366f1; border-radius: 7px; }
  </style>
</head>
<body>
  <!-- Hamburger for mobile -->
  <button class="hamburger" id="hamburger" aria-label="Open Menu" onclick="toggleSidebar()">&#9776;</button>

  <!-- Sidebar -->
  <nav class="sidebar closed" id="sidebar">
    <div class="sidebar-header">
      <img src="logo.png" alt="ExamGuard Logo">
      <span class="brand">Past Q Admin</span>
    </div>
    <div class="sidebar-nav">
      <a href="#dashboard" class="active" onclick="showSection('dashboard', this);closeSidebarOnMobile()"><span>üè†</span> Dashboard</a>
      <a href="#pastquestions" onclick="showSection('pastquestions', this);closeSidebarOnMobile()"><span>üìö</span> Past Questions</a>
      <a href="#profile" onclick="showSection('profile', this);closeSidebarOnMobile()"><span>üë§</span> Profile</a>
      <a href="student-dashoards.html" class="switch-account" onclick="closeSidebarOnMobile()">üîÑ Switch Account</a>
    </div>
    <div class="sidebar-footer">
      <span style="font-size:1.08em;" id="adminRole"></span><br>
      <a href="#" onclick="logout()" style="color:#ffe066; text-decoration:underline;font-size:0.97em;">Logout</a>
    </div>
  </nav>

  <div class="main-content full" id="mainContent">
    <!-- Topbar -->
    <div class="topbar">
      <span class="page-title" id="pageTitle">Past Questions Admin</span>
      <div class="admin-avatar">
        <img src="admin.png" alt="Admin" id="adminAvatar">
        <span id="adminName">Admin</span>
      </div>
    </div>
    <!-- Dashboard Welcome -->
    <div class="section" id="dashboardSection">
      <div class="section-title">Welcome, <span id="welcomeName">Admin</span>!</div>
      <p>
        Use this dashboard to upload, edit, and manage Past Questions for students.<br>
        <ul>
          <li>Upload rich-formatted questions with images and explanations.</li>
          <li>Organize questions by subject, year, <b>course code</b>, and topic.</li>
          <li>Bulk upload using JSON file or paste (see "Bulk Upload" button).</li>
          <li>Review, edit, and delete questions efficiently.</li>
          <li>Contact superadmin for advanced settings.</li>
        </ul>
      </p>
    </div>
    <!-- Past Questions Section -->
    <div class="section" id="pastquestionsSection" style="display:none;">
      <div class="section-title">Manage Past Questions</div>
      <div class="actions" style="margin-bottom: 12px; display: flex; gap: 10px; flex-wrap:wrap;">
        <button class="btn" onclick="openModal('addPastQModal')" id="addQuestionBtn">+ Add Past Question</button>
        <button class="btn" onclick="openModal('bulkUploadModal')" id="bulkUploadBtn">Bulk Upload (JSON)</button>
      </div>
      <div style="overflow-x:auto;">
        <table class="data-table" id="pastQuestionsTable">
          <thead>
            <tr>
              <th>Subject</th>
              <th>Year</th>
              <th>Course Code</th>
              <th>Question</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
    <!-- Profile Section -->
    <div class="section" id="profileSection" style="display:none;">
      <div class="section-title">Your Profile</div>
      <div style="display:flex;align-items:center;gap:28px;flex-wrap:wrap;">
        <img src="admin.png" id="profileAvatar" style="width:74px;height:74px;border-radius:50%;object-fit:cover;border:3px solid #ffe066;">
        <div>
          <div style="font-size:1.09em;font-weight:600;" id="profileName"></div>
          <div style="margin-bottom:7px;">Role: <b id="profileRole">Admin</b></div>
        </div>
      </div>
      <div style="margin-top:20px;">
        <label>Email</label>
        <input value="" id="profileEmail" disabled style="width:97%;padding:11px 8px;font-size:1.03em;border-radius:7px;border:none;margin-bottom:10px;">
        <label>Username</label>
        <input value="" id="profileUsername" disabled style="width:97%;padding:11px 8px;font-size:1.03em;border-radius:7px;border:none;margin-bottom:10px;">
      </div>
    </div>
    <div id="modalRoot"></div>
  </div>
  <!-- Quill JS -->
  <script src="https://cdn.quilljs.com/1.3.7/quill.js"></script>
  <script>
    // ========== CONFIG ==========
    const API_URL = "https://examguide.onrender.com/api/";
    const token = localStorage.getItem("token");
    let admin = {};
    let pastQuestions = [];

    // ========== AUTH & PROFILE ==========
    async function fetchAdminProfile() {
      if (!token) return window.location.href = "index.html";
      const resp = await fetch(API_URL + "auth/me", { headers: { Authorization: "Bearer " + token } });
      if (!resp.ok) { localStorage.removeItem("token"); window.location.href = "mock.html"; return; }
      admin = await resp.json();
      if (!admin || !admin.user || (admin.user.role !== "pq-uploader" && admin.user.role !== "superadmin")) {
        alert("Unauthorized.");
        window.location.href = "mock-icthallb";
        return;
      }
      admin = admin.user;
      document.getElementById("adminName").innerText = admin.fullname || admin.username || "-";
      document.getElementById("welcomeName").innerText = admin.fullname || admin.username || "-";
      document.getElementById("profileName").innerText = admin.fullname || admin.username || "-";
      document.getElementById("profileUsername").value = admin.username || "";
      document.getElementById("profileEmail").value = admin.email || "";
      document.getElementById("adminAvatar").src = admin.profilePic || "admin.png";
      document.getElementById("profileAvatar").src = admin.profilePic || "admin.png";
      document.getElementById("profileRole").innerText = admin.role.charAt(0).toUpperCase() + admin.role.slice(1);
      document.getElementById("adminRole").innerText = admin.role.charAt(0).toUpperCase() + admin.role.slice(1);
    }

    // ========== PAST QUESTIONS ==========
    async function fetchPastQuestions() {
      const resp = await fetch(API_URL + "past-questions/admin/all", {
        headers: { Authorization: "Bearer " + token }
      });
      pastQuestions = await resp.json();
      let html = "";
      (pastQuestions || []).forEach(q => {
        html += `<tr>
          <td>${q.subject}</td>
          <td>${q.year}</td>
          <td>${q.courseCode || '-'}</td>
          <td>${q.text?.replace(/(<([^>]+)>)/gi, "")?.slice(0,60) || "..."}</td>
          <td style="white-space:nowrap;">
            <button class="btn" style="padding:3px 13px;font-size:0.96em;" onclick="editPastQuestion('${q._id}')">Edit</button>
            <button class="btn" style="padding:3px 13px;font-size:0.96em;background:#ffe066;color:#1e3a8a;" onclick="deletePastQuestion('${q._id}', this)">Delete</button>
          </td>
        </tr>`;
      });
      document.querySelector("#pastQuestionsTable tbody").innerHTML = html;
    }
    function editPastQuestion(id) {
      alert("In production, this will open a modal with the Quill editor prefilled for editing.");
    }
    async function deletePastQuestion(id, btn) {
      if (!confirm("Delete this past question?")) return;
      setBtnLoading(btn, true);
      await fetch(API_URL + "past-questions/" + id, {
        method: "DELETE",
        headers: { Authorization: "Bearer " + token }
      });
      setBtnLoading(btn, false);
      fetchPastQuestions();
    }

    // ========== MODALS ==========
    function openModal(type) {
      let html = "";
      if (type === "addPastQModal") {
        html = `
          <div class="modal-backdrop" onclick="closeModal(event)">
            <div class="modal" onclick="event.stopPropagation()">
              <button class="close-modal" onclick="closeModal(event)">&times;</button>
              <h2>Add Past Question</h2>
              <label>Subject</label>
              <input id="subject" type="text" placeholder="e.g. Mathematics" required>
              <label>Year</label>
              <input id="year" type="text" placeholder="e.g. 2024" required>
              <label>Course Code</label>
              <input id="courseCode" type="text" placeholder="e.g. MTH106" required>
              <label>Topic (Optional)</label>
              <input id="topic" type="text" placeholder="e.g. Algebra">
              <label>Tags (comma separated)</label>
              <input id="tags" type="text" placeholder="e.g. theory, calculation">
              <label>Question Text (Rich Format)</label>
              <div id="quillEditor" class="quill-editor"></div>
              <label>Image (optional)</label>
              <input id="questionImage" type="file" accept="image/*">
              <label>Options</label>
              <input id="optionA" type="text" placeholder="Option A" required>
              <input id="optionB" type="text" placeholder="Option B" required>
              <input id="optionC" type="text" placeholder="Option C" required>
              <input id="optionD" type="text" placeholder="Option D" required>
              <label>Correct Answer</label>
              <select id="correctAnswer">
                <option value="A">A</option>
                <option value="B">B</option>
                <option value="C">C</option>
                <option value="D">D</option>
              </select>
              <label>Explanation (Rich Format, Optional)</label>
              <div id="quillExplanation" class="quill-editor"></div>
              <span id="addPastQMsg"></span>
              <button class="btn" id="addPastQBtn" onclick="submitAddPastQuestion()">Add<span class="spinner" style="display:none"></span></button>
            </div>
          </div>`;
      }
      if (type === "bulkUploadModal") {
        html = `
          <div class="modal-backdrop" onclick="closeModal(event)">
            <div class="modal" onclick="event.stopPropagation()">
              <button class="close-modal" onclick="closeModal(event)">&times;</button>
              <h2>Bulk Upload Questions (JSON)</h2>
              <label>Upload JSON File</label>
              <input id="bulkJsonFile" type="file" accept=".json">
              <div style="text-align:center; margin: 12px 0; color: #6366f1; font-weight: 600;">OR</div>
              <label>Paste JSON Array Below</label>
              <textarea id="bulkJsonPaste" placeholder='[{"subject":"Mathematics", "year":"2024", "courseCode":"MTH106", ...}, ...]' style="min-height:120px;"></textarea>
              <span id="bulkUploadMsg"></span>
              <button class="btn" id="bulkUploadActionBtn" onclick="submitBulkUpload()">Upload<span class="spinner" style="display:none"></span></button>
              <div style="font-size:0.93em;color:#888;margin-top:9px;">
                Example JSON:<br>
                <code>
                  [
                    {"subject":"Mathematics","year":"2024","courseCode":"MTH106","text":"...","options":["a","b","c","d"],"correctAnswer":"a"}
                  ]
                </code>
              </div>
            </div>
          </div>
        `;
      }
      if (html) {
        document.getElementById("modalRoot").innerHTML = html;
        if (type === "addPastQModal") {
          window.pqQuill = new Quill('#quillEditor', {
            theme: 'snow',
            modules: { toolbar: [
              ['bold', 'italic', 'underline', 'strike'],
              [{'header': 1}, {'header': 2}],
              [{'list': 'ordered'}, {'list': 'bullet'}],
              ['link', 'image'], ['clean']]
            }
          });
          window.explQuill = new Quill('#quillExplanation', {
            theme: 'snow',
            modules: { toolbar: [
              ['bold', 'italic', 'underline'], ['list', 'bullet'], ['link', 'image'], ['clean']
            ]}
          });
        }
      }
    }
    function closeModal(e) {
      if (!e || e.target.classList.contains('modal-backdrop') || e.target.classList.contains('close-modal')) {
        document.getElementById("modalRoot").innerHTML = "";
      }
    }

    // Spinner helper
    function setBtnLoading(btn, isLoading) {
      if (!btn) return;
      let spinner = btn.querySelector('.spinner');
      if (!spinner) {
        spinner = document.createElement('span');
        spinner.className = "spinner";
        btn.appendChild(spinner);
      }
      spinner.style.display = isLoading ? "inline-block" : "none";
      btn.disabled = isLoading;
    }

    async function submitAddPastQuestion() {
      const btn = document.getElementById("addPastQBtn");
      setBtnLoading(btn, true);
      const subject = document.getElementById("subject").value.trim();
      const year = document.getElementById("year").value.trim();
      const courseCode = document.getElementById("courseCode").value.trim();
      const topic = document.getElementById("topic").value.trim();
      const tags = document.getElementById("tags").value.trim().split(",").map(t=>t.trim()).filter(Boolean);
      const text = window.pqQuill.root.innerHTML;
      const optionA = document.getElementById("optionA").value.trim();
      const optionB = document.getElementById("optionB").value.trim();
      const optionC = document.getElementById("optionC").value.trim();
      const optionD = document.getElementById("optionD").value.trim();
      const correctLetter = document.getElementById("correctAnswer").value;
      const options = [optionA, optionB, optionC, optionD];
      const correctAnswer = options["ABCD".indexOf(correctLetter)];
      const explanation = window.explQuill.root.innerHTML;
      const imageInput = document.getElementById("questionImage");
      const imageFile = imageInput && imageInput.files[0];

      const msg = document.getElementById("addPastQMsg");
      msg.innerText = "";
      if (!subject || !year || !courseCode || !text || options.some(o=>!o) || !correctAnswer) { msg.innerText = "All fields required!"; setBtnLoading(btn, false); return; }
      if (!options.includes(correctAnswer)) { msg.innerText = "Correct answer must match one of the options."; setBtnLoading(btn, false); return; }

      try {
        const formData = new FormData();
        formData.append("subject", subject);
        formData.append("year", year);
        formData.append("courseCode", courseCode);
        formData.append("topic", topic);
        formData.append("tags", JSON.stringify(tags));
        formData.append("text", text);
        formData.append("options", JSON.stringify(options));
        formData.append("correctAnswer", correctAnswer);
        formData.append("explanation", explanation);
        if (imageFile) formData.append("image", imageFile);

        const resp = await fetch(API_URL + "past-questions", {
          method: "POST",
          headers: { Authorization: "Bearer " + token },
          body: formData
        });

        let data;
        try {
          data = await resp.json();
        } catch {
          msg.innerText = "Server returned an invalid response.";
          setBtnLoading(btn, false);
          return;
        }

        if (!resp.ok) {
          msg.innerText = data.error || data.message || "Failed to add question.";
          setBtnLoading(btn, false);
          return;
        }
        msg.innerText = "Past Question added!";
        fetchPastQuestions();
        setTimeout(() => { closeModal(); }, 1200);
      } catch (err) {
        msg.innerText = "Network error. Please check your connection or try again.";
      }
      setBtnLoading(btn, false);
    }

    async function submitBulkUpload() {
      const input = document.getElementById("bulkJsonFile");
      const textarea = document.getElementById("bulkJsonPaste");
      const file = input.files[0];
      const msg = document.getElementById("bulkUploadMsg");
      const btn = document.getElementById("bulkUploadActionBtn");
      setBtnLoading(btn, true);
      msg.innerText = "";

      // Priority: file > textarea
      if (file) {
        const formData = new FormData();
        formData.append("jsonFile", file);

        msg.innerText = "Uploading...";
        const resp = await fetch(API_URL + "past-questions/bulk-upload", {
          method: "POST",
          headers: { Authorization: "Bearer " + token },
          body: formData
        });
        const data = await resp.json();
        if (!resp.ok) {
          msg.innerText = data.error || "Upload failed.";
          setBtnLoading(btn, false);
          return;
        }
        msg.innerText = data.message || "Upload successful!";
        fetchPastQuestions();
        setTimeout(() => { closeModal(); }, 1500);
        setBtnLoading(btn, false);
        return;
      }

      // If no file, try textarea
      if (textarea.value.trim()) {
        let jsonArr;
        try {
          jsonArr = JSON.parse(textarea.value);
          if (!Array.isArray(jsonArr)) throw new Error("Not an array");
        } catch (e) {
          msg.innerText = "Invalid JSON array pasted.";
          setBtnLoading(btn, false);
          return;
        }
        msg.innerText = "Uploading...";
        const resp = await fetch(API_URL + "past-questions/bulk-upload", {
          method: "POST",
          headers: {
            "Authorization": "Bearer " + token,
            "Content-Type": "application/json"
          },
          body: JSON.stringify(jsonArr)
        });
        const data = await resp.json();
        if (!resp.ok) {
          msg.innerText = data.error || "Upload failed.";
          setBtnLoading(btn, false);
          return;
        }
        msg.innerText = data.message || "Upload successful!";
        fetchPastQuestions();
        setTimeout(() => { closeModal(); }, 1500);
        setBtnLoading(btn, false);
        return;
      }

      msg.innerText = "Please select a JSON file or paste JSON.";
      setBtnLoading(btn, false);
    }

    // ========== NAV ==========
    function showSection(id, el) {
      document.querySelectorAll('.sidebar-nav a').forEach(a => a.classList.remove('active'));
      if (el) el.classList.add('active');
      document.getElementById('pageTitle').innerText = el ? el.textContent.trim() : id.charAt(0).toUpperCase() + id.slice(1);
      ['dashboard','pastquestions','profile'].forEach(sec => {
        document.getElementById(sec+'Section').style.display = (sec===id) ? "" : "none";
      });
      if (id === "pastquestions") fetchPastQuestions();
    }
    function logout() {
      localStorage.removeItem("token");
      window.location.href = "mock.html";
    }

    // ========== SIDEBAR TOGGLE FOR MOBILE ==========
    function toggleSidebar() {
      const sidebar = document.getElementById("sidebar");
      const mainContent = document.getElementById("mainContent");
      if (sidebar.classList.contains("open")) {
        sidebar.classList.remove("open");
        sidebar.classList.add("closed");
        mainContent.classList.add("full");
      } else {
        sidebar.classList.add("open");
        sidebar.classList.remove("closed");
        mainContent.classList.remove("full");
      }
    }
    function closeSidebarOnMobile() {
      if (window.innerWidth <= 900) {
        document.getElementById("sidebar").classList.remove("open");
        document.getElementById("sidebar").classList.add("closed");
        document.getElementById("mainContent").classList.add("full");
      }
    }
    // Automatically close sidebar on click outside (mobile)
    document.addEventListener("click", function(e) {
      const sidebar = document.getElementById("sidebar");
      const hamburger = document.getElementById("hamburger");
      if (
        sidebar.classList.contains("open") &&
        !sidebar.contains(e.target) &&
        !hamburger.contains(e.target)
      ) {
        closeSidebarOnMobile();
      }
    });
    // Responsive sidebar init
    function responsiveSidebarInit() {
      if (window.innerWidth <= 900) {
        document.getElementById("sidebar").classList.add("closed");
        document.getElementById("sidebar").classList.remove("open");
        document.getElementById("mainContent").classList.add("full");
        document.getElementById("hamburger").style.display = "flex";
      } else {
        document.getElementById("sidebar").classList.remove("closed");
        document.getElementById("sidebar").classList.remove("open");
        document.getElementById("mainContent").classList.remove("full");
        document.getElementById("hamburger").style.display = "none";
      }
    }
    window.addEventListener("resize", responsiveSidebarInit);

    // ========== INIT ==========
    async function init() {
      responsiveSidebarInit();
      await fetchAdminProfile();
      showSection('dashboard', document.querySelector('.sidebar-nav a.active'));
    }
    window.onload = init;
  </script>
</body>
</html>
