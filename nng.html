<!DOCTYPE html>
<html lang="en" class="h-full bg-gray-100">
<head>
  <meta charset="UTF-8">
  <title>OAU ExamGuard - Student Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Load jsPDF for image-to-PDF. Place in <head> or before your script: -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <!-- Flowbite (carousel etc) -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/flowbite/2.3.0/flowbite.min.css"/>
<!-- MESSAGES SECTION: Modern UI + Quill Editor + Attachments + 2s Polling -->
<link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    .sidebar-active {
      background: linear-gradient(90deg, #4f46e5 0%, #6366f1 100%) !important;
      color: #fff !important;
    }
    .sidebar-dot {
      width: 9px; height: 9px; background: #ef4444; border-radius: 100%; margin-left: 6px;
      display: inline-block; vertical-align: middle;
    }
    .carousel-container {
      max-height: 220px;
    }
    .hide-scrollbar::-webkit-scrollbar {
      display: none;
    }
  </style>
</head>
<body class="h-full bg-gray-100">
  <!-- DASHBOARD LOADING SPINNER OVERLAY -->
<div id="dashboardSpinnerOverlay" style="position:fixed;inset:0;background:rgba(255,255,255,0.95);z-index:10000;display:flex;align-items:center;justify-content:center;transition:opacity .3s;"
     class="spinner-visible">
  <div class="flex flex-col items-center">
    <!-- Tailwind spinner -->
    <svg class="animate-spin h-14 w-14 text-indigo-600 mb-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
      <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"/>
      <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"/>
    </svg>
    <div class="text-lg font-semibold text-indigo-700">Loading your dashboard...</div>
  </div>
</div>
  <script>
  // Show spinner overlay, hide after 8s and when DOM is ready
  document.addEventListener("DOMContentLoaded", function() {
    setTimeout(() => {
      const spinner = document.getElementById("dashboardSpinnerOverlay");
      if (spinner) spinner.style.opacity = "0";
      setTimeout(() => {
        if (spinner) spinner.style.display = "none";
      }, 320); // Fade-out
    }, 10000);
  });
</script>
  <!-- Mobile Overlay -->
  <div id="mobileDrawerOverlay" onclick="toggleMobileDrawer(false)" class="fixed inset-0 bg-black bg-opacity-40 z-40 hidden"></div>
  <!-- Mobile Sidebar -->
  <aside id="mobileSidebar"
    class="fixed z-50 top-0 left-0 bottom-0 w-64 bg-[#2852a0] text-white transform -translate-x-full md:hidden transition-transform duration-300 ease-in-out"
    style="background:linear-gradient(180deg,#2852a0 0%,#467ae6 100%);">
    <div class="h-full flex flex-col py-5">
      <div class="px-7 py-3 mb-2">
        <h2 class="font-bold text-2xl tracking-tight leading-tight mb-1">OAU ExamGuard</h2>
        <div class="text-xs text-white/80">Student Dashboard</div>
      </div>
      <nav class="mt-6 flex-1">
        <ul class="flex flex-col gap-3 text-base">
          <li><button class="sidebar-btn sidebar-active w-full py-2 px-7 rounded-l-full flex items-center gap-3" onclick="switchSection('overview',true)"><svg class="w-6 h-6" fill="none" stroke="currentColor"><circle cx="12" cy="12" r="10" stroke-width="2"/><path d="M12 8v4l3 3" stroke-width="2"/></svg>Dashboard</button></li>
          <li><button class="sidebar-btn w-full py-2 px-7 rounded-l-full flex items-center gap-3" onclick="switchSection('mocktests',true)"><svg class="w-6 h-6" fill="none" stroke="currentColor"><rect x="4" y="4" width="16" height="16" rx="2" stroke-width="2"/></svg>Mock Tests</button></li>
          <li><button class="sidebar-btn w-full py-2 px-7 rounded-l-full flex items-center gap-3" onclick="switchSection('pastquestions',true)"><svg class="w-6 h-6" fill="none" stroke="currentColor"><path d="M5 4h14M5 20h14M7 4v16M17 4v16" stroke-width="2"/></svg>Past Questions</button></li>
          <li><button class="sidebar-btn w-full py-2 px-7 rounded-l-full flex items-center gap-3" onclick="switchSection('taskscenter',true)"><svg class="w-6 h-6" fill="none" stroke="currentColor"><path d="M9 12l2 2l4 -4"/><rect x="2" y="2" width="20" height="20" rx="5" stroke-width="2"/></svg>Tasks Center</button></li>
          <li><button class="sidebar-btn w-full py-2 px-7 rounded-l-full flex items-center gap-3" onclick="switchSection('resources',true)"><svg class="w-6 h-6" fill="none" stroke="currentColor"><path d="M5 20h14M7 20V7a2 2 0 012-2h6a2 2 0 012 2v13" stroke-width="2"/></svg>Study Resources</button></li>
          <li><button class="sidebar-btn w-full relative py-2 px-7 rounded-l-full flex items-center gap-3" onclick="switchSection('messages',true)"><svg class="w-6 h-6" fill="none" stroke="currentColor"><path d="M21 10.5A8.38 8.38 0 013 10.5c0-5.25 7.5-9 9-9s9 3.75 9 9z"/><circle cx="12" cy="10" r="2"/></svg>Messages<span class="sidebar-dot absolute right-5 top-3"></span></button></li>
          <li><button class="sidebar-btn w-full py-2 px-7 rounded-l-full flex items-center gap-3" onclick="switchSection('settings',true)"><svg class="w-6 h-6" fill="none" stroke="currentColor"><circle cx="12" cy="8" r="4" stroke-width="2"/><path d="M6 20v-2a4 4 0 014-4h4a4 4 0 014 4v2" stroke-width="2"/></svg>Profile Settings</button></li>
          <li><button class="sidebar-btn w-full py-2 px-7 rounded-l-full flex items-center gap-3" onclick="switchSection('assignments',true)"><svg class="w-6 h-6" fill="none" stroke="currentColor"><path d="M4 7h16M4 17h16"/><rect x="2" y="2" width="20" height="20" rx="2" stroke-width="2"/></svg>Assignment</button></li>
          <li><button class="sidebar-btn w-full py-2 px-7 rounded-l-full flex items-center gap-3" onclick="switchSection('studyPadi',true)"><svg class="w-6 h-6" fill="none" stroke="currentColor"><rect x="3" y="4" width="18" height="14" rx="2"/><path d="M16 2v4M8 2v4"/></svg>My StudyPadi</button></li>
          <li><button class="sidebar-btn w-full relative py-2 px-7 rounded-l-full flex items-center gap-3" onclick="switchSection('broadcasts',true)"><svg class="w-6 h-6" fill="none" stroke="currentColor"><path d="M5 15h2a3 3 0 003-3V8m9 7a7 7 0 00-7-7"></path></svg>Broadcasts<span class="sidebar-dot absolute right-5 top-3"></span></button></li>
          <li><button class="sidebar-btn w-full py-2 px-7 rounded-l-full flex items-center gap-3" onclick="switchSection('logout',true)"><svg class="w-6 h-6" fill="none" stroke="currentColor"><path d="M17 16l4-4m0 0l-4-4m4 4H7"/></svg>Logout</button></li>
        </ul>
      </nav>
    </div>
  </aside>

<div>
  <!-- Desktop Sidebar (fixed, scrollable, overlays content only on direct interaction) -->
  <aside class="hidden md:flex fixed pt-20 top-0 left-0 h-full w-64 bg-gradient-to-b from-[#2852a0] to-[#467ae6] text-white flex-col border-r z-30" id="desktopSidebar" style="will-change: transform;">
    <div class="h-full flex flex-col overflow-y-auto">
      <div class="px-7 py-6 mb-2 border-b border-white/10">
        <h2 class="font-bold text-2xl tracking-tight leading-tight mb-1">OAU ExamGuard</h2>
        <div class="text-xs text-white/80">Student Dashboard</div>
      </div>
      <nav class="mt-6 flex-1">
        <ul class="flex flex-col gap-2 text-base" id="desktopSidebarList">
          <!-- Same sidebar buttons as mobile -->
          <li><button class="sidebar-btn sidebar-active w-full py-2 px-7 rounded-l-full flex items-center gap-3" onclick="switchSection('overview')"><svg class="w-6 h-6" fill="none" stroke="currentColor"><circle cx="12" cy="12" r="10" stroke-width="2"/><path d="M12 8v4l3 3" stroke-width="2"/></svg>Dashboard</button></li>
          <li><button class="sidebar-btn w-full py-2 px-7 rounded-l-full flex items-center gap-3" onclick="switchSection('mocktests')"><svg class="w-6 h-6" fill="none" stroke="currentColor"><rect x="4" y="4" width="16" height="16" rx="2" stroke-width="2"/></svg>Mock Tests</button></li>
          <li><button class="sidebar-btn w-full py-2 px-7 rounded-l-full flex items-center gap-3" onclick="switchSection('pastquestions')"><svg class="w-6 h-6" fill="none" stroke="currentColor"><path d="M5 4h14M5 20h14M7 4v16M17 4v16" stroke-width="2"/></svg>Past Questions</button></li>
          <li><button class="sidebar-btn w-full py-2 px-7 rounded-l-full flex items-center gap-3" onclick="switchSection('taskscenter')"><svg class="w-6 h-6" fill="none" stroke="currentColor"><path d="M9 12l2 2l4 -4"/><rect x="2" y="2" width="20" height="20" rx="5" stroke-width="2"/></svg>Tasks Center</button></li>
          <li><button class="sidebar-btn w-full py-2 px-7 rounded-l-full flex items-center gap-3" onclick="switchSection('resources')"><svg class="w-6 h-6" fill="none" stroke="currentColor"><path d="M5 20h14M7 20V7a2 2 0 012-2h6a2 2 0 012 2v13" stroke-width="2"/></svg>Study Resources</button></li>
          <li><button class="sidebar-btn w-full relative py-2 px-7 rounded-l-full flex items-center gap-3" onclick="switchSection('messages')"><svg class="w-6 h-6" fill="none" stroke="currentColor"><path d="M21 10.5A8.38 8.38 0 013 10.5c0-5.25 7.5-9 9-9s9 3.75 9 9z"/><circle cx="12" cy="10" r="2"/></svg>Messages<span class="sidebar-dot absolute right-5 top-3"></span></button></li>
          <li><button class="sidebar-btn w-full py-2 px-7 rounded-l-full flex items-center gap-3" onclick="switchSection('settings')"><svg class="w-6 h-6" fill="none" stroke="currentColor"><circle cx="12" cy="8" r="4" stroke-width="2"/><path d="M6 20v-2a4 4 0 014-4h4a4 4 0 014 4v2" stroke-width="2"/></svg>Profile Settings</button></li>
          <li><button class="sidebar-btn w-full py-2 px-7 rounded-l-full flex items-center gap-3" onclick="switchSection('assignments')"><svg class="w-6 h-6" fill="none" stroke="currentColor"><path d="M4 7h16M4 17h16"/><rect x="2" y="2" width="20" height="20" rx="2" stroke-width="2"/></svg>Assignment</button></li>
          <li><button class="sidebar-btn w-full py-2 px-7 rounded-l-full flex items-center gap-3" onclick="switchSection('studyPadi')"><svg class="w-6 h-6" fill="none" stroke="currentColor"><rect x="3" y="4" width="18" height="14" rx="2"/><path d="M16 2v4M8 2v4"/></svg>My StudyPadi</button></li>
          <li><button class="sidebar-btn w-full relative py-2 px-7 rounded-l-full flex items-center gap-3" onclick="switchSection('broadcasts')"><svg class="w-6 h-6" fill="none" stroke="currentColor"><path d="M5 15h2a3 3 0 003-3V8m9 7a7 7 0 00-7-7"></path></svg>Broadcasts<span class="sidebar-dot absolute right-5 top-3"></span></button></li>
          <li><button class="sidebar-btn w-full py-2 px-7 rounded-l-full flex items-center gap-3" onclick="switchSection('logout')"><svg class="w-6 h-6" fill="none" stroke="currentColor"><path d="M17 16l4-4m0 0l-4-4m4 4H7"/></svg>Logout</button></li>
        </ul>
      </nav>
    </div>
  </aside>


   <div class="md:ml-64 flex flex-col min-h-screen bg-gray-100">
<!-- Responsive Header Block (Mobile & Desktop, Profile Pic from JS) -->
<header
  class="fixed top-0 left-0 right-0 z-40 w-full bg-white border-b px-2 sm:px-4 md:px-8 py-3 flex items-center justify-between shadow-sm overflow-x-hidden"
>
  <div class="flex items-center gap-2 sm:gap-3">
    <button class="md:hidden rounded-full bg-indigo-600 p-2" onclick="toggleMobileDrawer(true)" aria-label="Open sidebar">
      <svg class="w-7 h-7 text-white" fill="none" stroke="currentColor"><path d="M4 6h16M4 12h16M4 18h16"/></svg>
    </button>
    <span class="font-bold text-lg md:text-2xl text-indigo-800">Student Dashboard</span>
  </div>
  <div class="flex items-center gap-3 sm:gap-4">
    <div class="relative w-24 xs:w-28 sm:w-36 md:w-64">
      <input type="text" placeholder="Search..." class="pl-10 pr-3 py-2 w-full rounded-lg border bg-gray-50 focus:outline-none focus:ring focus:border-blue-300 text-sm">
      <div class="absolute left-2 top-2 text-gray-400">
        <svg class="w-5 h-5" fill="none" stroke="currentColor"><circle cx="11" cy="11" r="8"/><path d="M21 21l-4.35-4.35"/></svg>
      </div>
    </div>
    <button type="button" id="notifBtn" class="relative">
      <svg class="w-7 h-7 text-gray-600 hover:text-blue-600" fill="none" stroke="currentColor">
        <path d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6 6 0 10-12 0v3.159c0 .538-.214 1.055-.595 1.436L4 17h5"/>
      </svg>
      <span id="notifBadge" class="absolute top-0 right-0 w-3 h-3 bg-red-500 rounded-full border border-white"></span>
    </button>
    <div class="relative">
      <button type="button" id="profileDropdownBtn">
        <img id="headerProfilePic" class="w-8 h-8 rounded-full border-2 border-indigo-600 object-cover" src="https://ui-avatars.com/api/?name=Student&background=ede9fe&color=3b82f6&size=128&rounded=true" alt="Profile">
      </button>
      <div id="profileDropdown" class="hidden absolute right-0 mt-2 w-48 bg-white rounded shadow-lg z-10">
        <a href="#" class="block px-4 py-2 text-gray-700 hover:bg-indigo-100" onclick="switchSection('profile')">Profile</a>
        <a href="#" class="block px-4 py-2 text-gray-700 hover:bg-indigo-100" onclick="switchSection('settings')">Settings</a>
        <a href="#" class="block px-4 py-2 text-gray-700 hover:bg-indigo-100" onclick="switchSection('logout')">Logout</a>
      </div>
    </div>
  </div>
</header>

<!-- Profile avatar JS update -->
<script>
// Universal profile picture helper
function getProfilePicUrl(student) {
  if (!student) return "https://ui-avatars.com/api/?name=Student&background=ede9fe&color=3b82f6&size=128&rounded=true";
  if (student.profilePic) {
    if (student.profilePic.startsWith("data:image")) return student.profilePic;
    if (student.profilePic.startsWith("http")) return student.profilePic;
    return window.location.origin + student.profilePic;
  }
  const name = encodeURIComponent(student.fullname || student.username || "Student");
  return `https://ui-avatars.com/api/?name=${name}&background=ede9fe&color=3b82f6&size=128&rounded=true`;
}

function updateHeaderProfilePic(student) {
  const img = document.getElementById("headerProfilePic");
  if (img) img.src = getProfilePicUrl(student);
}



// Example async loader
async function fetchStudentProfile() {
  try {
    const resp = await fetch('https://examguide.onrender.com/api/auth/me', { credentials: 'include' });
    const data = await resp.json();
    student = data.user; // Adjust if your API shape is different
    updateHeaderProfilePic(student);
    // More code to populate the rest of user details
  } catch (err) {
    console.error('Failed to fetch student profile:', err);
  }
}

// Ensure DOM is loaded before running code
document.addEventListener("DOMContentLoaded", function() {
  fetchStudentProfile();
});
</script>
 <main class="flex-1 p-2 md:p-3 bg-gray-100 overflow-x-auto hide-scrollbar pt-[70px] md:pt-[70px]">
        <!-- Main Sections -->
        <div id="overview-section" class="section-block">
          <!-- Carousel Section -->
            <div class="carousel-container w-full max-w-5xl mx-auto mb-4 rounded-xl overflow-hidden shadow-lg">
          <div id="adCarousel" class="relative" data-carousel="slide">
            <div class="relative h-[160px] md:h-[220px] overflow-hidden rounded-xl">
              <div class="duration-700 ease-in-out absolute inset-0 transition-all" data-carousel-item="active">
                <img src="oaugate-1140x570.jpg" class="w-full h-full object-cover" alt="Ad 1">
                <div class="absolute bottom-3 left-3 bg-black/60 px-4 py-1 rounded text-white text-sm hidden md:block">Get 50% Off on ExamGuard Resources! ðŸš€</div>
              </div>
              <div class="duration-700 ease-in-out absolute inset-0 transition-all" data-carousel-item>
                <img src="oaugate-1140x570.jpg" class="w-full h-full object-cover" alt="Ad 2">
                <div class="absolute bottom-3 left-3 bg-black/60 px-4 py-1 rounded text-white text-sm hidden md:block">Try Mock Tests for Free This Month!</div>
              </div>
              <div class="duration-700 ease-in-out absolute inset-0 transition-all" data-carousel-item>
                <img src="oaugate-1140x570.jpg" class="w-full h-full object-cover" alt="Ad 3">
                <div class="absolute bottom-3 left-3 bg-black/60 px-4 py-1 rounded text-white text-sm hidden md:block">Earn While You Learn: Join Blog & Earn!</div>
              </div>
            </div>
            <button type="button" class="absolute top-0 left-0 z-30 flex items-center justify-center h-full px-4 cursor-pointer group focus:outline-none" data-carousel-prev>
              <span class="inline-flex items-center justify-center w-10 h-10 rounded-full bg-white/70 group-hover:bg-white/90">
                <svg class="w-6 h-6 text-indigo-700" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M15 19l-7-7 7-7"></path></svg>
              </span>
            </button>
            <button type="button" class="absolute top-0 right-0 z-30 flex items-center justify-center h-full px-4 cursor-pointer group focus:outline-none" data-carousel-next>
              <span class="inline-flex items-center justify-center w-10 h-10 rounded-full bg-white/70 group-hover:bg-white/90">
                <svg class="w-6 h-6 text-indigo-700" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M9 5l7 7-7 7"></path></svg>
              </span>
            </button>
          </div>
        </div>
          <!-- Welcome + Motivation -->
          <div class="mb-4">
            <div class="bg-gradient-to-r from-indigo-500 to-indigo-600 text-white rounded-xl shadow flex flex-col md:flex-row justify-between items-center px-4 md:px-6 py-5">
              <div>
                <h2 class="text-2xl font-bold mb-1">Welcome back, Alex!</h2>
                <div class="text-md" id="motivation-message">You are capable of amazing things.</div>
              </div>
              <div class="mt-3 md:mt-0">
                <button onclick="randomMotivation()" class="bg-white/20 hover:bg-indigo-400 rounded px-4 py-2 font-semibold">Refresh Motivation</button>
              </div>
            </div>
          </div>

          <!-- Quick Links -->
          <div class="mb-5">
            <div class="bg-white rounded-xl shadow px-3 py-4 flex justify-center">
              <div class="w-full flex flex-wrap justify-center gap-3">
                <button class="flex flex-col items-center justify-center w-24 h-24 md:w-28 md:h-28 rounded-lg border border-indigo-200 bg-indigo-50 hover:bg-indigo-100 transition shadow-sm"
                  onclick="window.location.href='gen-marketplace.html'">
                  <svg class="w-8 h-8 mb-1 text-indigo-700" fill="none" stroke="currentColor">
                    <rect x="2" y="6" width="20" height="14" rx="3" stroke-width="2"/><path d="M10 10h4M10 14h2" stroke-width="2"/>
                  </svg>
                  <span class="text-xs md:text-sm font-semibold text-indigo-800 mt-1">Marketplace</span>
                </button>
                <button class="flex flex-col items-center justify-center w-24 h-24 md:w-28 md:h-28 rounded-lg border border-indigo-200 bg-indigo-50 hover:bg-indigo-100 transition shadow-sm"
                  onclick="window.location.href='#profile'">
                  <svg class="w-8 h-8 mb-1 text-indigo-700" fill="none" stroke="currentColor">
                    <circle cx="12" cy="8" r="4" stroke-width="2"/><path d="M6 20v-2a4 4 0 014-4h4a4 4 0 014 4v2" stroke-width="2"/>
                  </svg>
                  <span class="text-xs md:text-sm font-semibold text-indigo-800 mt-1">Account Settings</span>
                </button>
                <button class="flex flex-col items-center justify-center w-24 h-24 md:w-28 md:h-28 rounded-lg border border-indigo-200 bg-indigo-50 hover:bg-indigo-100 transition shadow-sm"
                  onclick="window.location.href='tutor-req.html'">
                  <svg class="w-8 h-8 mb-1 text-indigo-700" fill="none" stroke="currentColor">
                    <circle cx="12" cy="8" r="4" stroke-width="2"/><path d="M6 20v-2a4 4 0 014-4h4a4 4 0 014 4v2" stroke-width="2"/>
                  </svg>
                  <span class="text-xs md:text-sm font-semibold text-indigo-800 mt-1">Request For Tutor</span>
                </button>
                <button class="flex flex-col items-center justify-center w-24 h-24 md:w-28 md:h-28 rounded-lg border border-indigo-200 bg-indigo-50 hover:bg-indigo-100 transition shadow-sm"
                  onclick="window.location.href='earnings.html'">
                  <svg class="w-8 h-8 mb-1 text-indigo-700" fill="none" stroke="currentColor">
                    <rect x="6" y="10" width="12" height="8" rx="3" stroke-width="2"/><path d="M9 10v-2a3 3 0 116 0v2" stroke-width="2"/>
                  </svg>
                  <span class="text-xs md:text-sm font-semibold text-indigo-800 mt-1">Earnings Page</span>
                </button>
                <button class="flex flex-col items-center justify-center w-24 h-24 md:w-28 md:h-28 rounded-lg border border-indigo-200 bg-indigo-50 hover:bg-indigo-100 transition shadow-sm"
                  onclick="window.location.href='#'">
                  <svg class="w-8 h-8 mb-1 text-indigo-700" fill="none" stroke="currentColor">
                    <path d="M21 15V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2m7 4h3m-6-4h6" stroke-width="2"/>
                    <circle cx="8.5" cy="8.5" r="1.5" />
                  </svg>
                  <span class="text-xs md:text-sm font-semibold text-indigo-800 mt-1">Blog and Earn</span>
                </button>
              </div>
            </div>
          </div>

          <!-- Top Scorers & Stat Cards -->
          <div class="mb-6 flex flex-col md:flex-row gap-4 w-full">
<div class="bg-white rounded-xl shadow md:w-1/3 w-full p-6 flex flex-col mb-2 md:mb-0">
  <h2 class="text-lg font-bold mb-2 text-indigo-700">Top Scorers</h2>
  <div class="flex flex-col gap-4 w-full" id="topScorersList">
    <!-- Will be filled via JS -->
  </div>
</div>

<div class="grid grid-cols-2 md:grid-cols-3 gap-4 md:w-2/3 w-full">
  <!-- 1. Total Exams Taken -->
  <div class="bg-white rounded-xl shadow p-6 text-center flex flex-col justify-center">
    <span class="text-3xl font-bold mb-1 text-indigo-800 block" id="stat-total-exams">-</span>
    <div class="font-semibold text-gray-700">Total Exams Taken</div>
  </div>
  <!-- 2. Avg Score -->
  <div class="bg-white rounded-xl shadow p-6 text-center flex flex-col justify-center">
    <span class="text-3xl font-bold mb-1 text-indigo-800 block" id="stat-avg-score">-</span>
    <div class="font-semibold text-gray-700">Average Score</div>
  </div>
  <!-- 3. Total Available Exams -->
  <div class="bg-white rounded-xl shadow p-6 text-center flex flex-col justify-center">
    <span class="text-3xl font-bold mb-1 text-indigo-800 block" id="stat-available-exams">-</span>
    <div class="font-semibold text-gray-700">Total Available Exams</div>
  </div>
  <!-- 4. Scholarship/Internship Opportunity -->
  <div class="bg-white rounded-xl shadow p-6 text-center flex flex-col justify-center">
    <span class="text-3xl font-bold mb-1 text-indigo-800 block" id="stat-scholarship-oppty">-</span>
    <div class="font-semibold text-gray-700">Scholarship/Interns Opportunity</div>
  </div>
  <!-- 5. Total Credit Point -->
  <div class="bg-white rounded-xl shadow p-6 text-center flex flex-col justify-center">
    <span class="text-3xl font-bold mb-1 text-indigo-800 block" id="stat-credit-points">-</span>
    <div class="font-semibold text-gray-700">Total Credit Points</div>
  </div>
  <!-- 6. Total Score Points (From Tasks) -->
  <div class="bg-white rounded-xl shadow p-6 text-center flex flex-col justify-center">
    <span class="text-3xl font-bold mb-1 text-indigo-800 block" id="stat-task-points">-</span>
    <div class="font-semibold text-gray-700">Total Score Points (Tasks)</div>
  </div>
</div>

<script>
// Example: Plug in values after fetching data
async function updateStatsPanel() {
  // Example API fetch logic -- replace API_URL with your actual endpoint!
  const API_URL = "https://examguide.onrender.com/api/";
  const token = localStorage.getItem("token");
  let student, mockResults = [], totalAvailableExams = 0, totalCreditPoints = 0, totalTaskPoints = 0;
  let scholarshipChance = "-";
  try {
    // Get student
    const resp = await fetch(API_URL + "auth/me", {
      credentials: "include",
      headers: token ? { Authorization: "Bearer " + token } : {}
    });
    const data = await resp.json();
    student = data.user;

    // Get exam results
    let resultsResp = await fetch(API_URL + "results/user/" + student._id, {
      credentials: "include",
      headers: token ? { Authorization: "Bearer " + token } : {}
    });
    mockResults = await resultsResp.json();

    // Only mock/exam tests.
    const filteredResults = (mockResults||[]).filter(r => {
      // Adjust "examSet" and type detection as needed for your backend
      if (!r.examSet) return false;
      const et = typeof r.examSet === "object" ? (r.examSet.type || "").toLowerCase() : "";
      return et === "mock" || et === "mock test" ||
             et === "exam" ||
             (r.examSet.title && r.examSet.title.toLowerCase().match(/mock|exam/));
    });

    document.getElementById("stat-total-exams").textContent = filteredResults.length;

    // Average Score
    let avg = "-";
    if (filteredResults.length) {
      avg = Math.round(filteredResults.reduce((sum, r) => sum + (parseFloat(r.score) || 0), 0) / filteredResults.length);
      avg = avg + "%";
    }
    document.getElementById("stat-avg-score").textContent = avg;

    // Total Available Exams
    let examRes = await fetch(API_URL + "schedules", { credentials: "include", headers: token ? { Authorization: "Bearer " + token } : {} });
    let examData = await examRes.json();
    if (Array.isArray(examData)) totalAvailableExams = examData.length;
    else if (examData.schedules && Array.isArray(examData.schedules)) totalAvailableExams = examData.schedules.length;
    document.getElementById("stat-available-exams").textContent = totalAvailableExams;

    // Scholarship/Internship Opportunity (dummy logic - replace as needed)
    // Example: if avg score >= 70, opportunity is 85%, else 45%, or get from API!
    if (typeof(avg) === "string" && avg !== "-") {
      const avgNum = parseInt(avg);
      scholarshipChance = (avgNum >= 70 ? "85%" : "45%");
    }
    document.getElementById("stat-scholarship-oppty").textContent = scholarshipChance;

    // Total Credit Point: fetch same as tutor/mock.html logic
let totalCreditPoints = "-";
if (student) {
  if (typeof student.creditPoints !== "undefined" && student.creditPoints !== null)
    totalCreditPoints = student.creditPoints;
  else if (typeof student.credits !== "undefined" && student.credits !== null)
    totalCreditPoints = student.credits;
}
document.getElementById("stat-credit-points").textContent = totalCreditPoints;
    // Total Score Points (From Tasks)
    let tasksRes = await fetch(API_URL + "tasks/user/" + student._id, { credentials: "include", headers: token ? { Authorization: "Bearer " + token } : {} });
    let tasksData = await tasksRes.json();
    if (Array.isArray(tasksData)) {
      totalTaskPoints = tasksData.reduce((sum, t) => sum + (t.points||0), 0);
    }
    document.getElementById("stat-task-points").textContent = totalTaskPoints || "-";

  } catch(e) {
    // fallback
    ["stat-total-exams","stat-avg-score","stat-available-exams","stat-scholarship-oppty","stat-credit-points","stat-task-points"].forEach(id=>{
      if(document.getElementById(id))document.getElementById(id).textContent="-";
    });
  }
}
// run after DOM
document.addEventListener("DOMContentLoaded", updateStatsPanel);
</script>
          </div>

<div class="bg-white mb-5 rounded-lg p-6 shadow flex flex-col items-center w-full">
  <h3 class="text-lg font-bold mb-3 text-indigo-700 w-full text-left">Mock Test Scores</h3>
  <div class="w-full" style="min-height:220px;">
    <canvas id="mockScoreLineChart" height="180"></canvas>
  </div>
  <div class="mt-3 w-full text-sm text-gray-600 flex flex-wrap gap-6">
    <div><span class="font-semibold">Best Mock:</span> <span id="mockBestStat">-</span></div>
    <div><span class="font-semibold">Last Mock:</span> <span id="mockLastStat">-</span></div>
  </div>
</div>

<!-- Modern Chart.js Line Chart for Mock Scores (no animation) -->
<script>
document.addEventListener("DOMContentLoaded", function() {
  (async function() {
    const API_URL = "https://examguide.onrender.com/api/";
    const token = localStorage.getItem("token");
    let student = null;
    try {
      const resp = await fetch(API_URL + "auth/me", {
        credentials: "include",
        headers: token ? { Authorization: "Bearer " + token } : {}
      });
      const data = await resp.json();
      student = data.user;
    } catch (e) {}

    let resultsCache = [];
    if (student && student._id) {
      try {
        const resp = await fetch(API_URL + "results/user/" + student._id, {
          credentials: "include",
          headers: token ? { Authorization: "Bearer " + token } : {}
        });
        resultsCache = await resp.json();
      } catch (e) {}
    }

    // Only mock tests.
    const mockResults = (resultsCache||[]).filter(r => {
      if (!r.examSet) return false;
      const et = typeof r.examSet === "object" ? (r.examSet.type || "").toLowerCase() : "";
      return et === "mock" || et === "mock test" || (r.examSet.title && r.examSet.title.toLowerCase().includes("mock"));
    });
    const sorted = [...mockResults].sort((a, b) => new Date(a.submittedAt) - new Date(b.submittedAt));

    function shortLabel(res, idx) {
      if (!res.examSet) return "Mock " + (idx+1);
      let str = res.examSet.title || "";
      const word = str.split(' ').find(w => w.length > 0) || ("Mock " + (idx+1));
      return word.length > 16 ? word.slice(0,16) + "..." : word;
    }

    const labels = sorted.map((r, i) => 
      (r.submittedAt ? (shortLabel(r, i) + " (" + (new Date(r.submittedAt).toLocaleDateString('en-GB', {month:"short", day:"numeric"})) + ")")
                     : shortLabel(r, i))
    );
    const scores = sorted.map(r => r.score ?? 0);
    let best = {score:"-", examSet:{title:"-"}}, last = {score:"-", examSet:{title:"-"}};
    if (sorted.length) {
      best = sorted.reduce((acc, curr) => (curr.score > (acc.score??-1) ? curr : acc), sorted[0]);
      last = sorted[sorted.length-1];
    }
    function firstWord(str) {
      if (!str) return "-";
      const match = str.match(/^\w+/);
      return match ? match[0] : str;
    }
    if (document.getElementById("mockBestStat"))
      document.getElementById("mockBestStat").textContent = `${best.score ?? "-"}% (${firstWord(best.examSet?.title)})`;
    if (document.getElementById("mockLastStat"))
      document.getElementById("mockLastStat").textContent = `${last.score ?? "-"}% (${firstWord(last.examSet?.title)})`;

    // Draw line chart with animation disabled
    const chartElem = document.getElementById("mockScoreLineChart");
    if (window.Chart && chartElem) {
      const ctx = chartElem.getContext("2d");
      if (window.mockScoreLineChart && typeof window.mockScoreLineChart.destroy === "function") {
        window.mockScoreLineChart.destroy();
      }
      window.mockScoreLineChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: labels.length ? labels : ['No Data'],
          datasets: [{
            label: 'Score (%)',
            data: scores.length ? scores : [0],
            fill: false,
            borderColor: '#6366f1',
            backgroundColor: '#6366f1',
            tension: 0.28,
            pointRadius: 5,
            pointBackgroundColor: '#3b82f6',
            pointBorderColor: '#fff',
            pointHoverRadius: 7,
            pointHoverBackgroundColor: '#f59e42',
            pointHoverBorderColor: '#6366f1',
            borderWidth: 3
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {display: false},
            tooltip: {
              enabled: true,
              callbacks: {
                label: function(context) {
                  return `Score: ${context.parsed.y}%`;
                }
              }
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              max: 100,
              title: { display: true, text: "Percentage (%)" },
              ticks: { font: { weight: 'bold' } }
            },
            x: {
              title: { display: true, text: "Test" },
              grid: {display:false}
            }
          },
          animation: false // << disables the extending animation effect
        }
      });
    }
  })();
});
</script>
   
     <div class="flex flex-col md:flex-row gap-6 w-full">
  <!-- GPA Progress -->    
  <div class="bg-white rounded-lg p-6 shadow pt-10 mt-4 md:mt-0 max-w-xl w-full">
    <h3 class="text-lg font-bold mb-3 text-indigo-700">GPA Progress</h3>
    <canvas id="gpaChart" height="120"></canvas>
  </div>
<!-- Sliding News -->
<div class="bg-white rounded-lg p-6 shadow mt-4 md:mt-0 max-w-md w-full flex flex-col justify-between relative overflow-hidden">
  <h3 class="text-lg font-bold mb-3 text-indigo-700">Latest News</h3>
  <div class="relative w-full h-64 flex items-center justify-center">
    <div id="news-carousel" class="w-full h-full flex transition-all duration-500">
      <!-- News slides injected here by JS -->
    </div>
    <!-- Arrows -->
    <button id="news-prev" class="absolute left-1 top-1/2 -translate-y-1/2 bg-white/80 hover:bg-indigo-100 shadow rounded-full p-2 z-10">
      <svg class="w-6 h-6 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/></svg>
    </button>
    <button id="news-next" class="absolute right-1 top-1/2 -translate-y-1/2 bg-white/80 hover:bg-indigo-100 shadow rounded-full p-2 z-10">
      <svg class="w-6 h-6 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/></svg>
    </button>
  </div>
  <!-- Indicators -->
  <div id="news-indicators" class="w-full flex justify-center gap-2 mt-4"></div>
</div>
  </div>
        </div>
<script>
const NEWS_API = "https://examguide.onrender.com/api/posts/filter?category=General&limit=3";
let newsItems = [];
let currentNews = 0;

function renderNewsSlide(idx) {
  if (!newsItems[idx]) return "";
  const news = newsItems[idx];
  const descr =
      news.summary ||
      (news.content && news.content.length > 150 ? news.content.slice(0, 150) + "..." : news.content) ||
      "";
  return `
    <div class="w-full h-full flex flex-col items-center animate-fadeIn">
      <div class="w-full h-40 rounded-lg overflow-hidden mb-2 flex-shrink-0">
        <img src="${news.imageUrl || news.image || 'https://images.unsplash.com/photo-1506744038136-46273834b3fb?auto=format&fit=crop&w=500&q=80'}"
          alt="${news.title || "ExamGuard News"}" class="w-full h-full object-cover object-center transition-all duration-300"/>
      </div>
      <h4 class="text-md font-bold text-indigo-700 mb-1 mt-2">${news.title || "Untitled"}</h4>
      <p class="text-gray-600 text-sm line-clamp-2">${descr}</p>
      <a href="campus-news-update?id=${news._id || news.id}" class="mt-4 inline-block bg-indigo-50 text-indigo-700 font-semibold px-4 py-2 rounded hover:bg-indigo-700 hover:text-white transition">Read More</a>
    </div>
  `;
}

// Animate fade-in utility
(function(){
  const style = document.createElement('style');
  style.innerHTML = `
  @keyframes fadeIn {
    0% {opacity:0; transform: translateY(8px);}
    100% {opacity:1; transform: translateY(0);}
  }
  .animate-fadeIn { animation: fadeIn .6s; }
  .line-clamp-2 { display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;}
  `;
  document.head.appendChild(style);
})();

function updateNewsCarousel() {
  const carousel = document.getElementById("news-carousel");
  if (!carousel) return;
  if (!newsItems.length) {
    carousel.innerHTML = `<div class="w-full h-full flex items-center justify-center text-gray-400">No news yet.</div>`;
  } else {
    carousel.innerHTML = renderNewsSlide(currentNews);
  }

  // Indicators
  const indicators = document.getElementById("news-indicators");
  indicators.innerHTML = "";
  for (let i = 0; i < newsItems.length; i++) {
    indicators.innerHTML += `<span class="inline-block w-2 h-2 rounded-full mx-1 ${i===currentNews?'bg-indigo-600':'bg-gray-300'}"></span>`;
  }
}

async function fetchNews() {
  try {
    const res = await fetch(NEWS_API);
    if (res.ok) {
      const data = await res.json();
      if (Array.isArray(data)) {
        newsItems = data.slice(0, 3);
      } else if (Array.isArray(data.posts)) {
        newsItems = data.posts.slice(0, 3);
      } else {
        newsItems = [];
      }
    } else {
      newsItems = [];
    }
  } catch {
    newsItems = [];
  }
}

document.addEventListener("DOMContentLoaded", async () => {
  await fetchNews();
  updateNewsCarousel();
  document.getElementById("news-prev").onclick = function() {
    if (newsItems.length) {
      currentNews = (currentNews - 1 + newsItems.length) % newsItems.length;
      updateNewsCarousel();
    }
  };
  document.getElementById("news-next").onclick = function() {
    if (newsItems.length) {
      currentNews = (currentNews + 1) % newsItems.length;
      updateNewsCarousel();
    }
  };
});
</script>
      
<!-- TASKS CENTER SECTION -->
<div id="taskscenter-section" class="section-block hidden">
  <div class="max-w-6xl mx-auto py-10 px-2 md:px-6">
    <div class="flex flex-col md:flex-row md:items-center justify-between gap-4 mb-8">
      <div>
        <h2 class="text-3xl font-bold text-indigo-800">Tasks Center</h2>
        <p class="text-md text-gray-600 mt-1">Complete daily and weekly activities to boost your engagement, earn rewards, and develop your skills.</p>
      </div>
      <div class="flex gap-4">
        <button class="inline-flex items-center gap-2 bg-green-600 hover:bg-green-700 text-white px-5 py-2 rounded-lg font-semibold shadow transition" onclick="refreshTasks()">
          <svg class="w-5 h-5" fill="none" stroke="currentColor"><path d="M4 4v5h.582M20 20v-5h-.581M7 10l-2 2 2 2M17 14l2-2-2-2" stroke-width="2"></path></svg>
          Refresh Tasks
        </button>
      </div>
    </div>

    <!-- Progress Overview -->
    <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 gap-6 mb-10" id="task-stats-row">
      <div class="bg-gradient-to-r from-blue-500 to-indigo-600 text-white rounded-2xl shadow-lg flex flex-col items-center p-6">
        <div class="text-3xl font-bold mb-1" id="activeTasksCount">-</div>
        <div class="uppercase text-xs tracking-wider font-semibold">Tasks Active</div>
      </div>
      <div class="bg-gradient-to-r from-green-400 to-teal-500 text-white rounded-2xl shadow-lg flex flex-col items-center p-6">
        <div class="text-3xl font-bold mb-1" id="completedTasksCount">-</div>
        <div class="uppercase text-xs tracking-wider font-semibold">Completed</div>
      </div>
      <div class="bg-gradient-to-r from-yellow-400 to-orange-500 text-white rounded-2xl shadow-lg flex flex-col items-center p-6">
        <div class="text-3xl font-bold mb-1" id="overdueTasksCount">-</div>
        <div class="uppercase text-xs tracking-wider font-semibold">Overdue</div>
      </div>
      <div class="bg-gradient-to-r from-pink-500 to-purple-600 text-white rounded-2xl shadow-lg flex flex-col items-center p-6">
        <div class="text-3xl font-bold mb-1" id="pointsCount">-</div>
        <div class="uppercase text-xs tracking-wider font-semibold">Points</div>
      </div>
    </div>

    <!-- Tasks List: horizontally scrollable -->
    <div class="bg-white rounded-2xl shadow-lg overflow-x-auto">
      <table class="min-w-full text-sm divide-y divide-gray-200" id="tasksTable">
        <thead class="bg-indigo-50 font-bold text-indigo-800">
          <tr>
            <th class="px-6 py-3 text-left whitespace-nowrap">Task</th>
            <th class="px-6 py-3 text-left whitespace-nowrap">Description</th>
            <th class="px-6 py-3 text-left whitespace-nowrap">Activity Type</th>
            <th class="px-6 py-3 text-left whitespace-nowrap">Points</th>
            <th class="px-6 py-3 text-left whitespace-nowrap">Status</th>
            <th class="px-6 py-3 text-left whitespace-nowrap">Action</th>
          </tr>
        </thead>
        <tbody class="bg-white divide-y divide-gray-100" id="tasksTableBody">
          <!-- Populated dynamically -->
        </tbody>
      </table>
    </div>

    <!-- Pagination controls -->
    <div class="flex items-center justify-end gap-3 mt-4" id="tasksPaginationControls">
      <button id="tasksPrevBtn" class="bg-gray-200 px-3 py-1 rounded hover:bg-gray-300 font-bold" disabled>Previous</button>
      <span id="tasksPageInfo" class="text-gray-700">Page 1</span>
      <button id="tasksNextBtn" class="bg-gray-200 px-3 py-1 rounded hover:bg-gray-300 font-bold" disabled>Next</button>
    </div>
  </div>

  <!-- Article/Reading Modal -->
  <div class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center hidden" id="articleModal">
    <div class="bg-white rounded-xl shadow-2xl max-w-2xl w-full p-8 relative flex flex-col gap-6">
      <button class="absolute top-3 right-4 text-gray-500 hover:text-indigo-700 text-xl" onclick="closeArticleModal()">&times;</button>
      <div>
        <iframe id="articleFrame" src="" width="100%" height="400" frameborder="0" class="rounded mb-5"></iframe>
        <div id="articleDescription" class="text-gray-700 text-sm mt-2"></div>
      </div>
      <button id="articleMarkAsDoneBtn" class="bg-green-600 hover:bg-green-700 text-white font-semibold px-5 py-2 rounded-lg self-end transition flex gap-2 items-center" data-taskid="">
        <span>Mark as Done</span>
        <svg id="articleMarkAsDoneLoader" class="hidden animate-spin w-5 h-5" viewBox="0 0 24 24">
          <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" fill="none"></circle>
          <path class="opacity-75" fill="currentColor" d="M4 12A8 8 0 018 4v4a4 4 0 00-4 4z"></path>
        </svg>
      </button>
    </div>
  </div>

  <!-- Video Modal -->
  <div class="fixed inset-0 bg-black bg-opacity-60 z-50 flex items-center justify-center hidden" id="videoModal">
    <div class="bg-white rounded-xl shadow-2xl max-w-2xl w-full p-8 relative flex flex-col gap-6">
      <button class="absolute top-3 right-4 text-gray-500 hover:text-indigo-700 text-xl" onclick="closeVideoModal()">&times;</button>
      <div>
        <iframe id="videoFrame" width="100%" height="360" src="" frameborder="0" allowfullscreen class="rounded mb-5"></iframe>
        <div id="videoDescription" class="text-gray-700 text-sm mt-2"></div>
      </div>
      <button id="videoMarkAsDoneBtn" class="bg-green-600 hover:bg-green-700 text-white font-semibold px-5 py-2 rounded-lg self-end transition flex gap-2 items-center" data-taskid="">
        <span>Mark as Done</span>
        <svg id="videoMarkAsDoneLoader" class="hidden animate-spin w-5 h-5" viewBox="0 0 24 24">
          <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" fill="none"></circle>
          <path class="opacity-75" fill="currentColor" d="M4 12A8 8 0 018 4v4a4 4 0 00-4 4z"></path>
        </svg>
      </button>
    </div>
  </div>

  <!-- Assignment Modal -->
  <div class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center hidden" id="assignmentModal">
    <div class="bg-white rounded-xl shadow-2xl max-w-2xl w-full p-8 relative flex flex-col gap-6">
      <button class="absolute top-3 right-4 text-gray-500 hover:text-orange-700 text-xl" onclick="closeAssignmentModal()">&times;</button>
      <div id="assignmentModalContent" class="overflow-auto" style="max-height:60vh;">
        <div id="assignmentInstructions" class="text-gray-700 text-base mb-2"></div>
        <iframe id="assignmentFrame" src="" width="100%" height="320" frameborder="0" class="rounded mb-3 hidden"></iframe>
        <div id="assignmentDeadline" class="text-xs text-gray-500 mt-2"></div>
      </div>
      <button id="assignmentMarkAsDoneBtn" class="bg-green-600 hover:bg-green-700 text-white font-semibold px-5 py-2 rounded-lg self-end transition flex gap-2 items-center" data-taskid="">
        <span>Mark as Done</span>
        <svg id="assignmentMarkAsDoneLoader" class="hidden animate-spin w-5 h-5" viewBox="0 0 24 24">
          <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" fill="none"></circle>
          <path class="opacity-75" fill="currentColor" d="M4 12A8 8 0 018 4v4a4 4 0 00-4 4z"></path>
        </svg>
      </button>
    </div>
  </div>

  <script>
// =============== CONFIGURATION ===============
const TASK_TYPES = {
  reading: {
    display: "Reading",
    color: "green",
    modal: "article",
  },
  article: {
    display: "Article",
    color: "emerald",
    modal: "article",
  },
  video: {
    display: "Video",
    color: "pink",
    modal: "video",
  },
  mocktest: {
    display: "Mock Test",
    color: "indigo",
    // Action is just link, no modal, direct launch
  },
  social: {
    display: "Social",
    color: "blue"
    // Action is just link
  },
  assignment: {
    display: "Assignment",
    color: "orange",
    modal: "assignment"
  },
  goal: {
    display: "Goal",
    color: "teal"
    // Maybe just info
  },
  profile: {
    display: "Profile",
    color: "purple"
    // Just a button to update profile
  },
  custom: {
    display: "Custom",
    color: "gray"
    // Fallback link
  },
};
// ============ UTILITY ==============
function esc(str) {
  return String(str || "")
    .replace(/'/g, "\\'")
    .replace(/"/g, "&quot;")
    .replace(/</g, "&lt;")
    .replace(/>/g, "&gt;");
}
function statusPill(status) {
  switch ((status || "").toLowerCase()) {
    case "active": return `<span class="bg-yellow-100 text-yellow-800 font-semibold px-3 py-1 rounded-full text-xs">Active</span>`;
    case "overdue": return `<span class="bg-red-100 text-red-700 font-semibold px-3 py-1 rounded-full text-xs">Overdue</span>`;
    case "done": case "completed": return `<span class="bg-green-100 text-green-700 font-semibold px-3 py-1 rounded-full text-xs">Done</span>`;
    default: return `<span class="bg-gray-100 text-gray-700 font-semibold px-3 py-1 rounded-full text-xs">${esc(status)}</span>`;
  }
}
function activityTypePill(type, meta) {
  const t = (type || "custom").toLowerCase();
  const conf = TASK_TYPES[t] || { display: t.charAt(0).toUpperCase() + t.substring(1), color: "gray" };
  let extra = "";
  if (t === "reading" || t === "article") extra = meta?.duration ? `<div class="text-xs text-gray-500 mt-1">${esc(meta.duration)}</div>` : "";
  if (t === "video") extra = meta?.duration ? `<div class="text-xs text-gray-500 mt-1">${esc(meta.duration)}</div>` : "";
  if (t === "social") extra = meta?.platform ? `<div class="text-xs text-gray-500 mt-1">${esc(meta.platform)}</div>` : "";
  if (t === "mocktest") extra = meta?.status ? `<div class="text-xs text-gray-500 mt-1">${esc(meta.status)}</div>` : "";
  if (t === "profile") extra = meta?.platform ? '<div class="text-xs text-gray-500 mt-1">'+esc(meta.platform)+'</div>' : '';
  return `<span class="bg-${conf.color}-100 text-${conf.color}-700 rounded-full px-3 py-1 font-semibold text-xs">${esc(conf.display)}</span>${extra}`;
}
function actionCell(task) {
  const t = (task.activityType || "custom").toLowerCase();
  const status = (task.status || "").toLowerCase();
  const meta = task.meta || {};
  // Completed tasks: show gray
  if (["done", "completed"].includes(status))
    return `<span class="text-gray-400 text-xs">Completed</span>`;
  // Reading/Article
  if (["reading", "article"].includes(t) && meta.url) {
    return `<button onclick="openArticleModal('${esc(meta.url)}','${esc(task._id)}')" class="bg-blue-600 hover:bg-blue-700 text-white rounded px-3 py-1 font-semibold text-xs shadow flex gap-2 items-center"><span>Read</span></button>`;
  }
  // Video
  if (t === "video" && meta.url) {
    return `<button onclick="openVideoModal('${esc(meta.url)}','${esc(task._id)}')" class="bg-pink-600 hover:bg-pink-700 text-white rounded px-3 py-1 font-semibold text-xs shadow flex gap-2 items-center"><span>Watch</span></button>`;
  }
  // Assignment
  if (t === "assignment") {
    return `<button onclick="openAssignmentModal('${esc(task._id)}')" class="bg-orange-600 hover:bg-orange-700 text-white rounded px-3 py-1 font-semibold text-xs shadow flex gap-2 items-center"><span>Open</span></button>`;
  }
  // MockTest
  if (t === "mocktest" && meta.url) {
    return `<button onclick="window.location.href='${esc(meta.url)}'" class="bg-indigo-600 hover:bg-indigo-700 text-white rounded px-3 py-1 font-semibold text-xs shadow flex gap-2 items-center"><span>Start Test</span></button>`;
  }
  // Social
  if (t === "social" && meta.url) {
    return `<a href="${esc(meta.url)}" target="_blank" class="bg-blue-700 hover:bg-blue-800 text-white px-3 py-1 rounded font-semibold text-xs shadow flex gap-2 items-center"><span>Open</span></a>`;
  }

if (t === "profile" && meta.url) {
  return `<a href="${esc(meta.url)}" target="_blank" class="bg-purple-600 hover:bg-purple-700 text-white px-3 py-1 rounded font-semibold text-xs shadow flex gap-2 items-center">
    <span>${meta.platform ? 'Follow on ' + esc(meta.platform) : 'View Profile'}</span>
    <svg class="inline w-4 h-4 ml-1" fill="none" stroke="currentColor"><path d="M5 12h14M12 5l7 7-7 7" stroke-width="1.5"/></svg>
  </a>`;
}
  // Goal/custom/other
  return `<span class="text-gray-400 text-xs">No Action</span>`;
}
// -------------- MODALS state -------------
let modalDisabledUntil = {};
let windowTasksList = [];

// -- Modal: Article/Reading --
function openArticleModal(url, taskId) {
  const task = windowTasksList.find((t) => t._id == taskId) || {};
  document.getElementById("articleFrame").src = url;
  document.getElementById("articleDescription").textContent = task.description || "";
  document.getElementById("articleModal").classList.remove("hidden");
  const btn = document.getElementById("articleMarkAsDoneBtn");
  btn.setAttribute("data-taskid", taskId);
  modalMarkBtnState("article", taskId, btn, document.getElementById("articleMarkAsDoneLoader"));
}
function closeArticleModal() {
  document.getElementById("articleModal").classList.add("hidden");
  document.getElementById("articleFrame").src = "";
  document.getElementById("articleMarkAsDoneBtn").setAttribute("data-taskid", "");
  document.getElementById("articleDescription").textContent = "";
}

// -- Modal: Video --
function openVideoModal(url, taskId) {
  const task = windowTasksList.find((t) => t._id == taskId) || {};
  document.getElementById("videoFrame").src = url + "?autoplay=1";
  document.getElementById("videoDescription").textContent = task.description || "";
  document.getElementById("videoModal").classList.remove("hidden");
  const btn = document.getElementById("videoMarkAsDoneBtn");
  btn.setAttribute("data-taskid", taskId);
  modalMarkBtnState("video", taskId, btn, document.getElementById("videoMarkAsDoneLoader"));
}
function closeVideoModal() {
  document.getElementById("videoModal").classList.add("hidden");
  document.getElementById("videoFrame").src = "";
  document.getElementById("videoMarkAsDoneBtn").setAttribute("data-taskid", "");
  document.getElementById("videoDescription").textContent = "";
}

// -- Modal: Assignment (shows instructions, deadline, and attached file/link if present) --
function openAssignmentModal(taskId) {
  const task = windowTasksList.find((t) => t._id == taskId) || {};
  document.getElementById("assignmentInstructions").innerHTML = (task.meta?.instructions ? esc(task.meta.instructions) : "No instructions provided.");
  if (task.meta?.url) {
    document.getElementById("assignmentFrame").src = task.meta.url;
    document.getElementById("assignmentFrame").classList.remove("hidden");
  } else {
    document.getElementById("assignmentFrame").src = "";
    document.getElementById("assignmentFrame").classList.add("hidden");
  }
  document.getElementById("assignmentDeadline").textContent = task.meta?.deadline
    ? "Deadline: " + new Date(task.meta.deadline).toLocaleString()
    : "";
  document.getElementById("assignmentModal").classList.remove("hidden");
  const btn = document.getElementById("assignmentMarkAsDoneBtn");
  btn.setAttribute("data-taskid", taskId);
  modalMarkBtnState("assignment", taskId, btn, document.getElementById("assignmentMarkAsDoneLoader"));
}
function closeAssignmentModal() {
  document.getElementById("assignmentModal").classList.add("hidden");
  document.getElementById("assignmentFrame").src = "";
  document.getElementById("assignmentMarkAsDoneBtn").setAttribute("data-taskid", "");
  document.getElementById("assignmentInstructions").textContent = "";
  document.getElementById("assignmentDeadline").textContent = "";
}

// -- Mark as done disable/enable utility for modals --
function modalMarkBtnState(modalType, taskId, btn, loader) {
  const disableKey = modalType + "_" + String(taskId);
  const now = Date.now(), until = modalDisabledUntil[disableKey] || 0;
  const span = btn.querySelector("span");
  if (until > now) {
    btn.disabled = true; loader.classList.add("hidden"); span.textContent = "Disabled for 1 min...";
    setTimeout(() => {
      if (modalDisabledUntil[disableKey] <= Date.now()) {
        btn.disabled = false; span.textContent = "Mark as Done";
      }
    }, until - now);
  } else {
    btn.disabled = false; loader.classList.add("hidden"); span.textContent = "Mark as Done";
  }
}

async function markTaskDone(taskId, modalType) {
  let btn, loader;
  if (modalType === "article") {
    btn = document.getElementById("articleMarkAsDoneBtn");
    loader = document.getElementById("articleMarkAsDoneLoader");
  } else if (modalType === "video") {
    btn = document.getElementById("videoMarkAsDoneBtn");
    loader = document.getElementById("videoMarkAsDoneLoader");
  } else if (modalType === "assignment") {
    btn = document.getElementById("assignmentMarkAsDoneBtn");
    loader = document.getElementById("assignmentMarkAsDoneLoader");
  }
  if (!btn) return;
  btn.disabled = true; loader.classList.remove("hidden");
  btn.querySelector("span").textContent = "Marking...";

  // Lock for 1 min
  const disableKey = modalType + "_" + String(taskId);
  modalDisabledUntil[disableKey] = Date.now() + 60000;
  try {
    const token = localStorage.getItem("token");
    await fetch(`https://examguide.onrender.com/api/tasks/${taskId}`, {
      method: "PATCH",
      headers: { "Content-Type": "application/json", ...(token ? { Authorization: "Bearer " + token } : {}) },
      body: JSON.stringify({ status: "done" }),
    });
    if (modalType === "article") closeArticleModal();
    if (modalType === "video") closeVideoModal();
    if (modalType === "assignment") closeAssignmentModal();
    await loadTasks(tasksCurrentPage);
  } catch (e) {
    alert("Failed to mark as done. Please retry.");
  }
  loader.classList.add("hidden");
  btn.querySelector("span").textContent = "Disabled for 1 min...";
  setTimeout(() => {
    if (modalDisabledUntil[disableKey] <= Date.now()) {
      btn.disabled = false;
      btn.querySelector("span").textContent = "Mark as Done";
    }
  }, 60000);
}

// --------- Pagination and main loader ---------
let tasksCurrentPage = 1;
const tasksPerPage = 6;
let tasksTotalPages = 1;

async function loadTasks(page = 1) {
  const API_URL = "https://examguide.onrender.com/api/";
  let token = localStorage.getItem("token");
  let student = null;
  try {
    const resp = await fetch(API_URL + "auth/me", {
      credentials: "include",
      headers: token ? { Authorization: "Bearer " + token } : {},
    });
    const data = await resp.json();
    student = data.user;
  } catch (e) {}
  let tasks = [];
  if (student && student._id) {
    try {
      const resp = await fetch(`${API_URL}tasks/user/${student._id}`, {
        credentials: "include",
        headers: token ? { Authorization: "Bearer " + token } : {},
      });
      tasks = await resp.json();
    } catch (e) {}
  }
  if (!Array.isArray(tasks) || !tasks.length) {
    // Fallback demo tasks
    tasks = [
      {
        _id: "demo1",
        title: `Read: "5 Quick Ways to Beat Procrastination"`,
        activityType: "reading",
        points: 15,
        status: "active",
        description: "Boost your productivity with these simple strategies for overcoming procrastination.",
        meta: { duration: "10 min", url: "https://medium.com/the-mission/5-quick-ways-to-beat-procrastination-626edf2e5a9" }
      },
      {
        _id: "demo2",
        title: `Watch: Study Motivation â€” How to Stay Focused`,
        activityType: "video",
        points: 10,
        status: "active",
        description: "Motivational tips and tricks to help you keep your mind on your studies.",
        meta: { duration: "7 min", url: "https://www.youtube.com/embed/Oe421EPjeBE" }
      },
      {
        _id: "demo3",
        title: `Like ExamGuard Facebook Page`,
        activityType: "social",
        points: 8,
        status: "active",
        description: "Support ExamGuard by liking our Facebook page.",
        meta: { url: "https://facebook.com/examguardpage", platform: "Facebook" }
      },
      {
        _id: "demo4",
        title: `Assignment: Essay Submission`,
        activityType: "assignment",
        points: 20,
        status: "active",
        description: "Write a short essay on your exam preparation strategy.",
        meta: { deadline: new Date(Date.now() + 86400000).toISOString(), instructions: "500 words minimum. Submit in the text area or as a PDF.", url: "" }
      },
      {
        _id: "demo5",
        title: "Complete your profile information",
        activityType: "profile",
        points: 5,
        status: "done",
        description: "Help us know you better by completing your entire profile."
      }
    ];
  }
  windowTasksList = tasks;

  // Pagination
  tasksTotalPages = Math.ceil(tasks.length / tasksPerPage) || 1;
  if (page < 1) page = 1;
  if (page > tasksTotalPages) page = tasksTotalPages;
  tasksCurrentPage = page;
  const startIdx = (page - 1) * tasksPerPage;
  const pageTasks = tasks.slice(startIdx, startIdx + tasksPerPage);

  // Table
  const tbody = document.getElementById("tasksTableBody");
  tbody.innerHTML = pageTasks
    .map(
      (task) => `<tr>
    <td class="px-6 py-4 font-semibold text-blue-900 whitespace-nowrap">${esc(task.title)}</td>
    <td class="px-6 py-4 text-gray-700">${esc(task.description || "")}</td>
    <td class="px-6 py-4 whitespace-nowrap">${activityTypePill(task.activityType, task.meta)}</td>
    <td class="px-6 py-4 text-center font-bold text-indigo-600 whitespace-nowrap">${esc(task.points) ?? 0}</td>
    <td class="px-6 py-4 whitespace-nowrap">${statusPill(task.status)}</td>
    <td class="px-6 py-4 whitespace-nowrap">${actionCell(task)}</td>
  </tr>`
    )
    .join("");

  // Stats
  const active = tasks.filter((t) => (t.status || "").toLowerCase() === "active").length;
  const done = tasks.filter((t) => ["done", "completed"].includes((t.status || "").toLowerCase())).length;
  const overdue = tasks.filter((t) => (t.status || "").toLowerCase() === "overdue").length;
  const points = tasks.reduce((sum, t) => sum + (t.points || 0), 0);
  document.getElementById("activeTasksCount").textContent = active;
  document.getElementById("completedTasksCount").textContent = done;
  document.getElementById("overdueTasksCount").textContent = overdue;
  document.getElementById("pointsCount").textContent = points;

  // Pagination controls
  document.getElementById("tasksPageInfo").textContent = `Page ${tasksCurrentPage} of ${tasksTotalPages}`;
  document.getElementById("tasksPrevBtn").disabled = tasksCurrentPage === 1;
  document.getElementById("tasksNextBtn").disabled = tasksCurrentPage === tasksTotalPages;
}

function refreshTasks() { loadTasks(1); }

document.addEventListener("DOMContentLoaded", function () {
  document.getElementById('articleMarkAsDoneBtn').onclick = function() {
    const taskId = this.getAttribute('data-taskid');
    if (taskId && !this.disabled) markTaskDone(taskId, "article");
  };
  document.getElementById('videoMarkAsDoneBtn').onclick = function() {
    const taskId = this.getAttribute('data-taskid');
    if (taskId && !this.disabled) markTaskDone(taskId, "video");
  };
  document.getElementById('assignmentMarkAsDoneBtn').onclick = function() {
    const taskId = this.getAttribute('data-taskid');
    if (taskId && !this.disabled) markTaskDone(taskId, "assignment");
  };
  document.getElementById("tasksPrevBtn").onclick = function () {
    if (tasksCurrentPage > 1) loadTasks(tasksCurrentPage - 1);
  };
  document.getElementById("tasksNextBtn").onclick = function () {
    if (tasksCurrentPage < tasksTotalPages) loadTasks(tasksCurrentPage + 1);
  };
  loadTasks(1);
});
  </script>
</div>

  <!-- Profile Section -->
<div id="profile-section" class="section-block hidden">
  <div class="max-w-4xl mx-auto py-10 px-2 md:px-8">
    <!-- Profile header/overview -->
    <div class="bg-white rounded-xl shadow-lg flex flex-col items-center md:flex-row md:items-start gap-8 p-8 mb-10">
      <div class="flex flex-col items-center md:items-start gap-5">
        <img class="w-32 h-32 rounded-full border-4 border-indigo-400 shadow-md object-cover" src="https://randomuser.me/api/portraits/men/32.jpg" alt="Profile avatar">
        <button class="bg-indigo-600 text-white px-4 py-1 rounded font-semibold text-sm shadow hover:bg-indigo-700 transition">Change Photo</button>
      </div>
      <div class="flex-1 flex flex-col gap-3 w-full">
        <h2 class="text-3xl font-bold text-indigo-800 mb-1">Alex Student</h2>
        <div class="text-md text-gray-600">Student, OAU ExamGuard</div>
        <div class="flex gap-3 flex-wrap mt-2">
          <span class="bg-indigo-100 text-indigo-800 px-3 py-1 rounded-md text-xs font-semibold">Year 3</span>
          <span class="bg-green-100 text-green-700 px-3 py-1 rounded-md text-xs font-semibold">GPA: 3.8</span>
          <span class="bg-pink-100 text-pink-700 px-3 py-1 rounded-md text-xs font-semibold">Account Type: Student</span>
        </div>
        <div class="flex flex-wrap gap-2 mt-3">
          <a href="mailto:alex.student@example.com" class="text-blue-600 text-sm underline">alex.student@example.com</a>
          <a href="#" class="text-gray-600 text-sm underline">Change Password</a>
        </div>
        <div class="mt-5 flex gap-3">
          <button class="bg-blue-700 text-white px-5 py-2 rounded font-semibold text-sm hover:bg-blue-800 transition shadow">Edit Profile</button>
          <button class="bg-gray-100 text-gray-800 px-5 py-2 rounded font-semibold text-sm border hover:bg-gray-200 transition shadow">Download Resume</button>
        </div>
      </div>
    </div>

    <!-- Profile Details & Edit form -->
    <div class="bg-white rounded-xl shadow p-8 flex flex-col gap-8 mb-10">
      <h3 class="text-xl font-bold text-indigo-700 mb-4">Personal Information</h3>
      <div class="grid md:grid-cols-2 gap-6">
        <div>
          <label class="block text-sm font-medium mb-1">Full Name</label>
          <input type="text" class="w-full border rounded-lg p-2 text-sm" value="Alex Student" />
        </div>
        <div>
          <label class="block text-sm font-medium mb-1">Email Address</label>
          <input type="email" class="w-full border rounded-lg p-2 text-sm" value="alex.student@example.com" />
        </div>
        <div>
          <label class="block text-sm font-medium mb-1">Country</label>
          <input type="text" class="w-full border rounded-lg p-2 text-sm" value="Nigeria" />
        </div>
        <div>
          <label class="block text-sm font-medium mb-1">Town/City</label>
          <input type="text" class="w-full border rounded-lg p-2 text-sm" value="Ile-Ife" />
        </div>
        <div>
          <label class="block text-sm font-medium mb-1">Institution</label>
          <input type="text" class="w-full border rounded-lg p-2 text-sm" value="Obafemi Awolowo University" />
        </div>
        <div>
          <label class="block text-sm font-medium mb-1">Department</label>
          <input type="text" class="w-full border rounded-lg p-2 text-sm" value="Computer Science" />
        </div>
        <div>
          <label class="block text-sm font-medium mb-1">Phone Number</label>
          <input type="text" class="w-full border rounded-lg p-2 text-sm" value="+2348012345678" />
        </div>
        <div>
          <label class="block text-sm font-medium mb-1">Gender</label>
          <select class="w-full border rounded-lg p-2 text-sm">
            <option>Male</option>
            <option>Female</option>
            <option>Other</option>
          </select>
        </div>
      </div>
      <div>
        <label class="block text-sm font-medium mb-1">Short Bio</label>
        <textarea class="w-full border rounded-lg p-2 text-sm min-h-[40px]" placeholder="Write a brief biography about yourself...">Hi, I'm Alex, a passionate learner and aspiring software engineer.</textarea>
      </div>
      <div class="mt-5 flex gap-3 justify-end">
        <button class="bg-blue-700 text-white px-6 py-2 rounded font-semibold text-sm hover:bg-blue-800 transition shadow">Save Changes</button>
        <button class="bg-gray-100 text-gray-800 px-6 py-2 rounded font-semibold text-sm border hover:bg-gray-200 transition shadow">Cancel</button>
      </div>
    </div>

    <!-- Social Media & External Links -->
    <div class="bg-white rounded-xl shadow p-8 flex flex-col gap-8 mb-8">
      <h3 class="text-xl font-bold text-indigo-700 mb-4">Social & External Links</h3>
      <div class="grid md:grid-cols-3 gap-5">
        <div>
          <label class="block text-sm font-medium mb-1">Facebook</label>
          <input type="text" class="w-full border rounded-lg p-2 text-sm" placeholder="Enter Facebook link" value="https://facebook.com/alex.student" />
        </div>
        <div>
          <label class="block text-sm font-medium mb-1">Twitter</label>
          <input type="text" class="w-full border rounded-lg p-2 text-sm" value="https://twitter.com/alex_student" />
        </div>
        <div>
          <label class="block text-sm font-medium mb-1">Instagram</label>
          <input type="text" class="w-full border rounded-lg p-2 text-sm" value="https://instagram.com/alex.student" />
        </div>
        <div>
          <label class="block text-sm font-medium mb-1">Github</label>
          <input type="text" class="w-full border rounded-lg p-2 text-sm" value="https://github.com/alexstudent" />
        </div>
        <div>
          <label class="block text-sm font-medium mb-1">LinkedIn</label>
          <input type="text" class="w-full border rounded-lg p-2 text-sm" value="https://linkedin.com/in/alexstudent" />
        </div>
        <div>
          <label class="block text-sm font-medium mb-1">Other Link</label>
          <input type="text" class="w-full border rounded-lg p-2 text-sm" value="" />
        </div>
      </div>
      <div class="mt-5 flex gap-3 justify-end">
        <button class="bg-blue-700 text-white px-6 py-2 rounded font-semibold text-sm hover:bg-blue-800 transition shadow">Save Social Links</button>
      </div>
    </div>

    <!-- Achievements & Badges -->
    <div class="bg-white rounded-xl shadow p-8 flex flex-col gap-4 mb-8">
      <h3 class="text-xl font-bold text-indigo-700 mb-1">Achievements & Badges</h3>
      <div class="flex gap-5 flex-wrap mt-1">
        <div class="bg-gradient-to-br from-yellow-400 via-indigo-500 to-blue-600 rounded-lg px-5 py-2 flex items-center gap-3 shadow">
          <svg class="w-7 h-7 text-yellow-100" fill="currentColor">
            <polygon points="24,0 32,16 24,32 0,32 8,16 0,0" />
          </svg>
          <span class="font-semibold text-white text-sm">Top Scorer (Mock Test)</span>
        </div>
        <div class="bg-gradient-to-r from-green-400 to-blue-400 rounded-lg px-5 py-2 flex items-center gap-3 shadow">
          <svg class="w-7 h-7 text-white" fill="currentColor">
            <circle cx="12" cy="12" r="10"/>
          </svg>
          <span class="font-semibold text-white text-sm">All Assignments Completed</span>
        </div>
        <div class="bg-gradient-to-r from-pink-500 to-purple-400 rounded-lg px-5 py-2 flex items-center gap-3 shadow">
          <svg class="w-7 h-7 text-white" fill="currentColor">
            <rect x="4" y="4" width="16" height="16" rx="7"/>
          </svg>
          <span class="font-semibold text-white text-sm">Social Media Star</span>
        </div>
        <!-- Add more badges dynamically -->
      </div>
    </div>

    <!-- Quick Motivation & Completion Status -->
    <div class="bg-gradient-to-r from-indigo-500 to-blue-500 text-white rounded-xl px-6 py-4 flex items-center justify-between shadow">
      <div>
        <h3 class="text-lg font-bold mb-1">Stay Focused!</h3>
        <p class="text-sm">Your consistency is key. Review your progress and aim for the next badge!</p>
      </div>
      <div>
        <span class="bg-white/30 px-4 py-1 rounded text-white font-semibold">Profile: 94% Complete</span>
      </div>
    </div>
  </div>
</div>
  <!-- Broadcasts Section -->
<div id="broadcasts-section" class="section-block hidden">
  <div class="max-w-5xl mx-auto py-10 px-2 md:px-8">
    <!-- Section Header -->
    <div class="flex flex-col md:flex-row md:items-center justify-between gap-4 mb-7">
      <div>
        <h2 class="text-3xl font-bold text-indigo-800">Broadcasts & Announcements</h2>
        <p class="text-md text-gray-600 mt-1">Stay up to date with important alerts, updates, and general information.</p>
      </div>
      <div class="flex gap-4">
        <button class="inline-flex items-center gap-2 bg-indigo-600 hover:bg-indigo-700 text-white px-5 py-2 rounded-lg font-semibold shadow transition"
                onclick="document.getElementById('createBroadcastModal').classList.remove('hidden')">
          <svg class="w-5 h-5" fill="none" stroke="currentColor"><path d="M12 4v16m8-8H4" stroke-width="2"></path></svg>
          New Broadcast
        </button>
      </div>
    </div>

    <!-- Broadcasts Feed -->
<div id="broadcastsFeed" class="flex flex-col gap-6">
  <!-- injected by JS -->
</div>


    <!-- Create Broadcast Modal -->
    <div class="fixed inset-0 bg-black bg-opacity-40 z-50 flex items-center justify-center hidden" id="createBroadcastModal">
      <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg mx-4 p-8 flex flex-col gap-6 relative">
        <button class="absolute top-4 right-5 text-gray-400 hover:text-indigo-600 text-2xl"
                onclick="document.getElementById('createBroadcastModal').classList.add('hidden')">&times;</button>
        <h3 class="font-bold text-2xl mb-2 text-indigo-900">New Broadcast</h3>
        <form class="flex flex-col gap-4">
          <div>
            <label class="font-medium mb-1 block">Title*</label>
            <input type="text" class="border rounded-lg p-2 w-full" placeholder="Enter broadcast title" required>
          </div>
          <div>
            <label class="font-medium mb-1 block">Message*</label>
            <textarea class="border rounded-lg p-2 w-full min-h-[60px]" placeholder="Type the announcement or alert details..." required></textarea>
          </div>
          <div>
            <label class="font-medium mb-1 block">Broadcast Color</label>
            <select class="border rounded-lg p-2 w-full">
              <option value="system">System (Blue)</option>
              <option value="success">Success (Green)</option>
              <option value="warning">Warning (Yellow)</option>
              <option value="info">Info (Gray)</option>
            </select>
          </div>
          <button type="submit" class="bg-indigo-600 hover:bg-indigo-700 text-white font-semibold rounded px-6 py-2 shadow mt-1">Send Broadcast</button>
        </form>
      </div>
    </div>
  </div>
</div>
<script>
const BROADCAST_API = "https://examguide.onrender.com/api/broadcasts";

const BROADCAST_STYLES = {
  system: { border: "border-indigo-600", text: "text-indigo-900", btn: "bg-indigo-50 text-indigo-700" },
  success: { border: "border-green-500", text: "text-green-800", btn: "bg-green-50 text-green-700" },
  warning: { border: "border-yellow-500", text: "text-yellow-800", btn: "bg-yellow-50 text-yellow-700" },
  info: { border: "border-gray-400", text: "text-gray-800", btn: "bg-gray-100 text-gray-700" }
};

// Fetch broadcasts from API
async function fetchBroadcasts() {
  try {
    const res = await fetch(BROADCAST_API, { credentials: "include" });
    if (!res.ok) {
      const message = await res.text();
      console.error("Broadcast fetch failed", res.status, message);
      return [];
    }
    return res.json();
  } catch(e) {
    console.error("Broadcast fetch error", e);
    return [];
  }
}

// Fetch current user ID for 'read' tracking
async function getCurrentUserId() {
  try {
    const res = await fetch("https://examguide.onrender.com/api/auth/me", { credentials: "include" });
    if (!res.ok) return null;
    const data = await res.json();
    return data.user && (data.user._id || data.user.id);
  } catch {
    return null;
  }
}

// Display broadcasts and highlight read/unread per user
function renderBroadcasts(list, currentUserId) {
  const container = document.getElementById("broadcastsFeed");
  if (!container) return;

  if (!list.length) {
    container.innerHTML = `
      <div class="text-center text-gray-400 py-10">
        No broadcasts available.
      </div>`;
    return;
  }

  container.innerHTML = list.map(b => {
    const style = BROADCAST_STYLES[b.type] || BROADCAST_STYLES.info;
    // Determine if current user has read this broadcast
    const read = Array.isArray(b.seenBy) && currentUserId && b.seenBy.includes(currentUserId);
    return `
      <div class="bg-white rounded-xl shadow p-6 flex flex-col md:flex-row gap-6 items-center border-l-4 ${style.border}">
        <div class="flex-1">
          <h3 class="font-bold text-lg ${style.text}">
            ${b.title}
          </h3>
          <p class="text-sm text-gray-600 mt-1">${b.message}</p>
        </div>
        <div class="flex flex-col items-end md:w-40">
          <span class="text-xs text-gray-400">
            ${new Date(b.createdAt).toLocaleDateString()} â€¢ ${b.author || "System"}
          </span>
          ${
            !read
              ? `<button onclick="markBroadcastRead('${b._id}')"
                   class="mt-2 ${style.btn} font-semibold rounded px-4 py-1 text-xs hover:opacity-80">
                   Mark as read
                 </button>`
              : `<span class="mt-2 text-xs text-green-600 font-semibold">Read</span>`
          }
        </div>
      </div>
    `;
  }).join("");
}

// Mark a broadcast as read for the current user
async function markBroadcastRead(id) {
  try {
    const res = await fetch(`${BROADCAST_API}/${id}/read`, {
      method: "PATCH",
      credentials: "include"
    });
    if (!res.ok) {
      const msg = await res.text();
      console.error("Failed to mark as read:", msg);
    }
  } catch(e) {
    console.error("Error marking as read", e);
  }
  // Reload after marking as read
  loadBroadcasts();
}

// Load and render the broadcasts feed
async function loadBroadcasts() {
  const [broadcasts, userId] = await Promise.all([fetchBroadcasts(), getCurrentUserId()]);
  renderBroadcasts(broadcasts, userId);
}

// Load on page ready; if you show/hide this section with tab/SPA, call loadBroadcasts() on section switch!
document.addEventListener("DOMContentLoaded", () => {
  loadBroadcasts();
});
</script>

<div id="studyPadi-section" class="section-block hidden">
  <div class="max-w-6xl mx-auto py-10 px-2 md:px-6">
    <!-- Section Header -->
    <div class="flex flex-col md:flex-row md:items-center justify-between gap-4 mb-7">
      <div>
        <h2 class="text-3xl font-bold text-indigo-800">My StudyPadi</h2>
        <p class="text-md text-gray-600 mt-1">Your personal study companion. Customize your goals, schedule sessions, and track your learning journey.</p>
      </div>
      <div class="flex gap-4">
        <button id="openAddGoalBtn" class="inline-flex items-center gap-2 bg-indigo-600 hover:bg-indigo-700 text-white px-5 py-2 rounded-lg font-semibold shadow transition">
          <svg class="w-5 h-5" fill="none" stroke="currentColor"><path d="M12 4v16m8-8H4" stroke-width="2"></path></svg>
          Add Study Goal
        </button>
        <button id="openScheduleSessionBtn" class="inline-flex items-center gap-2 bg-white/90 hover:bg-white text-indigo-700 px-4 py-2 rounded-lg font-semibold shadow transition border">
          <svg class="w-4 h-4" fill="none" stroke="currentColor"><path d="M12 4v16m8-8H4" stroke-width="1.5"></path></svg>
          Quick Session
        </button>
      </div>
    </div>

    <!-- Study Sessions & Goals List -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-5 mb-8" id="padi-cards">
      <!-- Cards inserted by JS -->
    </div>

    <!-- Overview -->
    <div id="padi-overview" class="bg-gradient-to-r from-indigo-500 to-blue-500 rounded-xl px-6 py-7 text-white shadow mb-8 grid md:grid-cols-2 gap-7">
      <!-- injected by JS -->
    </div>

    <!-- Timeline -->
    <div id="padi-timeline" class="bg-white rounded-xl shadow p-6 mb-8">
      <!-- injected by JS -->
    </div>


    <div class="flex items-start justify-between gap-4">
      <div>
        <h4 class="font-bold text-lg text-indigo-800">Convert Document to Questions (AI)</h4>
        <p class="text-sm text-gray-700">Upload a document (PDF, DOCX, TXT). Choose question type and desired number (max 40).</p>
      </div>
    </div>

    <!-- Form -->
    <form id="padiAiForm" class="mt-5 grid grid-cols-1 md:grid-cols-4 gap-3 items-end">
      <div>
        <label class="text-xs font-semibold mb-1 block">Choose file</label>
        <input id="padiAiFile" type="file" accept=".pdf,.docx,.txt,.md" class="w-full" required />
      </div>
      <div>
        <label class="text-xs font-semibold mb-1 block">Question Type</label>
        <select id="padiAiQType" class="border rounded p-2 w-full">
          <option value="mcq">Multiple Choice (MCQ)</option>
          <option value="short">Short Answer</option>
          <option value="mixed">Mixed</option>
        </select>
      </div>
      <div>
        <label class="text-xs font-semibold mb-1 block"># Questions (max 40)</label>
        <input id="padiAiCount" type="number" min="1" max="40" value="10" class="border rounded p-2 w-full text-center" />
      </div>
      <div>
        <label class="text-xs font-semibold mb-1 block">Output format</label>
        <select id="padiAiFormat" class="border rounded p-2 w-full">
          <option value="plain">Readable (recommended)</option>
          <option value="json">Raw JSON (for developers)</option>
          <option value="gpt-examset">Examset JSON</option>
        </select>
      </div>
      <div class="md:col-span-3">
        <label class="text-xs font-semibold mb-1 block">Instructions <span class="text-gray-400 font-normal">(optional)</span></label>
        <input id="padiAiInstructions" type="text" placeholder="e.g. Focus on basic-level conceptual questions" class="border rounded p-2 w-full" autocomplete="off" />
      </div>
      <div class="flex gap-2 items-center">
        <button id="padiAiSubmit" type="submit" class="bg-indigo-600 text-white px-4 py-2 rounded font-semibold">
          <span id="padiAiSubmitLabel">Convert</span>
        </button>
        <button id="padiAiCancel" type="button" class="bg-gray-100 text-gray-700 px-3 py-2 rounded hidden">Cancel</button>
        <div id="padiAiSpinner" class="hidden ml-2 text-sm text-gray-600">Processingâ€¦</div>
      </div>
    </form>

    <!-- Results / Exam UI output -->
    <div id="padiAiResult" class="mt-7 hidden transition-all">
      <!-- Reveal answers (only for JSON output mode) -->
      <div class="flex flex-wrap items-center mb-5 justify-between">
        <div class="flex items-center gap-6">
          <h5 class="font-semibold text-indigo-700 text-lg">Questions<span id="examSetStats" class="ml-3 text-xs text-slate-500"></span></h5>
          <label class="inline-flex items-center text-sm text-gray-700 hidden" id="padiRevealAnswersWrap">
            <input id="padiRevealAnswers" type="checkbox" class="accent-indigo-600 mr-2" />
            Reveal all answers
          </label>
        </div>
        <div class="flex gap-2">
          <button id="padiAiDownload" class="bg-white border px-3 py-1 rounded text-sm">Download</button>
          <button id="padiAiClear" class="bg-gray-50 border px-3 py-1 rounded text-sm">Clear</button>
        </div>
      </div>
      <div id="examQuestionSet" class="bg-white rounded-xl px-1 pt-1 pb-4"></div>
    </div>

    <!-- Saved sets (unchanged, visually integrated) -->
    <div id="padiSavedSetsWrap" class="mt-8">
      <div class="flex items-center justify-between mb-2">
        <h5 class="font-semibold text-indigo-700">Saved Question Sets</h5>
        <button id="padiRefreshSaved" class="text-sm text-indigo-600 hover:underline">Refresh</button>
      </div>
      <div id="padiSavedSets" class="grid grid-cols-1 md:grid-cols-2 gap-3 text-sm"></div>
      <div id="padiSavedEmpty" class="text-gray-500 text-sm mt-3 hidden">No previous sets found.</div>
    </div>
 
<!-- Saved set modal -->
<div id="padiSavedModal" class="fixed inset-0 bg-black bg-opacity-60 z-50 hidden items-center justify-center p-4">
  <div class="bg-white rounded-xl shadow-2xl w-full max-w-3xl p-6 relative">
    <button id="padiSavedModalClose" class="absolute top-3 right-3 text-gray-500 hover:text-gray-800 text-xl">&times;</button>
    <h3 id="padiSavedModalTitle" class="font-bold text-lg text-indigo-700 mb-3"></h3>
    <div id="padiSavedModalContent" class="max-h-[60vh] overflow-auto text-sm"></div>
    <div class="flex justify-end gap-2 mt-4">
      <button id="padiSavedModalDownload" class="bg-white border px-3 py-1 rounded text-sm">Download</button>
      <button id="padiSavedModalCopy" class="bg-indigo-600 text-white px-3 py-1 rounded text-sm">Copy</button>
    </div>
  </div>
</div>

<!-- ======= MODERN EXAM INTERFACE CSS ======= -->
<style>
/* Container/card for each set */
#examQuestionSet {
  font-family: 'Inter', system-ui, "Segoe UI", sans-serif;
  font-size: 1rem;
}

/* Question card styles */
.exam-question-card {
  padding: 23px 8px 15px 8px;
  margin-bottom: 7px;
  background: #fafafc;
  border-radius: 12px;
  box-shadow: 0 2px 8px rgba(60,60,100,0.04);
  border: 1.5px solid #eceffe;
  transition: box-shadow .17s;
}
.exam-question-card:not(:last-child){margin-bottom:18px;}
.exam-qnum {
  font-weight: bold;
  color: #6366f1;
  font-size: 1.12rem;
  margin-right: 0.68em;
  display: inline-block;
  letter-spacing: 0.01em;
}
.exam-qtext {
  font-size: 1.08rem;
  font-weight: 600;
  color: #292f36;
  margin-bottom: 8px;
  word-break: break-word;
}
.exam-mcq-opts {margin-top: 8px;}
.exam-mcq-opt label {
  font-size: 1.04rem;
  font-weight: 500;
  color: #23272f;
  background: #eef2ff;
  border-radius: 8px;
  padding: 8px 19px 8px 10px;
  display: flex;
  align-items: center;
  cursor: pointer;
  margin-bottom:6px;
}
.exam-mcq-opt input[type=radio] {
  accent-color: #6366f1;
  margin-right: 0.6em;
}
@media (hover: hover) {
  .exam-mcq-opt label:hover { background: #c7d2fe; }
}
.exam-answer-row {
  margin-top: 14px;
  position: relative;
  padding: 15px 12px;
  border-radius: 9px;
  background: linear-gradient(90deg,#e0f2fe 0,#fff 100%);
  color: #155c65;
  font-size:1.05em;
  font-weight: 500;
  box-shadow: 0 1px 8px 0 rgba(60,60,150,0.08);
  display: flex;
  align-items: center;
  gap:12px;
  opacity: 0; max-height: 0; transition: all .23s cubic-bezier(.51,.17,.34,.88);
}
.exam-answer-row.visible {
  opacity: 1; max-height: 200px; margin-top: 14px;
}
.exam-ans-badge {
  border-radius: 8px;
  font-size: .95em;
  font-weight: bold;
  color: #166534;
  background: #bbf7d0;
  padding: 2px 14px;
  margin-right: 14px;
  letter-spacing: 0.02em;
}
.exam-expl-row {
  margin-top: 10px;
  color: #475569;
  font-size: 0.98em;
  background: #f1f5f9;
  border-radius: 7px;
  padding: 10px 13px;
}

/* Reveal Answer Button */
.exam-reveal-btn {
  background: #6366f1;
  color: white;
  font-size: .97rem;
  border: 0;
  border-radius: 7px;
  padding: 7px 20px;
  margin-top: 13px;
  cursor: pointer;
  font-weight: 500;
  transition: background .13s;
  box-shadow: 0 1px 5px rgba(100,100,222,0.03);
}
.exam-reveal-btn:hover { background: #4f46e5; }
@media (max-width:700px) {
  .exam-question-card {padding:12px 2px 12px 6px;}
}
</style>

<!-- ======= EXAM UI RENDER LOGIC ======= -->
<script>
const padiAiForm = document.getElementById('padiAiForm');
const padiAiFile = document.getElementById('padiAiFile');
const padiAiQType = document.getElementById('padiAiQType');
const padiAiCount = document.getElementById('padiAiCount');
const padiAiFormat = document.getElementById('padiAiFormat');
const padiAiInstr = document.getElementById('padiAiInstructions');
const padiAiSubmit = document.getElementById('padiAiSubmit');
const padiAiSubmitLabel = document.getElementById('padiAiSubmitLabel');
const padiAiSpinner = document.getElementById('padiAiSpinner');
const padiAiResult = document.getElementById('padiAiResult');
const padiRevealAnswers = document.getElementById('padiRevealAnswers');
const padiRevealAnswersWrap = document.getElementById('padiRevealAnswersWrap');
const padiAiDownload = document.getElementById('padiAiDownload');
const padiAiClear = document.getElementById('padiAiClear');
const examQuestionSet = document.getElementById('examQuestionSet');
const examSetStats = document.getElementById('examSetStats');

let lastRenderedOut = null;

// Utility
function escapeHtml(str) {
  if (!str) return '';
  return String(str)
    .replace(/[&<>"]/g, function(s) {
      switch(s){
        case '&':return '&amp;';
        case '<':return '&lt;';
        case '>':return '&gt;';
        case '"':return '&quot;';
      }
    });
}

function setAiUiBusy(b) {
  padiAiSubmit.disabled = b;
  padiAiSpinner.classList.toggle('hidden', !b);
  padiAiSubmitLabel.textContent = b ? 'Convertingâ€¦' : 'Convert';
}


function renderAiExamResult(out) {
  // Helper
  function escapeHtml(str) {
    if (!str) return '';
    return String(str)
      .replace(/[&<>"]/g, function(s) {
        switch(s){
          case '&':return '&amp;';
          case '<':return '&lt;';
          case '>':return '&gt;';
          case '"':return '&quot;';
        }
      });
  }
  const examQuestionSet = document.getElementById('examQuestionSet');
  const examSetStats = document.getElementById('examSetStats');
  const padiAiResult = document.getElementById('padiAiResult');
  const padiAiDownload = document.getElementById('padiAiDownload');
  const padiRevealAnswersWrap = document.getElementById('padiRevealAnswersWrap');
  const padiRevealAnswers = document.getElementById('padiRevealAnswers');

  padiAiResult.classList.remove('hidden');
  examSetStats.textContent = '';
  padiRevealAnswersWrap.classList.add('hidden'); // hide unless MCQ
  
  let questionsArray = null;
  let examTxt = null;

  // Detect structure
  if (out.questions && Array.isArray(out.questions)) {
    questionsArray = out.questions;
  } else if (out.questions && typeof out.questions.raw === 'string') {
    examTxt = out.questions.raw;
  } else if (out.questions && Array.isArray(out.questions.raw)) {
    questionsArray = out.questions.raw;
  } else if (typeof out.raw === 'string') {
    examTxt = out.raw;
  } else if (typeof out.questions === 'string') {
    examTxt = out.questions;
  }

  if (questionsArray && questionsArray.length) {
    // MCQ/Short-answer array output
    examSetStats.textContent = `(${questionsArray.length} questions)`;
    padiRevealAnswersWrap.classList.remove('hidden');

    let html = '';
    questionsArray.forEach((q, i) => {
      let qText = q.question || q.text || q.prompt || q.title || `Question ${i+1}`;
      let opts = q.options || q.choices || null;
      let answer = q.answer || q.correct || q.key || q.solution || null;
      let explanation = q.explanation || q.expl || q.reason || null;
      html += `<div class="exam-question-card" id="exam-qcard-${i}">
        <div><span class="exam-qnum">${i+1}.</span> <span class="exam-qtext">${escapeHtml(qText)}</span></div>`;
      // MCQ options
      if (Array.isArray(opts) && opts.length) {
        html += `<div class="exam-mcq-opts pt-2">`;
        opts.forEach((opt, j) => {
          html += `<div class="exam-mcq-opt">
            <label><input name="aiq_${i}" type="radio" value="${escapeHtml(opt)}" disabled />
            <span>${String.fromCharCode(65+j)}. ${escapeHtml(opt)}</span></label>
            </div>`;
        });
        html += `</div>`;
      }
      if (answer) {
        html += `<button class="exam-reveal-btn mt-2" type="button" data-idx="${i}">Reveal Answer</button>`;
        let ansHtml = '';
        if (opts && /^\d+$/.test(String(answer))) {
          let idx = parseInt(answer,10),
            letter=String.fromCharCode(65+idx),
            txt=(opts[idx]||answer);
          ansHtml = `<span class="exam-ans-badge">Correct</span> ${letter}. ${escapeHtml(txt)}`;
        } else if (opts && typeof answer === 'string') {
          let idx = opts.findIndex(o => String(o).trim().toLowerCase() === String(answer).trim().toLowerCase());
          if (idx >= 0)
            ansHtml = `<span class="exam-ans-badge">Correct</span> ${String.fromCharCode(65+idx)}. ${escapeHtml(answer)}`;
          else
            ansHtml = `<span class="exam-ans-badge">Correct</span> ${escapeHtml(answer)}`;
        } else {
          ansHtml = `<span class="exam-ans-badge">Answer</span> ${escapeHtml(answer)}`;
        }
        let explHtml = explanation ? `<div class="exam-expl-row">${escapeHtml(explanation)}</div>` : '';
        html += `<div class="exam-answer-row" id="exam-ans-${i}">${ansHtml}</div>${explHtml}`;
      }
      html += `</div>`;
    });
    examQuestionSet.innerHTML = html;

    // Per-question reveal
    questionsArray.forEach((q, i) => {
      let btn = document.querySelector(`#exam-qcard-${i} .exam-reveal-btn`);
      let ansDiv = document.getElementById(`exam-ans-${i}`);
      if (btn && ansDiv) {
        btn.addEventListener('click', function() {
          let vis = ansDiv.classList.toggle('visible');
          btn.textContent = vis ? "Hide Answer" : "Reveal Answer";
        });
      }
    });

    // Global reveal all
    function updateRevealAll(checked) {
      questionsArray.forEach((q, i) => {
        let ansDiv = document.getElementById(`exam-ans-${i}`);
        let btn = document.querySelector(`#exam-qcard-${i} .exam-reveal-btn`);
        if (ansDiv) {
          ansDiv.classList.toggle('visible', checked);
          if (btn) btn.textContent = checked ? "Hide Answer" : "Reveal Answer";
        }
      });
    }
    padiRevealAnswers.onchange = () => updateRevealAll(padiRevealAnswers.checked);

    // Download as JSON
    padiAiDownload.onclick = () => {
      const blob = new Blob([JSON.stringify(questionsArray, null, 2)], {type: 'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `questions_${Date.now()}.json`;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    };

  } else if (examTxt) {
    // Plain text readable output
    examQuestionSet.innerHTML = `
      <div style="font-family:serif; padding:.5rem 1rem 0 1rem; font-size:1.08rem; color:#222; line-height:1.85;">
        ${examTxt.split(/\n{2,}/)
          .map(p => `<p style="margin:0 0 1.25em 0;">${escapeHtml(p).replace(/\n/g, "<br>")}</p>`)
          .join('')}
      </div>`;
    examSetStats.textContent = '';
    padiRevealAnswersWrap.classList.add('hidden');
    // Download as text
    padiAiDownload.onclick = () => {
      const blob = new Blob([examTxt], {type: 'text/plain'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `converted_${Date.now()}.txt`;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    };
  } else {
    // Fallback: pretty JSON
    examQuestionSet.innerHTML = `<pre class="text-xs whitespace-pre-wrap">${escapeHtml(JSON.stringify(out,null,2))}</pre>`;
    examSetStats.textContent = '';
    padiRevealAnswersWrap.classList.add('hidden');
  }
}

function renderExamPlainText(txt) {
  examQuestionSet.innerHTML =
    `<div style="font-family:serif; padding:1.3rem 0 .3rem 1rem; font-size:1.09rem; color:#1e293b; line-height:1.85;">
      ${String(txt).split(/\n{2,}/).map(s=>`<p style="margin:0 0 1.1em 0;">${escapeHtml(s).replace(/\n/g,'<br>')}</p>`).join('')}
     </div>`;
  examSetStats.textContent = '';
  padiRevealAnswersWrap.classList.add('hidden');

  // Download as text
  padiAiDownload.onclick = () => {
    const blob = new Blob([txt], {type: 'text/plain'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `converted_${Date.now()}.txt`;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  };
}

padiAiForm.addEventListener('submit', async function(e){
  e.preventDefault();
  if (!padiAiFile.files || !padiAiFile.files[0]) {
    return alert('Please choose a file to upload.');
  }
  let count = parseInt(padiAiCount.value)||10;
  if (count<1) count=1;
  if (count>40) count=40;
  const fd = new FormData();
  fd.append('file', padiAiFile.files[0]);
  fd.append('qtype', padiAiQType.value);
  fd.append('count', String(count));
  fd.append('format', padiAiFormat.value);
  fd.append('instructions', padiAiInstr.value || '');
  setAiUiBusy(true);
  padiAiResult.classList.add('hidden');
  examQuestionSet.innerHTML = '';
  lastRenderedOut = null;

  try {
    const token = localStorage.getItem('token') || '';
    const headers = {};
    if (token) headers['Authorization'] = 'Bearer ' + token;
    const resp = await fetch('https://examguide.onrender.com/api/studypadi/ai/convert-file', {
      method: 'POST', credentials: 'include', headers, body: fd
    });
    if (!resp.ok) {
      const txt = await resp.text();
      throw new Error(`Server error: ${resp.status} ${txt}`);
    }
    const out = await resp.json();
    padiAiResult.classList.remove('hidden');

    let examTxt = null;
    if (out.questions && typeof out.questions.raw === 'string') {
      examTxt = out.questions.raw;
    } else if (typeof out.raw === 'string') {
      examTxt = out.raw;
    } else if (typeof out.questions === 'string') {
      examTxt = out.questions;
    }

    if (examTxt) {
      // Plain readable output
      examQuestionSet.innerHTML = `
        <div style="font-family:serif; padding:.5rem 1rem 0 1rem; font-size:1.08rem; color:#222; line-height:1.85;">
          ${examTxt.split(/\n{2,}/)
            .map(p => `<p style="margin:0 0 1.25em 0;">${escapeHtml(p).replace(/\n/g, "<br>")}</p>`)
            .join('')}
        </div>`;
      examSetStats.textContent = '';
      padiRevealAnswersWrap.classList.add('hidden');
      padiAiDownload.onclick = () => {
        const blob = new Blob([examTxt], {type: 'text/plain'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `converted_${Date.now()}.txt`;
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);
      };
    } else if (out.questions && Array.isArray(out.questions)) {
      renderExamAiOutput(out);
    } else {
      examQuestionSet.innerHTML = `<pre class="text-xs whitespace-pre-wrap">${escapeHtml(JSON.stringify(out,null,2))}</pre>`;
      padiRevealAnswersWrap.classList.add('hidden');
    }
  } catch (err) {
    examQuestionSet.innerHTML = `<div class="text-red-700 font-medium">Error: ${escapeHtml(err.message||'Conversion failed')}</div>`;
    padiRevealAnswersWrap.classList.add('hidden');
    padiAiResult.classList.remove('hidden');
  } finally {
    setAiUiBusy(false);
  }
});

padiAiClear.addEventListener('click', () => {
  examQuestionSet.innerHTML = '';
  padiAiResult.classList.add('hidden');
  padiAiFile.value = '';
  lastRenderedOut = null;
});

// =================== SAVED SETS SECTION (retain original logic if needed) ===================
/* Try several candidate endpoints to fetch saved sets (be tolerant of backend naming) */
async function fetchSavedSets() {
  const token = localStorage.getItem('token') || '';
  const headers = {};
  if (token) headers['Authorization'] = 'Bearer ' + token;
  const candidates = [
    '/api/studypadi/ai/sets',
    '/api/studypadi/ai/history',
    '/api/studypadi/ai/list',
    '/api/studypadi/ai/previous'
  ];
  let sets = null;
  for (const ep of candidates) {
    try {
      const resp = await fetch(ep, { credentials: 'include', headers });
      if (!resp.ok) continue;
      const data = await resp.json();
      // accept array directly or object with 'sets'/'data'/'items'
      if (Array.isArray(data)) { sets = data; break; }
      if (Array.isArray(data.sets)) { sets = data.sets; break; }
      if (Array.isArray(data.items)) { sets = data.items; break; }
      if (Array.isArray(data.data)) { sets = data.data; break; }
    } catch (e) {
      // ignore and try next
    }
  }
  return sets || [];
}

/* Render saved sets list */
function renderSavedSetsList(sets) {
  padiSavedSets.innerHTML = '';
  if (!sets || !sets.length) {
    padiSavedEmpty.classList.remove('hidden');
    return;
  }
  padiSavedEmpty.classList.add('hidden');

  sets.forEach((s) => {
    // Normalize fields
    const title = s.title || s.setTitle || s.name || (s._id ? `Set ${s._id}` : 'Untitled');
    const qcount = Array.isArray(s.questions) ? s.questions.length : (s.count || s.num || (s._meta && s._meta.count) || '-');
    const created = s.createdAt || s.created || s._created || s.date || '';
    const id = s._id || s.id || title;

    const card = document.createElement('div');
    card.className = 'bg-white rounded-lg p-3 border shadow-sm flex flex-col';
    card.innerHTML = `
      <div class="flex items-center justify-between">
        <div class="text-gray-800 font-semibold">${escapeHtml(title)}</div>
        <div class="text-xs text-gray-500">${created ? new Date(created).toLocaleString() : ''}</div>
      </div>
      <div class="text-xs text-gray-600 mt-2">Questions: <span class="font-semibold text-gray-800">${qcount}</span></div>
      <div class="mt-3 flex gap-2">
        <button class="padi-open-set-btn bg-indigo-600 text-white px-3 py-1 rounded text-sm" data-id="${escapeHtml(String(id))}">Open</button>
        <button class="padi-download-set-btn bg-white border px-3 py-1 rounded text-sm" data-id="${escapeHtml(String(id))}">Download</button>
      </div>
    `;
    padiSavedSets.appendChild(card);
  });

  // Attach listeners
  padiSavedSets.querySelectorAll('.padi-open-set-btn').forEach(btn => {
    btn.addEventListener('click', async (e) => {
      const id = btn.getAttribute('data-id');
      openSavedSet(id);
    });
  });
  padiSavedSets.querySelectorAll('.padi-download-set-btn').forEach(btn => {
    btn.addEventListener('click', async (e) => {
      const id = btn.getAttribute('data-id');
      downloadSavedSet(id);
    });
  });
}

/* Open a saved set in modal - try endpoints to fetch a single set by id */
async function openSavedSet(id) {
  const token = localStorage.getItem('token') || '';
  const headers = {};
  if (token) headers['Authorization'] = 'Bearer ' + token;
  const candidates = [
    `/api/studypadi/ai/sets/${id}`,
    `/api/studypadi/ai/history/${id}`,
    `/api/studypadi/ai/get/${id}`,
    `/api/studypadi/ai/${id}`
  ];
  let set = null;
  for (const ep of candidates) {
    try {
      const resp = await fetch(ep, { credentials: 'include', headers });
      if (!resp.ok) continue;
      const data = await resp.json();
      // Accept direct set object or nested object
      if (data && (data.questions || Array.isArray(data))) { set = data; break; }
      if (data.set) { set = data.set; break; }
      if (data.data) { set = data.data; break; }
    } catch (e) {}
  }

  if (!set) {
    alert('Could not load saved set from server. The endpoint may be different. Check server or use Refresh.');
    return;
  }

  // Normalize to object { title, questions, raw, createdAt, _id }
  const normalized = {
    title: set.title || set.setTitle || set.name || ('Saved Set'),
    questions: Array.isArray(set.questions) ? set.questions : (Array.isArray(set) ? set : (typeof set.questions === 'string' ? null : null)),
    raw: typeof set.raw === 'string' ? set.raw : null,
    createdAt: set.createdAt || set.created || null,
    _id: set._id || set.id || null
  };

  lastModalSet = normalized;

  padiSavedModalTitle.textContent = normalized.title || 'Saved Set';
  if (normalized.questions && normalized.questions.length) {
    padiSavedModalContent.innerHTML = '';
    const container = document.createElement('div');
    for (let i = 0; i < normalized.questions.length; i++) {
      const q = normalized.questions[i];
      const wrapper = document.createElement('div');
      wrapper.className = 'question';
      wrapper.innerHTML = buildQuestionHTML(q, i);
      container.appendChild(wrapper);
    }
    padiSavedModalContent.appendChild(container);
  } else if (normalized.raw) {
    padiSavedModalContent.innerHTML = `<div class="prose">${nl2brEscaped(normalized.raw)}</div>`;
  } else {
    padiSavedModalContent.innerHTML = `<pre class="text-xs whitespace-pre-wrap">${escapeHtml(JSON.stringify(set, null, 2))}</pre>`;
  }

  // ensure modal answer visibility follows main reveal checkbox
  if (!padiRevealAnswers.checked) {
    padiSavedModalContent.classList.add(ANSWERS_HIDDEN_CLASS);
  } else {
    padiSavedModalContent.classList.remove(ANSWERS_HIDDEN_CLASS);
  }

  padiSavedModal.classList.remove('hidden');
}

/* Download saved set JSON (try to load then download) */
async function downloadSavedSet(id) {
  const token = localStorage.getItem('token') || '';
  const headers = {};
  if (token) headers['Authorization'] = 'Bearer ' + token;
  const epCandidates = [
    `/api/studypadi/ai/sets/${id}`,
    `/api/studypadi/ai/history/${id}`,
    `/api/studypadi/ai/get/${id}`,
    `/api/studypadi/ai/${id}`
  ];
  for (const ep of epCandidates) {
    try {
      const resp = await fetch(ep, { credentials: 'include', headers });
      if (!resp.ok) continue;
      const data = await resp.json();
      const payload = (data && (data.questions || data)) ? (data.questions ? data.questions : data) : data;
      const blob = new Blob([JSON.stringify(payload, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `savedset_${id}_${Date.now()}.json`;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
      return;
    } catch (e) {}
  }
  alert('Could not download saved set. The server endpoint may be different.');
}

/* Attach listeners for modal controls */
padiSavedModalClose.addEventListener('click', () => padiSavedModal.classList.add('hidden'));
padiSavedModalDownload.addEventListener('click', () => {
  if (!lastModalSet) return;
  const payload = lastModalSet.questions || lastModalSet.raw || lastModalSet;
  const blob = new Blob([JSON.stringify(payload, null, 2)], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `${(lastModalSet.title||'savedset').replace(/\s+/g,'_')}_${Date.now()}.json`;
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
});
padiSavedModalCopy.addEventListener('click', async () => {
  if (!lastModalSet) return;
  const payload = lastModalSet.questions || lastModalSet.raw || lastModalSet;
  try {
    await navigator.clipboard.writeText(JSON.stringify(payload, null, 2));
    alert('JSON copied to clipboard');
  } catch (e) {
    alert('Could not copy to clipboard');
  }
});

/* Open/close reveal answers toggle */
padiRevealAnswers.addEventListener('change', () => {
  updateRevealAnswersUI();
  // also update modal if open
  if (!padiSavedModal.classList.contains('hidden')) {
    if (!padiRevealAnswers.checked) padiSavedModalContent.classList.add(ANSWERS_HIDDEN_CLASS);
    else padiSavedModalContent.classList.remove(ANSWERS_HIDDEN_CLASS);
  }
});

/* Attempt to load saved sets on page load */
async function loadSavedSets() {
  padiSavedSets.innerHTML = `<div class="text-gray-500 col-span-full">Loadingâ€¦</div>`;
  try {
    const sets = await fetchSavedSets();
    renderSavedSetsList(sets);
  } catch (e) {
    padiSavedSets.innerHTML = `<div class="text-red-500 col-span-full">Failed to load saved sets</div>`;
  }
}
padiRefreshSaved.addEventListener('click', loadSavedSets);

/* Main form submit */
padiAiForm.addEventListener('submit', async function(e){
  e.preventDefault();
  if (!padiAiFile.files || !padiAiFile.files[0]) {
    return alert('Please choose a file to upload.');
  }
  let count = parseInt(padiAiCount.value) || 10;
  if (count < 1) count = 1;
  if (count > 40) count = 40;

  const fd = new FormData();
  fd.append('file', padiAiFile.files[0]);
  fd.append('qtype', padiAiQType.value);
  fd.append('count', String(count));
  fd.append('format', padiAiFormat.value);
  fd.append('instructions', padiAiInstr.value || '');

  setAiUiBusy(true);
  padiAiResult.classList.add('hidden');
  padiAiResultContent.textContent = '';

  try {
    // attach token from localStorage if available
    const token = localStorage.getItem('token') || '';
    if (!token) {
      console.warn('No token found in localStorage â€” request will be sent without Authorization header (cookies may still be used).');
    }

    const headers = {};
    if (token) headers['Authorization'] = 'Bearer ' + token;

    const resp = await fetch('https://examguide.onrender.com/api/studypadi/ai/convert-file', {
      method: 'POST',
      credentials: 'include',
      headers,
      body: fd
    });
    if (!resp.ok) {
      const txt = await resp.text();
      throw new Error(`Server error: ${resp.status} ${txt}`);
    }
    const out = await resp.json();

    // Render nicely
    renderAiOutput(out);

    // Optionally refresh saved sets (if backend stores them automatically)
    setTimeout(loadSavedSets, 800);

  } catch (err) {
    console.error(err);
    alert(err.message || 'Conversion failed');
  } finally {
    setAiUiBusy(false);
  }
});

padiAiClear.addEventListener('click', () => {
  padiAiResultContent.textContent = '';
  padiAiResult.classList.add('hidden');
  padiAiFile.value = '';
  lastRenderedOut = null;
});

/* initialize */
document.addEventListener('DOMContentLoaded', () => {
  // hide answers by default
  padiRevealAnswers.checked = false;
  updateRevealAnswersUI();
  loadSavedSets();
});

</script> 
    
    <!-- Motivational Banner -->
    <div class="bg-gradient-to-br from-yellow-400 via-indigo-400 to-blue-600 rounded-xl px-7 py-6 text-white shadow flex flex-col md:flex-row items-center gap-5">
      <div class="flex-1">
        <h3 class="text-xl font-bold">Tip:</h3>
        <p class="text-md mb-1">Set realistic goals and review your progress at least once a week for continuous improvement.</p>
     </div>
      <div>
        <button id="setWeeklyGoalBtn" class="bg-white/30 hover:bg-white/50 text-white font-semibold rounded px-6 py-2 transition">Set Weekly Goal</button>
      </div>
    </div>
  </div>

  <!-- Add / Edit Study Goal Modal -->
  <div id="addPadiModal" class="fixed inset-0 bg-black bg-opacity-40 z-50 flex items-center justify-center hidden">
    <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg mx-4 p-6 flex flex-col gap-4 relative">
      <button id="closeAddPadiModal" class="absolute top-4 right-5 text-gray-400 hover:text-indigo-600 text-2xl">&times;</button>
      <h3 id="addModalTitle" class="font-bold text-2xl mb-1 text-indigo-900">Add New Study Goal</h3>
      <form id="padiForm" class="flex flex-col gap-3">
        <input type="hidden" id="padiId" />
        <div>
          <label class="font-medium mb-1 block">Goal Title*</label>
          <input id="padiTitle" type="text" class="border rounded-lg p-2 w-full" placeholder="Goal title" required>
        </div>
        <div>
          <label class="font-medium mb-1 block">Course*</label>
          <input id="padiCourse" type="text" class="border rounded-lg p-2 w-full" placeholder="Course code or name (e.g. BIO102)" required>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-2">
          <div>
            <label class="font-medium mb-1 block">Due Date</label>
            <input id="padiDue" type="date" class="border rounded-lg p-2 w-full" />
          </div>
          <div>
            <label class="font-medium mb-1 block">Estimated Duration (mins)</label>
            <input id="padiDuration" type="number" min="1" class="border rounded-lg p-2 w-full" placeholder="60" />
          </div>
        </div>
        <div>
          <label class="font-medium mb-1 block">Description</label>
          <textarea id="padiDesc" class="border rounded-lg p-2 w-full min-h-[70px]" placeholder="Describe your study goal..." ></textarea>
        </div>
        <div class="flex gap-2 justify-end">
          <button type="button" id="padiDeleteBtn" class="bg-red-100 text-red-700 px-4 py-2 rounded hidden">Delete</button>
          <button type="submit" id="padiSaveBtn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-semibold rounded px-6 py-2 shadow">Save Goal</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Quick Session Modal -->
  <div id="quickSessionModal" class="fixed inset-0 bg-black bg-opacity-40 z-50 flex items-center justify-center hidden">
    <div class="bg-white rounded-xl shadow-2xl w-full max-w-md mx-4 p-6 flex flex-col gap-4 relative">
      <button id="closeQuickSessionModal" class="absolute top-4 right-5 text-gray-400 hover:text-indigo-600 text-2xl">&times;</button>
      <h3 class="font-bold text-lg text-indigo-900">Quick Study Session</h3>
      <form id="quickSessionForm" class="flex flex-col gap-3">
        <div>
          <label class="font-medium mb-1 block">Select Goal (optional)</label>
          <select id="quickSessionGoal" class="border rounded-lg p-2 w-full">
            <option value="">-- None --</option>
          </select>
        </div>
        <div class="grid grid-cols-2 gap-2">
          <div>
            <label class="font-medium mb-1 block">Start</label>
            <input id="quickStart" type="datetime-local" class="border rounded-lg p-2 w-full" />
          </div>
          <div>
            <label class="font-medium mb-1 block">Duration (mins)</label>
            <input id="quickDuration" type="number" min="5" value="30" class="border rounded-lg p-2 w-full" />
          </div>
        </div>
        <div class="flex gap-2 justify-end">
          <button type="submit" id="quickSessionSaveBtn" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded font-semibold">Start Session</button>
        </div>
      </form>
    </div>
  </div>
</div>

<script>

const API_BASE = "https://examguide.onrender.com/api/studypadi";
let goals = [], sessions = [], timeline = [];

// Auth header helper
function getAuthHeaders() {
  const token = localStorage.getItem("token");
  return token ? { "Authorization": "Bearer " + token } : {};
}

// Fetch helpers with consistent error handling
async function apiGET(path) {
  const res = await fetch(API_BASE + path, { credentials: "include", headers: getAuthHeaders() });
  if (!res.ok) throw new Error(`GET ${path} failed: ${res.status}`);
  return res.json();
}
async function apiPOST(path, body) {
  const res = await fetch(API_BASE + path, {
    method: "POST",
    credentials: "include",
    headers: { ...getAuthHeaders(), "Content-Type": "application/json" },
    body: JSON.stringify(body)
  });
  if (!res.ok) throw new Error(`POST ${path} failed: ${res.status}`);
  return res.json();
}
async function apiPUT(path, body) {
  const res = await fetch(API_BASE + path, {
    method: "PUT",
    credentials: "include",
    headers: { ...getAuthHeaders(), "Content-Type": "application/json" },
    body: JSON.stringify(body)
  });
  if (!res.ok) throw new Error(`PUT ${path} failed: ${res.status}`);
  return res.json();
}
async function apiDELETE(path) {
  const res = await fetch(API_BASE + path, {
    method: "DELETE",
    credentials: "include",
    headers: getAuthHeaders()
  });
  if (!res.ok) throw new Error(`DELETE ${path} failed: ${res.status}`);
  return res.json();
}
async function apiPATCH(path, body) {
  const res = await fetch(API_BASE + path, {
    method: "PATCH",
    credentials: "include",
    headers: { ...getAuthHeaders(), "Content-Type": "application/json" },
    body: JSON.stringify(body)
  });
  if (!res.ok) throw new Error(`PATCH ${path} failed: ${res.status}`);
  return res.json();
}

/* Utility helpers */
function esc(s){ if (s==null) return ''; return String(s).replaceAll('<','&lt;').replaceAll('>','&gt;'); }
function fmtDateTime(ts){ if (!ts) return ''; const d = new Date(ts); return d.toLocaleString(); }

// Spinner HTML (small)
function spinnerInline() {
  return `<svg class="animate-spin inline-block w-4 h-4 mr-1" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="3" fill="none"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"/></svg>`;
}

// Disable button and show spinner
function setButtonLoading(btn, loading, labelWhenProcessing) {
  if (!btn) return;
  if (loading) {
    if (!btn.dataset.origHtml) btn.dataset.origHtml = btn.innerHTML;
    btn.disabled = true;
    btn.classList.add('opacity-70', 'pointer-events-none');
    btn.innerHTML = spinnerInline() + (labelWhenProcessing || (btn.dataset.origLabel || btn.innerText || 'Processing'));
  } else {
    btn.disabled = false;
    btn.classList.remove('opacity-70', 'pointer-events-none');
    if (btn.dataset.origHtml) {
      btn.innerHTML = btn.dataset.origHtml;
      delete btn.dataset.origHtml;
    }
  }
}

/* Normalize backend documents to expose .id for convenience */
function normalizeGoal(g) { return { ...g, id: g._id || g.id }; }
function normalizeSession(s) { return { ...s, id: s._id || s.id }; }
function normalizeTimeline(t) { return { ...t, id: t._id || t.id }; }

/* --- Loaders (normalize _id -> id) --- */
async function loadGoals() {
  try {
    const data = await apiGET("/goals");
    if (Array.isArray(data)) goals = data.map(normalizeGoal);
    else if (Array.isArray(data.goals)) goals = data.goals.map(normalizeGoal);
    else goals = [];
  } catch (e) { console.error("loadGoals:", e); goals = []; }
}
async function loadSessions() {
  try {
    const data = await apiGET("/sessions");
    if (Array.isArray(data)) sessions = data.map(normalizeSession);
    else if (Array.isArray(data.sessions)) sessions = data.sessions.map(normalizeSession);
    else sessions = [];
  } catch (e) { console.error("loadSessions:", e); sessions = []; }
}
async function loadTimeline() {
  try {
    const data = await apiGET("/timeline");
    if (Array.isArray(data)) timeline = data.map(normalizeTimeline);
    else if (Array.isArray(data.timeline)) timeline = data.timeline.map(normalizeTimeline);
    else timeline = [];
  } catch (e) { console.error("loadTimeline:", e); timeline = []; }
}

async function loadAllBackend() {
  await Promise.allSettled([loadGoals(), loadSessions(), loadTimeline()]);
  renderAll();
}

/* --- Renderers --- */
function renderCards() {
  const container = document.getElementById('padi-cards');
  container.innerHTML = '';

  // Upcoming session (next that is not ended)
  const upcoming = sessions.filter(s => !s.endedAt && s.status !== 'cancelled').sort((a,b)=> new Date(a.start) - new Date(b.start))[0];
  if (upcoming) {
    const g = upcoming.goalId ? goals.find(x => x.id === upcoming.goalId || x._id === upcoming.goalId) : null;
    const startLabel = fmtDateTime(upcoming.start);
    const card = document.createElement('div');
    card.className = 'bg-white rounded-xl shadow p-6 flex flex-col gap-3';
    card.innerHTML = `
      <div class="flex items-center gap-3">
        <span class="bg-indigo-100 text-indigo-700 font-semibold px-3 py-1 rounded-lg text-xs">Session</span>
        <span class="bg-green-100 text-green-700 px-2 py-1 rounded-lg text-xs font-semibold">${esc(startLabel)}</span>
      </div>
      <h3 class="font-bold text-lg text-indigo-900 mb-2">${ g ? esc(g.title) : 'Quick Study Session' }</h3>
      <p class="text-gray-600 mb-2 text-sm">Duration: ${esc(upcoming.durationMin)} mins<br>Status: ${esc(upcoming.status || 'scheduled')}</p>
      <div class="flex gap-2">
        ${upcoming.status === 'in-progress' ? `<button class="action-btn action-small bg-indigo-600 hover:bg-indigo-700 text-white font-semibold rounded px-4 py-2 text-xs shadow" data-action="end" data-id="${upcoming.id}">End Session</button>`
        : `<button class="action-btn action-small bg-indigo-600 hover:bg-indigo-700 text-white font-semibold rounded px-4 py-2 text-xs shadow" data-action="join" data-id="${upcoming.id}">Join Session</button>`}
        <button class="action-btn action-small bg-white border border-gray-200 text-gray-700 rounded px-3 py-2 text-xs" data-action="cancel" data-id="${upcoming.id}">Cancel</button>
      </div>
    `;
    container.appendChild(card);
  } else {
    const card = document.createElement('div');
    card.className = 'bg-white rounded-xl shadow p-6 flex flex-col gap-3';
    card.innerHTML = `
      <div class="flex items-center gap-3">
        <span class="bg-indigo-100 text-indigo-700 font-semibold px-3 py-1 rounded-lg text-xs">Session</span>
        <span class="text-sm text-gray-500">No upcoming sessions</span>
      </div>
      <h3 class="font-bold text-lg text-indigo-900 mb-2">Start a session now</h3>
      <p class="text-gray-600 mb-2 text-sm">Use Quick Session to start a focused study period.</p>
      <button class="action-btn action-small bg-indigo-600 hover:bg-indigo-700 text-white font-semibold rounded px-4 py-2 text-xs shadow" id="startQuickBtn">Start Quick Session</button>
    `;
    container.appendChild(card);
  }

  // Goals
  if (!goals.length) {
    const empty = document.createElement('div');
    empty.className = 'bg-white rounded-xl shadow p-6';
    empty.innerHTML = `<div class="text-gray-500">No study goals yet. Add one to get started.</div>`;
    container.appendChild(empty);
  } else {
    goals.slice().sort((a,b)=> new Date(b.createdAt) - new Date(a.createdAt)).forEach(goal => {
      // use normalized goal.id (from _id)
      const idVal = goal.id || goal._id;
      const card = document.createElement('div');
      card.className = 'bg-white rounded-xl shadow p-6 flex flex-col gap-3';
      card.innerHTML = `
        <div class="flex items-center gap-3">
          <span class="bg-pink-100 text-pink-700 font-semibold px-3 py-1 rounded-lg text-xs">Goal</span>
          <span class="bg-yellow-100 text-yellow-700 px-2 py-1 rounded-lg text-xs font-semibold">${ goal.due ? 'Due: ' + new Date(goal.due).toLocaleDateString() : 'No due date' }</span>
        </div>
        <h3 class="font-bold text-lg text-indigo-900 mb-2">${esc(goal.title)}</h3>
        <div class="flex items-center gap-2 mb-2">
          <span class="inline-block px-2 py-1 bg-blue-100 text-blue-700 rounded text-xs font-semibold">${esc(goal.course)}</span>
          <span class="inline-block px-2 py-1 bg-gray-100 text-gray-700 rounded text-xs font-semibold">${goal.durationMin || '-'} mins</span>
        </div>
        <p class="text-gray-600 mb-2 text-sm">${esc(goal.description||'')}</p>
        <div class="flex gap-2">
          <button class="action-btn action-small bg-yellow-100 hover:bg-yellow-200 text-yellow-700 font-bold rounded px-4 py-2 text-xs shadow" data-action="toggleDone" data-id="${idVal}">${goal.completed ? 'Completed' : 'Mark as Done'}</button>
          <button class="action-btn action-small bg-white border border-gray-200 text-gray-700 rounded px-3 py-2 text-xs" data-action="edit" data-id="${idVal}">Edit</button>
          <button class="action-btn action-small bg-white border border-gray-200 text-red-600 rounded px-3 py-2 text-xs" data-action="delete" data-id="${idVal}">Delete</button>
        </div>
      `;
      container.appendChild(card);
    });
  }
}

function renderOverview() {
  const el = document.getElementById('padi-overview');
  const goalsDone = goals.filter(g => g.completed).length;
  const sessionsDone = sessions.filter(s => s.endedAt != null).length;
  const mins = sessions.filter(s => s.endedAt).reduce((sum,s)=> sum + (s.durationMin || 0), 0);
  el.innerHTML = `
    <div>
      <h3 class="font-bold text-lg mb-1">Todayâ€™s Progress</h3>
      <div class="flex flex-col gap-2 text-sm">
        <span>Sessions Completed: <span class="font-bold">${sessionsDone}</span></span>
        <span>Goals Achieved: <span class="font-bold">${goalsDone}</span></span>
        <span>Hours Studied: <span class="font-bold">${Math.floor(mins/60)}h ${mins%60}m</span></span>
      </div>
    </div>
    <div class="flex flex-col justify-center">
      <div class="text-sm mb-2">Keep up the great work! Stay consistent for better results.</div>
      <button id="seeFullJournalBtn" class="bg-white/20 hover:bg-white/40 text-white font-semibold rounded px-5 py-2 transition">See Full Journal</button>
    </div>
  `;
}

function renderTimeline() {
  const el = document.getElementById('padi-timeline');
  el.innerHTML = `<h3 class="text-lg font-semibold text-indigo-800 mb-3">Learning Timeline</h3>`;
  if (!Array.isArray(timeline) || timeline.length === 0) {
    el.innerHTML += `<div class="text-gray-500 p-4">No journal entries yet.</div>`;
    return;
  }
  const list = document.createElement('ol');
  list.className = 'relative border-l border-indigo-200 ml-4';
  timeline.forEach(entry => {
    const li = document.createElement('li');
    li.className = 'mb-5 ml-6';
    const colorClass = entry.type === 'session' ? 'bg-indigo-100 text-indigo-700' : (entry.type === 'goal' ? 'bg-green-100 text-green-700' : 'bg-yellow-100 text-yellow-700');
    li.innerHTML = `
      <span class="absolute -left-3 flex items-center justify-center w-6 h-6 ${colorClass} rounded-full ring-8 ring-white">
        <svg class="w-3 h-3 ${entry.type === 'session' ? 'text-indigo-700' : entry.type === 'goal' ? 'text-green-700' : 'text-yellow-700'}" fill="currentColor"><circle cx="1.5" cy="1.5" r="1.5"></circle></svg>
      </span>
      <div class="font-semibold text-indigo-900">${esc(entry.title)}</div>
      <span class="text-xs text-gray-400">${new Date(entry.time).toLocaleString()}</span>
      <div class="text-sm text-gray-700 mt-1">${esc(entry.msg)}</div>
    `;
    list.appendChild(li);
  });
  el.appendChild(list);
}

function renderAll() {
  renderCards();
  renderOverview();
  renderTimeline();
}

/* === Actions calling backend === */
async function createGoal(payload) { return apiPOST("/goals", payload); }
async function updateGoal(id, payload) { return apiPUT(`/goals/${encodeURIComponent(id)}`, payload); }
async function removeGoal(id) { return apiDELETE(`/goals/${encodeURIComponent(id)}`); }
async function createSession(payload) { return apiPOST("/sessions", payload); }
async function patchSession(id, payload) { return apiPATCH(`/sessions/${encodeURIComponent(id)}`, payload); }

/* === Centralized delegated handler for card actions (single listener) === */
document.getElementById('padi-cards').addEventListener('click', async function (e) {
  const btn = e.target.closest('[data-action]');
  if (!btn) return;
  const action = btn.dataset.action;
  const id = btn.dataset.id;

  // Show spinner on clicked button
  try {
    setButtonLoading(btn, true, action === 'toggleDone' ? (btn.innerText || 'Working') : 'Processing');

    if (action === 'join' || action === 'end' || action === 'cancel') {
      await patchSession(id, { action });
      await loadAllBackend();
    } else if (action === 'toggleDone') {
      const g = goals.find(x => (x.id === id) || (x._id === id));
      if (!g) throw new Error('Goal not found');
      await updateGoal(id, { completed: !g.completed });
      await loadAllBackend();
    } else if (action === 'edit') {
      const g = goals.find(x => (x.id === id) || (x._id === id));
      if (!g) throw new Error('Goal not found');
      // fill modal
      document.getElementById('padiId').value = g.id || g._id;
      document.getElementById('padiTitle').value = g.title;
      document.getElementById('padiCourse').value = g.course || '';
      document.getElementById('padiDue').value = g.due ? new Date(g.due).toISOString().slice(0,10) : '';
      document.getElementById('padiDuration').value = g.durationMin || '';
      document.getElementById('padiDesc').value = g.description || '';
      document.getElementById('addModalTitle').textContent = 'Edit Study Goal';
      document.getElementById('padiDeleteBtn').classList.remove('hidden');
      document.getElementById('addPadiModal').classList.remove('hidden');

      // wire delete button (replace previous handler)
      const delBtn = document.getElementById('padiDeleteBtn');
      delBtn.onclick = async () => {
        if (!confirm('Delete this goal?')) return;
        try {
          setButtonLoading(delBtn, true, 'Deleting');
          await removeGoal(g.id || g._id);
          document.getElementById('addPadiModal').classList.add('hidden');
          await loadAllBackend();
        } catch (err) {
          console.error(err);
          alert('Delete failed');
        } finally {
          setButtonLoading(delBtn, false);
        }
      };
    } else if (action === 'delete') {
      if (!confirm('Delete this goal?')) { setButtonLoading(btn, false); return; }
      await removeGoal(id);
      await loadAllBackend();
    }
  } catch (err) {
    console.error('action error', err);
    alert(err.message || 'Action failed');
  } finally {
    setButtonLoading(btn, false);
  }
});

/* Also attach click for startQuickBtn (dynamically created) */
document.getElementById('padi-cards').addEventListener('click', function(e){
  const el = e.target.closest('#startQuickBtn');
  if (el) openQuickSession();
});

/* Modal wiring */
document.getElementById('openAddGoalBtn')?.addEventListener('click', ()=> {
  document.getElementById('padiForm').reset();
  document.getElementById('padiId').value = '';
  document.getElementById('addModalTitle').textContent = 'Add New Study Goal';
  document.getElementById('padiDeleteBtn').classList.add('hidden');
  document.getElementById('addPadiModal').classList.remove('hidden');
});
document.getElementById('closeAddPadiModal')?.addEventListener('click', ()=> document.getElementById('addPadiModal').classList.add('hidden'));

document.getElementById('padiForm')?.addEventListener('submit', async function(e){
  e.preventDefault();
  const saveBtn = document.getElementById('padiSaveBtn');
  try {
    setButtonLoading(saveBtn, true, 'Saving');
    const id = document.getElementById('padiId').value || null;
    const payload = {
      title: document.getElementById('padiTitle').value.trim(),
      course: document.getElementById('padiCourse').value.trim(),
      due: document.getElementById('padiDue').value || null,
      durationMin: parseInt(document.getElementById('padiDuration').value) || null,
      description: document.getElementById('padiDesc').value.trim()
    };
    if (!payload.title) throw new Error('Title required');
    if (id) {
      await updateGoal(id, payload);
    } else {
      await createGoal(payload);
    }
    document.getElementById('addPadiModal').classList.add('hidden');
    await loadAllBackend();
  } catch (err) {
    console.error(err);
    alert(err.message || 'Failed to save goal.');
  } finally {
    setButtonLoading(saveBtn, false);
  }
});

/* Quick session modal wiring */
function openQuickSession(){
  const sel = document.getElementById('quickSessionGoal');
  sel.innerHTML = '<option value="">-- None --</option>' + goals.map(g=>`<option value="${esc(g.id || g._id)}">${esc(g.title)}</option>`).join('');
  const now = new Date();
  document.getElementById('quickStart').value = now.toISOString().slice(0,16);
  document.getElementById('quickSessionModal').classList.remove('hidden');
}
document.getElementById('openScheduleSessionBtn')?.addEventListener('click', openQuickSession);
document.getElementById('closeQuickSessionModal')?.addEventListener('click', ()=> document.getElementById('quickSessionModal').classList.add('hidden'));
document.getElementById('quickSessionForm')?.addEventListener('submit', async function(e){
  e.preventDefault();
  const saveBtn = document.getElementById('quickSessionSaveBtn');
  try {
    setButtonLoading(saveBtn, true, 'Starting');
    const payload = {
      goalId: document.getElementById('quickSessionGoal').value || null,
      start: document.getElementById('quickStart').value ? new Date(document.getElementById('quickStart').value).toISOString() : new Date().toISOString(),
      durationMin: parseInt(document.getElementById('quickDuration').value) || 30
    };
    await createSession(payload);
    document.getElementById('quickSessionModal').classList.add('hidden');
    await loadAllBackend();
  } catch (err) {
    console.error(err);
    alert('Failed to create session.');
  } finally {
    setButtonLoading(saveBtn, false);
  }
});

/* === Polling and initialization (2s) === */
let prevSnapshot = null;
async function pollAndRefresh() {
  try {
    await loadAllBackend();
    const snap = JSON.stringify({ goals, sessions, timeline });
    if (snap !== prevSnapshot) {
      prevSnapshot = snap;
      renderAll();
    }
  } catch (e) {
    console.warn('poll error', e);
  }
}
pollAndRefresh();
const POLL_INTERVAL_MS = 2000;
const pollHandle = setInterval(pollAndRefresh, POLL_INTERVAL_MS);
document.addEventListener('visibilitychange', () => { if (document.visibilityState === 'visible') pollAndRefresh(); });
window.addEventListener('beforeunload', () => clearInterval(pollHandle));

// Initial load
loadAllBackend().then(()=> { /* initial render done */ });
</script>
<!-- Logout Section -->
<div id="logout-section" class="section-block hidden">
  <div class="flex flex-col items-center justify-center min-h-[60vh] py-10">
    <div class="bg-white rounded-xl shadow-lg p-10 max-w-md w-full flex flex-col items-center text-center">
      <svg class="w-20 h-20 mb-4 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 48 48">
        <circle cx="24" cy="24" r="22" stroke-width="3" stroke="currentColor" fill="none"/>
        <path d="M32 16v-2a4 4 0 00-4-4h-8a4 4 0 00-4 4v20a4 4 0 004 4h8a4 4 0 004-4v-2" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/>
        <path d="M16 24h16m0 0l-5-5m5 5l-5 5" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/>
      </svg>
      <h2 class="text-2xl font-bold text-indigo-800 mb-2">Sign out</h2>
      <p class="text-gray-700 mb-6">Are you sure you want to log out of your account?<br>This will end your current session and youâ€™ll need to login again to access the dashboard.</p>
      <div class="flex flex-col gap-3 w-full">
        <button 
          onclick="handleLogout()"
          class="bg-red-600 hover:bg-red-700 text-white font-bold rounded-lg px-6 py-2 transition shadow"
        >
          Yes, Log me out
        </button>
        <button 
          onclick="switchSection('overview')"
          class="border border-gray-300 bg-gray-100 hover:bg-gray-200 text-gray-800 font-semibold rounded-lg px-6 py-2 transition shadow"
        >
          Cancel
        </button>
      </div>
    </div>
  </div>
  <script>
    function handleLogout() {
      // Clear local and session storage (including tokens & dashboard data)
      try {
        localStorage.clear();
        sessionStorage.clear();
      } catch {}
      // Optionally, for extra security, clear cookies (if JS-accessible)
      // Redirect to the login/landing page "mock-icthallb"
      window.location.href = "mock-icthallb";
    }
  </script>
</div>

<!-- Study Resources Section -->
<div id="resources-section" class="section-block hidden">
  <div class="max-w-7xl mx-auto py-10 px-2 md:px-8">
    <!-- Section Header -->
    <div class="flex flex-col md:flex-row md:items-center justify-between gap-4 mb-8">
      <div>
        <h2 class="text-3xl font-bold text-indigo-800">Study Resources</h2>
        <p class="text-md text-gray-600 mt-1">Find, organize, and access a collection of curated resources to help you excel.</p>
      </div>
      <div class="flex gap-4">
        <button id="openResourceUpload" class="inline-flex items-center gap-2 bg-indigo-600 hover:bg-indigo-700 text-white px-5 py-2 rounded-lg font-semibold shadow transition">
          <svg class="w-5 h-5" fill="none" stroke="currentColor"><path d="M12 4v16m8-8H4" stroke-width="2"></path></svg>
          Upload Resource
        </button>
        <button id="openResourceSearch" class="inline-flex items-center gap-2 border border-indigo-600 text-indigo-600 hover:bg-indigo-50 px-5 py-2 rounded-lg font-semibold transition shadow">
          <svg class="w-5 h-5" fill="none" stroke="currentColor"><path d="M21 21l-6-6m3-5A7 7 0 1 1 5 5a7 7 0 0 1 13 5z" stroke-width="2"></path></svg>
          Search Resources
        </button>
      </div>
    </div>

    <!-- Filter & Search -->
    <form id="resourcesFilterForm" class="flex flex-wrap gap-3 items-center bg-white shadow rounded-xl p-4 mb-8" onsubmit="return false;">
      <input id="resourcesQuery" type="text" class="flex-1 min-w-[150px] border rounded-lg p-2 text-sm" placeholder="Search by title, topic, or keyword..." />
      <select id="resourcesType" class="border rounded-lg p-2 text-sm bg-gray-50 min-w-[120px]">
        <option value="">All Types</option>
        <option value="pdf">PDF</option>
        <option value="video">Video</option>
        <option value="notes">Notes</option>
        <option value="audio">Audio</option>
        <option value="link">Link</option>
      </select>
      <select id="resourcesCourse" class="border rounded-lg p-2 text-sm bg-gray-50 min-w-[140px]">
        <option value="">All Courses</option>
      </select>
      <button id="applyResourcesFilter" type="button" class="bg-indigo-600 hover:bg-indigo-700 transition text-white font-semibold px-5 py-2 rounded-lg shadow text-sm">Filter</button>
      <button id="clearResourcesFilter" type="button" class="border px-4 py-2 rounded text-sm">Clear</button>
    </form>

    <!-- Resources Grid/Table -->
    <div class="bg-white rounded-2xl shadow-lg overflow-x-auto">
      <table class="min-w-full divide-y divide-gray-200">
        <thead>
          <tr class="bg-indigo-50 text-left text-gray-700 text-sm font-semibold">
            <th class="px-6 py-4 rounded-tl-2xl">Preview</th>
            <th class="px-6 py-4">Title</th>
            <th class="px-6 py-4">Type</th>
            <th class="px-6 py-4">Course</th>
            <th class="px-6 py-4">Uploaded By</th>
            <th class="px-6 py-4">Date Added</th>
            <th class="px-6 py-4">Actions</th>
            <th class="px-6 py-4 rounded-tr-2xl">Rating</th>
          </tr>
        </thead>
        <tbody id="resourcesTableBody" class="divide-y divide-gray-100 text-sm">
          <!-- Rows injected by JS -->
        </tbody>
      </table>
    </div>

    <!-- Pagination / Summary -->
    <div class="mt-4 flex items-center justify-between">
      <div class="text-sm text-gray-600" id="resourcesSummary">0 resources</div>
      <div class="flex items-center gap-2">
        <button id="resourcesPrev" class="px-3 py-1 border rounded disabled:opacity-50" disabled>Previous</button>
        <span id="resourcesPageInfo" class="text-sm text-gray-700">Page 1</span>
        <button id="resourcesNext" class="px-3 py-1 border rounded disabled:opacity-50" disabled>Next</button>
      </div>
    </div>
  </div>

  <!-- Upload Resource Modal (hidden by default) -->
  <div id="uploadResourceModal" class="fixed inset-0 bg-black bg-opacity-40 z-50 hidden flex items-center justify-center p-4">
    <!-- Modal inner: limited height and scrollable to support upward/downward scrolling -->
    <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg mx-4 p-6 relative max-h-[90vh] overflow-auto">
      <button id="closeUploadModal" class="absolute top-4 right-5 text-gray-400 hover:text-indigo-600 text-2xl">&times;</button>
      <h3 class="font-bold text-2xl mb-2 text-indigo-900">Upload New Resource</h3>

      <!-- Thumbnail preview & upload placed near top -->
      <form id="uploadResourceForm" class="flex flex-col gap-4">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label class="font-medium mb-1 block">Title*</label>
            <input name="title" id="resourceTitle" required class="border rounded-lg p-2 w-full" />
          </div>

          <div>
            <label class="font-medium mb-1 block">Course</label>
            <input name="course" id="resourceCourse" class="border rounded-lg p-2 w-full" placeholder="e.g. PHY101" />
          </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label class="font-medium mb-1 block">Type*</label>
            <select name="type" id="resourceType" required class="border rounded-lg p-2 w-full">
              <option value="pdf">PDF</option>
              <option value="video">Video</option>
              <option value="notes">Notes</option>
              <option value="audio">Audio</option>
              <option value="link">Link</option>
              <option value="other">Other</option>
            </select>
          </div>
          <div>
            <label class="font-medium mb-1 block">Thumbnail (optional)</label>
            <div class="flex items-center gap-3">
              <div class="w-24 h-16 bg-gray-50 rounded overflow-hidden flex items-center justify-center border" id="thumbnailPreviewWrapper">
                <img id="thumbnailPreview" class="w-full h-full object-cover hidden" alt="Thumbnail preview" />
                <span id="thumbnailPlaceholder" class="text-xs text-gray-400">No image</span>
              </div>
              <div class="flex-1">
                <input id="resourceThumbnail" name="thumbnail" type="file" accept="image/*" class="border rounded-lg px-2 py-1 w-full" />
                <div class="text-xs text-gray-500 mt-1">Optional image used as preview/thumbnail.</div>
                <button id="clearThumbnail" type="button" class="mt-1 text-xs text-gray-600 underline hidden">Remove</button>
              </div>
            </div>
          </div>
        </div>
        <div>
          <label class="font-medium mb-1 block">Upload File</label>
          <input name="file" type="file" id="resourceFileInput" class="border rounded-lg px-2 py-1 w-full" />
          <div class="text-xs text-gray-500 mt-1">Optional â€” if provided it'll be uploaded to the server and used instead of the external link.</div>
        </div>
        <div>
          <label class="font-medium mb-1 block">External Link</label>
          <input name="link" id="resourceLink" type="url" class="border rounded-lg p-2 w-full" placeholder="https://..." />
        </div>
        <div>
          <label class="font-medium mb-1 block">Description</label>
          <textarea name="description" id="resourceDescription" class="border rounded-lg p-2 w-full min-h-[120px]"></textarea>
        </div>
        <div class="flex items-center gap-3 mt-2">
          <button id="uploadResourceSubmit" type="submit" class="bg-indigo-600 hover:bg-indigo-700 text-white font-semibold rounded px-6 py-2">Upload Resource</button>
          <button type="button" id="cancelUploadBtn" class="border rounded px-4 py-2">Cancel</button>
          <div id="uploadResourceMsg" class="text-sm text-green-600 hidden"></div>
        </div>
      </form>
    </div>
  </div>

  <!-- Resource Viewer Modal (hidden by default) -->
  <div id="resourceViewerModal" class="fixed inset-0 bg-black bg-opacity-40 z-50 hidden flex items-center justify-center p-4">
    <div class="bg-white rounded-xl shadow-2xl w-full max-w-4xl mx-4 p-6 relative max-h-[95vh] overflow-auto flex flex-col" style="min-height:340px;">
      <button id="closeViewerModal" class="absolute top-4 right-5 text-gray-400 hover:text-indigo-600 text-2xl">&times;</button>
      <div id="resourceViewerContent" class="flex-1 flex items-center justify-center min-h-[280px]">
        <!-- Will be injected here -->
      </div>
      <div id="viewerFileActions" class="mt-4 flex justify-end gap-3">
        <!-- Download button added by JS -->
      </div>
    </div>
  </div>

  <script>
    (function(){
      // Endpoints
      const API_ROOT = "https://examguide.onrender.com/api/resources";
      const COURSES_EP = API_ROOT + "/courses";
      const TOKEN_KEY = "token";
      const token = () => localStorage.getItem(TOKEN_KEY);
      const authHeaders = () => token() ? { Authorization: "Bearer " + token() } : {};

      // Elements
      const qInput = document.getElementById("resourcesQuery");
      const typeSelect = document.getElementById("resourcesType");
      const courseSelect = document.getElementById("resourcesCourse");
      const applyFilterBtn = document.getElementById("applyResourcesFilter");
      const clearFilterBtn = document.getElementById("clearResourcesFilter");
      const tableBody = document.getElementById("resourcesTableBody");
      const summaryEl = document.getElementById("resourcesSummary");
      const prevBtn = document.getElementById("resourcesPrev");
      const nextBtn = document.getElementById("resourcesNext");
      const pageInfo = document.getElementById("resourcesPageInfo");
      const uploadModal = document.getElementById("uploadResourceModal");
      const openUpload = document.getElementById("openResourceUpload");
      const uploadForm = document.getElementById("uploadResourceForm");
      const uploadMsg = document.getElementById("uploadResourceMsg");
      const closeUploadModal = document.getElementById("closeUploadModal");
      const cancelUploadBtn = document.getElementById("cancelUploadBtn");

      // Viewer Elements
      const viewerModal = document.getElementById("resourceViewerModal");
      const viewerContent = document.getElementById("resourceViewerContent");
      const closeViewerModal = document.getElementById("closeViewerModal");
      const viewerFileActions = document.getElementById("viewerFileActions");

      // Thumbnail elements
      const thumbnailInput = document.getElementById("resourceThumbnail");
      const thumbnailPreview = document.getElementById("thumbnailPreview");
      const thumbnailPlaceholder = document.getElementById("thumbnailPlaceholder");
      const thumbnailPreviewWrapper = document.getElementById("thumbnailPreviewWrapper");
      const clearThumbnailBtn = document.getElementById("clearThumbnail");

      // Pagination state
      let currentPage = 1;
      const perPage = 10;
      let total = 0, pages = 1;

      document.addEventListener("DOMContentLoaded", init);

      function debounce(fn, wait = 300) {
        let t;
        return (...a) => { clearTimeout(t); t = setTimeout(() => fn(...a), wait); };
      }

      async function init() {
        attachEvents();
        await populateCourses();
        loadResources(1);
      }

      function attachEvents() {
        applyFilterBtn.addEventListener("click", () => loadResources(1));
        clearFilterBtn.addEventListener("click", () => { qInput.value = ""; typeSelect.value = ""; courseSelect.value = ""; loadResources(1); });
        qInput.addEventListener("input", debounce(() => loadResources(1), 400));
        prevBtn.addEventListener("click", () => { if (currentPage > 1) loadResources(currentPage - 1); });
        nextBtn.addEventListener("click", () => { if (currentPage < pages) loadResources(currentPage + 1); });

        openUpload.addEventListener("click", openUploadModal);
        closeUploadModal.addEventListener("click", closeUploadModalHandler);
        cancelUploadBtn.addEventListener("click", closeUploadModalHandler);
        uploadForm.addEventListener("submit", onUploadSubmit);

        thumbnailInput.addEventListener("change", onThumbnailSelected);
        clearThumbnailBtn.addEventListener("click", clearThumbnail);

        // Resource viewer modal events
        closeViewerModal.addEventListener("click", closeViewerModalHandler);
        viewerModal.addEventListener("click", function(ev) {
          if (ev.target === viewerModal) closeViewerModalHandler();
        });
      }

      function openUploadModal() {
        uploadModal.classList.remove("hidden");
        document.body.style.overflow = "hidden";
        const inner = uploadModal.querySelector("[role='dialog']") || uploadModal.querySelector("div");
        if (inner) inner.scrollTop = 0;
      }

      function closeUploadModalHandler() {
        uploadModal.classList.add("hidden");
        document.body.style.overflow = "";
        clearThumbnail();
      }

      function openResourceViewer(data) {
        viewerContent.innerHTML = "";
        viewerFileActions.innerHTML = "";

        // Title
        let titleBlock = `<div class="mb-3 text-xl font-bold text-indigo-900 text-center">${escapeHtml(data.title || 'Resource Viewer')}</div>`;

        // Determine content based on type
        let fileUrl = data.fileUrl || data.link || data.url || '';
        let extension = '';
        // Extract file extension if possible
        if (fileUrl) {
          let match = fileUrl.match(/\.(\w+)(?:[#?].*)?$/);
          extension = match ? match[1].toLowerCase() : '';
        }

        let viewerHtml = '';
        if (data.type === "pdf" || extension === "pdf") {
          viewerHtml = `<iframe src="${fileUrl}" class="w-full h-[600px] rounded shadow-lg border" frameborder="0"></iframe>`;
        } else if (data.type === "video" || ["mp4", "webm", "mov"].includes(extension)) {
          viewerHtml = `<video src="${fileUrl}" controls class="w-full max-h-[600px] rounded shadow-lg"></video>`;
        } else if (data.type === "audio" || ["mp3", "ogg", "wav"].includes(extension)) {
          viewerHtml = `<audio src="${fileUrl}" controls class="w-full mt-10"></audio>`;
        } else if (data.type === "notes" || ["txt", "md"].includes(extension)) {
          viewerHtml = `<iframe src="${fileUrl}" class="w-full h-[600px] rounded shadow-lg border" frameborder="0"></iframe>`;
        } else if (data.type === "link") {
          viewerHtml = `<iframe src="${fileUrl}" class="w-full h-[600px] rounded shadow-lg border" frameborder="0"></iframe>`;
        } else { // fallback
          viewerHtml = `<iframe src="${fileUrl}" class="w-full h-[600px] rounded shadow-lg border" frameborder="0"></iframe>
                        <p class="mt-4 text-sm text-gray-400 text-center">Format not directly supported. <a href="${fileUrl}" target="_blank" class="text-indigo-700 underline">Open externally</a></p>`;
        }

        viewerContent.innerHTML = titleBlock + viewerHtml;

        // Add download button if fileUrl is available
        if (fileUrl) {
          let downloadBtn = document.createElement("a");
          downloadBtn.href = fileUrl;
          downloadBtn.target = "_blank";
          downloadBtn.download = "";
          downloadBtn.className = "bg-indigo-600 hover:bg-indigo-700 text-white font-semibold rounded px-6 py-2 transition";
          downloadBtn.textContent = "Download Resource";
          viewerFileActions.appendChild(downloadBtn);
        }

        viewerModal.classList.remove("hidden");
        document.body.style.overflow = "hidden";
      }

      function closeViewerModalHandler() {
        viewerModal.classList.add("hidden");
        document.body.style.overflow = "";
        viewerContent.innerHTML = "";
        viewerFileActions.innerHTML = "";
      }

      async function populateCourses() {
        try {
          const res = await fetch(COURSES_EP);
          if (!res.ok) return;
          const data = await res.json();
          courseSelect.innerHTML = `<option value="">All Courses</option>` + data.map(c => `<option value="${c}">${c}</option>`).join("");
          const uploadCourse = document.getElementById("resourceCourse");
          if (uploadCourse) {
            let dl = document.getElementById("coursesDatalist");
            if (!dl) {
              dl = document.createElement("datalist"); dl.id = "coursesDatalist";
              document.body.appendChild(dl);
            }
            dl.innerHTML = data.map(c => `<option value="${c}">`).join("");
            uploadCourse.setAttribute("list", "coursesDatalist");
          }
        } catch (e) {
          // ignore
        }
      }

      async function loadResources(page = 1) {
        currentPage = page;
        const q = qInput.value.trim();
        const type = typeSelect.value;
        const course = courseSelect.value;
        const params = new URLSearchParams();
        params.set("page", currentPage);
        params.set("limit", perPage);
        if (q) params.set("q", q);
        if (type) params.set("type", type);
        if (course) params.set("course", course);

        try {
          const res = await fetch(API_ROOT + "?" + params.toString(), { headers: authHeaders() });
          if (!res.ok) throw new Error("Failed to fetch resources");
          const data = await res.json();
          const items = data.items || [];
          const meta = data.meta || { page: currentPage, limit: perPage, total: items.length, pages: Math.max(1, Math.ceil(items.length / perPage)) };
          total = meta.total || items.length;
          pages = meta.pages || Math.max(1, Math.ceil(total / perPage));
          renderResources(items);
          summaryEl.textContent = `${total} resource(s)`;
          pageInfo.textContent = `Page ${meta.page || currentPage} of ${pages}`;
          prevBtn.disabled = currentPage <= 1;
          nextBtn.disabled = currentPage >= pages;
        } catch (e) {
          tableBody.innerHTML = `<tr><td class="px-6 py-4 text-sm text-gray-500" colspan="8">Failed to load resources.</td></tr>`;
          summaryEl.textContent = `0 resources`;
        }
      }

      function makeUploaderLabel(u) {
        if (!u) return "Unknown";
        return u.fullname || u.username || u.email || "Unknown";
      }

      function renderResources(items) {
        if (!Array.isArray(items) || !items.length) {
          tableBody.innerHTML = `<tr><td class="px-6 py-4 text-sm text-gray-500" colspan="8">No resources found.</td></tr>`;
          return;
        }
        tableBody.innerHTML = "";
        for (const r of items) {
          const uploader = makeUploaderLabel(r.uploadedBy);
          const date = r.createdAt ? new Date(r.createdAt).toLocaleDateString() : "-";
          const ratingCount = (r.ratings && r.ratings.length) ? `(${r.ratings.length})` : "(0)";
          const avg = r.ratingAvg !== undefined ? r.ratingAvg : (r.ratings && r.ratings.length ? (r.ratings.reduce((s, rr) => s + (rr.rating || 0), 0) / r.ratings.length).toFixed(1) : "0.0");

          const row = document.createElement("tr");
          row.className = "hover:bg-indigo-50/40 transition";

          const thumbUrl = r.thumbnailUrl || r.thumbUrl || (r.fileUrl && r.type === "video" ? r.fileUrl : "");
          const thumbHtml = thumbUrl
            ? `<img src="${thumbUrl}" alt="thumbnail" class="w-20 h-12 object-cover rounded" />`
            : `<div class="w-20 h-12 bg-gray-100 rounded flex items-center justify-center text-xs text-gray-400">No preview</div>`;

          row.innerHTML = `
            <td class="px-6 py-4">${thumbHtml}</td>
            <td class="px-6 py-4">
              <a href="#" class="font-semibold text-indigo-800 hover:underline resource-title" data-id="${r._id}">${escapeHtml(r.title)}</a>
              <div class="text-xs text-gray-500">${escapeHtml(r.description || "")}</div>
            </td>
            <td class="px-6 py-4">
              <span class="inline-flex gap-1 items-center px-2 py-1 rounded ${r.type === 'video' ? 'bg-pink-100 text-pink-700' : r.type === 'pdf' ? 'bg-blue-100 text-blue-700' : 'bg-gray-100 text-gray-700'} font-medium text-xs">
                ${escapeHtml(r.type || "file")}
              </span>
            </td>
            <td class="px-6 py-4">${escapeHtml(r.course || "-")}</td>
            <td class="px-6 py-4 flex items-center gap-2">
              <img src="${r.uploadedBy && r.uploadedBy.profilePic ? (r.uploadedBy.profilePic.startsWith('http') ? r.uploadedBy.profilePic : r.uploadedBy.profilePic) : 'https://ui-avatars.com/api/?name='+encodeURIComponent(uploader)}" class="w-6 h-6 rounded-full" alt="${escapeHtml(uploader)}"/>
              <span>${escapeHtml(uploader)}</span>
            </td>
            <td class="px-6 py-4">${escapeHtml(date)}</td>
            <td class="px-6 py-4 flex gap-2">
              <button class="viewBtn bg-indigo-600 hover:bg-indigo-700 text-white font-semibold px-4 py-1 rounded text-xs" data-id="${r._id}">View</button>
              <button class="downloadBtn bg-gray-100 hover:bg-indigo-50 text-indigo-700 px-4 py-1 rounded text-xs" data-id="${r._id}">Download</button>
              <button class="favBtn bg-yellow-100 hover:bg-yellow-200 text-yellow-700 px-3 py-1 rounded text-xs font-bold" data-id="${r._id}">â˜… Save</button>
            </td>
            <td class="px-6 py-4">
              <div class="flex gap-0.5 text-yellow-400 items-center">
                ${renderStars(avg)}
                <span class="text-gray-500 ml-1 text-xs">${ratingCount}</span>
              </div>
            </td>
          `;

          tableBody.appendChild(row);

          // Wire buttons
          row.querySelector(".viewBtn").addEventListener("click", async () => {
            // Fetch resource details for viewer modal
            try {
              let res = await fetch(`${API_ROOT}/${r._id}`, { headers: authHeaders() });
              if (!res.ok) throw new Error("Unable to fetch resource info.");
              let resourceData = await res.json();
              // Use resourceData and patched url info
              let viewData = {
                _id: resourceData._id,
                title: resourceData.title || r.title,
                type: resourceData.type || r.type,
                fileUrl: resourceData.fileUrl || resourceData.link || r.fileUrl || r.link,
                link: resourceData.link || r.link,
                url: resourceData.fileUrl || resourceData.link || r.fileUrl || r.link
              };
              openResourceViewer(viewData);
            } catch (e) {
              alert("Could not open viewer. Try again.");
            }
          });
          row.querySelector(".downloadBtn").addEventListener("click", () => window.open(`${API_ROOT}/${r._id}/download`, "_blank"));
          row.querySelector(".favBtn").addEventListener("click", () => onSaveToggle(r._id, row.querySelector(".favBtn")));
          row.querySelector(".resource-title")?.addEventListener("click", async (ev) => {
            ev.preventDefault();
            // Open viewer modal instead of new tab
            try {
              let res = await fetch(`${API_ROOT}/${r._id}`, { headers: authHeaders() });
              if (!res.ok) throw new Error("Unable to fetch resource info.");
              let resourceData = await res.json();
              let viewData = {
                _id: resourceData._id,
                title: resourceData.title || r.title,
                type: resourceData.type || r.type,
                fileUrl: resourceData.fileUrl || resourceData.link || r.fileUrl || r.link,
                link: resourceData.link || r.link,
                url: resourceData.fileUrl || resourceData.link || r.fileUrl || r.link
              };
              openResourceViewer(viewData);
            } catch(e) {
              alert("Could not open viewer. Try again.");
            }
          });
        }
      }

      function renderStars(avg) {
        const n = Math.round(Number(avg) || 0);
        let out = "";
        for (let i = 1; i <= 5; i++) {
          if (i <= n) out += `<svg class="w-4 h-4 text-yellow-400" viewBox="0 0 20 20" fill="currentColor"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.286 3.957a1 1 0 00.95.69h4.162c.969 0 1.371 1.24.588 1.81l-3.37 2.448a1 1 0 00-.364 1.118l1.286 3.957c.3.921-.755 1.688-1.54 1.118L10 15.347l-3.37 2.448c-.785.57-1.84-.197-1.54-1.118l1.286-3.957a1 1 0 00-.364-1.118L2.64 9.383c-.783-.57-.38-1.81.588-1.81h4.162a1 1 0 00.95-.69L9.049 2.927z"/></svg>`;
          else out += `<svg class="w-4 h-4 text-gray-300" viewBox="0 0 20 20" fill="currentColor"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.286 3.957a1 1 0 00.95.69h4.162c.969 0 1.371 1.24.588 1.81l-3.37 2.448a1 1 0 00-.364 1.118l1.286 3.957c.3.921-.755 1.688-1.54 1.118L10 15.347l-3.37 2.448c-.785.57-1.84-.197-1.54-1.118l1.286-3.957a1 1 0 00-.364-1.118L2.64 9.383c-.783-.57-.38-1.81.588-1.81h4.162a1 1 0 00.95-.69L9.049 2.927z"/></svg>`;
        }
        return out;
      }

      async function onSaveToggle(resourceId, btnEl) {
        if (!token()) { alert("Please log in to save resources."); return; }
        try {
          const res = await fetch(`${API_ROOT}/${resourceId}/save`, { method: "POST", headers: authHeaders() });
          if (res.ok) {
            btnEl.textContent = "â˜… Saved";
          } else {
            const del = await fetch(`${API_ROOT}/${resourceId}/save`, { method: "DELETE", headers: authHeaders() });
            if (del.ok) btnEl.textContent = "â˜… Save";
            else {
              const err = await res.json().catch(()=>({message:"Failed"}));
              alert("Could not update save: " + (err.message || ""));
            }
          }
        } catch (e) {
          alert("Could not update library. Please try again.");
        }
      }

      async function onUploadSubmit(e) {
        e.preventDefault();
        if (!token()) { alert("Please login to upload resources."); return; }

        const form = new FormData();
        const title = document.getElementById("resourceTitle").value;
        const course = document.getElementById("resourceCourse").value;
        const type = document.getElementById("resourceType").value;
        const fileInput = document.getElementById("resourceFileInput");
        const link = document.getElementById("resourceLink").value;
        const description = document.getElementById("resourceDescription").value;

        form.append("title", title);
        if (course) form.append("course", course);
        if (type) form.append("type", type);
        if (description) form.append("description", description);
        if (link) form.append("link", link);

        if (fileInput && fileInput.files && fileInput.files[0]) {
          form.append("file", fileInput.files[0], fileInput.files[0].name);
        }
        if (thumbnailInput && thumbnailInput.files && thumbnailInput.files[0]) {
          form.append("thumbnail", thumbnailInput.files[0], thumbnailInput.files[0].name);
        }

        try {
          const res = await fetch(API_ROOT, { method: "POST", headers: authHeaders(), body: form });
          const data = await res.json();
          if (!res.ok) throw new Error(data.message || "Upload failed");
          uploadMsg.textContent = "Upload successful";
          uploadMsg.classList.remove("hidden");
          setTimeout(()=> uploadMsg.classList.add("hidden"), 3000);
          closeUploadModalHandler();
          uploadForm.reset();
          await populateCourses();
          await loadResources(1);
        } catch (err) {
          uploadMsg.textContent = "Upload failed: " + (err.message || "");
          uploadMsg.classList.remove("hidden");
          setTimeout(()=> uploadMsg.classList.add("hidden"), 4000);
        }
      }

      function onThumbnailSelected(ev) {
        const f = ev.target.files && ev.target.files[0];
        if (!f) { clearThumbnail(); return; }
        const url = URL.createObjectURL(f);
        thumbnailPreview.src = url;
        thumbnailPreview.classList.remove("hidden");
        thumbnailPlaceholder.classList.add("hidden");
        clearThumbnailBtn.classList.remove("hidden");
        const inner = uploadModal.querySelector("div");
        if (inner) inner.scrollTop = 0;
      }

      function clearThumbnail() {
        thumbnailInput.value = "";
        thumbnailPreview.src = "";
        thumbnailPreview.classList.add("hidden");
        thumbnailPlaceholder.classList.remove("hidden");
        clearThumbnailBtn.classList.add("hidden");
      }

      function escapeHtml(s) {
        if (!s) return "";
        return String(s).replace(/&/g, "&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;");
      }

      window.loadResourcesSection = loadResources;

    })();
  </script>
</div>
            
        
<!-- ==== ASSIGNMENTS SECTION (Full Implementation, Student View) ==== -->
<div id="assignments-section" class="section-block hidden">
  <div class="max-w-5xl mx-auto py-10 px-2 md:px-6">
    <div class="flex flex-col md:flex-row md:items-center justify-between mb-8 gap-4">
      <div>
        <h2 class="text-3xl font-bold text-indigo-800">Assignments</h2>
        <p class="text-md text-gray-600 mt-1">Assignments from your approved tutor(s). Track, submit, and review any tasks set by your tutor.</p>
      </div>
    </div>
    <!-- Message shown when there's no tutor -->
    <div id="assignments-no-tutor-msg" class="bg-yellow-50 text-yellow-800 p-5 rounded-xl shadow text-center font-semibold mb-8 hidden">
      <i class="fa fa-user-check text-lg text-yellow-500 mr-2"></i>
      You do not have an approved tutor yet.
      <br class="my-1"/>
      <a href="tutor-req.html" class="inline-block mt-2 bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700 shadow">Request for a Tutor now</a>
    </div>
    <div id="assignments-error-msg" class="bg-red-50 text-red-800 p-5 rounded-xl shadow text-center font-semibold mb-8 hidden">
      <i class="fa fa-exclamation-triangle text-lg text-red-500 mr-2"></i>
      There was a problem loading your assignments. Please refresh or try again later.
    </div>
    <div class="bg-white rounded-2xl shadow-lg overflow-x-auto" id="assignments-table-box" style="display: none;">
      <table class="min-w-full text-sm divide-y divide-gray-200" id="assignmentsTableStudent">
        <thead class="bg-indigo-50 font-bold text-indigo-800">
          <tr>
            <th class="px-6 py-3 text-left whitespace-nowrap">Title</th>
            <th class="px-6 py-3 text-left whitespace-nowrap">Subject</th>
            <th class="px-6 py-3 text-left whitespace-nowrap">Tutor</th>
            <th class="px-6 py-3 text-left whitespace-nowrap">Due</th>
            <th class="px-6 py-3 text-left whitespace-nowrap">Status</th>
            <th class="px-6 py-3 text-left whitespace-nowrap">Actions</th>
          </tr>
        </thead>
        <tbody class="bg-white divide-y divide-gray-100" id="assignmentsTableBodyStudent">
          <!-- Populated dynamically -->
        </tbody>
      </table>
      <div id="assignmentsEmptyMsgStudent" class="hidden text-center py-10 text-xl text-gray-400">
        <i class="fa fa-file-circle-xmark text-2xl mb-2 block"></i>
        No assignments found from your Tutor(s).
      </div>
    </div>
  </div>
</div>

<!-- Assignment View Modal (details/submission UI) -->
<div id="assignmentViewModal" class="fixed inset-0 z-50 hidden items-center justify-center modal-bg px-4">
  <div class="bg-white rounded-2xl w-full max-w-xl shadow-2xl overflow-auto" style="max-height:96vh;">
    <div class="flex items-start justify-between p-5 border-b">
      <div>
        <div id="assignmentModalTitle" class="font-bold text-xl text-indigo-900">Assignment Title</div>
        <div id="assignmentModalSub" class="text-xs text-gray-500 mt-1">Subject | Due | Tutor</div>
      </div>
      <button class="text-gray-500 text-2xl px-3" onclick="closeAssignmentViewModal()">Ã—</button>
    </div>
    <div class="p-6 space-y-3">
      <div id="assignmentModalInstructions" class="text-gray-700 mb-3">Instructions/details will show here.</div>
      <div class="text-xs text-gray-500" id="assignmentModalDue"></div>
      <div id="assignmentModalStatusPill" class="inline-block mt-2"></div>
      <div id="assignmentModalFile" class="mt-3"></div>
      <div id="assignmentModalSubmissionBlock" class="mt-7 hidden">
        <form onsubmit="return submitAssignmentSubmission(event)" enctype="multipart/form-data">
          <label class="block mb-2 font-semibold">Upload or paste your work<span class="text-red-600">*</span></label>
          <input type="file" accept=".pdf,.doc,.docx,.jpg,.png,.jpeg,.zip" class="block mb-2" name="file" id="assignmentUploadFile"/>
          <textarea id="assignmentSubmitText" rows="5" class="w-full border rounded mb-3 p-2" placeholder="Paste your assignment answer here..."></textarea>
          <input type="hidden" id="assignmentIdHidden"/>
          <button class="bg-indigo-600 hover:bg-indigo-800 text-white px-5 py-2 rounded font-bold" id="assignmentSubmitBtn">Submit Assignment</button>
        </form>
      </div>
      <div class="mt-6" id="assignmentModalSubmissionDetails"></div>
    </div>
  </div>
</div>

<script>
// === ASSIGNMENTS SECTION LOGIC (FULLY IMPLEMENTED) ===

const API_BASE_STUDENT = "https://examguide.onrender.com/api/";
let student_assignments_cache = [];
let student_assignments_tutors = [];
let current_user = null;

async function loadStudentAssignmentsSection() {
  // References
  const tableBox = document.getElementById('assignments-table-box');
  const tableBody = document.getElementById('assignmentsTableBodyStudent');
  const emptyMsg = document.getElementById('assignmentsEmptyMsgStudent');
  const noTutorMsg = document.getElementById('assignments-no-tutor-msg');
  const errorMsg = document.getElementById('assignments-error-msg');

  // Reset display
  tableBox.style.display = "none";
  emptyMsg.classList.add("hidden");
  noTutorMsg.classList.add("hidden");
  errorMsg.classList.add("hidden");
  tableBody.innerHTML = "";

  // Get auth token
  let token = localStorage.getItem('token') || sessionStorage.getItem('token');
  if (!token) {
    noTutorMsg.classList.remove("hidden");
    return;
  }

  try {
    // 1. Get current student user
    let meResp = await fetch(API_BASE_STUDENT + "auth/me", {
      credentials: "include",
      headers: { Authorization: "Bearer " + token }
    });
    if (!meResp.ok) throw new Error("Failed to get user");
    let meData = await meResp.json();
    let user = meData.user;
    current_user = user;
    if (!user || !user._id) throw new Error("No user object");

    // 2. Get tutors for the student
    let tutors = [];
    let tutorResp = await fetch(API_BASE_STUDENT + "students/" + user._id + "/tutors", {
      credentials: "include",
      headers: { Authorization: "Bearer " + token }
    });
    if (tutorResp.ok) {
      let tData = await tutorResp.json();
      tutors = Array.isArray(tData) ? tData : (tData.tutors || []);
    }
    student_assignments_tutors = tutors;

    if (!tutors.length) {
      noTutorMsg.classList.remove("hidden");
      return;
    }

    // 3. Fetch assignments - all assignments assigned to this user
    let assignments = [];
    let assignResp = await fetch(API_BASE_STUDENT + "assignments/user/" + user._id, {
      credentials: "include",
      headers: { Authorization: "Bearer " + token }
    });
    if (assignResp.ok) {
      let aData = await assignResp.json();
      assignments = Array.isArray(aData) ? aData : (aData.assignments || []);
    } else {
      assignments = [];
    }

    const tutorIds = tutors.map(t => t._id || t.id);
    assignments = assignments.filter(a =>
      tutorIds.includes((typeof a.tutor === "object" ? (a.tutor._id || a.tutor.id) : a.tutor)));

    // 4. Show assignments table or empty message
    student_assignments_cache = assignments;
    if (!assignments.length) {
      tableBox.style.display = "";
      emptyMsg.classList.remove("hidden");
      return;
    }

    tableBox.style.display = "";
    emptyMsg.classList.add("hidden");
    tableBody.innerHTML = "";

    assignments.forEach(a => {
      const title = a.title || "-";
      const subject = a.subject || "-";
      const tutorName = (a.tutor && (a.tutor.fullname || a.tutor.username)) || "-";
      const due = a.dueDate ? (new Date(a.dueDate).toLocaleDateString()) : "-";
      const status = (a.status || "Pending").toLowerCase();
      let statusHtml;
      switch (status) {
        case "graded":
          statusHtml = '<span class="bg-green-100 text-green-700 font-semibold px-3 py-1 rounded-full text-xs">Graded</span>'; break;
        case "published":
          statusHtml = '<span class="bg-blue-100 text-blue-700 font-semibold px-3 py-1 rounded-full text-xs">Published</span>'; break;
        case "overdue":
          statusHtml = '<span class="bg-red-100 text-red-700 font-semibold px-3 py-1 rounded-full text-xs">Overdue</span>'; break;
        default:
          statusHtml = '<span class="bg-yellow-100 text-yellow-800 font-semibold px-3 py-1 rounded-full text-xs">Pending</span>';
      }
      tableBody.innerHTML += `
        <tr>
          <td class="py-3 px-3 font-bold text-indigo-900">${title}</td>
          <td class="py-3 px-3">${subject}</td>
          <td class="py-3 px-3">${tutorName}</td>
          <td class="py-3 px-3">${due}</td>
          <td class="py-3 px-3">${statusHtml}</td>
          <td class="py-3 px-3">
            <button class="bg-green-500 text-white px-3 py-1 rounded text-xs shadow hover:bg-green-600 mr-1"
                    onclick="viewStudentAssignment('${a._id}')"><i class="fa fa-eye"></i> View</button>
          </td>
        </tr>`;
    });
  } catch (err) {
    document.getElementById('assignments-error-msg').classList.remove("hidden");
  }
}

// ----- Assignment modal/view logic -----
async function viewStudentAssignment(assignmentId) {
  // Find assignment from cache
  const a = student_assignments_cache.find(ax => String(ax._id || ax.id) === String(assignmentId));
  if (!a) return;

  // Populate modal
  document.getElementById("assignmentModalTitle").textContent = a.title || "-";
  let subj = a.subject || "-";
  let tutor = (a.tutor && (a.tutor.fullname || a.tutor.username)) || "-";
  let due = a.dueDate ? (new Date(a.dueDate).toLocaleDateString()) : "-";
  document.getElementById("assignmentModalSub").textContent = `${subj} | Due: ${due} | Tutor: ${tutor}`;
  document.getElementById("assignmentModalInstructions").textContent = a.instructions || a.description || "No instructions provided.";

  document.getElementById("assignmentModalStatusPill").innerHTML =
    (a.status && a.status.toLowerCase() === "graded")
    ? '<span class="bg-green-600 text-white px-3 py-1 rounded-full text-xs font-bold">Graded</span>'
    : ((a.status && a.status.toLowerCase() === "published")
      ? '<span class="bg-blue-600 text-white px-3 py-1 rounded-full text-xs font-bold">Published</span>'
      : '<span class="bg-yellow-100 text-yellow-800 px-3 py-1 rounded-full text-xs font-bold">Pending</span>');

  document.getElementById("assignmentModalDue").textContent = a.dueDate ? 'Due: ' + new Date(a.dueDate).toLocaleString() : "";

  // Show attached file(s) if present
  let afile = '';
  if (a.fileUrl || (a.files && a.files.length)) {
    const links = [];
    if (a.fileUrl)
      links.push(`<a href="${a.fileUrl}" target="_blank" class="text-indigo-600 underline">Download Attachment</a>`);
    if (a.files && a.files.length)
      a.files.forEach(f =>
        links.push(`<a href="${f.url || f}" target="_blank" class="text-indigo-600 underline">Attachment</a>`));
    afile = links.join('<br>');
  }
  document.getElementById("assignmentModalFile").innerHTML = afile;

  // Assignment submissions: fetch submission(s) for this assignment and user
  document.getElementById("assignmentModalSubmissionDetails").innerHTML = "";
  try {
    let token = localStorage.getItem('token') || sessionStorage.getItem('token');
    let submitResp = await fetch(`${API_BASE_STUDENT}assignments/${a._id}/my-submission`, {
      headers: { Authorization: "Bearer " + token },
      credentials: "include"
    });
    if (submitResp.ok) {
      const submitData = await submitResp.json();
      if (submitData && submitData.submission) {
        const sub = submitData.submission;
        document.getElementById("assignmentModalSubmissionBlock").classList.add("hidden");
        let feedback = sub.feedback ? `<div class="bg-blue-50 text-blue-800 px-4 py-2 rounded mt-2 mb-1"><i class="fa fa-comment"></i> Feedback: ${sub.feedback}</div>` : "";
        let grade = sub.grade !== undefined ? `<div class="bg-green-50 text-green-800 px-4 py-2 rounded mb-2"><i class="fa fa-check"></i> Grade: <span class="font-bold">${sub.grade}</span></div>` : "";
        let fileLink = sub.fileUrl ? `<div><a href="${sub.fileUrl}" target="_blank" class="text-indigo-700 underline">View File Submission</a></div>` : "";
        let text = sub.text ? `<div class="bg-gray-50 rounded px-3 py-2 text-gray-700 mt-1"><strong>Your Text:</strong><br>${sub.text}</div>` : "";
        document.getElementById("assignmentModalSubmissionDetails").innerHTML =
          `<div class="mb-2">You have submitted this assignment${sub.gradedAt ? " (graded)" : ""}.</div>
          ${grade}${feedback}${fileLink}${text}
          <div class="text-xs text-gray-400 mt-1">Submitted ${new Date(sub.submittedAt).toLocaleString() || "-"}</div>`;
        return;
      }
    }
    // If no submission found
    if (a.status && String(a.status).toLowerCase() === "overdue") {
      document.getElementById("assignmentModalSubmissionBlock").classList.add("hidden");
      document.getElementById("assignmentModalSubmissionDetails").innerHTML =
        '<div class="text-red-600 font-bold mt-3">This assignment is overdue and cannot be submitted.</div>';
    } else {
      document.getElementById("assignmentIdHidden").value = a._id;
      document.getElementById("assignmentModalSubmissionBlock").classList.remove("hidden");
      document.getElementById("assignmentModalSubmissionDetails").innerHTML = "";
      document.getElementById("assignmentSubmitText").value = "";
      document.getElementById("assignmentUploadFile").value = "";
    }
  } catch (e) {
    document.getElementById("assignmentModalSubmissionBlock").classList.add("hidden");
    document.getElementById("assignmentModalSubmissionDetails").innerHTML =
      '<div class="bg-red-50 text-red-700 rounded px-4 py-2">Could not load submission info.</div>';
  }

  // Show the modal
  const modal = document.getElementById("assignmentViewModal");
  modal.classList.remove("hidden");
  modal.classList.add("flex");
  document.body.style.overflow = "hidden";
}

function closeAssignmentViewModal() {
  const modal = document.getElementById("assignmentViewModal");
  modal.classList.add("hidden");
  modal.classList.remove("flex");
  document.body.style.overflow = "";
}

async function submitAssignmentSubmission(e) {
  e.preventDefault();
  const id = document.getElementById("assignmentIdHidden").value;
  const text = document.getElementById("assignmentSubmitText").value;
  const fileInput = document.getElementById("assignmentUploadFile");
  const file = fileInput.files[0];
  let token = localStorage.getItem('token') || sessionStorage.getItem('token');
  if (!id) return false;
  if (!text && !file) {
    alert("Please type your answer or upload a file.");
    return false;
  }

  const form = new FormData();
  form.append("assignment", id);
  if (text) form.append("text", text);
  if (file) form.append("file", file);

  document.getElementById("assignmentSubmitBtn").disabled = true;
  document.getElementById("assignmentSubmitBtn").textContent = "Submitting...";

  try {
    const resp = await fetch(`${API_BASE_STUDENT}assignments/${id}/submit`, {
      method: "POST",
      body: form,
      headers: { Authorization: "Bearer " + token },
      credentials: "include"
    });
    const data = await resp.json();
    if (resp.ok) {
      alert("Submission received! You can edit or resubmit before it's graded.");
      closeAssignmentViewModal();
      loadStudentAssignmentsSection();
    } else {
      alert("Error submitting assignment: " + (data && data.message ? data.message : "Unknown error"));
      document.getElementById("assignmentSubmitBtn").disabled = false;
      document.getElementById("assignmentSubmitBtn").textContent = "Submit Assignment";
    }
  } catch (err) {
    alert("Could not submit: " + err);
    document.getElementById("assignmentSubmitBtn").disabled = false;
    document.getElementById("assignmentSubmitBtn").textContent = "Submit Assignment";
  }
  return false;
}

document.addEventListener("DOMContentLoaded", function() {
  // Only run if assignments-section is present
  if (document.getElementById("assignments-section")) {
    loadStudentAssignmentsSection();
    // Modal close wiring
    document.getElementById("assignmentViewModal").addEventListener("click", function(e){
      if (e.target === this) closeAssignmentViewModal();
    });
    window.addEventListener("keydown", e => { if (e.key === "Escape") closeAssignmentViewModal(); });
  }
});

// Add this function as a global for use by the table buttons:
window.viewStudentAssignment = viewStudentAssignment;
window.closeAssignmentViewModal = closeAssignmentViewModal;
window.submitAssignmentSubmission = submitAssignmentSubmission;

</script>
              

<!-- Mock Tests / Exams Section (Paginated) -->
<div id="mocktests-section" class="section-block hidden">
  <div class="max-w-5xl mx-auto py-8">
    <!-- AVAILABLE MOCKS -->
    <div class="mb-8">
      <h2 class="text-2xl font-semibold text-indigo-800 mb-2">Available Mock Exams</h2>
      <div class="overflow-x-auto rounded-xl shadow">
        <table class="min-w-full bg-white rounded-xl" id="mockExamsTable">
          <thead>
            <tr class="bg-indigo-50 text-gray-700 font-semibold text-sm">
              <th class="px-5 py-3 text-left rounded-tl-xl">Exam Title</th>
              <th class="px-5 py-3 text-left">Start Time</th>
              <th class="px-5 py-3 text-left">Status</th>
              <th class="px-5 py-3 text-left rounded-tr-xl">Action</th>
            </tr>
          </thead>
          <tbody class="text-gray-700" id="mockExamsTableBody">
            <!-- Filled by JS -->
          </tbody>
        </table>
      </div>
      <div class="flex items-center justify-end gap-3 mt-2">
        <button id="mockAvailablePrevBtn" class="bg-gray-200 px-3 py-1 rounded hover:bg-gray-300 font-bold" disabled>Previous</button>
        <span id="mockAvailablePageInfo" class="text-gray-700">Page 1</span>
        <button id="mockAvailableNextBtn" class="bg-gray-200 px-3 py-1 rounded hover:bg-gray-300 font-bold" disabled>Next</button>
      </div>
    </div>

    <!-- COMPLETED MOCKS -->
    <div class="mb-2">
      <h2 class="text-2xl font-semibold text-indigo-800 mb-2">Completed Mock Exams</h2>
      <div class="overflow-x-auto rounded-xl shadow">
        <table class="min-w-full bg-white rounded-xl" id="completedExamsTable">
          <thead>
            <tr class="bg-indigo-50 text-gray-700 font-semibold text-sm">
              <th class="px-5 py-3 text-left rounded-tl-xl">Exam Title</th>
              <th class="px-5 py-3 text-left">Date Completed</th>
              <th class="px-5 py-3 text-left">Score</th>
              <th class="px-5 py-3 text-left rounded-tr-xl">Review</th>
            </tr>
          </thead>
          <tbody class="text-gray-700" id="completedExamsTableBody">
            <!-- Filled by JS -->
          </tbody>
        </table>
      </div>
      <div class="flex items-center justify-end gap-3 mt-2">
        <button id="mockCompletedPrevBtn" class="bg-gray-200 px-3 py-1 rounded hover:bg-gray-300 font-bold" disabled>Previous</button>
        <span id="mockCompletedPageInfo" class="text-gray-700">Page 1</span>
        <button id="mockCompletedNextBtn" class="bg-gray-200 px-3 py-1 rounded hover:bg-gray-300 font-bold" disabled>Next</button>
      </div>
    </div>
  </div>
</div>

<script>
const MOCK_PAGE_SIZE = 6;
let availableMocks = [];
let completedMocks = [];
let availableMockPage = 1;
let completedMockPage = 1;

function formatDate(dateStr) {
  if (!dateStr) return "";
  const date = new Date(dateStr);
  return date.toLocaleDateString('en-GB', { year: 'numeric', month: 'short', day: 'numeric' });
}
function formatTime(dateStr) {
  if (!dateStr) return "";
  const date = new Date(dateStr);
  return date.toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit' });
}
function esc(str) { return String(str || "").replace(/</g, "&lt;").replace(/>/g, "&gt;"); }

async function fetchCurrentUser() {
  try {
    const token = localStorage.getItem("token") || sessionStorage.getItem("token");
    if (!token) return null;
    const res = await fetch(`${API_BASE_URL}/api/auth/me`, {
      headers: { "Authorization": "Bearer " + token }
    });
    if (!res.ok) throw new Error("Failed to fetch user");
    const data = await res.json();
    return data.user;
  } catch(err) {
    console.error("User fetch error:", err);
    return null;
  }
}

async function fetchMockExams() {
  const token = localStorage.getItem("token") || sessionStorage.getItem("token");
  availableMocks = [];
  completedMocks = [];
  availableMockPage = 1;
  completedMockPage = 1;
  try {
    const user = await fetchCurrentUser();
    if (!user) {
      document.getElementById("mockExamsTableBody").innerHTML =
        '<tr><td colspan="4" class="px-5 py-5 text-center text-gray-400">Please login</td></tr>';
      document.getElementById("completedExamsTableBody").innerHTML =
        '<tr><td colspan="4" class="px-5 py-5 text-center text-gray-400">Please login</td></tr>';
      updatePaginationControls();
      return;
    }
    let faculty = user.faculty && (user.faculty._id || user.faculty);
    let department = user.department && (user.department._id || user.department);
    let level = user.level || "100";

    // Fetch exam schedules (AVAILABLE)
    let url = `${API_BASE_URL}/api/schedules?faculty=${faculty}&department=${department}&level=${encodeURIComponent(level)}`;
    const resExams = await fetch(url, {
      headers: { "Authorization": token ? `Bearer ${token}` : undefined }
    });
    let scheduleExams = [];
    if (resExams.ok) {
      const resp = await resExams.json();
      if (Array.isArray(resp)) {
        scheduleExams = resp;
      } else if (resp.schedules) {
        scheduleExams = resp.schedules;
      }
    }

    // Fetch completed exams (history)
    let completed = [];
    const resCompleted = await fetch(`${API_BASE_URL}/api/results/user/${user._id}`, {
      headers: { "Authorization": token ? `Bearer ${token}` : undefined }
    });
    if (resCompleted.ok) {
      const data = await resCompleted.json();
      if (Array.isArray(data)) completed = data;
    }

    // Gather completed examSet IDs
    const completedExamSetIDs = new Set(
      completed
        .map(r =>
          r.examSet?._id ||
          r.examSet ||
          r.examSetId ||
          (typeof r.examSet === 'object' && r.examSet?._id)
        )
        .filter(Boolean)
        .map(String)
    );

    // Available (not completed)
    availableMocks = scheduleExams.filter(sch => {
      const examSetId = sch.examSet?._id || sch.examSet || sch.examSetId || sch._id;
      return !completedExamSetIDs.has(String(examSetId));
    });

    // Completed
    completedMocks = completed;

    renderAvailableMocks();
    renderCompletedMocks();
    updatePaginationControls();
  } catch (e) {
    document.getElementById("mockExamsTableBody").innerHTML =
      `<tr><td colspan="4" class="px-5 py-5 text-center text-red-500">Failed to load exams.</td></tr>`;
    document.getElementById("completedExamsTableBody").innerHTML =
      `<tr><td colspan="4" class="px-5 py-5 text-center text-red-500">Failed to load exams.</td></tr>`;
    updatePaginationControls();
  }
}

function renderAvailableMocks() {
  const tbody = document.getElementById("mockExamsTableBody");
  const start = (availableMockPage-1)*MOCK_PAGE_SIZE;
  const pageMocks = availableMocks.slice(start, start+MOCK_PAGE_SIZE);
  tbody.innerHTML = "";
  if (!pageMocks.length) {
    tbody.innerHTML = `<tr><td colspan="4" class="text-gray-400 px-5 py-5 text-center">No available mock exams</td></tr>`;
    return;
  }
  pageMocks.forEach(sch => {
    const examSet = sch.examSet || {};
    const title = esc(examSet.title || sch.title || "Untitled");
    const startTime = sch.start || sch.startTime || sch.date || examSet.startTime || "";
    const status = (sch.status || examSet.status || "").toLowerCase();
    let now = new Date();
    let examStartTime = new Date(startTime);

    let statusLabel = "";
    let actionBtn = "";
    if ((status === "active" || status === "open") && examStartTime <= now) {
      statusLabel = `<span class="inline-flex items-center px-3 py-1 bg-green-100 text-green-700 rounded-full text-xs font-bold">Available</span>`;
      actionBtn = `<button class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white font-semibold rounded-lg shadow text-xs" onclick="startTest('${examSet._id || sch._id}')">Start</button>`;
    } else if (status === "closed") {
      statusLabel = `<span class="inline-flex items-center px-3 py-1 bg-gray-200 text-gray-700 rounded-full text-xs font-bold">Closed</span>`;
      actionBtn = `<button class="px-4 py-2 bg-gray-200 text-gray-400 font-semibold rounded-lg shadow text-xs cursor-not-allowed" disabled>Closed</button>`;
    } else {
      statusLabel = `<span class="inline-flex items-center px-3 py-1 bg-blue-100 text-blue-700 rounded-full text-xs font-bold">Upcoming</span>`;
      actionBtn = `<button class="px-4 py-2 bg-blue-100 text-blue-500 font-semibold rounded-lg shadow text-xs cursor-not-allowed" disabled>Upcoming</button>`;
    }
    tbody.innerHTML += `
      <tr class="border-b hover:bg-indigo-50/50">
        <td class="px-5 py-4 font-medium">${title}</td>
        <td class="px-5 py-4 text-sm">${formatDate(startTime)} ${formatTime(startTime)}</td>
        <td class="px-5 py-4">${statusLabel}</td>
        <td class="px-5 py-4">${actionBtn}</td>
      </tr>
    `;
  });
}

function renderCompletedMocks() {
  const tbody = document.getElementById("completedExamsTableBody");
  const start = (completedMockPage-1)*MOCK_PAGE_SIZE;
  const pageMocks = completedMocks.slice(start, start+MOCK_PAGE_SIZE);
  if (!pageMocks.length) {
    tbody.innerHTML = `<tr><td colspan="4" class="text-gray-400 px-5 py-5 text-center">No completed mock exams yet</td></tr>`;
    return;
  }
  tbody.innerHTML = pageMocks.map(res => {
    let title =
      esc((res.examSet && (res.examSet.title || res.examSet.name)) ||
      res.examTitle || res.title || "Untitled");
    let dateCompleted = res.completedAt || res.date || res.createdAt || res.submittedAt;
    let score = res.score || res.percentage || (res.result ? `${res.result}` : "");
    return `
  <tr class="border-b hover:bg-indigo-50/50">
    <td class="px-5 py-4 font-medium">${title}</td>
    <td class="px-5 py-4 text-sm">${formatDate(dateCompleted)}</td>
    <td class="px-5 py-4 font-semibold text-green-700">${score ? (score + '%') : ''}</td>
    <td class="px-5 py-4">
      <button class="px-4 py-2 bg-indigo-600 hover:bg-indigo-700 text-white font-semibold rounded-lg shadow text-xs"
        onclick="openReviewTab('${res._id}')">Review</button>
    </td>
  </tr>
`;
  }).join('');
}

function updatePaginationControls() {
  // Available
  const totalAvailable = Math.ceil(availableMocks.length / MOCK_PAGE_SIZE) || 1;
  document.getElementById("mockAvailablePageInfo").textContent = `Page ${availableMockPage} of ${totalAvailable}`;
  document.getElementById("mockAvailablePrevBtn").disabled = availableMockPage <= 1;
  document.getElementById("mockAvailableNextBtn").disabled = availableMockPage >= totalAvailable;
  // Completed
  const totalCompleted = Math.ceil(completedMocks.length / MOCK_PAGE_SIZE) || 1;
  document.getElementById("mockCompletedPageInfo").textContent = `Page ${completedMockPage} of ${totalCompleted}`;
  document.getElementById("mockCompletedPrevBtn").disabled = completedMockPage <= 1;
  document.getElementById("mockCompletedNextBtn").disabled = completedMockPage >= totalCompleted;
}

// Event Listeners for Pagination
document.addEventListener("DOMContentLoaded", function() {
  document.getElementById("mockAvailablePrevBtn").onclick = function() {
    if (availableMockPage > 1) { availableMockPage--; renderAvailableMocks(); updatePaginationControls(); }
  };
  document.getElementById("mockAvailableNextBtn").onclick = function() {
    const total = Math.ceil(availableMocks.length / MOCK_PAGE_SIZE) || 1;
    if (availableMockPage < total) { availableMockPage++; renderAvailableMocks(); updatePaginationControls(); }
  };
  document.getElementById("mockCompletedPrevBtn").onclick = function() {
    if (completedMockPage > 1) { completedMockPage--; renderCompletedMocks(); updatePaginationControls(); }
  };
  document.getElementById("mockCompletedNextBtn").onclick = function() {
    const total = Math.ceil(completedMocks.length / MOCK_PAGE_SIZE) || 1;
    if (completedMockPage < total) { completedMockPage++; renderCompletedMocks(); updatePaginationControls(); }
  };

  fetchMockExams();
});

function startTest(examSetId) {
  window.location.href = `test.html?examSet=${encodeURIComponent(examSetId)}`;
}
function openReviewTab(sessionId) {
  window.open('review.html?session=' + encodeURIComponent(sessionId), '_blank');
}

</script>
<!-- Full PATCH: Past Questions Section â€“ now supports multiple images per question and "PDF-like" multi-image preview! -->

<!-- Past Questions Section -->
<div id="pastquestions-section" class="section-block hidden">
  <div class="max-w-6xl mx-auto py-8">
    <!-- Filter Form -->
    <form id="pastQuestionsFilterForm" class="bg-white rounded-xl shadow px-6 py-5 mb-8 flex flex-col md:flex-row gap-4 md:items-end">
      <!-- ... (unchanged) ... -->
      <div class="flex flex-col flex-1">
        <label class="font-medium text-gray-700 mb-1" for="pqf-course">Course</label>
        <input type="text" id="pqf-course" name="course" class="border rounded-lg p-2 text-gray-700 focus:ring focus:border-blue-400 outline-none" placeholder="e.g., Physics, Chemistry">
      </div>
      <div class="flex flex-col flex-1">
        <label class="font-medium text-gray-700 mb-1" for="pqf-year">Year</label>
        <input type="number" id="pqf-year" name="year" class="border rounded-lg p-2 text-gray-700 focus:ring focus:border-blue-400 outline-none" placeholder="e.g., 2023">
      </div>
      <div class="flex flex-col flex-1">
        <label class="font-medium text-gray-700 mb-1" for="pqf-type">Exam Type</label>
        <select id="pqf-type" name="type" class="border rounded-lg p-2 text-gray-700 focus:ring focus:border-blue-400 outline-none">
          <option value="" selected>All types</option>
          <option value="midterm">Midterm</option>
          <option value="final">Final</option>
          <option value="quiz">Quiz</option>
        </select>
      </div>
      <button type="submit" class="bg-gradient-to-r from-indigo-500 to-blue-600 text-white font-semibold px-7 py-2 rounded-lg shadow-md hover:from-indigo-700 hover:to-blue-800 transition w-full md:w-auto">
        Filter
      </button>
    </form>
    <!-- Upload Form Toggle & Modal -->
    <div class="flex justify-end mb-4">
      <button
        onclick="document.getElementById('pq-upload-modal').classList.remove('hidden')"
        class="bg-green-600 hover:bg-green-700 text-white font-semibold px-6 py-2 rounded-lg shadow"
      >
        Upload Past Question
      </button>
    </div>
    <!-- Upload Modal (hidden by default) -->
    <div id="pq-upload-modal" class="fixed inset-0 flex items-center justify-center z-50 bg-black bg-opacity-40 hidden transition">
      <div class="bg-white w-full max-w-md mx-auto rounded-xl shadow-2xl p-8 relative flex flex-col gap-6">
        <button
          class="absolute top-3 right-4 text-gray-400 hover:text-indigo-700 text-2xl"
          onclick="document.getElementById('pq-upload-modal').classList.add('hidden')">&times;</button>
        <h2 class="font-bold text-xl text-indigo-700">Upload Past Question</h2>
        <form id="pq-upload-form" enctype="multipart/form-data" class="flex flex-col gap-4">
          <div>
            <label class="block font-medium mb-1 text-gray-700" for="pq-upload-course">Course Code</label>
            <input required type="text" name="course" id="pq-upload-course" placeholder="e.g., PHY101"
              class="w-full border rounded-lg p-2 text-gray-800 focus:ring focus:border-indigo-400 outline-none">
          </div>
          <div>
            <label class="block font-medium mb-1 text-gray-700" for="pq-upload-title">Title</label>
            <input required type="text" name="title" id="pq-upload-title" placeholder="e.g., Physics 101 - Final"
              class="w-full border rounded-lg p-2 text-gray-800 focus:ring focus:border-indigo-400 outline-none">
          </div>
          <div class="flex gap-2">
            <div class="flex-1">
              <label class="block font-medium mb-1 text-gray-700" for="pq-upload-year">Year</label>
              <input required type="number" name="year" id="pq-upload-year" placeholder="2024"
                class="w-full border rounded-lg p-2 text-gray-800 focus:ring focus:border-indigo-400 outline-none">
            </div>
            <div class="flex-1">
              <label class="block font-medium mb-1 text-gray-700" for="pq-upload-type">Exam Type</label>
              <select name="type" id="pq-upload-type" class="w-full border rounded-lg p-2 text-gray-800 focus:ring focus:border-indigo-400 outline-none">
                <option value="midterm">Midsemester Exam</option>
                <option value="final">Final</option>
                <option value="quiz">Quiz</option>
              </select>
            </div>
          </div>
          <div>
            <label class="block font-medium mb-1 text-gray-700" for="pq-upload-desc">Description <span class="text-gray-400 text-xs">(optional)</span></label>
            <textarea name="description" id="pq-upload-desc" rows="2" placeholder="Key highlights, what makes this paper useful, etc." class="w-full border rounded-lg p-2 text-gray-800 focus:ring focus:border-indigo-400 outline-none"></textarea>
          </div>
          <div>
            <label class="block font-medium mb-1 text-gray-700" for="pq-upload-file">File <span class="text-gray-400 text-xs">(PDF, Images, etc)</span></label>
            <input required type="file" name="file" id="pq-upload-file" accept=".pdf,image/*,application/msword,.docx" multiple class="w-full border rounded-lg p-2 text-gray-800" />
            <span class="block text-xs text-gray-500 mt-1">You may upload a single PDF/DOC, or <b>multiple images</b> (for scanned past questions).</span>
          </div>
          <button type="submit" class="bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 rounded mt-2">
            Upload
          </button>
          <div id="pq-upload-status" class="text-sm mt-1"></div>
        </form>
      </div>
    </div>
    <!-- Past Questions List/Grid Area -->
    <div id="pastQuestionsListGrid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
      <!-- JS injects cards here -->
    </div>
    <!-- No Results Found (hidden by default) -->
    <div id="pq-no-results" class="mt-12 flex flex-col items-center justify-center text-gray-400 hidden">
      <svg class="w-14 h-14 mb-2" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24"><path d="M5 12h14M12 5l7 7-7 7"/></svg>
      <span class="font-semibold text-lg">No past questions found.</span>
      <span class="text-sm">Try adjusting your search filters.</span>
    </div>
  </div>
</div>

<!-- Past Question "View" Modal -->
<div id="pq-view-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center hidden transition">
  <div id="pq-view-modal-content" class="relative bg-white rounded-2xl shadow-2xl max-w-3xl w-full mx-4 flex flex-col">
    <button
      class="absolute top-3 right-4 text-gray-400 hover:text-indigo-700 text-3xl font-bold z-10"
      id="pq-view-modal-close"
      aria-label="Close"
    >&times;</button>
    <div class="p-6" id="pq-view-modal-body"></div>
  </div>
</div>

<script>
const PQ_API_URL = "https://examguide.onrender.com/api/pastquestions";
let currentUserId = null;

async function fetchCurrentUserId() {
  try {
    const resp = await fetch("https://examguide.onrender.com/api/auth/me", { credentials: "include" });
    if (resp.ok) {
      const data = await resp.json();
      currentUserId = data?.user?._id || data?.user?.id || null;
    }
  } catch {
    currentUserId = null;
  }
}
fetchCurrentUserId();

function pq_esc(str) {
  return String(str||"").replace(/[<>&"']/g, c =>
    c === '<' ? '&lt;'
    : c === '>' ? '&gt;'
    : c === '&' ? '&amp;'
    : c === '"' ? '&quot;' : '&#39;');
}

// --- jsPDF download utility ---
async function downloadImagesAsPDF(imgUrls, fileName = "PastQuestion.pdf") {
  const { jsPDF } = window.jspdf;
  const pdf = new jsPDF({ orientation: "portrait", unit: "pt", format: "a4" });
  for (let i = 0; i < imgUrls.length; i++) {
    let imgUrl = imgUrls[i];
    let img = await loadImageAsDataUrl(imgUrl);
    let imgProps = pdf.getImageProperties(img);
    let pdfWidth = pdf.internal.pageSize.getWidth();
    let pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;
    if (pdfHeight > pdf.internal.pageSize.getHeight()) {
      pdfHeight = pdf.internal.pageSize.getHeight();
      pdfWidth = (imgProps.width * pdfHeight) / imgProps.height;
    }
    if (i > 0) pdf.addPage();
    pdf.addImage(img, imgProps.fileType || "JPEG", 0, 0, pdfWidth, pdfHeight);
  }
  pdf.save(fileName);
}
function loadImageAsDataUrl(url) {
  return fetch(url)
    .then(r => r.blob())
    .then(blob =>
      new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onloadend = () => resolve(reader.result);
        reader.onerror = reject;
        reader.readAsDataURL(blob);
      })
    );
}

// Modal utility, unchanged
function openPQModal(html) {
  document.getElementById('pq-view-modal-body').innerHTML = html;
  document.getElementById('pq-view-modal').classList.remove('hidden');
}
function closePQModal() {
  document.getElementById('pq-view-modal').classList.add('hidden');
  document.getElementById('pq-view-modal-body').innerHTML = "";
}
document.getElementById('pq-view-modal-close').onclick = closePQModal;
document.getElementById('pq-view-modal').onclick = function(e) {
  if (e.target === this) closePQModal();
};
document.addEventListener('keydown', e=>{ if (e.key==="Escape") closePQModal(); });

function appendFileExtension(url, mimetype) {
  if (/\.(pdf|doc|docx|jpg|jpeg|png|gif)$/i.test(url)) return url;
  if (Array.isArray(mimetype)) mimetype = mimetype[0];
  if (mimetype === "application/pdf") return url + ".pdf";
  if (mimetype === "application/msword") return url + ".doc";
  if (mimetype === "application/vnd.openxmlformats-officedocument.wordprocessingml.document") return url + ".docx";
  return url;
}

function renderPQCard(item) {
  let colorClass = {
    midterm:"bg-purple-100 text-purple-700",
    final:"bg-green-100 text-green-700",
    quiz:"bg-red-100 text-red-700"
  }[item.type?.toLowerCase()] || 'bg-indigo-100 text-indigo-800';

  let isMultiImage = Array.isArray(item.fileUrl) && item.fileUrl.length > 1 && item.fileUrl.every(url => /\.(jpg|jpeg|png|gif)$/i.test(url));
  let fileUrl = Array.isArray(item.fileUrl) ? item.fileUrl[0] : (item.fileUrl || item.file || "");
  let mimetype = Array.isArray(item.mimetype) ? item.mimetype[0] : (item.mimetype || '');
  fileUrl = appendFileExtension(fileUrl, mimetype);

  let isPDF = fileUrl.toLowerCase().endsWith(".pdf");
  let isImage = /\.(jpg|jpeg|png|gif)$/i.test(fileUrl);
  let isDoc = /\.docx?$/i.test(fileUrl);

  let showActions = item.uploadedBy && currentUserId && (item.uploadedBy === currentUserId || item.uploadedBy._id === currentUserId);
  let actionsHtml = showActions ? `
    <div class="mt-2 flex gap-2">
      <button class="bg-red-600 hover:bg-red-700 text-white px-3 py-1 rounded text-sm font-semibold"
        onclick="jsDeletePQ('${item._id || item.id}')">Delete</button>
    </div>
  ` : "";

  let jsFunc = `pqShowPreviewModal(${JSON.stringify(item).replace(/"/g,'&quot;')})`;

  // --- Download Button Logic ---
  let downloadBtn = '';
  if (isMultiImage) {
    downloadBtn = `<button
        class="flex-1 bg-gray-100 hover:bg-indigo-50 text-indigo-700 transition px-4 py-2 rounded-lg font-semibold text-center"
        onclick='downloadImagesAsPDF(${JSON.stringify(item.fileUrl)}, "${pq_esc(item.title || item.course || "PastQuestion")}.pdf")'
      >Download as PDF</button>`;
  } else {
    downloadBtn = `<a class="flex-1 bg-gray-100 hover:bg-indigo-50 text-indigo-700 transition px-4 py-2 rounded-lg font-semibold text-center"
      href="${pq_esc(fileUrl)}" target="_blank" download>Download</a>`;
  }

  return `
    <div class="bg-white rounded-2xl shadow-lg p-6 flex flex-col hover:shadow-xl transition">
      <div class="flex items-center gap-3 mb-3">
        <span class="${colorClass} font-semibold px-3 py-1 rounded-lg text-xs">${pq_esc(item.course)}</span>
        <span class="bg-yellow-100 text-yellow-700 font-semibold px-2 py-1 rounded-lg text-xs">${pq_esc(item.year)}</span>
        <span class="${colorClass} px-2 py-1 rounded-lg text-xs font-semibold">${pq_esc(item.type)}</span>
      </div>
      <h3 class="font-bold text-lg text-indigo-900 mb-2">${pq_esc(item.title) || pq_esc(item.course) + " " + pq_esc(item.year)}</h3>
      <p class="text-gray-600 mb-4 text-sm">${pq_esc(item.description) || "Past question."}</p>
      <div class="flex gap-2 mt-auto">
        <button type="button" class="flex-1 bg-blue-600 hover:bg-blue-700 transition text-white px-4 py-2 rounded-lg font-semibold shadow"
          onclick="${jsFunc}">View</button>
        ${downloadBtn}
      </div>
      ${actionsHtml}
    </div>
  `;
}
window.jsDeletePQ = function(pqid){
  if (!confirm("Are you sure you want to delete this past question?")) return;
  fetch(PQ_API_URL + "/" + pqid, {
    method: "DELETE",
    credentials: "include"
  }).then(r => {
    if (r.ok) fetchAndRenderPastQuestions();
    else alert("Delete failed.");
  });
};

function pqShowPreviewModal(item) {
  if (Array.isArray(item.fileUrl) && item.fileUrl.length > 1 && item.fileUrl.every(url=> /\.(jpg|jpeg|png|gif)$/i.test(url))) {
    let images = item.fileUrl.map((url, i) =>
      `<div class="flex justify-center w-full my-4"><img src="${pq_esc(url)}" alt="Scan page ${i+1}" class="max-w-full max-h-[60vh] rounded border shadow" /></div>`
    ).join("");
    let content = `
      <div class="mb-2">
        <div class="flex items-center gap-2">
          <span class="bg-indigo-100 text-indigo-800 font-semibold px-3 py-1 rounded-lg text-xs">${pq_esc(item.course)}</span>
          <span class="bg-yellow-100 text-yellow-700 font-semibold px-2 py-1 rounded-lg text-xs">${pq_esc(item.year)}</span>
          <span class="bg-gray-50 text-gray-700 px-2 py-1 rounded-lg text-xs font-semibold">${pq_esc(item.type)}</span>
        </div>
        <h3 class="font-bold text-2xl text-indigo-900">${pq_esc(item.title) || pq_esc(item.course) + " " + pq_esc(item.year)}</h3>
        <p class="text-gray-600 text-sm">${pq_esc(item.description) || "Past question."}</p>
      </div>
      <div class="border bg-gray-50 rounded p-2 overflow-x-auto max-h-[64vh]">
        ${images}
      </div>
      <div class="mt-2 text-xs text-gray-500 text-center">
        This is a multi-page scanned past question uploaded as images.<br>
        Use <b>Download as PDF</b> on the card to export all pages to a single file.
      </div>
    `;
    openPQModal(content);
    return;
  }
  // Single file (PDF/Image/Doc)
  let fileUrl = Array.isArray(item.fileUrl) ? item.fileUrl[0] : (item.fileUrl || item.file || "");
  let mimetype = Array.isArray(item.mimetype) ? item.mimetype[0] : (item.mimetype || '');
  fileUrl = appendFileExtension(fileUrl, mimetype);

  let isPDF = fileUrl.toLowerCase().endsWith(".pdf");
  let isImage = /\.(jpg|jpeg|png|gif)$/i.test(fileUrl);
  let isDoc = /\.docx?$/i.test(fileUrl);

  let content = `
    <div class="flex flex-col gap-1 mb-3">
      <div class="flex items-center gap-3">
        <span class="bg-indigo-100 text-indigo-800 font-semibold px-3 py-1 rounded-lg text-xs">${pq_esc(item.course)}</span>
        <span class="bg-yellow-100 text-yellow-700 font-semibold px-2 py-1 rounded-lg text-xs">${pq_esc(item.year)}</span>
        <span class="bg-gray-50 text-gray-700 px-2 py-1 rounded-lg text-xs font-semibold">${pq_esc(item.type)}</span>
      </div>
      <h3 class="font-bold text-2xl text-indigo-900">${pq_esc(item.title) || pq_esc(item.course) + " " + pq_esc(item.year)}</h3>
      <p class="text-gray-600 text-sm">${pq_esc(item.description) || "Past question."}</p>
    </div>
  `;
  if (isPDF) {
    content += `
      <div class="w-full h-[60vh] flex items-center justify-center">
        <iframe src="${pq_esc(fileUrl)}#toolbar=1&view=fitH" class="w-full h-full rounded-lg border" frameborder="0" allowfullscreen></iframe>
      </div>
      <div class="mt-2 text-xs text-gray-500 text-center">
        Can't view? <a href="https://docs.google.com/gview?url=${encodeURIComponent(fileUrl)}&embedded=true" target="_blank" class="underline text-indigo-600">Open in Google Viewer</a>
      </div>
    `;
  } else if (isImage) {
    content += `
      <div class="flex justify-center w-full my-4">
        <img src="${pq_esc(fileUrl)}" alt="Past Question Image" class="max-w-full max-h-[55vh] rounded border" />
      </div>
    `;
  } else if (isDoc) {
    content += `
      <div class="w-full h-[60vh] flex items-center justify-center">
        <iframe src="https://docs.google.com/gview?url=${encodeURIComponent(fileUrl)}&embedded=true" class="w-full h-full rounded-lg border" frameborder="0"></iframe>
      </div>
      <div class="mt-2 text-xs text-gray-500 text-center">
        Can't view? <a href="${pq_esc(fileUrl)}" target="_blank" class="underline text-indigo-600">Download DOC File</a>
      </div>
    `;
  } else {
    content += `
      <div class="py-10 text-center">
        <span class="block text-gray-500 mb-3">Preview unavailable for this file type.</span>
        <a href="${pq_esc(fileUrl)}" target="_blank" class="bg-indigo-600 hover:bg-indigo-700 text-white font-semibold px-6 py-2 rounded-lg shadow">Download File</a>
      </div>
    `;
  }
  openPQModal(content);
}

let pq_lastFetched = [], pq_loading = false;

async function fetchAndRenderPastQuestions(q={}) {
  pq_loading = true;
  document.getElementById("pq-no-results").classList.add("hidden");
  let url = PQ_API_URL;
  let params = [];
  if (q.course) params.push("course="+encodeURIComponent(q.course));
  if (q.year) params.push("year="+encodeURIComponent(q.year));
  if (q.type) params.push("type="+encodeURIComponent(q.type));
  if (params.length) url += "?" + params.join("&");
  let list = [];
  try {
    let resp = await fetch(url, {credentials:"include"});
    list = await resp.json();
    if (!Array.isArray(list)) list = [];
    pq_lastFetched = list;
  } catch (e) {
    pq_lastFetched = [];
    list = [];
  }
  let grid = document.getElementById('pastQuestionsListGrid');
  grid.innerHTML = "";
  if (!list.length) {
    document.getElementById("pq-no-results").classList.remove("hidden");
    return;
  }
  document.getElementById("pq-no-results").classList.add("hidden");
  list.forEach(item=>{
    grid.innerHTML += renderPQCard(item);
  });
}
document.addEventListener("DOMContentLoaded",()=>fetchAndRenderPastQuestions());

document.getElementById('pastQuestionsFilterForm').onsubmit = function(e){
  e.preventDefault();
  let course = document.getElementById('pqf-course').value.trim();
  let year = document.getElementById('pqf-year').value.trim();
  let type = document.getElementById('pqf-type').value.trim();
  fetchAndRenderPastQuestions({course,year,type});
};

document.getElementById("pq-upload-form").onsubmit = async function(e){
  e.preventDefault();
  const status = document.getElementById("pq-upload-status");
  status.textContent = "";
  const form = e.target;
  let formData = new FormData(form);
  try {
    status.textContent = "Uploading...";
    let resp = await fetch(PQ_API_URL, {
      method: "POST",
      body: formData,
      credentials: "include"
    });
    if (!resp.ok) throw new Error("Upload failed");
    status.textContent = "Upload successful!";
    setTimeout(()=>{status.textContent="";document.getElementById('pq-upload-modal').classList.add("hidden");form.reset();},1200);
    fetchAndRenderPastQuestions();
  } catch(e) {
    status.textContent = "Upload failed, please try again.";
  }
};
</script>



<style>
/* Basic layout & modern bubbles */
.chat-grid { display:flex; gap:1rem; height:100%; }
#msgSidebar { width: 26%; min-width: 260px; max-width: 360px; background:#fff; border-radius:12px; box-shadow:0 6px 22px rgba(22,24,35,0.06); overflow:hidden; }
@media (max-width:767px) {
  #msgSidebar { position:fixed; top:0; left:0; height:100vh; width:88vw; max-width:340px; transform:translateX(-110%); transition:transform .22s; z-index:60; border-radius:0 18px 18px 0; }
  #msgSidebar.open { transform:translateX(0); }
  #msgSidebarOverlay { position:fixed; inset:0; background:rgba(0,0,0,.18); z-index:55; display:block; }
  #msgFab { display:flex; }
}
#msgSidebarOverlay { display:none; }
#msgFab { display:none; position:fixed; right:1.2rem; bottom:1.6rem; width:56px; height:56px; border-radius:999px; background:#6366f1; color:#fff; align-items:center; justify-content:center; box-shadow:0 8px 30px rgba(99,102,241,.18); z-index:70; border:none; }
#msgFab:hover { background:#4f46e5; }
.messages-pane { flex:1; display:flex; flex-direction:column; border-radius:12px; overflow:hidden; background:#f7fafc; box-shadow: 0 6px 18px rgba(22,24,35,0.04); }
/* header */
#msg-chat-header { display:flex; align-items:center; gap:12px; padding:12px 16px; background:#fff; border-bottom:1px solid #eef2ff; }
/* messages */
#msg-chat-body { padding:16px; overflow-y:auto; display:flex; flex-direction:column; gap:12px; }
.msg-row { display:flex; gap:10px; align-items:flex-end; }
.msg-row.mine { flex-direction:row-reverse; }
.msg-bubble { max-width:70%; padding:10px 12px; border-radius:12px; box-shadow: 0 4px 14px rgba(16,24,40,0.04); font-size:0.95rem; line-height:1.3; }
.msg-bubble.mine { background: linear-gradient(90deg,#eef2ff,#eef6ff); color:#0f172a; border-radius:12px 12px 8px 12px; }
.msg-bubble.other { background:#fff; color:#0f172a; border-radius:12px 12px 12px 8px; }
.msg-meta { font-size:0.75rem; color:#94a3b8; margin-top:6px; }
/* attachment preview in composer */
#attach-preview { display:flex; gap:8px; align-items:center; flex-wrap:wrap; margin-left:6px; }
.attach-thumb { width:64px; height:64px; object-fit:cover; border-radius:8px; border:1px solid #e6eef8; }
/* composer */
#msg-compose-bar { padding:10px; background:#fff; border-top:1px solid #eef2ff; display:flex; gap:10px; align-items:center; }
.quill-wrapper { flex:1; min-height:48px; max-height:160px; overflow:auto; border:1px solid #eef2ff; border-radius:8px; background:#fff; }
.btn { display:inline-flex; align-items:center; gap:8px; padding:8px 12px; border-radius:8px; cursor:pointer; }
.icon-btn { width:40px; height:40px; display:inline-flex; align-items:center; justify-content:center; background:#f1f5f9; border-radius:8px; cursor:pointer; border:1px solid #e6eef8; }
.small-muted { font-size:0.8rem; color:#94a3b8; }
/* small screen adjustments */
@media (max-width:767px) {
  #msgSidebar { box-shadow: 0 10px 40px rgba(2,6,23,0.2); }
  .msg-bubble { max-width:78%; }
}
</style>

<div id="messages-section" class="section-block">
  <div class="chat-grid h-[80vh] w-full" style="height:80vh;">
    <!-- Sidebar -->
    <aside id="msgSidebar" class="rounded-lg overflow-hidden flex flex-col bg-white border-r shadow-lg" tabindex="-1">
      <div class="flex-shrink-0 p-4 border-b relative">
        <input id="msg-search" type="text" placeholder="Search messages or contacts"
          class="block w-full p-2 pl-9 text-sm border rounded-lg bg-gray-50 outline-none focus:border-blue-300" />
        <span class="absolute left-4 top-3.5 text-gray-400">
          <!-- search icon -->
          <svg class="w-4 h-4" fill="none" stroke="currentColor"><path d="M21 21l-4.35-4.35M11 19a8 8 0 100-16 8 8 0 000 16z"/></svg>
        </span>
      </div>
      <div class="flex-1 overflow-y-auto min-h-0 pb-4">
        <div>
          <div class="text-xs font-semibold px-4 pt-3 pb-2 text-gray-500 uppercase">Your Chats</div>
          <ul id="msg-contacts-list" class="divide-y"></ul>
        </div>
        <div>
          <div class="text-xs font-semibold px-4 pt-3 pb-2 text-gray-500 uppercase">People in Your Dept & Level</div>
          <ul id="msg-similar-list" class="divide-y"></ul>
        </div>
        <div>
          <div class="text-xs font-semibold px-4 pt-3 pb-2 text-gray-500 uppercase">Groups</div>
          <ul id="msg-groups-list" class="divide-y"></ul>
          <div class="px-4"><button class="bg-indigo-600 text-white w-full mt-3 px-3 py-2 rounded" onclick="showGroupModal()">+ Create Group Chat</button></div>
        </div>
      </div>
    </aside>

    <!-- Mobile overlay & fab -->
    <div id="msgSidebarOverlay" class="hidden" onclick="toggleMsgSidebar(false)"></div>
    <button id="msgFab" onclick="toggleMsgSidebar(true)" title="Open chats">
      <svg class="w-6 h-6" fill="none" stroke="currentColor"><path d="M4 6h16M4 12h16M4 18h16"/></svg>
    </button>

    <!-- Main messages pane -->
    <div class="messages-pane flex-1 flex flex-col rounded-lg overflow-hidden bg-gray-50">
      <div id="msg-chat-header"></div>

      <div id="msg-chat-body"></div>

      <!-- Composer: Quill + attachments -->
      <div id="msg-compose-bar">
        <div class="icon-btn" id="attach-btn" title="Attach file">
          <svg class="w-5 h-5 text-gray-700" fill="none" stroke="currentColor"><path d="M4 7v13a2 2 0 002 2h12a2 2 0 002-2V7m-8-4h4l2 4H8l2-4z"/></svg>
        </div>
        <input type="file" id="attach-input" class="hidden" />
        <div class="quill-wrapper">
          <div id="msg-quill" style="min-height:40px;"></div>
        </div>
        <div id="attach-preview"></div>
        <button id="msg-send" class="btn bg-blue-600 text-white" title="Send message">
          <svg class="w-4 h-4" fill="none" stroke="currentColor"><path d="M22 12l-20 9L9 12 2 3l20 9z"/></svg>
          <span>Send</span>
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Group modal (unchanged) -->
<div id="group-modal" class="fixed inset-0 bg-black bg-opacity-30 flex items-center justify-center z-50 hidden">
  <div class="bg-white rounded-xl p-6 w-full max-w-md shadow-xl relative">
    <button onclick="closeGroupModal()" class="absolute top-2 right-3 text-gray-400 font-bold text-lg">&times;</button>
    <h3 class="text-lg font-bold mb-3">Create a New Group Chat</h3>
    <input id="group-name" placeholder="Group name" class="border p-2 w-full rounded mb-2" />
    <div class="text-sm text-gray-700 mb-2">Select members from your department and level:</div>
    <div id="group-users" class="overflow-y-auto max-h-48 border rounded px-3 py-2 mb-2 bg-gray-50"></div>
    <button onclick="submitGroup()" class="w-full bg-blue-700 text-white px-3 py-2 rounded font-semibold hover:bg-blue-800">Create Group</button>
    <div id="group-modal-result" class="text-center mt-3"></div>
  </div>
</div>

<!-- Quill CDN -->
<script src="https://cdn.quilljs.com/1.3.6/quill.min.js"></script>

<script>
/* ---------------------------
   Config & state
   --------------------------- */
const MSG_API_BASE = "https://examguide.onrender.com/api/messages";
let myUserId = null, chats = [], groups = [], currentChat = null, messages = [], similarUsers = [];
function getAuthHeaders() { const t = localStorage.getItem("token"); return t ? { "Authorization": "Bearer " + t } : {}; }

/* ---------------------------
   Quill + attachments init
   --------------------------- */
const quill = new Quill('#msg-quill', {
  theme: 'snow',
  placeholder: 'Write a message... (press Enter to send)',
  modules: { toolbar: [['bold','italic','underline'], [{ 'list': 'ordered'},{ 'list': 'bullet' }], ['link','image']] }
});
const attachInput = document.getElementById('attach-input');
const attachBtn = document.getElementById('attach-btn');
const attachPreview = document.getElementById('attach-preview');
let currentAttachment = null;

attachBtn.addEventListener('click', () => attachInput.click());
attachInput.addEventListener('change', (ev) => {
  const f = ev.target.files && ev.target.files[0];
  currentAttachment = f || null;
  attachPreview.innerHTML = '';
  if (!f) return;
  if (f.type.startsWith('image/')) {
    const url = URL.createObjectURL(f);
    const img = document.createElement('img');
    img.src = url; img.className = 'attach-thumb';
    attachPreview.appendChild(img);
  } else {
    const div = document.createElement('div');
    div.className = 'small-muted';
    div.textContent = f.name;
    attachPreview.appendChild(div);
  }
});

/* allow Enter to send (plain Enter) â€” but preserve Shift+Enter for newline */
quill.keyboard.addBinding({ key: 13 }, function(range, context) {
  // If shiftKey pressed, allow new line
  const e = window.event;
  if (e && e.shiftKey) return true;
  e.preventDefault();
  sendMsg();
  return false;
});

/* ---------------------------
   Fetch "me" and initial load
   --------------------------- */
async function fetchMe() {
  try {
    const res = await fetch('/api/auth/me', { credentials:'include', headers: getAuthHeaders() });
    if (res.ok) {
      const js = await res.json();
      myUserId = js?.user?._id || js?.user?.id || null;
    }
  } catch (e) { console.warn('fetchMe failed', e); }
}
fetchMe().then(()=> { loadChats(); loadSimilarUsers(); });

/* ---------------------------
   Sidebar renders (calls close sidebar on mobile)
   --------------------------- */
function onMobileChatSelected(){ if (window.innerWidth < 768) toggleMsgSidebar(false); }

function renderSidebarContacts(filter = "") {
  const list = (chats || []).filter(c => {
    const name = (c.fullname||c.username||'').toLowerCase();
    return name.includes((filter||'').toLowerCase());
  }).map(chat => {
    const isActive = currentChat && currentChat._id === chat._id;
    return `
      <li class="px-4 py-3 flex items-center gap-3 cursor-pointer ${isActive ? 'bg-indigo-50' : 'hover:bg-gray-50'}"
          onclick="openChatById('${chat._id}'); onMobileChatSelected();">
        <img src="${esc(chat.avatar || ('https://ui-avatars.com/api/?name=' + esc(chat.fullname||chat.username)))}" class="w-10 h-10 rounded-full"/>
        <div class="flex-1">
          <div class="flex justify-between items-center">
            <div class="font-medium">${esc(chat.fullname || chat.username)}</div>
            <div class="text-xs text-gray-400">${chat.unreadCount ? '<span class=\"bg-indigo-600 text-white rounded-full px-2 text-xs\">' + chat.unreadCount + '</span>' : ''}</div>
          </div>
          <div class="text-xs text-gray-400 truncate">${esc(chat.lastMessageText||'')}</div>
        </div>
      </li>
    `;
  }).join('');
  document.getElementById('msg-contacts-list').innerHTML = list || '<div class="px-4 py-3 text-sm text-gray-400">No contacts</div>';
}

function renderSidebarGroups() {
  const list = (groups||[]).map(g => `
    <li class="px-4 py-3 flex items-center gap-3 cursor-pointer hover:bg-gray-50" onclick="openChatById('${g._id}', true); onMobileChatSelected();">
      <img src="${esc(g.avatar || ('https://ui-avatars.com/api/?name=' + esc(g.name)))}" class="w-10 h-10 rounded-full"/>
      <div class="flex-1">
        <div class="font-medium">${esc(g.name)}</div>
        <div class="text-xs text-gray-400 truncate">${esc(g.lastMessageText||'')}</div>
      </div>
    </li>
  `).join('');
  document.getElementById('msg-groups-list').innerHTML = list || '<div class="px-4 py-3 text-sm text-gray-400">No groups</div>';
}

function renderSimilarContacts() {
  const list = (similarUsers||[]).map(u => `
    <li class="px-4 py-3 flex items-center gap-3 cursor-pointer hover:bg-gray-50" onclick="openChatById('${u._id}', false); onMobileChatSelected();">
      <img src="${esc(u.avatar || ('https://ui-avatars.com/api/?name=' + esc(u.fullname||u.username)))}" class="w-8 h-8 rounded-full"/>
      <div>
        <div class="font-medium text-sm">${esc(u.fullname||u.username)}</div>
        <div class="text-xs text-gray-400">${esc(u.level||'')}</div>
      </div>
    </li>
  `).join('');
  document.getElementById('msg-similar-list').innerHTML = list || '<div class="px-4 py-3 text-sm text-gray-400">No similar users</div>';
}

/* ---------------------------
   Load data
   --------------------------- */
async function loadChats() {
  try {
    const res = await fetch(MSG_API_BASE + '/chats', { credentials:'include', headers: getAuthHeaders() });
    if (!res.ok) return;
    const data = await res.json();
    chats = data.chats || [];
    groups = data.groups || [];
    renderSidebarContacts(document.getElementById('msg-search').value || '');
    renderSidebarGroups();
    // keep active chat if present; otherwise open first chat
    if (!currentChat && chats[0]) openChatById(chats[0]._id);
  } catch (e) { console.warn('loadChats err', e); }
}

async function loadSimilarUsers() {
  try {
    const res = await fetch(MSG_API_BASE + '/similar-users', { credentials:'include', headers: getAuthHeaders() });
    if (!res.ok) return;
    similarUsers = await res.json();
    renderSimilarContacts();
  } catch (e) { console.warn('loadSimilarUsers', e); }
}

/* ---------------------------
   Chat selection & header
   --------------------------- */
function renderChatHeader() {
  const el = document.getElementById('msg-chat-header');
  if (!currentChat) { el.innerHTML = '<div class="px-4 py-3 small-muted">Select a chat to start messaging</div>'; return; }
  if (currentChat.isGroup) {
    el.innerHTML = `
      <div style="display:flex;align-items:center;gap:12px;padding:8px 12px">
        <img src="${esc(currentChat.avatar || ('https://ui-avatars.com/api/?name=' + esc(currentChat.name)))}" class="w-12 h-12 rounded-full"/>
        <div>
          <div class="font-semibold">${esc(currentChat.name)}</div>
          <div class="small-muted">Group â€¢ ${esc(currentChat.members ? currentChat.members.length : '')} members</div>
        </div>
      </div>`;
  } else {
    el.innerHTML = `
      <div style="display:flex;align-items:center;gap:12px;padding:8px 12px">
        <img src="${esc(currentChat.avatar || ('https://ui-avatars.com/api/?name=' + esc(currentChat.fullname || currentChat.username)))}" class="w-12 h-12 rounded-full"/>
        <div>
          <div class="font-semibold">${esc(currentChat.fullname || currentChat.username)}</div>
          <div class="small-muted">Online</div>
        </div>
      </div>`;
  }
}

/* ---------------------------
   Render messages (use HTML if provided)
   --------------------------- */
function renderChatBody() {
  const body = document.getElementById('msg-chat-body');
  if (!messages || messages.length === 0) {
    body.innerHTML = '<div class="small-muted text-center p-6">No messages here yet. Say hi!</div>';
    return;
  }
  body.innerHTML = messages.map(m => {
    const mine = (m.from && (m.from._id === myUserId || m.from === myUserId));
    // prefer html property if backend stores rich content
    const contentHTML = m.html ? m.html : (m.text ? escapeHtml(m.text).replace(/\n/g,'<br/>') : '');
    const isImg = m.attachmentType === 'image' || /\.(jpe?g|png|gif|webp)$/i.test(m.attachmentUrl||'');
    const attachHtml = m.attachmentUrl ? (isImg ? `<img src="${esc(m.attachmentUrl)}" class="rounded-lg" style="max-width:240px;display:block;margin-top:8px;" />` : `<a href="${esc(m.attachmentUrl)}" class="text-sm text-indigo-600" target="_blank">Download attachment</a>`) : '';
    return `
      <div class="msg-row ${mine ? 'mine' : ''}">
        <img src="${esc(m.fromAvatar || (mine ? myAvatar() : currentChat?.avatar || 'https://ui-avatars.com/api/?name=User'))}" class="w-8 h-8 rounded-full"/>
        <div>
          <div class="msg-bubble ${mine ? 'mine' : 'other'}">
            ${contentHTML}
            ${attachHtml}
          </div>
          <div class="msg-meta ${mine ? 'text-right' : ''}">${esc(formatTime(m.time || m.createdAt || ''))}</div>
        </div>
      </div>
    `;
  }).join('');
  // auto-scroll to bottom
  setTimeout(()=> { const pane = document.getElementById('msg-chat-body'); pane.scrollTop = pane.scrollHeight; }, 80);
}

/* ---------------------------
   Utilities
   --------------------------- */
function esc(s){ return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }
function escapeHtml(s){ return esc(s).replace(/&#39;/g,"'"); } // allow single quote
function formatTime(t){
  try { const d = new Date(t); return d.toLocaleString(); } catch(e){ return t||''; }
}
function myAvatar(){ return 'https://ui-avatars.com/api/?name=Me&background=4f46e5&color=fff&bold=true'; }

/* ---------------------------
   Open chat and fetch messages
   --------------------------- */
async function openChatById(id, isGroup=false) {
  // find chat in chats/groups/similar
  currentChat = (isGroup ? groups : chats).find(x => x._id === id) || similarUsers.find(x => x._id === id) || { _id:id, isGroup:isGroup };
  if (!currentChat) return;
  // render header
  renderChatHeader();
  // fetch messages
  try {
    const url = isGroup ? `${MSG_API_BASE}/group/${encodeURIComponent(id)}/messages` : `${MSG_API_BASE}/user/${encodeURIComponent(id)}/messages`;
    const res = await fetch(url, { credentials:'include', headers: getAuthHeaders() });
    if (!res.ok) { document.getElementById('msg-chat-body').innerHTML = '<div class="small-muted p-4">Could not load messages.</div>'; return; }
    messages = await res.json();
    renderChatBody();
    onMobileChatSelected();
  } catch (e) { console.warn('openChatById error', e); }
}

/* ---------------------------
   Sending message (supports FormData for attachments & HTML from Quill)
   --------------------------- */
document.getElementById('msg-send').addEventListener('click', sendMsg);
async function sendMsg() {
  if (!currentChat) return;
  const html = quill.root.innerHTML.trim();
  const plain = quill.getText().trim();
  if (!plain && !currentAttachment) return; // nothing to send

  const url = currentChat.isGroup ? `${MSG_API_BASE}/group/${encodeURIComponent(currentChat._id)}/send` : `${MSG_API_BASE}/user/${encodeURIComponent(currentChat._id)}/send`;

  try {
    let opts = { method: 'POST', credentials:'include', headers: {...getAuthHeaders()} };
    if (currentAttachment) {
      const fd = new FormData();
      fd.append('file', currentAttachment);
      fd.append('text', plain || '');
      fd.append('html', html || '');
      opts.body = fd;
      // DO NOT set Content-Type for FormData; browser will set boundary
    } else {
      opts.headers['Content-Type'] = 'application/json';
      opts.body = JSON.stringify({ text: plain || '', html: html || '' });
    }
    // send
    const res = await fetch(url, opts);
    if (!res.ok) {
      console.warn('send failed', await res.text());
    } else {
      // clear composer
      quill.setText('');
      attachInput.value = '';
      currentAttachment = null;
      attachPreview.innerHTML = '';
      // update conversation immediately
      const rjson = await res.json();
      // if API returns saved message push it, else refetch
      if (rjson && rjson.message) {
        messages.push(rjson.message);
        renderChatBody();
      } else {
        await fetchLatestChatMessages(); // fallback to re-fetch
      }
      // refresh sidebar silently
      loadChats();
    }
  } catch (e) { console.warn('sendMsg error', e); }
}

/* ---------------------------
   Silent polling every 2 seconds
   --------------------------- */
let pollInterval = 2000;
async function fetchLatestChatMessages() {
  if (!currentChat) return;
  try {
    const url = currentChat.isGroup ? `${MSG_API_BASE}/group/${encodeURIComponent(currentChat._id)}/messages` : `${MSG_API_BASE}/user/${encodeURIComponent(currentChat._id)}/messages`;
    const res = await fetch(url, { credentials:'include', headers: getAuthHeaders() });
    if (!res.ok) return;
    const latest = await res.json();
    // compare by length or last id
    const lastKnownId = messages.length ? messages[messages.length-1]?._id : null;
    const newLastId = latest.length ? latest[latest.length-1]?._id : null;
    if (latest.length !== messages.length || newLastId !== lastKnownId) {
      messages = latest;
      renderChatBody();
    }
  } catch(e){ /* silent */ }
}

async function silentPoll() {
  try {
    await loadChats(); // refresh sidebar silently
    await fetchLatestChatMessages();
  } catch(e){}
}
setInterval(silentPoll, pollInterval);

/* ---------------------------
   Group modal logic (unchanged)
   --------------------------- */
function showGroupModal(){
  // render users
  const html = (similarUsers||[]).map(u => `<label class="block py-1"><input type="checkbox" value="${u._id}" /> ${esc(u.fullname||u.username)} (${esc(u.level||'')})</label>`).join('');
  document.getElementById('group-users').innerHTML = html;
  document.getElementById('group-modal-result').textContent = '';
  document.getElementById('group-modal').classList.remove('hidden');
}
function closeGroupModal(){ document.getElementById('group-modal').classList.add('hidden'); }
async function submitGroup(){
  const name = document.getElementById('group-name').value.trim();
  const boxes = Array.from(document.querySelectorAll('#group-users input:checked'));
  const memberIds = boxes.map(b=>b.value);
  if (!name || memberIds.length===0) { document.getElementById('group-modal-result').textContent = 'Enter group name & select members'; return; }
  try {
    const res = await fetch(MSG_API_BASE + '/groups/create', {
      method:'POST', credentials:'include', headers: {...getAuthHeaders(), 'Content-Type':'application/json'}, body: JSON.stringify({ name, memberIds })
    });
    const out = await res.json();
    if (out.success) {
      document.getElementById('group-modal-result').innerHTML = `<div class="text-green-600">Group created! Code: <b>${out.code}</b></div>`;
      loadChats();
      setTimeout(closeGroupModal, 1600);
    } else {
      document.getElementById('group-modal-result').innerHTML = `<div class="text-red-600">${out.error || 'Error'}</div>`;
    }
  } catch(e){ document.getElementById('group-modal-result').innerHTML = `<div class="text-red-600">Error creating group</div>`; }
}

/* ---------------------------
   Sidebar toggle for mobile
   --------------------------- */
function toggleMsgSidebar(open) {
  const side = document.getElementById('msgSidebar');
  const overlay = document.getElementById('msgSidebarOverlay');
  if (open) { side.classList.add('open'); overlay.classList.remove('hidden'); document.getElementById('msgFab').style.display='none'; }
  else { side.classList.remove('open'); overlay.classList.add('hidden'); if (window.innerWidth < 768) document.getElementById('msgFab').style.display='flex'; }
}
window.addEventListener('resize', () => {
  if (window.innerWidth >= 768) { document.getElementById('msgFab').style.display='none'; document.getElementById('msgSidebar').classList.remove('open'); document.getElementById('msgSidebarOverlay').classList.add('hidden'); }
  else { document.getElementById('msgFab').style.display='flex'; }
});

/* ---------------------------
   Search hook
   --------------------------- */
document.getElementById('msg-search').addEventListener('input', e => { renderSidebarContacts(e.target.value||''); });

/* ---------------------------
   Initial helpers: load similar users & chats
   --------------------------- */
async function loadSimilarUsers(){ // override earlier stub to keep usage consistent
  try {
    const res = await fetch(MSG_API_BASE + '/similar-users', { credentials:'include', headers: getAuthHeaders() });
    if (res.ok) similarUsers = await res.json();
    renderSimilarContacts();
  } catch(e){}
}
</script>
<!-- Settings Section -->
<div id="settings-section" class="section-block hidden">
  <div class="max-w-5xl mx-auto flex flex-col gap-6 py-6">
    <!-- General Info -->
    <div class="bg-white rounded-lg shadow p-5 space-y-6">
      <h2 class="font-semibold text-xl mb-2">General information</h2>
      <form id="general-info-form" class="grid md:grid-cols-3 gap-4">
        <div>
          <label class="block text-sm font-medium mb-1">Your name*</label>
          <input type="text" name="fullname" id="settings-fullname" class="w-full border rounded-lg p-2 text-sm" placeholder="Ex. Bonnie Green" required />
        </div>
        <div>
          <label class="block text-sm font-medium mb-1">Full address*</label>
          <input type="text" name="address" id="settings-address" class="w-full border rounded-lg p-2 text-sm" placeholder="174 Cayuga Ave, San Francisco, CA 9411" required />
        </div>
        <div>
          <label class="block text-sm font-medium mb-1">Biography</label>
          <textarea name="bio" id="settings-bio" class="w-full border rounded-lg p-2 text-sm h-10 min-h-[40px] max-h-32" placeholder="Hello, my name is Bonnie Green..."></textarea>
        </div>
        <div>
          <label class="block text-sm font-medium mb-1">ZIP/Postal code</label>
          <input type="text" name="zip" id="settings-zip" class="w-full border rounded-lg p-2 text-sm" placeholder="Ex. 123456" />
        </div>
        <div>
          <label class="block text-sm font-medium mb-1">Your institution</label>
          <input type="text" name="institution" id="settings-institution" class="w-full border rounded-lg p-2 text-sm" placeholder="Ex. OAU, UI..." />
        </div>
        <div>
          <label class="block text-sm font-medium mb-1">Country*</label>
          <input type="text" name="country" id="settings-country" class="w-full border rounded-lg p-2 text-sm" placeholder="Nigeria" required />
        </div>
        <div>
          <label class="block text-sm font-medium mb-1">Town/City*</label>
          <input type="text" name="city" id="settings-city" class="w-full border rounded-lg p-2 text-sm" placeholder="Ex. Ile-Ife" required />
        </div>
        <div>
          <label class="block text-sm font-medium mb-1">Department</label>
          <input type="text" name="department" id="settings-department" class="w-full border rounded-lg p-2 text-sm" placeholder="e.g. Computer Science" />
        </div>
        <div>
          <label class="block text-sm font-medium mb-1">Account Type <span class="text-gray-400" title="E.g., Admin, Student, Teacher">?</span></label>
          <select name="role" id="settings-role" class="w-full border rounded-lg p-2 text-sm" required>
            <option value="">Choose your account type</option>
            <option value="student">Student</option>
            <option value="tutor">Tutor</option>
            <option value="blogger">Blogger</option>
            <option value="admin">Admin</option>
            <option value="superadmin">SuperAdmin</option>
          </select>
        </div>
        <div>
          <label class="block text-sm font-medium mb-1">Phone</label>
          <input type="text" name="phone" id="settings-phone" class="w-full border rounded-lg p-2 text-sm" placeholder="e.g. 08031223344" />
        </div>
        <div>
          <label class="block text-sm font-medium mb-1">Level</label>
          <input type="text" name="level" id="settings-level" class="w-full border rounded-lg p-2 text-sm" placeholder="e.g. 100, 200, 300" />
        </div>
        <div>
          <label class="block text-sm font-medium mb-1">Faculty</label>
          <input type="text" name="faculty" id="settings-faculty" class="w-full border rounded-lg p-2 text-sm" placeholder="e.g. Science" />
        </div>
        <div>
          <label class="block text-sm font-medium mb-1">Religion</label>
          <input type="text" name="religion" id="settings-religion" class="w-full border rounded-lg p-2 text-sm" placeholder="Religion" />
        </div>
        <div>
          <label class="block text-sm font-medium mb-1">Student ID</label>
          <input type="text" name="studentId" id="settings-studentId" class="w-full border rounded-lg p-2 text-sm" disabled placeholder="Auto Generated" />
        </div>
      </form>
      <button type="submit" form="general-info-form" id="save-general-btn" class="bg-blue-700 text-white mt-2 px-6 py-2 rounded font-semibold hover:bg-blue-800">Save changes</button>
      <div id="general-info-msg" class="text-sm mt-2"></div>
    </div>
    <!-- Social -->
    <div class="bg-white rounded-lg shadow p-5 space-y-4">
      <div class="text-xl font-semibold mb-1">Social</div>
      <form id="social-form" class="grid md:grid-cols-2 gap-4">
        <div>
          <label class="text-sm font-medium">Facebook</label>
          <input type="text" name="facebook" id="settings-facebook" class="w-full border rounded-lg p-2 text-sm" placeholder="Enter your facebook account"/>
        </div>
        <div>
          <label class="text-sm font-medium">Twitter</label>
          <input type="text" name="twitter" id="settings-twitter" class="w-full border rounded-lg p-2 text-sm" placeholder="Enter your twitter account"/>
        </div>
        <div>
          <label class="text-sm font-medium">Instagram</label>
          <input type="text" name="instagram" id="settings-instagram" class="w-full border rounded-lg p-2 text-sm" placeholder="Enter your instagram account"/>
        </div>
        <div>
          <label class="text-sm font-medium">TikTok</label>
          <input type="text" name="tiktok" id="settings-tiktok" class="w-full border rounded-lg p-2 text-sm" placeholder="Enter your tiktok account"/>
        </div>
        <div>
          <label class="text-sm font-medium">Github</label>
          <input type="text" name="github" id="settings-github" class="w-full border rounded-lg p-2 text-sm" placeholder="Enter your github account"/>
        </div>
        <div>
          <label class="text-sm font-medium">Behance</label>
          <input type="text" name="behance" id="settings-behance" class="w-full border rounded-lg p-2 text-sm" placeholder="Enter your behance account"/>
        </div>
        <div>
          <label class="text-sm font-medium">Pinterest</label>
          <input type="text" name="pinterest" id="settings-pinterest" class="w-full border rounded-lg p-2 text-sm" placeholder="Enter your pinterest account"/>
        </div>
        <div>
          <label class="text-sm font-medium">Dribbble</label>
          <input type="text" name="dribbble" id="settings-dribbble" class="w-full border rounded-lg p-2 text-sm" placeholder="Enter your dribbble account"/>
        </div>
      </form>
      <button type="submit" form="social-form" id="save-social-btn" class="bg-blue-700 text-white mt-2 px-6 py-2 rounded font-semibold hover:bg-blue-800">Save changes</button>
      <div id="social-info-msg" class="text-sm mt-2"></div>
    </div>
    <!-- Password -->
    <div class="bg-white rounded-lg shadow p-5 space-y-4">
      <div class="text-xl font-semibold mb-1">Password</div>
      <form id="password-form" class="grid md:grid-cols-2 gap-6">
        <div class="space-y-3">
          <label class="block text-sm font-medium mb-1">Current password</label>
          <input type="password" name="currentPassword" id="settings-current-password" class="w-full border rounded-lg p-2 text-sm" placeholder="Enter your current password" required/>
          <label class="block text-sm font-medium mb-1">Your new password</label>
          <input type="password" name="newPassword" id="settings-new-password" class="w-full border rounded-lg p-2 text-sm" placeholder="Enter your new password" required/>
          <label class="block text-sm font-medium mb-1">Confirm new password</label>
          <input type="password" name="confirmPassword" id="settings-confirm-password" class="w-full border rounded-lg p-2 text-sm" placeholder="Confirm new password" required/>
          <button type="submit" class="bg-blue-700 text-white mt-1 px-6 py-2 rounded font-semibold hover:bg-blue-800">Save changes</button>
          <div id="password-msg" class="text-sm mt-2"></div>
        </div>
        <div class="bg-gray-50 rounded-lg p-4 text-sm">
          <div class="font-semibold mb-1">Password requirements:</div>
          <ul class="space-y-1">
            <li class="flex items-center gap-2 text-green-600"><span class="text-xl">â—</span>At least 10 characters (and up to 100 characters)</li>
            <li class="flex items-center gap-2 text-green-600"><span class="text-xl">â—</span>At least one lowercase character</li>
            <li class="flex items-center gap-2 text-green-600"><span class="text-xl">â—</span>Inclusion of at least one special character, e.g., ! @ # ?</li>
            <li class="flex items-center gap-2 text-gray-400"><span class="text-xl">â—</span>Significantly different from your previous passwords</li>
          </ul>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
const apiBase = "https://examguide.onrender.com/api";
function getToken() {
  return localStorage.getItem("token") || sessionStorage.getItem("token");
}
function setMsg(id, msg, isError) {
  const el = document.getElementById(id);
  if (!el) return;
  el.textContent = msg || "";
  el.style.color = isError ? "#b91c1c" : "#047857";
}
async function fetchProfile() {
  try {
    const resp = await fetch(apiBase+"/auth/me", {
      headers: { Authorization: "Bearer "+getToken() }
    });
    const { user } = await resp.json();
    // General:
    if (user) {
      document.getElementById("settings-fullname").value = user.fullname||"";
      document.getElementById("settings-institution").value = user.institution||"";
      document.getElementById("settings-country").value = user.country||"";
      document.getElementById("settings-city").value = user.location||"";
      document.getElementById("settings-phone").value = user.phone||"";
      document.getElementById("settings-level").value = user.level||"";
      document.getElementById("settings-department").value = (user.department && user.department.name) || user.department || "";
      document.getElementById("settings-faculty").value = (user.faculty && user.faculty.name) || user.faculty || "";
      document.getElementById("settings-role").value = user.role||"";
      document.getElementById("settings-religion").value = user.religion||"";
      document.getElementById("settings-studentId").value = user.studentId||"";
      // Address/ZIP/Bio: extend as needed for your schema
      document.getElementById("settings-address").value = user.address||"";
      document.getElementById("settings-zip").value = user.zip||"";
      document.getElementById("settings-bio").value = user.bio||"";

      // Social: assuming a user.social object (update as appropriate)
      document.getElementById("settings-facebook").value   = user.social?.facebook||"";
      document.getElementById("settings-twitter").value    = user.social?.twitter||"";
      document.getElementById("settings-instagram").value  = user.social?.instagram||"";
      document.getElementById("settings-tiktok").value     = user.social?.tiktok||"";
      document.getElementById("settings-github").value     = user.social?.github||"";
      document.getElementById("settings-behance").value    = user.social?.behance||"";
      document.getElementById("settings-pinterest").value  = user.social?.pinterest||"";
      document.getElementById("settings-dribbble").value   = user.social?.dribbble||"";
    }
  } catch (e) {
    setMsg("general-info-msg", "Could not load profile", true);
  }
}
fetchProfile();

// --- General info form
document.getElementById("general-info-form").onsubmit = async function(e) {
  e.preventDefault();
  setMsg("general-info-msg", "Saving...", false);
  const payload = {
    fullname: document.getElementById("settings-fullname").value,
    institution: document.getElementById("settings-institution").value,
    country: document.getElementById("settings-country").value,
    location: document.getElementById("settings-city").value,
    phone: document.getElementById("settings-phone").value,
    level: document.getElementById("settings-level").value,
    department: document.getElementById("settings-department").value,
    faculty: document.getElementById("settings-faculty").value,
    role: document.getElementById("settings-role").value,
    religion: document.getElementById("settings-religion").value,
    address: document.getElementById("settings-address").value,
    zip: document.getElementById("settings-zip").value,
    bio: document.getElementById("settings-bio").value
  };
  try {
    const resp = await fetch(apiBase+"/auth/me", {
      method: "PATCH",
      headers: {
        "Content-Type": "application/json",
        Authorization: "Bearer "+getToken()
      },
      body: JSON.stringify(payload)
    });
    if (resp.ok) {
      setMsg("general-info-msg", "Profile updated successfully.");
      await fetchProfile();
    } else {
      const data = await resp.json();
      setMsg("general-info-msg", data.message || "Update failed", true);
    }
  } catch (e) {
    setMsg("general-info-msg", "Error updating profile", true);
  }
};

// --- Social info form ---
document.getElementById("social-form").onsubmit = async function(e) {
  e.preventDefault();
  setMsg("social-info-msg", "Saving...", false);
  const payload = {
    social: {
      facebook: document.getElementById("settings-facebook").value,
      twitter: document.getElementById("settings-twitter").value,
      instagram: document.getElementById("settings-instagram").value,
      tiktok: document.getElementById("settings-tiktok").value,
      github: document.getElementById("settings-github").value,
      behance: document.getElementById("settings-behance").value,
      pinterest: document.getElementById("settings-pinterest").value,
      dribbble: document.getElementById("settings-dribbble").value
    }
  };
  try {
    const resp = await fetch(apiBase+"/auth/me", {
      method: "PATCH",
      headers: {
        "Content-Type": "application/json",
        Authorization: "Bearer "+getToken()
      },
      body: JSON.stringify(payload)
    });
    if (resp.ok) {
      setMsg("social-info-msg", "Social info updated.");
      await fetchProfile();
    } else {
      const data = await resp.json();
      setMsg("social-info-msg", data.message || "Update failed", true);
    }
  } catch (e) {
    setMsg("social-info-msg", "Error updating social info", true);
  }
};

// --- Password form
document.getElementById("password-form").onsubmit = async function(e) {
  e.preventDefault();
  setMsg("password-msg", "", false);
  const current = document.getElementById("settings-current-password").value;
  const next = document.getElementById("settings-new-password").value;
  const confirm = document.getElementById("settings-confirm-password").value;

  if (next !== confirm) {
    setMsg("password-msg", "Passwords do not match", true);
    return;
  }
  try {
    setMsg("password-msg", "Saving...", false);
    const resp = await fetch(apiBase+"/auth/change-password", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        Authorization: "Bearer "+getToken()
      },
      body: JSON.stringify({
        currentPassword: current,
        newPassword: next
      })
    });
    const data = await resp.json();
    if (resp.ok) {
      setMsg("password-msg", data.message || "Password changed.");
      document.getElementById("settings-current-password").value = "";
      document.getElementById("settings-new-password").value = "";
      document.getElementById("settings-confirm-password").value = "";
    } else {
      setMsg("password-msg", data.message || "Failed to change password", true);
    }
  } catch (e) {
    setMsg("password-msg", "Error changing password", true);
  }
};
</script>
        <!-- Other section blocks remain unchanged, and are hidden unless selected -->
      </main>
    </div>
  </div>

  <script>

let student = null;
    async function fetchStudentProfile() {
  try {
    // Update with your actual API endpoint
    const resp = await fetch('https://examguide.onrender.com/api/auth/me', { credentials: 'include' });
    const data = await resp.json();
    student = data.user; // Adapt if your response shape differs
    updateHeaderProfilePic(student);
    populateUserDetails();
    // Any additional UI functions needing student
  } catch (err) {
    console.error('Failed to fetch student', err);
    // Optionally show error message or fallback UI
  }
}
          // Section show/hide
    function toggleMobileDrawer(show) {
      const sidebar = document.getElementById('mobileSidebar');
      const overlay = document.getElementById('mobileDrawerOverlay');
      if (show) {
        sidebar.classList.remove('-translate-x-full');
        overlay.classList.remove('hidden');
      } else {
        sidebar.classList.add('-translate-x-full');
        overlay.classList.add('hidden');
      }
    }
    function switchSection(section, isMobile) {
      if(isMobile) toggleMobileDrawer(false);
      document.querySelectorAll('.section-block').forEach(s => s.classList.add('hidden'));
      if(document.getElementById(section + '-section'))
        document.getElementById(section + '-section').classList.remove('hidden');
      const allLists = [document.getElementById('desktopSidebarList'), document.querySelector('aside#mobileSidebar nav ul')];
      allLists.forEach(list => {
        if (!list) return;
        Array.from(list.children).forEach((li, i) => {
          if (li.querySelector('.sidebar-btn')) {
            const sectionsOrder = ['overview','mocktests','pastquestions','taskscenter','resources','messages','profile','assignments','studyPadi','broadcasts','settings','logout'];
            if(i===sectionsOrder.indexOf(section)) {
              li.querySelector('.sidebar-btn').classList.add('sidebar-active');
            } else {
              li.querySelector('.sidebar-btn').classList.remove('sidebar-active');
            }
          }
        });
      });
    }
    document.getElementById('profileDropdownBtn').addEventListener('click', function(e) {
      e.stopPropagation();
      document.getElementById('profileDropdown').classList.toggle('hidden');
    });
    document.getElementById('notifBtn').addEventListener('click', function(e){
      alert('You have 2 new notifications!');
    });
    window.addEventListener('click', function(e){
      if (!document.getElementById('profileDropdownBtn').contains(e.target)) {
        document.getElementById('profileDropdown').classList.add('hidden');
      }
    });

    // Motivation Quotes
    const motivations = [
      "You are capable of amazing things.",
      "Donâ€™t watch the clock; do what it does. Keep going.",
      "Success is not for the lazy.",
      "Stay positive, work hard, make it happen.",
      "Mistakes are proof that you are trying.",
      "Push yourself, because no one else is going to do it for you.",
      "Believe you can and youâ€™re halfway there.",
      "Small steps every day!",
      "Your only limit is your mind.",
      "Dream big, work hard, stay focused."
    ];
    function randomMotivation() {
      const msg = motivations[Math.floor(Math.random()*motivations.length)];
      document.getElementById('motivation-message').textContent = msg;
    }
    // Auto refresh motivational quote every 5 seconds
    setInterval(randomMotivation, 5000);

    // === Fetch CURRENT USER details from backend ===
    const API_BASE_URL = "https://examguide.onrender.com";
    async function fetchCurrentUser() {
      try {
        const token = localStorage.getItem("token");
        if (!token) return null;
        const res = await fetch(`${API_BASE_URL}/api/auth/me`, {
          method: "GET",
          headers: { "Authorization": `Bearer ${token}` },
          credentials: "include"
        });
        if (!res.ok) throw new Error("Failed to fetch user");
        const data = await res.json();
        return data.user;
      } catch (err) {
        console.error("Error fetching user:", err);
        return null;
      }
    }
    // Update dashboard UI with user info
    async function populateUserDetails() {
      const user = await fetchCurrentUser();
      if (!user) return;
      // Welcome message
      document.querySelectorAll('h2.text-2xl.font-bold.mb-1').forEach(el => {
        el.textContent = `Welcome back, ${user.fullname || user.username || 'Student'}!`;
      });
      // Profile photo (dashboard + profile section)
     const img = document.getElementById("headerProfilePic");
if (img) img.src = getProfilePicUrl(student);
      // Email
      const emailInput = document.querySelector("input[type='email']");
      if (emailInput && user.email) emailInput.value = user.email;
      const emailLink = document.querySelector("a[href^='mailto:']");
      if (emailLink && user.email) {
        emailLink.textContent = user.email;
        emailLink.href = `mailto:${user.email}`;
      }
      // Name, phone, department, etc. (update if available)
      if (document.querySelector("input[type='text'][value='Alex Student']") && user.fullname)
        document.querySelector("input[type='text'][value='Alex Student']").value = user.fullname;
      if (document.querySelector("input[type='text'][value='+2348012345678']") && user.phone)
        document.querySelector("input[type='text'][value='+2348012345678']").value = user.phone;
      if (document.querySelector("input[type='text'][value='Computer Science']") && user.department)
        document.querySelector("input[type='text'][value='Computer Science']").value = user.department;
    }

    document.addEventListener('DOMContentLoaded', function() {
      switchSection('overview');
      populateUserDetails();
      

      const gpaCtx = document.getElementById('gpaChart').getContext('2d');
      window.gpaChart = new Chart(gpaCtx, {
        type: 'line',
        data: {
          labels: ['Year 1', 'Year 2', 'Year 3', 'Year 4'],
          datasets: [{
            label: 'GPA',
            data: [3.2, 3.45, 3.67, 3.8],
            borderColor: '#2563eb',
            backgroundColor: 'rgba(37,99,235,0.1)',
            borderWidth: 3,
            pointRadius: 4,
            tension: 0.3,
            fill: true
          }]
        },
        options: {
          scales: { y: { beginAtZero: false, min:2.0, max:4.0 } },
          plugins: { legend: { display: false } }
        }
      });

      randomMotivation();
    });

document.addEventListener("DOMContentLoaded", function() {
  const API_URL = "https://examguide.onrender.com/api/";
  const token = localStorage.getItem("token");
  function fetchTopScorers() {
    fetch(API_URL + "results/leaderboard/top", {
      headers: { Authorization: "Bearer " + token }
    })
    .then(resp => resp.json())
    .then(data => {
      let html = "";
      if (Array.isArray(data) && data.length > 0) {
        html = data.slice(0, 3).map((stu, idx) => `
          <div class="flex items-center gap-3">
            <img src="${stu.profilePic || `https://ui-avatars.com/api/?name=${encodeURIComponent(stu.fullname||stu.username)}&background=3a86ff&color=fff&rounded=true`}" class="w-10 h-10 rounded-full border-2 border-indigo-400 shadow" alt="${stu.fullname}">
            <span class="text-base font-semibold text-indigo-900 flex-1">${stu.fullname || stu.username}</span>
            <span class="text-sm font-bold text-indigo-600">${stu.totalScore} pts</span>
            <span class="ml-2 text-xl">${['ðŸ¥‡','ðŸ¥ˆ','ðŸ¥‰'][idx]||''}</span>
          </div>
        `).join('');
      } else {
        html = `<div style="text-align:center;color:#888;">No leaderboard data yet.</div>`;
      }
      document.getElementById("topScorersList").innerHTML = html;
    }).catch(() => {
      document.getElementById("topScorersList").innerHTML = `<div style="text-align:center;color:#f25f5c;">Failed to load top scorers!</div>`;
    });
  }
  fetchTopScorers();
});
    // example usage in HTML/JS
document.getElementById('profileImage').src = getProfilePicUrl(student);
// getProfilePicUrl implements the logic above
</script>
</body>
</html>
