<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>OAU ExamGuard | Admin Dashboard</title>
  <link rel="icon" href="logo.png"/>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet"/>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/flowbite/2.3.0/flowbite.min.css" rel="stylesheet"/>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/flowbite/2.3.0/flowbite.min.js"></script>
  <style>
    .sidebar {
      transition: transform .3s;
    }
    .sidebar.open {
      transform: translateX(0);
    }
    .loader {
      display: inline-block;
      width: 42px;
      height: 42px;
      border: 5px solid #e0e7ff;
      border-top: 5px solid #6366f1;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    @keyframes spin { 100% { transform: rotate(360deg);} }
    .toast {
      position: fixed;
      bottom: 1.5rem;
      right: 1.5rem;
      z-index: 99999;
      min-width: 220px;
      background: #fff;
      border-radius: 1em;
      padding: 1em 1.5em;
      box-shadow: 0 2px 16px #6366f133;
      color: #232323;
      font-weight: 600;
      display: none;
      align-items: center;
      gap: 10px;
      animation: fadeIn .5s;
    }
    @keyframes fadeIn {
      from {opacity:0;transform:translateY(20px);}
      to {opacity:1;transform:translateY(0);}
    }
    .toast.success { border-left: 6px solid #22c55e;}
    .toast.error { border-left: 6px solid #ef4444;}
    .toast.info { border-left: 6px solid #2563eb;}
    .modal-backdrop {
      position: fixed; inset: 0; z-index: 9999;
      background: rgba(24,41,89,0.12); display: none; align-items:center; justify-content:center;
    }
    .modal-backdrop.show { display: flex !important;}
    .modal-content {
      background: #fff; border-radius: 1.2em; box-shadow: 0 8px 32px #0003;
      max-width: 99vw; min-width: 320px; padding: 2em 1.5em; position: relative;
      max-height: 89vh; overflow-y: auto; animation: fadeIn .4s;
    }
    .modal-close { position: absolute; right: 1em; top: 0.7em; color: #6366f1; font-size: 1.8em; cursor:pointer;}
    @media (max-width: 700px) {
      .sidebar { width: 90vw;}
      .main-content { padding-left: 0;}
    }
  </style>
</head>
<body class="bg-gradient-to-br from-indigo-50 to-white min-h-screen font-sans transition-colors">
  <!-- Loader -->
  <div id="globalLoader" style="display:none;position:fixed;z-index:999999;top:0;left:0;width:100vw;height:100vh;background:rgba(255,255,255,0.96);align-items:center;justify-content:center;">
    <div style="text-align:center;">
      <div class="loader"></div>
      <div style="margin-top:14px;color:#6366f1;font-weight:700;font-size:1.15em;">Loading...</div>
    </div>
  </div>
<aside id="sidebar" class="sidebar fixed top-0 left-0 h-screen w-72 bg-gradient-to-br from-blue-900 to-indigo-600 text-white p-7 shadow-2xl z-40 -translate-x-full md:translate-x-0 transition-transform duration-300">
 <div class="mb-12">
      <h1 class="text-3xl font-extrabold tracking-tight">ExamGuard Admin</h1>
      <p class="text-sm text-indigo-200">Dashboard</p>
    </div>
    <nav>
      <ul class="space-y-7">
        <li><a href="#" class="flex items-center gap-3 text-lg hover:text-yellow-400 transition-colors font-bold" data-tab="overview"><i class="fas fa-home"></i>Overview</a></li>
        <li><a href="#" class="flex items-center gap-3 text-lg hover:text-yellow-400 transition-colors font-bold" data-tab="faculties"><i class="fas fa-university"></i>Faculties</a></li>
        <li><a href="#" class="flex items-center gap-3 text-lg hover:text-yellow-400 transition-colors font-bold" data-tab="departments"><i class="fas fa-building"></i>Departments</a></li>
        <li><a href="#" class="flex items-center gap-3 text-lg hover:text-yellow-400 transition-colors font-bold" data-tab="users"><i class="fas fa-users"></i>Users</a></li>
        <li><a href="#" class="flex items-center gap-3 text-lg hover:text-yellow-400 transition-colors font-bold" data-tab="courses"><i class="fas fa-book"></i>Courses</a></li>
        <li><a href="#" class="flex items-center gap-3 text-lg hover:text-yellow-400 transition-colors font-bold" data-tab="settings"><i class="fas fa-cogs"></i>Settings</a></li>
      </ul>
    </nav>
  </aside>
  <!-- Sidebar overlay mobile -->
  <div id="sidebar-overlay" class="fixed inset-0 bg-black bg-opacity-40 z-30 hidden"></div>
  <!-- Mobile Menu Button -->
  <button id="menu-toggle" class="md:hidden fixed top-4 left-4 z-50 p-3 bg-indigo-600 text-white rounded-full shadow-lg hover:bg-indigo-700" aria-label="Open Menu">
    <i class="fas fa-bars text-lg"></i>
  </button>
  <!-- Main Content -->
  <main class="main-content max-w-7xl mx-auto p-4 md:ml-72 md:p-8 lg:p-12 min-h-screen">
    <!-- Overview Tab -->
    <section id="overview" class="tab-content active">
      <header class="bg-white rounded-2xl shadow-xl p-8 mb-8 flex items-center justify-between card relative">
        <div>
          <h2 class="text-3xl font-bold text-indigo-900 mb-2">Welcome, Admin</h2>
          <div class="text-gray-700 text-base">Manage faculties, departments, users, and courses efficiently from this dashboard.</div>
        </div>
        <div class="text-indigo-600 text-4xl"><i class="fas fa-user-shield"></i></div>
      </header>
      <div class="grid grid-cols-1 md:grid-cols-3 gap-8 mb-8">
        <div class="bg-white rounded-2xl shadow-xl p-6 card flex flex-col items-center">
          <div class="text-3xl text-indigo-600 mb-2"><i class="fas fa-university"></i></div>
          <div class="font-bold text-lg" id="overviewFacultyCount">--</div>
          <div class="text-gray-600">Faculties</div>
        </div>
        <div class="bg-white rounded-2xl shadow-xl p-6 card flex flex-col items-center">
          <div class="text-3xl text-indigo-600 mb-2"><i class="fas fa-building"></i></div>
          <div class="font-bold text-lg" id="overviewDeptCount">--</div>
          <div class="text-gray-600">Departments</div>
        </div>
        <div class="bg-white rounded-2xl shadow-xl p-6 card flex flex-col items-center">
          <div class="text-3xl text-indigo-600 mb-2"><i class="fas fa-users"></i></div>
          <div class="font-bold text-lg" id="overviewUserCount">--</div>
          <div class="text-gray-600">Users</div>
        </div>
      </div>
      <div class="bg-white rounded-2xl shadow-xl p-6 card mb-10">
        <h3 class="text-xl font-semibold text-indigo-900 mb-4">Quick Actions</h3>
        <div class="flex flex-wrap gap-4">
          <button class="px-5 py-3 bg-indigo-600 text-white rounded-lg shadow hover:bg-yellow-400 hover:text-indigo-900 font-bold transition" onclick="showModal('addFacultyModal')"><i class="fas fa-plus mr-2"></i>Add Faculty</button>
          <button class="px-5 py-3 bg-indigo-600 text-white rounded-lg shadow hover:bg-yellow-400 hover:text-indigo-900 font-bold transition" onclick="showModal('addDeptModal')"><i class="fas fa-plus mr-2"></i>Add Department</button>
        </div>
      </div>
    </section>
    <!-- Faculties Tab -->
    <section id="faculties" class="tab-content">
      <header class="bg-white rounded-2xl shadow-xl p-7 mb-7 flex items-center justify-between card relative">
        <div>
          <h2 class="text-2xl font-bold text-blue-900 mb-2">Faculties</h2>
          <div class="text-gray-600">Manage all faculties in the institution.</div>
        </div>
      </header>
      <div id="facultyList" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
        <!-- Faculties will be loaded here -->
      </div>
      <div class="mt-6 flex gap-4">
        <button class="px-5 py-3 bg-indigo-600 text-white rounded-lg shadow hover:bg-yellow-400 hover:text-indigo-900 font-bold transition" onclick="showModal('addFacultyModal')"><i class="fas fa-plus mr-2"></i>Add Faculty</button>
      </div>
    </section>
    <!-- Departments Tab -->
    <section id="departments" class="tab-content">
      <header class="bg-white rounded-2xl shadow-xl p-7 mb-7 flex items-center justify-between card relative">
        <div>
          <h2 class="text-2xl font-bold text-blue-900 mb-2">Departments</h2>
          <div class="text-gray-600">Manage all departments. Edit department images, subtitles, and courses.</div>
        </div>
      </header>
      <div id="deptList" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
        <!-- Departments will be loaded here -->
      </div>
      <div class="mt-6 flex gap-4">
        <button class="px-5 py-3 bg-indigo-600 text-white rounded-lg shadow hover:bg-yellow-400 hover:text-indigo-900 font-bold transition" onclick="showModal('addDeptModal')"><i class="fas fa-plus mr-2"></i>Add Department</button>
      </div>
    </section>
    <!-- Users Tab -->
    <section id="users" class="tab-content">
      <header class="bg-white rounded-2xl shadow-xl p-7 mb-7 flex items-center justify-between card relative">
        <div>
          <h2 class="text-2xl font-bold text-blue-900 mb-2">Users</h2>
          <div class="text-gray-600">Manage registered users. Search, filter, and view user details.</div>
        </div>
      </header>
      <div class="mb-4 flex flex-wrap gap-3">
        <input type="text" id="userSearchInput" class="rounded-lg border border-indigo-300 px-4 py-2 w-full max-w-xs" placeholder="Search by name, username, or email..."/>
        <button class="px-4 py-2 bg-indigo-600 text-white rounded-lg shadow hover:bg-yellow-400 hover:text-indigo-900 font-bold transition" onclick="searchUsers()">Search</button>
      </div>
      <div id="usersList" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
        <!-- Users loaded here -->
      </div>
    </section>
    <!-- Courses Tab -->
    <section id="courses" class="tab-content">
      <header class="bg-white rounded-2xl shadow-xl p-7 mb-7 flex items-center justify-between card relative">
        <div>
          <h2 class="text-2xl font-bold text-blue-900 mb-2">Courses</h2>
          <div class="text-gray-600">View, edit, and manage courses attached to departments.</div>
        </div>
      </header>
      <div id="coursesList" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
        <!-- Courses loaded here -->
      </div>
    </section>
    <!-- Settings Tab -->
    <section id="settings" class="tab-content">
      <header class="bg-white rounded-2xl shadow-xl p-7 mb-7 flex items-center justify-between card relative">
        <div>
          <h2 class="text-2xl font-bold text-blue-900 mb-2">Settings</h2>
          <div class="text-gray-600">Application and admin settings.</div>
        </div>
      </header>
      <div class="bg-white rounded-2xl shadow-xl p-7">
        <div class="text-indigo-700 mb-4 font-bold">Admin Profile & Security</div>
        <form id="adminProfileForm" class="space-y-4 max-w-xl">
          <div>
            <label for="adminName" class="block mb-1 font-semibold text-gray-700">Name</label>
            <input id="adminName" class="w-full border border-indigo-200 rounded-lg px-4 py-2" placeholder="Your Name"/>
          </div>
          <div>
            <label for="adminEmail" class="block mb-1 font-semibold text-gray-700">Email</label>
            <input id="adminEmail" type="email" class="w-full border border-indigo-200 rounded-lg px-4 py-2" placeholder="Your Email"/>
          </div>
          <div>
            <label for="adminPassword" class="block mb-1 font-semibold text-gray-700">New Password</label>
            <input id="adminPassword" type="password" class="w-full border border-indigo-200 rounded-lg px-4 py-2" placeholder="••••••••••"/>
          </div>
          <button type="submit" class="px-5 py-2 bg-indigo-600 text-white rounded-lg font-bold shadow hover:bg-yellow-400 hover:text-indigo-900 transition">Update Profile</button>
        </form>
      </div>
    </section>
  </main>
  <!-- Add/Edit Faculty Modal -->
  <div id="addFacultyModal" class="modal-backdrop">
    <div class="modal-content">
      <button class="modal-close" onclick="hideModal('addFacultyModal')">&times;</button>
      <h2 class="font-bold text-xl mb-3 text-indigo-700">Add New Faculty</h2>
      <form id="facultyForm" class="space-y-4">
        <div>
          <label for="facultyName" class="block mb-1 font-semibold text-gray-700">Faculty Name</label>
          <input id="facultyName" required class="w-full border border-indigo-200 rounded-lg px-4 py-2" placeholder="Faculty Name"/>
        </div>
        <button type="submit" class="px-5 py-2 bg-indigo-600 text-white rounded-lg font-bold shadow hover:bg-yellow-400 hover:text-indigo-900 transition">Add Faculty</button>
      </form>
    </div>
  </div>
  <!-- Add/Edit Department Modal -->
  <div id="addDeptModal" class="modal-backdrop">
    <div class="modal-content">
      <button class="modal-close" onclick="hideModal('addDeptModal')">&times;</button>
      <h2 class="font-bold text-xl mb-3 text-indigo-700">Add New Department</h2>
      <form id="deptForm" class="space-y-4">
        <div>
          <label for="deptName" class="block mb-1 font-semibold text-gray-700">Department Name</label>
          <input id="deptName" required class="w-full border border-indigo-200 rounded-lg px-4 py-2" placeholder="Department Name"/>
        </div>
        <div>
          <label for="deptFaculty" class="block mb-1 font-semibold text-gray-700">Faculty</label>
          <select id="deptFaculty" required class="w-full border border-indigo-200 rounded-lg px-4 py-2">
            <!-- Faculties loaded dynamically -->
          </select>
        </div>
        <div>
          <label for="deptSubtitle" class="block mb-1 font-semibold text-gray-700">Subtitle</label>
          <input id="deptSubtitle" class="w-full border border-indigo-200 rounded-lg px-4 py-2" placeholder="E.g. Life Sciences"/>
        </div>
        <div>
          <label for="deptImage" class="block mb-1 font-semibold text-gray-700">Background Image</label>
          <input id="deptImage" type="file" accept="image/*" class="w-full px-2 py-1 border border-indigo-200 rounded-lg"/>
        </div>
        <button type="submit" class="px-5 py-2 bg-indigo-600 text-white rounded-lg font-bold shadow hover:bg-yellow-400 hover:text-indigo-900 transition">Add Department</button>
      </form>
    </div>
  </div>
  <!-- Edit Courses Modal -->
  <div id="editCoursesModal" class="modal-backdrop">
    <div class="modal-content">
      <button class="modal-close" onclick="hideModal('editCoursesModal')">&times;</button>
      <h2 class="font-bold text-xl mb-3 text-indigo-700">Edit Department Courses</h2>
      <form id="coursesForm" class="space-y-4">
        <div>
          <label for="courseInput" class="block mb-1 font-semibold text-gray-700">Add Course</label>
          <input id="courseInput" class="w-full border border-indigo-200 rounded-lg px-4 py-2 mb-2" placeholder="e.g. BCH101 - Introduction to Biochemistry"/>
          <button type="button" class="px-4 py-2 bg-indigo-600 text-white rounded-lg font-bold shadow hover:bg-yellow-400 hover:text-indigo-900 transition" onclick="addCourseToList()">Add</button>
        </div>
        <div id="coursesListEditable" class="mb-4 flex flex-wrap gap-2"></div>
        <button type="submit" class="px-5 py-2 bg-indigo-600 text-white rounded-lg font-bold shadow hover:bg-yellow-400 hover:text-indigo-900 transition">Save Courses</button>
      </form>
    </div>
  </div>
  <!-- Toast/Feedback -->
  <div id="toast" class="toast"></div>
  <script>
// Show sidebar (mobile)
document.getElementById("menu-toggle").onclick = function() {
  document.getElementById("sidebar").classList.toggle("-translate-x-full");
  document.getElementById("sidebar-overlay").classList.toggle("hidden");
};
// Hide sidebar (mobile)
document.getElementById("sidebar-overlay").onclick = function() {
  document.getElementById("sidebar").classList.add("-translate-x-full");
  document.getElementById("sidebar-overlay").classList.add("hidden");
};
    // Tab navigation
    document.querySelectorAll(".sidebar a[data-tab]").forEach(link=>{
      link.onclick = function(e){
        e.preventDefault();
        document.querySelectorAll(".tab-content").forEach(tab=>tab.classList.remove("active"));
        document.getElementById(link.getAttribute("data-tab")).classList.add("active");
      };
    });
    // Modal logic
    function showModal(id) {
      document.getElementById(id).classList.add("show");
    }
    function hideModal(id) {
      document.getElementById(id).classList.remove("show");
    }
    // Toast/Feedback
    function showToast(msg, type="info") {
      const toast = document.getElementById("toast");
      toast.textContent = msg;
      toast.className = "toast " + type;
      toast.style.display = "flex";
      setTimeout(()=>toast.style.display="none", 3200);
    }
    // Loader logic
    function showLoader() {document.getElementById("globalLoader").style.display="flex";}
    function hideLoader() {document.getElementById("globalLoader").style.display="none";}

    // ---- Faculty CRUD ----
    async function getFaculties() {
      showLoader();
      try {
        const res = await fetch('/api/faculties');
        const faculties = await res.json();
        // Overview count
        document.getElementById("overviewFacultyCount").textContent = faculties.length;
        // Faculties tab
        const facultyList = document.getElementById("facultyList");
        facultyList.innerHTML = "";
        faculties.forEach(f=>{
          facultyList.innerHTML += `
            <div class="bg-gradient-to-br from-blue-50 to-indigo-50 rounded-xl shadow p-6 flex flex-col gap-3">
              <div class="text-xl font-bold text-indigo-800 mb-1">${f.name}</div>
              <div class="text-gray-500 text-sm">ID: ${f._id}</div>
              <button class="mt-3 px-4 py-2 bg-red-500 text-white rounded font-bold hover:bg-red-700 transition" onclick="deleteFaculty('${f._id}')"><i class="fas fa-trash"></i> Delete</button>
            </div>
          `;
        });
        // Fill in faculties for department modal
        const deptFaculty = document.getElementById("deptFaculty");
        deptFaculty.innerHTML = faculties.map(f=>`<option value="${f._id}">${f.name}</option>`).join('');
      } catch(e){
        showToast("Error loading faculties!","error");
      }
      hideLoader();
    }
    document.getElementById("facultyForm").onsubmit = async function(e){
      e.preventDefault();
      showLoader();
      try {
        const name = document.getElementById("facultyName").value.trim();
        const res = await fetch("/api/faculties",{
          method:"POST",
          headers:{'Content-Type':'application/json'},
          body:JSON.stringify({name})
        });
        if(res.ok){
          showToast("Faculty added!","success");
          hideModal('addFacultyModal');
          getFaculties();
        }else{
          const err = await res.json();
          showToast(err.message || "Error!","error");
        }
      }catch(e){showToast("Could not add faculty!","error");}
      hideLoader();
    };
    async function deleteFaculty(id) {
      if(!confirm("Delete this faculty?")) return;
      showLoader();
      try {
        const res = await fetch(`/api/faculties/${id}`,{method:"DELETE"});
        if(res.ok){showToast("Faculty deleted!","success");getFaculties();}
        else{showToast("Error deleting faculty!","error");}
      }catch(e){showToast("Delete failed!", "error");}
      hideLoader();
    }

    // ---- Department CRUD ----
    async function getDepartments() {
      showLoader();
      try {
        const res = await fetch('/api/departments');
        const depts = await res.json();
        document.getElementById("overviewDeptCount").textContent = depts.length;
        // Departments tab
        const deptList = document.getElementById("deptList");
        deptList.innerHTML = "";
        depts.forEach(d=>{
          deptList.innerHTML += `
            <div class="bg-white rounded-xl shadow p-6 flex flex-col gap-3">
              <div class="flex gap-4 items-center">
                <img src="${d.backgroundImage||'https://placehold.co/80x80'}" class="w-16 h-16 object-cover rounded-lg border border-indigo-100"/>
                <div>
                  <div class="font-bold text-indigo-800 text-lg">${d.name}</div>
                  <div class="text-gray-500 text-sm mb-1">Faculty: ${d.faculty}</div>
                  <div class="text-gray-600 text-xs">${d.subtitle||''}</div>
                </div>
              </div>
              <div class="mt-2 flex gap-2 flex-wrap">
                <button class="px-3 py-2 bg-indigo-600 text-white rounded font-bold hover:bg-yellow-400 hover:text-indigo-800 transition" onclick="showEditDept('${d._id}')"><i class="fas fa-edit"></i> Edit</button>
                <button class="px-3 py-2 bg-blue-600 text-white rounded font-bold hover:bg-yellow-400 hover:text-blue-800 transition" onclick="showEditCourses('${d._id}')"><i class="fas fa-book"></i> Courses</button>
                <button class="px-3 py-2 bg-red-500 text-white rounded font-bold hover:bg-red-700 transition" onclick="deleteDept('${d._id}')"><i class="fas fa-trash"></i> Delete</button>
              </div>
            </div>
          `;
        });
      }catch(e){
        showToast("Error loading departments!","error");
      }
      hideLoader();
    }
    document.getElementById("deptForm").onsubmit = async function(e){
      e.preventDefault();
      showLoader();
      try {
        const name = document.getElementById("deptName").value.trim();
        const faculty = document.getElementById("deptFaculty").value;
        const subtitle = document.getElementById("deptSubtitle").value.trim();
        let backgroundImage = "";
        const fileInput = document.getElementById("deptImage");
        if(fileInput.files[0]){
          const formData = new FormData();
          formData.append("image", fileInput.files[0]);
          // Upload to /api/images (Cloudinary)
          const imgRes = await fetch("/api/images",{method:"POST",body:formData});
          const imgData = await imgRes.json();
          backgroundImage = imgData.url;
        }
        const res = await fetch("/api/departments",{
          method:"POST",
          headers:{'Content-Type':'application/json'},
          body:JSON.stringify({name, faculty, subtitle, backgroundImage})
        });
        if(res.ok){
          showToast("Department added!","success");
          hideModal('addDeptModal');
          getDepartments();
        }else{
          const err = await res.json();
          showToast(err.message || "Error!","error");
        }
      }catch(e){showToast("Could not add department!","error");}
      hideLoader();
    };
    async function deleteDept(id) {
      if(!confirm("Delete this department?")) return;
      showLoader();
      try {
        const res = await fetch(`/api/departments/${id}`,{method:"DELETE"});
        if(res.ok){showToast("Department deleted!","success");getDepartments();}
        else{showToast("Error deleting department!","error");}
      }catch(e){showToast("Delete failed!","error");}
      hideLoader();
    }
    // Edit department (example placeholder)
    function showEditDept(id) {
      // For demo: you can load dept info and open a modal for editing subtitle/image
      showToast("Edit department UI coming soon!","info");
    }

    // ---- Courses CRUD ----
    let editingDeptId = null;
    async function showEditCourses(id) {
      showLoader();
      editingDeptId = id;
      try {
        const res = await fetch(`/api/departments/${id}`);
        const dept = await res.json();
        document.getElementById("coursesListEditable").innerHTML = "";
        (dept.courses||[]).forEach(c=>{
          addCourseChip(c);
        });
        showModal('editCoursesModal');
      }catch(e){
        showToast("Error loading courses!","error");
      }
      hideLoader();
    }
    function addCourseChip(course) {
      const chip = document.createElement("span");
      chip.className = "bg-blue-50 text-indigo-700 px-3 py-1 rounded-lg font-semibold mr-2 mb-2 inline-flex items-center";
      chip.innerHTML = `<span>${course}</span> <button class="ml-2 text-red-500 font-bold" onclick="this.parentElement.remove()">×</button>`;
      document.getElementById("coursesListEditable").appendChild(chip);
    }
    function addCourseToList() {
      const input = document.getElementById("courseInput");
      const val = input.value.trim();
      if(val){
        addCourseChip(val);
        input.value = "";
      }
    }
    document.getElementById("coursesForm").onsubmit = async function(e){
      e.preventDefault();
      showLoader();
      // Collect all chips
      const chips = document.querySelectorAll("#coursesListEditable span");
      const courses = Array.from(chips).map(chip=>chip.querySelector("span").textContent.trim());
      try {
        const res = await fetch(`/api/departments/${editingDeptId}`,{
          method:"PATCH",
          headers:{'Content-Type':'application/json'},
          body:JSON.stringify({courses})
        });
        if(res.ok){
          showToast("Courses updated!","success");
          hideModal('editCoursesModal');
          getDepartments();
        }else{
          const err = await res.json();
          showToast(err.message || "Error!","error");
        }
      }catch(e){showToast("Could not update courses!","error");}
      hideLoader();
    };

    // ---- Users ----
    async function getUsers(query="") {
      showLoader();
      try {
        let url = "/api/users";
        if(query) url += "?search=" + encodeURIComponent(query);
        const res = await fetch(url);
        const users = await res.json();
        document.getElementById("overviewUserCount").textContent = users.length;
        const usersList = document.getElementById("usersList");
        usersList.innerHTML = "";
        users.forEach(u=>{
          usersList.innerHTML += `
            <div class="bg-white rounded-xl shadow p-6 flex flex-col gap-3">
              <div class="flex gap-4 items-center">
                <img src="${u.profilePic||'https://placehold.co/50x50'}" class="w-12 h-12 object-cover rounded-full border border-indigo-100"/>
                <div>
                  <div class="font-bold text-indigo-800 text-lg">${u.fullname||u.username}</div>
                  <div class="text-gray-500 text-sm mb-1">Email: ${u.email||'N/A'}</div>
                  <div class="text-gray-600 text-xs">Role: ${u.role}</div>
                </div>
              </div>
            </div>
          `;
        });
      }catch(e){showToast("Error loading users!","error");}
      hideLoader();
    }
    function searchUsers() {
      const q = document.getElementById("userSearchInput").value.trim();
      getUsers(q);
    }

    // ---- Courses Overview ----
    async function getCoursesOverview() {
      showLoader();
      try {
        const res = await fetch('/api/departments');
        const depts = await res.json();
        const coursesList = document.getElementById("coursesList");
        coursesList.innerHTML = "";
        depts.forEach(d=>{
          coursesList.innerHTML += `
            <div class="bg-white rounded-xl shadow p-6 flex flex-col gap-3">
              <div class="font-bold text-indigo-800 text-lg mb-1">${d.name}</div>
              <div class="text-gray-600 text-xs mb-2">Faculty: ${d.faculty}</div>
              <div class="flex flex-wrap gap-2">${(d.courses||[]).map(c=>`<span class="bg-blue-50 text-indigo-700 px-3 py-1 rounded-lg font-semibold">${c}</span>`).join('')}</div>
            </div>
          `;
        });
      }catch(e){
        showToast("Error loading courses!","error");
      }
      hideLoader();
    }

    // ---- Admin Profile ----
    document.getElementById("adminProfileForm").onsubmit = async function(e){
      e.preventDefault();
      showLoader();
      showToast("Profile updated!","success");
      hideLoader();
    };

    // ---- Initial Load ----
    document.addEventListener("DOMContentLoaded",()=>{
      getFaculties();
      getDepartments();
      getUsers();
      getCoursesOverview();
    });
  </script>
</body>
</html>
