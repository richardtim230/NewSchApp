<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=0.8">
    <title>OAU ExamGuard - Result</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Poppins', sans-serif;
            background-color: #f9fafb;
            overflow-x: hidden;
        }
        .exam-bg {
            background: linear-gradient(135deg, #4f46e5, #7c3aed);
            padding: 2rem;
            border-radius: 12px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        }
        .card {
            transition: transform 0.3s ease-in-out, box-shadow 0.3s ease-in-out;
        }
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px rgba(0, 0, 0, 0.2);
        }
        .action-btn {
            transition: background-color 0.3s ease, transform 0.2s ease;
        }
        .action-btn:hover {
            background-color: #5b21b6;
            transform: scale(1.05);
        }
        .timer {
            font-size: 1.5rem;
            font-weight: bold;
            color: #ef4444;
        }
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        .pulse {
            animation: pulse 2s infinite;
        }
        .summary-stat {
            border-radius: 16px;
            background: #fff;
            box-shadow: 0 2px 10px #4f46e522;
            display: flex;
            gap: 1.5rem;
            padding: 1.2rem 2rem;
            margin-bottom: 2rem;
            justify-content: center;
            align-items: center;
            flex-wrap: wrap;
        }
        .summary-item {
            min-width: 120px;
            text-align: center;
        }
        .summary-label {
            color: #6366f1;
            font-weight: 700;
            font-size: 1.1rem;
        }
        .summary-value {
            font-weight: bold;
            font-size: 1.6rem;
            color: #4f46e5;
            margin-top: 0.4em;
        }
        .option-row {
            display: flex;
            align-items: center;
            gap: 0.7em;
            padding: 0.7em 1em;
            border-radius: 12px;
            margin-bottom: 0.5em;
            border: 2px solid transparent;
            background: #f3f4f6;
            font-weight: 500;
            transition: background 0.18s, border-color 0.18s;
        }
        .option-row.correct {
            background: #dcfce7;
            border-color: #22c55e;
            color: #15803d;
        }
        .option-row.user-selected {
            background: #e0e7ff;
            border-color: #6366f1;
            color: #4f46e5;
        }
        .option-row.user-selected.wrong {
            background: #fee2e2;
            border-color: #ef4444;
            color: #b91c1c;
        }
        .option-row input[type="radio"] {
            accent-color: #6366f1;
        }
        .explanation-container {
            margin-top: 1.5em;
            padding: 1.1em 1.5em;
            background: #f3f4f6;
            border-radius: 12px;
            border-left: 5px solid #6366f1;
            color: #333;
            font-size: 1.08rem;
            box-shadow: 0 1px 6px #6366f122;
        }
        .question-card {
            border-radius: 18px;
            box-shadow: 0 6px 24px rgba(79, 70, 229, 0.11);
            border: 1.5px solid #ececff;
        }
        .q-badge {
            min-width: 48px;
            min-height: 48px;
            font-size: 1.3rem;
            box-shadow: 0 2px 8px rgba(79,70,229,0.08);
        }
        @media (max-width: 640px) {
            .summary-stat {
                flex-direction: column;
                padding: 1em;
                gap: 0.7em;
            }
            .summary-item {
                min-width: 80px;
                font-size: 1em;
            }
            .question-card { padding: 1rem; border-radius: 12px; }
            .q-badge { min-width: 40px; min-height: 40px; font-size: 1rem; }
        }
        .eg-summary-container {
  display: flex;
  flex-direction: column;
  align-items: center;
  background: rgba(255,255,255,0.7);
  border-radius: 20px;
  box-shadow: 0 4px 20px #6366f111;
  padding: 2.2em 1.2em 1.5em 1.2em;
  margin: 0 auto 2em auto;
  max-width: 360px;
  gap: 1.2em;
  position: relative;
}

.eg-main-score {
  display: flex;
  flex-direction: column;
  align-items: center;
  margin-bottom: 1.4em;
}
.eg-main-score-ring {
  width: 85px; height: 85px;
  background: linear-gradient(135deg, #6366f1 50%, #a5b4fc 100%);
  border-radius: 50%;
  box-shadow: 0 4px 18px #6366f133, 0 1.5px 5px #a5b4fc33;
  display: flex;
  align-items: center; justify-content: center;
  margin-bottom: 0.4em;
  border: 6px solid rgba(99,102,241,0.11);
}
.eg-main-score-value {
  font-size: 2.1rem;
  font-weight: 800;
  color: #fff;
  text-shadow: 0 1px 8px #6366f122;
}
.eg-main-score-label {
  margin-top: 0.1em;
  font-size: 1.16rem;
  color: #6366f1;
  font-weight: 700;
  letter-spacing: 0.5px;
}

.eg-summary-stats {
  display: flex;
  flex-wrap: wrap;
  gap: 1.1em 2em;
  justify-content: center;
  width: 100%;
}
.eg-summary-item {
  display: flex;
  flex-direction: column;
  align-items: center;
  min-width: 65px;
}
.eg-stat-icon {
  width: 36px; height: 36px;
  border-radius: 50%;
  display: flex;
  align-items: center; justify-content: center;
  font-size: 1.5rem;
  margin-bottom: 0.18em;
  box-shadow: 0 2px 8px #6366f122;
}
.eg-correct { background: #dcfce7; color: #16a34a; }
.eg-wrong { background: #fee2e2; color: #dc2626; }
.eg-time { background: #e0e7ff; color: #4f46e5; }
.eg-total { background: #fef9c3; color: #eab308; }
.eg-stat-label {
  font-size: 1rem; color: #6366f1; font-weight: 600; margin-bottom: 0.1em;
}
.eg-stat-value {
  font-size: 1.17rem; font-weight: 700; color: #1e293b;
}
@media (max-width: 640px) {
  .eg-summary-container { padding: 1.2em 0.5em 1.2em 0.5em; }
  .eg-main-score-ring { width: 64px; height: 64px;}
  .eg-main-score-value { font-size: 1.45rem;}
  .eg-summary-stats { gap: 0.7em 1.2em;}
  .eg-stat-icon { width: 28px; height: 28px; font-size: 1.1rem; }
  .eg-summary-item { min-width: 49px;}
        }
    </style>
</head>
<body class="min-h-screen">
    <!-- Header -->
    <header class="bg-white shadow-md sticky top-0 z-50">
        <nav class="container mx-auto px-4 sm:px-6 py-4 flex justify-between items-center">
            <div class="flex items-center">
                <img src="logo.png?text=Logo" alt="OAU ExamGuard Logo" class="h-10 w-10 sm:h-12 sm:w-12 mr-3">
                <h1 class="text-xl sm:text-2xl font-bold text-indigo-600">OAU ExamGuard Results</h1>
            </div>
        </nav>
    </header>

    <main class="container mx-auto px-4 sm:px-6 py-8">
        <!-- Exam Header -->
        <section class="custom-header mb-8">
            <div class="header-top relative flex items-center justify-center rounded-t-xl overflow-hidden" style="height: 110px;">
                <img src="images (7).jpeg?auto=format&fit=crop&w=800&q=80" alt="Header Background" 
                    class="absolute inset-0 w-full h-full object-cover opacity-70 pointer-events-none" />
                <h2 class="relative z-10 w-full text-center font-extrabold text-white text-3xl sm:text-4xl tracking-wide drop-shadow-lg" style="letter-spacing: 2px;">
                    Exam Results
                </h2>
            </div>
            <div class="header-bottom bg-gradient-to-r from-indigo-700 to-purple-700 text-white py-6 px-2 rounded-b-xl text-center">
                <div class="text-2xl sm:text-3xl font-bold tracking-wide" id="subject-display">Mathematics</div>
                <div class="text-xl sm:text-2xl font-semibold mt-2" id="code-display">(MTH105)</div>
                <div class="text-lg sm:text-xl font-medium mt-1" id="year-display">2024/2025</div>
            </div>
        </section>

        <!-- Result Summary -->
        <!-- Modern Result Summary Section -->
<div class="eg-summary-container">
  <div class="eg-main-score">
    <div class="eg-main-score-ring">
      <span class="eg-main-score-value" id="score-value">3/6</span>
    </div>
    <span class="eg-main-score-label">Score</span>
  </div>
  <div class="eg-summary-stats">
    <div class="eg-summary-item">
      <div class="eg-stat-icon eg-correct"><i class="bi bi-check-circle"></i></div>
      <div class="eg-stat-label">Correct</div>
      <div class="eg-stat-value" id="correct-value">3</div>
    </div>
    <div class="eg-summary-item">
      <div class="eg-stat-icon eg-wrong"><i class="bi bi-x-circle"></i></div>
      <div class="eg-stat-label">Wrong</div>
      <div class="eg-stat-value" id="wrong-value">3</div>
    </div>
    <div class="eg-summary-item">
      <div class="eg-stat-icon eg-time"><i class="bi bi-clock-history"></i></div>
      <div class="eg-stat-label">Time</div>
      <div class="eg-stat-value" id="timespent-value">30m 0s</div>
    </div>
    <div class="eg-summary-item">
      <div class="eg-stat-icon eg-total"><i class="bi bi-list-ol"></i></div>
      <div class="eg-stat-label">Total</div>
      <div class="eg-stat-value" id="total-value">6</div>
    </div>
  </div>
</div>

        <!-- Question Review -->
        <section class="mb-12">
            <div class="question-card bg-white p-7 rounded-2xl shadow-xl border border-gray-100 max-w-xl mx-auto" id="question-card">
                <div class="flex items-center gap-3 mb-3">
                    <div class="q-badge flex items-center justify-center bg-gradient-to-r from-indigo-500 to-purple-500 text-white font-bold text-lg w-12 h-12 rounded-full shadow" id="q-badge">
                        1
                    </div>
                    <h3 class="text-2xl font-extrabold text-gray-900" id="question-header">Question 1</h3>
                </div>
                <p class="text-lg text-gray-800 mb-6 font-medium" id="question-text"></p>
                <div id="options-review"></div>
                <div class="explanation-container" id="explanation-container"></div>
                <div class="flex justify-between gap-8 mt-7">
                    <button class="action-btn bg-gray-400 text-white px-7 py-2 rounded-full font-bold shadow-sm hover:bg-gray-500 transition" id="prev-btn">Prev</button>
                    <button class="action-btn bg-gradient-to-r from-indigo-600 to-purple-600 text-white px-7 py-2 rounded-full font-bold shadow hover:from-indigo-700 hover:to-purple-700 transition" id="next-btn">Next</button>
                </div>
            </div>
        </section>

        <!-- Question Navigator -->
        <section class="mb-12">
            <div class="card bg-white p-6 rounded-lg shadow-md">
                <h3 class="text-xl font-semibold mb-4">Question Navigator</h3>
                <div class="grid grid-cols-5 sm:grid-cols-10 gap-2" id="navigator-buttons">
                    <!-- Buttons will be injected here -->
                </div>
            </div>
        </section>
    </main>

    <footer class="bg-gray-800 text-white py-8">
        <div class="container mx-auto px-4 sm:px-6 text-center">
            <p class="text-sm sm:text-base">© 2025 OAU ExamGuard. All rights reserved.</p>
            <div class="mt-4 space-x-4">
                <a href="#" class="text-gray-400 hover:text-white text-sm sm:text-base">Privacy Policy</a>
                <a href="#" class="text-gray-400 hover:text-white text-sm sm:text-base">Terms of Service</a>
                <a href="#" class="text-gray-400 hover:text-white text-sm sm:text-base">Contact Us</a>
            </div>
        </div>
    </footer>

    <script>
        // Parse config from query params
        let config = {};
        let questions = [];
        let answers = {};
        let correctChoices = {};
        let wrongChoices = {};
        let explanations = {};
        let score = 0;
        let total = 0;
        let totalCorrect = 0;
        let totalWrong = 0;
        let timeSpent = 0;
        let currentQuestion = 0;
        function parseConfig() {
            const urlParams = new URLSearchParams(window.location.search);
            config = {
                subject: urlParams.get("subject") || "Mathematics",
                year: urlParams.get("year") || "2024",
                count: urlParams.get("count") || "50",
                time: urlParams.get("time") || "40",
                difficulty: urlParams.get("difficulty") || "Medium",
                score: urlParams.get("score") || "-",
                total: urlParams.get("total") || "-",
            };
            document.getElementById("subject-display").textContent = config.subject;
            document.getElementById("year-display").textContent = config.year;
            document.getElementById("code-display").textContent = config.subject === "Mathematics" ? "(MTH105)" : "";
        }
        parseConfig();

        function formatSeconds(sec) {
            const mins = Math.floor(sec / 60);
            const remSec = sec % 60;
            return `${mins}m ${remSec}s`;
        }

        async function fetchResultData() {
            // This endpoint should return the user's most recent answers, correct/wrong choices, explanations and timing for this subject/year/difficulty.
            // If not available, fallback to refetching questions and answers.
            const token = localStorage.getItem("token") || "";
            // 1. Fetch questions (same as exam)
            const params = new URLSearchParams({
                subject: config.subject,
                year: config.year,
                count: config.count,
                difficulty: config.difficulty
            });
            const resp = await fetch(`https://examguide.onrender.com/api/past-questions?${params.toString()}`, {
                headers: { "Authorization": "Bearer " + token }
            });
            questions = await resp.json();
            // 2. Fetch last submitted answer session
            // This should be replaced with a real endpoint to fetch last session for this user/config
            let session = null;
            try {
                const userResp = await fetch("https://examguide.onrender.com/api/auth/me", {
                    headers: { "Authorization": "Bearer " + token }
                });
                const user = await userResp.json();
                // Now fetch user's last answer for this subject/year/difficulty
                const answerResp = await fetch(`https://examguide.onrender.com/api/past-questions/save-answers?userId=${user.user._id}&subject=${config.subject}&year=${config.year}&difficulty=${config.difficulty}`, {
                    headers: { "Authorization": "Bearer " + token }
                });
                if (answerResp.ok) {
                    session = await answerResp.json();
                }
            } catch {}
            // Use session answers if available
            if (session && session.answers) {
                answers = {};
                session.answers.forEach(a => { answers[a.questionId] = a.answer; });
                correctChoices = session.correctChoices || {};
                wrongChoices = session.wrongChoices || {};
                totalCorrect = session.totalCorrect || 0;
                totalWrong = session.totalWrong || 0;
                score = session.totalCorrect || config.score;
                total = questions.length;
                timeSpent = session.timeSpent || 0;
            } else {
                answers = {}; correctChoices = {}; wrongChoices = {};
                totalCorrect = Number(config.score) || 0;
                totalWrong = (Number(config.total) || questions.length) - totalCorrect;
                score = totalCorrect;
                total = Number(config.total) || questions.length;
                timeSpent = Number(config.time) * 60;
            }
            // Collect explanations
            explanations = {};
            questions.forEach(q => {
                explanations[q._id] = q.explanation || "";
            });
        }

        function updateSummary() {
            document.getElementById("score-value").textContent = `${score}/${total}`;
            document.getElementById("correct-value").textContent = totalCorrect;
            document.getElementById("wrong-value").textContent = totalWrong;
            document.getElementById("total-value").textContent = total;
            document.getElementById("timespent-value").textContent = formatSeconds(timeSpent);
        }

        function renderQuestion(idx) {
            if (!questions.length) return;
            currentQuestion = idx;
            const q = questions[idx];
            document.getElementById('q-badge').textContent = idx+1;
            document.getElementById('question-header').textContent = `Question ${idx+1}`;
            document.getElementById('question-text').innerHTML = q.text || q.question || "No question text available.";
            // Render options
            const optionsDiv = document.getElementById("options-review");
            optionsDiv.innerHTML = "";
            const opts = q.options || q.choices || [];
            const correctAns = q.correctAnswer;
            const userAns = answers[q._id];
            opts.forEach((opt, i) => {
                let rowClass = "option-row";
                if (opt === correctAns) rowClass += " correct";
                if (opt === userAns && opt === correctAns) rowClass += " user-selected";
                else if (opt === userAns && opt !== correctAns) rowClass += " user-selected wrong";
                optionsDiv.innerHTML += `
                    <div class="${rowClass}">
                        <input type="radio" disabled ${userAns === opt ? "checked" : ""} />
                        <span>${String.fromCharCode(65+i)}. ${opt}</span>
                    </div>
                `;
            });
            document.getElementById("explanation-container").innerHTML = q.explanation ? `<b>Explanation:</b> ${q.explanation}` : `<i>No explanation provided.</i>`;
            document.getElementById("prev-btn").disabled = (idx === 0);
            document.getElementById("next-btn").disabled = (idx === questions.length-1);
            renderNavigator();
        }

        function renderNavigator() {
            const navDiv = document.getElementById("navigator-buttons");
            navDiv.innerHTML = "";
            questions.forEach((q, idx) => {
                navDiv.innerHTML += `
                    <button class="action-btn px-3 py-2 rounded-full text-sm ${idx === currentQuestion ? 'bg-indigo-600 text-white pulse' : 'bg-gray-300 text-gray-700'}" onclick="goToQuestion(${idx})">${idx+1}</button>
                `;
            });
        }
        window.goToQuestion = function(idx) {
            renderQuestion(idx);
        };

        document.getElementById("prev-btn").addEventListener("click", () => {
            if (currentQuestion > 0) renderQuestion(currentQuestion-1);
        });
        document.getElementById("next-btn").addEventListener("click", () => {
            if (currentQuestion < questions.length-1) renderQuestion(currentQuestion+1);
        });

        window.onload = async function() {
            await fetchResultData();
            updateSummary();
            renderQuestion(0);
        };
    </script>
</body>
</html>
