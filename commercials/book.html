<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Books | Marketplace</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/flowbite/2.5.1/flowbite.min.css" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/css?family=Inter:400,500,700&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Inter', sans-serif; }
    .product-card {
      border: 1.5px solid #e0e7ef;
      box-shadow: 0 6px 24px rgba(59,130,246,0.08);
      border-radius: 1.25rem;
      background: #fff;
      transition: box-shadow 0.2s, transform 0.2s;
    }
    .product-card:hover {
      box-shadow: 0 12px 32px rgba(59,130,246,0.16);
      transform: translateY(-2px) scale(1.02);
    }
    .footer-link:hover { color: #fbbf24; text-decoration: underline; transition: color 0.2s;}
    .cat-card:hover { transform: translateY(-4px) scale(1.03); box-shadow: 0 8px 24px rgba(59,130,246,0.12);}
    #autocomplete-list { position:absolute; z-index:99; background:#fff; border-radius:0.5rem; box-shadow: 0 2px 8px rgba(0,0,0,0.08); width:100%;}
    #autocomplete-list div { cursor:pointer; padding:0.75rem; }
    #autocomplete-list div:hover { background:#dbeafe; }
  </style>
</head>
<body class="bg-gray-50 text-gray-900">

  <!-- Navbar -->
  <nav class="bg-white shadow-md fixed top-0 left-0 w-full z-50">
    <div class="max-w-7xl mx-auto flex items-center justify-between px-6 py-4">
      <h1 class="text-2xl font-bold text-blue-600">Market<span class="text-gray-900">Place</span></h1>
      <nav class="hidden md:flex gap-8 font-medium">
        <a href="../mart.html" class="hover:text-blue-600 transition">Home</a>
        <a href="../mart.html#products-section" class="hover:text-blue-600 transition">Shop</a>
        <a href="../mart.html#categories" class="hover:text-blue-600 transition">Categories</a>
        <a href="../mart.html#contact" class="hover:text-blue-600 transition">Contact</a>
      </nav>
      <a id="account-btn" href="#" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition">Sign In</a>
    </div>
  </nav>

  <!-- Header Section with overlayed image background -->
  <section class="relative h-[360px] sm:h-[460px] flex items-center justify-center pt-20"
           style="background-image: url('https://images.unsplash.com/photo-1512820790803-83ca734da794?auto=format&fit=crop&w=1200&q=80'); background-size: cover; background-position: center;">
    <div class="absolute inset-0 bg-black/60"></div>
    <div class="relative z-10 text-center px-6 sm:px-12 max-w-3xl">
      <h2 class="text-4xl sm:text-5xl font-extrabold text-white mb-4">Books</h2>
      <p class="text-lg sm:text-xl text-blue-100 mb-6">
        Find textbooks, novels, guides, academic publications, and more. Buy new or used from verified sellers. Read, learn, and grow!
      </p>
      <form class="max-w-xl mx-auto flex items-center gap-3 mb-4" onsubmit="event.preventDefault(); searchProducts();">
        <input type="text" id="searchInput" autocomplete="off" placeholder="Search books, authors, genres..."
               class="w-full px-4 py-3 rounded-lg border border-blue-300 focus:ring-2 focus:ring-blue-500 outline-none text-lg">
        <button type="submit" class="bg-white text-blue-600 font-semibold px-6 py-3 rounded-lg hover:bg-blue-100 transition">Search</button>
      </form>
      <div id="autocomplete-list"></div>
    </div>
  </section>

  <!-- Books Filter Bar -->
  <section class="bg-white shadow-sm">
    <div class="max-w-7xl mx-auto px-6 py-4 flex flex-col md:flex-row items-center justify-between gap-4">
      <div class="flex gap-3 flex-wrap">
        <button class="px-4 py-2 bg-blue-50 text-blue-700 rounded-lg font-medium hover:bg-blue-100 transition" onclick="filterCategory('All')">All</button>
        <button class="px-4 py-2 bg-gray-50 text-gray-700 rounded-lg font-medium hover:bg-blue-50 transition" onclick="filterCategory('Textbooks')">Textbooks</button>
        <button class="px-4 py-2 bg-gray-50 text-gray-700 rounded-lg font-medium hover:bg-blue-50 transition" onclick="filterCategory('Novels')">Novels</button>
        <button class="px-4 py-2 bg-gray-50 text-gray-700 rounded-lg font-medium hover:bg-blue-50 transition" onclick="filterCategory('Academic')">Academic</button>
        <button class="px-4 py-2 bg-gray-50 text-gray-700 rounded-lg font-medium hover:bg-blue-50 transition" onclick="filterCategory('Children')">Children</button>
        <button class="px-4 py-2 bg-gray-50 text-gray-700 rounded-lg font-medium hover:bg-blue-50 transition" onclick="filterCategory('Others')">Others</button>
      </div>
      <div>
        <label class="font-medium mr-2">Sort by:</label>
        <select id="sortSelect" class="px-3 py-2 rounded-lg border border-gray-300 text-gray-700" onchange="sortProducts()">
          <option value="featured">Featured</option>
          <option value="lowest">Lowest Price</option>
          <option value="highest">Highest Price</option>
          <option value="newest">Newest</option>
        </select>
      </div>
    </div>
  </section>

  <!-- Books Product Grid -->
  <section class="py-16 bg-gray-100">
    <h2 class="text-2xl font-bold text-center mb-10 text-blue-700 tracking-tight">Popular Books</h2>
    <div id="books-products" class="max-w-7xl mx-auto grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-8 px-6">
      <div id="products-loader" class="col-span-full text-center py-12 text-lg text-gray-500">Loading books...</div>
      <!-- Products are rendered here by JS -->
    </div>
  </section>

  <!-- Special Features Section -->
  <section class="bg-white py-12">
    <div class="max-w-7xl mx-auto grid md:grid-cols-4 gap-8 px-6">
      <div class="p-6 rounded-xl shadow bg-blue-50 border-t-4 border-blue-400 text-center">
        <div class="text-3xl mb-3">üìö</div>
        <h3 class="font-bold text-lg text-blue-700">Wide Selection</h3>
        <p class="text-gray-600 mt-2">Browse hundreds of genres, authors, and publishers.</p>
      </div>
      <div class="p-6 rounded-xl shadow bg-blue-50 border-t-4 border-yellow-400 text-center">
        <div class="text-3xl mb-3">üîç</div>
        <h3 class="font-bold text-lg text-yellow-600">Advanced Search</h3>
        <p class="text-gray-600 mt-2">Filter by author, genre, price, year, and more.</p>
      </div>
      <div class="p-6 rounded-xl shadow bg-blue-50 border-t-4 border-green-400 text-center">
        <div class="text-3xl mb-3">üì¶</div>
        <h3 class="font-bold text-lg text-green-700">Buy & Rent</h3>
        <p class="text-gray-600 mt-2">Purchase or rent books at best prices from verified sellers.</p>
      </div>
      <div class="p-6 rounded-xl shadow bg-blue-50 border-t-4 border-yellow-500 text-center">
        <div class="text-3xl mb-3">‚≠ê</div>
        <h3 class="font-bold text-lg text-blue-700">Ratings & Reviews</h3>
        <p class="text-gray-600 mt-2">See ratings and reviews before you buy. Share your experience.</p>
      </div>
    </div>
  </section>

  <!-- Blog / News Section -->
  <section id="blog" class="max-w-7xl mx-auto px-4 py-8">
    <h2 class="text-xl font-bold text-blue-700 mb-6 text-center">Academic Book News & Articles</h2>
    <div id="blog-list" class="grid grid-cols-1 md:grid-cols-3 gap-8 relative min-h-[180px]">
      <div id="blog-loader" class="col-span-full text-center py-10 text-gray-400">
        <svg class="mx-auto animate-spin h-8 w-8 text-blue-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
          <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
          <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"></path>
        </svg>
        <span class="block mt-3">Loading articles...</span>
      </div>
      <!-- Blogs rendered here by JS -->
    </div>
  </section>

  <!-- Footer -->
  <footer class="bg-gray-900 text-gray-300 py-6 mt-12">
    <div class="max-w-7xl mx-auto px-6 grid md:grid-cols-3 gap-8">
      <div>
        <h3 class="text-xl font-bold text-white">Marketplace</h3>
        <p class="mt-3 text-sm">Buy, rent, and discover books with trust & safety guaranteed.</p>
      </div>
      <div>
        <h3 class="font-semibold text-white">Quick Links</h3>
        <ul class="mt-3 space-y-2 text-sm">
          <li><a href="../about-us-faq" class="hover:text-white">About Us</a></li>
          <li><a href="../mart.html#categories" class="hover:text-white">Categories</a></li>
          <li><a href="../mart.html#shop" class="hover:text-white">Support</a></li>
        </ul>
      </div>
      <div>
        <h3 class="font-semibold text-white">Follow Us</h3>
        <div class="flex gap-4 mt-3">
          <a href="#" class="hover:text-white">üåê</a>
          <a href="#" class="hover:text-white">üê¶</a>
          <a href="#" class="hover:text-white">üìö</a>
        </div>
      </div>
    </div>
    <div class="text-center text-sm text-gray-500 mt-8">¬© 2025 Marketplace. All rights reserved.</div>
  </footer>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/flowbite/2.5.1/flowbite.min.js"></script>
  <script>
    // --- Auth Check ---
    let buyerProfile = null;
    async function checkAuth() {
      try {
        const token = localStorage.getItem("token");
        if (token) {
          const res = await fetch("https://examguard-jmvj.onrender.com/api/auth/me", {
            headers: { "Authorization": "Bearer " + token }
          });
          if (res.ok) {
            document.getElementById("account-btn").textContent = "My Dashboard";
            document.getElementById("account-btn").href = "../dashboard";
            buyerProfile = await res.json();
            return true;
          }
        }
      } catch (e) {}
      document.getElementById("account-btn").textContent = "Sign In";
      document.getElementById("account-btn").href = "../login";
      buyerProfile = null;
      return false;
    }

    // --- Product Fetch ---
    let allBooks = [];
    let filteredBooks = [];
    let currentCategory = "All";

    async function fetchBooks(query = "") {
      document.getElementById("products-loader").style.display = "";
      try {
        let url = "https://examguard-jmvj.onrender.com/api/blogger-dashboard/public/listings";
        let res = await fetch(url);
        let products = [];
        if (res.ok) {
          products = await res.json();
          // Filter ONLY books category (including 'book', 'books', or more specific like 'novel', 'textbook', etc.)
          products = products.filter(
            p =>
              (p.category && (
                p.category.toLowerCase().includes("book") ||
                p.category.toLowerCase() === "novel" ||
                p.category.toLowerCase() === "novels" ||
                p.category.toLowerCase() === "textbook" ||
                p.category.toLowerCase() === "textbooks" ||
                p.category.toLowerCase() === "academic" ||
                p.category.toLowerCase() === "children"
              )) &&
              ((p.status && (p.status === "Published" || p.status === "Active")) || p.approved)
          );
          if (query) {
            const q = query.toLowerCase();
            products = products.filter(p =>
              (p.title && p.title.toLowerCase().includes(q)) ||
              (p.summary && p.summary.toLowerCase().includes(q)) ||
              (p.category && p.category.toLowerCase().includes(q)) ||
              (p.author && p.author.toLowerCase().includes(q)) ||
              (p.authorName && p.authorName.toLowerCase().includes(q))
            );
          }
        }
        allBooks = products;
        filteredBooks = products;
        renderBooks(products);
      } catch (e) {
        allBooks = [];
        filteredBooks = [];
        renderBooks([]);
      }
      document.getElementById("products-loader").style.display = "none";
    }

    // --- Render Products Function ---
    function renderBooks(products) {
      const list = document.getElementById("books-products");
      if (!products.length) {
        list.innerHTML = `<div class="text-center col-span-4 text-lg text-gray-500 py-12">No books found.</div>`;
        return;
      }
      list.innerHTML = products.map(p => `
        <div class="product-card p-5 flex flex-col">
          <div class="relative rounded-xl overflow-hidden mb-4">
            <img src="${p.img || p.imageUrl || (Array.isArray(p.images) && p.images[0]) || 'https://ui-avatars.com/api/?name=' + encodeURIComponent(p.title || 'Book') + '&background=eee&color=263159'}"
                 alt="${p.title}" class="w-full h-52 object-cover bg-gray-100" />
          </div>
          <span class="bg-blue-100 text-blue-700 text-xs font-medium px-3 py-1 rounded-full mb-2 w-fit">${p.category || 'Book'}</span>
          <h3 class="font-bold text-lg text-gray-900 mb-1">${p.title}</h3>
          <p class="text-gray-600 text-sm mb-2">${p.author || p.authorName || ""}</p>
          <p class="text-gray-600 text-xs mb-2">${p.summary || p.description || ""}</p>
          <div class="flex items-center mb-2">
            <span class="flex items-center text-yellow-500 text-sm font-semibold mr-2">
              ${p.rating ? `‚≠ê ${p.rating}` : ""}
            </span>
            <span class="text-xs text-gray-500">${p.likes ? `(${p.likes} likes)` : ""}</span>
          </div>
          <div class="flex items-center justify-between mt-auto">
            <span class="font-bold text-blue-700 text-xl">${p.price || ""}</span>
            <a href="../sales/items.html?id=${p._id || p.id}" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold px-5 py-2 rounded-full shadow flex items-center gap-2 transition">
              View
              <svg class="w-5 h-5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                <path d="M13 5l7 7-7 7M5 12h14" />
              </svg>
            </a>
          </div>
          <div class="mt-2 flex items-center gap-2">
            <span class="px-2 py-1 text-xs bg-yellow-100 text-yellow-800 rounded">${p.seller || p.author || p.authorName || ""}</span>
            <span class="flex items-center text-xs text-yellow-600">${p.rating || ("‚≠ê " + (p.likes || 0))}</span>
          </div>
        </div>
      `).join("");
    }

    // --- Search Logic ---
    function searchProducts() {
      const query = document.getElementById("searchInput").value.trim();
      let products = allBooks;
      if (query) {
        const q = query.toLowerCase();
        products = products.filter(p =>
          (p.title && p.title.toLowerCase().includes(q)) ||
          (p.summary && p.summary.toLowerCase().includes(q)) ||
          (p.category && p.category.toLowerCase().includes(q)) ||
          (p.author && p.author.toLowerCase().includes(q)) ||
          (p.authorName && p.authorName.toLowerCase().includes(q))
        );
      }
      filteredBooks = products;
      renderBooks(products);
    }

    // --- Category Filter ---
    function filterCategory(category) {
      currentCategory = category;
      let products = allBooks;
      if (category === "All") {
        // Do nothing, show all
      } else {
        products = products.filter(p =>
          (p.category && p.category.toLowerCase().includes(category.toLowerCase()))
        );
      }
      filteredBooks = products;
      renderBooks(products);
    }

    // --- Sort Logic ---
    function sortProducts() {
      const sortVal = document.getElementById("sortSelect").value;
      let products = [...filteredBooks];
      if (sortVal === "lowest") {
        products.sort((a, b) => parseInt(a.price?.replace(/[^0-9]/g,"")) - parseInt(b.price?.replace(/[^0-9]/g,"")));
      } else if (sortVal === "highest") {
        products.sort((a, b) => parseInt(b.price?.replace(/[^0-9]/g,"")) - parseInt(a.price?.replace(/[^0-9]/g,"")));
      } else if (sortVal === "newest") {
        products.sort((a, b) => new Date(b.date) - new Date(a.date));
      }
      renderBooks(products);
    }

    document.addEventListener("DOMContentLoaded", async function() {
      await checkAuth();
      await fetchBooks();

      document.getElementById("searchInput").addEventListener("keyup", function(e){
        if(e.key === "Enter"){
          searchProducts();
        }
      });

      fetchAcademicBlogs();
    });

    // --- Blog Section Logic (efficient backend filtering/sorting for Academics) ---
const API_BASE = "https://examguard-jmvj.onrender.com/api";
const ACADEMICS_POSTS_API = API_BASE + "/public/posts/academics";
const USER_API = API_BASE + "/users/";

async function fetchAuthorName(userId) {
  if (!userId) return "Anonymous";
  if (window.authorCache && window.authorCache[userId]) return window.authorCache[userId];
  try {
    const res = await fetch(USER_API + userId);
    if (!res.ok) return userId;
    const data = await res.json();
    const name = data.user?.fullname || data.user?.username || userId;
    window.authorCache = window.authorCache || {};
    window.authorCache[userId] = name;
    return name;
  } catch {
    return userId;
  }
}

async function fetchAcademicBlogs() {
  const blogList = document.getElementById("blog-list");
  const blogLoader = document.getElementById("blog-loader");
  blogLoader.style.display = "";
  blogList.innerHTML = blogLoader.outerHTML;

  try {
    let url = `${ACADEMICS_POSTS_API}?limit=6&sortBy=date&order=desc`;
    const res = await fetch(url);
    let articles = [];
    if (res.ok) {
      articles = await res.json();
    }
    blogList.innerHTML = "";
    if (!articles || !articles.length) {
      blogList.innerHTML = `<div class="col-span-full text-center text-gray-400 py-10">No academic articles found.</div>`;
      return;
    }
    // Unique author IDs
    const authorIds = [...new Set(articles.map(a => a.author?._id || a.author || a.authorId).filter(Boolean))];
    const authorNames = {};
    await Promise.all(authorIds.map(async uid => {
      if (!authorNames[uid]) authorNames[uid] = await fetchAuthorName(uid);
    }));

    articles.forEach(blog => {
      const authorId = blog.author?._id || blog.author || blog.authorId;
      const authorName = blog.authorName || authorNames[authorId] || "Anonymous";
      const maxLen = 120;
      let content = blog.summary || (blog.content && blog.content.slice(0, maxLen)) || "";
      if (content.length > maxLen) content = content.slice(0, maxLen) + "...";
      blogList.innerHTML += `
        <div class="bg-white rounded-xl shadow p-6 hover:ring-2 hover:ring-blue-400 cursor-pointer transition flex flex-col h-full">
          <img src="${blog.imageUrl || blog.image || 'https://images.unsplash.com/photo-1512820790803-83ca734da794?auto=format&fit=crop&w=400&q=80'}" class="rounded-lg mb-4 w-full h-24 object-cover" alt="${blog.title}">
          <h3 class="font-bold text-lg mb-2">${blog.title}</h3>
          <div class="text-xs text-gray-500 mb-2">${authorName} ‚Ä¢ ${blog.date ? new Date(blog.date).toLocaleDateString() : ""}</div>
          <p class="text-gray-700 text-sm mb-2 flex-1">${content}</p>
          <a href="../campus-news-update?id=${blog._id || blog.id}" class="text-blue-600 font-semibold hover:underline mt-auto block">Read More</a>
        </div>
      `;
    });
  } catch(e) {
    blogList.innerHTML = `<div class="col-span-full text-center text-gray-400 py-10">Error loading academic articles.</div>`;
  }
    }
    
  </script>
</body>
</html>
