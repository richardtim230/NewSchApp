<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>OAU ExamGuard Marketplace | Buy & Sell</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/flowbite/2.2.1/flowbite.min.css" rel="stylesheet"/>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/flowbite/2.2.1/flowbite.min.js"></script>
  <style>
    .gold-accent { color: #f59e42; }
    .navy-bg { background-color: #1e293b; }
    .market-hero-bg {
      background-image: url('https://images.unsplash.com/photo-1515378791036-0648a3ef77b2?auto=format&fit=crop&w=1200&q=80');
      background-size: cover;
      background-position: center;
      background-repeat: no-repeat;
    }
    @media (max-width: 600px) {
      .market-hero-bg { background-position: 60% center; }
    }
    .dark .dark-invert { filter: invert(1) hue-rotate(180deg); }
    .market-img-full {
      object-fit: contain !important;
      background: #f3f4f6;
      min-height: 200px;
      max-height: 300px;
      width: 100%;
      display: block;
    }
    .category-tab-active {
      background-color: #1e293b !important;
      color: #fff !important;
    }
    .category-tab {
      background-color: #fef9c3;
      color: #a16207;
      transition: background 0.2s, color 0.2s;
    }
    .category-tab:hover {
      background-color: #fde68a;
      color: #1e293b;
    }

    /* Loader styles */
    .spinner {
      border: 4px solid #f3f4f6;
      border-top: 4px solid #f59e42;
      border-radius: 50%;
      width: 36px;
      height: 36px;
      animation: spin 1s linear infinite;
      margin: auto;
      display: block;
    }
    @keyframes spin {
      to { transform: rotate(360deg);}
    }
    .btn-loading {
      position: relative;
      pointer-events: none;
      opacity: 0.7;
    }
    .btn-spinner {
      border: 2px solid #f3f4f6;
      border-top: 2px solid #f59e42;
      border-radius: 50%;
      width: 18px;
      height: 18px;
      animation: spin 1s linear infinite;
      display: inline-block;
      vertical-align: middle;
      margin-right: 6px;
    }
  </style>
</head>
<body class="bg-gray-50 text-gray-900 transition-colors duration-300" id="marketbody">

  <!-- Announcements Banner -->
  <div class="bg-yellow-100 border-b-2 border-yellow-400 text-yellow-900 text-center py-2 px-4 font-semibold flex items-center justify-center gap-2">
    <span>‚ö° Marketplace Notice:</span> <span>Never pay before pickup. Watch out for scams!</span>
  </div>

  <!-- Dark Mode Toggle -->
  <div class="fixed top-3 right-3 z-50 flex gap-2">
    <button id="darkToggle" class="bg-blue-900 text-yellow-400 rounded-full w-10 h-10 flex items-center justify-center shadow-lg hover:bg-yellow-500 hover:text-blue-900 transition text-xl" title="Toggle dark mode">üåô</button>
  </div>

  <!-- Marketplace Hero -->
  <header class="market-hero-bg relative min-h-[380px] md:min-h-[420px] flex items-center">
    <div class="absolute inset-0 bg-gradient-to-br from-blue-900/80 via-blue-900/50 to-yellow-700/60"></div>
    <div class="relative z-10 max-w-4xl mx-auto px-4 py-12 text-center w-full">
      <h1 class="text-3xl md:text-5xl font-extrabold text-white drop-shadow mb-4">
        OAU ExamGuard <span class="text-yellow-400">Premium Marketplace</span>
      </h1>
      <p class="max-w-2xl mx-auto text-lg text-yellow-100 mb-8">
        Buy and sell textbooks, gadgets, tickets, hostels, and more. Secure, student-only, and packed with features to make your campus life easier.
      </p>
      <div class="flex flex-col sm:flex-row justify-center items-center gap-4">
        <button data-modal-target="post-modal" data-modal-toggle="post-modal" class="bg-yellow-500 text-blue-900 px-8 py-3 rounded-full font-bold shadow hover:bg-yellow-600 transition">Post an Item</button>
        <a href="#categories" class="bg-blue-900 text-white px-8 py-3 rounded-full font-bold shadow hover:bg-yellow-500 hover:text-blue-900 transition">Browse Categories</a>
      </div>
    </div>
  </header>

  <!-- Quick Search/Filter/Sort/Category Tabs -->
  <section class="bg-white shadow py-6 px-4">
    <div class="max-w-5xl mx-auto flex flex-col md:flex-row gap-4 md:gap-8 items-center justify-between">
      <form id="searchForm" class="flex flex-1 gap-2">
        <input id="searchInput" type="text" placeholder="Search for books, gadgets, etc." class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-yellow-400" />
        <button type="submit" class="bg-yellow-500 text-blue-900 px-5 py-2 rounded-lg font-bold hover:bg-yellow-600 transition" id="searchBtn">Search</button>
      </form>
      <div class="flex flex-wrap gap-2 mt-2 md:mt-0" id="categoryTabs">
        <button onclick="filterCategory('All',this)" class="category-tab px-4 py-2 rounded transition">All</button>
        <button onclick="filterCategory('Books',this)" class="category-tab px-4 py-2 rounded transition">Books</button>
        <button onclick="filterCategory('Gadgets',this)" class="category-tab px-4 py-2 rounded transition">Gadgets</button>
        <button onclick="filterCategory('Hostel',this)" class="category-tab px-4 py-2 rounded transition">Hostel</button>
        <button onclick="filterCategory('Tickets',this)" class="category-tab px-4 py-2 rounded transition">Tickets</button>
        <button onclick="filterCategory('Others',this)" class="category-tab px-4 py-2 rounded transition">Others</button>
      </div>
      <div class="flex items-center gap-1">
        <label for="sortSelect" class="hidden md:inline text-blue-900 font-medium">Sort:</label>
        <select id="sortSelect" class="px-2 py-1 border rounded focus:ring-2 focus:ring-yellow-400">
          <option value="newest">Newest</option>
          <option value="lowprice">Price: Low to High</option>
          <option value="highprice">Price: High to Low</option>
        </select>
      </div>
    </div>
  </section>

  <!-- Marketplace Feature Highlights -->
  <section class="max-w-5xl mx-auto py-12 px-4 grid md:grid-cols-3 gap-8" id="categories">
    <div class="bg-white rounded-2xl shadow flex flex-col items-center p-8 border-t-4 border-yellow-500">
      <span class="text-4xl mb-3">üîí</span>
      <h3 class="font-bold text-blue-900 mb-2">Safe & Verified</h3>
      <p class="text-gray-700 text-center">All listings are student-verified. Chat safely and only with real OAUers.</p>
    </div>
    <div class="bg-white rounded-2xl shadow flex flex-col items-center p-8 border-t-4 border-blue-900">
      <span class="text-4xl mb-3">üí¨</span>
      <h3 class="font-bold text-yellow-600 mb-2">Instant Messaging</h3>
      <p class="text-gray-700 text-center">Negotiate and ask questions directly with sellers‚Äîno third-party needed.</p>
    </div>
    <div class="bg-white rounded-2xl shadow flex flex-col items-center p-8 border-t-4 border-yellow-500">
      <span class="text-4xl mb-3">‚≠ê</span>
      <h3 class="font-bold text-blue-900 mb-2">Ratings & Reviews</h3>
      <p class="text-gray-700 text-center">See real feedback before you buy. Rate your experience and earn points!</p>
    </div>
  </section>

  <!-- Marketplace Items Listing -->
  <section class="max-w-7xl mx-auto py-12 px-4">
    <div class="flex flex-col sm:flex-row items-center justify-between mb-4 gap-2">
      <h2 class="text-2xl font-bold text-blue-900">Latest Listings</h2>
      <span id="listingCount" class="text-gray-500 text-sm"></span>
    </div>
    <div id="marketGrid" class="grid gap-6 md:grid-cols-3 sm:grid-cols-2"></div>
    <div class="flex justify-center mt-8 gap-2" id="paginationWrapper">
      <!-- Pagination buttons will be rendered here -->
    </div>
  </section>

  <!-- Post Item Modal (Flowbite) -->
  <div id="post-modal" tabindex="-1" aria-hidden="true" class="hidden overflow-y-auto overflow-x-hidden fixed top-0 right-0 left-0 z-50 w-full md:inset-0 h-modal md:h-full bg-black/40">
    <div class="relative p-4 w-full max-w-lg md:max-w-xl mx-auto h-full flex items-center min-h-screen">
      <div class="relative bg-white rounded-lg shadow p-6 w-full">
        <button type="button" class="absolute top-3 right-3 text-gray-400 hover:text-blue-900" data-modal-hide="post-modal">
          <svg aria-hidden="true" class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M6 18L18 6M6 6l12 12"></path>
          </svg>
        </button>
        <h3 class="text-xl font-bold text-blue-900 mb-2">Post a New Item</h3>
        <form id="postItemForm" class="space-y-4">
          <div>
            <label class="block mb-1 font-medium">Title</label>
            <input type="text" required class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-yellow-400" />
          </div>
          <div>
            <label class="block mb-1 font-medium">Category</label>
            <select class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-yellow-400" required>
              <option value="">Select</option>
              <option>Books</option>
              <option>Gadgets</option>
              <option>Hostel</option>
              <option>Tickets</option>
              <option>Others</option>
            </select>
          </div>
          <div>
            <label class="block mb-1 font-medium">Description</label>
            <textarea rows="3" required class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-yellow-400"></textarea>
          </div>
          <div>
            <label class="block mb-1 font-medium">Price (‚Ç¶)</label>
            <input type="number" min="0" required class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-yellow-400" />
          </div>
          <div>
            <label class="block mb-1 font-medium">Upload Image</label>
            <input type="file" accept="image/*" class="w-full" />
          </div>
          <button type="submit" class="w-full py-3 mt-2 bg-yellow-600 text-white font-bold rounded-lg hover:bg-blue-900 hover:text-yellow-400 transition" id="postItemBtn">Post Item</button>
        </form>
      </div>
    </div>
  </div>

  <!-- Live Chat Widget (Demo) -->
  <div class="fixed bottom-6 right-6 z-50">
    <button id="chatToggle" class="bg-blue-900 text-yellow-400 rounded-full w-16 h-16 flex items-center justify-center shadow-lg hover:bg-yellow-500 hover:text-blue-900 transition text-3xl">
      üí¨
    </button>
    <div id="chatWidget" class="hidden mt-2 w-80 bg-white shadow-lg rounded-2xl border p-4">
      <div class="flex items-center gap-2 mb-2">
        <span class="text-blue-900 font-bold">Marketplace Chat</span>
        <span class="ml-auto text-xs bg-yellow-500 text-blue-900 px-2 rounded-full">Beta</span>
      </div>
      <div class="h-40 overflow-y-auto border rounded p-2 mb-2 text-sm text-gray-700 bg-gray-50">
        <div class="mb-1"><span class="font-semibold text-blue-900">AI:</span> How can I assist you today?</div>
      </div>
      <form id="chatForm" class="flex gap-2">
        <input id="chatInput" type="text" placeholder="Type a message..." class="flex-1 px-3 py-2 border rounded" />
        <button type="submit" class="bg-yellow-500 text-blue-900 px-4 py-2 rounded font-bold hover:bg-blue-900 hover:text-yellow-400 transition" id="chatSendBtn">Send</button>
      </form>
    </div>
  </div>

  <!-- Item Modal (details and chat with seller, wishlist, report, offer) -->
  <div id="item-modal" tabindex="-1" aria-hidden="true" class="hidden fixed z-50 inset-0 bg-black/40">
    <div class="relative p-4 w-full max-w-lg md:max-w-xl mx-auto h-full flex items-center min-h-screen">
      <div class="relative bg-white rounded-lg shadow p-6 w-full">
        <button type="button" class="absolute top-3 right-3 text-gray-400 hover:text-blue-900" data-modal-hide="item-modal">
          <svg aria-hidden="true" class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M6 18L18 6M6 6l12 12"></path>
          </svg>
        </button>
        <div id="modalItemContent"></div>
      </div>
    </div>
  </div>

  <!-- Report Modal -->
  <div id="report-modal" tabindex="-1" aria-hidden="true" class="hidden overflow-y-auto overflow-x-hidden fixed top-0 right-0 left-0 z-50 w-full md:inset-0 h-modal md:h-full bg-black/40">
    <div class="relative p-4 w-full max-w-md mx-auto h-full flex items-center min-h-screen">
      <div class="relative bg-white rounded-lg shadow p-6 w-full">
        <button type="button" class="absolute top-3 right-3 text-gray-400 hover:text-blue-900" data-modal-hide="report-modal">
          <svg aria-hidden="true" class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M6 18L18 6M6 6l12 12"></path>
          </svg>
        </button>
        <h3 class="text-lg font-bold text-blue-900 mb-2">Report Listing</h3>
        <form id="reportForm" class="space-y-3">
          <label class="block font-medium">Reason</label>
          <select class="w-full px-3 py-2 border rounded" required>
            <option value="">Select...</option>
            <option>Inappropriate content</option>
            <option>Fraudulent listing</option>
            <option>Suspicious seller</option>
            <option>Other</option>
          </select>
          <textarea placeholder="Describe the issue (optional)" class="w-full px-3 py-2 border rounded" rows="3"></textarea>
          <button type="submit" class="w-full py-2 bg-yellow-500 text-blue-900 font-bold rounded hover:bg-blue-900 hover:text-yellow-400 transition" id="reportBtn">Submit Report</button>
        </form>
      </div>
    </div>
  </div>

  <!-- Offer/Negotiation Modal -->
  <div id="offer-modal" tabindex="-1" aria-hidden="true" class="hidden overflow-y-auto overflow-x-hidden fixed top-0 right-0 left-0 z-50 w-full md:inset-0 h-modal md:h-full bg-black/40">
    <div class="relative p-4 w-full max-w-md mx-auto h-full flex items-center min-h-screen">
      <div class="relative bg-white rounded-lg shadow p-6 w-full">
        <button type="button" class="absolute top-3 right-3 text-gray-400 hover:text-blue-900" data-modal-hide="offer-modal">
          <svg aria-hidden="true" class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M6 18L18 6M6 6l12 12"></path>
          </svg>
        </button>
        <h3 class="text-lg font-bold text-blue-900 mb-3">Send Offer</h3>
        <form id="offerForm" class="space-y-3">
          <label class="block font-medium">Offer Price (‚Ç¶)</label>
          <input type="number" min="0" class="w-full px-3 py-2 border rounded" id="offerPriceInput" required />
          <label class="block font-medium mt-2">Reason for Offer</label>
          <textarea class="w-full px-3 py-2 border rounded" id="offerReasonInput" placeholder="Explain why you chose this offer or add a note for seller..." rows="2" required></textarea>
          <label class="block font-medium mt-2">Send Message (optional)</label>
          <textarea class="w-full px-3 py-2 border rounded" id="offerMsgInput" placeholder="Extra message for seller..." rows="2"></textarea>
          <button type="submit" class="w-full py-2 bg-yellow-500 text-blue-900 font-bold rounded hover:bg-blue-900 hover:text-yellow-400 transition" id="offerBtn">Send Offer</button>
        </form>
        <div id="offerResponse" class="p-3 text-center text-green-600 hidden"></div>
      </div>
    </div>
  </div>
  <footer class="bg-gray-900 text-gray-300 py-10">
    <div class="max-w-7xl mx-auto px-6 grid md:grid-cols-3 gap-8">
      <div>
        <h3 class="text-xl font-bold text-white">Marketplace</h3>
        <p class="mt-3 text-sm">Buy, sell, and discover products in your community with trust & safety guaranteed.</p>
      </div>
      <div>
        <h3 class="font-semibold text-white">Quick Links</h3>
        <ul class="mt-3 space-y-2 text-sm">
          <li><a href="#" class="hover:text-white">About Us</a></li>
          <li><a href="#" class="hover:text-white">Categories</a></li>
          <li><a href="#" class="hover:text-white">Support</a></li>
        </ul>
      </div>
      <div>
        <h3 class="font-semibold text-white">Follow Us</h3>
        <div class="flex gap-4 mt-3">
          <a href="#" class="hover:text-white">üåê</a>
          <a href="#" class="hover:text-white">üê¶</a>
          <a href="#" class="hover:text-white">üì∏</a>
        </div>
      </div>
    </div>
    <div class="text-center text-sm text-gray-500 mt-10">¬© 2025 Marketplace. All rights reserved.</div>
  </footer>
 <script>
    // === MARKETPLACE BACKEND INTEGRATION ===
    const BACKEND = "https://examguide.onrender.com";
    let marketItems = [];
    let filteredItems = [];
    let pagedItems = [];
    const wishlist = new Set();
    let buyerProfile = null;
    let currentPage = 1;
    const ITEMS_PER_PAGE = 20;
    let currentCategory = 'All';
    let currentSearch = "";

    // Loader helpers
    function showGridLoader() {
      const grid = document.getElementById('marketGrid');
      if (grid) grid.innerHTML = `<div class='col-span-3 py-16 flex justify-center items-center'><span class="spinner"></span></div>`;
    }
    function hideGridLoader() {
      // no-op, loader is replaced by renderMarket
    }
    function setBtnLoading(btn, isLoading, text) {
      if (!btn) return;
      if (isLoading) {
        btn.classList.add('btn-loading');
        btn.disabled = true;
        btn.innerHTML = `<span class="btn-spinner"></span> ${text || btn.dataset.loadingText || btn.textContent}`;
      } else {
        btn.classList.remove('btn-loading');
        btn.disabled = false;
        btn.innerHTML = btn.dataset.originalText || text || btn.textContent.replace(/^\s*\u{1f504}?\s*/u, '');
      }
    }

    // Auth check
    async function checkAuth() {
      try {
        const token = localStorage.getItem("token");
        if (token) {
          const res = await fetch(BACKEND+"/api/auth/me", { headers: { "Authorization": "Bearer " + token } });
          if (res.ok) {
            buyerProfile = await res.json();
            return true;
          }
        }
      } catch (e) {}
      buyerProfile = null;
      return false;
    }

    // Fetch all published/active items from all sellers
    async function fetchAllListings() {
      showGridLoader();
      try {
        const res = await fetch(BACKEND + "/api/blogger-dashboard/public/listings");
        if (!res.ok) throw new Error("Could not fetch listings");
        const data = await res.json();
        // Normalizing results for UI compatibility
        marketItems = (data || []).map(item => ({
          id: item._id || item.id,
          title: item.title || item.item,
          price: item.price,
          category: item.category || "Others",
          description: item.description || "",
          image: item.img || item.imageUrl || "https://placehold.co/400x300?text=No+Image",
          seller: item.sellerName || item.seller || "Unknown",
          sellerId: item.sellerId || item.owner || "",
          verified: item.verified || false,
          rating: item.rating || (4 + Math.random()),
          reviews: item.reviews || Math.floor(Math.random() * 10) + 1,
          date: item.date || "Recently"
        }));
        applyCurrentFilterSortPaginate();
      } catch (err) {
        document.getElementById('marketGrid').innerHTML = "<div class='col-span-3 text-center text-red-500 py-10'>Failed to load marketplace items. Please try again later.</div>";
        document.getElementById('listingCount').textContent = "";
        renderPagination(1, 1);
      }
    }

    // Filtering, searching, sorting and pagination pipeline
    function applyCurrentFilterSortPaginate(opts = {}) {
      // 1. Filter by category
      filteredItems = (currentCategory === "All")
        ? [...marketItems]
        : marketItems.filter(item => item.category === currentCategory);

      // 2. Search
      if (currentSearch) {
        filteredItems = filteredItems.filter(item =>
          item.title.toLowerCase().includes(currentSearch) ||
          item.description.toLowerCase().includes(currentSearch)
        );
      }

      // 3. Sorting
      const sortVal = document.getElementById('sortSelect').value;
      let sorted = [...filteredItems];
      if (sortVal === 'lowprice') sorted.sort((a, b) => a.price - b.price);
      else if (sortVal === 'highprice') sorted.sort((a, b) => b.price - a.price);

      // 4. Pagination
      let totalItems = sorted.length;
      let totalPages = Math.max(1, Math.ceil(totalItems / ITEMS_PER_PAGE));
      if (opts.forcePageOne) currentPage = 1;
      if (currentPage > totalPages) currentPage = totalPages;
      const start = (currentPage - 1) * ITEMS_PER_PAGE;
      const end = Math.min(start + ITEMS_PER_PAGE, sorted.length);
      pagedItems = sorted.slice(start, end);

      renderMarket(pagedItems, totalItems, currentPage, totalPages);
      renderPagination(currentPage, totalPages);
    }

    // RENDER MARKETPLACE ITEMS
    function renderMarket(items, totalCount, page, totalPages) {
      const grid = document.getElementById('marketGrid');
      if (!grid) return;
      grid.innerHTML = "";
      if (items.length === 0) {
        grid.innerHTML = "<div class='col-span-3 text-center text-gray-500 py-10'>No items found for your search or filter.</div>";
      }
      items.forEach(item => {
        grid.innerHTML += `
        <div class="bg-white rounded-xl shadow p-4 flex flex-col hover:shadow-xl transition group relative">
          <button onclick="toggleWishlist('${item.id}')" aria-label="Save to Wishlist" class="absolute top-3 right-3 text-2xl focus:outline-none transition">
            <span class="${wishlist.has(item.id) ? 'text-yellow-500' : 'text-gray-300'}">&#10084;</span>
          </button>
          <img src="${item.image}" alt="${item.title}" class="market-img-full rounded-lg mb-3 group-hover:scale-105 transition" />
          <div class="flex-1 flex flex-col">
            <h3 class="font-bold text-blue-900 text-lg mb-1">${item.title}</h3>
            <div class="flex items-center text-yellow-500 text-base font-bold mb-2">‚Ç¶${(item.price||0).toLocaleString()}</div>
            <div class="text-xs text-gray-400 mb-1">${item.category} &bull; ${item.date}</div>
            <div class="flex flex-wrap gap-2 mb-2 items-center">
              <span class="bg-yellow-100 text-yellow-700 px-2 py-1 rounded text-xs flex items-center gap-1">${item.seller} 
                ${item.verified ? '<span class="ml-1 inline-block bg-blue-900 text-yellow-400 px-2 rounded-full text-xs font-bold">Verified</span>' : ''}
              </span>
              <span class="bg-blue-900 text-white px-2 py-1 rounded text-xs"><span class="font-bold">${item.rating.toFixed(1)}</span> <span class="text-yellow-400">‚òÖ</span> (${item.reviews})</span>
            </div>
            <p class="text-gray-600 mb-3 line-clamp-2">${item.description}</p>
            <div class="flex gap-2 flex-wrap">
              <a href="sales/items.html?id=${item.id}" class="mt-auto bg-yellow-500 text-blue-900 px-3 py-2 rounded-lg font-bold hover:bg-blue-900 hover:text-yellow-400 transition">View & Chat</a>
              <button onclick="openOfferModal('${item.id}', this)" class="bg-blue-900 text-yellow-400 px-3 py-2 rounded-lg font-bold hover:bg-yellow-500 hover:text-blue-900 transition">Send Offer</button>
              <button onclick="openReportModal('${item.id}', this)" aria-label="Report Item" class="ml-auto text-red-600 hover:underline text-xs">Report</button>
            </div>
          </div>
        </div>
        `;
      });
      // Update listing count
      if (typeof totalCount !== "undefined" && typeof page !== "undefined" && typeof totalPages !== "undefined") {
        const start = (page - 1) * ITEMS_PER_PAGE + 1;
        const end = Math.min(start + items.length - 1, totalCount);
        document.getElementById('listingCount').textContent =
          `${totalCount || 0} listing${totalCount !== 1 ? 's' : ''} shown (${start}-${end} of ${totalCount})`;
      } else {
        document.getElementById('listingCount').textContent = `${items.length} listing${items.length !== 1 ? 's' : ''} shown`;
      }
    }

    // PAGINATION RENDER
    function renderPagination(current, total) {
      const wrapper = document.getElementById('paginationWrapper');
      if (!wrapper) return;
      wrapper.innerHTML = "";
      if (total <= 1) return;

      // Prev
      wrapper.innerHTML += `<button class="bg-blue-900 text-white px-4 py-2 rounded hover:bg-yellow-600 hover:text-blue-900 transition" ${current === 1 ? "disabled style='opacity:0.4;cursor:not-allowed'" : ""} onclick="gotoPage(${current-1})" id="prevBtn">${current === 1 ? '<span class="btn-spinner"></span> ' : ''}Prev</button>`;
      // Page numbers
      for (let i = 1; i <= total; ++i) {
        if (i === current) {
          wrapper.innerHTML += `<button class="bg-yellow-500 text-blue-900 px-4 py-2 rounded font-bold">${i}</button>`;
        } else if (i === 1 || i === total || (i >= current-1 && i <= current+1)) {
          wrapper.innerHTML += `<button class="bg-white border px-4 py-2 rounded text-blue-900 hover:bg-yellow-100 transition" onclick="gotoPage(${i})">${i}</button>`;
        } else if (i === current-2 || i === current+2) {
          wrapper.innerHTML += `<span class="px-2 py-2 text-gray-400">...</span>`;
        }
      }
      // Next
      wrapper.innerHTML += `<button class="bg-blue-900 text-white px-4 py-2 rounded hover:bg-yellow-600 hover:text-blue-900 transition" ${current === total ? "disabled style='opacity:0.4;cursor:not-allowed'" : ""} onclick="gotoPage(${current+1})" id="nextBtn">${current === total ? '<span class="btn-spinner"></span> ' : ''}Next</button>`;
    }
    window.gotoPage = function(page) {
      currentPage = page;
      applyCurrentFilterSortPaginate();
      window.scrollTo({top: 0, behavior: 'smooth'});
    };

    // WISHLIST
    function toggleWishlist(id) {
      if (wishlist.has(id)) wishlist.delete(id); else wishlist.add(id);
      applyCurrentFilterSortPaginate();
    }

    // FILTER BY CATEGORY (with active styling)
    function filterCategory(cat, btn) {
      currentCategory = cat;
      currentSearch = "";
      document.getElementById('searchInput').value = "";
      applyCurrentFilterSortPaginate({forcePageOne: true});
      document.querySelectorAll('#categoryTabs button').forEach(b => {
        b.classList.remove('category-tab-active');
      });
      if (btn) btn.classList.add('category-tab-active');
      else {
        document.querySelectorAll('#categoryTabs button').forEach(b => {
          if (b.textContent.trim() === cat) b.classList.add('category-tab-active');
        });
      }
    }
    window.filterCategory = filterCategory;
    window.toggleWishlist = toggleWishlist;

    // On load, highlight 'All' as active
    window.addEventListener('DOMContentLoaded', function() {
      document.querySelectorAll('#categoryTabs button')[0].classList.add('category-tab-active');
    });

    // SEARCH
    document.getElementById('searchForm').addEventListener('submit', function(e) {
      e.preventDefault();
      currentSearch = document.getElementById('searchInput').value.trim().toLowerCase();
      applyCurrentFilterSortPaginate({forcePageOne: true});
    });

    // SORTING
    document.getElementById('sortSelect').addEventListener('change', function(e){
      applyCurrentFilterSortPaginate();
    });

    // POST ITEM MODAL DEMO
    document.getElementById('postItemForm').addEventListener('submit', function(e) {
      e.preventDefault();
      const btn = document.getElementById('postItemBtn');
      setBtnLoading(btn, true, "Posting...");
      setTimeout(() => {
        setBtnLoading(btn, false, "Post Item");
        alert("Your item will be posted after admin review. (Demo only)");
        document.querySelector('[data-modal-hide="post-modal"]').click();
      }, 1100);
    });

    // ITEM DETAILS MODAL (Wishlist, Report, Offer)
    let currentItemId = null;
    function openItemModal(id) {
      currentItemId = id;
      const item = marketItems.find(i => i.id === id);
      if (!item) return;
      document.getElementById('modalItemContent').innerHTML = `
        <div class="flex gap-2 items-center mb-2">
          <img src="${item.image}" alt="${item.title}" class="market-img-full w-24 h-24 object-contain rounded-lg border" />
          <div>
            <h3 class="font-bold text-blue-900 text-xl mb-1">${item.title}</h3>
            <div class="flex items-center text-yellow-500 text-lg font-bold mb-1">‚Ç¶${item.price.toLocaleString()}</div>
            <div class="flex gap-2 items-center mb-1">
              <span class="bg-yellow-100 text-yellow-700 px-2 py-1 rounded text-xs flex items-center gap-1">${item.seller}
                ${item.verified ? '<span class="ml-1 inline-block bg-blue-900 text-yellow-400 px-2 rounded-full text-xs font-bold">Verified</span>' : ''}
              </span>
              <span class="bg-blue-900 text-white px-2 py-1 rounded text-xs"><span class="font-bold">${item.rating}</span> <span class="text-yellow-400">‚òÖ</span> (${item.reviews})</span>
            </div>
          </div>
          <button onclick="toggleWishlist(${item.id})" aria-label="Save to Wishlist" class="ml-auto text-2xl focus:outline-none transition">
            <span class="${wishlist.has(item.id) ? 'text-yellow-500' : 'text-gray-300'}">&#10084;</span>
          </button>
        </div>
        <div class="text-xs text-gray-400 mb-1">${item.category} &bull; ${item.date}</div>
        <p class="text-gray-700 mb-3">${item.description}</p>
        <div class="flex gap-2 mb-3">
          <button onclick="openReportModal(${item.id})" class="bg-red-100 text-red-700 text-xs px-2 py-1 rounded hover:bg-red-200 transition">Report</button>
          <button onclick="openOfferModal(${item.id})" class="bg-blue-900 text-yellow-400 text-xs px-2 py-1 rounded hover:bg-yellow-500 hover:text-blue-900 transition">Send Offer</button>
        </div>
        <form id="itemChatForm" class="flex gap-2 mt-3">
          <input type="text" placeholder="Message seller..." class="flex-1 px-3 py-2 border rounded" />
          <button type="submit" class="bg-yellow-500 text-blue-900 px-4 py-2 rounded font-bold hover:bg-blue-900 hover:text-yellow-400 transition" id="sendMsgBtn">Send</button>
        </form>
      `;
      document.getElementById('item-modal').classList.remove('hidden');
      document.getElementById('itemChatForm').addEventListener('submit', async function(e){
        e.preventDefault();
        const btn = document.getElementById('sendMsgBtn');
        setBtnLoading(btn, true, "Sending...");
        await checkAuth();
        if(!buyerProfile || !buyerProfile.user) {
          setBtnLoading(btn, false, "Send");
          alert("Please sign in to send a message to the seller.");
          return;
        }
        const msg = this.querySelector('input').value.trim();
        if (!msg) {
          setBtnLoading(btn, false, "Send");
          return;
        }
        try {
          const token = localStorage.getItem("token");
          const item = marketItems.find(i => i.id === currentItemId);
          if (!item.sellerId) {
            setBtnLoading(btn, false, "Send");
            return alert("Seller not found for this item.");
          }
          const res = await fetch(BACKEND + "/api/blogger-dashboard/messages", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "Authorization": "Bearer " + token
            },
            body: JSON.stringify({
              sellerId: item.sellerId,
              text: msg,
              productId: currentItemId
            })
          });
          setBtnLoading(btn, false, "Send");
          if (res.ok) {
            alert("Message sent to seller!");
            this.reset();
          } else {
            alert("Failed to send message.");
          }
        } catch {
          setBtnLoading(btn, false, "Send");
          alert("Failed to send message.");
        }
      });
    }
    window.openItemModal = openItemModal;

    document.querySelectorAll('[data-modal-hide="item-modal"]').forEach(btn => {
      btn.addEventListener('click', () => document.getElementById('item-modal').classList.add('hidden'));
    });

    // REPORT MODAL
    function openReportModal(id, btn) {
      document.getElementById('report-modal').classList.remove('hidden');
    }
    window.openReportModal = openReportModal;
    document.getElementById('reportForm').addEventListener('submit', function(e){
      e.preventDefault();
      const btn = document.getElementById('reportBtn');
      setBtnLoading(btn, true, "Reporting...");
      setTimeout(() => {
        setBtnLoading(btn, false, "Submit Report");
        alert('Thank you for reporting. Our team will review this item.');
        document.querySelector('[data-modal-hide="report-modal"]').click();
      }, 1100);
    });
    document.querySelectorAll('[data-modal-hide="report-modal"]').forEach(btn => {
      btn.addEventListener('click', () => document.getElementById('report-modal').classList.add('hidden'));
    });
    document.getElementById('report-modal').addEventListener('click', function(e){
      if(e.target === this) this.classList.add('hidden');
    });

    // OFFER MODAL
    let offerItemId = null;
    function openOfferModal(id, btn) {
      offerItemId = id;
      document.getElementById('offer-modal').classList.remove('hidden');
      document.getElementById('offerForm').reset();
      document.getElementById('offerResponse').classList.add('hidden');
    }
    window.openOfferModal = openOfferModal;
    document.getElementById('offerForm').addEventListener('submit', async function(e){
      e.preventDefault();
      const btn = document.getElementById('offerBtn');
      setBtnLoading(btn, true, "Sending...");
      await checkAuth();
      if(!buyerProfile || !buyerProfile.user) {
        setBtnLoading(btn, false, "Send Offer");
        alert("Please sign in to send an offer.");
        return;
      }
      const offerPrice = document.getElementById('offerPriceInput').value;
      const offerReason = document.getElementById('offerReasonInput').value.trim();
      const offerMsg = document.getElementById('offerMsgInput').value.trim();
      if (!offerPrice || !offerReason) {
        setBtnLoading(btn, false, "Send Offer");
        alert("Please enter your offer and a reason for your offer.");
        return;
      }
      const item = marketItems.find(i => i.id === offerItemId);
      const token = localStorage.getItem("token");
      const fullMessage = `Reason: ${offerReason}\n${offerMsg ? "Message: " + offerMsg : ""}`;
      try {
        const res = await fetch(BACKEND + "/api/offers", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "Authorization": "Bearer " + token
          },
          body: JSON.stringify({
            productId: offerItemId,
            offerPrice,
            message: fullMessage,
            buyer: {
              id: buyerProfile.user._id,
              name: buyerProfile.user.fullname || buyerProfile.user.username,
              email: buyerProfile.user.email,
              phone: buyerProfile.user.phone
            }
          })
        });
        setBtnLoading(btn, false, "Send Offer");
        if (res.ok) {
          document.getElementById('offerResponse').textContent = "Offer sent successfully!";
          document.getElementById('offerResponse').classList.remove('hidden');
          this.reset();
          setTimeout(() => {
            document.getElementById('offerResponse').classList.add('hidden');
            document.querySelector('[data-modal-hide="offer-modal"]').click();
          }, 1500);
        } else {
          document.getElementById('offerResponse').textContent = "Failed to send offer.";
          document.getElementById('offerResponse').classList.remove('hidden');
        }
      } catch {
        setBtnLoading(btn, false, "Send Offer");
        document.getElementById('offerResponse').textContent = "Failed to send offer.";
        document.getElementById('offerResponse').classList.remove('hidden');
      }
    });
    document.querySelectorAll('[data-modal-hide="offer-modal"]').forEach(btn => {
      btn.addEventListener('click', () => document.getElementById('offer-modal').classList.add('hidden'));
    });
    document.getElementById('offer-modal').addEventListener('click', function(e){
      if(e.target === this) this.classList.add('hidden');
    });

    // LIVE CHAT WIDGET DEMO
    const chatToggle = document.getElementById('chatToggle');
    const chatWidget = document.getElementById('chatWidget');
    chatToggle.addEventListener('click', () => {
      chatWidget.classList.toggle('hidden');
    });
    document.getElementById('chatForm').addEventListener('submit', function(e){
      e.preventDefault();
      const btn = document.getElementById('chatSendBtn');
      setBtnLoading(btn, true, "Sending...");
      setTimeout(() => {
        setBtnLoading(btn, false, "Send");
        const chatInput = document.getElementById('chatInput');
        if (chatInput.value.trim()) {
          const msgBox = chatWidget.querySelector('div.h-40');
          msgBox.innerHTML += `<div class="mb-1"><span class="font-semibold text-blue-900">You:</span> ${chatInput.value}</div>`;
          msgBox.scrollTop = msgBox.scrollHeight;
          chatInput.value = "";
        }
      }, 800);
    });

    // INIT: Auth check + Fetch listings on page load!
    window.addEventListener('DOMContentLoaded', async function() {
      await checkAuth();
      fetchAllListings();
      document.querySelectorAll('#categoryTabs button')[0].classList.add('category-tab-active');
    });

    // Close modals when background clicked (post, item, report, offer)
    document.querySelectorAll('[data-modal-hide="post-modal"]').forEach(btn => {
      btn.addEventListener('click', () => document.getElementById('post-modal').classList.add('hidden'));
    });
    document.getElementById('post-modal').addEventListener('click', function(e){
      if(e.target === this) this.classList.add('hidden');
    });
    document.getElementById('item-modal').addEventListener('click', function(e){
      if(e.target === this) this.classList.add('hidden');
    });

    // DARK MODE
    document.getElementById('darkToggle').addEventListener('click', function() {
      document.body.classList.toggle('dark');
      document.body.classList.toggle('bg-gray-900');
      document.body.classList.toggle('text-gray-100');
    });

  </script>
</body>
</html>
