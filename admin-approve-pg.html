<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Admin Dashboard | Marketplace Moderation</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .badge-approved { background: #d1fae5; color: #065f46; }
    .badge-pending { background: #fef3c7; color: #92400e; }
    .badge-rejected { background: #fee2e2; color: #991b1b; }
    .modal-bg {
      background: rgba(30,41,59,0.30);
      backdrop-filter: blur(2px);
      -webkit-backdrop-filter: blur(2px);
    }
    .tab-btn-active {
      border-bottom-width: 2px;
      border-color: #6366f1;
      color: #3730a3;
      background-color: #eef2ff;
    }
    .tab-btn {
      border-bottom-width: 2px;
      border-color: transparent;
      color: #334155;
      background-color: transparent;
    }
    .spinner {
      border-top-color: #6366f1;
      animation: spin 1s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
    @media (max-width: 640px) {
      .hero-text { font-size: 1.2rem !important; }
      .admin-hero-title { font-size: 2rem !important; }
    }
  </style>
</head>
<body class="bg-gradient-to-br from-indigo-50 via-white to-yellow-50 min-h-screen w-full overflow-x-hidden">
  <!-- HERO SECTION -->
  <section class="bg-gradient-to-br from-indigo-900 via-indigo-700 to-indigo-600 py-10 px-4 text-white shadow-md">
    <div class="max-w-6xl mx-auto flex flex-col sm:flex-row items-center justify-between gap-6">
      <div class="mb-4 sm:mb-0 flex-1">
        <h1 class="admin-hero-title text-4xl sm:text-5xl font-extrabold mb-3 drop-shadow-lg">Marketplace <span class="text-yellow-300">Admin</span> Dashboard</h1>
        <p class="hero-text text-lg sm:text-xl text-indigo-100 mb-5">Moderate, approve, and manage all product listings, sellers, bloggers, and blog posts in one place. Make your marketplace safe, trusted, and thriving!</p>
        <div class="flex gap-3">
          <a href="#" class="bg-yellow-400/95 text-blue-900 font-bold px-6 py-2 rounded-full shadow hover:bg-yellow-500 transition">Marketplace</a>
          <a href="#" class="bg-white/90 text-blue-800 font-bold px-6 py-2 rounded-full shadow hover:bg-indigo-100 transition">All Admin Tools</a>
        </div>
      </div>
      <div class="flex-1 flex justify-center">
        <img src="https://cdn.jsdelivr.net/gh/twitter/twemoji@latest/assets/svg/1f512.svg" class="w-40 h-40 drop-shadow-lg" alt="Moderation">
      </div>
    </div>
  </section>

  <!-- TABS -->
  <nav class="max-w-6xl mx-auto px-4 mt-8">
    <div class="flex gap-2 border-b border-gray-200 overflow-x-auto">
      <button class="tab-btn-active px-5 py-2 rounded-t font-semibold transition min-w-max" data-tab="listings">Listings</button>
      <button class="tab-btn px-5 py-2 rounded-t font-semibold transition min-w-max" data-tab="sellers">Sellers</button>
      <button class="tab-btn px-5 py-2 rounded-t font-semibold transition min-w-max" data-tab="bloggers">Bloggers</button>
      <button class="tab-btn px-5 py-2 rounded-t font-semibold transition min-w-max" data-tab="posts">Blog Posts</button>
      <button class="tab-btn px-5 py-2 rounded-t font-semibold transition min-w-max" data-tab="analytics">Analytics</button>
      <button class="tab-btn px-5 py-2 rounded-t font-semibold transition min-w-max" data-tab="help">Help</button>
    </div>
  </nav>

  <main class="max-w-6xl mx-auto px-2 sm:px-4 py-8">
    <!-- LISTINGS TAB -->
    <section class="tab-content" id="tab-listings">
      <div class="flex flex-col sm:flex-row justify-between items-center mb-6 gap-4">
        <div>
          <h2 class="text-2xl font-bold text-indigo-800 mb-2">Product Listings Moderation</h2>
          <p class="text-gray-500 text-sm">Approve, reject, or unpublish listings. Click "View Seller" for seller account info.</p>
        </div>
        <div class="flex gap-2 items-center">
          <input id="searchInput" type="text" class="border rounded px-3 w-10 py-2 shadow-sm" placeholder="Search products/sellers..." />
          <select id="statusFilter" class="border rounded px-2 py-2">
            <option value="">All</option>
            <option value="pending">Pending</option>
            <option value="approved">Approved</option>
            <option value="rejected">Rejected</option>
            <option value="unpublished">Unpublished</option>
          </select>
        </div>
      </div>
      <div id="listingsGrid" class="grid gap-6 sm:grid-cols-2 lg:grid-cols-3"></div>
      <div id="listingsLoader" class="py-16 flex justify-center hidden">
        <span class="w-10 h-10 border-4 border-indigo-300 rounded-full border-t-transparent spinner"></span>
      </div>
    </section>

    <!-- SELLERS TAB -->
    <section class="tab-content hidden" id="tab-sellers">
      <div class="mb-6">
        <h2 class="text-2xl font-bold text-indigo-800 mb-2">All Sellers</h2>
        <p class="text-gray-500 text-sm">View and audit all marketplace sellers. Click a seller for details. Use tabs to filter by approval status.</p>
        <div class="flex gap-2 mt-2">
          <button class="seller-tab-btn px-4 py-2 rounded bg-indigo-100 text-blue-900 font-semibold" data-status="all">All</button>
          <button class="seller-tab-btn px-4 py-2 rounded bg-green-100 text-green-800" data-status="approved">Approved</button>
          <button class="seller-tab-btn px-4 py-2 rounded bg-yellow-100 text-yellow-800" data-status="pending">Pending</button>
        </div>
      </div>
      <div id="sellersGrid" class="grid gap-6 sm:grid-cols-2 lg:grid-cols-3"></div>
      <div id="sellersLoader" class="py-16 flex justify-center hidden">
        <span class="w-10 h-10 border-4 border-indigo-300 rounded-full border-t-transparent spinner"></span>
      </div>
    </section>
<!-- Blog Post Preview Modal -->
<div id="postModal" class="modal-bg fixed inset-0 z-50 hidden flex items-center justify-center">
  <div class="bg-white p-6 rounded-xl shadow-lg w-full max-w-lg relative mx-2 overflow-y-auto max-h-[90vh]">
    <button onclick="closePostModal()" class="absolute top-3 right-3 text-gray-400 hover:text-blue-900">
      <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
          d="M6 18L18 6M6 6l12 12"></path>
      </svg>
    </button>
    <div id="postModalContent"></div>
  </div>
        </div>
    <!-- BLOGGERS TAB -->
    <section class="tab-content hidden" id="tab-bloggers">
      <div class="mb-6">
        <h2 class="text-2xl font-bold text-indigo-800 mb-2">All Bloggers/Marketers</h2>
        <p class="text-gray-500 text-sm">View and audit all bloggers/marketers. Click for details. Use tabs to filter by approval status.</p>
        <div class="flex gap-2 mt-2">
          <button class="blogger-tab-btn px-4 py-2 rounded bg-indigo-100 text-blue-900 font-semibold" data-status="all">All</button>
          <button class="blogger-tab-btn px-4 py-2 rounded bg-green-100 text-green-800" data-status="approved">Approved</button>
          <button class="blogger-tab-btn px-4 py-2 rounded bg-yellow-100 text-yellow-800" data-status="pending">Pending</button>
        </div>
      </div>
      <div id="bloggersGrid" class="grid gap-6 sm:grid-cols-2 lg:grid-cols-3"></div>
      <div id="bloggersLoader" class="py-16 flex justify-center hidden">
        <span class="w-10 h-10 border-4 border-indigo-300 rounded-full border-t-transparent spinner"></span>
      </div>
    </section>

    <!-- BLOG POSTS TAB -->
    <section class="tab-content hidden" id="tab-posts">
      <div class="mb-6">
        <h2 class="text-2xl font-bold text-indigo-800 mb-2">All Blog Posts</h2>
        <p class="text-gray-500 text-sm">Review and moderate all blog posts, both pending and approved.</p>
        <div class="flex gap-2 mt-2">
          <button class="post-tab-btn px-4 py-2 rounded bg-indigo-100 text-blue-900 font-semibold" data-status="all">All</button>
          <button class="post-tab-btn px-4 py-2 rounded bg-green-100 text-green-800" data-status="approved">Approved</button>
          <button class="post-tab-btn px-4 py-2 rounded bg-yellow-100 text-yellow-800" data-status="pending">Pending</button>
        </div>
      </div>
      <div id="postsGrid" class="grid gap-6 sm:grid-cols-1 md:grid-cols-2 lg:grid-cols-3"></div>
      <div id="postsLoader" class="py-16 flex justify-center hidden">
        <span class="w-10 h-10 border-4 border-indigo-300 rounded-full border-t-transparent spinner"></span>
      </div>
    </section>

    <!-- ANALYTICS TAB -->
    <section class="tab-content hidden" id="tab-analytics">
      <h2 class="text-2xl font-bold text-indigo-800 mb-4">Marketplace Analytics</h2>
      <div class="grid gap-8 grid-cols-1 md:grid-cols-3 mb-10">
        <div class="bg-white rounded-xl shadow p-6 flex flex-col items-center">
          <span class="text-4xl mb-2 text-indigo-600">üì¶</span>
          <div class="font-bold text-indigo-800 text-2xl mb-1" id="totalListings">0</div>
          <div class="text-sm text-indigo-700">Total Listings</div>
        </div>
        <div class="bg-white rounded-xl shadow p-6 flex flex-col items-center">
          <span class="text-4xl mb-2 text-yellow-500">üßë‚Äçüíº</span>
          <div class="font-bold text-indigo-800 text-2xl mb-1" id="totalSellers">0</div>
          <div class="text-sm text-indigo-700">Total Sellers</div>
        </div>
        <div class="bg-white rounded-xl shadow p-6 flex flex-col items-center">
          <span class="text-4xl mb-2 text-green-600">üìù</span>
          <div class="font-bold text-indigo-800 text-2xl mb-1" id="totalBloggers">0</div>
          <div class="text-sm text-indigo-700">Total Bloggers/Marketers</div>
        </div>
        <div class="bg-white rounded-xl shadow p-6 flex flex-col items-center">
          <span class="text-4xl mb-2 text-green-600">‚úÖ</span>
          <div class="font-bold text-indigo-800 text-2xl mb-1" id="approvedListings">0</div>
          <div class="text-sm text-indigo-700">Listings Approved</div>
        </div>
        <div class="bg-white rounded-xl shadow p-6 flex flex-col items-center">
          <span class="text-4xl mb-2 text-yellow-500">üìö</span>
          <div class="font-bold text-indigo-800 text-2xl mb-1" id="totalPosts">0</div>
          <div class="text-sm text-indigo-700">Total Blog Posts</div>
        </div>
      </div>
    </section>

    <!-- HELP TAB -->
    <section class="tab-content hidden" id="tab-help">
      <h2 class="text-2xl font-bold text-indigo-800 mb-4">Admin Help & Support</h2>
      <div class="bg-white rounded-xl shadow p-6 flex flex-col gap-4 border border-indigo-100 max-w-2xl">
        <div class="flex items-center gap-2 mb-2">
          <span class="text-blue-900 font-bold">Need Help?</span>
          <span class="ml-auto text-xs bg-indigo-100 text-indigo-800 px-2 rounded-full">Admin</span>
        </div>
        <div class="h-32 overflow-y-auto border rounded p-2 mb-2 text-sm text-gray-700 bg-indigo-50" id="helpBox">
          <div class="mb-1"><span class="font-semibold text-blue-900">AI:</span> How can I assist you with moderation or administration today?</div>
        </div>
        <form id="helpForm" class="flex gap-2">
          <input id="helpInput" type="text" placeholder="Type a support message..." class="flex-1 px-3 py-2 border rounded" />
          <button type="submit" class="bg-indigo-600 text-white px-4 py-2 rounded font-bold hover:bg-indigo-700 transition">Send</button>
        </form>
      </div>
    </section>
  </main>

  <!-- Seller/Blogger Modal -->
  <div id="sellerModal" class="modal-bg fixed inset-0 z-50 hidden flex items-center justify-center">
    <div class="bg-white p-6 rounded-xl shadow-lg w-full max-w-md relative mx-2">
      <button onclick="closeSellerModal()" class="absolute top-3 right-3 text-gray-400 hover:text-blue-900">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
            d="M6 18L18 6M6 6l12 12"></path>
        </svg>
      </button>
      <div id="sellerModalContent"></div>
    </div>
  </div>

  <!-- Spinner Overlay -->
  <div id="globalSpinner" class="fixed inset-0 z-[9999] bg-black/30 flex items-center justify-center hidden">
    <div class="w-16 h-16 border-4 border-indigo-200 rounded-full border-t-indigo-500 spinner"></div>
  </div>

  <script>
    const BACKEND = "https://examguide.onrender.com";
    function getToken() { return localStorage.token || sessionStorage.token || ''; }
    function authHeader() { return { 'Authorization': 'Bearer ' + getToken(), 'Content-Type': 'application/json' }; }
    function showSpinner() { document.getElementById('globalSpinner').classList.remove('hidden'); }
    function hideSpinner() { document.getElementById('globalSpinner').classList.add('hidden'); }
    function showListingsLoader(show) { document.getElementById('listingsLoader').classList.toggle('hidden', !show); }
    function showSellersLoader(show) { document.getElementById('sellersLoader').classList.toggle('hidden', !show); }
    function showBloggersLoader(show) { document.getElementById('bloggersLoader').classList.toggle('hidden', !show); }
    function showPostsLoader(show) { document.getElementById('postsLoader').classList.toggle('hidden', !show); }

    let allListings = [];
    let allSellers = [];
    let allBloggers = [];
    let allPosts = [];
window.viewBlogPost = function(postId) {
  const post = allPosts.find(p => p._id === postId);
  if (!post) return alert("Could not find post.");
  document.getElementById('postModalContent').innerHTML = `
    <h2 class="font-bold text-2xl text-indigo-800 mb-2">${post.title}</h2>
    <div class="mb-2 text-sm text-gray-500 flex gap-2">
      <span>${post.category || ''}</span>
      <span>${post.date ? new Date(post.date).toLocaleDateString() : ''}</span>
      <span>By: ${post.authorName || ''}</span>
    </div>
    <div class="prose prose-sm max-w-full mb-4">${post.content || '<i>No content</i>'}</div>
    <div class="flex gap-2">
      ${(post.status === "Published" || post.status === "Active") ?
        `<button onclick="approvePost('${post._id}', false);closePostModal()" class="bg-red-100 text-red-700 px-4 py-2 rounded font-bold flex-1">Reject</button>` :
        `<button onclick="approvePost('${post._id}', true);closePostModal()" class="bg-green-100 text-green-700 px-4 py-2 rounded font-bold flex-1">Approve</button>`
      }
      <button onclick="closePostModal()" class="bg-gray-200 text-gray-800 px-4 py-2 rounded font-bold flex-1">Close</button>
    </div>
  `;
  document.getElementById('postModal').classList.remove('hidden');
};
window.closePostModal = function() {
  document.getElementById('postModal').classList.add('hidden');
};
    // === LISTINGS LOGIC ===
    async function fetchAllListings() {
      showListingsLoader(true);
      const res = await fetch(BACKEND + "/api/blogger-dashboard/admin/alllistings", { headers: authHeader() });
      showListingsLoader(false);
      return res.ok ? await res.json() : [];
    }
    async function fetchAllSellers() {
      showSellersLoader(true);
      const res = await fetch(BACKEND + "/api/users?role=seller", { headers: authHeader() });
      showSellersLoader(false);
      const data = await res.json();
      return Array.isArray(data.users) ? data.users : Array.isArray(data) ? data : [];
    }
async function fetchAllBloggers() {
  showBloggersLoader(true);
  // Fetch both blogger and pending_blogger roles
  const [bloggerRes, pendingRes] = await Promise.all([
    fetch(BACKEND + "/api/users?role=blogger", { headers: authHeader() }),
    fetch(BACKEND + "/api/users?role=pending_blogger", { headers: authHeader() })
  ]);
  showBloggersLoader(false);
  let bloggers = [];
  let pendingBloggers = [];
  try {
    const data1 = await bloggerRes.json();
    const data2 = await pendingRes.json();
    bloggers = Array.isArray(data1.users) ? data1.users : Array.isArray(data1) ? data1 : [];
    pendingBloggers = Array.isArray(data2.users) ? data2.users : Array.isArray(data2) ? data2 : [];
  } catch {}
  // Merge and deduplicate by _id
  const all = [...bloggers, ...pendingBloggers];
  const seen = new Set();
  return all.filter(b => {
    if (seen.has(b._id)) return false;
    seen.add(b._id);
    return true;
  });
}
    async function fetchAllPosts() {
      showPostsLoader(true);
      const res = await fetch(BACKEND + "/api/blogger-dashboard/admin/allposts", { headers: authHeader() });
      showPostsLoader(false);
      return res.ok ? await res.json() : [];
    }
    async function updateListingStatus(listingId, update) {
      showSpinner();
      const res = await fetch(BACKEND + `/api/blogger-dashboard/admin/listings/${listingId}`, {
        method: "PATCH",
        headers: authHeader(),
        body: JSON.stringify(update)
      });
      hideSpinner();
      return res.ok;
    }
    async function updateUserApproval(userId, approved) {
      showSpinner();
      const res = await fetch(BACKEND + `/api/users/${userId}/approval`, {
        method: "PATCH",
        headers: authHeader(),
        body: JSON.stringify({ approved })
      });
      hideSpinner();
      return res.ok;
    }
    async function updatePostApproval(postId, approved) {
      showSpinner();
      const res = await fetch(BACKEND + `/api/blogger-dashboard/admin/posts/${postId}/approval`, {
        method: "PATCH",
        headers: authHeader(),
        body: JSON.stringify({ approved, status: approved ? "Published" : "Draft" })
      });
      hideSpinner();
      return res.ok;
    }
    function badge(status, approved) {
      if (approved) return `<span class="px-2 py-1 rounded text-xs badge-approved font-semibold">Approved</span>`;
      if (status === "Unpublished" || status === "rejected" || status === "Pending Approval") return `<span class="px-2 py-1 rounded text-xs badge-rejected font-semibold">Pending/Rejected</span>`;
      return `<span class="px-2 py-1 rounded text-xs badge-pending font-semibold">Pending</span>`;
    }
    function listingCard(listing) {
      return `
        <div class="bg-white rounded-xl shadow border flex flex-col relative overflow-hidden">
          <div class="flex items-center justify-center bg-gray-100 h-44">
            <img src="${listing.img || listing.imageUrl || ''}" alt="${listing.title}" class="h-40 object-contain rounded max-w-full" />
          </div>
          <div class="p-4 flex-1 flex flex-col">
            <div class="flex items-center justify-between mb-2">
              <span class="font-bold text-lg text-blue-900 truncate">${listing.title}</span>
              ${badge(listing.status, listing.approved)}
            </div>
            <span class="inline-block text-xs bg-blue-100 text-blue-800 px-2 py-1 rounded mb-2">${listing.category || ''}</span>
            <div class="mb-2 text-sm text-gray-700 line-clamp-2">${listing.description || ''}</div>
            <div class="text-yellow-700 font-bold text-lg mb-2">‚Ç¶${(listing.price || 0).toLocaleString()}</div>
            <div class="flex items-center text-xs mb-2">
              <span class="mr-2 text-gray-500">Seller:</span>
              <button onclick="viewSeller('${listing.sellerId}')" class="text-blue-700 hover:underline font-semibold mr-2">View Seller</button>
            </div>
            <div class="flex gap-2 mt-auto">
              ${listing.approved ? 
                `<button onclick="setApproval('${listing._id}', false)" class="bg-red-100 text-red-700 px-2 py-1 rounded font-bold flex-1">Reject</button>` :
                `<button onclick="setApproval('${listing._id}', true)" class="bg-green-100 text-green-700 px-2 py-1 rounded font-bold flex-1">Approve</button>`
              }
              <button onclick="unpublishListing('${listing._id}')" class="bg-gray-200 text-gray-800 px-2 py-1 rounded font-bold flex-1">Unpublish</button>
            </div>
          </div>
        </div>
      `;
    }
    function sellerCard(seller) {
      return `
        <div class="bg-white rounded-xl shadow border flex flex-col items-center p-6 text-center">
          <img src="${seller.profilePic || 'https://ui-avatars.com/api/?name='+encodeURIComponent(seller.fullname||'User')+'&background=FFCE45&color=263159&rounded=true'}"
            class="w-20 h-20 rounded-full border-4 border-yellow-400 mb-4" />
          <div class="font-bold text-lg text-blue-900 mb-1">${seller.fullname || seller.username || 'Seller'}</div>
          <div class="text-gray-500 text-sm mb-2 break-all">${seller.email || ''}</div>
          <div class="text-xs text-gray-700 mb-2"><b>Joined:</b> ${seller.createdAt ? new Date(seller.createdAt).toLocaleDateString() : ''}</div>
          <div class="text-gray-700 text-sm mb-2">${seller.bio || '‚Äî'}</div>
          <div class="mb-2">
            Status: ${seller.approved ? `<span class="badge-approved px-2 py-1 rounded text-xs">Approved</span>` : `<span class="badge-pending px-2 py-1 rounded text-xs">Pending</span>`}
          </div>
          <div class="flex gap-2 w-full mt-2">
            ${seller.approved ? 
              `<button onclick="approveUser('${seller._id}', false)" class="bg-red-100 text-red-700 px-2 py-1 rounded font-bold flex-1">Reject</button>` :
              `<button onclick="approveUser('${seller._id}', true)" class="bg-green-100 text-green-700 px-2 py-1 rounded font-bold flex-1">Approve</button>`
            }
            <button onclick="viewSeller('${seller._id}')" class="bg-indigo-100 text-blue-900 font-semibold px-4 py-2 rounded shadow hover:bg-indigo-200 transition flex-1">View Profile</button>
          </div>
        </div>
      `;
    }
    function bloggerCard(blogger) {
      return `
        <div class="bg-white rounded-xl shadow border flex flex-col items-center p-6 text-center">
          <img src="${blogger.passport || 'https://ui-avatars.com/api/?name='+encodeURIComponent(blogger.fullname||'User')+'&background=FFCE45&color=263159&rounded=true'}"
            class="w-20 h-20 rounded-full border-4 border-yellow-400 mb-4 object-contain" />
          <div class="font-bold text-lg text-blue-900 mb-1">${blogger.fullname || blogger.username || 'Blogger'}</div>
          <div class="text-gray-500 text-sm mb-2 break-all">${blogger.email || ''}</div>
          <div class="text-xs text-gray-700 mb-2"><b>Joined:</b> ${blogger.createdAt ? new Date(blogger.createdAt).toLocaleDateString() : ''}</div>
          <div class="text-gray-700 text-sm mb-2">${blogger.institution || ''}</div>
          <div class="mb-2">
            Status: ${blogger.approved ? `<span class="badge-approved px-2 py-1 rounded text-xs">Approved</span>` : `<span class="badge-pending px-2 py-1 rounded text-xs">Pending</span>`}
          </div>
          <div class="flex gap-2 w-full mt-2">
            ${blogger.approved ? 
              `<button onclick="approveBlogger('${blogger._id}', false)" class="bg-red-100 text-red-700 px-2 py-1 rounded font-bold flex-1">Reject</button>` :
              `<button onclick="approveBlogger('${blogger._id}', true)" class="bg-green-100 text-green-700 px-2 py-1 rounded font-bold flex-1">Approve</button>`
            }
            <button onclick="viewBlogger('${blogger._id}')" class="bg-indigo-100 text-blue-900 font-semibold px-4 py-2 rounded shadow hover:bg-indigo-200 transition flex-1">View Profile</button>
          </div>
        </div>
      `;
    }
    function postCard(post) {
  return `
    <div class="bg-white rounded-xl shadow border flex flex-col p-4 max-w-full">
      <h3 class="font-bold text-lg text-indigo-800 mb-1 truncate">${post.title}</h3>
      <div class="flex items-center gap-2 mb-2">
        <span class="text-xs bg-blue-100 text-blue-800 px-2 py-1 rounded">${post.category || ''}</span>
        <span class="text-xs">${post.status || 'Pending'}</span>
      </div>
      <div class="text-gray-800 text-sm mb-2 line-clamp-3 break-words">${(post.content || '').replace(/(<([^>]+)>)/gi, '').slice(0, 150)}...</div>
      <div class="flex-1"></div>
      <div class="flex justify-between items-center mt-2 gap-2">
        <span class="text-xs text-gray-500">By: ${post.authorName || ''}</span>
        <span class="text-xs text-gray-500">${post.date ? new Date(post.date).toLocaleDateString() : ''}</span>
      </div>
      <div class="flex gap-2 mt-2">
        <button onclick="viewBlogPost('${post._id}')" class="bg-indigo-100 text-indigo-900 px-2 py-1 rounded font-bold flex-1">View Post</button>
        ${(post.status === "Published" || post.status === "Active") ?
          `<button onclick="approvePost('${post._id}', false)" class="bg-red-100 text-red-700 px-2 py-1 rounded font-bold flex-1">Reject</button>` :
          `<button onclick="approvePost('${post._id}', true)" class="bg-green-100 text-green-700 px-2 py-1 rounded font-bold flex-1">Approve</button>`
        }
      </div>
    </div>
  `;
    }
    async function renderListings() {
      const grid = document.getElementById('listingsGrid');
      let filtered = allListings;
      const q = document.getElementById('searchInput').value.trim().toLowerCase();
      const filter = document.getElementById('statusFilter').value;
      if (q) {
        filtered = filtered.filter(l =>
          (l.title && l.title.toLowerCase().includes(q)) ||
          (l.category && l.category.toLowerCase().includes(q)) ||
          (l.description && l.description.toLowerCase().includes(q)) ||
          (l.sellerId && (allSellers.find(s => s._id === l.sellerId)?.fullname || '').toLowerCase().includes(q))
        );
      }
      if (filter) {
        if (filter === "approved") filtered = filtered.filter(l => l.approved);
        else if (filter === "pending") filtered = filtered.filter(l => !l.approved && (!l.status || l.status === "Pending" || l.status === "Active"));
        else if (filter === "rejected" || filter === "unpublished") filtered = filtered.filter(l => l.status === "Unpublished" || l.status === "rejected");
      }
      if (!filtered.length) {
        grid.innerHTML = `<div class="col-span-3 text-center text-lg text-gray-400 py-12">No listings found.</div>`;
        return;
      }
      grid.innerHTML = filtered.map(listingCard).join("");
    }
    async function renderSellers(status = "all") {
      const grid = document.getElementById('sellersGrid');
      let filtered = allSellers;
      if (status === "approved") filtered = filtered.filter(u => u.approved);
      else if (status === "pending") filtered = filtered.filter(u => !u.approved);
      if (!filtered.length) {
        grid.innerHTML = `<div class="col-span-3 text-center text-lg text-gray-400 py-12">No sellers found.</div>`;
        return;
      }
      grid.innerHTML = filtered.map(sellerCard).join("");
    }
    async function renderBloggers(status = "all") {
      const grid = document.getElementById('bloggersGrid');
      let filtered = allBloggers;
      if (status === "approved") filtered = filtered.filter(u => u.approved);
      else if (status === "pending") filtered = filtered.filter(u => !u.approved);
      if (!filtered.length) {
        grid.innerHTML = `<div class="col-span-3 text-center text-lg text-gray-400 py-12">No bloggers/marketers found.</div>`;
        return;
      }
      grid.innerHTML = filtered.map(bloggerCard).join("");
    }
    async function renderPosts(status = "all") {
      const grid = document.getElementById('postsGrid');
      let filtered = allPosts;
      if (status === "approved") filtered = filtered.filter(p => p.status === "Published" || p.status === "Active");
      else if (status === "pending") filtered = filtered.filter(p => p.status !== "Published" && p.status !== "Active");
      if (!filtered.length) {
        grid.innerHTML = `<div class="col-span-3 text-center text-lg text-gray-400 py-12">No blog posts found.</div>`;
        return;
      }
      grid.innerHTML = filtered.map(postCard).join("");
    }
    async function loadListingsTab() {
      showListingsLoader(true);
      allListings = await fetchAllListings();
      allSellers = await fetchAllSellers();
      showListingsLoader(false);
      renderListings();
      updateAnalytics();
    }
    async function loadSellersTab() {
      showSellersLoader(true);
      allSellers = await fetchAllSellers();
      showSellersLoader(false);
      renderSellers();
      updateAnalytics();
    }
    async function loadBloggersTab() {
      showBloggersLoader(true);
      allBloggers = await fetchAllBloggers();
      showBloggersLoader(false);
      renderBloggers();
      updateAnalytics();
    }
    async function loadPostsTab() {
      showPostsLoader(true);
      allPosts = await fetchAllPosts();
      showPostsLoader(false);
      renderPosts();
      updateAnalytics();
    }
    window.setApproval = async function(listingId, approve) {
      const ok = await updateListingStatus(listingId, { approved: approve, status: approve ? "Active" : "Unpublished" });
      if (!ok) alert("Failed to update listing status.");
      await loadListingsTab();
    };
    window.unpublishListing = async function(listingId) {
      const ok = await updateListingStatus(listingId, { status: "Unpublished", approved: false });
      if (!ok) alert("Failed to unpublish listing.");
      await loadListingsTab();
    };
    window.approveUser = async function(userId, approve) {
      const ok = await updateUserApproval(userId, approve);
      if (!ok) alert("Failed to update user approval.");
      await loadSellersTab();
    };
    window.approveBlogger = async function(userId, approve) {
      const ok = await updateUserApproval(userId, approve);
      if (!ok) alert("Failed to update blogger approval.");
      await loadBloggersTab();
    };
    window.approvePost = async function(postId, approve) {
      const ok = await updatePostApproval(postId, approve);
      if (!ok) alert("Failed to update post approval.");
      await loadPostsTab();
    };
    window.viewSeller = function(userId) {
      const seller = allSellers.find(s => s._id === userId);
      if (!seller) return alert("Could not fetch seller details.");
      document.getElementById('sellerModalContent').innerHTML = `
        <div class="flex flex-col items-center mb-4">
          <img src="${seller.profilePic || 'https://ui-avatars.com/api/?name='+encodeURIComponent(seller.fullname||'User')+'&background=FFCE45&color=263159&rounded=true'}"
            class="w-20 h-20 rounded-full border-4 border-yellow-400 mb-2" />
          <div class="font-bold text-lg text-blue-900">${seller.fullname || seller.username || 'Seller'}</div>
          <div class="text-gray-500">${seller.email || ''}</div>
        </div>
        <div>
          <div class="mb-1"><b>Phone:</b> <span class="text-gray-800">${seller.phone || 'N/A'}</span></div>
          <div class="mb-1"><b>Joined:</b> <span class="text-gray-800">${seller.createdAt ? new Date(seller.createdAt).toLocaleDateString() : ''}</span></div>
          <div class="mb-1"><b>Bio:</b> <span class="text-gray-800">${seller.bio || '‚Äî'}</span></div>
        </div>
      `;
      document.getElementById('sellerModal').classList.remove('hidden');
    };
    window.viewBlogger = function(userId) {
      const blogger = allBloggers.find(b => b._id === userId);
      if (!blogger) return alert("Could not fetch blogger details.");
      document.getElementById('sellerModalContent').innerHTML = `
        <div class="flex flex-col items-center mb-4">
          <img src="${blogger.passport || 'https://ui-avatars.com/api/?name='+encodeURIComponent(blogger.fullname||'User')+'&background=FFCE45&color=263159&rounded=true'}"
            class="w-20 h-20 rounded-full border-4 border-yellow-400 mb-2 object-contain" />
          <div class="font-bold text-lg text-blue-900">${blogger.fullname || blogger.username || 'Blogger'}</div>
          <div class="text-gray-500">${blogger.email || ''}</div>
        </div>
        <div>
          <div class="mb-1"><b>Phone:</b> <span class="text-gray-800">${blogger.phone || 'N/A'}</span></div>
          <div class="mb-1"><b>Joined:</b> <span class="text-gray-800">${blogger.createdAt ? new Date(blogger.createdAt).toLocaleDateString() : ''}</span></div>
          <div class="mb-1"><b>Institution:</b> <span class="text-gray-800">${blogger.institution || '‚Äî'}</span></div>
          <div class="mb-1"><b>Role:</b> <span class="text-gray-800">${blogger.role || '‚Äî'}</span></div>
        </div>
      `;
      document.getElementById('sellerModal').classList.remove('hidden');
    };
    window.closeSellerModal = function() {
      document.getElementById('sellerModal').classList.add('hidden');
    };
    // Seller, Blogger, Post tab filter logic
    document.querySelectorAll('.seller-tab-btn').forEach(btn => {
      btn.addEventListener('click', function() {
        document.querySelectorAll('.seller-tab-btn').forEach(b => b.classList.remove('font-bold', 'bg-indigo-200'));
        this.classList.add('font-bold', 'bg-indigo-200');
        renderSellers(this.dataset.status);
      });
    });
    document.querySelectorAll('.blogger-tab-btn').forEach(btn => {
      btn.addEventListener('click', function() {
        document.querySelectorAll('.blogger-tab-btn').forEach(b => b.classList.remove('font-bold', 'bg-indigo-200'));
        this.classList.add('font-bold', 'bg-indigo-200');
        renderBloggers(this.dataset.status);
      });
    });
    document.querySelectorAll('.post-tab-btn').forEach(btn => {
      btn.addEventListener('click', function() {
        document.querySelectorAll('.post-tab-btn').forEach(b => b.classList.remove('font-bold', 'bg-indigo-200'));
        this.classList.add('font-bold', 'bg-indigo-200');
        renderPosts(this.dataset.status);
      });
    });

    // === ANALYTICS ===
    function updateAnalytics() {
      document.getElementById('totalListings').textContent = allListings.length;
      document.getElementById('totalSellers').textContent = allSellers.length;
      document.getElementById('totalBloggers').textContent = allBloggers.length;
      document.getElementById('approvedListings').textContent = allListings.filter(l => l.approved).length;
      document.getElementById('totalPosts').textContent = allPosts.length;
    }

    // === TABS ===
    function tabSwitch(tabName) {
      document.querySelectorAll('[data-tab]').forEach(b => b.classList.remove('tab-btn-active'));
      document.querySelector(`[data-tab="${tabName}"]`).classList.add('tab-btn-active');
      document.querySelectorAll('.tab-content').forEach(tab => tab.classList.add('hidden'));
      document.getElementById('tab-' + tabName).classList.remove('hidden');
      if (tabName === 'listings') loadListingsTab();
      if (tabName === 'sellers') loadSellersTab();
      if (tabName === 'bloggers') loadBloggersTab();
      if (tabName === 'posts') loadPostsTab();
      if (tabName === 'analytics') updateAnalytics();
    }
    document.querySelectorAll('[data-tab]').forEach(btn => {
      btn.addEventListener('click', function () { tabSwitch(this.dataset.tab); });
    });
    document.getElementById('searchInput').addEventListener('input', renderListings);
    document.getElementById('statusFilter').addEventListener('change', renderListings);

    document.getElementById('helpForm').addEventListener('submit', function(e){
      e.preventDefault();
      const helpInput = document.getElementById('helpInput');
      if (helpInput.value.trim()) {
        const box = document.getElementById('helpBox');
        box.innerHTML += `<div class="mb-1"><span class="font-semibold text-blue-900">You:</span> ${helpInput.value}</div>`;
        box.scrollTop = box.scrollHeight;
        helpInput.value = "";
      }
    });

    window.addEventListener('DOMContentLoaded', () => {
      tabSwitch('listings');
    });
  </script>
</body>
</html>
