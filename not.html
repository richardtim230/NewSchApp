<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ExamGuard Support Chatbot - Gemini Powered</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/flowbite/2.2.1/flowbite.min.css" rel="stylesheet"/>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/flowbite/2.2.1/flowbite.min.js"></script>
  <link rel="icon" href="https://cdn-icons-png.flaticon.com/512/2282/2282759.png">
  <style>
    .chatbot-fade-in { animation: fadeIn 0.3s ease; }
    @keyframes fadeIn { from { opacity: 0; transform: scale(0.96);} to {opacity:1; transform: scale(1);} }
    .chatbot-message-bot {
      background: linear-gradient(90deg, #dbeafe 60%, #e0e7ff 100%);
      color: #1e3a8a;
      align-self: flex-start;
    }
    .chatbot-message-user {
      background: linear-gradient(90deg, #facc15 60%, #fde68a 100%);
      color: #7c5702;
      align-self: flex-end;
    }
    .chatbot-message-img {
      max-width: 140px;
      max-height: 160px;
      border-radius: 0.7em;
      object-fit: cover;
      margin-top: 0.25rem;
      margin-bottom: 0.25rem;
      box-shadow: 0 2px 8px #0001;
      border: 2px solid #e0e7ff;
    }
    .chatbot-scroll::-webkit-scrollbar {
      width: 5px;
      background: #f3f4f6;
    }
    .chatbot-scroll::-webkit-scrollbar-thumb {
      background: #d1d5db;
      border-radius: 8px;
    }
    .chatbot-scroll { scrollbar-width: thin; scrollbar-color: #d1d5db #f3f4f6; }
    #chatbotFile { display: none; }
    .chatbot-file-label {
      display: flex;
      align-items: center;
      padding: 0.5rem 0.75rem;
      border-radius: 9999px;
      background: #f1f5f9;
      color: #1e3a8a;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      margin-right: 0.5rem;
      transition: background 0.2s;
    }
    .chatbot-file-label:hover { background: #e0e7ff; }
    .chat-link-btn {
      display: inline-block;
      margin: 0.4em 0.3em 0 0;
      padding: 0.5em 1.2em;
      color: #fff !important;
      background: #2563eb;
      border-radius: 9999px;
      font-weight: 600;
      font-size: 1em;
      text-decoration: none;
      box-shadow: 0 2px 8px #1e40af22;
      transition: background 0.2s, color 0.2s;
    }
    .chat-link-btn:hover, .chat-link-btn:focus { background: #facc15; color: #1e3a8a !important; }
    .gemini-typing::after {
      content: '';
      display: inline-block;
      width: 1em;
      height: 1em;
      border-radius: 50%;
      background: #2563eb;
      animation: blink 1s infinite;
      vertical-align: middle;
      margin-left: .35em;
    }
    @keyframes blink { 50% { opacity: 0.3; } }
  </style>
</head>
<body class="bg-blue-50 text-blue-900">
  <!-- Chat Toggle Button -->
  <button id="chatbotToggleBtn"
    class="fixed z-40 bottom-8 right-4 flex items-center gap-2 bg-blue-700 text-white px-5 py-3 rounded-full shadow-lg hover:bg-yellow-400 hover:text-blue-900 transition text-lg font-bold focus:outline-none">
    <svg class="w-7 h-7 mr-1" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" d="M17 8h2a2 2 0 0 1 2 2v10a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V10a2 2 0 0 1 2-2h2"/>
      <path stroke-linecap="round" stroke-linejoin="round" d="M15 3H9a2 2 0 0 0-2 2v2h10V5a2 2 0 0 0-2-2z"/>
    </svg>
    Support
  </button>

  <!-- Chat Modal -->
  <div id="chatbotModal"
    class="hidden fixed inset-0 z-50 flex items-end sm:items-center justify-center bg-black/30">
    <div
      class="chatbot-fade-in bg-white rounded-xl shadow-2xl w-[97vw] max-w-xs sm:max-w-sm md:max-w-sm lg:max-w-xs relative flex flex-col mb-4"
      style="min-width: 320px; max-width: 350px; min-height: 440px; max-height: 590px;">
      <!-- Modal Header -->
      <div class="flex items-center justify-between px-5 py-4 border-b border-blue-100 bg-blue-700 rounded-t-xl">
        <div class="flex items-center gap-2">
          <img src="https://cdn-icons-png.flaticon.com/512/2282/2282759.png" class="w-8 h-8 rounded-full" alt="ExamGuard Support">
          <span class="font-bold text-lg text-white">ExamGuard Support</span>
        </div>
        <button id="chatbotCloseBtn" class="text-white hover:text-yellow-400 focus:outline-none">
          <svg class="w-7 h-7" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"/>
          </svg>
        </button>
      </div>
      <!-- Modal Body: Messages -->
      <div id="chatbotMessages" class="flex-1 p-5 overflow-y-auto chatbot-scroll bg-blue-50" style="min-height:360px; max-height:440px;">
        <!-- Messages will go here -->
      </div>
      <!-- Modal Footer: Input -->
      <div class="px-4 py-3 border-t border-blue-100 bg-white rounded-b-xl">
        <form id="chatbotForm" class="flex gap-2 items-center">
          <label for="chatbotFile" class="chatbot-file-label" title="Send Image">
            <svg class="w-6 h-6 text-blue-800" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
              <path d="M15.172 7l-6.586 6.586a2 2 0 102.828 2.828l6.586-6.586a2 2 0 10-2.828-2.828z"/>
              <path d="M16 5l3 3"/>
            </svg>
            <input type="file" id="chatbotFile" accept="image/*">
          </label>
          <input id="chatbotInput" type="text" autocomplete="off" placeholder="Type your question..."
            class="flex-1 w-4 px-4 py-2 rounded-full border border-blue-200 focus:ring-2 focus:ring-blue-500 outline-none text-blue-900 bg-blue-50" required />
          <button type="submit"
            class="bg-yellow-400 text-blue-900 font-bold px-4 py-2 rounded-full shadow hover:bg-blue-700 hover:text-white transition">Send</button>
        </form>
      </div>
    </div>
  </div>
  <script>
    // Gemini API Key - replace with your actual key for production
    const GEMINI_API_KEY = "AIzaSyAcHoajEEKUQ48oHVDSgp2njtjVFDqq_j8"; // <-- PUT YOUR GEMINI API KEY HERE

    // All navigation links for your platform (for button linking)
    const NAV_LINKS = {
      homepage: { text: "Homepage", url: "index.html" },
      marketplace: { text: "Marketplace", url: "index.html#marketplace" },
      fullMarketplace: { text: "Full Marketplace", url: "gen-marketplace.html" },
      blog: { text: "Blog", url: "index.html#blog" },
      blogCommunity: { text: "Blog & Stories", url: "ngg-blog.html" },
      login: { text: "Login", url: "index.html#login" },
      register: { text: "Register", url: "index.html#register" },
      mock: { text: "Mock Exams", url: "mock.html" },
      contact: { text: "Contact Form", url: "index.html#contact" }
    };

    // Elements
    const chatbotToggleBtn = document.getElementById('chatbotToggleBtn');
    const chatbotModal = document.getElementById('chatbotModal');
    const chatbotCloseBtn = document.getElementById('chatbotCloseBtn');
    const chatbotForm = document.getElementById('chatbotForm');
    const chatbotInput = document.getElementById('chatbotInput');
    const chatbotMessages = document.getElementById('chatbotMessages');
    const chatbotFile = document.getElementById('chatbotFile');

    // Modal open/close
    function openChatbot() {
      chatbotModal.classList.remove('hidden');
      setTimeout(() => chatbotInput.focus(), 250);
      chatbotMessages.scrollTop = chatbotMessages.scrollHeight;
    }
    function closeChatbot() {
      chatbotModal.classList.add('hidden');
    }
    chatbotToggleBtn.addEventListener('click', openChatbot);
    chatbotCloseBtn.addEventListener('click', closeChatbot);
    chatbotModal.addEventListener('click', function(e){
      if (e.target === chatbotModal) closeChatbot();
    });

    // Message rendering
    function addMessage(msg, type = "bot", imgUrl = null) {
      const msgDiv = document.createElement('div');
      msgDiv.className = `max-w-[88%] px-4 py-3 mb-3 rounded-2xl shadow text-[1rem] ${type === "bot" ? "chatbot-message-bot" : "chatbot-message-user"} flex flex-col`;
      if (imgUrl) {
        msgDiv.innerHTML = `<img src="${imgUrl}" class="chatbot-message-img mb-1" alt="Sent Image">${msg ? `<span>${msg}</span>` : ""}`;
      } else {
        msgDiv.innerHTML = msg;
      }
      chatbotMessages.appendChild(msgDiv);
      chatbotMessages.scrollTop = chatbotMessages.scrollHeight;
    }

    // Initial welcome message
    function showWelcome() {
      chatbotMessages.innerHTML = '';
      addMessage("ðŸ‘‹ Hi there! How can I help you get around ExamGuard today?");
    }
    showWelcome();

    // --- Gemini Prompting ---
    // Inject links as buttons if Gemini outputs [Homepage], [Marketplace], etc.
    function enrichGeminiResponse(text) {
      // Replace [ButtonLabel] with the proper platform links
      let enriched = text
        .replace(/\[Homepage\]/gi, `<a href="${NAV_LINKS.homepage.url}" class="chat-link-btn">${NAV_LINKS.homepage.text}</a>`)
        .replace(/\[Marketplace\]/gi, `<a href="${NAV_LINKS.marketplace.url}" class="chat-link-btn">${NAV_LINKS.marketplace.text}</a>`)
        .replace(/\[Full Marketplace\]/gi, `<a href="${NAV_LINKS.fullMarketplace.url}" class="chat-link-btn">${NAV_LINKS.fullMarketplace.text}</a>`)
        .replace(/\[Blog\]/gi, `<a href="${NAV_LINKS.blog.url}" class="chat-link-btn">${NAV_LINKS.blog.text}</a>`)
        .replace(/\[Blog & Stories\]/gi, `<a href="${NAV_LINKS.blogCommunity.url}" class="chat-link-btn">${NAV_LINKS.blogCommunity.text}</a>`)
        .replace(/\[Login\]/gi, `<a href="${NAV_LINKS.login.url}" class="chat-link-btn">${NAV_LINKS.login.text}</a>`)
        .replace(/\[Register\]/gi, `<a href="${NAV_LINKS.register.url}" class="chat-link-btn">${NAV_LINKS.register.text}</a>`)
        .replace(/\[Mock Exams\]/gi, `<a href="${NAV_LINKS.mock.url}" class="chat-link-btn">${NAV_LINKS.mock.text}</a>`)
        .replace(/\[Contact Form\]/gi, `<a href="${NAV_LINKS.contact.url}" class="chat-link-btn">${NAV_LINKS.contact.text}</a>`);
      return enriched;
    }

    // Gemini system prompt (make it behave like a helpful human agent)
    const SYSTEM_PROMPT = `
You are ExamGuard's human support agent. Answer every question as a friendly, helpful team member.
- Never say you are an AI or language model.
- Guide users on how to use ExamGuard: homepage, marketplace, blog, login, registration, mock exams, and contact.
- When appropriate, suggest navigation by writing [Homepage], [Marketplace], [Full Marketplace], [Blog], [Blog & Stories], [Login], [Register], [Mock Exams], or [Contact Form] in square brackets to turn into buttons.
- Respond in a conversational, human, supportive tone. Greet users, use first person, and be concise and clear.
- If the user uploads an image, thank them and let them know our team will review it.
- If the question is not about ExamGuard or its features, politely steer them back to platform support.
`;

    // Gemini API call for text (and optionally image)
    async function geminiReply(userMsg, imgBase64) {
      let body;
      // Build Gemini message with system prompt and user content
      let contents = [{ role: "user", parts: [{ text: SYSTEM_PROMPT + "\n" + userMsg }] }];
      if (imgBase64) {
        contents[0].parts.push({ inline_data: { mime_type: "image/png", data: imgBase64.split(',')[1] } });
      }
      body = { contents };

      // Show typing...
      addMessage('<span class="gemini-typing">Typing</span>', "bot");
      const loadingDiv = chatbotMessages.lastChild;

      try {
        // Gemini API (v1beta)
        const res = await fetch("https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=" + GEMINI_API_KEY, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(body)
        });
        const data = await res.json();
        loadingDiv.remove();
        let answer = (data && data.candidates && data.candidates[0]?.content?.parts?.map(p => p.text).join('\n')) ||
                     (data?.candidates?.[0]?.content?.text) || "Sorry, I couldn't process your request. Please try again.";
        // Inject navigation links/buttons as needed
        answer = enrichGeminiResponse(answer);
        addMessage(answer, "bot");
      } catch (e) {
        loadingDiv.remove();
        addMessage("Sorry, there was an error contacting support agent.", "bot");
      }
    }

    // Chat form submit
    chatbotForm.addEventListener('submit', function(e) {
      e.preventDefault();
      const userMsg = chatbotInput.value.trim();
      const imgFile = chatbotFile.files[0];
      if (!userMsg && !imgFile) return;

      if (imgFile) {
        const reader = new FileReader();
        reader.onload = function(ev) {
          addMessage("", "user", ev.target.result);
          if (userMsg) addMessage(userMsg, "user");
          chatbotInput.value = "";
          chatbotFile.value = "";
          geminiReply(userMsg || "[Image uploaded]", ev.target.result);
        };
        reader.readAsDataURL(imgFile);
      } else {
        addMessage(userMsg, "user");
        chatbotInput.value = "";
        geminiReply(userMsg);
      }
      chatbotFile.value = "";
    });

    // Image upload via input
    chatbotFile.addEventListener('change', function() {
      if (chatbotFile.files.length > 0) {
        chatbotInput.focus();
      }
    });

    // Re-show welcome if closed and reopened
    chatbotToggleBtn.addEventListener('click', showWelcome);
  </script>
</body>
</html>
