<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Marketplace | Buyer Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/flowbite/2.5.1/flowbite.min.css" rel="stylesheet" />
  <style>
    body { background: #f3f4f6; }
    .dashboard-section { background: #fff; border-radius: 1.2rem; box-shadow: 0 2px 16px 0 rgba(37,99,235,.08);}
    .spinner { border: 4px solid #e5e7eb; border-top: 4px solid #2563eb; border-radius: 50%; width: 28px; height: 28px; animation: spin 1s linear infinite; }
    @keyframes spin { 100% { transform: rotate(360deg); } }
    .no-scrollbar::-webkit-scrollbar { display: none; }
    .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    .menu-overlay { background: rgba(0,0,0,0.4); }
    @media (min-width: 768px) {
      #cart-items.grid-cards {
        display: grid;
        grid-template-columns: repeat(2, minmax(0, 1fr));
        gap: 1.25rem;
      }
      #wishlist-items.grid-cards {
        display: grid;
        grid-template-columns: repeat(2, minmax(0, 1fr));
        gap: 1.25rem;
      }
    }
    @media (min-width: 1024px) {
      #cart-items.grid-cards,
      #wishlist-items.grid-cards {
        grid-template-columns: repeat(3, minmax(0, 1fr));
      }
    }
    @media (min-width: 768px) {
  #offers-list.grid-cards {
    display: grid;
    grid-template-columns: repeat(2, minmax(0, 1fr));
    gap: 1.25rem;
  }
}
@media (min-width: 1024px) {
  #offers-list.grid-cards {
    grid-template-columns: repeat(3, minmax(0, 1fr));
  }
    }
  </style>
</head>
<body>
  <!-- Navigation -->
  <nav class="bg-white shadow sticky top-0 z-40">
    <div class="max-w-4xl mx-auto flex items-center justify-between px-4 py-4">
      <a href="mart.html" class="flex items-center gap-2">
        <span class="text-2xl font-extrabold text-blue-600">Market<span class="text-gray-900">Place</span></span>
      </a>
      <!-- Desktop Menu -->
      <div class="hidden md:flex items-center gap-6 font-medium">
        <a href="mart.html" class="hover:text-blue-600 transition">Shop</a>
        <a href="mart.html#products-section" class="hover:text-blue-600 transition">Categories</a>
        <a href="#help" class="hover:text-blue-600 transition">Help</a>
        <a href="blog-notes-category" class="hover:text-blue-600 transition">Blog Homepage</a>
        <a href="/" class="hover:text-blue-600 transition">Homepage</a>
        <a href="loader.html" class="hover:text-blue-600 transition">Academics</a>
        <img id="profile-avatar" src="https://ui-avatars.com/api/?name=User&background=FFCE45&color=263159&rounded=true" class="h-9 w-9 rounded-full border-2 border-blue-600 ml-3" alt="User">
      </div>
      <!-- Mobile Hamburger -->
      <button id="mobile-menu-btn" class="md:hidden block focus:outline-none">
        <svg class="w-8 h-8 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-width="2" stroke-linecap="round" stroke-linejoin="round" d="M4 8h16M4 16h16"/>
        </svg>
      </button>
    </div>
    <!-- Mobile Menu Drawer -->
    <div id="mobile-menu-overlay" class="fixed inset-0 z-50 hidden menu-overlay"></div>
    <div id="mobile-menu" class="fixed top-0 right-0 h-full w-64 bg-white shadow-xl z-50 transform translate-x-full transition-transform duration-300">
      <div class="flex items-center justify-between p-4 border-b">
        <span class="text-lg font-bold text-blue-600">Menu</span>
        <button id="close-mobile-menu" class="text-gray-400 hover:text-gray-900">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-width="2" stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"/>
          </svg>
        </button>
      </div>
      <nav class="flex flex-col gap-4 p-4 font-medium">
        <a href="mart.html" class="hover:text-blue-600 transition">Shop</a>
        <a href="mart.html#products-section" class="hover:text-blue-600 transition">Categories</a>
        <a href="#help" class="hover:text-blue-600 transition">Help</a>
        <a href="blog-notes-category" class="hover:text-blue-600 transition">Blog Homepage</a>
        <a href="/" class="hover:text-blue-600 transition">Homepage</a>
        <a href="loader.html" class="hover:text-blue-600 transition">Academics</a>
        <button id="mobile-logout-btn" class="px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700">Logout</button>
      </nav>
      <div class="p-4 flex items-center gap-2 border-t mt-2">
        <img id="mobile-profile-avatar" src="https://ui-avatars.com/api/?name=User&background=FFCE45&color=263159&rounded=true" class="h-9 w-9 rounded-full border-2 border-blue-600" alt="User">
        <span id="mobile-profile-name" class="font-semibold text-blue-800"></span>
      </div>
    </div>
  </nav>
  
<div id="notification-modal" class="fixed inset-0 z-[99] flex items-center justify-center bg-black/30 hidden">
  <div id="notification-content" class="bg-white rounded-lg shadow-lg px-6 py-5 text-center max-w-sm w-full border border-gray-300">
    <div id="notification-icon" class="mx-auto mb-3 text-4xl"></div>
    <div id="notification-text" class="text-lg font-semibold text-gray-800 mb-2"></div>
    <button id="notification-close-btn" class="mt-2 px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 transition">Close</button>
  </div>
</div>

<script>
  // Notification modal logic
  function showNotification({ message, type = "info", icon = "" }) {
    const modal = document.getElementById("notification-modal");
    const content = document.getElementById("notification-content");
    const text = document.getElementById("notification-text");
    const iconElem = document.getElementById("notification-icon");
    text.textContent = message || "";
    iconElem.innerHTML = icon || (type === "success"
      ? "✅"
      : type === "error"
      ? "❌"
      : "ℹ️"
    );
    // Set modal color based on type
    content.className = "bg-white rounded-lg shadow-lg px-6 py-5 text-center max-w-sm w-full border " +
      (type === "success"
        ? "border-green-400"
        : type === "error"
        ? "border-red-400"
        : "border-blue-300");
    modal.classList.remove("hidden");
    document.body.style.overflow = "hidden";
    // Close logic
    document.getElementById("notification-close-btn").onclick = function() {
      modal.classList.add("hidden");
      document.body.style.overflow = "";
    };
    // Auto-close after 2.5s unless user interacts
    setTimeout(() => {
      if (!modal.classList.contains("hidden")) {
        modal.classList.add("hidden");
        document.body.style.overflow = "";
      }
    }, 2500);
  }
</script>
<!-- [ ... your existing code ... ] -->
  <main class="max-w-4xl mx-auto py-8 px-2 sm:px-3">
    <!-- Profile Summary -->
    <section class="dashboard-section p-6 mb-8 flex flex-col sm:flex-row gap-6 items-center w-full">
      <img id="buyer-avatar" src="https://ui-avatars.com/api/?name=User&background=FFCE45&color=263159&rounded=true" class="h-16 w-16 rounded-full border-4 border-blue-600 shadow" />
      <div class="flex-1 text-center sm:text-left">
        <h2 class="text-xl font-bold text-blue-800" id="buyer-name"></h2>
        <div class="text-gray-600 mb-2" id="buyer-email"></div>
        <button id="edit-profile-btn" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 transition mt-2">Edit Profile</button>
      </div>
      <div>
        <button id="logout-btn" class="px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700 transition">Logout</button>
      </div>
    </section>

    <!-- Dashboard Tabs -->
    <nav class="flex gap-2 mb-6 overflow-x-auto no-scrollbar">
      <button class="tab-btn-active px-4 py-2 rounded font-semibold tab-btn" data-tab="cart">Cart</button>
      <button class="tab-btn px-4 py-2 rounded font-semibold tab-btn" data-tab="wishlist">Wishlist</button>
      <button class="tab-btn px-4 py-2 rounded font-semibold tab-btn" data-tab="offers">Offers</button>
      <button class="tab-btn px-4 py-2 rounded font-semibold tab-btn" data-tab="orders">Orders</button>
      <button class="tab-btn px-4 py-2 rounded font-semibold tab-btn" data-tab="messages">Messages</button>
      <button class="tab-btn px-4 py-2 rounded font-semibold tab-btn" data-tab="notifications">Notifications</button>
      <button class="tab-btn px-4 py-2 rounded font-semibold tab-btn" data-tab="help">Help</button>
    </nav>

    <!-- Tab Contents -->
    <section class="dashboard-section p-6 w-full" id="tab-cart">
      <h3 class="text-xl font-bold text-blue-700 mb-4">My Cart</h3>
      <div id="cart-items" class="grid-cards space-y-4"></div>
      <div class="flex flex-col sm:flex-row justify-between items-center mt-8 gap-4">
        <div class="font-bold text-lg text-green-700">
          Total: ₦<span id="cart-total">0</span>
        </div>
        <button id="pay-out-btn" class="px-6 py-3 bg-green-600 text-white rounded-lg shadow hover:bg-green-700 font-bold text-lg transition w-full sm:w-auto">
          Pay Now
        </button>
      </div>
    </section>
    <section class="dashboard-section p-6 hidden w-full" id="tab-wishlist">
      <h3 class="text-xl font-bold text-pink-600 mb-4">Wishlist</h3>
      <div id="wishlist-items" class="grid-cards space-y-4"></div>
    </section>
    <section class="dashboard-section p-6 hidden w-full" id="tab-offers">
      <h3 class="text-xl font-bold text-yellow-600 mb-4">My Offers</h3>
      <div id="offers-list" class="space-y-4"></div>
    </section>
    <section class="dashboard-section p-6 hidden w-full" id="tab-orders">
      <h3 class="text-xl font-bold text-green-700 mb-4">Orders</h3>
      <div id="orders-list" class="space-y-4"></div>
      <div id="orders-payment-section" class="flex flex-col sm:flex-row justify-end items-center gap-5 mt-8"></div>
    </section>
    <section class="dashboard-section p-6 hidden w-full" id="tab-messages">
      <h3 class="text-xl font-bold text-blue-800 mb-4">Messages</h3>
      <div id="messages-list" class="space-y-4"></div>
    </section>
    <section class="dashboard-section p-6 hidden w-full" id="tab-notifications">
      <h3 class="text-xl font-bold text-gray-700 mb-4">Notifications</h3>
      <div id="notifications-list" class="space-y-4"></div>
    </section>
    <section class="dashboard-section p-6 hidden w-full" id="tab-help">
      <h3 class="text-xl font-bold text-indigo-700 mb-4">Help & Support</h3>
      <form id="helpForm" class="flex gap-2">
        <input id="helpInput" type="text" placeholder="Type a support message..." class="flex-1 px-3 py-2 border rounded" required />
        <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded font-bold hover:bg-blue-700 transition">Send</button>
      </form>
      <div id="helpBox" class="mt-4 h-32 overflow-y-auto border rounded p-2 text-sm text-gray-700 bg-blue-50"></div>
    </section>
  </main>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/flowbite/2.5.1/flowbite.min.js"></script>
  <script>
    const BACKEND = "https://examguard-jmvj.onrender.com";
    function getToken() { return localStorage.token || sessionStorage.token || ''; }
    function authHeader() { return { 'Authorization': 'Bearer ' + getToken() }; }

    // --- Tab switching ---
    document.querySelectorAll('.tab-btn').forEach(btn => {
      btn.addEventListener('click', function () {
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('tab-btn-active'));
        this.classList.add('tab-btn-active');
        document.querySelectorAll('.dashboard-section').forEach(tab => tab.classList.add('hidden'));
        document.getElementById('tab-' + this.dataset.tab).classList.remove('hidden');
        if (this.dataset.tab === "cart") loadCart();
        if (this.dataset.tab === "wishlist") loadWishlist();
        if (this.dataset.tab === "offers") loadOffers();
        if (this.dataset.tab === "orders") loadOrders();
        if (this.dataset.tab === "messages") loadMessages();
        if (this.dataset.tab === "notifications") loadNotifications();
      });
    });

    // --- Mobile menu logic ---
    const mobileMenuBtn = document.getElementById('mobile-menu-btn');
    const mobileMenu = document.getElementById('mobile-menu');
    const mobileMenuOverlay = document.getElementById('mobile-menu-overlay');
    const closeMobileMenuBtn = document.getElementById('close-mobile-menu');
    mobileMenuBtn.onclick = function() {
      mobileMenu.classList.remove('translate-x-full');
      mobileMenuOverlay.classList.remove('hidden');
      document.body.style.overflow = 'hidden';
    };
    closeMobileMenuBtn.onclick = function() {
      mobileMenu.classList.add('translate-x-full');
      mobileMenuOverlay.classList.add('hidden');
      document.body.style.overflow = '';
    };
    mobileMenuOverlay.onclick = function() {
      mobileMenu.classList.add('translate-x-full');
      mobileMenuOverlay.classList.add('hidden');
      document.body.style.overflow = '';
    };
    document.getElementById('mobile-logout-btn').onclick = function() {
      localStorage.removeItem("token");
      sessionStorage.removeItem("token");
      window.location.href = "/login";
    };
    
    

    // --- Profile & Auth ---
    async function loadProfile() {
  try {
    const res = await fetch(BACKEND + "/api/auth/me", { headers: authHeader() });
    if (!res.ok) throw new Error("Unauthenticated");
    const data = await res.json();
    window.buyerProfile = data.user || data;
        document.getElementById("buyer-name").textContent = data.user?.fullname || data.user?.username || "Buyer";
        document.getElementById("buyer-email").textContent = data.user?.email || "";
        document.getElementById("buyer-avatar").src = data.user?.profilePic || `https://ui-avatars.com/api/?name=${encodeURIComponent(data.user?.fullname||"Buyer")}&background=FFCE45&color=263159&rounded=true`;
        document.getElementById("profile-avatar").src = data.user?.profilePic || `https://ui-avatars.com/api/?name=${encodeURIComponent(data.user?.fullname||"Buyer")}&background=FFCE45&color=263159&rounded=true`;
        document.getElementById("mobile-profile-avatar").src = data.user?.profilePic || `https://ui-avatars.com/api/?name=${encodeURIComponent(data.user?.fullname||"Buyer")}&background=FFCE45&color=263159&rounded=true`;
        document.getElementById("mobile-profile-name").textContent = data.user?.fullname || data.user?.username || "Buyer";
      } catch {
        window.location.href = "/login";
      }
    }
    document.getElementById('logout-btn').onclick = function() {
      localStorage.removeItem("token");
      sessionStorage.removeItem("token");
      window.location.href = "/login";
    };
    document.getElementById('edit-profile-btn').onclick = function() {
      showNotification({message: "Profile editing coming soon!", type: "info"});
    };

    // --- Cart ---
    async function updateCartQuantity(productId, newQty) {
      await fetch(BACKEND + "/api/cart/add", {
        method: "POST",
        headers: { ...authHeader(), "Content-Type": "application/json" },
        body: JSON.stringify({ productId, quantity: newQty })
      });
      loadCart();
    }

  async function orderCartItems() {
  const res = await fetch(BACKEND + "/api/cart", { headers: authHeader() });
  const cart = await res.json();
  if (!cart.items || !cart.items.length) {
    showNotification({message: "No items to order!", type: "info"});
    return;
  }
  // Place orders for each item
  for (const item of cart.items) {
    if (item.productId) {
      const resp = await orderProduct(item.productId, item.quantity);
      if (!resp.ok) {
        const err = await resp.json();
        showNotification({message: "Order failed: " + (err.error || resp.statusText), type: "error"});
        return;
      }
    }
  }
  // Clear cart after all orders placed
  await fetch(BACKEND + "/api/cart/clear", {
    method: "POST",
    headers: authHeader()
  });
  showNotification({message: "Order(s) placed! Pending payment.", type: "success"});
  loadOrders();
  loadCart();
}

    async function orderProduct(productId, quantity) {
  return await fetch(BACKEND + "/api/orders", {
    method: "POST",
    headers: { ...authHeader(), "Content-Type": "application/json" },
    body: JSON.stringify({ productId, quantity })
  });
}

    async function loadCart() {
  const cartItemsDiv = document.getElementById('cart-items');
  cartItemsDiv.classList.add('grid-cards');
  cartItemsDiv.innerHTML = '<div class="spinner mx-auto my-8"></div>';
  let total = 0;
  try {
    const res = await fetch(BACKEND + "/api/cart", { headers: authHeader() });
    const cart = await res.json();
    if (!cart.items || !cart.items.length) {
      cartItemsDiv.innerHTML = '<div class="text-gray-400 text-center my-6">Your cart is empty.</div>';
      document.getElementById('cart-total').textContent = "0";
      return;
    }
    cartItemsDiv.innerHTML = cart.items.map(item => {
      // Use snapshot fields and enrichments
      const title = item.latestTitle || item.title || "Product";
      const price = Number(item.latestPrice ?? item.price ?? 0);
      total += price * (item.quantity || 1);
      const image = item.latestImage || item.image || 'https://ui-avatars.com/api/?name=Product&background=eee&color=263159&rounded=true';
      const seller = item.latestSellerName || item.sellerName || "Unknown";
      return `
        <div class="flex flex-col sm:flex-row gap-3 items-center bg-gray-50 rounded-xl p-4 shadow border border-gray-200">
          <div class="flex-shrink-0 w-28 h-28 bg-gray-100 rounded-xl flex items-center justify-center overflow-hidden">
            <img src="${image}" class="w-full h-full object-cover" />
          </div>
          <div class="flex-1 w-full flex flex-col gap-2 pl-0 sm:pl-4">
            <div class="flex items-center justify-between">
              <div class="font-semibold text-blue-800 text-lg">${title}</div>
              <button class="px-3 py-1 bg-red-100 text-red-600 font-bold rounded hover:bg-red-200" onclick="removeCartItem('${item.productId}')">Remove</button>
            </div>
            <div class="text-yellow-700 font-bold text-xl">&#8358;${price.toLocaleString()}</div>
            <div class="text-sm text-gray-700">Date Carted: ${item.addedAt ? new Date(item.addedAt).toLocaleDateString() : "-"}</div>
            <div class="text-sm text-gray-700">Seller: ${seller}</div>
            <div class="flex items-center gap-2 mt-2">
              <button class="bg-gray-200 p-2 rounded-full text-gray-900 font-bold text-xl" onclick="changeQty('${item.productId}', -1)">-</button>
              <span class="font-bold text-gray-700 px-2">Qty: x${item.quantity}</span>
              <button class="bg-gray-200 p-2 rounded-full text-gray-900 font-bold text-xl" onclick="changeQty('${item.productId}', 1)">+</button>
            </div>
          </div>
        </div>
      `;
    }).join('');
    document.getElementById('cart-total').textContent = total.toLocaleString();
  } catch {
    cartItemsDiv.innerHTML = '<div class="text-red-500 text-center my-6">Failed to load cart.</div>';
    document.getElementById('cart-total').textContent = "0";
  }
}
    window.changeQty = async function(productId, delta) {
  // Get the current cart, find item, update quantity
  const res = await fetch(BACKEND + "/api/cart", { headers: authHeader() });
  const cart = await res.json();
  const item = cart.items.find(i => i.productId && i.productId === productId);
  if (!item) return;
  let newQty = (item.quantity || 1) + delta;
  if (newQty < 1) newQty = 1;
  // Set the new quantity directly
  await fetch(BACKEND + "/api/cart/update", {
    method: "POST",
    headers: { ...authHeader(), "Content-Type": "application/json" },
    body: JSON.stringify({ productId, quantity: newQty })
  });
  loadCart();
};
    window.removeCartItem = async function(productId) {
      await fetch(BACKEND + "/api/cart/remove", {
        method: "POST",
        headers: { ...authHeader(), "Content-Type": "application/json" },
        body: JSON.stringify({ productId })
      });
      loadCart();
    };
    document.getElementById('pay-out-btn').onclick = async function() {
      await orderCartItems();
    };

    // --- Wishlist ---
    async function loadWishlist() {
      const wishlistItemsDiv = document.getElementById('wishlist-items');
      wishlistItemsDiv.classList.add('grid-cards');
      wishlistItemsDiv.innerHTML = '<div class="spinner mx-auto my-8"></div>';
      try {
        const res = await fetch(BACKEND + "/api/blogger-dashboard/wishlist", { headers: authHeader() });
        const { wishlist } = await res.json();
        if (!wishlist || !wishlist.length) {
          wishlistItemsDiv.innerHTML = '<div class="text-gray-400 text-center my-6">No items in wishlist.</div>';
          return;
        }
        wishlistItemsDiv.innerHTML = wishlist.map(item => `
          <div class="flex flex-col sm:flex-row gap-3 items-center bg-gray-50 rounded-xl p-4 shadow border border-gray-200">
            <div class="flex-shrink-0 w-28 h-28 bg-gray-100 rounded-xl flex items-center justify-center overflow-hidden">
              <img src="${(item.images?.[0] || item.img || item.imageUrl || 'https://ui-avatars.com/api/?name=' + encodeURIComponent(item.title || 'Product') + '&background=eee&color=263159&rounded=true')}" class="object-cover w-full h-full rounded-xl" alt="Wishlist image"/>
            </div>
            <div class="flex-1 w-full flex flex-col gap-2 pl-0 sm:pl-4">
              <div class="flex items-center justify-between">
                <div class="font-semibold text-blue-800 text-lg">${item.title}</div>
                <button class="px-3 py-1 bg-pink-100 text-pink-600 font-semibold rounded hover:bg-pink-200" onclick="removeWishlistItem('${item._id||item.id}')">Remove</button>
              </div>
              <div class="text-yellow-700 font-bold text-xl">&#8358;${Number(item.price||0).toLocaleString()}</div>
              <div class="flex mt-2">
                <button class="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700 font-semibold" onclick="placeOrderFromWishlist('${item._id||item.id}')">Place Order</button>      </div>
            </div>
          </div>
        `).join('');
      } catch {
        wishlistItemsDiv.innerHTML = '<div class="text-red-500 text-center my-6">Failed to load wishlist.</div>';
      }
    }
    // Wishlist removal with feedback
window.removeWishlistItem = async function(listingId) {
  try {
    const response = await fetch(BACKEND + `/api/blogger-dashboard/wishlist/remove/${listingId}`, { method: "DELETE", headers: authHeader() });
    if (response.ok) {
      showNotification({ message: "Item removed from wishlist.", type: "success" });
      loadWishlist();
    } else {
      showNotification({ message: "Failed to remove item from wishlist.", type: "error" });
    }
  } catch {
    showNotification({ message: "Failed to remove item from wishlist.", type: "error" });
  }
};

// Place order from wishlist with feedback
window.placeOrderFromWishlist = async function(listingId) {
  try {
    await orderProduct(listingId, 1);
    showNotification({ message: "Order placed! Pending payment.", type: "success" });
  } catch {
    showNotification({ message: "Failed to place order from wishlist.", type: "error" });
  }
};

    async function loadOffers() {
  const offersList = document.getElementById('offers-list');
  offersList.classList.add('grid-cards');
  offersList.innerHTML = '<div class="spinner mx-auto my-8"></div>';
  try {
    const res = await fetch(BACKEND + "/api/offers/mine", { headers: authHeader() });
    const { offers } = await res.json();
    if (!offers || !offers.length) {
      offersList.innerHTML = '<div class="text-gray-400 text-center my-6">No offers submitted yet.</div>';
      return;
    }
    offersList.innerHTML = await Promise.all(offers.map(async offer => {
      // Fetch product details
      let prod = {};
      try {
        const prodRes = await fetch(BACKEND + `/api/blogger-dashboard/public/listings/${offer.productId}`, { headers: authHeader() });
        if (prodRes.ok) prod = await prodRes.json();
      } catch {}

      // Only enable order button if accepted
      const orderBtnEnabled = offer.status === 'accepted';

      return `
      <div class="flex flex-col sm:flex-row gap-3 items-center bg-yellow-50 rounded-xl p-4 shadow border border-yellow-200">
        <div class="flex-shrink-0 w-28 h-28 bg-gray-100 rounded-xl flex items-center justify-center overflow-hidden">
          <img src="${(prod.images?.[0] || prod.img || prod.imageUrl || 'https://ui-avatars.com/api/?name=' + encodeURIComponent(prod.title || 'Product') + '&background=eee&color=263159&rounded=true')}" class="object-cover w-full h-full rounded-xl" alt="Offer image"/>
        </div>
        <div class="flex-1 w-full flex flex-col gap-2 pl-0 sm:pl-4">
          <div class="flex items-center justify-between">
            <div>
              <div class="font-semibold text-blue-800 text-lg">${prod.title || offer.productTitle || 'Product'}</div>
              <div class="text-sm text-gray-700">Original price: <span class="text-yellow-700 font-bold">&#8358;${Number(prod.price||0).toLocaleString()}</span></div>
              <div class="text-sm text-blue-700">Offer price: <span class="text-yellow-700 font-bold">&#8358;${Number(offer.offerPrice||0).toLocaleString()}</span></div>
            </div>
            <button class="px-4 py-2 bg-green-600 text-white rounded font-semibold shadow ${orderBtnEnabled ? 'hover:bg-green-700' : 'opacity-60 cursor-not-allowed'}" ${orderBtnEnabled ? `onclick="orderOfferProduct('${offer.productId}', '${offer.offerPrice}', '${offer._id}')"` : 'disabled'}>
              Order
            </button>
          </div>
          <div class="flex gap-3 text-xs text-gray-600">
            <span>Date: ${offer.createdAt ? new Date(offer.createdAt).toLocaleDateString() : '-'}</span>
            <span>Status: <span class="${offer.status === 'accepted' ? 'text-green-700 font-bold' : offer.status === 'rejected' ? 'text-red-700 font-bold' : 'text-yellow-700 font-bold'}">${offer.status || 'pending'}</span></span>
          </div>
        </div>
      </div>
      `;
    })).then(htmlArr => htmlArr.join(''));
  } catch {
    offersList.innerHTML = '<div class="text-red-500 text-center my-6">Failed to load offers.</div>';
  }
}

// Helper: order product with agreed price from offer
window.orderOfferProduct = async function(productId, offerPrice, offerId) {
  try {
    await fetch(BACKEND + "/api/orders", {
      method: "POST",
      headers: { ...authHeader(), "Content-Type": "application/json" },
      body: JSON.stringify({
        productId,
        quantity: 1,
        price: offerPrice,
        offerId,
        status: "pending_payment"
      })
    });
    showNotification({message: "Order placed at agreed price! Pending payment.", type: "success"});
    loadOrders();
  } catch {
    showNotification({message: "Failed to place order.", type: "error"});
  }
}

      
  async function loadOrders() {
  document.getElementById('orders-list').innerHTML = '<div class="spinner mx-auto my-8"></div>';
  let total = 0;
  let pendingOrders = [];
  try {
    const res = await fetch(BACKEND + "/api/orders", { headers: authHeader() });
    const { orders } = await res.json();
    if (!orders || !orders.length) {
      document.getElementById('orders-list').innerHTML = '<div class="text-gray-400 text-center my-6">No orders yet.</div>';
      document.getElementById('orders-payment-section').innerHTML = "";
      return;
    }
    document.getElementById('orders-list').innerHTML = orders.map(order => {
      // Use order.price (offer-based orders have correct price!)
      if (order.status === "pending_payment") {
        total += (order.price || 0) * (order.quantity || 1);
        pendingOrders.push(order);
      }
      return `
        <div class="bg-green-50 p-3 rounded shadow flex flex-col sm:flex-row gap-2 items-center">
          <div class="flex-1">
            <div class="font-semibold text-green-700">${order.productTitle || 'Product'}</div>
            <div class="text-gray-700">Qty: x${order.quantity || 1}</div>
            <div class="text-gray-700">Status: ${order.status || "pending_payment"}</div>
            <div class="text-yellow-700 font-bold">&#8358;${Number(order.price || 0).toLocaleString()}</div>
            <div class="text-xs text-gray-500">${order.createdAt ? new Date(order.createdAt).toLocaleDateString() : ''}</div>
          </div>
          <div>
            <button class="px-3 py-1 bg-red-100 text-red-600 font-semibold rounded hover:bg-red-200"
              onclick="removeOrder('${order._id}')"
              ${order.status === 'paid' ? 'disabled style="opacity:0.5;cursor:not-allowed;"' : ''}>
              Remove
            </button>
          </div>
        </div>
      `;
    }).join('');
    // Payment section
    if (pendingOrders.length) {
      document.getElementById('orders-payment-section').innerHTML = `
        <button id="proceed-payment-btn" class="px-6 py-3 bg-blue-600 text-white rounded-lg shadow hover:bg-blue-700 font-bold text-lg transition">
          Proceed to Payment (${total ? '&#8358;' + total.toLocaleString() : '₦0'})
        </button>
      `;
      document.getElementById('proceed-payment-btn').onclick = function() {
        alert("Proceeding to payment for ₦" + total.toLocaleString() + ". (Integrate payment gateway here.)");
      };
    } else {
      document.getElementById('orders-payment-section').innerHTML = "";
    }
  } catch {
    document.getElementById('orders-list').innerHTML = '<div class="text-red-500 text-center my-6">Failed to load orders.</div>';
    document.getElementById('orders-payment-section').innerHTML = "";
  }
}

// Helper for removing/cancelling order
window.removeOrder = async function(orderId) {
  if (!confirm("Remove this order?")) return;
  await fetch(BACKEND + `/api/orders/${orderId}`, {
    method: "DELETE",
    headers: authHeader()
  });
  loadOrders();
};
async function loadMessages() {
  const messagesList = document.getElementById('messages-list');
  messagesList.innerHTML = '<div class="spinner mx-auto my-8"></div>';

  try {
    // Fetch all messages involving this buyer
    const res = await fetch(BACKEND + "/api/massages", { headers: authHeader() });
    const allMessages = await res.json();

    // Group messages by seller and product
    const grouped = {};
    allMessages.forEach(msg => {
      if (!msg.receiverId || !msg.senderId || !msg.productId) return;
      // Unique chat key: sellerId + productId
      const otherId = msg.senderId === buyerProfile._id ? msg.receiverId : msg.senderId;
      const chatKey = otherId + "_" + msg.productId;
      if (!grouped[chatKey]) grouped[chatKey] = { sellerId: otherId, productId: msg.productId, messages: [] };
      grouped[chatKey].messages.push(msg);
    });

    if (!Object.keys(grouped).length) {
      messagesList.innerHTML = `<div class="text-gray-400 text-center my-6">No messages yet.</div>`;
      return;
    }

    // Render each seller+product chat thread
    messagesList.innerHTML = await Promise.all(Object.values(grouped).map(async chat => {
      const msgs = chat.messages;
      const sellerName = msgs.find(m => m.senderId !== buyerProfile._id)?.senderName || msgs[0].receiverName || "Seller";
      let productDetails = "";

      // Fetch product details (show context at top)
      try {
        const prodRes = await fetch(BACKEND + `/api/blogger-dashboard/public/listings/${chat.productId}`, { headers: authHeader() });
        if (prodRes.ok) {
          const prod = await prodRes.json();
          productDetails = `
            <div class="flex items-center gap-3 mb-2">
              <img src="${(prod.images?.[0] || prod.img || prod.imageUrl || 'https://ui-avatars.com/api/?name=' + encodeURIComponent(prod.title || 'Product') + '&background=eee&color=263159&rounded=true')}" class="object-cover w-14 h-14 rounded" alt="Product"/>
              <div>
                <div class="font-semibold text-blue-900 text-sm">${prod.title}</div>
                <div class="text-yellow-700 font-bold text-xs">&#8358;${Number(prod.price || 0).toLocaleString()}</div>
              </div>
            </div>
          `;
        }
      } catch {}

      return `
      <div class="bg-white rounded-xl shadow mb-6 overflow-hidden">
        <div class="px-4 py-3 border-b bg-blue-50 flex items-center gap-2">
          <div class="w-9 h-9 rounded-full bg-blue-200 flex items-center justify-center font-bold text-blue-900">${sellerName[0]}</div>
          <div class="font-semibold text-blue-900">${sellerName}</div>
        </div>
        <div class="px-4 pt-3 pb-1">${productDetails}</div>
        <div class="p-3 bg-gray-50 min-h-[160px] max-h-[320px] overflow-y-auto whatsapp-chat">
          ${msgs.map(msg => `
            <div class="flex ${msg.senderId === buyerProfile._id ? 'justify-end' : 'justify-start'} mb-2">
              <div class="${msg.senderId === buyerProfile._id ? 'bg-green-100 text-green-900' : 'bg-gray-200 text-gray-900'} px-4 py-2 rounded-2xl max-w-[70%] shadow">
                ${msg.text}
                <div class="text-xs text-gray-500 text-right mt-1">${new Date(msg.date).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}</div>
              </div>
            </div>
          `).join('')}
        </div>
        <form class="flex gap-2 p-2 border-t bg-white" onsubmit="return sendChatMessage('${chat.sellerId}', '${chat.productId}', this, event)">
          <input type="text" class="flex-1 border rounded px-3 py-2" name="chatBody" placeholder="Type a message..." required>
          <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded font-bold">Send</button>
        </form>
      </div>
      `;
    })).then(htmlArr => htmlArr.join(''));
  } catch (e) {
    messagesList.innerHTML = `<div class="text-red-500 text-center my-6">Failed to load messages.</div>`;
  }
}

// Helper for sending chat message (WhatsApp-style, with product context)
window.sendChatMessage = async function(sellerId, productId, form, event) {
  if (event) event.preventDefault(); // <-- Prevent the default form submit!
  const input = form.chatBody;
  const text = input.value.trim();
  if (!text) return false;
  try {
    await fetch(BACKEND + "/api/massages", {
      method: "POST",
      headers: { ...authHeader(), "Content-Type": "application/json" },
      body: JSON.stringify({
        sellerId,
        text,
        productId
      })
    });
    input.value = "";
    await loadMessages();
  } catch (e) {
    showNotification({message: "Failed to send message.", type: "error"});
  }
  return false; // <-- Prevent page reload
}
    async function loadNotifications() {
      document.getElementById('notifications-list').innerHTML = '<div class="spinner mx-auto my-8"></div>';
      document.getElementById('notifications-list').innerHTML = '<div class="text-gray-400 text-center my-6">No notifications yet. (Coming soon)</div>';
    }
    document.getElementById('helpForm').addEventListener('submit', function(e){
      e.preventDefault();
      const helpInput = document.getElementById('helpInput');
      if (helpInput.value.trim()) {
        const box = document.getElementById('helpBox');
        box.innerHTML += `<div class="mb-1"><span class="font-semibold text-blue-800">You:</span> ${helpInput.value}</div>`;
        box.scrollTop = box.scrollHeight;
        helpInput.value = "";
      }
    });

  document.addEventListener('DOMContentLoaded', async () => {
  await loadProfile(); // Make sure buyerProfile is loaded before anything else!
  loadCart();
  loadMessages(); // Only call loadMessages after buyerProfile is set
});
  </script>
</body>
</html>
