<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Marketplace | Buyer Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/flowbite/2.5.1/flowbite.min.css" rel="stylesheet" />
  <style>
    body { background: #f3f4f6; }
    .dashboard-section { background: #fff; border-radius: 1.2rem; box-shadow: 0 2px 16px 0 rgba(37,99,235,.08);}
    .spinner { border: 4px solid #e5e7eb; border-top: 4px solid #2563eb; border-radius: 50%; width: 28px; height: 28px; animation: spin 1s linear infinite; }
    @keyframes spin { 100% { transform: rotate(360deg); } }
    .no-scrollbar::-webkit-scrollbar { display: none; }
    .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    .menu-overlay { background: rgba(0,0,0,0.4); }
  </style>
</head>
<body>
  <!-- Navigation -->
  <nav class="bg-white shadow sticky top-0 z-40">
    <div class="max-w-4xl mx-auto flex items-center justify-between px-4 py-4">
      <a href="mart.html" class="flex items-center gap-2">
        <span class="text-2xl font-extrabold text-blue-600">Market<span class="text-gray-900">Place</span></span>
      </a>
      <!-- Desktop Menu -->
      <div class="hidden md:flex items-center gap-6 font-medium">
        <a href="mart.html" class="hover:text-blue-600 transition">Shop</a>
        <a href="mart.html#products-section" class="hover:text-blue-600 transition">Categories</a>
        <a href="#help" class="hover:text-blue-600 transition">Help</a>
        <img id="profile-avatar" src="https://ui-avatars.com/api/?name=User&background=FFCE45&color=263159&rounded=true" class="h-9 w-9 rounded-full border-2 border-blue-600 ml-3" alt="User">
      </div>
      <!-- Mobile Hamburger -->
      <button id="mobile-menu-btn" class="md:hidden block focus:outline-none">
        <svg class="w-8 h-8 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-width="2" stroke-linecap="round" stroke-linejoin="round" d="M4 8h16M4 16h16"/>
        </svg>
      </button>
    </div>
    <!-- Mobile Menu Drawer -->
    <div id="mobile-menu-overlay" class="fixed inset-0 z-50 hidden menu-overlay"></div>
    <div id="mobile-menu" class="fixed top-0 right-0 h-full w-64 bg-white shadow-xl z-50 transform translate-x-full transition-transform duration-300">
      <div class="flex items-center justify-between p-4 border-b">
        <span class="text-lg font-bold text-blue-600">Menu</span>
        <button id="close-mobile-menu" class="text-gray-400 hover:text-gray-900">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-width="2" stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"/>
          </svg>
        </button>
      </div>
      <nav class="flex flex-col gap-4 p-4 font-medium">
        <a href="mart.html" class="hover:text-blue-600 transition">Shop</a>
        <a href="mart.html#products-section" class="hover:text-blue-600 transition">Categories</a>
        <a href="#help" class="hover:text-blue-600 transition">Help</a>
        <button id="mobile-logout-btn" class="px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700">Logout</button>
      </nav>
      <div class="p-4 flex items-center gap-2 border-t mt-2">
        <img id="mobile-profile-avatar" src="https://ui-avatars.com/api/?name=User&background=FFCE45&color=263159&rounded=true" class="h-9 w-9 rounded-full border-2 border-blue-600" alt="User">
        <span id="mobile-profile-name" class="font-semibold text-blue-800"></span>
      </div>
    </div>
  </nav>
  <main class="max-w-4xl mx-auto py-8 px-2 sm:px-3">
    <!-- Profile Summary -->
    <section class="dashboard-section p-6 mb-8 flex flex-col sm:flex-row gap-6 items-center w-full">
      <img id="buyer-avatar" src="https://ui-avatars.com/api/?name=User&background=FFCE45&color=263159&rounded=true" class="h-16 w-16 rounded-full border-4 border-blue-600 shadow" />
      <div class="flex-1 text-center sm:text-left">
        <h2 class="text-xl font-bold text-blue-800" id="buyer-name"></h2>
        <div class="text-gray-600 mb-2" id="buyer-email"></div>
        <button id="edit-profile-btn" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 transition mt-2">Edit Profile</button>
      </div>
      <div>
        <button id="logout-btn" class="px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700 transition">Logout</button>
      </div>
    </section>

    <!-- Dashboard Tabs -->
    <nav class="flex gap-2 mb-6 overflow-x-auto no-scrollbar">
      <button class="tab-btn-active px-4 py-2 rounded font-semibold tab-btn" data-tab="cart">Cart</button>
      <button class="tab-btn px-4 py-2 rounded font-semibold tab-btn" data-tab="wishlist">Wishlist</button>
      <button class="tab-btn px-4 py-2 rounded font-semibold tab-btn" data-tab="offers">Offers</button>
      <button class="tab-btn px-4 py-2 rounded font-semibold tab-btn" data-tab="orders">Orders</button>
      <button class="tab-btn px-4 py-2 rounded font-semibold tab-btn" data-tab="messages">Messages</button>
      <button class="tab-btn px-4 py-2 rounded font-semibold tab-btn" data-tab="notifications">Notifications</button>
      <button class="tab-btn px-4 py-2 rounded font-semibold tab-btn" data-tab="help">Help</button>
    </nav>

    <!-- Tab Contents -->
    <section class="dashboard-section p-6 w-full" id="tab-cart">
      <h3 class="text-xl font-bold text-blue-700 mb-4">My Cart</h3>
      <div id="cart-items" class="space-y-4"></div>
      <div class="flex flex-col sm:flex-row justify-between items-center mt-8 gap-4">
        <div class="font-bold text-lg text-green-700">
          Total: â‚¦<span id="cart-total">0</span>
        </div>
        <button id="pay-out-btn" class="px-6 py-3 bg-green-600 text-white rounded-lg shadow hover:bg-green-700 font-bold text-lg transition w-full sm:w-auto">
          Pay Out
        </button>
      </div>
    </section>
    <section class="dashboard-section p-6 hidden w-full" id="tab-wishlist">
      <h3 class="text-xl font-bold text-pink-600 mb-4">Wishlist</h3>
      <div id="wishlist-items" class="space-y-4"></div>
    </section>
    <section class="dashboard-section p-6 hidden w-full" id="tab-offers">
      <h3 class="text-xl font-bold text-yellow-600 mb-4">My Offers</h3>
      <div id="offers-list" class="space-y-4"></div>
    </section>
    <section class="dashboard-section p-6 hidden w-full" id="tab-orders">
      <h3 class="text-xl font-bold text-green-700 mb-4">Orders</h3>
      <div id="orders-list" class="space-y-4"></div>
    </section>
    <section class="dashboard-section p-6 hidden w-full" id="tab-messages">
      <h3 class="text-xl font-bold text-blue-800 mb-4">Messages</h3>
      <div id="messages-list" class="space-y-4"></div>
    </section>
    <section class="dashboard-section p-6 hidden w-full" id="tab-notifications">
      <h3 class="text-xl font-bold text-gray-700 mb-4">Notifications</h3>
      <div id="notifications-list" class="space-y-4"></div>
    </section>
    <section class="dashboard-section p-6 hidden w-full" id="tab-help">
      <h3 class="text-xl font-bold text-indigo-700 mb-4">Help & Support</h3>
      <form id="helpForm" class="flex gap-2">
        <input id="helpInput" type="text" placeholder="Type a support message..." class="flex-1 px-3 py-2 border rounded" required />
        <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded font-bold hover:bg-blue-700 transition">Send</button>
      </form>
      <div id="helpBox" class="mt-4 h-32 overflow-y-auto border rounded p-2 text-sm text-gray-700 bg-blue-50"></div>
    </section>
  </main>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/flowbite/2.5.1/flowbite.min.js"></script>
  <script>
    const BACKEND = "https://examguide.onrender.com";
    function getToken() { return localStorage.token || sessionStorage.token || ''; }
    function authHeader() { return { 'Authorization': 'Bearer ' + getToken() }; }
    // --- Tab switching ---
    document.querySelectorAll('.tab-btn').forEach(btn => {
      btn.addEventListener('click', function () {
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('tab-btn-active'));
        this.classList.add('tab-btn-active');
        document.querySelectorAll('.dashboard-section').forEach(tab => tab.classList.add('hidden'));
        document.getElementById('tab-' + this.dataset.tab).classList.remove('hidden');
        if (this.dataset.tab === "cart") loadCart();
        if (this.dataset.tab === "wishlist") loadWishlist();
        if (this.dataset.tab === "offers") loadOffers();
        if (this.dataset.tab === "orders") loadOrders();
        if (this.dataset.tab === "messages") loadMessages();
        if (this.dataset.tab === "notifications") loadNotifications();
      });
    });

    // --- Mobile menu logic ---
    const mobileMenuBtn = document.getElementById('mobile-menu-btn');
    const mobileMenu = document.getElementById('mobile-menu');
    const mobileMenuOverlay = document.getElementById('mobile-menu-overlay');
    const closeMobileMenuBtn = document.getElementById('close-mobile-menu');
    mobileMenuBtn.onclick = function() {
      mobileMenu.classList.remove('translate-x-full');
      mobileMenuOverlay.classList.remove('hidden');
      document.body.style.overflow = 'hidden';
    };
    closeMobileMenuBtn.onclick = function() {
      mobileMenu.classList.add('translate-x-full');
      mobileMenuOverlay.classList.add('hidden');
      document.body.style.overflow = '';
    };
    mobileMenuOverlay.onclick = function() {
      mobileMenu.classList.add('translate-x-full');
      mobileMenuOverlay.classList.add('hidden');
      document.body.style.overflow = '';
    };
    document.getElementById('mobile-logout-btn').onclick = function() {
      localStorage.removeItem("token");
      sessionStorage.removeItem("token");
      window.location.href = "/login";
    };

    // --- Profile & Auth ---
    async function loadProfile() {
      try {
        const res = await fetch(BACKEND + "/api/auth/me", { headers: authHeader() });
        if (!res.ok) throw new Error("Unauthenticated");
        const data = await res.json();
        document.getElementById("buyer-name").textContent = data.user?.fullname || data.user?.username || "Buyer";
        document.getElementById("buyer-email").textContent = data.user?.email || "";
        document.getElementById("buyer-avatar").src = data.user?.profilePic || `https://ui-avatars.com/api/?name=${encodeURIComponent(data.user?.fullname||"Buyer")}&background=FFCE45&color=263159&rounded=true`;
        document.getElementById("profile-avatar").src = data.user?.profilePic || `https://ui-avatars.com/api/?name=${encodeURIComponent(data.user?.fullname||"Buyer")}&background=FFCE45&color=263159&rounded=true`;
        document.getElementById("mobile-profile-avatar").src = data.user?.profilePic || `https://ui-avatars.com/api/?name=${encodeURIComponent(data.user?.fullname||"Buyer")}&background=FFCE45&color=263159&rounded=true`;
        document.getElementById("mobile-profile-name").textContent = data.user?.fullname || data.user?.username || "Buyer";
      } catch {
        window.location.href = "/login";
      }
    }
    document.getElementById('logout-btn').onclick = function() {
      localStorage.removeItem("token");
      sessionStorage.removeItem("token");
      window.location.href = "/login";
    };
    document.getElementById('edit-profile-btn').onclick = function() {
      alert("Profile editing coming soon!");
    };

    // --- Cart ---
    async function loadCart() {
      document.getElementById('cart-items').innerHTML = '<div class="spinner mx-auto my-8"></div>';
      let total = 0;
      try {
        const res = await fetch(BACKEND + "/api/cart", { headers: authHeader() });
        const cart = await res.json();
        if (!cart.items || !cart.items.length) {
          document.getElementById('cart-items').innerHTML = '<div class="text-gray-400 text-center my-6">Your cart is empty.</div>';
          document.getElementById('cart-total').textContent = "0";
          return;
        }
        document.getElementById('cart-items').innerHTML = cart.items.map(item => {
          const prod = item.productId;
          // Defensive fallback if product missing
          if (!prod) {
            return `
              <div class="flex flex-col sm:flex-row gap-4 items-center bg-red-50 rounded-lg p-3 shadow border border-red-200">
                <div class="flex-shrink-0 w-24 h-24 bg-gray-100 rounded-lg flex items-center justify-center text-gray-400">No Image</div>
                <div class="flex-1 w-full">
                  <div class="font-semibold text-red-700">Product unavailable</div>
                  <div class="text-gray-500 text-sm mb-2">This item may have been deleted.</div>
                  <button class="px-4 py-2 bg-red-500 text-white rounded hover:bg-red-600" onclick="removeCartItem('${item._id}')">Remove</button>
                </div>
              </div>
            `;
          }
          let price = Number(prod.price || 0);
          total += price * (item.quantity || 1);
          return `
            <div class="flex flex-col sm:flex-row gap-3 items-center bg-gray-50 rounded-xl p-4 shadow border border-gray-200">
              <div class="flex-shrink-0 w-28 h-28 bg-gray-100 rounded-xl flex items-center justify-center overflow-hidden">
                <img src="${(prod.images?.[0] || prod.img || prod.imageUrl || 'https://ui-avatars.com/api/?name=' + encodeURIComponent(prod.title || 'Product') + '&background=eee&color=263159&rounded=true')}" class="object-cover w-full h-full rounded-xl" alt="Product image"/>
              </div>
              <div class="flex-1 w-full flex flex-col gap-2 pl-0 sm:pl-4">
                <div class="flex items-center justify-between">
                  <div class="font-semibold text-blue-800 text-lg">${prod.title}</div>
                  <button class="px-3 py-1 bg-red-100 text-red-600 font-bold rounded hover:bg-red-200" onclick="removeCartItem('${prod._id || prod.id}')">Remove</button>
                </div>
                <div class="text-yellow-700 font-bold text-xl">&#8358;${price.toLocaleString()}</div>
                <div class="text-sm text-gray-700">Date Carted: ${item.addedAt ? new Date(item.addedAt).toLocaleDateString() : "-"}</div>
                <div class="text-sm text-gray-700">Seller: ${prod.sellerName || prod.seller || "Unknown"}</div>
                <div class="flex items-center gap-2">
                  <span class="font-bold text-gray-700">Qty: x${item.quantity}</span>
                </div>
              </div>
            </div>
          `;
        }).join('');
        document.getElementById('cart-total').textContent = total.toLocaleString();
      } catch {
        document.getElementById('cart-items').innerHTML = '<div class="text-red-500 text-center my-6">Failed to load cart.</div>';
        document.getElementById('cart-total').textContent = "0";
      }
    }
    window.removeCartItem = async function(productId) {
      await fetch(BACKEND + "/api/cart/remove", {
        method: "POST",
        headers: { ...authHeader(), "Content-Type": "application/json" },
        body: JSON.stringify({ productId })
      });
      loadCart();
    };
    document.getElementById('pay-out-btn').onclick = function() {
      const total = document.getElementById('cart-total').textContent.replace(/,/g,'');
      if (total === "0") {
        alert("No items in cart to pay for!");
        return;
      }
      alert("Proceeding to payment for â‚¦" + total + ". (Integrate payment gateway here.)");
    };

    // --- Wishlist ---
    async function loadWishlist() {
      document.getElementById('wishlist-items').innerHTML = '<div class="spinner mx-auto my-8"></div>';
      try {
        const res = await fetch(BACKEND + "/api/blogger-dashboard/wishlist", { headers: authHeader() });
        const { wishlist } = await res.json();
        if (!wishlist || !wishlist.length) {
          document.getElementById('wishlist-items').innerHTML = '<div class="text-gray-400 text-center my-6">No items in wishlist.</div>';
          return;
        }
        document.getElementById('wishlist-items').innerHTML = wishlist.map(item => `
          <div class="flex gap-4 items-center bg-gray-50 rounded p-3 shadow">
            <img src="${(item.images?.[0] || item.img || item.imageUrl || 'https://ui-avatars.com/api/?name=' + encodeURIComponent(item.title || 'Product') + '&background=eee&color=263159&rounded=true')}" class="object-cover w-20 h-20 rounded" alt="Wishlist image"/>
            <div class="flex-1">
              <div class="font-semibold text-blue-800 truncate">${item.title}</div>
              <div class="text-yellow-700 font-bold">&#8358;${Number(item.price||0).toLocaleString()}</div>
            </div>
            <div>
              <button class="px-3 py-1 rounded bg-pink-100 text-pink-600 font-semibold" onclick="removeWishlistItem('${item._id||item.id}')">Remove</button>
            </div>
          </div>
        `).join('');
      } catch {
        document.getElementById('wishlist-items').innerHTML = '<div class="text-red-500 text-center my-6">Failed to load wishlist.</div>';
      }
    }
    window.removeWishlistItem = async function(listingId) {
      await fetch(BACKEND + `/api/blogger-dashboard/wishlist/remove/${listingId}`, { method: "DELETE", headers: authHeader() });
      loadWishlist();
    };

    // --- Offers ---
    async function loadOffers() {
      document.getElementById('offers-list').innerHTML = '<div class="spinner mx-auto my-8"></div>';
      try {
        const res = await fetch(BACKEND + "/api/offers/mine", { headers: authHeader() });
        const { offers } = await res.json();
        if (!offers || !offers.length) {
          document.getElementById('offers-list').innerHTML = '<div class="text-gray-400 text-center my-6">No offers submitted yet.</div>';
          return;
        }
        document.getElementById('offers-list').innerHTML = offers.map(offer => `
          <div class="bg-yellow-50 p-3 rounded shadow flex flex-col sm:flex-row gap-2 items-center">
            <div class="flex-1">
              <div class="font-semibold text-yellow-700">${offer.productTitle || 'Product'}</div>
              <div class="text-gray-700">â‚¦${Number(offer.offerPrice||0).toLocaleString()}</div>
              <div class="text-xs text-gray-500">${offer.createdAt ? new Date(offer.createdAt).toLocaleDateString() : ''}</div>
            </div>
            <div>
              <span class="inline-block px-2 py-1 rounded text-xs font-bold ${offer.status === 'accepted' ? 'bg-green-100 text-green-700' : offer.status === 'rejected' ? 'bg-red-100 text-red-700' : 'bg-yellow-100 text-yellow-700'}">${offer.status || 'pending'}</span>
            </div>
          </div>
        `).join('');
      } catch {
        document.getElementById('offers-list').innerHTML = '<div class="text-red-500 text-center my-6">Failed to load offers.</div>';
      }
    }

    // --- Orders (sample, needs backend support) ---
    async function loadOrders() {
      document.getElementById('orders-list').innerHTML = '<div class="spinner mx-auto my-8"></div>';
      document.getElementById('orders-list').innerHTML = '<div class="text-gray-400 text-center my-6">No orders yet. (Coming soon)</div>';
    }

    // --- Messages (sample, needs backend support) ---
    async function loadMessages() {
      document.getElementById('messages-list').innerHTML = '<div class="spinner mx-auto my-8"></div>';
      document.getElementById('messages-list').innerHTML = '<div class="text-gray-400 text-center my-6">No messages yet. (Coming soon)</div>';
    }

    // --- Notifications (sample, needs backend support) ---
    async function loadNotifications() {
      document.getElementById('notifications-list').innerHTML = '<div class="spinner mx-auto my-8"></div>';
      document.getElementById('notifications-list').innerHTML = '<div class="text-gray-400 text-center my-6">No notifications yet. (Coming soon)</div>';
    }

    // --- Help ---
    document.getElementById('helpForm').addEventListener('submit', function(e){
      e.preventDefault();
      const helpInput = document.getElementById('helpInput');
      if (helpInput.value.trim()) {
        const box = document.getElementById('helpBox');
        box.innerHTML += `<div class="mb-1"><span class="font-semibold text-blue-800">You:</span> ${helpInput.value}</div>`;
        box.scrollTop = box.scrollHeight;
        helpInput.value = "";
      }
    });

    // --- On load ---
    document.addEventListener('DOMContentLoaded', () => {
      loadProfile();
      loadCart();
    });
  </script>
</body>
</html>
