<!DOCTYPE html>
<html lang="en" class="h-full bg-gray-100">
<head>
  <meta charset="UTF-8">
  <title>OAU ExamGuard - Student Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Flowbite (carousel etc) -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/flowbite/2.3.0/flowbite.min.css"/>
  <!-- Chart.js (will be used in scripts) -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    .sidebar-active {
      background: linear-gradient(90deg, #4f46e5 0%, #6366f1 100%) !important;
      color: #fff !important;
    }
    .sidebar-dot {
      width: 9px; height: 9px; background: #ef4444; border-radius: 100%; margin-left: 6px;
      display: inline-block; vertical-align: middle;
    }
    .carousel-container {
      max-height: 220px;
    }
    .hide-scrollbar::-webkit-scrollbar {
      display: none;
    }
  </style>
</head>
<body class="h-full bg-gray-100">

  <!-- Mobile Overlay -->
  <div id="mobileDrawerOverlay" class="fixed inset-0 bg-black bg-opacity-40 z-40 hidden"></div>
  <!-- Mobile Sidebar -->
  <aside id="mobileSidebar"
    class="fixed z-50 top-0 left-0 bottom-0 w-64 bg-[#2852a0] text-white transform -translate-x-full md:hidden transition-transform duration-300 ease-in-out"
    style="background:linear-gradient(180deg,#2852a0 0%,#467ae6 100%);">
    <div class="h-full flex flex-col py-5">
      <div class="px-7 py-3 mb-2">
        <h2 class="font-bold text-2xl tracking-tight leading-tight mb-1">OAU ExamGuard</h2>
        <div class="text-xs text-white/80">Student Dashboard</div>
      </div>
      <nav class="mt-6 flex-1">
        <ul class="flex flex-col gap-3 text-base">
          <!-- Sidebar nav items will go here via script if needed -->
        </ul>
      </nav>
    </div>
  </aside>

  <div class="flex min-h-screen">
    <!-- Desktop Sidebar -->
    <aside class="hidden md:flex w-64 bg-gradient-to-b from-[#2852a0] to-[#467ae6] text-white flex-col border-r min-h-screen" id="desktopSidebar">
      <div>
        <div class="px-7 py-6 mb-2 border-b border-white/10">
          <h2 class="font-bold text-2xl tracking-tight leading-tight mb-1">OAU ExamGuard</h2>
          <div class="text-xs text-white/80">Student Dashboard</div>
        </div>
        <nav class="mt-6 flex-1">
          <ul class="flex flex-col gap-2 text-base" id="desktopSidebarList">
            <!-- Sidebar nav items will go here via script if needed -->
          </ul>
        </nav>
      </div>
    </aside>

    <div class="flex-1 flex flex-col min-h-screen bg-gray-100">
      <!-- Header (Unchanged, dynamic profile may be added via script) -->
      <header class="w-full bg-white border-b px-4 md:px-8 py-3 flex items-center justify-between shadow-sm">
        <div class="flex items-center gap-3">
          <button class="md:hidden rounded-full bg-indigo-600 p-2" aria-label="Open sidebar">
            <svg class="w-7 h-7 text-white" fill="none" stroke="currentColor"><path d="M4 6h16M4 12h16M4 18h16"/></svg>
          </button>
          <span class="font-bold text-lg md:text-2xl text-indigo-800">Student Dashboard</span>
        </div>
        <div class="flex items-center gap-4">
          <div class="relative w-36 sm:w-64">
            <input type="text" placeholder="Search..." class="pl-10 pr-3 py-2 w-full rounded-lg border bg-gray-50 focus:outline-none focus:ring focus:border-blue-300">
            <div class="absolute left-2 top-2 text-gray-400">
              <svg class="w-5 h-5" fill="none" stroke="currentColor"><circle cx="11" cy="11" r="8"/><path d="M21 21l-4.35-4.35"/></svg>
            </div>
          </div>
          <button type="button" id="notifBtn">
            <svg class="w-7 h-7 text-gray-600 hover:text-blue-600" fill="none" stroke="currentColor"><path d="M15 17h5l-1.405-1.405"/></svg>
          </button>
          <div class="relative">
            <button type="button" id="profileDropdownBtn">
              <img class="w-8 h-8 rounded-full border-2 border-indigo-600" src="" alt="Profile">
            </button>
            <div id="profileDropdown" class="hidden absolute right-0 mt-2 w-48 bg-white rounded shadow-lg z-10">
              <a href="#" class="block px-4 py-2 text-gray-700 hover:bg-indigo-100">Profile</a>
              <a href="#" class="block px-4 py-2 text-gray-700 hover:bg-indigo-100">Settings</a>
              <a href="#" class="block px-4 py-2 text-gray-700 hover:bg-indigo-100">Logout</a>
            </div>
          </div>
        </div>
      </header>
      <main class="flex-1 p-2 md:p-8 bg-gray-100 overflow-x-auto hide-scrollbar">
        <!-- ----------- OVERVIEW SECTION (Dynamic) ----------- -->
        <section id="overview-section" class="section-block">
          <!-- Carousel placeholder -->
          <div class="carousel-container w-full max-w-5xl mx-auto mb-4 rounded-xl overflow-hidden shadow-lg" id="adCarouselContainer">
            <!-- Ads/carousel items will be rendered by JS -->
          </div>
          <!-- Welcome & Motivation placeholder -->
          <div id="welcomeCard" class="mb-4">
            <!-- Welcome message & motivational quote will be rendered by JS -->
          </div>
          <!-- Quick Links -->
          <div id="quickLinks" class="mb-5 flex justify-center">
            <!-- Quick access buttons will be dynamically rendered here -->
          </div>

          <!-- Top Scorers & Stat Cards -->
          <div class="mb-6 flex flex-col md:flex-row gap-4 w-full">
            <div id="topScorers" class="bg-white rounded-xl shadow md:w-1/3 w-full p-6 flex flex-col mb-2 md:mb-0">
              <!-- Leaderboard goes here -->
            </div>
            <div id="statCards" class="grid grid-cols-2 md:grid-cols-2 gap-4 md:w-2/3 w-full">
              <!-- Dashboard stats (courses, GPA, assignments, etc) -->
            </div>
          </div>

          <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6 w-full">
            <div id="mockTestScores" class="bg-white rounded-lg p-6 shadow flex flex-col items-center w-full">
              <!-- Mock tests chart and data will be rendered by JS -->
            </div>
            <div id="recentActivity" class="bg-white rounded-lg p-6 shadow w-full">
              <!-- Recent activities list goes here -->
            </div>
          </div>
          <div id="gpaProgress" class="bg-white rounded-lg p-6 shadow mt-4 md:mt-0 max-w-xl w-full">
            <!-- GPA progress chart/data -->
          </div>
        </section>

        <!-- ----------- TASKS CENTER SECTION (Dynamic) ----------- -->
        <section id="taskscenter-section" class="section-block hidden">
          <div class="max-w-6xl mx-auto py-10 px-2 md:px-6">
            <!-- Section Header -->
            <div class="flex flex-col md:flex-row md:items-center justify-between gap-4 mb-8">
              <div>
                <h2 class="text-3xl font-bold text-indigo-800">Tasks Center</h2>
                <p class="text-md text-gray-600 mt-1">Complete daily and weekly activities to boost your engagement, earn rewards, and develop your skills.</p>
              </div>
              <div class="flex gap-4">
                <button class="inline-flex items-center gap-2 bg-green-600 hover:bg-green-700 text-white px-5 py-2 rounded-lg font-semibold shadow transition" id="refreshTasksBtn">
                  <svg class="w-5 h-5" fill="none" stroke="currentColor"><path d="M4 4v5h.582M20 20v-5h-.581M7 10l-2 2 2 2M17 14l2-2-2-2" stroke-width="2"></path></svg>
                  Refresh Tasks
                </button>
              </div>
            </div>
            <!-- Progress Overview (dynamic) -->
            <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 gap-6 mb-10" id="taskProgressOverview"></div>
            <!-- Tasks List Table -->
            <div class="bg-white rounded-2xl shadow-lg overflow-hidden" id="taskTableContainer"></div>
            <!-- Task Modals go here if needed -->
            <!-- ... -->
          </div>
        </section>
        <!-- PROFILE SECTION -->
<section id="profile-section" class="section-block hidden">
  <div class="max-w-4xl mx-auto py-10 px-2 md:px-8" id="profileContainer">
    <!--
      All profile summary, avatar, bio, details, edit form, social links,
      achievements, etc., will be dynamically rendered here via JS.
    -->
  </div>
</section>

<!-- BROADCASTS SECTION -->
<section id="broadcasts-section" class="section-block hidden">
  <div class="max-w-5xl mx-auto py-10 px-2 md:px-8" id="broadcastsContainer">
    <!--
      Announcements, notification feed, create broadcast (if admin), 
      and broadcast modals will be handled dynamically here.
    -->
  </div>
</section>

<!-- STUDYPADI SECTION -->
<section id="studyPadi-section" class="section-block hidden">
  <div class="max-w-6xl mx-auto py-10 px-2 md:px-6" id="studyPadiContainer">
    <!--
      Personalized learning goals, study session scheduling, progress charts,
      journals, timelines, and quick motivation will be dynamically rendered here.
    -->
  </div>
</section>

<!-- RESOURCES SECTION -->
<section id="resources-section" class="section-block hidden">
  <div class="max-w-7xl mx-auto py-10 px-2 md:px-8" id="resourcesContainer">
    <!--
      Curated resources, upload/search/filter, resources table/table,
      ratings and resource modals will be handled dynamically here.
    -->
  </div>
</section>

<!-- LOGOUT SECTION -->
<section id="logout-section" class="section-block hidden">
  <div class="flex flex-col items-center justify-center min-h-[60vh] py-10" id="logoutContainer">
    <!--
      Logout confirmation UI will be rendered here via JS.
    -->
  </div>
</section>
      </main>
    </div>
  </div>
<script>
// =================== CONFIG ===================
const API_URL = "https://examguide.onrender.com/api/";
const token = localStorage.getItem("token");

// ============ UTILITIES ==============
function formatDate(dt) {
  if (!dt) return '-';
  const d = new Date(dt);
  return d.toLocaleDateString() + ' ' + d.toLocaleTimeString();
}
function escapeHtml(str) {
  if (!str) return "";
  return str.replace(/&/g, "&amp;")
    .replace(/</g, "&lt;")
    .replace(/>/g, "&gt;")
    .replace(/"/g, "&quot;")
    .replace(/'/g, "&#039;");
}
function clearNode(node) {
  if (node) node.innerHTML = '';
}
function showSection(sectionId) {
  document.querySelectorAll('.section-block').forEach(el => el.classList.add('hidden'));
  const el = document.getElementById(sectionId);
  if (el) el.classList.remove('hidden');
}

// ============ FETCH HELPERS =============
async function fetchWithAuth(url, options = {}) {
  options.headers = options.headers || {};
  if (token) options.headers['Authorization'] = 'Bearer ' + token;
  const resp = await fetch(url, options);
  if (resp.status === 401 || resp.status === 403) {
    localStorage.removeItem("token");
    window.location.href = "/mock-icthallb";
    throw new Error("Session expired.");
  }
  return resp;
}

// ================== OVERVIEW/DASHBOARD ==================

// --- Welcome & Motivation ---
function renderWelcomeAndMotivation(studentName = "Student") {
  const welcome = document.getElementById('welcomeCard');
  const messages = [
    "You are capable of amazing things.",
    "Another step forwardâ€”keep growing!",
    "Small steps every day lead to big results.",
    "Never stop believing in yourself.",
    "Consistency beats intensity."
  ];
  const msg = messages[Math.floor(Math.random()*messages.length)];
  welcome.innerHTML = `
    <div class="bg-gradient-to-r from-indigo-500 to-indigo-600 text-white rounded-xl shadow flex flex-col md:flex-row justify-between items-center px-4 md:px-6 py-5">
      <div>
        <h2 class="text-2xl font-bold mb-1">Welcome back, ${escapeHtml(studentName)}!</h2>
        <div class="text-md" id="motivation-message">${escapeHtml(msg)}</div>
      </div>
      <div class="mt-3 md:mt-0">
        <button onclick="renderWelcomeAndMotivation('${escapeHtml(studentName)}')" class="bg-white/20 hover:bg-indigo-400 rounded px-4 py-2 font-semibold">Refresh Motivation</button>
      </div>
    </div>`;
}

// --- Quick Links ---
function renderQuickLinks() {
  const container = document.getElementById('quickLinks');
  clearNode(container);
  container.innerHTML = `
    <div class="w-full flex flex-wrap justify-center gap-3">
      <button class="flex flex-col items-center justify-center w-24 h-24 md:w-28 md:h-28 rounded-lg border border-indigo-200 bg-indigo-50 hover:bg-indigo-100 transition shadow-sm"
        onclick="showSection('resources-section')">
        <svg class="w-8 h-8 mb-1 text-indigo-700" fill="none" stroke="currentColor">
          <rect x="2" y="6" width="20" height="14" rx="3" stroke-width="2"/><path d="M10 10h4M10 14h2" stroke-width="2"/>
        </svg>
        <span class="text-xs md:text-sm font-semibold text-indigo-800 mt-1">Resources</span>
      </button>
      <button class="flex flex-col items-center justify-center w-24 h-24 md:w-28 md:h-28 rounded-lg border border-indigo-200 bg-indigo-50 hover:bg-indigo-100 transition shadow-sm"
        onclick="showSection('taskscenter-section')">
        <svg class="w-8 h-8 mb-1 text-indigo-700" fill="none" stroke="currentColor">
          <circle cx="12" cy="8" r="4" stroke-width="2"/><path d="M6 20v-2a4 4 0 014-4h4a4 4 0 014 4v2" stroke-width="2"/>
        </svg>
        <span class="text-xs md:text-sm font-semibold text-indigo-800 mt-1">Tasks Center</span>
      </button>
      <button class="flex flex-col items-center justify-center w-24 h-24 md:w-28 md:h-28 rounded-lg border border-indigo-200 bg-indigo-50 hover:bg-indigo-100 transition shadow-sm"
        onclick="showSection('profile-section')">
        <svg class="w-8 h-8 mb-1 text-indigo-700" fill="none" stroke="currentColor">
          <rect x="6" y="10" width="12" height="8" rx="3" stroke-width="2"/><path d="M9 10v-2a3 3 0 116 0v2" stroke-width="2"/>
        </svg>
        <span class="text-xs md:text-sm font-semibold text-indigo-800 mt-1">Profile</span>
      </button>
    </div>
  `;
}

// --- Top Scorers / Leaderboard ---
async function renderLeaderboard() {
  const container = document.getElementById('topScorers');
  clearNode(container);
  try {
    const resp = await fetchWithAuth(API_URL + "results/leaderboard/top");
    const data = await resp.json();
    if (!data.length) {
      container.innerHTML = "<div class='text-gray-400 text-center'>No leaderboard available.</div>";
      return;
    }
    container.innerHTML = `<h2 class="text-lg font-bold mb-2 text-indigo-700">Top Scorers</h2>` +
      data.slice(0, 3).map((stu, i) => `
        <div class="flex items-center gap-4 bg-[${i===0?'#eef2ff':i===1?'#f8fafc':'#fffbeb'}] rounded-lg px-3 py-2 shadow-sm mb-2">
          <span class="text-3xl">${['ðŸ¥‡','ðŸ¥ˆ','ðŸ¥‰'][i]}</span>
          <div class="flex-1">
            <div class="font-bold text-indigo-900">${escapeHtml(stu.fullname || stu.username)}</div>
            <div class="text-[13px] text-indigo-600">Total Score: ${stu.totalScore ?? "-"}</div>
          </div>
          <span class="px-3 py-1 rounded-lg text-sm font-semibold"
            style="background:${i===0?'#6366f1':i===1?'#e2e8f0':'#fed7aa'}; color:${i===0?'white':'#333'}">
            ${['1st','2nd','3rd'][i]}
          </span>
        </div>
      `).join('');
  } catch {
    container.innerHTML = "<div class='text-gray-400 text-center'>Failed to load leaderboard.</div>";
  }
}

// --- Stat Cards (dashboard mini-cards) ---
async function renderStatCards(user, results) {
  const container = document.getElementById('statCards');
  clearNode(container);
  // Fallback if undefined:
  user = user || {};
  results = results || [];
  const courses = (user.courses?.length) || 4;
  const scores = results.map(r => r.score).filter(s => typeof s === "number");
  const avgScore = scores.length ? Math.round(scores.reduce((a,b)=>a+b,0)/scores.length) : '-';
  const assignmentsDue = user.assignmentsDue || 3;
  const gpa = user.gpa || "A-";
  container.innerHTML = `
    <div class="bg-white rounded-xl shadow p-6 text-center flex flex-col justify-center">
      <span class="text-3xl font-bold mb-1 text-indigo-800 block">${courses}</span>
      <div class="font-semibold text-gray-700">Courses</div>
    </div>
    <div class="bg-white rounded-xl shadow p-6 text-center flex flex-col justify-center">
      <span class="text-3xl font-bold mb-1 text-indigo-800 block">${avgScore}${avgScore!=='-'?'%':''}</span>
      <div class="font-semibold text-gray-700">Avg. Mock Score</div>
    </div>
    <div class="bg-white rounded-xl shadow p-6 text-center flex flex-col justify-center">
      <span class="text-3xl font-bold mb-1 text-indigo-800 block">${assignmentsDue}</span>
      <div class="font-semibold text-gray-700">Assignments Due</div>
    </div>
    <div class="bg-white rounded-xl shadow p-6 text-center flex flex-col justify-center">
      <span class="text-3xl font-bold mb-1 text-indigo-800 block">${gpa}</span>
      <div class="font-semibold text-gray-700">Current GPA</div>
    </div>
  `;
}

// --- Mock Test Scores Chart ---
async function renderMockTestScores(results) {
  const container = document.getElementById('mockTestScores');
  clearNode(container);
  // Data: results is array of user's tests
  const sorted = (results || []).slice().sort((a, b) => new Date(b.submittedAt) - new Date(a.submittedAt));
  const top5 = sorted.slice(0, 5);
  container.innerHTML = `<h3 class="text-lg font-bold mb-3 text-indigo-700 w-full text-left">Mock Test Scores</h3>
    <canvas id="mockScoreChart" height="140"></canvas>
    <div class="mt-2 text-sm text-gray-600 w-full text-left"></div>`;
  const labels = top5.map(r => r.examSet?.title || "Mock");
  const scores = top5.map(r => r.score ?? 0);
  if (labels.length > 0) {
    new Chart(document.getElementById('mockScoreChart').getContext('2d'), {
      type: 'bar',
      data: { labels: labels, datasets: [{ label: "Score (%)", data: scores, backgroundColor: "#6366f1" }] },
      options: { responsive: true, scales: { y: { beginAtZero: true, max: 100 } } }
    });
  }
  container.querySelector('div.mt-2').innerHTML = scores.length
    ? `<span class="font-semibold">Best Mock:</span> ${Math.max(...scores)}%<br>
       <span class="font-semibold">Last Mock:</span> ${scores[0]}%`
    : "No test data.";
}

// --- Recent Activity ---
function renderRecentActivity(results) {
  const container = document.getElementById('recentActivity');
  clearNode(container);
  const sorted = (results || []).slice().sort((a, b) => new Date(b.submittedAt)-new Date(a.submittedAt));
  const activities = sorted.slice(0, 5);
  container.innerHTML = `
    <h3 class="text-lg font-bold mb-3">Recent Activity</h3>
    <ol class="relative border-l border-gray-200 ml-4">
      ${
        activities.length ?
        activities.map(r => `
          <li class="mb-6 ml-6">
            <span class="absolute -left-3 flex items-center justify-center w-6 h-6 bg-blue-100 rounded-full ring-8 ring-white">
              <svg class="w-3 h-3 text-blue-600" fill="currentColor"><circle cx="1.5" cy="1.5" r="1.5"></circle></svg>
            </span>
            <h4 class="font-semibold text-gray-700">
              Scored ${r.score ?? '-'}% on ${escapeHtml(r.examSet?.title || "Mock Test")}
            </h4>
            <span class="text-xs text-gray-400">${formatDate(r.submittedAt)}</span>
          </li>
        `).join('') : `<li class="ml-6 text-gray-400">No activity yet.</li>`
      }
    </ol>
  `;
}

// --- GPA Progress Chart ---
function renderGpaProgress(user) {
  const container = document.getElementById('gpaProgress');
  clearNode(container);
  container.innerHTML = `<h3 class="text-lg font-bold mb-3 text-indigo-700">GPA Progress</h3>
    <canvas id="gpaChart" height="120"></canvas>`;
  // For demo, create dummy GPAs (should adapt if backend supports GPAs per term):
  const semesters = ["100L", "200L", "300L", "400L"];
  const gpas = [3.1, 3.5, 3.6, (user.gpa ? Number(user.gpa) : 3.85)];
  new Chart(document.getElementById('gpaChart').getContext('2d'), {
    type: 'line',
    data: { labels: semesters, datasets: [{ label: "GPA", data: gpas, borderColor: "#6366f1", backgroundColor: "#eef2ff" }] },
    options: { responsive: true, scales: { y: { beginAtZero: true, max: 4 } } }
  });
}

// --- Overview Main Renderer ---
async function renderOverview() {
  let user = { fullname: 'Student' }, results = [];
  try {
    const userResp = await fetchWithAuth(API_URL + "auth/me");
    const userData = await userResp.json();
    if (userData && userData.user) user = userData.user;
    const resultsResp = await fetchWithAuth(API_URL + "results/user/" + user._id);
    results = await resultsResp.json();
  } catch {}
  renderWelcomeAndMotivation(user.fullname || user.username || 'Student');
  renderQuickLinks();
  await renderLeaderboard();
  await renderStatCards(user, results);
  await renderMockTestScores(results);
  renderRecentActivity(results);
  renderGpaProgress(user);
}

// ================== TASKS CENTER ==================
async function renderTasksCenter() {
  const progressElem = document.getElementById('taskProgressOverview');
  const tableElem = document.getElementById('taskTableContainer');
  clearNode(progressElem); clearNode(tableElem);
  progressElem.innerHTML = `
    <div class="bg-gradient-to-r from-blue-500 to-indigo-600 text-white rounded-2xl shadow-lg flex flex-col items-center p-6">
      <div class="text-3xl font-bold mb-1" id="tcTasksActive">...</div>
      <div class="uppercase text-xs tracking-wider font-semibold">Tasks Active</div>
    </div>
    <div class="bg-gradient-to-r from-green-400 to-teal-500 text-white rounded-2xl shadow-lg flex flex-col items-center p-6">
      <div class="text-3xl font-bold mb-1" id="tcCompleted">...</div>
      <div class="uppercase text-xs tracking-wider font-semibold">Completed</div>
    </div>
    <div class="bg-gradient-to-r from-yellow-400 to-orange-500 text-white rounded-2xl shadow-lg flex flex-col items-center p-6">
      <div class="text-3xl font-bold mb-1" id="tcOverdue">...</div>
      <div class="uppercase text-xs tracking-wider font-semibold">Overdue</div>
    </div>
    <div class="bg-gradient-to-r from-pink-500 to-purple-600 text-white rounded-2xl shadow-lg flex flex-col items-center p-6">
      <div class="text-3xl font-bold mb-1">
        <span><svg class="inline w-6 h-6" fill="none" stroke="currentColor"><path d="M16.24 7.76a6 6 0 01-8.48 8.48" stroke-width="2"></path></svg></span><span id="tcPoints">...</span></div>
      <div class="uppercase text-xs tracking-wider font-semibold">Points</div>
    </div>
  `;
  try {
    const resp = await fetchWithAuth(API_URL + "tasks/active");
    const tasks = await resp.json();
    // Calculate stats:
    let active = 0, completed = 0, overdue = 0, points = 0;
    let now = new Date();
    let rows = tasks.map(task => {
      let isDone = task.completed;
      let due = new Date(task.dueDate);
      if (isDone) { completed++; } else if (due < now) { overdue++; } else { active++; }
      points += task.points || 0;
      return `<tr>
        <td class="px-6 py-4 font-semibold text-blue-900">${escapeHtml(task.title)}</td>
        <td class="px-6 py-4"><span class="bg-green-100 text-green-700 rounded-full px-3 py-1 font-semibold text-xs">${escapeHtml(task.type||"Other")}</span></td>
        <td class="px-6 py-4 text-center font-bold text-indigo-600">${task.points||0}</td>
        <td class="px-6 py-4">
          <span class="bg-${isDone?'green':'yellow'}-100 text-${isDone?'green-700':'yellow-800'} font-semibold px-3 py-1 rounded-full text-xs">${isDone?'Done':'Active'}</span>
        </td>
        <td class="px-6 py-4">${isDone?'Completed':`<button class="bg-blue-600 hover:bg-blue-700 text-white rounded px-4 py-1 font-semibold text-xs shadow" onclick="completeTask('${task._id}')">Mark as Done</button>`}</td>
      </tr>`;
    }).join('');
    tableElem.innerHTML = `<table class="min-w-full text-sm divide-y divide-gray-200">
      <thead class="bg-indigo-50 font-bold text-indigo-800">
        <tr>
          <th class="px-6 py-3 text-left">Task</th>
          <th class="px-6 py-3 text-left">Type</th>
          <th class="px-6 py-3 text-left">Points</th>
          <th class="px-6 py-3 text-left">Status</th>
          <th class="px-6 py-3 text-left">Action</th>
        </tr>
      </thead>
      <tbody class="bg-white divide-y divide-gray-100">
        ${rows}
      </tbody>
    </table>`;
    // Update stats
    document.getElementById("tcTasksActive").textContent = active;
    document.getElementById("tcCompleted").textContent = completed;
    document.getElementById("tcOverdue").textContent = overdue;
    document.getElementById("tcPoints").textContent = points;
  } catch {
    tableElem.innerHTML = "<div class='text-gray-400 text-center py-8'>Failed to load tasks.</div>";
    document.getElementById("tcTasksActive").textContent = "0";
    document.getElementById("tcCompleted").textContent = "0";
    document.getElementById("tcOverdue").textContent = "0";
    document.getElementById("tcPoints").textContent = "0";
  }
}
window.completeTask = async function(id) {
  await fetchWithAuth(API_URL + "tasks/"+id+"/complete", {method:"POST"});
  renderTasksCenter();
};

// ================== PROFILE SECTION ==================
async function renderProfileSection() {
  const container = document.getElementById('profileContainer');
  clearNode(container);
  try {
    const resp = await fetchWithAuth(API_URL + "auth/me");
    const data = await resp.json();
    const u = data.user;
    container.innerHTML = `
    <div class="bg-white rounded-xl shadow-lg flex flex-col items-center md:flex-row md:items-start gap-8 p-8 mb-10">
      <div class="flex flex-col items-center md:items-start gap-5">
        <img class="w-32 h-32 rounded-full border-4 border-indigo-400 shadow-md object-cover" src="${escapeHtml(u.profilePic||'https://ui-avatars.com/api/?name='+encodeURIComponent(u.fullname||u.username||'User'))}" alt="Profile avatar">
      </div>
      <div class="flex-1 flex flex-col gap-3 w-full">
        <h2 class="text-3xl font-bold text-indigo-800 mb-1">${escapeHtml(u.fullname||u.username||'Student')}</h2>
        <div class="text-md text-gray-600">${escapeHtml(u.email||'')}</div>
        <div class="mt-5 flex gap-3">
          <span class="bg-green-100 text-green-700 px-3 py-1 rounded-md text-xs font-semibold">GPA: ${u.gpa??'N/A'}</span>
        </div>
        <div class="mt-3">
          <span class="text-xs text-gray-600">Phone: ${escapeHtml(u.phone||"-")}</span>
        </div>
      </div>
    </div>
    <div class="bg-white rounded-xl shadow p-8 flex flex-col gap-2 mb-10">
      <h3 class="text-xl font-bold text-indigo-700 mb-4">Personal Information</h3>
      <div><b>Level:</b> ${escapeHtml(u.level||'')}</div>
      <div><b>Department:</b> ${escapeHtml(u.department?.name || '')}</div>
      <div><b>Faculty:</b> ${escapeHtml(u.faculty?.name || '')}</div>
      <div><b>Student ID:</b> ${escapeHtml(u.studentId||'')}</div>
    </div>
    `;
  } catch {
    container.innerHTML = "<div class='text-gray-400 text-center py-8'>Failed to load profile info.</div>";
  }
}

// ================== BROADCASTS SECTION ==================
async function renderBroadcastsSection() {
  const container = document.getElementById('broadcastsContainer');
  clearNode(container);
  try {
    const resp = await fetchWithAuth(API_URL + "broadcasts");
    const broadcasts = await resp.json();
    if (!Array.isArray(broadcasts) || broadcasts.length === 0) {
      container.innerHTML = '<div class="py-16 text-center text-gray-400">No broadcasts at this time.</div>';
      return;
    }
    container.innerHTML = `
      <div class="flex flex-col gap-6">
        ${broadcasts.map(b => `
          <div class="bg-white rounded-xl shadow p-6 flex flex-col md:flex-row gap-6 items-center border-l-4 border-indigo-600">
            <div class="flex-1">
              <h3 class="font-bold text-lg text-indigo-900 flex items-center gap-2">
                ${escapeHtml(b.title||'')}
              </h3>
              <div class="text-sm text-gray-600 mt-1">
                ${escapeHtml(b.message||'')}
              </div>
            </div>
            <div class="flex flex-col items-end md:w-36">
              <span class="text-xs text-gray-400">${formatDate(b.createdAt)} â€¢ System</span>
            </div>
          </div>
        `).join('')}
      </div>`;
  } catch {
    container.innerHTML = "<div class='text-gray-400 text-center py-8'>Failed to load broadcasts.</div>";
  }
}

// ================== STUDYPADI SECTION ==================
async function renderStudyPadiSection() {
  const container = document.getElementById('studyPadiContainer');
  clearNode(container);
  // Because there is no explicit endpoint in the sample, here is a basic placeholder:
  container.innerHTML = `<div class="bg-white shadow rounded-xl p-8 text-center text-gray-500">Your personalized study goals, sessions, and progress will appear here soon.</div>`;
}

// ================== RESOURCES SECTION ==================
async function renderResourcesSection() {
  const container = document.getElementById('resourcesContainer');
  clearNode(container);
  try {
    const resp = await fetchWithAuth(API_URL + "resources");
    const resources = await resp.json();
    if (!Array.isArray(resources) || resources.length === 0) {
      container.innerHTML = '<div class="py-16 text-center text-gray-400">No resources found.</div>';
      return;
    }
    container.innerHTML = `
      <table class="min-w-full divide-y divide-gray-200">
        <thead>
          <tr class="bg-indigo-50 text-left text-gray-700 text-sm font-semibold">
            <th class="px-6 py-4">Title</th>
            <th class="px-6 py-4">Type</th>
            <th class="px-6 py-4">Course</th>
            <th class="px-6 py-4">Uploaded By</th>
            <th class="px-6 py-4">Date Added</th>
            <th class="px-6 py-4">Actions</th>
          </tr>
        </thead>
        <tbody class="divide-y divide-gray-100 text-sm">
          ${resources.map(r=>`
            <tr>
              <td class="px-6 py-4 font-semibold text-indigo-800">${escapeHtml(r.title||'')}</td>
              <td class="px-6 py-4">${escapeHtml(r.type||'-')}</td>
              <td class="px-6 py-4">${escapeHtml(r.course||'-')}</td>
              <td class="px-6 py-4">${escapeHtml(r.uploader?.fullname||r.uploader?.username||'')}</td>
              <td class="px-6 py-4">${formatDate(r.createdAt)}</td>
              <td class="px-6 py-4"><a href="${escapeHtml(r.link||r.url||'#')}" target="_blank" class="text-blue-700 underline">View</a></td>
            </tr>
          `).join('')}
        </tbody>
      </table>`;
  } catch {
    container.innerHTML = "<div class='text-gray-400 text-center py-8'>Failed to load resources.</div>";
  }
}

// ================== LOGOUT SECTION ==================
function renderLogoutSection() {
  const container = document.getElementById('logoutContainer');
  clearNode(container);
  container.innerHTML = `
    <div class="bg-white rounded-xl shadow-lg p-10 max-w-md w-full flex flex-col items-center text-center">
      <svg class="w-20 h-20 mb-4 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 48 48">
        <circle cx="24" cy="24" r="22" stroke-width="3" stroke="currentColor" fill="none"/>
        <path d="M32 16v-2a4 4 0 00-4-4h-8a4 4 0 00-4 4v20a4 4 0 004 4h8a4 4 0 004-4v-2" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/>
        <path d="M16 24h16m0 0l-5-5m5 5l-5 5" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/>
      </svg>
      <h2 class="text-2xl font-bold text-indigo-800 mb-2">Sign out</h2>
      <p class="text-gray-700 mb-6">Are you sure you want to log out of your account?</p>
      <div class="flex flex-col gap-3 w-full">
        <button 
          onclick="doLogout()"
          class="bg-red-600 hover:bg-red-700 text-white font-bold rounded-lg px-6 py-2 transition shadow">
          Yes, Log me out
        </button>
        <button 
          onclick="showSection('overview-section')"
          class="border border-gray-300 bg-gray-100 hover:bg-gray-200 text-gray-800 font-semibold rounded-lg px-6 py-2 transition shadow">
          Cancel
        </button>
      </div>
    </div>
  `;
}
window.doLogout = function() {
  localStorage.removeItem("token");
  window.location.href = "/mock-icthallb";
};

// ================== ROUTING & MAIN INIT ==================
function route(section) {
  showSection(section);
  switch(section) {
    case 'overview-section': renderOverview(); break;
    case 'taskscenter-section': renderTasksCenter(); break;
    case 'profile-section': renderProfileSection(); break;
    case 'broadcasts-section': renderBroadcastsSection(); break;
    case 'resources-section': renderResourcesSection(); break;
    case 'studyPadi-section': renderStudyPadiSection(); break;
    case 'logout-section': renderLogoutSection(); break;
  }
}

// Set up sidebar links (naive version)
document.addEventListener("DOMContentLoaded", () => {
  // Optionally bind all nav to use route()
  document.querySelectorAll("aside button, aside a").forEach(btn => {
    const onclick = btn.getAttribute('onclick');
    if (onclick && onclick.includes("switchSection")) {
      btn.onclick = function(e) {
        e.preventDefault();
        const section = this.getAttribute("onclick").match(/switchSection\(['"]?([^'"]+)['"]?\)/);
        if (section) route(section[1]+"-section");
      };
    }
  });
  // Initial route:
  route("overview-section");
});
</script>
</body>
</html>
