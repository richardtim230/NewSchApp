<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <title>Practice Result Summary</title>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/flowbite/2.2.1/flowbite.min.css" rel="stylesheet"/>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    .result-card { border-left: 4px solid #2563eb; background: #fff; box-shadow: 0 2px 16px #2563eb22; margin-bottom: 2rem; }
    .option { background: #f8fafc; color: #222; }
    .option.selected { border: 2px solid #2563eb; background: #e0e7ff; font-weight: bold; color: #2563eb; }
    .option.correct { border: 2px solid #16a34a; background: #dcfce7; color: #16a34a; font-weight: bold; }
    .option.incorrect { border: 2px solid #dc2626; background: #fee2e2; color: #dc2626; font-weight: bold; }
    .explanation { background: #f1f5f9; border-left: 4px solid #6366f1; padding: 1rem; margin-top: 1.2rem; border-radius: 0.7rem; }
    .hero-bg {
      background-image: url('sky.jpg');
      background-size: cover;
      background-position: center;
      position: relative;
    }
    .hero-overlay {
      position: absolute;
      inset: 0;
      background: linear-gradient(to bottom right, rgba(30, 41, 59, 0.7) 0%, rgba(59, 130, 246, 0.4) 100%);
      z-index: 1;
      border-bottom-left-radius: 2rem;
      border-bottom-right-radius: 2rem;
    }
    .hero-content {
      position: relative;
      z-index: 2;
    }
  </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-white min-h-screen">
  <!-- HERO SECTION -->
  <section class="w-full h-44 md:h-64 hero-bg relative flex items-center justify-center mb-8 rounded-b-2xl overflow-hidden">
    <div class="hero-overlay"></div>
    <div class="hero-content flex flex-col items-center justify-center w-full text-center px-4">
      <h1 class="text-3xl md:text-5xl font-extrabold text-white drop-shadow-lg mb-2 tracking-wide" style="letter-spacing: 2px;">
        OAU ExamGuard Nigeria
      </h1>
    </div>
  </section>
  <!-- SCORE SUMMARY -->
  <main class="max-w-2xl mx-auto px-3 py-4">
    <div id="scoreSummary" class="mb-6"></div>
    <div id="cardsContainer"></div>
    <div class="flex flex-wrap gap-2 mt-8">
      <button id="retakePracticeBtn" class="px-6 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 font-semibold">Retake Practice</button>
      <button id="downloadPdfBtn" class="px-6 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 font-semibold">Download PDF</button>
    </div>
    <!-- Ad Modal -->
<div id="adModal" style="
  display:none;
  position:fixed;
  inset:0;
  z-index:10000;
  background:rgba(0,0,0,0.92);
  width:100vw;
  height:100vh;
  align-items:center;
  justify-content:center;">
  <div style="width:100vw;height:100vh;display:flex;flex-direction:column;justify-content:center;align-items:center;">
    <iframe id="adIframe"
      src="https://examguard.com.ng"
      style="width:100vw;height:85vh;border:none;background:#fff;border-radius:0;">
    </iframe>
    <div style="width:100vw;text-align:center;background:#fff;padding:18px 0 8px 0;font-size:1.2em;">
      <span id="adCountdown" style="font-size:1.5em;font-weight:700;color:#6366f1;">20</span>
      <button id="adCancelBtn" style="display:none;margin-left:18px;padding:6px 24px;background:#eee;border-radius:8px;font-size:1em;">Cancel</button>
      <div style="font-size:0.99em;color:#888;margin-top:10px;">You will be redirected shortly.</div>
    </div>
  </div>
</div>
  </main>
  
  <script>
    const result = JSON.parse(localStorage.getItem("practiceResult") || "{}");
    const questions = JSON.parse(localStorage.getItem("practiceQuestions") || "[]");
    const answers = JSON.parse(localStorage.getItem("practiceAnswers") || "{}");
// === Ad Modal Logic ===
let adModalTimer = null, adModalCountdown = 20, adModalProceedCallback = null;
const SMARTLINK_URL = "https://examguard.com.ng";

function showAdModal(proceedCallback) {
  adModalProceedCallback = proceedCallback;
  adModalCountdown = 20;
  document.getElementById("adIframe").src = SMARTLINK_URL;
  document.getElementById("adModal").style.display = "flex";
  document.getElementById("adCountdown").textContent = adModalCountdown;
  document.getElementById("adCancelBtn").style.display = "none";
  clearInterval(adModalTimer);
  adModalTimer = setInterval(() => {
    adModalCountdown--;
    document.getElementById("adCountdown").textContent = adModalCountdown;
    if (adModalCountdown <= 10) {
      document.getElementById("adCancelBtn").style.display = "block";
    }
    if (adModalCountdown <= 0) {
      closeAdModal(true);
    }
  }, 1500);
}

function closeAdModal(proceed) {
  clearInterval(adModalTimer);
  document.getElementById("adModal").style.display = "none";
  document.getElementById("adIframe").src = "";
  if (proceed && typeof adModalProceedCallback === "function") {
    adModalProceedCallback();
    adModalProceedCallback = null;
  }
}

document.getElementById("adCancelBtn").onclick = function() {
  closeAdModal(true);
};
    document.addEventListener("DOMContentLoaded", function() {
  const retakeBtn = document.getElementById("retakePracticeBtn");
  if (retakeBtn) {
    retakeBtn.onclick = function(e) {
      e.preventDefault();
      showAdModal(() => {
        window.location.href = 'tpp.html'; // or any page you want
      });
    };
  }
});
    // Show score summary
    document.getElementById("scoreSummary").innerHTML = `
      <div class="p-4 bg-blue-100 rounded-xl font-bold text-lg text-blue-900 flex flex-col md:flex-row items-center justify-between gap-3">
        <div>
          <span class="text-2xl md:text-3xl font-extrabold text-blue-900">Score: ${result.score || 0} / ${result.total || questions.length}</span>
        </div>
        <div>
          <span class="text-lg font-semibold text-indigo-700">Accuracy: ${Math.round(((result.score||0)/(result.total||questions.length))*100)}%</span>
        </div>
        <div>
          <span class="text-md font-medium text-gray-700">Questions: ${questions.length}</span>
        </div>
        <div>
          <span class="text-md font-medium text-green-700">Time Spent: ${result.timeSpent ? Math.round(result.timeSpent/60) + ' min' : '--'}</span>
        </div>
      </div>
    `;

    // Render question cards
    const container = document.getElementById("cardsContainer");
    questions.forEach((q, i) => {
      const userAnswer = answers[q._id] || null;
      const correctAnswer = result.correctChoices?.[q._id] || q.correctAnswer || null;
      const explanation = q.explanation || result.explanations?.[q._id] || "No explanation provided.";
      // Option rendering
      let optsHtml = (q.options || q.choices || []).map(opt => {
        let cls = "option";
        if (opt === correctAnswer) cls += " correct";
        if (opt === userAnswer && userAnswer !== correctAnswer) cls += " incorrect";
        if (opt === userAnswer && userAnswer === correctAnswer) cls += " selected";
        return `<div class="${cls} rounded px-4 py-2 mb-2">${opt}</div>`;
      }).join('');
      // Feedback
      let feedbackText = "";
      if (!userAnswer) {
        feedbackText = `<div class="text-red-600 font-medium mb-2">You did not answer this question.</div>`;
      } else if (userAnswer === correctAnswer) {
        feedbackText = `<div class="text-green-700 font-medium mb-2">Correct!</div>`;
      } else {
        feedbackText = `<div class="text-red-600 font-medium mb-2">Incorrect. Your Answer: <span class="font-semibold">${userAnswer}</span></div>`;
      }
      container.innerHTML += `
        <div class="result-card rounded-xl border-l-4 border-blue-500 bg-white shadow p-4 mb-6">
          <div class="font-bold text-lg mb-2">Q${i+1}: ${q.text || q.question || ""}</div>
          <div class="mb-2">${optsHtml}</div>
          ${feedbackText}
          <div class="explanation">
            <span class="font-bold text-blue-900">Explanation:</span>
            <span class="text-blue-900">${explanation}</span>
          </div>
        </div>
      `;
    });

    // ----------- PDF Download Logic with Unicode-friendly built-in font -----------
    document.getElementById("downloadPdfBtn").addEventListener("click", generatePDF);

    function cleanText(str) {
      // Optionally replace HTML tags and unsupported symbols with plain equivalents
      return (str || "")
        .replace(/<sup>(.*?)<\/sup>/g, (_, s) => s) // remove tags
        .replace(/<sub>(.*?)<\/sub>/g, (_, s) => s)
        .replace(/&lt;/g, "<").replace(/&gt;/g, ">")
        .replace(/&amp;/g, "&");
        // You can add more replacements as needed
    }

    function generatePDF() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({ unit: "pt", format: "a4" });

      // Use built-in 'helvetica' font (good Unicode coverage for most Western/Latin scripts and basic symbols)
      doc.setFont("helvetica", "normal");

      let x = 40, y = 50;
      const lineHeight = 24;
      const pageWidth = doc.internal.pageSize.getWidth() - 80; // 40px margin each side

      doc.setFont("helvetica", "bold");
      doc.setFontSize(20);
      doc.text("OAU ExamGuard Practice Result", x, y);
      y += lineHeight;
      doc.setFontSize(14);
      doc.setFont("helvetica", "normal");
      doc.text(`Subject: ${result.subject || questions[0]?.subject || '-'}`, x, y);
      y += lineHeight;
      doc.text(`Course Code: ${result.courseCode || questions[0]?.courseCode || '-'}`, x, y);
      y += lineHeight;
      doc.text(`Year: ${result.year || questions[0]?.year || '-'}`, x, y);
      y += lineHeight * 1.2;

      doc.setFontSize(13);
      doc.text(`Score: ${result.score || 0} / ${result.total || questions.length}`, x, y);
      y += lineHeight;
      doc.text(`Accuracy: ${Math.round(((result.score||0)/(result.total||questions.length))*100)}%`, x, y);
      y += lineHeight;
      doc.text(`Time Spent: ${result.timeSpent ? Math.round(result.timeSpent/60) + ' min' : '--'}`, x, y);
      y += lineHeight * 1.2;

      questions.forEach((q, i) => {
        if (y > 750) { doc.addPage(); y = 50; }
        let questionText = cleanText(q.text || q.question || "");
        let wrappedQ = doc.splitTextToSize(`Q${i + 1}: ${questionText}`, pageWidth);

        doc.setFont("helvetica", "bold");
        doc.setFontSize(12);
        doc.text(wrappedQ, x, y);
        y += lineHeight * wrappedQ.length;

        // Options
        (q.options || q.choices || []).forEach((opt, idx) => {
          let isCorrect = (opt === (result.correctChoices?.[q._id] || q.correctAnswer));
          let marker = String.fromCharCode(65 + idx) + ". ";
          let textOpt = marker + cleanText(opt);
          doc.setFont("helvetica", isCorrect ? "bold" : "normal");
          doc.setTextColor(isCorrect ? 34 : 0, isCorrect ? 197 : 0, isCorrect ? 94 : 0);
          let wrappedOpt = doc.splitTextToSize(textOpt, pageWidth - 20);
          doc.text(wrappedOpt, x + 14, y);
          y += lineHeight * wrappedOpt.length - 4;
          doc.setTextColor(0, 0, 0);
        });

        // Correct answer
        doc.setFont("helvetica", "bold");
        doc.setTextColor(34, 197, 94);
        doc.text("Correct Answer: " + cleanText(result.correctChoices?.[q._id] || q.correctAnswer || "-"), x, y);
        doc.setTextColor(0, 0, 0);
        y += lineHeight;

        // Explanation
        doc.setFont("helvetica", "normal");
        doc.setFontSize(11);
        let explanation = cleanText(q.explanation || result.explanations?.[q._id] || "No explanation provided.");
        let explanationLines = doc.splitTextToSize("Explanation: " + explanation, pageWidth);
        doc.text(explanationLines, x, y);
        y += lineHeight * explanationLines.length + 8;

        y += 8;
      });

      doc.save("practice-result.pdf");
    }
    // // Uncomment below to trigger auto-download on page load:
    window.addEventListener("DOMContentLoaded", generatePDF);
  </script>
</body>
</html>
