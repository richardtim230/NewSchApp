<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>OAU ExamGuard | Blogger Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/flowbite/2.2.1/flowbite.min.css" rel="stylesheet"/>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/flowbite/2.2.1/flowbite.min.js"></script>
  <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
  <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
    <!-- Add these inside <head> after your Quill includes -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/quill-better-table@1.2.10/dist/quill-better-table.min.css" />
<script src="https://cdn.jsdelivr.net/npm/quill-better-table@1.2.10/dist/quill-better-table.min.js"></script>

<style>
  /* Add/fix these styles for the editor container */
  .ql-editor {
    min-height: 160px;
    height: 250px !important;
    max-height: 250px !important;
    overflow-y: auto;
    font-size: 1rem;
  }
  #editor {
    min-height: 250px;
    height: 250px;
    max-height: 250px;
    overflow-y: auto;
    background: #fff;
    border-radius: 0.5rem;
  }



    .navy-text-glass {
      background: linear-gradient(90deg, #1e293b 45%, #475569 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      font-weight: bold;
    }
    .gold-text-glass {
      background: linear-gradient(90deg, #fde68a 25%, #fbbf24 80%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      font-weight: bold;
    }
    .nav-shadow { box-shadow: 0 2px 12px 0 rgba(30,41,59,0.10);}
    .tab-btn-active {
      border-bottom-width: 2px;
      border-color: #6366f1;
      color: #3730a3;
      background-color: #eef2ff;
    }
    .tab-btn {
      border-bottom-width: 2px;
      border-color: transparent;
      color: #334155;
      background-color: transparent;
    }
    .ql-editor {
      min-height: 160px;
      font-size: 1rem;
    }
    .preview-modal-bg {
      background: rgba(30,41,59,0.15);
      backdrop-filter: blur(2px);
      -webkit-backdrop-filter: blur(2px);
    }
    .post-preview-content h1, 
    .post-preview-content h2, 
    .post-preview-content h3 {
      color: #1e293b;
      margin-top: 0.75rem;
      margin-bottom: 0.5rem;
    }
    .post-preview-content p {
      margin-bottom: 0.7rem;
    }
    .post-preview-content strong { color: #b45309; }
    .post-preview-content blockquote {
      border-left: 4px solid #fbbf24;
      background: #fffbe9;
      margin: 1rem 0;
      padding: 0.5rem 1rem;
      color: #444;
    }
    .line-clamp-2 { display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
    .spinner { border-top-color: #6366f1; animation: spin 1s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }
  </style>
</head>
<body class="bg-white text-gray-900 min-h-screen">
  <nav class="fixed top-0 left-0 right-0 z-50 bg-white/90 nav-shadow backdrop-blur-md border-b border-gray-200">
    <div class="max-w-7xl mx-auto px-4 flex justify-between items-center h-16">
      <div class="flex items-center gap-2 font-bold text-xl">
        <img src="https://cdn.jsdelivr.net/gh/twitter/twemoji@latest/assets/svg/1f393.svg" class="h-8" alt="logo">
        <span class="navy-text-glass">OAU</span> <span class="gold-text-glass ml-1">ExamGuard</span>
      </div>
      <div class="hidden md:flex space-x-7 font-semibold items-center">
        <a href="marketplace.html" class="text-gray-700 hover:text-indigo-700 transition">Marketplace</a>
        <a href="#dashboard-tabs" class="text-gray-700 hover:text-indigo-700 transition">Dashboard</a>
        <a href="#profile" class="text-gray-700 hover:text-indigo-700 transition">Profile</a>
        <img id="profileAvatar" src="https://ui-avatars.com/api/?name=User&background=FFCE45&color=263159&rounded=true" class="h-9 w-9 rounded-full border-2 border-yellow-400 ml-3" alt="User">
      </div>
      <button id="hamburger-btn" type="button" class="md:hidden p-2 text-indigo-500 focus:outline-none" aria-label="Open menu">
        <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3"
            d="M4 6h16M4 12h16M4 18h16"></path>
        </svg>
      </button>
    </div>
    <div class="md:hidden absolute top-16 left-0 right-0 bg-white/95 border-b border-t border-indigo-200 shadow-lg z-40" id="mobile-menu" hidden>
      <div class="flex flex-col px-6 py-4 space-y-2 font-bold text-blue-900">
        <a href="marketplace.html" class="hover:text-indigo-500 transition">Marketplace</a>
        <a href="#dashboard-tabs" class="hover:text-indigo-500 transition">Dashboard</a>
        <a href="#profile" class="hover:text-indigo-500 transition">Profile</a>
      </div>
    </div>
  </nav>
  <div class="pt-20"></div>
  <main id="dashboard-tabs" class="max-w-3xl mx-auto px-2 md:px-0">

<div class="flex overflow-x-auto gap-2 border-b border-gray-200 mb-6 pb-1">
  <button class="tab-btn-active px-4 py-2 rounded-t font-semibold transition min-w-max" data-tab="myposts">My Posts</button>
  <button class="tab-btn px-4 py-2 rounded-t font-semibold transition min-w-max" data-tab="editor">New Post</button>
  <button class="tab-btn px-4 py-2 rounded-t font-semibold transition min-w-max" data-tab="earnings">Earnings</button>
  <button class="tab-btn px-4 py-2 rounded-t font-semibold transition min-w-max" data-tab="messages">Messages</button>
  <button class="tab-btn px-4 py-2 rounded-t font-semibold transition min-w-max" data-tab="settings">Settings</button>
  <button class="tab-btn px-4 py-2 rounded-t font-semibold transition min-w-max" data-tab="help">Help</button>
  <button class="tab-btn px-4 py-2 rounded-t font-semibold transition min-w-max" data-tab="postlinks">Post Links</button> <!-- New Tab -->
</div>
    <section>
      <div class="tab-content" id="tab-myposts">
        <h2 class="text-xl font-bold text-indigo-700 mb-6 flex items-center justify-between">
          My Posts
          <button id="toEditorBtn" class="bg-indigo-600 text-white font-semibold px-4 py-2 rounded-full shadow hover:bg-indigo-700 transition text-sm">+ New Post</button>
        </h2>
        <div id="myPostsList" class="flex flex-col gap-6"></div>
      </div>
      <div class="tab-content hidden" id="tab-editor">
        <nav class="flex items-center text-xs text-gray-400 space-x-2 mb-4">
          <span class="hover:text-indigo-600 cursor-pointer" onclick="tabSwitch('myposts')">Home</span>
          <span>/</span>
          <span class="hover:text-indigo-600 cursor-pointer" onclick="tabSwitch('myposts')">Posts</span>
          <span>/</span>
          <span class="text-indigo-700">Text Editor</span>
        </nav>
        <h2 class="text-2xl font-bold text-gray-800 mb-4">Add a new post</h2>
        <div class="flex items-center gap-2 mb-6">
          <button id="trashBtn" class="bg-red-100 text-red-600 px-4 py-2 rounded font-semibold hover:bg-red-200 transition flex items-center gap-1">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M6 18L18 6M6 6l12 12"/></svg>
            Trash
          </button>
          <button id="scheduleBtn" class="bg-gray-100 text-gray-700 px-4 py-2 rounded font-semibold hover:bg-gray-200 transition flex items-center gap-1">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M8 7V3M16 7V3M4 11h16M5 19h14"/></svg>
            Schedule
          </button>
          <button id="publishBtn" class="bg-indigo-600 text-white px-4 py-2 rounded font-semibold hover:bg-indigo-700 transition flex items-center gap-1 ml-auto relative">
            <span id="publishSpinner" class="hidden absolute left-2 top-1/2 -translate-y-1/2 w-4 h-4 border-2 border-indigo-500 rounded-full border-t-transparent spinner"></span>
            <span>Publish</span>
          </button>
        </div>
        <form id="postEditorForm" class="space-y-4" enctype="multipart/form-data">
          <div>
            <label class="block font-medium mb-1">Title</label>
            <input type="text" id="postTitle" placeholder="Write your article title here" class="w-full px-3 py-2 border rounded focus:ring-2 focus:ring-indigo-200" required />
          </div>
          <div>
            <label class="block font-medium mb-1">Category</label>
            <select id="postCategory" class="w-full px-3 py-2 border rounded focus:ring-2 focus:ring-indigo-200" required>
              <option value="">Select a category</option>
              <option value="Campus Life">Campus Life</option>
              <option value="Academics">Academics</option>
              <option value="Tips & Hacks">Tips & Hacks</option>
              <option value="Opportunities">Opportunities</option>
              <option value="Events">Events</option>
              <option value="General">General</option>
            </select>
          </div>
          <div>
            <label class="block font-medium mb-1">Article content</label>
            <div id="editor" class="bg-white rounded border"></div>
          </div>
          <div>
            <label class="block font-medium mb-1">Featured Images (max 3, jpg/png/gif, 5MB each)</label>
            <input type="file" id="imageUpload" accept="image/*" multiple class="w-full px-3 py-2 border rounded focus:ring-2 focus:ring-yellow-200" />
            <div id="imagePreview" class="flex gap-2 mt-3"></div>
          </div>
          <div class="flex gap-3 mt-6">
            <button type="button" onclick="tabSwitch('myposts')" class="px-4 py-2 rounded bg-gray-100 text-gray-700 hover:bg-gray-200 font-semibold transition">Cancel</button>
            <button type="submit" id="saveDraftBtn" class="px-6 py-2 rounded bg-indigo-600 text-white hover:bg-indigo-700 font-semibold transition relative">
              <span id="draftSpinner" class="hidden absolute left-2 top-1/2 -translate-y-1/2 w-4 h-4 border-2 border-indigo-500 rounded-full border-t-transparent spinner"></span>
              Save Draft
            </button>
            <button type="button" id="previewBtn" class="px-6 py-2 rounded bg-white text-indigo-600 border border-indigo-200 hover:bg-indigo-50 font-semibold transition">Preview</button>
          </div>
        </form>
      </div>
      <div class="tab-content hidden" id="tab-earnings">
        <h2 class="text-xl font-bold text-indigo-700 mb-6">Earnings & Stats</h2>
        <div class="grid md:grid-cols-3 gap-8 mb-8">
          <div class="bg-white border border-indigo-100 rounded-xl shadow p-6 flex flex-col items-center">
            <span class="text-4xl mb-2 text-indigo-600">üí∞</span>
            <div class="font-bold text-indigo-700 text-2xl mb-1" id="earningsTotal">‚Ç¶0</div>
            <div class="text-sm text-indigo-700">Total Earned</div>
            <button class="mt-3 bg-indigo-600 text-white px-4 py-2 rounded font-bold hover:bg-indigo-700 transition">Withdraw</button>
          </div>
          <div class="bg-white border border-indigo-100 rounded-xl shadow p-6 flex flex-col items-center">
            <span class="text-4xl mb-2 text-yellow-500">‚≠ê</span>
            <div class="font-bold text-indigo-700 text-2xl mb-1" id="avgRating">0.0</div>
            <div class="text-sm text-indigo-700">Avg. Rating</div>
            <button class="mt-3 bg-yellow-400 text-blue-900 px-4 py-2 rounded font-bold hover:bg-indigo-600 hover:text-white transition">See Reviews</button>
          </div>
          <div class="bg-white border border-indigo-100 rounded-xl shadow p-6 flex flex-col items-center">
            <span class="text-4xl mb-2 text-blue-900">üìù</span>
            <div class="font-bold text-indigo-700 text-2xl mb-1" id="postsCount">0</div>
            <div class="text-sm text-indigo-700">Posts Published</div>
            <button class="mt-3 bg-indigo-600 text-white px-4 py-2 rounded font-bold hover:bg-indigo-700 transition">New Post</button>
          </div>
        </div>
        <div>
          <h4 class="font-bold text-blue-900 mb-2">Recent Activity</h4>
          <ul class="bg-white rounded-xl p-4 shadow space-y-2 border border-indigo-100" id="recentActivity"></ul>
        </div>
      </div>
      <div class="tab-content hidden" id="tab-messages">
        <h2 class="text-xl font-bold text-indigo-700 mb-5">Messages & Comments</h2>
        <div class="bg-white rounded-xl shadow p-4 flex flex-col border border-indigo-100 space-y-3" id="messagesList"></div>
        <div class="mt-6">
          <h3 class="font-bold text-blue-900 mb-2">Send a Message</h3>
          <form id="blogMsgForm" class="flex gap-2">
            <input type="text" id="msgText" placeholder="Type a message..." class="flex-1 px-3 py-2 border rounded" required />
            <button type="submit" class="bg-indigo-600 text-white px-4 py-2 rounded font-bold hover:bg-indigo-700 transition">Send</button>
          </form>
        </div>
      </div>
      <div class="tab-content hidden" id="tab-settings">
        <h2 class="text-xl font-bold text-indigo-700 mb-6">Profile & Settings</h2>
        <form class="space-y-4 max-w-xl" id="settingsForm">
          <div>
            <label class="block font-medium mb-1">Display Name</label>
            <input type="text" id="profileName" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-200" />
          </div>
          <div>
            <label class="block font-medium mb-1">Email</label>
            <input type="email" id="profileEmail" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-200" />
          </div>
          <div>
            <label class="block font-medium mb-1">Bio</label>
            <textarea id="profileBio" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-200" rows="2"></textarea>
          </div>
          <div>
            <label class="block font-medium mb-1">Notifications</label>
            <div class="flex gap-3">
              <label class="flex items-center gap-2"><input type="checkbox" id="notifyEmail"> Email Alerts</label>
              <label class="flex items-center gap-2"><input type="checkbox" id="notifySMS"> SMS Alerts</label>
              <label class="flex items-center gap-2"><input type="checkbox" id="notifyPush"> Push Notifications</label>
            </div>
          </div>
          <button type="submit" class="bg-indigo-600 text-white px-6 py-2 rounded font-bold hover:bg-indigo-700 transition">Save Settings</button>
        </form>
      </div>
        <!-- New tab for Post Links -->
  <div class="tab-content hidden" id="tab-postlinks">
    <h2 class="text-xl font-bold text-indigo-700 mb-6">Post Links</h2>
    <ul id="postsLinkList" class="space-y-3"></ul>
  </div>
      <div class="tab-content hidden" id="tab-help">
        <h2 class="text-xl font-bold text-indigo-600 mb-6">Help & Support</h2>
        <div class="bg-white rounded-xl shadow p-4 flex flex-col gap-4 border border-indigo-100">
          <div class="flex items-center gap-2 mb-2">
            <span class="text-blue-900 font-bold">Need Help?</span>
            <span class="ml-auto text-xs bg-indigo-100 text-indigo-800 px-2 rounded-full">Blogger</span>
          </div>
          <div class="h-32 overflow-y-auto border rounded p-2 mb-2 text-sm text-gray-700 bg-gray-50" id="helpBox"></div>
          <form id="helpForm" class="flex gap-2">
            <input id="helpInput" type="text" placeholder="Type a support message..." class="flex-1 px-3 py-2 border rounded" required />
            <button type="submit" class="bg-indigo-600 text-white px-4 py-2 rounded font-bold hover:bg-indigo-700 transition">Send</button>
          </form>
        </div>
      </div>
    </section>
  </main>
  <div id="previewModal" class="preview-modal-bg fixed inset-0 z-50 hidden flex items-center justify-center">
    <div class="bg-white rounded-xl shadow-lg w-full max-w-2xl mx-auto p-6 relative">
      <button id="closePreviewModal" class="absolute top-3 right-3 text-gray-400 hover:text-blue-900">
        <svg aria-hidden="true" class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
            d="M6 18L18 6M6 6l12 12"></path>
        </svg>
      </button>
      <h3 class="font-bold text-2xl text-indigo-700 mb-4" id="previewModalTitle"></h3>
      <div class="post-preview-content prose" id="previewModalContent"></div>
      <div id="previewImages" class="flex gap-3 mt-4"></div>
    </div>
  </div>
  <script>
    const BACKEND = "https://examguide.onrender.com";
    function getToken() { return localStorage.token || sessionStorage.token || ''; }
    function authHeader() { return { 'Authorization': 'Bearer ' + getToken() }; }
function renderPostLinks() {
    const el = document.getElementById('postsLinkList');
    if (!posts.length) {
      el.innerHTML = `<div class="text-gray-400 py-6">No posts to display.</div>`;
      return;
    }
    el.innerHTML = posts.map(post => {
      // This slug logic should match your static generator's logic
      const slug = (post.title || "")
        .toLowerCase().replace(/[^a-z0-9]+/g, "-").replace(/(^-|-$)/g, "") + "-" + post._id;
      return `<li>
        <a class="text-blue-700 hover:underline font-semibold" target="_blank"
          href="blog/${slug}.html">${post.title}</a>
        <span class="text-xs text-gray-500 ml-2">${post.status || ""}</span>
      </li>`;
    }).join('');
  }
    // LOGOUT AND REDIRECT
    function forceLogout() {
      localStorage.removeItem('token');
      sessionStorage.removeItem('token');
      window.location = "mock-icthallb";
    }

    let posts = [];
    let quill, quillInitialized = false, editingPostId = null;
    let uploadedImages = [];

    function showPostsLoading() {
      document.getElementById('myPostsList').innerHTML = `<div class="flex items-center justify-center py-12"><svg class="animate-spin h-8 w-8 text-indigo-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v8z"></path></svg></div>`;
    }

    async function fetchProfile() {
      try {
        const res = await fetch(BACKEND + "/api/users/me", { headers: { ...authHeader(), "Content-Type": "application/json" } });
        if (res.status === 401 || res.status === 403) return forceLogout();
        if (!res.ok) return;
        const d = await res.json();
        document.getElementById("profileName").value = d.user.fullname || "";
        document.getElementById("profileEmail").value = d.user.email || "";
        document.getElementById("profileBio").value = d.user.bio || "";
        document.getElementById("profileAvatar").src = d.user.profilePic ? d.user.profilePic : `https://ui-avatars.com/api/?name=${encodeURIComponent(d.user.fullname||"User")}&background=FFCE45&color=263159&rounded=true`;
        document.getElementById("notifyEmail").checked = !!d.user.notifyEmail;
        document.getElementById("notifySMS").checked = !!d.user.notifySMS;
        document.getElementById("notifyPush").checked = !!d.user.notifyPush;
      } catch {
        forceLogout();
      }
    }

    async function saveProfile(e) {
      e.preventDefault();
      try {
        const res = await fetch(BACKEND + "/api/users/me", {
          method: "PATCH",
          headers: { ...authHeader(), "Content-Type": "application/json" },
          body: JSON.stringify({
            fullname: document.getElementById("profileName").value,
            email: document.getElementById("profileEmail").value,
            bio: document.getElementById("profileBio").value,
            notifyEmail: document.getElementById("notifyEmail").checked,
            notifySMS: document.getElementById("notifySMS").checked,
            notifyPush: document.getElementById("notifyPush").checked
          })
        });
        if (res.status === 401 || res.status === 403) return forceLogout();
      } catch {
        forceLogout();
      }
    }

    async function fetchPosts() {
      showPostsLoading();
      try {
        const res = await fetch(BACKEND + "/api/blogger-dashboard/myposts", { headers: authHeader() });
        if (res.status === 401 || res.status === 403) return forceLogout();
        if (!res.ok) throw new Error("Failed to fetch posts.");
        posts = await res.json();
        renderMyPosts();
        document.getElementById('postsCount').textContent = posts.length;
        let totalEarnings = 0, totalRating = 0, totalRated = 0;
        let recent = [];
        posts.forEach(post => {
          totalEarnings += post.earnings || 0;
          if (post.rating) { totalRating += post.rating; totalRated++; }
          if (post.status === "Published" && post.date) recent.push(post);
        });
        document.getElementById('earningsTotal').textContent = "‚Ç¶" + totalEarnings.toLocaleString();
        document.getElementById('avgRating').textContent = totalRated ? (totalRating/totalRated).toFixed(2) : "0.0";
        recent.sort((a,b) => new Date(b.date)-new Date(a.date));
        document.getElementById('recentActivity').innerHTML = recent.slice(0, 5).map(p => `<li>+‚Ç¶${p.earnings||0} for "${p.title}" (${p.status||"Draft"})</li>`).join('');
      } catch (err) {
        document.getElementById('myPostsList').innerHTML = `<div class="text-red-500 text-center py-8">Could not load posts. Please try again.</div>`;
      }
    }

    function renderMyPosts() {
      const el = document.getElementById('myPostsList');
      if (!posts.length) {
        el.innerHTML = `<div class="text-gray-500 text-center py-8">No posts yet. Click "New Post" to start blogging!</div>`;
        return;
      }
      el.innerHTML = "";
      posts.forEach(post => {
        let images = Array.isArray(post.images) && post.images.length ? post.images : (post.imageUrl ? [post.imageUrl] : []);
        let imageHtml = images.length
          ? `<img src="${images[0]}" alt="${post.title}" class="rounded-lg w-24 h-24 object-cover mr-3">`
          : '';
        el.innerHTML += `
        <div class="rounded-xl border border-gray-200 shadow p-4 flex flex-col md:flex-row gap-4 items-center bg-white">
          ${imageHtml}
          <div class="flex-1">
            <div class="flex items-center gap-2 mb-2">
              <span class="inline-block bg-indigo-100 text-indigo-800 px-2 py-1 rounded-full text-xs">${post.status || "Draft"}</span>
              <span class="text-xs text-gray-400">${post.date ? new Date(post.date).toLocaleDateString() : ""}</span>
              <span class="ml-auto text-xs text-gray-600">${post.views || 0} views</span>
            </div>
            <div class="font-bold text-lg md:text-xl text-blue-900 mb-1">${post.title}</div>
            <div class="prose prose-sm text-gray-700 mb-2 line-clamp-2" style="max-width:100%">${post.content.replace(/<[^>]+>/g, '').substring(0, 120) + "..."}</div>
            <div class="flex items-center gap-4 mt-2">
              <button onclick="editPost('${post._id}')" class="text-indigo-600 font-semibold hover:underline">Edit</button>
              <button onclick="deletePost('${post._id}')" class="text-red-500 font-semibold hover:underline">Delete</button>
              <button onclick="previewPost('${post._id}')" class="text-blue-600 font-semibold hover:underline">Preview</button>
              <span class="ml-auto text-xs text-yellow-600 font-bold">‚Ç¶${post.earnings || 0} earned</span>
              <span class="text-xs text-indigo-600 font-bold">${post.comments ? post.comments.length : 0} comments</span>
            </div>
          </div>
        </div>
        `;
      });
      document.getElementById('postsCount').textContent = posts.length;
    }

  function initEditor() {
      if(quillInitialized) return;
      quill = new Quill('#editor', {
        theme: 'snow',
        modules: {
          toolbar: [
            [{ 'header': [1, 2, false] }],
            ['bold', 'italic', 'underline', 'strike'],
            [{ 'align': [] }],
            [{ 'color': [] }, { 'background': [] }],
            ['blockquote', 'code-block', 'link', 'image'],
            [{ 'list': 'ordered'}, { 'list': 'bullet' }],
            ['clean']
          ]
        }
      });
      quillInitialized = true;
    }
    setTimeout(initEditor, 50);

  function tabSwitch(tabName) {
    document.querySelectorAll('[data-tab]').forEach(b => b.classList.remove('tab-btn-active'));
    document.querySelector(`[data-tab="${tabName}"]`).classList.add('tab-btn-active');
    document.querySelectorAll('.tab-content').forEach(tab => tab.classList.add('hidden'));
    document.getElementById('tab-' + tabName).classList.remove('hidden');
    if(tabName === 'editor') setTimeout(initEditor, 50);
    if(tabName === 'settings') fetchProfile();
    if(tabName === 'myposts') fetchPosts();
    if(tabName === 'earnings') fetchPosts();
    if(tabName === 'messages') fetchMessages();
    if(tabName === 'postlinks') renderPostLinks();
  }

    

    document.querySelectorAll('[data-tab]').forEach(btn => {
      btn.addEventListener('click', function() { tabSwitch(this.dataset.tab); });
    });
    document.getElementById('toEditorBtn').onclick = () => { tabSwitch('editor'); clearEditor(); };
    document.getElementById('trashBtn').onclick = () => { clearEditor(); };

    function clearEditor() {
      document.getElementById('postTitle').value = "";
      document.getElementById('postCategory').value = "";
      if (quill) quill.setContents([{ insert: '\n' }]);
      editingPostId = null;
      uploadedImages = [];
      document.getElementById("imageUpload").value = "";
      document.getElementById("imagePreview").innerHTML = "";
    }

    // UTIL: Convert file to base64 string
    function fileToBase64(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result); // reader.result is a data URL
        reader.onerror = reject;
        reader.readAsDataURL(file);
      });
    }

    // Image preview and limit (now base64)
    document.getElementById("imageUpload").addEventListener("change", async function(evt) {
      const files = Array.from(evt.target.files);
      if (files.length > 3) {
        alert("You can upload a maximum of 3 images per post.");
        evt.target.value = "";
        return;
      }
      let html = "";
      uploadedImages = [];
      for (const file of files) {
        if (file.size > 5*1024*1024) {
          alert("Each image must be less than 5MB.");
          evt.target.value = "";
          html = "";
          uploadedImages = [];
          return;
        }
        const base64 = await fileToBase64(file);
        html += `<img src="${base64}" class="w-14 h-14 rounded border object-cover" title="${file.name}">`;
        uploadedImages.push(base64); // push base64 string
      }
      document.getElementById("imagePreview").innerHTML = html;
    });

    // SAVE DRAFT AND PUBLISH: Send base64
    document.getElementById('postEditorForm').onsubmit = async function(e){
      e.preventDefault();
      const title = document.getElementById('postTitle').value;
      const category = document.getElementById('postCategory').value;
      const content = quill.root.innerHTML;
      const saveBtn = document.getElementById('saveDraftBtn');
      const draftSpinner = document.getElementById('draftSpinner');
      saveBtn.disabled = true;
      draftSpinner.classList.remove('hidden');
      try {
        let body = {
          title,
          category,
          content,
          status: "Draft",
          images: uploadedImages // array of base64 strings
        };
        let method = editingPostId ? "PUT" : "POST";
        let url = editingPostId
          ? `${BACKEND}/api/blogger-dashboard/posts/${editingPostId}`
          : `${BACKEND}/api/blogger-dashboard/posts`;
        const res = await fetch(url, {
          method,
          headers: {
            'Authorization': 'Bearer ' + getToken(),
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(body)
        });
        if (res.status === 401 || res.status === 403) return forceLogout();
        if (!res.ok) throw new Error(editingPostId ? "Could not update post." : "Could not create post.");
        await fetchPosts();
        tabSwitch('myposts');
        clearEditor();
      } catch (err) {
        alert("There was an error saving your post.");
      } finally {
        saveBtn.disabled = false;
        draftSpinner.classList.add('hidden');
      }
    };

    document.getElementById('publishBtn').onclick = async function() {
      const publishBtn = this;
      const publishSpinner = document.getElementById('publishSpinner');
      publishBtn.disabled = true;
      publishSpinner.classList.remove('hidden');
      const title = document.getElementById('postTitle').value;
      const category = document.getElementById('postCategory').value;
      const content = quill.root.innerHTML;
      try {
        let body = {
          title,
          category,
          content,
          status: "Published",
          images: uploadedImages // array of base64
        };
        let method = editingPostId ? "PUT" : "POST";
        let url = editingPostId
          ? `${BACKEND}/api/blogger-dashboard/posts/${editingPostId}`
          : `${BACKEND}/api/blogger-dashboard/posts`;
        const res = await fetch(url, {
          method,
          headers: {
            'Authorization': 'Bearer ' + getToken(),
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(body)
        });
        if (res.status === 401 || res.status === 403) return forceLogout();
        if (!res.ok) throw new Error("Publish failed.");
        await fetchPosts();
        tabSwitch('myposts');
        clearEditor();
      } catch (err) {
        alert("There was an error publishing your post.");
      } finally {
        publishBtn.disabled = false;
        publishSpinner.classList.add('hidden');
      }
    };

    window.editPost = function(id) {
      const post = posts.find(p => p._id === id);
      if(!post) return;
      tabSwitch('editor');
      setTimeout(() => {
        document.getElementById('postTitle').value = post.title;
        document.getElementById('postCategory').value = post.category || "";
        if (quill) quill.setContents(quill.clipboard.convert(post.content));
        editingPostId = id;
        if (Array.isArray(post.images) && post.images.length) {
          let html = "";
          post.images.forEach(img => {
            html += `<img src="${img}" class="w-14 h-14 rounded border object-cover">`;
          });
          document.getElementById("imagePreview").innerHTML = html;
        } else {
          document.getElementById("imagePreview").innerHTML = "";
        }
      }, 100);
    };

    window.deletePost = async function(id) {
      if(!confirm("Are you sure you want to delete this post?")) return;
      try {
        const res = await fetch(`${BACKEND}/api/blogger-dashboard/posts/${id}`, {
          method: 'DELETE',
          headers: authHeader()
        });
        if (res.status === 401 || res.status === 403) return forceLogout();
        if (!res.ok) throw new Error("Delete failed.");
        await fetchPosts();
      } catch (err) {}
    };

    window.previewPost = function(id) {
      const post = posts.find(p => p._id === id);
      if (!post) return;
      showPreviewModal(post.title, post.content, post.images || (post.imageUrl ? [post.imageUrl] : []));
    };

    function showPreviewModal(title, content, images) {
      document.getElementById('previewModalTitle').innerText = title;
      document.getElementById('previewModalContent').innerHTML = content;
      let html = '';
      if (Array.isArray(images)) {
        images.forEach(img => {
          html += `<img src="${img}" class="w-24 h-24 object-cover rounded border" />`;
        });
      }
      document.getElementById('previewImages').innerHTML = html;
      document.getElementById('previewModal').classList.remove('hidden');
    }
    document.getElementById('closePreviewModal').onclick = function() {
      document.getElementById('previewModal').classList.add('hidden');
    };
    document.getElementById('previewBtn').onclick = function() {
      const title = document.getElementById('postTitle').value || "Untitled Preview";
      const content = quill.root.innerHTML;
      let html = '';
      if (uploadedImages.length) {
        uploadedImages.forEach(img => {
          html += `<img src="${img}" class="w-24 h-24 object-cover rounded border" />`;
        });
      }
      document.getElementById('previewModalTitle').innerText = title;
      document.getElementById('previewModalContent').innerHTML = content;
      document.getElementById('previewImages').innerHTML = html;
      document.getElementById('previewModal').classList.remove('hidden');
    };
    document.getElementById('hamburger-btn').addEventListener('click', function() {
      const menu = document.getElementById('mobile-menu');
      menu.hidden = !menu.hidden;
    });
    document.getElementById('settingsForm').onsubmit = saveProfile;

    async function fetchMessages() {
      try {
        const res = await fetch(BACKEND + "/api/blogger-dashboard/messages", { headers: authHeader() });
        if (res.status === 401 || res.status === 403) return forceLogout();
        if (!res.ok) throw new Error("Failed to fetch messages");
        const data = await res.json();
        document.getElementById('messagesList').innerHTML = data.map(msg => `<div class="flex items-center gap-2"><img src="https://ui-avatars.com/api/?name=${encodeURIComponent(msg.from||'User')}&background=FFCE45&color=263159&rounded=true" class="h-8 w-8 rounded-full border" alt="User"><span class="font-semibold text-blue-900">${msg.from||"User"}</span><span class="text-gray-700">${msg.msg}</span><span class="text-xs text-gray-400 ml-auto">${msg.date ? new Date(msg.date).toLocaleString() : ""}</span></div>`).join('');
      } catch { document.getElementById('messagesList').innerHTML = ""; }
    }

    document.getElementById('blogMsgForm').onsubmit = async function(e){
      e.preventDefault();
      const msgText = document.getElementById('msgText').value;
      if (!msgText.trim()) return;
      try {
        const res = await fetch(BACKEND + "/api/blogger-dashboard/messages", {
          method: "POST",
          headers: { ...authHeader(), "Content-Type": "application/json" },
          body: JSON.stringify({ msg: msgText, date: new Date().toISOString(), from: document.getElementById("profileName").value || "Me" })
        });
        if (res.status === 401 || res.status === 403) return forceLogout();
        fetchMessages();
        this.reset();
      } catch {}
    };

    document.getElementById('helpForm').addEventListener('submit', function(e){
      e.preventDefault();
      const helpInput = document.getElementById('helpInput');
      if (helpInput.value.trim()) {
        const box = document.getElementById('helpBox');
        box.innerHTML += `<div class="mb-1"><span class="font-semibold text-blue-900">You:</span> ${helpInput.value}</div>`;
        box.scrollTop = box.scrollHeight;
        helpInput.value = "";
      }
    });

    document.addEventListener('DOMContentLoaded', () => {
      fetchProfile();
      fetchPosts();
    });
  </script>
</body>
</html>
