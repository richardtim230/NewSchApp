<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Account Settings | OAU ExamGuard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/flowbite/2.3.0/flowbite.min.css" rel="stylesheet" />
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { background: linear-gradient(120deg, #f0f4ff 0%, #fef6e4 100%); min-height:100vh; }
    .settings-card { background: #fff; border-radius: 1.3rem; box-shadow: 0 4px 32px 0 rgba(80,100,180,0.11); }
    .settings-section { margin-bottom: 2.5rem; }
    .file-upload-label { cursor:pointer; }
    .file-upload-label:hover { background: #f3f4f6; }
    .file-info { font-size:0.98em; color:#555; margin-top:3px; }
  </style>
</head>
<body class="min-h-screen flex items-center justify-center px-2 py-8">
  <main class="w-full max-w-lg mx-auto settings-card p-9">
    <h1 class="text-2xl font-extrabold text-indigo-800 mb-6 text-center tracking-tight">Account Settings</h1>

    <form id="settingsForm" class="space-y-8" autocomplete="off">

      <!-- Contact Details -->
      <section class="settings-section">
        <h2 class="text-lg font-semibold text-indigo-700 mb-4">Contact Information</h2>
        <div class="flex flex-col gap-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1" for="fullname">Full Name</label>
            <input type="text" id="fullname" name="fullname" class="form-input w-full rounded-lg border-gray-300 bg-gray-50" required readonly>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1" for="email">Email</label>
            <input type="email" id="email" name="email" class="form-input w-full rounded-lg border-gray-300 bg-gray-50" required readonly>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1" for="phone">Phone Number</label>
            <input type="tel" id="phone" name="phone" class="form-input w-full rounded-lg border-gray-300 bg-gray-50" required readonly>
          </div>
        </div>
      </section>

      <!-- Account Details -->
      <section class="settings-section">
        <h2 class="text-lg font-semibold text-indigo-700 mb-4">Account Details</h2>
        <div class="flex flex-col gap-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1" for="bank">Bank Name</label>
            <input type="text" id="bank" name="bank" class="form-input w-full rounded-lg border-gray-300" required>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1" for="accountName">Account Name</label>
            <input type="text" id="accountName" name="accountName" class="form-input w-full rounded-lg border-gray-300" required>
            <span id="acctNameCheck" class="text-xs font-semibold"></span>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1" for="accountNumber">Account Number</label>
            <input type="text" id="accountNumber" name="accountNumber" maxlength="12" pattern="\d{10,12}" class="form-input w-full rounded-lg border-gray-300" required>
            <span class="text-xs text-gray-400">10-12 digits</span>
          </div>
        </div>
      </section>

      <!-- Verification Documents -->
      <section class="settings-section">
        <h2 class="text-lg font-semibold text-indigo-700 mb-4">Identity Verification</h2>
        <div class="flex flex-col gap-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1" for="idType">ID Type</label>
            <select name="idType" id="idType" class="form-select w-full rounded-lg border-gray-300" required>
              <option value="">Select ID Type</option>
              <option value="studentId">Student ID Card</option>
              <option value="nationalId">National ID Card</option>
              <option value="votersCard">Voter's Card</option>
              <option value="driverLicense">Driver's License</option>
              <option value="passport">International Passport</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1 file-upload-label" for="idDocument">
              Upload ID Document (jpg, png, or pdf)
            </label>
            <input type="file" id="idDocument" name="idDocument" accept=".jpg,.jpeg,.png,.pdf" class="block" required>
            <span id="idDocInfo" class="file-info"></span>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1 file-upload-label" for="proofOfAddress">
              Upload Proof of Address (jpg, png, or pdf)
            </label>
            <input type="file" id="proofOfAddress" name="proofOfAddress" accept=".jpg,.jpeg,.png,.pdf" class="block" required>
            <span id="addrDocInfo" class="file-info"></span>
          </div>
        </div>
      </section>

      <button type="submit" class="w-full bg-indigo-700 text-white font-bold py-3 rounded-lg shadow hover:bg-indigo-900 transition text-lg">Save Settings</button>
      <div id="settingsMsg" class="text-center mt-4 text-base"></div>
    </form>
  </main>
  <script>
    const API_BASE = "https://examguide.onrender.com/api";
    // 1. Autofill profile fields
    let currentProfile = {};
    async function autoFillProfile() {
      const token = localStorage.getItem('token');
      if (!token) return;
      try {
        const resp = await fetch(`${API_BASE}/auth/me`, {
          headers: { "Authorization": "Bearer " + token }
        });
        if (!resp.ok) throw new Error();
        const data = await resp.json();
        currentProfile = data.user || data || {};
        document.getElementById("fullname").value = currentProfile.fullname || "";
        document.getElementById("email").value = currentProfile.email || "";
        document.getElementById("phone").value = currentProfile.phone || "";
      } catch {
        document.getElementById("settingsMsg").textContent = "Unable to load profile. Please log in again.";
        document.getElementById("settingsMsg").className = "text-center mt-4 text-base text-red-600";
      }
    }
    autoFillProfile();

    // 2. File name display
    document.getElementById('idDocument').addEventListener('change', function() {
      const file = this.files[0];
      document.getElementById('idDocInfo').textContent = file ? file.name : "";
    });
    document.getElementById('proofOfAddress').addEventListener('change', function() {
      const file = this.files[0];
      document.getElementById('addrDocInfo').textContent = file ? file.name : "";
    });

    // 3. Account name check (live validation)
    document.getElementById('accountName').addEventListener('input', function() {
      const acctName = this.value.trim().toLowerCase();
      const profileName = (document.getElementById('fullname').value || "").trim().toLowerCase();
      const check = document.getElementById('acctNameCheck');
      if (!acctName) {
        check.textContent = "";
        return;
      }
      if (profileName && acctName !== profileName) {
        check.textContent = "Account Name must match your profile name!";
        check.className = "text-xs font-semibold text-red-600";
      } else {
        check.textContent = "Match!";
        check.className = "text-xs font-semibold text-green-600";
      }
    });

    // 4. Settings Save Handler
    document.getElementById('settingsForm').onsubmit = async function(e) {
      e.preventDefault();
      const msg = document.getElementById('settingsMsg');
      msg.textContent = "";
      msg.className = "text-center mt-4 text-base";
      const token = localStorage.getItem('token');
      if (!token) {
        msg.textContent = "Session expired. Please log in.";
        msg.classList.add("text-red-600");
        return;
      }
      // Check account name
      const acctName = document.getElementById('accountName').value.trim().toLowerCase();
      const profileName = (document.getElementById('fullname').value || "").trim().toLowerCase();
      if (acctName !== profileName) {
        msg.textContent = "Account Name must match your profile name!";
        msg.classList.add("text-red-600");
        document.getElementById('accountName').focus();
        return;
      }
      // Collect form data
      const formData = new FormData();
      formData.append("fullname", document.getElementById('fullname').value);
      formData.append("email", document.getElementById('email').value);
      formData.append("phone", document.getElementById('phone').value);
      formData.append("bank", document.getElementById('bank').value);
      formData.append("accountName", document.getElementById('accountName').value);
      formData.append("accountNumber", document.getElementById('accountNumber').value);
      formData.append("idType", document.getElementById('idType').value);
      if (document.getElementById('idDocument').files[0])
        formData.append("idDocument", document.getElementById('idDocument').files[0]);
      if (document.getElementById('proofOfAddress').files[0])
        formData.append("proofOfAddress", document.getElementById('proofOfAddress').files[0]);

      // POST to /api/account-settings (assumed endpoint)
      try {
        msg.textContent = "Saving...";
        msg.className = "text-center mt-4 text-base text-blue-700";
        const resp = await fetch(`${API_BASE}/account-settings`, {
          method: "POST",
          headers: { "Authorization": "Bearer " + token },
          body: formData
        });
        const data = await resp.json();
        if (resp.ok && data.success) {
          msg.textContent = "Account settings saved and submitted for verification!";
          msg.className = "text-center mt-4 text-base text-green-600";
        } else {
          msg.textContent = data.error || "Failed to save settings. Try again.";
          msg.className = "text-center mt-4 text-base text-red-600";
        }
      } catch (err) {
        msg.textContent = "Network error. Please try again.";
        msg.className = "text-center mt-4 text-base text-red-600";
      }
    };
  </script>
</body>
</html>
