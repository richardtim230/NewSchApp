
<!doctype html>
<html lang="en" class="h-full bg-gray-100">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>OAU ExamGuard — Earnings & Finance</title>

  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <!-- jsPDF (for PDF export) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <style>
    /* small utilities consistent with other pages */
    .card-glow { background: linear-gradient(180deg, #ffffff, #fbfdff); box-shadow: 0 8px 20px rgba(99,102,241,0.08); }
    .muted { color: #6b7280; }
    .dot-credit { width:8px;height:8px;border-radius:50%;background:#10b981;display:inline-block;margin-right:6px;}
    .dot-debit { width:8px;height:8px;border-radius:50%;background:#ef4444;display:inline-block;margin-right:6px;}
    .hide-scrollbar::-webkit-scrollbar { display:none; }
  </style>
</head>
<body class="h-full bg-gray-100 font-sans text-sm">

  <!-- Mobile Overlay -->
  <div id="mobileDrawerOverlay" onclick="toggleMobileDrawer(false)" class="fixed inset-0 bg-black bg-opacity-40 z-40 hidden"></div>
  <!-- Mobile Sidebar -->
  <aside id="mobileSidebar"
    class="fixed z-50 top-0 left-0 bottom-0 w-64 bg-[#2852a0] text-white transform -translate-x-full md:hidden transition-transform duration-300 ease-in-out"
    style="background:linear-gradient(180deg,#2852a0 0%,#467ae6 100%);">
    <div class="h-full flex flex-col py-5">
      <div class="px-7 py-3 mb-2">
        <h2 class="font-bold text-2xl tracking-tight leading-tight mb-1">OAU ExamGuard</h2>
        <div class="text-xs text-white/80">Student Dashboard</div>
      </div>
      <nav class="mt-6 flex-1">
        <ul class="flex flex-col gap-3 text-base">
          <li><button class="sidebar-btn sidebar-active w-full py-2 px-7 rounded-l-full flex items-center gap-3" onclick="switchSection('overview',true)"><svg class="w-6 h-6" fill="none" stroke="currentColor"><circle cx="12" cy="12" r="10" stroke-width="2"/><path d="M12 8v4l3 3" stroke-width="2"/></svg>Dashboard</button></li>
          <li><button class="sidebar-btn w-full py-2 px-7 rounded-l-full flex items-center gap-3" onclick="switchSection('mocktests',true)"><svg class="w-6 h-6" fill="none" stroke="currentColor"><rect x="4" y="4" width="16" height="16" rx="2" stroke-width="2"/></svg>Mock Tests</button></li>
          <li><button class="sidebar-btn w-full py-2 px-7 rounded-l-full flex items-center gap-3" onclick="switchSection('pastquestions',true)"><svg class="w-6 h-6" fill="none" stroke="currentColor"><path d="M5 4h14M5 20h14M7 4v16M17 4v16" stroke-width="2"/></svg>Past Questions</button></li>
          <li><button class="sidebar-btn w-full py-2 px-7 rounded-l-full flex items-center gap-3" onclick="switchSection('taskscenter',true)"><svg class="w-6 h-6" fill="none" stroke="currentColor"><path d="M9 12l2 2l4 -4"/><rect x="2" y="2" width="20" height="20" rx="5" stroke-width="2"/></svg>Tasks Center</button></li>
          <li><button class="sidebar-btn w-full py-2 px-7 rounded-l-full flex items-center gap-3" onclick="switchSection('resources',true)"><svg class="w-6 h-6" fill="none" stroke="currentColor"><path d="M5 20h14M7 20V7a2 2 0 012-2h6a2 2 0 012 2v13" stroke-width="2"/></svg>Study Resources</button></li>
          <li><button class="sidebar-btn w-full relative py-2 px-7 rounded-l-full flex items-center gap-3" onclick="switchSection('messages',true)"><svg class="w-6 h-6" fill="none" stroke="currentColor"><path d="M21 10.5A8.38 8.38 0 013 10.5c0-5.25 7.5-9 9-9s9 3.75 9 9z"/><circle cx="12" cy="10" r="2"/></svg>Messages<span class="sidebar-dot absolute right-5 top-3"></span></button></li>
          <li><button class="sidebar-btn w-full py-2 px-7 rounded-l-full flex items-center gap-3" onclick="switchSection('settings',true)"><svg class="w-6 h-6" fill="none" stroke="currentColor"><circle cx="12" cy="8" r="4" stroke-width="2"/><path d="M6 20v-2a4 4 0 014-4h4a4 4 0 014 4v2" stroke-width="2"/></svg>Profile Settings</button></li>
          <li><button class="sidebar-btn w-full py-2 px-7 rounded-l-full flex items-center gap-3" onclick="switchSection('assignments',true)"><svg class="w-6 h-6" fill="none" stroke="currentColor"><path d="M4 7h16M4 17h16"/><rect x="2" y="2" width="20" height="20" rx="2" stroke-width="2"/></svg>Assignment</button></li>
          <li><button class="sidebar-btn w-full py-2 px-7 rounded-l-full flex items-center gap-3" onclick="switchSection('studyPadi',true)"><svg class="w-6 h-6" fill="none" stroke="currentColor"><rect x="3" y="4" width="18" height="14" rx="2"/><path d="M16 2v4M8 2v4"/></svg>My StudyPadi</button></li>
          <li><button class="sidebar-btn w-full relative py-2 px-7 rounded-l-full flex items-center gap-3" onclick="switchSection('broadcasts',true)"><svg class="w-6 h-6" fill="none" stroke="currentColor"><path d="M5 15h2a3 3 0 003-3V8m9 7a7 7 0 00-7-7"></path></svg>Broadcasts<span class="sidebar-dot absolute right-5 top-3"></span></button></li>
          <li><button class="sidebar-btn w-full py-2 px-7 rounded-l-full flex items-center gap-3" onclick="switchSection('logout',true)"><svg class="w-6 h-6" fill="none" stroke="currentColor"><path d="M17 16l4-4m0 0l-4-4m4 4H7"/></svg>Logout</button></li>
        </ul>
      </nav>
    </div>
  </aside>

<div>
  <!-- Desktop Sidebar (fixed, scrollable, overlays content only on direct interaction) -->
  <aside class="hidden md:flex fixed pt-20 top-0 left-0 h-full w-64 bg-gradient-to-b from-[#2852a0] to-[#467ae6] text-white flex-col border-r z-30" id="desktopSidebar" style="will-change: transform;">
    <div class="h-full flex flex-col overflow-y-auto">
      <div class="px-7 py-6 mb-2 border-b border-white/10">
        <h2 class="font-bold text-2xl tracking-tight leading-tight mb-1">OAU ExamGuard</h2>
        <div class="text-xs text-white/80">Student Dashboard</div>
      </div>
      <nav class="mt-6 flex-1">
        <ul class="flex flex-col gap-2 text-base" id="desktopSidebarList">
          <!-- Same sidebar buttons as mobile -->
          <li><button class="sidebar-btn sidebar-active w-full py-2 px-7 rounded-l-full flex items-center gap-3" onclick="switchSection('overview')"><svg class="w-6 h-6" fill="none" stroke="currentColor"><circle cx="12" cy="12" r="10" stroke-width="2"/><path d="M12 8v4l3 3" stroke-width="2"/></svg>Dashboard</button></li>
          <li><button class="sidebar-btn w-full py-2 px-7 rounded-l-full flex items-center gap-3" onclick="switchSection('mocktests')"><svg class="w-6 h-6" fill="none" stroke="currentColor"><rect x="4" y="4" width="16" height="16" rx="2" stroke-width="2"/></svg>Mock Tests</button></li>
          <li><button class="sidebar-btn w-full py-2 px-7 rounded-l-full flex items-center gap-3" onclick="switchSection('pastquestions')"><svg class="w-6 h-6" fill="none" stroke="currentColor"><path d="M5 4h14M5 20h14M7 4v16M17 4v16" stroke-width="2"/></svg>Past Questions</button></li>
          <li><button class="sidebar-btn w-full py-2 px-7 rounded-l-full flex items-center gap-3" onclick="switchSection('taskscenter')"><svg class="w-6 h-6" fill="none" stroke="currentColor"><path d="M9 12l2 2l4 -4"/><rect x="2" y="2" width="20" height="20" rx="5" stroke-width="2"/></svg>Tasks Center</button></li>
          <li><button class="sidebar-btn w-full py-2 px-7 rounded-l-full flex items-center gap-3" onclick="switchSection('resources')"><svg class="w-6 h-6" fill="none" stroke="currentColor"><path d="M5 20h14M7 20V7a2 2 0 012-2h6a2 2 0 012 2v13" stroke-width="2"/></svg>Study Resources</button></li>
          <li><button class="sidebar-btn w-full relative py-2 px-7 rounded-l-full flex items-center gap-3" onclick="switchSection('messages')"><svg class="w-6 h-6" fill="none" stroke="currentColor"><path d="M21 10.5A8.38 8.38 0 013 10.5c0-5.25 7.5-9 9-9s9 3.75 9 9z"/><circle cx="12" cy="10" r="2"/></svg>Messages<span class="sidebar-dot absolute right-5 top-3"></span></button></li>
          <li><button class="sidebar-btn w-full py-2 px-7 rounded-l-full flex items-center gap-3" onclick="switchSection('settings')"><svg class="w-6 h-6" fill="none" stroke="currentColor"><circle cx="12" cy="8" r="4" stroke-width="2"/><path d="M6 20v-2a4 4 0 014-4h4a4 4 0 014 4v2" stroke-width="2"/></svg>Profile Settings</button></li>
          <li><button class="sidebar-btn w-full py-2 px-7 rounded-l-full flex items-center gap-3" onclick="switchSection('assignments')"><svg class="w-6 h-6" fill="none" stroke="currentColor"><path d="M4 7h16M4 17h16"/><rect x="2" y="2" width="20" height="20" rx="2" stroke-width="2"/></svg>Assignment</button></li>
          <li><button class="sidebar-btn w-full py-2 px-7 rounded-l-full flex items-center gap-3" onclick="switchSection('studyPadi')"><svg class="w-6 h-6" fill="none" stroke="currentColor"><rect x="3" y="4" width="18" height="14" rx="2"/><path d="M16 2v4M8 2v4"/></svg>My StudyPadi</button></li>
          <li><button class="sidebar-btn w-full relative py-2 px-7 rounded-l-full flex items-center gap-3" onclick="switchSection('broadcasts')"><svg class="w-6 h-6" fill="none" stroke="currentColor"><path d="M5 15h2a3 3 0 003-3V8m9 7a7 7 0 00-7-7"></path></svg>Broadcasts<span class="sidebar-dot absolute right-5 top-3"></span></button></li>
          <li><button class="sidebar-btn w-full py-2 px-7 rounded-l-full flex items-center gap-3" onclick="switchSection('logout')"><svg class="w-6 h-6" fill="none" stroke="currentColor"><path d="M17 16l4-4m0 0l-4-4m4 4H7"/></svg>Logout</button></li>
        </ul>
      </nav>
    </div>
  </aside>


   <div class="md:ml-64 flex flex-col min-h-screen bg-gray-100">
<!-- Responsive Header Block (Mobile & Desktop, Profile Pic from JS) -->
<header
  class="fixed top-0 left-0 right-0 z-40 w-full bg-white border-b px-2 sm:px-4 md:px-8 py-3 flex items-center justify-between shadow-sm overflow-x-hidden"
>
  <div class="flex items-center gap-2 sm:gap-3">
    <button class="md:hidden rounded-full bg-indigo-600 p-2" onclick="toggleMobileDrawer(true)" aria-label="Open sidebar">
      <svg class="w-7 h-7 text-white" fill="none" stroke="currentColor"><path d="M4 6h16M4 12h16M4 18h16"/></svg>
    </button>
    <span class="font-bold text-lg md:text-2xl text-indigo-800">Student Dashboard</span>
  </div>
  <div class="flex items-center gap-3 sm:gap-4">
    <div class="relative w-24 xs:w-28 sm:w-36 md:w-64">
      <input type="text" placeholder="Search..." class="pl-10 pr-3 py-2 w-full rounded-lg border bg-gray-50 focus:outline-none focus:ring focus:border-blue-300 text-sm">
      <div class="absolute left-2 top-2 text-gray-400">
        <svg class="w-5 h-5" fill="none" stroke="currentColor"><circle cx="11" cy="11" r="8"/><path d="M21 21l-4.35-4.35"/></svg>
      </div>
    </div>
    <button type="button" id="notifBtn" class="relative">
      <svg class="w-7 h-7 text-gray-600 hover:text-blue-600" fill="none" stroke="currentColor">
        <path d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6 6 0 10-12 0v3.159c0 .538-.214 1.055-.595 1.436L4 17h5"/>
      </svg>
      <span id="notifBadge" class="absolute top-0 right-0 w-3 h-3 bg-red-500 rounded-full border border-white"></span>
    </button>
    <div class="relative">
      <button type="button" id="profileDropdownBtn">
        <img id="headerProfilePic" class="w-8 h-8 rounded-full border-2 border-indigo-600 object-cover" src="https://ui-avatars.com/api/?name=Student&background=ede9fe&color=3b82f6&size=128&rounded=true" alt="Profile">
      </button>
      <div id="profileDropdown" class="hidden absolute right-0 mt-2 w-48 bg-white rounded shadow-lg z-10">
        <a href="#" class="block px-4 py-2 text-gray-700 hover:bg-indigo-100" onclick="switchSection('profile')">Profile</a>
        <a href="#" class="block px-4 py-2 text-gray-700 hover:bg-indigo-100" onclick="switchSection('settings')">Settings</a>
        <a href="#" class="block px-4 py-2 text-gray-700 hover:bg-indigo-100" onclick="switchSection('logout')">Logout</a>
      </div>
    </div>
  </div>
</header>

<!-- Profile avatar JS update -->
<script>
// Universal profile picture helper
function getProfilePicUrl(student) {
  if (!student) return "https://ui-avatars.com/api/?name=Student&background=ede9fe&color=3b82f6&size=128&rounded=true";
  if (student.profilePic) {
    if (student.profilePic.startsWith("data:image")) return student.profilePic;
    if (student.profilePic.startsWith("http")) return student.profilePic;
    return window.location.origin + student.profilePic;
  }
  const name = encodeURIComponent(student.fullname || student.username || "Student");
  return `https://ui-avatars.com/api/?name=${name}&background=ede9fe&color=3b82f6&size=128&rounded=true`;
}

function updateHeaderProfilePic(student) {
  const img = document.getElementById("headerProfilePic");
  if (img) img.src = getProfilePicUrl(student);
}



// Example async loader
async function fetchStudentProfile() {
  try {
    const resp = await fetch('https://examguide.onrender.com/api/auth/me', { credentials: 'include' });
    const data = await resp.json();
    student = data.user; // Adjust if your API shape is different
    updateHeaderProfilePic(student);
    // More code to populate the rest of user details
  } catch (err) {
    console.error('Failed to fetch student profile:', err);
  }
}

// Ensure DOM is loaded before running code
document.addEventListener("DOMContentLoaded", function() {
  fetchStudentProfile();
});
</script>

  <main class="pt-20 max-w-6xl mx-auto px-4 md:px-6 pb-12">

    <!-- Top: Bank Details Card & Quick Earnings Summary -->
    <section class="grid grid-cols-1 lg:grid-cols-3 gap-6">
      <!-- Bank Card -->
      <div class="col-span-2 card-glow p-6 rounded-xl">
        <div class="flex justify-between items-start">
          <div>
            <div class="text-xs muted">Primary Account</div>
            <div id="bankAccountName" class="text-lg font-semibold text-indigo-800 mt-1">Account Name</div>
            <div id="bankDetailsRow" class="text-sm muted mt-1">Bank · Account number</div>
          </div>

          <div class="flex flex-col items-end gap-2">
            <div class="text-xs muted">Available Balance</div>
            <div id="balanceDisplay" class="text-2xl font-bold text-indigo-700">₦0.00</div>
            <div class="flex gap-2 mt-2">
              <button id="historyBtn" class="bg-indigo-600 text-white px-3 py-1 rounded hover:bg-indigo-700 text-sm">History</button>
              <button id="transferBtn" class="bg-white border border-indigo-200 px-3 py-1 rounded hover:bg-indigo-50 text-sm">Transfer</button>
            </div>
          </div>
        </div>

        <div class="mt-5 grid grid-cols-1 sm:grid-cols-2 gap-4 items-center">
          <div>
            <div class="text-xs muted">Last payout</div>
            <div id="lastPayout" class="text-sm font-medium">—</div>
          </div>
          <div class="flex gap-2 justify-start sm:justify-end">
            <button id="withdrawBtn" class="bg-amber-500 hover:bg-amber-600 text-white px-4 py-2 rounded font-semibold">Withdraw</button>
            <button id="exportCsvBtn" class="bg-gray-100 border rounded px-3 py-2 hover:bg-gray-200">Export CSV</button>
            <button id="downloadPdfBtn" class="bg-gray-100 border rounded px-3 py-2 hover:bg-gray-200">Download PDF</button>
          </div>
        </div>

        <div class="mt-6 w-full">
          <div class="text-xs muted">Balance breakdown</div>
          <div class="mt-2 grid grid-cols-2 sm:grid-cols-4 gap-3">
            <div class="bg-indigo-50 rounded p-3 text-center">
              <div class="text-xs muted">Total Earned</div>
              <div id="statTotalEarned" class="text-sm font-semibold text-indigo-700">₦0</div>
            </div>
            <div class="bg-green-50 rounded p-3 text-center">
              <div class="text-xs muted">Pending</div>
              <div id="statPending" class="text-sm font-semibold text-green-700">₦0</div>
            </div>
            <div class="bg-red-50 rounded p-3 text-center">
              <div class="text-xs muted">Withdrawn</div>
              <div id="statWithdrawn" class="text-sm font-semibold text-red-600">₦0</div>
            </div>
            <div class="bg-yellow-50 rounded p-3 text-center">
              <div class="text-xs muted">Fees</div>
              <div id="statFees" class="text-sm font-semibold text-amber-600">₦0</div>
            </div>
          </div>
        </div>
      </div>

      <!-- Earnings Chart Card -->
      <div class="card-glow p-6 rounded-xl">
        <div class="flex justify-between items-center">
          <div>
            <div class="text-xs muted">Earnings (last 6 months)</div>
            <div class="text-lg font-semibold text-indigo-800 mt-1">Performance</div>
          </div>
          <div>
            <select id="chartRange" class="border rounded px-2 py-1 text-sm">
              <option value="6">6 months</option>
              <option value="3">3 months</option>
              <option value="12">12 months</option>
            </select>
          </div>
        </div>
        <div class="mt-4">
          <canvas id="earningsChart" height="220"></canvas>
        </div>
      </div>
    </section>

    <!-- Transactions & Filters -->
    <section class="mt-8">
      <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
        <div>
          <h2 class="text-xl font-bold text-indigo-800">Transaction History</h2>
          <div class="text-xs muted">Recent deposits, payouts and charges</div>
        </div>

        <div class="flex flex-col sm:flex-row gap-2 items-stretch">
          <div class="flex gap-2 items-center">
            <select id="filterType" class="border rounded px-2 py-2 text-sm">
              <option value="all">All Types</option>
              <option value="credit">Credits</option>
              <option value="debit">Debits</option>
            </select>

            <input id="fromDate" type="date" class="border rounded px-2 py-2 text-sm" />
            <input id="toDate" type="date" class="border rounded px-2 py-2 text-sm" />
          </div>

          <div class="flex gap-2">
            <button id="applyFiltersBtn" class="bg-indigo-600 text-white px-4 py-2 rounded">Apply</button>
            <button id="resetFiltersBtn" class="bg-white border px-4 py-2 rounded">Reset</button>
          </div>
        </div>
      </div>

      <div class="mt-4 bg-white rounded-xl shadow overflow-auto">
        <table class="min-w-full text-left">
          <thead class="bg-indigo-50 text-indigo-700">
            <tr>
              <th class="px-4 py-3">#</th>
              <th class="px-4 py-3">Date</th>
              <th class="px-4 py-3">Description</th>
              <th class="px-4 py-3">Type</th>
              <th class="px-4 py-3 text-right">Amount</th>
            </tr>
          </thead>
          <tbody id="transactionsBody" class="divide-y divide-gray-100">
            <!-- rows injected by JS -->
          </tbody>
        </table>
      </div>

      <!-- Pagination -->
      <div class="mt-4 flex items-center justify-between">
        <div class="text-sm muted" id="transactionsSummary">Showing 0 transactions</div>
        <div class="flex items-center gap-2">
          <button id="prevPage" class="px-3 py-1 rounded bg-gray-100" disabled>Previous</button>
          <span id="pageInfo" class="text-sm muted">Page 1</span>
          <button id="nextPage" class="px-3 py-1 rounded bg-gray-100" disabled>Next</button>
        </div>
      </div>
    </section>
  </main>

  <!-- Minimal footer -->
  <footer class="mt-12 text-center text-xs text-gray-400 pb-8">
    © OAU ExamGuard — Earnings
  </footer>

  <!-- Modal: Transaction Details -->
  <div id="txModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden items-center justify-center">
    <div class="bg-white rounded-xl w-full max-w-2xl p-6 relative">
      <button class="absolute top-3 right-3 text-gray-500" onclick="closeTxModal()">×</button>
      <h3 class="text-lg font-semibold text-indigo-800" id="txModalTitle">Transaction</h3>
      <div class="mt-3 text-sm" id="txModalBody"></div>
      <div class="mt-4 text-right">
        <button class="px-4 py-2 rounded bg-indigo-600 text-white" onclick="closeTxModal()">Close</button>
      </div>
    </div>
  </div>

<script>
let student = null;
    async function fetchStudentProfile() {
  try {
    // Update with your actual API endpoint
    const resp = await fetch('https://examguide.onrender.com/api/auth/me', { credentials: 'include' });
    const data = await resp.json();
    student = data.user; // Adapt if your response shape differs
    updateHeaderProfilePic(student);
    populateUserDetails();
    // Any additional UI functions needing student
  } catch (err) {
    console.error('Failed to fetch student', err);
    // Optionally show error message or fallback UI
  }
}
          // Section show/hide
    function toggleMobileDrawer(show) {
      const sidebar = document.getElementById('mobileSidebar');
      const overlay = document.getElementById('mobileDrawerOverlay');
      if (show) {
        sidebar.classList.remove('-translate-x-full');
        overlay.classList.remove('hidden');
      } else {
        sidebar.classList.add('-translate-x-full');
        overlay.classList.add('hidden');
      }
    }
    function switchSection(section, isMobile) {
      if(isMobile) toggleMobileDrawer(false);
      document.querySelectorAll('.section-block').forEach(s => s.classList.add('hidden'));
      if(document.getElementById(section + '-section'))
        document.getElementById(section + '-section').classList.remove('hidden');
      const allLists = [document.getElementById('desktopSidebarList'), document.querySelector('aside#mobileSidebar nav ul')];
      allLists.forEach(list => {
        if (!list) return;
        Array.from(list.children).forEach((li, i) => {
          if (li.querySelector('.sidebar-btn')) {
            const sectionsOrder = ['overview','mocktests','pastquestions','taskscenter','resources','messages','profile','assignments','studyPadi','broadcasts','settings','logout'];
            if(i===sectionsOrder.indexOf(section)) {
              li.querySelector('.sidebar-btn').classList.add('sidebar-active');
            } else {
              li.querySelector('.sidebar-btn').classList.remove('sidebar-active');
            }
          }
        });
      });
    }
    document.getElementById('profileDropdownBtn').addEventListener('click', function(e) {
      e.stopPropagation();
      document.getElementById('profileDropdown').classList.toggle('hidden');
    });
    document.getElementById('notifBtn').addEventListener('click', function(e){
      alert('You have 2 new notifications!');
    });
    window.addEventListener('click', function(e){
      if (!document.getElementById('profileDropdownBtn').contains(e.target)) {
        document.getElementById('profileDropdown').classList.add('hidden');
      }
    });

const API_BASE = "https://examguide.onrender.com/api/"; // adapt to your API
let wallet = null;
let transactions = [];
let filteredTransactions = [];
let currentPage = 1;
const pageSize = 8;

// Utility: format currency
function formatCurrency(n) {
  if (n === null || typeof n === "undefined") return "₦0.00";
  const num = typeof n === "string" ? parseFloat(n) || 0 : (n || 0);
  return new Intl.NumberFormat('en-NG', { style: 'currency', currency: 'NGN', maximumFractionDigits: 2 }).format(num);
}

// Sample fallback data
const MOCK_WALLET = {
  accountName: "Alex Johnson",
  accountNumber: "0123456789",
  bankName: "First National Bank",
  balance: 45230.75,
  totalEarned: 125000.50,
  pending: 4500,
  withdrawn: 72000,
  fees: 1269.5,
  lastPayout: "2026-01-10T09:20:00Z"
};

const MOCK_TXS = [
  { id: "t1", date: "2026-01-10T09:20:00Z", desc: "Payout: January", type: "debit", amount: 15000 },
  { id: "t2", date: "2026-01-05T13:12:00Z", desc: "Sale: Mock Test Package", type: "credit", amount: 3500 },
  { id: "t3", date: "2025-12-28T18:02:00Z", desc: "Referral bonus", type: "credit", amount: 1200 },
  { id: "t4", date: "2025-11-21T08:30:00Z", desc: "Withdrawal", type: "debit", amount: 20000 },
  { id: "t5", date: "2025-11-15T10:00:00Z", desc: "Sale: E-book", type: "credit", amount: 800 },
  { id: "t6", date: "2025-10-10T09:50:00Z", desc: "Payout: Oct", type: "debit", amount: 12000 },
  { id: "t7", date: "2025-09-12T12:00:00Z", desc: "Sale: Premium Mock", type: "credit", amount: 9500 },
  { id: "t8", date: "2025-08-30T11:30:00Z", desc: "Fee", type: "debit", amount: 269.5 },
  { id: "t9", date: "2025-07-21T08:20:00Z", desc: "Sale: Course", type: "credit", amount: 22000 },
  { id: "t10", date: "2025-06-05T14:00:00Z", desc: "Referral bonus", type: "credit", amount: 1000 }
];

// DOM refs
const bankAccountNameEl = document.getElementById("bankAccountName");
const bankDetailsRowEl = document.getElementById("bankDetailsRow");
const balanceDisplayEl = document.getElementById("balanceDisplay");
const lastPayoutEl = document.getElementById("lastPayout");
const statTotalEarnedEl = document.getElementById("statTotalEarned");
const statPendingEl = document.getElementById("statPending");
const statWithdrawnEl = document.getElementById("statWithdrawn");
const statFeesEl = document.getElementById("statFees");
const transactionsBody = document.getElementById("transactionsBody");
const transactionsSummary = document.getElementById("transactionsSummary");
const pageInfo = document.getElementById("pageInfo");
const prevPageBtn = document.getElementById("prevPage");
const nextPageBtn = document.getElementById("nextPage");

const globalSearchInput = document.getElementById("globalSearch");
const filterType = document.getElementById("filterType");
const fromDate = document.getElementById("fromDate");
const toDate = document.getElementById("toDate");
const applyFiltersBtn = document.getElementById("applyFiltersBtn");
const resetFiltersBtn = document.getElementById("resetFiltersBtn");
const exportCsvBtn = document.getElementById("exportCsvBtn");
const downloadPdfBtn = document.getElementById("downloadPdfBtn");
const historyBtn = document.getElementById("historyBtn");

// Chart
let earningsChart = null;

// Fetch wallet summary & transactions
async function loadFinance() {
  try {
    // Attempt to fetch wallet
    const token = localStorage.getItem("token");
    let walletRes = await fetch(API_BASE + "finance/wallet", { credentials: "include", headers: token ? { Authorization: "Bearer " + token } : {} });
    if (!walletRes.ok) throw new Error("wallet fetch failed");
    const walletData = await walletRes.json();
    // Adapt if API wraps object differently
    wallet = walletData.wallet || walletData || MOCK_WALLET;
  } catch (e) {
    wallet = MOCK_WALLET;
  }

  try {
    // Attempt to fetch transactions
    const token = localStorage.getItem("token");
    let txRes = await fetch(API_BASE + "finance/transactions", { credentials: "include", headers: token ? { Authorization: "Bearer " + token } : {} });
    if (!txRes.ok) throw new Error("tx fetch failed");
    const txData = await txRes.json();
    transactions = Array.isArray(txData) ? txData : (txData.transactions || MOCK_TXS);
  } catch (e) {
    transactions = MOCK_TXS;
  }

  renderWallet();
  applyFiltersAndRender();
  renderEarningsChart();
}

// Render wallet card values
function renderWallet() {
  bankAccountNameEl.textContent = wallet.accountName || "—";
  bankDetailsRowEl.textContent = `${wallet.bankName || "Bank"} · ${wallet.accountNumber || "—"}`;
  balanceDisplayEl.textContent = formatCurrency(wallet.balance || 0);
  lastPayoutEl.textContent = wallet.lastPayout ? new Date(wallet.lastPayout).toLocaleDateString() : "—";
  statTotalEarnedEl.textContent = formatCurrency(wallet.totalEarned || 0);
  statPendingEl.textContent = formatCurrency(wallet.pending || 0);
  statWithdrawnEl.textContent = formatCurrency(wallet.withdrawn || 0);
  statFeesEl.textContent = formatCurrency(wallet.fees || 0);
}

// Filters & pagination
function applyFiltersAndRender(page = 1) {
  const q = (globalSearchInput?.value || "").trim().toLowerCase();
  const type = filterType?.value || "all";
  const from = fromDate?.value ? new Date(fromDate.value) : null;
  const to = toDate?.value ? new Date(toDate.value) : null;

  filteredTransactions = transactions.filter(tx => {
    const tdesc = (tx.desc || tx.description || "").toString().toLowerCase();
    if (q) {
      if (!(tdesc.includes(q) || (tx.id || "").toLowerCase().includes(q))) return false;
    }
    if (type !== "all") {
      if ((tx.type || "").toLowerCase() !== type) return false;
    }
    if (from) {
      const d = new Date(tx.date);
      if (d < from) return false;
    }
    if (to) {
      const d = new Date(tx.date);
      // include entire day
      const toEnd = new Date(to.getFullYear(), to.getMonth(), to.getDate(), 23, 59, 59);
      if (d > toEnd) return false;
    }
    return true;
  });

  currentPage = page;
  renderTransactionsPage();
}

function renderTransactionsPage() {
  const start = (currentPage - 1) * pageSize;
  const end = start + pageSize;
  const pageItems = filteredTransactions.slice(start, end);
  transactionsBody.innerHTML = "";

  pageItems.forEach((tx, idx) => {
    const i = start + idx + 1;
    const dt = new Date(tx.date);
    const amount = formatCurrency(tx.amount);
    const type = (tx.type || "credit").toLowerCase();
    const color = type === "credit" ? "text-green-600" : "text-red-600";
    const dot = type === "credit" ? '<span class="dot-credit"></span>' : '<span class="dot-debit"></span>';

    const row = document.createElement("tr");
    row.className = "hover:bg-gray-50";
    row.innerHTML = `
      <td class="px-4 py-3 whitespace-nowrap">${i}</td>
      <td class="px-4 py-3 whitespace-nowrap">${dt.toLocaleDateString()} <div class="text-xs muted">${dt.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</div></td>
      <td class="px-4 py-3">${tx.desc || tx.description || '—'}</td>
      <td class="px-4 py-3">${dot}<span class="uppercase text-xs font-semibold ${type === 'credit' ? 'text-green-700' : 'text-red-700'}">${type}</span></td>
      <td class="px-4 py-3 text-right font-semibold ${color}">${amount}</td>
    `;
    row.addEventListener("click", () => openTxModal(tx));
    transactionsBody.appendChild(row);
  });

  const total = filteredTransactions.length;
  transactionsSummary.textContent = `Showing ${Math.min(total, start + 1)}–${Math.min(total, end)} of ${total} transactions`;
  pageInfo.textContent = `Page ${currentPage}`;
  prevPageBtn.disabled = currentPage <= 1;
  nextPageBtn.disabled = end >= total;
}

// Pagination handlers
prevPageBtn.addEventListener("click", () => {
  if (currentPage > 1) {
    currentPage--;
    renderTransactionsPage();
  }
});
nextPageBtn.addEventListener("click", () => {
  if ((currentPage * pageSize) < filteredTransactions.length) {
    currentPage++;
    renderTransactionsPage();
  }
});

// Filters
applyFiltersBtn.addEventListener("click", () => applyFiltersAndRender(1));
resetFiltersBtn.addEventListener("click", () => {
  globalSearchInput.value = "";
  filterType.value = "all";
  fromDate.value = "";
  toDate.value = "";
  applyFiltersAndRender(1);
});
globalSearchInput?.addEventListener("keyup", (e) => {
  if (e.key === "Enter") applyFiltersAndRender(1);
});

// Transaction modal
function openTxModal(tx) {
  document.getElementById("txModalTitle").textContent = `${tx.desc || tx.description || 'Transaction'}`;
  document.getElementById("txModalBody").innerHTML = `
    <div class="grid grid-cols-2 gap-3">
      <div><div class="text-xs muted">Date</div><div>${new Date(tx.date).toLocaleString()}</div></div>
      <div><div class="text-xs muted">Type</div><div>${(tx.type || '').toUpperCase()}</div></div>
      <div><div class="text-xs muted">Amount</div><div class="font-semibold">${formatCurrency(tx.amount)}</div></div>
      <div><div class="text-xs muted">Reference</div><div>${tx.id || tx.reference || '—'}</div></div>
    </div>
    <div class="mt-3 text-xs muted">${tx.notes || ''}</div>
  `;
  document.getElementById("txModal").classList.remove("hidden");
}
function closeTxModal() {
  document.getElementById("txModal").classList.add("hidden");
}

// Chart rendering
function renderEarningsChart() {
  // derive monthly totals from transactions
  const months = parseInt(document.getElementById("chartRange").value || 6);
  const now = new Date();
  const labels = [];
  const sums = [];
  for (let i = months - 1; i >= 0; i--) {
    const d = new Date(now.getFullYear(), now.getMonth() - i, 1);
    labels.push(d.toLocaleString('default', { month: 'short', year: 'numeric' }));
    sums.push(0);
  }
  // accumulate credits into sums
  transactions.forEach(tx => {
    const d = new Date(tx.date);
    const idx = labels.findIndex(l => l.startsWith(d.toLocaleString('default', { month: 'short' })));
    //Better: match year & month
    const labelForTx = `${d.toLocaleString('default', { month: 'short' })} ${d.getFullYear()}`;
    const li = labels.indexOf(labelForTx);
    const monthIndex = labels.findIndex(lbl => lbl === labelForTx);
    if (monthIndex >= 0 && (tx.type || '').toLowerCase() === 'credit') {
      sums[monthIndex] = (sums[monthIndex] || 0) + (Number(tx.amount) || 0);
    }
  });

  // If months labels do not match due to formatting, fallback: compute months map
  if (!sums.some(v => v !== 0)) {
    // fallback strategy: create map by YYYY-MM
    const map = {};
    transactions.forEach(tx => {
      const d = new Date(tx.date);
      const key = `${d.getFullYear()}-${d.getMonth()}`;
      if ((tx.type || '').toLowerCase() === 'credit') map[key] = (map[key] || 0) + (Number(tx.amount) || 0);
    });
    // fill sums by labels
    labels.forEach((lbl, i) => {
      const parts = lbl.split(' ');
      const mon = new Date(Date.parse(parts[0] + " 1, " + (parts[1] || new Date().getFullYear())));
      const key = `${mon.getFullYear()}-${mon.getMonth()}`;
      sums[i] = map[key] || 0;
    });
  }

  const ctx = document.getElementById("earningsChart").getContext('2d');
  if (earningsChart) earningsChart.destroy();
  earningsChart = new Chart(ctx, {
    type: 'line',
    data: {
      labels,
      datasets: [{
        label: 'Credits (₦)',
        data: sums,
        borderColor: '#6366f1',
        backgroundColor: 'rgba(99,102,241,0.08)',
        tension: 0.3,
        fill: true,
        pointRadius: 4,
        pointBackgroundColor: '#6366f1'
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { display: false },
        tooltip: {
          callbacks: {
            label: ctx => `₦${Number(ctx.parsed.y || 0).toLocaleString()}`
          }
        }
      },
      scales: {
        y: {
          beginAtZero: true,
          ticks: {
            callback: v => `₦${Number(v).toLocaleString()}`
          }
        }
      }
    }
  });
}

document.getElementById("chartRange").addEventListener("change", renderEarningsChart);

// Exports
exportCsvBtn.addEventListener("click", () => {
  const rows = filteredTransactions.map(tx => ({
    Date: new Date(tx.date).toLocaleString(),
    Description: tx.desc || tx.description || '',
    Type: tx.type || '',
    Amount: tx.amount || 0,
    Reference: tx.id || tx.reference || ''
  }));
  if (!rows.length) return alert("No transactions to export.");
  const keys = Object.keys(rows[0]);
  const csv = [keys.join(",")].concat(rows.map(r => keys.map(k => `"${String(r[k] || '').replace(/"/g,'""')}"`).join(","))).join("\n");
  const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = `transactions_${(new Date()).toISOString().slice(0,10)}.csv`;
  a.click();
  URL.revokeObjectURL(url);
});

// Simple PDF export (wallet summary + top transactions)
downloadPdfBtn.addEventListener("click", async () => {
  const { jsPDF } = window.jspdf || {};
  if (!jsPDF) return alert("PDF library not available.");
  const doc = new jsPDF({ unit: 'pt', format: 'a4' });
  doc.setFontSize(14);
  doc.text("Earnings Summary", 40, 50);
  doc.setFontSize(11);
  doc.text(`Account: ${wallet.accountName || '—'}`, 40, 80);
  doc.text(`Bank: ${wallet.bankName || '—'} (${wallet.accountNumber || '—'})`, 40, 96);
  doc.text(`Balance: ${formatCurrency(wallet.balance || 0)}`, 40, 112);
  doc.text(`Last payout: ${wallet.lastPayout ? new Date(wallet.lastPayout).toLocaleString() : '—'}`, 40, 128);

  // Transactions table (top 8 of filtered)
  const startY = 160;
  doc.setFontSize(12);
  doc.text("Recent transactions:", 40, startY);
  const headerY = startY + 16;
  doc.setFontSize(10);
  doc.text("Date", 40, headerY);
  doc.text("Description", 130, headerY);
  doc.text("Type", 360, headerY);
  doc.text("Amount", 430, headerY);

  let y = headerY + 12;
  filteredTransactions.slice(0, 12).forEach(tx => {
    doc.text(new Date(tx.date).toLocaleDateString(), 40, y);
    doc.text((tx.desc || tx.description || '').toString().slice(0,40), 130, y);
    doc.text((tx.type || '').toUpperCase(), 360, y);
    doc.text(formatCurrency(tx.amount || 0), 430, y);
    y += 14;
    if (y > 740) {
      doc.addPage();
      y = 40;
    }
  });

  doc.save(`earnings_${(new Date()).toISOString().slice(0,10)}.pdf`);
});

// Quick handlers
historyBtn.addEventListener("click", () => {
  // Scroll to transactions
  window.scrollTo({ top: document.querySelector('section.mt-8').offsetTop - 20, behavior: 'smooth' });
});

// UPDATE: Change 'transfer' and 'withdraw' to redirect
document.getElementById("transferBtn").addEventListener("click", () => {
  window.location.href = "transfer.html";
});
document.getElementById("withdrawBtn").addEventListener("click", () => {
  window.location.href = "withdraw.html";
});

// Init
document.addEventListener("DOMContentLoaded", loadFinance);
</script>
</body>
</html>
