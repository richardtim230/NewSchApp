
<!doctype html>
<html lang="en" class="h-full bg-gray-100">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>OAU ExamGuard — Earnings & Finance</title>

  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <!-- jsPDF (for PDF export) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <style>
    /* small utilities consistent with other pages */
    .card-glow { background: linear-gradient(180deg, #ffffff, #fbfdff); box-shadow: 0 8px 20px rgba(99,102,241,0.08); }
    .muted { color: #6b7280; }
    .dot-credit { width:8px;height:8px;border-radius:50%;background:#10b981;display:inline-block;margin-right:6px;}
    .dot-debit { width:8px;height:8px;border-radius:50%;background:#ef4444;display:inline-block;margin-right:6px;}
    .hide-scrollbar::-webkit-scrollbar { display:none; }
  </style>
</head>
<body class="h-full bg-gray-100 font-sans text-sm">

  <!-- Header -->
  <header class="fixed top-0 left-0 right-0 bg-white border-b z-40">
    <div class="max-w-6xl mx-auto px-4 md:px-6 py-3 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <button class="md:hidden p-2 rounded-full bg-indigo-600 text-white" aria-label="open menu">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M4 6h16M4 12h16M4 18h16"/></svg>
        </button>
        <div>
          <div class="text-indigo-800 font-bold">OAU ExamGuard</div>
          <div class="text-xs muted">Earnings & Finance</div>
        </div>
      </div>

      <div class="flex items-center gap-3">
        <div class="relative w-40 hidden sm:block">
          <input id="globalSearch" placeholder="Search transactions..." class="w-full rounded-lg border px-3 py-2 text-sm bg-gray-50 focus:outline-none" />
          <div class="absolute left-3 top-2 text-gray-400">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><circle cx="11" cy="11" r="8"/><path d="M21 21l-4.35-4.35"/></svg>
          </div>
        </div>

        <button id="notifBtn" class="p-2 rounded-full hover:bg-gray-100">
          <svg class="w-6 h-6 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6 6 0 10-12 0v3.159c0 .538-.214 1.055-.595 1.436L4 17h5"/></svg>
        </button>

        <div class="relative">
          <button id="profileBtn" class="rounded-full overflow-hidden border-2 border-indigo-600 w-9 h-9 bg-indigo-50">
            <img id="headerProfilePic" class="w-full h-full object-cover" src="https://ui-avatars.com/api/?name=Student&background=ede9fe&color=3b82f6&size=128&rounded=true" alt="profile"/>
          </button>
        </div>
      </div>
    </div>
  </header>

  <main class="pt-20 max-w-6xl mx-auto px-4 md:px-6 pb-12">

    <!-- Top: Bank Details Card & Quick Earnings Summary -->
    <section class="grid grid-cols-1 lg:grid-cols-3 gap-6">
      <!-- Bank Card -->
      <div class="col-span-2 card-glow p-6 rounded-xl">
        <div class="flex justify-between items-start">
          <div>
            <div class="text-xs muted">Primary Account</div>
            <div id="bankAccountName" class="text-lg font-semibold text-indigo-800 mt-1">Account Name</div>
            <div id="bankDetailsRow" class="text-sm muted mt-1">Bank · Account number</div>
          </div>

          <div class="flex flex-col items-end gap-2">
            <div class="text-xs muted">Available Balance</div>
            <div id="balanceDisplay" class="text-2xl font-bold text-indigo-700">₦0.00</div>
            <div class="flex gap-2 mt-2">
              <button id="historyBtn" class="bg-indigo-600 text-white px-3 py-1 rounded hover:bg-indigo-700 text-sm">History</button>
              <button id="transferBtn" class="bg-white border border-indigo-200 px-3 py-1 rounded hover:bg-indigo-50 text-sm">Transfer</button>
            </div>
          </div>
        </div>

        <div class="mt-5 grid grid-cols-1 sm:grid-cols-2 gap-4 items-center">
          <div>
            <div class="text-xs muted">Last payout</div>
            <div id="lastPayout" class="text-sm font-medium">—</div>
          </div>
          <div class="flex gap-2 justify-start sm:justify-end">
            <button id="withdrawBtn" class="bg-amber-500 hover:bg-amber-600 text-white px-4 py-2 rounded font-semibold">Withdraw</button>
            <button id="exportCsvBtn" class="bg-gray-100 border rounded px-3 py-2 hover:bg-gray-200">Export CSV</button>
            <button id="downloadPdfBtn" class="bg-gray-100 border rounded px-3 py-2 hover:bg-gray-200">Download PDF</button>
          </div>
        </div>

        <div class="mt-6 w-full">
          <div class="text-xs muted">Balance breakdown</div>
          <div class="mt-2 grid grid-cols-2 sm:grid-cols-4 gap-3">
            <div class="bg-indigo-50 rounded p-3 text-center">
              <div class="text-xs muted">Total Earned</div>
              <div id="statTotalEarned" class="text-sm font-semibold text-indigo-700">₦0</div>
            </div>
            <div class="bg-green-50 rounded p-3 text-center">
              <div class="text-xs muted">Pending</div>
              <div id="statPending" class="text-sm font-semibold text-green-700">₦0</div>
            </div>
            <div class="bg-red-50 rounded p-3 text-center">
              <div class="text-xs muted">Withdrawn</div>
              <div id="statWithdrawn" class="text-sm font-semibold text-red-600">₦0</div>
            </div>
            <div class="bg-yellow-50 rounded p-3 text-center">
              <div class="text-xs muted">Fees</div>
              <div id="statFees" class="text-sm font-semibold text-amber-600">₦0</div>
            </div>
          </div>
        </div>
      </div>

      <!-- Earnings Chart Card -->
      <div class="card-glow p-6 rounded-xl">
        <div class="flex justify-between items-center">
          <div>
            <div class="text-xs muted">Earnings (last 6 months)</div>
            <div class="text-lg font-semibold text-indigo-800 mt-1">Performance</div>
          </div>
          <div>
            <select id="chartRange" class="border rounded px-2 py-1 text-sm">
              <option value="6">6 months</option>
              <option value="3">3 months</option>
              <option value="12">12 months</option>
            </select>
          </div>
        </div>
        <div class="mt-4">
          <canvas id="earningsChart" height="220"></canvas>
        </div>
      </div>
    </section>

    <!-- Transactions & Filters -->
    <section class="mt-8">
      <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
        <div>
          <h2 class="text-xl font-bold text-indigo-800">Transaction History</h2>
          <div class="text-xs muted">Recent deposits, payouts and charges</div>
        </div>

        <div class="flex flex-col sm:flex-row gap-2 items-stretch">
          <div class="flex gap-2 items-center">
            <select id="filterType" class="border rounded px-2 py-2 text-sm">
              <option value="all">All Types</option>
              <option value="credit">Credits</option>
              <option value="debit">Debits</option>
            </select>

            <input id="fromDate" type="date" class="border rounded px-2 py-2 text-sm" />
            <input id="toDate" type="date" class="border rounded px-2 py-2 text-sm" />
          </div>

          <div class="flex gap-2">
            <button id="applyFiltersBtn" class="bg-indigo-600 text-white px-4 py-2 rounded">Apply</button>
            <button id="resetFiltersBtn" class="bg-white border px-4 py-2 rounded">Reset</button>
          </div>
        </div>
      </div>

      <div class="mt-4 bg-white rounded-xl shadow overflow-auto">
        <table class="min-w-full text-left">
          <thead class="bg-indigo-50 text-indigo-700">
            <tr>
              <th class="px-4 py-3">#</th>
              <th class="px-4 py-3">Date</th>
              <th class="px-4 py-3">Description</th>
              <th class="px-4 py-3">Type</th>
              <th class="px-4 py-3 text-right">Amount</th>
            </tr>
          </thead>
          <tbody id="transactionsBody" class="divide-y divide-gray-100">
            <!-- rows injected by JS -->
          </tbody>
        </table>
      </div>

      <!-- Pagination -->
      <div class="mt-4 flex items-center justify-between">
        <div class="text-sm muted" id="transactionsSummary">Showing 0 transactions</div>
        <div class="flex items-center gap-2">
          <button id="prevPage" class="px-3 py-1 rounded bg-gray-100" disabled>Previous</button>
          <span id="pageInfo" class="text-sm muted">Page 1</span>
          <button id="nextPage" class="px-3 py-1 rounded bg-gray-100" disabled>Next</button>
        </div>
      </div>
    </section>
  </main>

  <!-- Minimal footer -->
  <footer class="mt-12 text-center text-xs text-gray-400 pb-8">
    © OAU ExamGuard — Earnings
  </footer>

  <!-- Modal: Transaction Details -->
  <div id="txModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden items-center justify-center">
    <div class="bg-white rounded-xl w-full max-w-2xl p-6 relative">
      <button class="absolute top-3 right-3 text-gray-500" onclick="closeTxModal()">×</button>
      <h3 class="text-lg font-semibold text-indigo-800" id="txModalTitle">Transaction</h3>
      <div class="mt-3 text-sm" id="txModalBody"></div>
      <div class="mt-4 text-right">
        <button class="px-4 py-2 rounded bg-indigo-600 text-white" onclick="closeTxModal()">Close</button>
      </div>
    </div>
  </div>

<script>
/*
  Earnings & Finance page script
  - Fetches finance summary and transactions from API endpoints (fallback to mock data)
  - Renders chart and table
  - Supports filtering, pagination, CSV export and simple PDF export
*/

const API_BASE = "https://examguide.onrender.com/api/"; // adapt to your API
let wallet = null;
let transactions = [];
let filteredTransactions = [];
let currentPage = 1;
const pageSize = 8;

// Utility: format currency
function formatCurrency(n) {
  if (n === null || typeof n === "undefined") return "₦0.00";
  const num = typeof n === "string" ? parseFloat(n) || 0 : (n || 0);
  return new Intl.NumberFormat('en-NG', { style: 'currency', currency: 'NGN', maximumFractionDigits: 2 }).format(num);
}

// Sample fallback data
const MOCK_WALLET = {
  accountName: "Alex Johnson",
  accountNumber: "0123456789",
  bankName: "First National Bank",
  balance: 45230.75,
  totalEarned: 125000.50,
  pending: 4500,
  withdrawn: 72000,
  fees: 1269.5,
  lastPayout: "2026-01-10T09:20:00Z"
};

const MOCK_TXS = [
  { id: "t1", date: "2026-01-10T09:20:00Z", desc: "Payout: January", type: "debit", amount: 15000 },
  { id: "t2", date: "2026-01-05T13:12:00Z", desc: "Sale: Mock Test Package", type: "credit", amount: 3500 },
  { id: "t3", date: "2025-12-28T18:02:00Z", desc: "Referral bonus", type: "credit", amount: 1200 },
  { id: "t4", date: "2025-11-21T08:30:00Z", desc: "Withdrawal", type: "debit", amount: 20000 },
  { id: "t5", date: "2025-11-15T10:00:00Z", desc: "Sale: E-book", type: "credit", amount: 800 },
  { id: "t6", date: "2025-10-10T09:50:00Z", desc: "Payout: Oct", type: "debit", amount: 12000 },
  { id: "t7", date: "2025-09-12T12:00:00Z", desc: "Sale: Premium Mock", type: "credit", amount: 9500 },
  { id: "t8", date: "2025-08-30T11:30:00Z", desc: "Fee", type: "debit", amount: 269.5 },
  { id: "t9", date: "2025-07-21T08:20:00Z", desc: "Sale: Course", type: "credit", amount: 22000 },
  { id: "t10", date: "2025-06-05T14:00:00Z", desc: "Referral bonus", type: "credit", amount: 1000 }
];

// DOM refs
const bankAccountNameEl = document.getElementById("bankAccountName");
const bankDetailsRowEl = document.getElementById("bankDetailsRow");
const balanceDisplayEl = document.getElementById("balanceDisplay");
const lastPayoutEl = document.getElementById("lastPayout");
const statTotalEarnedEl = document.getElementById("statTotalEarned");
const statPendingEl = document.getElementById("statPending");
const statWithdrawnEl = document.getElementById("statWithdrawn");
const statFeesEl = document.getElementById("statFees");
const transactionsBody = document.getElementById("transactionsBody");
const transactionsSummary = document.getElementById("transactionsSummary");
const pageInfo = document.getElementById("pageInfo");
const prevPageBtn = document.getElementById("prevPage");
const nextPageBtn = document.getElementById("nextPage");

const globalSearchInput = document.getElementById("globalSearch");
const filterType = document.getElementById("filterType");
const fromDate = document.getElementById("fromDate");
const toDate = document.getElementById("toDate");
const applyFiltersBtn = document.getElementById("applyFiltersBtn");
const resetFiltersBtn = document.getElementById("resetFiltersBtn");
const exportCsvBtn = document.getElementById("exportCsvBtn");
const downloadPdfBtn = document.getElementById("downloadPdfBtn");
const historyBtn = document.getElementById("historyBtn");

// Chart
let earningsChart = null;

// Fetch wallet summary & transactions
async function loadFinance() {
  try {
    // Attempt to fetch wallet
    const token = localStorage.getItem("token");
    let walletRes = await fetch(API_BASE + "finance/wallet", { credentials: "include", headers: token ? { Authorization: "Bearer " + token } : {} });
    if (!walletRes.ok) throw new Error("wallet fetch failed");
    const walletData = await walletRes.json();
    // Adapt if API wraps object differently
    wallet = walletData.wallet || walletData || MOCK_WALLET;
  } catch (e) {
    wallet = MOCK_WALLET;
  }

  try {
    // Attempt to fetch transactions
    const token = localStorage.getItem("token");
    let txRes = await fetch(API_BASE + "finance/transactions", { credentials: "include", headers: token ? { Authorization: "Bearer " + token } : {} });
    if (!txRes.ok) throw new Error("tx fetch failed");
    const txData = await txRes.json();
    transactions = Array.isArray(txData) ? txData : (txData.transactions || MOCK_TXS);
  } catch (e) {
    transactions = MOCK_TXS;
  }

  renderWallet();
  applyFiltersAndRender();
  renderEarningsChart();
}

// Render wallet card values
function renderWallet() {
  bankAccountNameEl.textContent = wallet.accountName || "—";
  bankDetailsRowEl.textContent = `${wallet.bankName || "Bank"} · ${wallet.accountNumber || "—"}`;
  balanceDisplayEl.textContent = formatCurrency(wallet.balance || 0);
  lastPayoutEl.textContent = wallet.lastPayout ? new Date(wallet.lastPayout).toLocaleDateString() : "—";
  statTotalEarnedEl.textContent = formatCurrency(wallet.totalEarned || 0);
  statPendingEl.textContent = formatCurrency(wallet.pending || 0);
  statWithdrawnEl.textContent = formatCurrency(wallet.withdrawn || 0);
  statFeesEl.textContent = formatCurrency(wallet.fees || 0);
}

// Filters & pagination
function applyFiltersAndRender(page = 1) {
  const q = (globalSearchInput?.value || "").trim().toLowerCase();
  const type = filterType?.value || "all";
  const from = fromDate?.value ? new Date(fromDate.value) : null;
  const to = toDate?.value ? new Date(toDate.value) : null;

  filteredTransactions = transactions.filter(tx => {
    const tdesc = (tx.desc || tx.description || "").toString().toLowerCase();
    if (q) {
      if (!(tdesc.includes(q) || (tx.id || "").toLowerCase().includes(q))) return false;
    }
    if (type !== "all") {
      if ((tx.type || "").toLowerCase() !== type) return false;
    }
    if (from) {
      const d = new Date(tx.date);
      if (d < from) return false;
    }
    if (to) {
      const d = new Date(tx.date);
      // include entire day
      const toEnd = new Date(to.getFullYear(), to.getMonth(), to.getDate(), 23, 59, 59);
      if (d > toEnd) return false;
    }
    return true;
  });

  currentPage = page;
  renderTransactionsPage();
}

function renderTransactionsPage() {
  const start = (currentPage - 1) * pageSize;
  const end = start + pageSize;
  const pageItems = filteredTransactions.slice(start, end);
  transactionsBody.innerHTML = "";

  pageItems.forEach((tx, idx) => {
    const i = start + idx + 1;
    const dt = new Date(tx.date);
    const amount = formatCurrency(tx.amount);
    const type = (tx.type || "credit").toLowerCase();
    const color = type === "credit" ? "text-green-600" : "text-red-600";
    const dot = type === "credit" ? '<span class="dot-credit"></span>' : '<span class="dot-debit"></span>';

    const row = document.createElement("tr");
    row.className = "hover:bg-gray-50";
    row.innerHTML = `
      <td class="px-4 py-3 whitespace-nowrap">${i}</td>
      <td class="px-4 py-3 whitespace-nowrap">${dt.toLocaleDateString()} <div class="text-xs muted">${dt.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</div></td>
      <td class="px-4 py-3">${tx.desc || tx.description || '—'}</td>
      <td class="px-4 py-3">${dot}<span class="uppercase text-xs font-semibold ${type === 'credit' ? 'text-green-700' : 'text-red-700'}">${type}</span></td>
      <td class="px-4 py-3 text-right font-semibold ${color}">${amount}</td>
    `;
    row.addEventListener("click", () => openTxModal(tx));
    transactionsBody.appendChild(row);
  });

  const total = filteredTransactions.length;
  transactionsSummary.textContent = `Showing ${Math.min(total, start + 1)}–${Math.min(total, end)} of ${total} transactions`;
  pageInfo.textContent = `Page ${currentPage}`;
  prevPageBtn.disabled = currentPage <= 1;
  nextPageBtn.disabled = end >= total;
}

// Pagination handlers
prevPageBtn.addEventListener("click", () => {
  if (currentPage > 1) {
    currentPage--;
    renderTransactionsPage();
  }
});
nextPageBtn.addEventListener("click", () => {
  if ((currentPage * pageSize) < filteredTransactions.length) {
    currentPage++;
    renderTransactionsPage();
  }
});

// Filters
applyFiltersBtn.addEventListener("click", () => applyFiltersAndRender(1));
resetFiltersBtn.addEventListener("click", () => {
  globalSearchInput.value = "";
  filterType.value = "all";
  fromDate.value = "";
  toDate.value = "";
  applyFiltersAndRender(1);
});
globalSearchInput?.addEventListener("keyup", (e) => {
  if (e.key === "Enter") applyFiltersAndRender(1);
});

// Transaction modal
function openTxModal(tx) {
  document.getElementById("txModalTitle").textContent = `${tx.desc || tx.description || 'Transaction'}`;
  document.getElementById("txModalBody").innerHTML = `
    <div class="grid grid-cols-2 gap-3">
      <div><div class="text-xs muted">Date</div><div>${new Date(tx.date).toLocaleString()}</div></div>
      <div><div class="text-xs muted">Type</div><div>${(tx.type || '').toUpperCase()}</div></div>
      <div><div class="text-xs muted">Amount</div><div class="font-semibold">${formatCurrency(tx.amount)}</div></div>
      <div><div class="text-xs muted">Reference</div><div>${tx.id || tx.reference || '—'}</div></div>
    </div>
    <div class="mt-3 text-xs muted">${tx.notes || ''}</div>
  `;
  document.getElementById("txModal").classList.remove("hidden");
}
function closeTxModal() {
  document.getElementById("txModal").classList.add("hidden");
}

// Chart rendering
function renderEarningsChart() {
  // derive monthly totals from transactions
  const months = parseInt(document.getElementById("chartRange").value || 6);
  const now = new Date();
  const labels = [];
  const sums = [];
  for (let i = months - 1; i >= 0; i--) {
    const d = new Date(now.getFullYear(), now.getMonth() - i, 1);
    labels.push(d.toLocaleString('default', { month: 'short', year: 'numeric' }));
    sums.push(0);
  }
  // accumulate credits into sums
  transactions.forEach(tx => {
    const d = new Date(tx.date);
    const idx = labels.findIndex(l => l.startsWith(d.toLocaleString('default', { month: 'short' })));
    //Better: match year & month
    const labelForTx = `${d.toLocaleString('default', { month: 'short' })} ${d.getFullYear()}`;
    const li = labels.indexOf(labelForTx);
    const monthIndex = labels.findIndex(lbl => lbl === labelForTx);
    if (monthIndex >= 0 && (tx.type || '').toLowerCase() === 'credit') {
      sums[monthIndex] = (sums[monthIndex] || 0) + (Number(tx.amount) || 0);
    }
  });

  // If months labels do not match due to formatting, fallback: compute months map
  if (!sums.some(v => v !== 0)) {
    // fallback strategy: create map by YYYY-MM
    const map = {};
    transactions.forEach(tx => {
      const d = new Date(tx.date);
      const key = `${d.getFullYear()}-${d.getMonth()}`;
      if ((tx.type || '').toLowerCase() === 'credit') map[key] = (map[key] || 0) + (Number(tx.amount) || 0);
    });
    // fill sums by labels
    labels.forEach((lbl, i) => {
      const parts = lbl.split(' ');
      const mon = new Date(Date.parse(parts[0] + " 1, " + (parts[1] || new Date().getFullYear())));
      const key = `${mon.getFullYear()}-${mon.getMonth()}`;
      sums[i] = map[key] || 0;
    });
  }

  const ctx = document.getElementById("earningsChart").getContext('2d');
  if (earningsChart) earningsChart.destroy();
  earningsChart = new Chart(ctx, {
    type: 'line',
    data: {
      labels,
      datasets: [{
        label: 'Credits (₦)',
        data: sums,
        borderColor: '#6366f1',
        backgroundColor: 'rgba(99,102,241,0.08)',
        tension: 0.3,
        fill: true,
        pointRadius: 4,
        pointBackgroundColor: '#6366f1'
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { display: false },
        tooltip: {
          callbacks: {
            label: ctx => `₦${Number(ctx.parsed.y || 0).toLocaleString()}`
          }
        }
      },
      scales: {
        y: {
          beginAtZero: true,
          ticks: {
            callback: v => `₦${Number(v).toLocaleString()}`
          }
        }
      }
    }
  });
}

document.getElementById("chartRange").addEventListener("change", renderEarningsChart);

// Exports
exportCsvBtn.addEventListener("click", () => {
  const rows = filteredTransactions.map(tx => ({
    Date: new Date(tx.date).toLocaleString(),
    Description: tx.desc || tx.description || '',
    Type: tx.type || '',
    Amount: tx.amount || 0,
    Reference: tx.id || tx.reference || ''
  }));
  if (!rows.length) return alert("No transactions to export.");
  const keys = Object.keys(rows[0]);
  const csv = [keys.join(",")].concat(rows.map(r => keys.map(k => `"${String(r[k] || '').replace(/"/g,'""')}"`).join(","))).join("\n");
  const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = `transactions_${(new Date()).toISOString().slice(0,10)}.csv`;
  a.click();
  URL.revokeObjectURL(url);
});

// Simple PDF export (wallet summary + top transactions)
downloadPdfBtn.addEventListener("click", async () => {
  const { jsPDF } = window.jspdf || {};
  if (!jsPDF) return alert("PDF library not available.");
  const doc = new jsPDF({ unit: 'pt', format: 'a4' });
  doc.setFontSize(14);
  doc.text("Earnings Summary", 40, 50);
  doc.setFontSize(11);
  doc.text(`Account: ${wallet.accountName || '—'}`, 40, 80);
  doc.text(`Bank: ${wallet.bankName || '—'} (${wallet.accountNumber || '—'})`, 40, 96);
  doc.text(`Balance: ${formatCurrency(wallet.balance || 0)}`, 40, 112);
  doc.text(`Last payout: ${wallet.lastPayout ? new Date(wallet.lastPayout).toLocaleString() : '—'}`, 40, 128);

  // Transactions table (top 8 of filtered)
  const startY = 160;
  doc.setFontSize(12);
  doc.text("Recent transactions:", 40, startY);
  const headerY = startY + 16;
  doc.setFontSize(10);
  doc.text("Date", 40, headerY);
  doc.text("Description", 130, headerY);
  doc.text("Type", 360, headerY);
  doc.text("Amount", 430, headerY);

  let y = headerY + 12;
  filteredTransactions.slice(0, 12).forEach(tx => {
    doc.text(new Date(tx.date).toLocaleDateString(), 40, y);
    doc.text((tx.desc || tx.description || '').toString().slice(0,40), 130, y);
    doc.text((tx.type || '').toUpperCase(), 360, y);
    doc.text(formatCurrency(tx.amount || 0), 430, y);
    y += 14;
    if (y > 740) {
      doc.addPage();
      y = 40;
    }
  });

  doc.save(`earnings_${(new Date()).toISOString().slice(0,10)}.pdf`);
});

// Quick handlers
historyBtn.addEventListener("click", () => {
  // Scroll to transactions
  window.scrollTo({ top: document.querySelector('section.mt-8').offsetTop - 20, behavior: 'smooth' });
});

// UPDATE: Change 'transfer' and 'withdraw' to redirect
document.getElementById("transferBtn").addEventListener("click", () => {
  window.location.href = "transfer.html";
});
document.getElementById("withdrawBtn").addEventListener("click", () => {
  window.location.href = "withdraw.html";
});

// Init
document.addEventListener("DOMContentLoaded", loadFinance);
</script>
</body>
</html>
