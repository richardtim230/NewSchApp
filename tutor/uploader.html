<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Upload & Manage CBT Questions | Admin</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Quill editor -->
  <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
  <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
  <style>
    .ql-toolbar.ql-snow { border-radius: 0.75em 0.75em 0 0;}
    .ql-container.ql-snow { border-radius: 0 0 0.75em 0.75em;}
    /* For better option/answer layout */
    .answer-opt-box label { min-width:2em; }
    /* Table & scrolling improvements */
    .custom-table thead th,
    .custom-table tbody td { white-space: normal; word-break: break-word; }
    .truncate-cell {
      max-width: 180px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    @media (max-width: 600px) {
      .truncate-cell { max-width: 80px; }
    }
    .edit-modal-bg {
      position: fixed; left: 0; top: 0; width: 100vw; height: 100vh;
      background: rgba(0,0,0,0.40); z-index: 1000;
      display: flex; align-items: center; justify-content: center;
    }
    .edit-modal-panel {
      background: #fff; border-radius: 1em; max-width: 99vw; width: 100%; max-height: 98vh;
      overflow-y: auto; box-shadow: 0 8px 40px rgba(0,0,0,0.18);
      padding: 2em 1em;
    }
    .prose img { max-width: 100%; height: auto; }

    /* Extra spacing for edit modal editors */
    #edit-q-editor .ql-container,
    #edit-optA .ql-container, #edit-optB .ql-container,
    #edit-optC .ql-container, #edit-optD .ql-container,
    #edit-expl-editor .ql-container {
      min-height: 64px;
      margin-bottom: 1.25rem; /* 20px */
    }
  </style>
</head>
<body class="bg-gray-50 min-h-screen py-12">
<div class="max-w-3xl mx-auto bg-white rounded-2xl shadow-lg px-2 sm:px-8 py-10">
  <h1 class="text-3xl font-black mb-2 text-blue-700">Upload & Manage CBT Questions</h1>
  <p class="text-gray-500 mb-4">Enter exam information, select tags, upload JSON, or add questions manually with text, math and images.</p>
  <form id="examset-form" class="space-y-4 mb-6">
    <div>
      <label class="font-bold block mb-2 text-gray-700">Exam Access Code</label>
      <input type="text" id="accessCode" required class="w-full px-5 py-3 rounded-xl border border-gray-300" placeholder="ExamSet Access Code (e.g. ENG10123SUM)" />
    </div>
    <div>
      <label class="font-bold block mb-2 text-gray-700">Subject (e.g. CHM101)</label>
      <input type="text" id="subject" required class="w-full px-5 py-3 rounded-xl border border-gray-300" placeholder="Exam Subject" />
    </div>
    <div>
      <label class="font-bold block mb-2 text-gray-700">Exam Title (optional)</label>
      <input type="text" id="title" class="w-full px-5 py-3 rounded-xl border border-gray-300" placeholder="Exam Title"/>
    </div>
    <div>
      <label class="font-bold block mb-2 text-gray-700">Tags (comma separated: e.g. undergraduate,university)</label>
      <input type="text" id="tags" class="w-full px-5 py-3 rounded-xl border border-gray-300" placeholder="Tags"/>
    </div>
    <div class="flex items-center">
      <button type="button" id="save-examset-btn" class="bg-blue-700 hover:bg-blue-900 text-white font-bold py-3 px-8 rounded-xl shadow-lg">
        Save/Select Exam Set
      </button>
      <span class="ml-2 font-semibold text-gray-600" id="selected-examset"></span>
      <button type="button" id="delete-examset-btn" class="bg-red-100 border border-red-300 px-4 py-2 rounded font-semibold text-red-800 ml-4">
        Delete Exam Set
      </button>
    </div>
    <div id="form-message" class="mt-2 text-base font-medium"></div>
  </form>

  <div class="flex flex-wrap gap-3 mb-12">
    <button id="switch-to-json" type="button" class="bg-yellow-100 border border-yellow-300 px-4 py-2 rounded font-semibold text-yellow-800">
      Upload by JSON file/textarea
    </button>
    <button id="switch-to-manual" type="button" class="bg-blue-100 border border-blue-300 px-4 py-2 rounded font-semibold text-blue-800">
      Add Question Manually
    </button>
  </div>

  <!-- JSON Upload -->
  <form id="json-upload-form" class="mb-10 block">
    <div>
      <label class="font-bold block mb-2 text-gray-700">Paste Questions JSON:</label>
      <textarea id="questionsJSON" rows="7" class="w-full px-4 py-3 border rounded-xl font-mono text-sm mb-2" placeholder='[{"question": "...", "options":[...], "answer":"A", ...}]'></textarea>
    </div>
    <div>
      <label class="block font-medium text-gray-500 mb-2">or Upload JSON file (<span class="text-xs">will overwrite the textarea above</span>)</label>
      <input type="file" accept="application/json" id="questionsFile" class="block w-full"/>
    </div>
    <button type="submit" class="bg-blue-700 hover:bg-blue-900 text-white font-bold py-3 px-8 rounded-xl shadow-lg mt-2">
      Upload Questions via JSON
    </button>
    <div id="json-form-message" class="mt-2 text-base font-medium"></div>
    <details class="mt-2 text-sm mb-8">
      <summary class="font-semibold mb-1">JSON Format Example</summary>
      <pre class="bg-gray-100 border rounded p-3 overflow-x-auto text-xs">
[
  {
    "question": "&lt;p&gt;What is 2 + 2?&lt;/p&gt;",
    "options": [
      {"key":"A","text":"&lt;p&gt;3&lt;/p&gt;"},
      {"key":"B","text":"&lt;p&gt;4&lt;/p&gt;"},
      {"key":"C","text":"&lt;p&gt;2&lt;/p&gt;"},
      {"key":"D","text":"&lt;p&gt;5&lt;/p&gt;"}
    ],
    "answer": "B",
    "explanation": "&lt;p&gt;2 + 2 is 4.&lt;/p&gt;",
    "image": ""
  },
  ...
]
      </pre>
    </details>
  </form>

  <!-- Manual Add/Edit Form -->
  <form id="manual-form" class="mb-10 hidden">
    <div class="mb-2 font-bold text-gray-800">Question Text</div>
    <div id="manual-q-editor" class="mb-3"></div>

    <div class="grid grid-cols-1 sm:grid-cols-2 gap-6 answer-opt-box mb-4">
      <div class="mb-6">
        <label class="font-bold block mb-1 text-gray-700">Option A</label>
        <div id="opt-A-editor"></div>
      </div>
      <div class="mb-6">
        <label class="font-bold block mb-1 text-gray-700">Option B</label>
        <div id="opt-B-editor"></div>
      </div>
      <div class="mb-6">
        <label class="font-bold block mb-1 text-gray-700">Option C</label>
        <div id="opt-C-editor"></div>
      </div>
      <div class="mb-6">
        <label class="font-bold block mb-1 text-gray-700">Option D</label>
        <div id="opt-D-editor"></div>
      </div>
    </div>

    <div class="mb-5">
      <label class="mr-2 font-bold">Correct Answer:</label>
      <select id="manual-answer" class="border rounded p-1 font-semibold">
        <option value="A">A</option><option value="B">B</option>
        <option value="C">C</option><option value="D">D</option>
      </select>
    </div>
    <div class="mb-4">
      <label class="font-bold mb-1 text-gray-700 block">Explanation (optional)</label>
      <div id="manual-expl-editor"></div>
    </div>
    <button type="submit" class="bg-blue-800 hover:bg-blue-900 text-white font-bold py-3 px-8 rounded-xl shadow-lg mt-2">
      Add Question
    </button>
    <div id="manual-form-message" class="mt-2 text-base font-medium"></div>
  </form>

  <!-- Questions Management Table -->
  <div id="management-section" class="mt-10">
    <div class="mb-3 flex items-center">
      <span class="font-bold text-lg text-blue-700 mr-3">Questions In This Exam Set:</span>
      <button type="button" id="refresh-btn" class="ml-auto py-1 px-4 rounded bg-blue-700 text-white hover:bg-blue-900 text-sm">Refresh</button>
    </div>
    <div class="w-full overflow-x-auto">
      <table class="w-full text-xs sm:text-sm border rounded-xl custom-table">
        <thead>
        <tr class="bg-blue-100 text-blue-900">
          <th class="p-2">#</th>
          <th class="p-2">Question</th>
          <th class="p-2">Answer</th>
          <th class="p-2">Options</th>
          <th class="p-2">Actions</th>
        </tr>
        </thead>
        <tbody id="questions-tbody"></tbody>
      </table>
    </div>
    <div id="no-questions-msg" class="text-gray-500 mt-2 text-center"></div>
  </div>

  <!-- EDIT MODAL PLACEHOLDER -->
  <div id="edit-modal-root"></div>
</div>
<script>
const API_BASE = "https://examguide.onrender.com";
let currentExamSetId = null;
let examSetData = null;
let lastAccessCode = "";

function getTagsArray() {
  const v = document.getElementById('tags').value.trim();
  return v ? v.split(',').map(x=>x.trim()).filter(Boolean) : [];
}

function examsetFields() {
  return {
    accessCode: document.getElementById('accessCode').value.trim(),
    subject: document.getElementById('subject').value.trim(),
    title: document.getElementById('title').value.trim(),
    tags: getTagsArray()
  }
}

async function saveOrGetExamSet(e) {
  if (e) e.preventDefault();
  const msg = document.getElementById('form-message');
  msg.textContent = "";
  const { accessCode, subject, title, tags } = examsetFields();
  if (!accessCode || !subject) {
    msg.textContent = "Please provide access code and subject";
    msg.className = "text-red-600 mt-2 text-base font-medium";
    return;
  }
  msg.textContent = "Saving/finding exam set...";
  let res = await fetch(`${API_BASE}/api/exam-set/by-access?accessCode=${encodeURIComponent(accessCode)}&subject=${encodeURIComponent(subject)}&title=${encodeURIComponent(title)}&tags=${encodeURIComponent(tags.join(','))}`);
  let data = await res.json();
  if (data.examSet?._id) {
    currentExamSetId = data.examSet._id;
    examSetData = data.examSet;
    lastAccessCode = accessCode;
    document.getElementById('selected-examset').textContent = `Selected: ${examSetData.subject} (${examSetData.accessCode}) [Tags: ${examSetData.tags ? examSetData.tags.join(", ") : ""}]`;
    msg.textContent = "Exam set ready";
    msg.className = "text-green-700 mt-2 text-base font-medium";
    fetchAndRenderQuestions();
  } else {
    msg.textContent = "Error saving/finding exam set!";
    msg.className = "text-red-600 mt-2 text-base font-medium";
  }
}

document.getElementById('save-examset-btn').onclick = saveOrGetExamSet;
document.getElementById('accessCode').addEventListener('blur', ()=>{ currentExamSetId = null; lastAccessCode = ""; fetchAndRenderQuestions(); });
document.getElementById('subject').addEventListener('blur', ()=>{ currentExamSetId = null; fetchAndRenderQuestions(); });

/** DELETE EXAM SET **/
document.getElementById('delete-examset-btn').onclick = async function() {
  if (!currentExamSetId) {
    alert("No exam set selected.");
    return;
  }
  if (!confirm("Are you sure you want to delete this Exam Set and ALL its questions? This cannot be undone.")) return;
  try {
    const resp = await fetch(`${API_BASE}/api/exam-set/${currentExamSetId}`, { method: "DELETE" });
    if (resp.ok) {
      alert("Exam set deleted.");
      currentExamSetId = null;
      examSetData = null;
      lastAccessCode = "";
      document.getElementById('selected-examset').textContent = "";
      document.getElementById('form-message').textContent = "";
      fetchAndRenderQuestions();
    } else {
      alert("Failed to delete exam set.");
    }
  } catch {
    alert("Network error while deleting.");
  }
};

/** VIEW MODE SWITCH **/
function showJsonForm() {
  document.getElementById('json-upload-form').classList.remove('hidden');
  document.getElementById('manual-form').classList.add('hidden');
}
function showManualForm() {
  document.getElementById('manual-form').classList.remove('hidden');
  document.getElementById('json-upload-form').classList.add('hidden');
}
document.getElementById('switch-to-json').onclick = showJsonForm;
document.getElementById('switch-to-manual').onclick = showManualForm;

/** JSON UPLOAD **/
document.getElementById('questionsFile').addEventListener('change', function(e){
  const file = e.target.files[0];
  if (file) {
    const reader = new FileReader();
    reader.onload = function(ev){
      document.getElementById('questionsJSON').value = ev.target.result;
    };
    reader.readAsText(file);
  }
});
document.getElementById('json-upload-form').addEventListener('submit', async function(e){
  e.preventDefault();
  const msg = document.getElementById('json-form-message');
  msg.textContent = "";
  if (!currentExamSetId) {
    msg.className = "text-red-600 mt-2";
    msg.textContent = "Select or create an exam set first!";
    return;
  }
  let questions;
  try {
    questions = JSON.parse(document.getElementById('questionsJSON').value);
  } catch (err) {
    msg.textContent = "Invalid JSON!";
    msg.className = "text-red-600 mt-2";
    return;
  }
  if (!Array.isArray(questions) || !questions.length) {
    msg.textContent = "Your questions JSON must be a non-empty array.";
    msg.className = "text-red-600 mt-2";
    return;
  }
  let uploaded = 0, failed = 0;
  for (let q of questions) {
    try {
      const resp = await fetch(`${API_BASE}/api/cbt-questions`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          examSet: currentExamSetId,
          question: q.question,
          options: q.options,
          answer: q.answer,
          explanation: q.explanation || "",
          image: q.image || ""
        })
      });
      (resp.ok ? uploaded++ : failed++);
    } catch { failed++; }
  }
  msg.textContent = `Upload complete: ${uploaded} added${failed>0 ?", "+failed+" failed":""}.`;
  msg.className = failed === 0 ? "text-green-700 mt-2" : "text-orange-600 mt-2";
  fetchAndRenderQuestions();
});

/** MANUAL ADDING W/ QUILL **/
let qEditor, expEditor, optAEditor, optBEditor, optCEditor, optDEditor;
function initQuillEditors() {
  if (!window.Quill) return setTimeout(initQuillEditors, 50);
  qEditor = new Quill('#manual-q-editor', { theme: 'snow', placeholder: 'Type the question here', modules: {toolbar: [['bold', 'italic', 'underline', 'image', 'code-block', 'formula']] }});
  expEditor = new Quill('#manual-expl-editor', { theme: 'snow', placeholder: 'Explain the answer (optional)', modules: {toolbar: [['bold', 'italic','underline','image','code-block','formula']] }});
  optAEditor = new Quill('#opt-A-editor', { theme: 'snow', placeholder: 'Option A', modules: {toolbar: [['bold','italic','underline','image','formula']] }});
  optBEditor = new Quill('#opt-B-editor', { theme: 'snow', placeholder: 'Option B', modules: {toolbar: [['bold','italic','underline','image','formula']] }});
  optCEditor = new Quill('#opt-C-editor', { theme: 'snow', placeholder: 'Option C', modules: {toolbar: [['bold','italic','underline','image','formula']] }});
  optDEditor = new Quill('#opt-D-editor', { theme: 'snow', placeholder: 'Option D', modules: {toolbar: [['bold','italic','underline','image','formula']] }});
}
initQuillEditors();

document.getElementById('manual-form').addEventListener('submit', async function(e){
  e.preventDefault();
  const msg = document.getElementById('manual-form-message');
  msg.textContent = "";
  if (!currentExamSetId) {
    msg.className = "text-red-600 mt-2";
    msg.textContent = "Select or create an exam set first!";
    return;
  }
  // Grab HTML (Quill outputs) for question/opts/expl
  const qHtml = qEditor.root.innerHTML.trim();
  const explHtml = expEditor.root.innerHTML.trim();
  const opts = [
    { key: "A", text: optAEditor.root.innerHTML.trim() },
    { key: "B", text: optBEditor.root.innerHTML.trim() },
    { key: "C", text: optCEditor.root.innerHTML.trim() },
    { key: "D", text: optDEditor.root.innerHTML.trim() },
  ];
  const ans = document.getElementById('manual-answer').value || "A";
  if (!qHtml || opts.some(o => !o.text || o.text === "<p><br></p>")) {
    msg.textContent = "Please fill in the question and all options!";
    msg.className = "text-red-600 mt-2";
    return;
  }
  try {
    const resp = await fetch(`${API_BASE}/api/cbt-questions`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        examSet: currentExamSetId,
        question: qHtml,
        options: opts,
        answer: ans,
        explanation: explHtml,
        image: ""
      })
    });
    if (resp.ok) {
      msg.textContent = "Question added!";
      msg.className = "text-green-700 mt-2";
      // Reset editors
      qEditor.root.innerHTML = "";
      expEditor.root.innerHTML = "";
      [optAEditor, optBEditor, optCEditor, optDEditor].forEach(ed => ed.root.innerHTML = "");
      fetchAndRenderQuestions();
    } else {
      msg.textContent = "Failed to add question (server)";
      msg.className = "text-red-600 mt-2";
    }
  } catch (err) {
    msg.textContent = "Network/server error.";
    msg.className = "text-red-600 mt-2";
  }
});

/** TABLE: Render + CRUD + EDIT **/
async function fetchAndRenderQuestions(){
  const tbody = document.getElementById('questions-tbody');
  const msg = document.getElementById('no-questions-msg');
  tbody.innerHTML = "";
  msg.textContent = "";
  const accessCode = lastAccessCode || document.getElementById('accessCode').value.trim();
  const subject = document.getElementById('subject').value.trim();
  if(!accessCode) {
    msg.textContent = "Enter and save at least access code and subject.";
    return;
  }
  let examSetId = currentExamSetId;
  try {
    if (!examSetId) {
      const setRes = await fetch(`${API_BASE}/api/exam-set/by-access?accessCode=${encodeURIComponent(accessCode)}&subject=${encodeURIComponent(subject)}`);
      const data = await setRes.json();
      examSetId = data.examSet?._id;
      currentExamSetId = examSetId;
    }
    if(!examSetId) throw new Error("Exam set not found");
  } catch {
    msg.textContent = "Could not find or create the exam set for the provided code/subject.";
    return;
  }
  // Fetch all questions in this exam set -- New: fetch ALL by paginating if needed
  try {
    let allQuestions = [];
    let page = 1;
    let done = false;
    const PAGE_LIMIT = 100;
    while (!done) {
      const listRes = await fetch(`${API_BASE}/api/cbt-questions?examSet=${encodeURIComponent(examSetId)}&page=${page}&limit=${PAGE_LIMIT}`);
      const questions = await listRes.json();
      if(Array.isArray(questions) && questions.length > 0){
          allQuestions.push(...questions);
          if(questions.length < PAGE_LIMIT) done = true;
          else page++;
      } else {
          done = true;
      }
    }
    if(!Array.isArray(allQuestions) || allQuestions.length === 0){
      msg.textContent = "No questions found for this exam set.";
      return;
    }
    allQuestions.forEach((q, idx) => {
      const row = document.createElement('tr');
      row.innerHTML = `
        <td class="p-2 border">${idx+1}</td>
        <td class="p-2 border truncate-cell" title="Click to view full question" style="max-width:180px;cursor:pointer;" onclick="showFullHtmlModal(\`${q.question.replace(/`/g, '\\`').replace(/\\/g, '\\\\')}\`, 'Question')">${stripHtml(q.question)}</td>
        <td class="p-2 border truncate-cell">${q.answer}</td>
        <td class="p-2 border truncate-cell">${(q.options||[]).map(opt=>`${opt.key}. ${stripHtml(opt.text)}`).join("<br>")}</td>
        <td class="p-2 border">
            <button data-id="${q._id}" class="edit-btn bg-yellow-400 px-3 py-1 rounded text-xs mr-1">Edit</button>
            <button data-id="${q._id}" class="delete-btn bg-red-600 text-white text-xs px-3 py-1 rounded">Delete</button>
        </td>
      `;
      tbody.appendChild(row);
    });
    document.querySelectorAll('.delete-btn').forEach(btn => {
      btn.onclick = () => handleDelete(btn.getAttribute("data-id"));
    });
    document.querySelectorAll('.edit-btn').forEach(btn => {
      btn.onclick = () => showEditModal(btn.getAttribute("data-id"));
    });
  } catch(err){
    msg.textContent = "Failed to fetch questions.";
  }
}

// Utility to strip html tags from string for table preview
function stripHtml(html){
  const tmp = document.createElement("DIV");
  tmp.innerHTML = html;
  return tmp.textContent || tmp.innerText || "";
}

async function handleDelete(id){
  if (!confirm("Are you sure you want to delete this question?")) return;
  try {
    const resp = await fetch(`${API_BASE}/api/cbt-questions/${id}`, { method: "DELETE" });
    if (resp.ok) fetchAndRenderQuestions();
    else alert("Delete failed.");
  } catch { alert("Delete failed."); }
}

/** Show modal for full html question/option view */
window.showFullHtmlModal = function(htmlContent, title="Content") {
  let modal = document.createElement("div");
  modal.className = "fixed left-0 top-0 w-full h-full bg-black bg-opacity-50 flex items-center justify-center z-50";
  modal.innerHTML = `
    <div class="bg-white p-8 rounded-xl shadow-xl max-w-2xl w-full relative">
      <button id="close-full-modal" class="absolute top-1 right-2 text-2xl px-2 text-gray-400 hover:text-gray-800">&times;</button>
      <div class="font-bold text-xl mb-2">${title}</div>
      <div class="max-h-[60vh] overflow-y-auto prose">${htmlContent}</div>
    </div>
  `;
  document.body.appendChild(modal);
  document.getElementById("close-full-modal").onclick = ()=>{ document.body.removeChild(modal); };
}

/** ------- EDIT MODAL -------- **/
let editState = { question: null };
async function showEditModal(id) {
  // Fetch question
  let res = await fetch(`${API_BASE}/api/cbt-questions/${id}`);
  let q = await res.json();
  editState.question = q;
  let modal = document.getElementById('edit-modal-root');
  modal.innerHTML = `
    <div class="edit-modal-bg">
      <div class="edit-modal-panel relative w-full max-w-xl mx-auto">
        <button class="absolute right-3 top-3 text-2xl text-gray-400 hover:text-gray-700" id="close-edit-modal">&times;</button>
        <h2 class="mb-3 text-xl font-bold text-blue-700">Edit Question</h2>
        <form id="edit-form" class="space-y-6">
          <div class="mb-5">
            <label class="block mb-1 text-gray-700 font-semibold">Question</label>
            <div id="edit-q-editor"></div>
          </div>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div class="mb-6">
              <label class="block mb-1 text-gray-700 font-semibold">Option A</label>
              <div id="edit-optA"></div>
            </div>
            <div class="mb-6">
              <label class="block mb-1 text-gray-700 font-semibold">Option B</label>
              <div id="edit-optB"></div>
            </div>
            <div class="mb-6">
              <label class="block mb-1 text-gray-700 font-semibold">Option C</label>
              <div id="edit-optC"></div>
            </div>
            <div class="mb-6">
              <label class="block mb-1 text-gray-700 font-semibold">Option D</label>
              <div id="edit-optD"></div>
            </div>
          </div>
          <div class="mb-5">
            <label class="mr-2 font-bold">Correct Answer:</label>
            <select id="edit-answer" class="border rounded p-1 font-semibold">
              <option value="A">A</option><option value="B">B</option>
              <option value="C">C</option><option value="D">D</option>
            </select>
          </div>
          <div class="mb-4">
            <label class="block mb-1 text-gray-700 font-semibold">Explanation (optional)</label>
            <div id="edit-expl-editor"></div>
          </div>
          <button type="submit" class="bg-blue-700 text-white py-2 px-8 rounded font-bold hover:bg-blue-900 mt-2">Save</button>
          <div id="edit-msg" class="text-sm mt-2"></div>
        </form>
      </div>
    </div>
  `;
  // Attach Quill editors to modal
  let qEditor = new Quill('#edit-q-editor', { theme: 'snow', modules: {toolbar: [['bold','italic','underline','image','formula','code-block']] }});
  let aEditor = new Quill('#edit-optA', { theme: 'snow', modules: {toolbar: [['bold','italic','underline','image','formula']] }});
  let bEditor = new Quill('#edit-optB', { theme: 'snow', modules: {toolbar: [['bold','italic','underline','image','formula']] }});
  let cEditor = new Quill('#edit-optC', { theme: 'snow', modules: {toolbar: [['bold','italic','underline','image','formula']] }});
  let dEditor = new Quill('#edit-optD', { theme: 'snow', modules: {toolbar: [['bold','italic','underline','image','formula']] }});
  let explEditor = new Quill('#edit-expl-editor', { theme: 'snow', modules: {toolbar: [['bold','italic','underline','image','formula','code-block']] }});
  
  qEditor.root.innerHTML = q.question || "";
  let opts = {};
  (q.options||[]).forEach(o=>opts[o.key]=o.text||"");
  aEditor.root.innerHTML = opts.A || "";
  bEditor.root.innerHTML = opts.B || "";
  cEditor.root.innerHTML = opts.C || "";
  dEditor.root.innerHTML = opts.D || "";
  explEditor.root.innerHTML = q.explanation || "";

  document.getElementById('edit-answer').value = q.answer || "A";
  document.getElementById('close-edit-modal').onclick = ()=>{
    modal.innerHTML = '';
    editState.question = null;
  };

  document.getElementById('edit-form').onsubmit = async function(ev){
    ev.preventDefault();
    const msg = document.getElementById('edit-msg');
    msg.textContent = '';
    let opts = [
      { key: "A", text: aEditor.root.innerHTML.trim() },
      { key: "B", text: bEditor.root.innerHTML.trim() },
      { key: "C", text: cEditor.root.innerHTML.trim() },
      { key: "D", text: dEditor.root.innerHTML.trim() }
    ];
    if (!qEditor.root.innerHTML.trim() || opts.some(o=>!o.text||o.text==='<p><br></p>')) {
      msg.textContent = "Fill in the question and all options!";
      msg.className = "text-red-600 mt-2";
      return;
    }
    let updated = {
      question: qEditor.root.innerHTML,
      options: opts,
      answer: document.getElementById('edit-answer').value || "A",
      explanation: explEditor.root.innerHTML
    };
    try {
      let res = await fetch(`${API_BASE}/api/cbt-questions/${q._id}`, {
        method: "PUT",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(updated)
      });
      if (res.ok) {
        msg.textContent = "Saved!";
        msg.className = "text-green-700 mt-2";
        setTimeout(()=>{
          modal.innerHTML='';
          fetchAndRenderQuestions();
        },800);
      } else {
        msg.textContent = "Update failed!";
        msg.className = "text-red-600 mt-2";
      }
    } catch {
      msg.textContent = "Network/server error.";
      msg.className = "text-red-600 mt-2";
    }
  }
}

/** --- End EDIT MODAL --- */

window.addEventListener('DOMContentLoaded', ()=>{
  fetchAndRenderQuestions();
  showJsonForm();
});
document.getElementById('refresh-btn').onclick = fetchAndRenderQuestions;
</script>
</body>
</html>
