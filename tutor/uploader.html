<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Upload & Manage CBT Questions | Admin</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50 min-h-screen py-12">
  <div class="max-w-3xl mx-auto bg-white rounded-2xl shadow-lg px-8 py-10">
    <h1 class="text-3xl font-black mb-2 text-blue-700">Upload & Manage CBT Questions</h1>
    <p class="text-gray-500 mb-4">Enter the exam information, upload/add questions, and manage your exam set easily.</p>
    <form id="question-upload-form" class="space-y-4 mb-6">
      <div>
        <label class="font-bold block mb-2 text-gray-700">Exam Access Code</label>
        <input type="text" id="accessCode" required class="w-full px-5 py-3 rounded-xl border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-600" placeholder="ExamSet Access Code (e.g. ABCD1234)" />
      </div>
      <div>
        <label class="font-bold block mb-2 text-gray-700">Subject (e.g. CHM101)</label>
        <input type="text" id="subject" required class="w-full px-5 py-3 rounded-xl border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-600" placeholder="Exam Subject" />
      </div>
      <div>
        <label class="font-bold block mb-2 text-gray-700">Exam Title (optional)</label>
        <input type="text" id="title" class="w-full px-5 py-3 rounded-xl border border-gray-300 focus:outline-none" placeholder="Exam Title"/>
      </div>
      <div>
        <label class="font-bold block mb-2 text-gray-700">Paste Questions JSON (see format below):</label>
        <textarea id="questionsJSON" rows="8" class="w-full px-4 py-3 border rounded-xl font-mono text-sm" placeholder='[{"question": "...", "options":[...], "answer":"A", ...}, ...]'></textarea>
      </div>
      <div>
        <label class="block font-medium text-gray-500 mt-2 mb-2">or Upload JSON file</label>
        <input type="file" accept="application/json" id="questionsFile" class="block w-full"/>
      </div>
      <button type="submit" class="bg-blue-700 hover:bg-blue-900 text-white font-bold py-3 px-8 rounded-xl shadow-lg mt-2">
        Upload Questions
      </button>
      <div id="form-message" class="mt-2 text-base font-medium"></div>
    </form>
    <details class="mt-2 text-sm mb-8">
      <summary class="font-semibold mb-1">JSON Format Example</summary>
      <pre class="bg-gray-100 border rounded p-3 overflow-x-auto text-xs">
[
  {
    "question": "What is 2 + 2?",
    "options": [
      {"key":"A","text":"3"},
      {"key":"B","text":"4"},
      {"key":"C","text":"2"},
      {"key":"D","text":"5"}
    ],
    "answer": "B",
    "explanation": "2 + 2 is 4.",
    "image": ""
  },
  ...
]
      </pre>
    </details>
    <!-- Questions Management Table -->
    <div id="management-section" class="mt-10">
      <div class="mb-3 flex items-center">
        <span class="font-bold text-lg text-blue-700 mr-3">Questions In This Exam Set:</span>
        <button type="button" id="refresh-btn" class="ml-auto py-1 px-4 rounded bg-blue-700 text-white hover:bg-blue-900 text-sm">Refresh</button>
      </div>
      <table class="w-full text-xs sm:text-sm border rounded-xl overflow-x-auto">
        <thead>
          <tr class="bg-blue-100 text-blue-900">
            <th class="p-2">#</th>
            <th class="p-2">Question</th>
            <th class="p-2">Answer</th>
            <th class="p-2">Options</th>
            <th class="p-2">Actions</th>
          </tr>
        </thead>
        <tbody id="questions-tbody"></tbody>
      </table>
      <div id="no-questions-msg" class="text-gray-500 mt-2 text-center"></div>
    </div>
    <!-- Edit Modal -->
    <div id="edit-modal" class="fixed inset-0 bg-black bg-opacity-30 flex items-center justify-center z-50 hidden">
      <div class="bg-white rounded-xl p-8 w-full max-w-lg shadow-lg relative">
        <button id="close-modal" class="absolute right-3 top-3 text-xl text-gray-400 hover:text-gray-700">&times;</button>
        <h2 class="mb-3 text-xl font-bold text-blue-700">Edit Question</h2>
        <form id="edit-form" class="space-y-4">
          <input type="hidden" id="edit-id" />
          <div>
            <label class="block mb-1 text-gray-700 font-semibold">Question</label>
            <textarea id="edit-question" class="w-full border rounded p-2" required rows="3"></textarea>
          </div>
          <div>
            <label class="block mb-1 text-gray-700 font-semibold">Answer</label>
            <select id="edit-answer" class="border rounded w-full p-2">
              <option value="A">A</option><option value="B">B</option>
              <option value="C">C</option><option value="D">D</option>
            </select>
          </div>
          <div>
            <label class="block mb-1 text-gray-700 font-semibold">Options</label>
            <div class="grid grid-cols-1 gap-2">
              <input type="text" id="edit-opt-A" class="p-2 border rounded" placeholder="Option A" required />
              <input type="text" id="edit-opt-B" class="p-2 border rounded" placeholder="Option B" required />
              <input type="text" id="edit-opt-C" class="p-2 border rounded" placeholder="Option C" required />
              <input type="text" id="edit-opt-D" class="p-2 border rounded" placeholder="Option D" required />
            </div>
          </div>
          <div>
            <label class="block mb-1 text-gray-700 font-semibold">Explanation (optional)</label>
            <textarea id="edit-explanation" class="w-full border rounded p-2" rows="2"></textarea>
          </div>
          <button type="submit" class="bg-blue-700 text-white py-2 px-8 rounded font-bold hover:bg-blue-900 mt-2">Save</button>
        </form>
        <div id="edit-msg" class="text-sm mt-2"></div>
      </div>
    </div>
  </div>
  <script>
    const API_BASE = "https://examguide.onrender.com";
    let currentExamSetId = null;
    let lastAccessCode = "";

    // File upload -> textarea sync
    document.getElementById('questionsFile').addEventListener('change', function(e){
      const file = e.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = function(ev){
          document.getElementById('questionsJSON').value = ev.target.result;
        };
        reader.readAsText(file);
      }
    });

    // On submit: upload all questions
    document.getElementById('question-upload-form').addEventListener('submit', async function(e){
      e.preventDefault();
      const msg = document.getElementById('form-message');
      msg.textContent = "";
      msg.className = "mt-2 text-base font-medium";

      // Step 1: validate
      const accessCode = document.getElementById('accessCode').value.trim();
      const subject = document.getElementById('subject').value.trim();
      const title = document.getElementById('title').value.trim();

      if (accessCode.length < 4 || subject === "") {
        msg.textContent = "Please provide both a valid access code and subject!";
        msg.classList.add("text-red-600");
        return;
      }

      // Step 2: Get or create exam set with this access code and subject
      msg.textContent = "Checking/creating exam set...";
      let examSet;
      try {
        const setRes = await fetch(`${API_BASE}/api/exam-set/by-access?accessCode=${encodeURIComponent(accessCode)}&subject=${encodeURIComponent(subject)}&title=${encodeURIComponent(title)}`);
        if (!setRes.ok) throw new Error("API error");
        const data = await setRes.json();
        if (!data.examSet || !data.examSet._id) throw new Error("Couldn't create/find exam set");
        examSet = data.examSet;
        currentExamSetId = examSet._id;
        lastAccessCode = accessCode;
      } catch (err) {
        msg.textContent = "Could not get or create exam set: " + (err.message || "(unknown error)");
        msg.classList.add("text-red-600");
        return;
      }

      // Step 3: Parse JSON
      let questions;
      try {
        questions = JSON.parse(document.getElementById('questionsJSON').value);
      } catch (err) {
        msg.textContent = "Invalid JSON! Please check your format.";
        msg.classList.add("text-red-600");
        return;
      }
      if (!Array.isArray(questions) || questions.length === 0) {
        msg.textContent = "Your questions JSON must be a non-empty array.";
        msg.classList.add("text-red-600");
        return;
      }

      // Step 4: Upload each
      let uploaded = 0, failed = 0;
      for (let q of questions) {
        try {
          const resp = await fetch(`${API_BASE}/api/cbt-questions`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              examSet: examSet._id,
              question: q.question,
              options: q.options,
              answer: q.answer,
              explanation: q.explanation || "",
              image: q.image || ""
            })
          });
          if (resp.ok) uploaded++;
          else failed++;
        } catch { failed++; }
      }
      msg.textContent = `Upload complete: ${uploaded} added${failed>0?", "+failed+" failed":""}.`;
      msg.classList.add(failed === 0 ? "text-green-700" : "text-orange-600");
      fetchAndRenderQuestions();
    });

    // Fetch and display all questions for the current set
    async function fetchAndRenderQuestions(){
      const tbody = document.getElementById('questions-tbody');
      const msg = document.getElementById('no-questions-msg');
      tbody.innerHTML = "";
      msg.textContent = "";
      // Read form fields (again) if needed. Use last known id/code.
      const accessCode = lastAccessCode || document.getElementById('accessCode').value.trim();
      const subject = document.getElementById('subject').value.trim();
      // If nothing, skip
      if(!accessCode) { msg.textContent = "Enter and save at least access code and subject."; return; }

      // Get (or create) the exam set again
      let examSetId = currentExamSetId;
      try {
        if (!examSetId) {
          const setRes = await fetch(`${API_BASE}/api/exam-set/by-access?accessCode=${encodeURIComponent(accessCode)}&subject=${encodeURIComponent(subject)}`);
          const data = await setRes.json();
          examSetId = data.examSet?._id;
          currentExamSetId = examSetId;
        }
        if(!examSetId) throw new Error("Exam set not found");
      } catch {
        msg.textContent = "Could not find or create the exam set for the provided code/subject.";
        return;
      }
      // Fetch all questions in this exam set
      try {
        const listRes = await fetch(`${API_BASE}/api/cbt-questions?examSet=${encodeURIComponent(examSetId)}`);
        const questions = await listRes.json();
        if(!Array.isArray(questions) || questions.length === 0){
          msg.textContent = "No questions found for this exam set.";
          return;
        }
        // Render all
        questions.forEach((q, idx) => {
          const row = document.createElement('tr');
          row.innerHTML = `
            <td class="p-2 border">${idx+1}</td>
            <td class="p-2 border max-w-[280px] truncate" title="${q.question.replace(/"/g, '&quot;')}">${q.question.length>80?q.question.slice(0,77)+"...":q.question}</td>
            <td class="p-2 border">${q.answer}</td>
            <td class="p-2 border">${(q.options||[]).map(opt=>`${opt.key}. ${opt.text}`).join("<br>")}</td>
            <td class="p-2 border">
                <button data-id="${q._id}" class="edit-btn bg-yellow-400 text-xs px-3 py-1 rounded mr-1">Edit</button>
                <button data-id="${q._id}" class="delete-btn bg-red-600 text-white text-xs px-3 py-1 rounded">Delete</button>
            </td>
          `;
          tbody.appendChild(row);
        });
        // Add listeners for edit and delete
        document.querySelectorAll('.edit-btn').forEach(btn => {
          btn.onclick = () => showEditModal(btn.getAttribute("data-id"));
        });
        document.querySelectorAll('.delete-btn').forEach(btn => {
          btn.onclick = () => handleDelete(btn.getAttribute("data-id"));
        });
      } catch(err){
        msg.textContent = "Failed to fetch questions.";
      }
    }

    document.getElementById('refresh-btn').onclick = fetchAndRenderQuestions;

    // Show the edit modal & populate
    async function showEditModal(id){
      // Fetch question by id
      const res = await fetch(`${API_BASE}/api/cbt-questions/${id}`);
      const q = await res.json();
      document.getElementById('edit-id').value = id;
      document.getElementById('edit-question').value = q.question || "";
      document.getElementById('edit-opt-A').value = (q.options?.find(o=>o.key==="A")||{}).text || "";
      document.getElementById('edit-opt-B').value = (q.options?.find(o=>o.key==="B")||{}).text || "";
      document.getElementById('edit-opt-C').value = (q.options?.find(o=>o.key==="C")||{}).text || "";
      document.getElementById('edit-opt-D').value = (q.options?.find(o=>o.key==="D")||{}).text || "";
      document.getElementById('edit-answer').value = q.answer || "A";
      document.getElementById('edit-explanation').value = q.explanation || "";
      document.getElementById('edit-modal').classList.remove("hidden");
      document.getElementById('edit-msg').textContent = "";
    }

    document.getElementById('close-modal').onclick = function() {
      document.getElementById('edit-modal').classList.add("hidden");
    };
    // Edit form submit
    document.getElementById('edit-form').onsubmit = async function(e){
      e.preventDefault();
      const msg = document.getElementById('edit-msg');
      msg.textContent = "";
      const id = document.getElementById('edit-id').value;
      const updated = {
        question: document.getElementById('edit-question').value,
        answer: document.getElementById('edit-answer').value,
        options: [
          { key: "A", text: document.getElementById('edit-opt-A').value },
          { key: "B", text: document.getElementById('edit-opt-B').value },
          { key: "C", text: document.getElementById('edit-opt-C').value },
          { key: "D", text: document.getElementById('edit-opt-D').value }
        ],
        explanation: document.getElementById('edit-explanation').value,
      };
      try {
        const resp = await fetch(`${API_BASE}/api/cbt-questions/${id}`, {
          method: "PUT",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(updated)
        });
        if (resp.ok) {
          msg.textContent = "Saved!";
          msg.classList.add("text-green-700");
          setTimeout(() => {
            document.getElementById('edit-modal').classList.add("hidden");
            fetchAndRenderQuestions();
          }, 700);
        } else {
          msg.textContent = "Update failed!";
          msg.classList.add("text-red-600");
        }
      } catch(err){
        msg.textContent = "Network/server error.";
        msg.classList.add("text-red-600");
      }
    };

    // Delete handler
    async function handleDelete(id){
      if (!confirm("Are you sure you want to delete this question?")) return;
      try {
        const resp = await fetch(`${API_BASE}/api/cbt-questions/${id}`, { method: "DELETE" });
        if (resp.ok) fetchAndRenderQuestions();
        else alert("Delete failed.");
      } catch { alert("Delete failed."); }
    }

    // Auto-refresh questions list when code/subject fields blur
    document.getElementById('accessCode').addEventListener('blur', ()=>{ currentExamSetId = null; lastAccessCode = ""; fetchAndRenderQuestions(); });
    document.getElementById('subject').addEventListener('blur', ()=>{ currentExamSetId = null; fetchAndRenderQuestions(); });
    // And on page load
    window.addEventListener('DOMContentLoaded', fetchAndRenderQuestions);
  </script>
</body>
</html>
