<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Live Coding Platform</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" href="https://cdn.jsdelivr.net/npm/@mdi/svg/svg/code-tags.svg" type="image/svg+xml">
  <link rel="stylesheet" href="liveclass.css">
  <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
</head>
<body>
<div class="container" id="mainContainer">
  <!-- SIDEBAR -->
  <aside class="sidebar" id="sidebar">
    <div class="logo-area">
      <div class="logo-circle">
        <img src="https://cdn.jsdelivr.net/npm/@mdi/svg/svg/code-tags.svg" alt="Logo">
      </div>
      <span class="title">Live Coding Platform</span>
    </div>
    <div class="user-list-section">
      <div class="section-label">Live Users</div>
      <ul class="user-list" id="userList"></ul>
      <div id="typingStatus" style="margin-top:.5em;color:#ffd74d;font-size:.98em;"></div>
    </div>
    <div class="chat-section">
      <div class="section-label">Chat</div>
      <div class="chat-box" id="chatBox"></div>
      <form class="chat-form" id="chatForm" autocomplete="off">
        <input type="text" id="chatInput" placeholder="Type a message..." maxlength="180">
        <button type="submit">Send</button>
      </form>
    </div>
  </aside>
  <main class="main" id="mainArea">
    <div class="tabs" id="tabsBar">
      <button class="tab-btn active" data-tab="edit">Live Code</button>
      <button class="tab-btn" data-tab="about">About</button>
    </div>
    <!-- Tabs -->
    <div id="tab-edit" class="tab-content active">
      <div class="editors-area" id="editorsArea">
        <div class="area-header" id="editorsHeader">
          <span style="font-weight:700;">Code editors</span>
          <button id="minmaxEditorsBtn" title="Minimize editors" style="float:right;padding:0 1em;border-radius:8px;cursor:pointer;background:#293072;color:#fff;border:none;font-size:.96em;">Minimize</button>
          <button id="maximizeEditorsBtn" title="Maximize editors" style="float:right;margin-right:.6em;padding:0 1em;border-radius:8px;cursor:pointer;background:var(--highlight);color:#fff;border:none;font-size:.96em;">Maximize</button>
        </div>
        <div id="editorsInner">
          <div class="editor-block">
            <div class="editor-label">HTML <span class="lang">html</span></div>
            <textarea class="editor" id="htmlEditor" spellcheck="false" autocomplete="off" placeholder="Type HTML here..."></textarea>
          </div>
          <div class="editor-block">
            <div class="editor-label">CSS <span class="lang">css</span></div>
            <textarea class="editor" id="cssEditor" spellcheck="false" autocomplete="off" placeholder="Type CSS here..."></textarea>
          </div>
          <div class="editor-block">
            <div class="editor-label">JavaScript <span class="lang">js</span></div>
            <textarea class="editor" id="jsEditor" spellcheck="false" autocomplete="off" placeholder="Type JavaScript here..."></textarea>
          </div>
        </div>
      </div>
      <div class="output-toolbar" id="outputToolbar">
        <span style="font-weight:700">Output area</span>
        <button class="full-btn" id="minmaxResultBtn" style="float:right;">Minimize</button>
        <button class="full-btn" id="maximizeResultBtn" style="float:right;margin-right:.6em;">Maximize</button>
        <span class="status" id="outputStatus" style="margin-left:1em;">Latest preview below</span>
        <button class="run-btn" id="runBtn">Run & Update Output</button>
        <button class="full-btn" id="fullscreenBtn" title="Full screen Output">Full Output</button>
      </div>
      <div class="output-preview" id="outputPreview">
        <iframe id="resultFrame" title="Live Output" sandbox="allow-scripts allow-same-origin" style="width:100%;height:100%;border:none;border-radius:10px;min-height:140px;max-height:400px;background:#fff;"></iframe>
      </div>
    </div>
    <div id="tab-about" class="tab-content" style="display:none;max-width:800px;margin:1rem auto 0 auto;padding:2rem 1rem 2.5rem 1rem;background:var(--card-bg);border-radius:var(--radius);box-shadow:0 4px 34px #2861e030;">
      <h2 style="color:var(--highlight);margin-bottom:.6em;font-size:1.19em;">About This Platform</h2>
      <ul style="color:var(--highlight);padding-left:1.1em;">
        <li>Live code sharing and team sync, fullscreen maximization</li>
        <li>Show "who is typing"</li>
        <li>Full browser editors/result view</li>
        <li>Beautiful dark UI</li>
      </ul>
    </div>
  </main>
</div>
<!-- Fullscreen Editors Overlay -->
<div id="fullscreenEditorsOverlay" style="display:none;position:fixed;top:0;left:0;width:100vw;height:100vh;z-index:9999;background:#232741;">
  <div style="position:relative;width:100vw;height:100vh;display:flex;flex-direction:column;">
    <div class="area-header" style="padding:1.3em 1.1em 0 1.1em;">
      <span style="font-weight:800;font-size:1.3em;color:var(--highlight);">Code Editors (Full Screen)</span>
      <button id="restoreEditorsBtn" style="background:var(--primary);color:#fff;border:none;border-radius:9px;padding:.8em 1.3em;float:right;cursor:pointer;font-weight:700;font-size:.99em;">Restore</button>
    </div>
    <div id="fullscreenEditorsArea" style="flex:1;display:grid;grid-template-columns:repeat(3,1fr);gap:1.3em;padding:1em;">
      <div class="editor-block">
        <div class="editor-label">HTML <span class="lang">html</span></div>
        <textarea class="editor" id="fsHtmlEditor" spellcheck="false" autocomplete="off"></textarea>
      </div>
      <div class="editor-block">
        <div class="editor-label">CSS <span class="lang">css</span></div>
        <textarea class="editor" id="fsCssEditor" spellcheck="false" autocomplete="off"></textarea>
      </div>
      <div class="editor-block">
        <div class="editor-label">JavaScript <span class="lang">js</span></div>
        <textarea class="editor" id="fsJsEditor" spellcheck="false" autocomplete="off"></textarea>
      </div>
    </div>
  </div>
</div>
<!-- Fullscreen Result Overlay -->
<div id="fullscreenResultOverlay" style="display:none;position:fixed;top:0;left:0;width:100vw;height:100vh;z-index:9999;background:#181c27;">
  <div style="position:relative;width:100vw;height:100vh;">
    <button id="restoreResultBtn" style="position:absolute;top:1em;right:1.5em;background:var(--primary);color:#fff;border:none;border-radius:9px;padding:.7em 1.3em;cursor:pointer;font-weight:700;font-size:1em;z-index:2;">Restore</button>
    <iframe id="fsResultFrame" title="Live Output Fullscreen" sandbox="allow-scripts allow-same-origin" style="position:absolute;top:3em;left:0;width:100vw;height:calc(100vh - 3em);border:none;border-radius:0;background:#fff;"></iframe>
  </div>
</div>
<script>
/** Auth & User fetch **/
let token = localStorage.getItem("token") || "";
if (!token) {
  alert("You must be logged in! Please login to use live coding platform.");
  window.location = '/mock.html'; throw new Error("Not logged in");
}
let currentUser = { name: "", avatar: "", role: "" };
async function fetchUserDetails() {
  try {
    const resp = await fetch("https://examguard-jmvj.onrender.com/api/auth/me", {
      method: "GET",
      headers: { "Authorization": "Bearer " + token }
    });
    const data = await resp.json();
    if (data.user) {
      currentUser = {
        name: data.user.fullname || data.user.username || "Anonymous",
        avatar: data.user.profilePic || "https://api.dicebear.com/6.x/bottts/svg?seed=" + Math.floor(Math.random() * 100000)
      };
      localStorage.setItem("livecoding-username", currentUser.name);
      localStorage.setItem("livecoding-avatar", currentUser.avatar);
    }
  } catch (e) {
    alert("Authentication problem, please log in again.");
    window.location = '/mock.html';
  }
}
let fetchPromise = fetchUserDetails();

const htmlEditor = document.getElementById('htmlEditor');
const cssEditor = document.getElementById('cssEditor');
const jsEditor = document.getElementById('jsEditor');

/** Socket & Live Sync **/
const socketEndpoint = "https://examguard-jmvj.onrender.com/liveclass";
let socket, usersOnline = [], chatMessages = [], codeTypingTimeout, skipNextCodeUpdate = false;
let codeState = { html: "", css: "", js: "" };

fetchPromise.then(() => {
  socket = io(socketEndpoint, { transports: ['websocket'], query: { token } });
  socket.emit("user:join", { name: currentUser.name, avatar: currentUser.avatar });
  socket.on("user:presence", users => { usersOnline = users; renderUserList(); });
  socket.on("code:update", code => {
    codeState = code;
    if (!skipNextCodeUpdate) { loadCode(code.html, code.css, code.js, true); }
    skipNextCodeUpdate = false;
    syncFullscreenEditors(code);
  });
  socket.on("typing:code", data => {
    if (data && data.user && data.user != currentUser.name) {
      showTypingStatus(data.user + " is coding...");
      clearTimeout(codeTypingTimeout);
      codeTypingTimeout = setTimeout(hideTypingStatus, 1600);
    }
  });
  socket.on("chat:message", msg => { chatMessages.push(msg); renderChat(); });
  socket.on("typing:chat", data => {
    if (data && data.user && data.user != currentUser.name) {
      showTypingStatus(data.user + " is typing in chat...");
      clearTimeout(codeTypingTimeout);
      codeTypingTimeout = setTimeout(hideTypingStatus, 1600);
    }
  });
  document.getElementById('chatInput').addEventListener('input', function() {
    socket.emit("typing:chat", { user: currentUser.name });
  });
});

/** UI Logic **/
document.querySelectorAll('.tab-btn').forEach(btn => {
  btn.onclick = () => {
    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    document.querySelectorAll('.tab-content').forEach(tc => tc.style.display = 'none');
    document.getElementById('tab-' + btn.dataset.tab).style.display = 'block';
  }
});
function loadCode(html, css, js, updatePreview = true) {
  skipNextCodeUpdate = true;
  htmlEditor.value = html ?? "";
  cssEditor.value = css ?? "";
  jsEditor.value = js ?? "";
  if (updatePreview) updateOutput();
}
function getCode() {
  return { html: htmlEditor.value, css: cssEditor.value, js: jsEditor.value };
}
function emitTypingCode() {
  if (socket) socket.emit("typing:code", { user: currentUser.name });
  showTypingStatus("You are coding...");
  clearTimeout(codeTypingTimeout);
  codeTypingTimeout = setTimeout(hideTypingStatus, 1200);
}
htmlEditor.oninput = cssEditor.oninput = jsEditor.oninput = () => {
  if (socket) {
    socket.emit("code:update", getCode());
    emitTypingCode();
  }
  updateOutput();
  syncFullscreenEditors(getCode());
};
document.getElementById('runBtn').onclick = () => { updateOutput(); showOutputStatus("Output updated!"); };

const resultFrame = document.getElementById('resultFrame');
function updateOutput() {
  const code = getCode();
  const doc = `<!DOCTYPE html>
    <html lang="en"><head>
      <meta charset="UTF-8"><title>Live Output</title><style>${code.css}</style>
    </head><body>
    ${code.html}
    <script>${code.js}<\/script>
    </body></html>`;
  resultFrame.srcdoc = doc;
  if (document.getElementById('fullscreenOutput').style.display == "flex") {
    document.getElementById('fullResultFrame').srcdoc = doc;
  }
}
function showOutputStatus(msg) {
  const el = document.getElementById('outputStatus');
  el.textContent = msg;
  setTimeout(() => { el.textContent = "Latest preview below" }, 2200);
}
function showTypingStatus(msg){
  document.getElementById('typingStatus').textContent = msg;
}
function hideTypingStatus(){ document.getElementById('typingStatus').textContent = ""; }

function renderUserList() {
  const ul = document.getElementById('userList');
  ul.innerHTML = '';
  usersOnline.forEach(u => {
    const li = document.createElement("li");
    li.className = "user-item" + (u.name == currentUser.name ? " self" : "");
    li.innerHTML = `<img class="avatar" src="${u.avatar}" alt="avatar"/> <b>${u.name}</b> <span class="user-live"></span>`;
    ul.appendChild(li);
  });
}
function renderChat() {
  const box = document.getElementById('chatBox');
  box.innerHTML = '';
  chatMessages.forEach(c => {
    const div = document.createElement("div");
    div.className = "chat-msg";
    div.innerHTML = `<span class="chat-sender">${c.sender}</span> ${c.text}`;
    box.appendChild(div);
  });
  box.scrollTop = box.scrollHeight;
}
document.getElementById('chatForm').onsubmit = (e) => {
  e.preventDefault();
  const chatInput = document.getElementById('chatInput');
  if (chatInput.value.trim() && socket) {
    socket.emit("chat:message", {
      sender: currentUser.name, text: chatInput.value.trim(), avatar: currentUser.avatar
    });
    showTypingStatus("You are typing...");
    clearTimeout(codeTypingTimeout);
    codeTypingTimeout = setTimeout(hideTypingStatus, 1800);
    chatInput.value = "";
  }
};

window.addEventListener('DOMContentLoaded', function() {
  loadCode(
    `<h2 style="color:#2861e0;font-family:sans-serif;">Welcome to Live Coding!</h2>
    <p style="color:#333;font-size:1.15em;">Collaborate, learn, and code live together.<br/>HTML, CSS, JS editors â€” try updating below!</p>
    <div style="padding:1em;background:#e8f7fc;border-radius:13px;">
      <ul style="margin-left:2em;"><li>Type in the editors.</li><li>Click <b>Run &amp; Update Output</b> to preview below.</li><li>Open multiple browsers for multi-user effect.</li></ul>
    </div>`,
    `body { font-family: 'Inter', Arial, sans-serif; background:#e8f7fc; } h2 { font-size:2em; margin-top:.2em; font-weight:900; color: #2861e0; } p { color: #333955; font-size:1.14em; margin-bottom:1em;} li { font-size:1em; margin-bottom:.6em;}`,
    `console.log("ðŸ‘©â€ðŸ’» Live Coding Platform â€” Edit HTML, CSS & JS");`
  );
});

/* MINIMIZE/MAXIMIZE (Container/true fullscreen) */
let editorsMinimized = false, editorsMaximized = false;
let resultMinimized = false, resultMaximized = false;

document.getElementById('minmaxEditorsBtn').onclick = function() {
  editorsMinimized = !editorsMinimized;
  document.getElementById('editorsInner').style.display = editorsMinimized ? 'none' : '';
  this.textContent = editorsMinimized ? 'Restore' : 'Minimize';
};
document.getElementById('minmaxResultBtn').onclick = function() {
  resultMinimized = !resultMinimized;
  document.getElementById('outputPreview').style.display = resultMinimized ? 'none' : '';
  this.textContent = resultMinimized ? 'Restore' : 'Minimize';
};

/* MAXIMIZE TO FULLSCREEN for Editors */
function copyEditorsToFullscreen() {
  document.getElementById("fsHtmlEditor").value = htmlEditor.value;
  document.getElementById("fsCssEditor").value = cssEditor.value;
  document.getElementById("fsJsEditor").value = jsEditor.value;
}
function copyFsEditorsToOriginal() {
  htmlEditor.value = document.getElementById("fsHtmlEditor").value;
  cssEditor.value = document.getElementById("fsCssEditor").value;
  jsEditor.value = document.getElementById("fsJsEditor").value;
  htmlEditor.dispatchEvent(new Event('input'));
  cssEditor.dispatchEvent(new Event('input'));
  jsEditor.dispatchEvent(new Event('input'));
}
function syncFullscreenEditors(code) {
  document.getElementById("fsHtmlEditor").value = code.html ?? "";
  document.getElementById("fsCssEditor").value = code.css ?? "";
  document.getElementById("fsJsEditor").value = code.js ?? "";
}
document.getElementById('maximizeEditorsBtn').onclick = function() {
  editorsMaximized = true;
  // Hide everything else
  document.getElementById("mainContainer").style.display = "none";
  document.getElementById("fullscreenEditorsOverlay").style.display = "block";
  copyEditorsToFullscreen();
}
document.getElementById('restoreEditorsBtn').onclick = function() {
  editorsMaximized = false;
  document.getElementById("mainContainer").style.display = "";
  document.getElementById("fullscreenEditorsOverlay").style.display = "none";
  copyFsEditorsToOriginal();
}
/* Fullscreen editor onchange = live sync */
["fsHtmlEditor","fsCssEditor","fsJsEditor"].forEach(id=>{
  document.getElementById(id).oninput = function() {
    htmlEditor.value = document.getElementById("fsHtmlEditor").value;
    cssEditor.value = document.getElementById("fsCssEditor").value;
    jsEditor.value = document.getElementById("fsJsEditor").value;
    if(socket) {
      socket.emit("code:update", getCode());
      emitTypingCode();
    }
    updateOutput();
  }
});

/* MAXIMIZE TO FULLSCREEN for Result */
document.getElementById('maximizeResultBtn').onclick = function() {
  resultMaximized = true;
  document.getElementById("mainContainer").style.display = "none";
  document.getElementById("fullscreenResultOverlay").style.display = "block";
  document.getElementById("fsResultFrame").srcdoc = resultFrame.srcdoc;
}
document.getElementById('restoreResultBtn').onclick = function() {
  resultMaximized = false;
  document.getElementById("mainContainer").style.display = "";
  document.getElementById("fullscreenResultOverlay").style.display = "none";
}

</script>
</body>
</html>
