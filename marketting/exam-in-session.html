<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Official Exam — In Session | ExamGuard</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link href="https://fonts.googleapis.com/css?family=Inter:400,600,700&display=swap" rel="stylesheet">
  <link rel="icon" href="../logo.png">

  <style>
    :root{
      --bg-0:#f6f8ff; --bg-1:#eef2ff;
      --accent:#3b82f6; --accent-2:#6366f1; --muted:#6b7280;
      --card-bg:#ffffff; --sidebar-w:86vw; --desk-sidebar-w:300px;
      --danger:#ef4444;
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;font-family:Inter,system-ui,Arial;background:linear-gradient(180deg,var(--bg-0),var(--bg-1));-webkit-font-smoothing:antialiased;color:#0b2a44}
    a{color:inherit;text-decoration:none}

    /* Top bar */
    .topbar {
      position:sticky; top:0; z-index:120; display:flex;align-items:center;justify-content:space-between;padding:12px 16px;background:rgba(255,255,255,0.92);border-bottom:1px solid rgba(11,42,60,0.06);
    }
    .brand { display:flex; gap:12px; align-items:center; }
    .brand img { width:42px;height:42px;border-radius:8px; }
    .page-title { font-weight:900; font-size:1rem; color:var(--accent-2); }

    .main-wrap { padding:18px; max-width:1200px; margin:18px auto; }

    /* Layout: exam area + side panel (question map, timer) */
    .session { display:grid; grid-template-columns: 1fr 320px; gap:16px; align-items:start; }
    @media (max-width:980px) { .session { grid-template-columns: 1fr 320px; } }
    @media (max-width:780px) { .session { grid-template-columns: 1fr; } }

    .card { background:var(--card-bg); border-radius:12px; padding:14px; box-shadow: 0 8px 20px rgba(11,42,60,0.04); border:1px solid rgba(11,42,60,0.03); }

    /* Question area */
    .question-head { display:flex; justify-content:space-between; gap:12px; align-items:center; flex-wrap:wrap; }
    .exam-meta { font-weight:800; font-size:1.05rem; }
    .muted-small { color:var(--muted); font-size:0.9rem; }

    .question-body { margin-top:12px; min-height:220px; }
    .question-text { font-weight:800; font-size:1.05rem; line-height:1.45; }
    .choices { margin-top:12px; display:flex; flex-direction:column; gap:8px; }
    .choice { padding:10px 12px; border-radius:10px; border:1px solid #eef3ff; background:#fff; cursor:pointer; display:flex; gap:12px; align-items:center; }
    .choice.selected { background:linear-gradient(90deg,var(--accent),var(--accent-2)); color:#fff; border-color:rgba(59,130,246,0.18); }
    .choice .letter { width:28px; text-align:center; font-weight:800; }

    /* controls */
    .controls { margin-top:14px; display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    .btn { padding:10px 14px; border-radius:10px; border:none; cursor:pointer; background:linear-gradient(90deg,var(--accent),var(--accent-2)); color:#fff; font-weight:800; }
    .btn.ghost { background:transparent; color:var(--accent-2); border:1px solid rgba(59,130,246,0.08); }
    .btn.warn { background:linear-gradient(90deg,#f97316,#f59e0b); }

    /* side panel */
    .side { display:flex; flex-direction:column; gap:12px; position:sticky; top:92px; align-self:start; }
    .timer { font-weight:900; font-size:1.1rem; background:#fff; padding:10px; border-radius:10px; border:1px solid #eef3ff; text-align:center; }
    .qmap { display:grid; grid-template-columns:repeat(5,1fr); gap:8px; margin-top:10px; }
    .qbtn { padding:8px; border-radius:8px; border:1px solid #eef3ff; background:#fff; cursor:pointer; font-weight:800; }
    .qbtn.answered { background:linear-gradient(90deg,var(--accent),var(--accent-2)); color:#fff; }
    .qbtn.flagged { border:2px solid var(--danger); }

    /* integrity & status */
    .status { display:flex; gap:8px; align-items:center; margin-top:8px; }
    .status .pill { padding:6px 8px; border-radius:999px; background:#f3f6fb; font-weight:700; color:var(--muted); }

    /* login overlay inside page */
    .login-overlay { position:fixed; inset:0; display:flex; align-items:center; justify-content:center; z-index:140; background:rgba(2,6,23,0.6); }
    .login-card { width:560px; max-width:92vw; border-radius:12px; background:#fff; padding:18px; }
    .form-row { display:flex; gap:8px; flex-wrap:wrap; margin-top:8px; }
    input[type="text"], input[type="password"], input[type="number"] { padding:10px; border-radius:8px; border:1px solid #e6e9ef; width:100%; }

    /* small helpers */
    .muted-note { font-size:0.9rem; color:var(--muted); margin-top:8px; }
    .danger-note { color:var(--danger); font-weight:800; }

    /* lock overlay when submitted */
    .locked { opacity:0.6; pointer-events:none; user-select:none; }

    /* accessibility focus */
    :focus { outline:3px solid rgba(99,102,241,0.18); outline-offset:2px; border-radius:6px }
  </style>
</head>
<body>
  <div class="topbar" role="banner">
    <div class="brand" aria-hidden="false">
      <img src="../logo.png" alt="School logo">
      <div>
        <div class="page-title">Official Examination — Secure Session</div>
        <div class="muted-small" id="examSessionMeta">Central Exam</div>
      </div>
    </div>

    <div style="display:flex;gap:12px;align-items:center">
      <div class="muted-small">Secure exam environment</div>
      <div style="width:8px"></div>
    </div>
  </div>

  <main class="main-wrap" role="main">
    <!-- Login overlay shown until student verifies identity for this session -->
    <div id="loginOverlay" class="login-overlay" role="dialog" aria-modal="true" aria-labelledby="loginTitle">
      <div class="login-card card" role="document">
        <h2 id="loginTitle">Exam authentication</h2>
        <p class="muted-small">Enter your admission number and exam code to begin. Do not share your code. This session will be monitored.</p>

        <form id="authForm" style="margin-top:12px">
          <div class="form-row">
            <label style="flex:1">
              Admission number
              <input id="admNumber" type="text" autocomplete="off" required aria-required="true" />
            </label>
            <label style="width:160px">
              Exam code
              <input id="examCode" type="password" autocomplete="off" required aria-required="true" />
            </label>
          </div>

          <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px">
            <button class="btn ghost" type="button" id="authCancel">Cancel</button>
            <button class="btn" type="submit" id="authSubmit">Verify & Join</button>
          </div>

          <div class="muted-note" id="authHint">You must verify before starting. Your camera & focus will be monitored (institution policy).</div>
        </form>
      </div>
    </div>

    <!-- Main session UI -->
    <div id="sessionArea" class="session" aria-live="polite" style="display:none">
      <section class="card" id="questionCard" aria-labelledby="qHead">
        <div class="question-head" id="qHead">
          <div>
            <div class="exam-meta" id="examTitle">—</div>
            <div class="muted-small" id="examInfo">Class / Subject • Exam</div>
          </div>

          <div style="display:flex;gap:10px;align-items:center">
            <div class="timer" id="timer">00:00</div>
            <button class="btn ghost" id="fullscreenBtn">Full screen</button>
            <div id="connectionStatus" class="muted-small">Online</div>
          </div>
        </div>

        <div class="question-body" id="questionBody">
          <div id="loadingPlaceholder" class="muted-small">Loading...</div>
        </div>

        <div class="controls" id="sessionControls">
          <div>
            <button class="btn ghost" id="prevBtn" aria-label="Previous question">Previous</button>
            <button class="btn ghost" id="nextBtn" aria-label="Next question">Next</button>
            <button class="btn ghost" id="flagBtn" aria-pressed="false">Flag</button>
          </div>

          <div style="margin-left:auto;display:flex;gap:8px;align-items:center">
            <button class="btn" id="saveBtn">Save answer</button>
            <button class="btn warn" id="submitBtn">Submit exam</button>
          </div>
        </div>

        <div id="integrityBox" style="margin-top:14px" class="muted-small">
          <div>Focus warnings: <strong id="focusWarnings">0</strong></div>
          <div class="muted-small">Do not switch windows or open other applications. Window switches are tracked.</div>
        </div>
      </section>

      <aside class="side">
        <div class="card">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div style="font-weight:800">Session</div>
            <div class="muted-small" id="sessionId">—</div>
          </div>

          <div style="margin-top:10px" id="sessionMeta">
            <div class="muted-small">Student: <strong id="studentName">—</strong></div>
            <div class="muted-small" id="studentClass">Class: —</div>
          </div>

          <div style="margin-top:12px">
            <div style="font-weight:800">Question map</div>
            <div class="qmap" id="qMap" role="navigation" aria-label="Question map" tabindex="0"></div>
          </div>

          <div style="margin-top:12px">
            <div style="display:flex;justify-content:space-between;align-items:center">
              <div style="font-weight:800">Progress</div>
              <div class="muted-small" id="progressMeta">0 / 0</div>
            </div>

            <div style="margin-top:8px" class="status">
              <div class="pill" id="answeredCount">Answered: 0</div>
              <div class="pill" id="flaggedCount">Flagged: 0</div>
            </div>
          </div>
        </div>

        <div class="card">
          <div style="font-weight:800">Rules & Help</div>
          <ul class="muted-small" style="margin-top:8px">
            <li>Do not refresh or close your browser during the exam.</li>
            <li>Switching windows may be recorded and may lead to sanctions.</li>
            <li>Use the Save button frequently — answers are auto-saved periodically.</li>
          </ul>
          <div style="margin-top:12px;display:flex;gap:8px">
            <button class="btn ghost" id="helpBtn">Help</button>
            <button class="btn" id="reportBtn">Report issue</button>
          </div>
        </div>
      </aside>
    </div>

    <!-- Submission modal -->
    <div id="submitModal" class="login-overlay" style="display:none" role="dialog" aria-modal="true">
      <div class="login-card card">
        <h3>Confirm submission</h3>
        <p class="muted-small">You are about to submit your answers. This action cannot be undone. Make sure you saved your answers.</p>
        <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px">
          <button class="btn ghost" id="cancelSubmit">Cancel</button>
          <button class="btn warn" id="confirmSubmit">Submit now</button>
        </div>
      </div>
    </div>

    <!-- Result / End modal -->
    <div id="endModal" class="login-overlay" style="display:none" role="dialog" aria-modal="true">
      <div class="login-card card">
        <h3>Exam submitted</h3>
        <p class="muted-small" id="endMessage">Thank you — your answers have been recorded.</p>
        <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px">
          <button class="btn" id="endOk">Close</button>
        </div>
      </div>
    </div>

  </main>

  <script>
    (function () {
      // Configuration
      const API_BASE = 'https://examguide.onrender.com/api'; // replace with official endpoints
      const AUTO_SAVE_INTERVAL = 7000; // ms
      const FOCUS_WARNING_LIMIT = 3; // after X switches, record

      // State
      let session = {
        sessionId: null,
        examId: null,
        student: null,
        questions: [], // {id, q, choices[], answerIndex?}
        currentIndex: 0,
        answers: {}, // qid => selectedIndex
        flagged: new Set(),
        durationSec: 0,
        remaining: 0,
        autoSaveT: null,
        focusWarnings: 0,
        infractions: []
      };
      let autoSaveTimer = null;
      let countdownT = null;
      let isAuthenticated = false;
      let isSubmitted = false;
      let offline = false;

      // DOM
      const loginOverlay = document.getElementById('loginOverlay');
      const authForm = document.getElementById('authForm');
      const admNumberEl = document.getElementById('admNumber');
      const examCodeEl = document.getElementById('examCode');
      const authCancel = document.getElementById('authCancel');

      const sessionArea = document.getElementById('sessionArea');
      const examTitle = document.getElementById('examTitle');
      const examInfo = document.getElementById('examInfo');
      const timerEl = document.getElementById('timer');
      const questionBody = document.getElementById('questionBody');
      const prevBtn = document.getElementById('prevBtn');
      const nextBtn = document.getElementById('nextBtn');
      const flagBtn = document.getElementById('flagBtn');
      const saveBtn = document.getElementById('saveBtn');
      const submitBtn = document.getElementById('submitBtn');
      const fullscreenBtn = document.getElementById('fullscreenBtn');
      const qMap = document.getElementById('qMap');
      const answeredCountEl = document.getElementById('answeredCount');
      const flaggedCountEl = document.getElementById('flaggedCount');
      const progressMeta = document.getElementById('progressMeta');
      const selectionInfo = document.getElementById('selectionInfo');
      const connectionStatus = document.getElementById('connectionStatus');
      const authHint = document.getElementById('authHint');
      const sessionIdEl = document.getElementById('sessionId');
      const studentNameEl = document.getElementById('studentName');
      const studentClassEl = document.getElementById('studentClass');

      const submitModal = document.getElementById('submitModal');
      const cancelSubmit = document.getElementById('cancelSubmit');
      const confirmSubmit = document.getElementById('confirmSubmit');

      const endModal = document.getElementById('endModal');
      const endMessage = document.getElementById('endMessage');
      const endOk = document.getElementById('endOk');

      // Prevent copy/paste/print & right-click to reduce casual data exfiltration
      document.addEventListener('contextmenu', (e) => e.preventDefault());
      document.addEventListener('copy', (e)=> e.preventDefault());
      document.addEventListener('cut', (e)=> e.preventDefault());
      document.addEventListener('paste', (e)=> e.preventDefault());
      window.addEventListener('keydown', (e) => {
        if ((e.ctrlKey || e.metaKey) && ['p','s','c','v','x','u','w'].includes((e.key || '').toLowerCase())) {
          e.preventDefault();
        }
      });

      // Auth form handling (mocked)
      authForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const adm = admNumberEl.value.trim();
        const code = examCodeEl.value.trim();
        if (!adm || !code) { authHint.textContent = 'Admission number and exam code are required.'; return; }
        authHint.textContent = 'Verifying...';

        try {
          // Replace with real call:
          // const res = await fetch(`${API_BASE}/exams/verify`, {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({adm, code, exam: getExamId()})});
          // const data = await res.json();
          // For demo: simulate verification
          await delay(700);
          // demo student
          const data = {
            ok: true,
            student: { id: adm, name: 'Demo Student', class: 'SS2' },
            exam: { id: getExamId() || 'EXAM-DEMO', title: 'Central Examination — Term', subject: 'Biology', durationMinutes: 30 },
            questions: mockQuestionsForDemo() // replace with server
          };

          if (!data.ok) { authHint.textContent = data.message || 'Verification failed'; return; }

          // set session
          session.student = data.student;
          session.examId = data.exam.id;
          session.sessionId = 'S-' + Math.random().toString(36).slice(2,10).toUpperCase();
          session.questions = data.questions.slice();
          session.durationSec = (data.exam.durationMinutes || 30) * 60;
          session.remaining = session.durationSec;
          session.answers = {}; session.flagged = new Set(); session.currentIndex = 0;

          // mark authenticated and show UI
          isAuthenticated = true;
          loginOverlay.style.display = 'none';
          sessionArea.style.display = '';
          examTitle.textContent = data.exam.title;
          examInfo.textContent = `${data.student.class} • ${data.exam.subject}`;
          sessionIdEl.textContent = session.sessionId;
          studentNameEl.textContent = data.student.name;
          studentClassEl.textContent = data.student.class;
          document.getElementById('examSessionMeta').textContent = `${data.exam.title} • ${data.exam.subject}`;

          // render first question & map, start autosave & timer
          renderQuestion(0);
          renderQMap();
          startAutoSave();
          startTimer();
          setupVisibilityTracking();
          authHint.textContent = '';
        } catch (err) {
          console.error(err);
          authHint.textContent = 'Network error during verification. Try again.';
        }
      });

      authCancel.addEventListener('click', () => {
        // redirect to homepage or simply stay
        if (confirm('Cancel and return to the main page?')) window.location.href = '/';
      });

      // Helper: get exam id from url query param (exam=EXAM-xxx)
      function getExamId() {
        const p = new URLSearchParams(window.location.search);
        return p.get('exam') || null;
      }

      // Mock questions (for demo)
      function mockQuestionsForDemo() {
        // produce 12 MCQs
        const qs = [];
        for (let i=1;i<=12;i++){
          qs.push({
            id: 'Q' + String(i).padStart(3,'0'),
            q: `Sample question ${i}: Which option is correct?`,
            choices: ['Option A','Option B','Option C','Option D']
          });
        }
        return qs;
      }

      // Render question at index
      function renderQuestion(index) {
        if (!session.questions.length) { questionBody.innerHTML = '<div class="muted-small">No questions loaded.</div>'; return; }
        session.currentIndex = Math.max(0, Math.min(index, session.questions.length - 1));
        const q = session.questions[session.currentIndex];
        // build DOM
        const answered = typeof session.answers[q.id] === 'number';
        const flagged = session.flagged.has(q.id);
        const html = document.createElement('div');
        html.innerHTML = `
          <div class="question-text">Q${session.currentIndex + 1}. ${escapeHtml(q.q)}</div>
          <div class="choices" role="list" aria-label="Choices"></div>
        `;
        const choicesWrap = html.querySelector('.choices');
        q.choices.forEach((c, idx) => {
          const btn = document.createElement('button');
          btn.className = 'choice' + ((session.answers[q.id] === idx) ? ' selected' : '');
          btn.type = 'button';
          btn.dataset.idx = idx;
          btn.innerHTML = `<div class="letter">${String.fromCharCode(65 + idx)}</div><div style="flex:1;text-align:left">${escapeHtml(c)}</div>`;
          btn.addEventListener('click', () => {
            session.answers[q.id] = idx;
            renderQuestion(session.currentIndex);
            renderQMap(); updateProgress();
          });
          choicesWrap.appendChild(btn);
        });
        // attach to body
        questionBody.innerHTML = '';
        questionBody.appendChild(html);

        // update controls
        flagBtn.setAttribute('aria-pressed', flagged ? 'true' : 'false');
        flagBtn.textContent = flagged ? 'Flagged' : 'Flag';
        // update navigation button disabled state
        prevBtn.disabled = session.currentIndex === 0;
        nextBtn.disabled = session.currentIndex === session.questions.length - 1;

        updateProgress();
      }

      // Q map render
      function renderQMap() {
        qMap.innerHTML = '';
        session.questions.forEach((q, i) => {
          const btn = document.createElement('button');
          btn.className = 'qbtn' + (session.answers[q.id] !== undefined ? ' answered' : '') + (session.flagged.has(q.id) ? ' flagged' : '');
          btn.textContent = i + 1;
          btn.dataset.i = i;
          btn.addEventListener('click', () => {
            renderQuestion(i);
          });
          qMap.appendChild(btn);
        });
      }

      // Update progress meta
      function updateProgress() {
        const answered = Object.keys(session.answers).length;
        const flagged = session.flagged.size;
        answeredCountEl.textContent = `Answered: ${answered}`;
        flaggedCountEl.textContent = `Flagged: ${flagged}`;
        progressMeta.textContent = `${answered} / ${session.questions.length}`;
      }

      // Controls
      prevBtn.addEventListener('click', ()=> renderQuestion(session.currentIndex - 1));
      nextBtn.addEventListener('click', ()=> renderQuestion(session.currentIndex + 1));
      flagBtn.addEventListener('click', () => {
        const q = session.questions[session.currentIndex];
        if (!q) return;
        if (session.flagged.has(q.id)) session.flagged.delete(q.id); else session.flagged.add(q.id);
        flagBtn.setAttribute('aria-pressed', session.flagged.has(q.id) ? 'true' : 'false');
        flagBtn.textContent = session.flagged.has(q.id) ? 'Flagged' : 'Flag';
        renderQMap(); updateProgress();
        saveSession();
      });

      saveBtn.addEventListener('click', () => {
        saveSession(true);
        alert('Answer saved');
      });

      // Autosave to server/local
      function startAutoSave() {
        if (autoSaveTimer) clearInterval(autoSaveTimer);
        autoSaveTimer = setInterval(()=> {
          saveSession(false);
        }, AUTO_SAVE_INTERVAL);
      }

      async function saveSession(showMessage = false) {
        // persist locally first
        try {
          const payload = {
            sessionId: session.sessionId, examId: session.examId, studentId: session.student?.id,
            answers: session.answers, flagged: Array.from(session.flagged), remaining: session.remaining, currentIndex: session.currentIndex
          };
          localStorage.setItem('eg_exam_save_' + session.sessionId, JSON.stringify(payload));
          // Attempt to POST to server (mocked)
          // await fetch(`${API_BASE}/exam/session/save`, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload)});
        } catch (err) {
          console.warn('Autosave failed', err);
        }
        if (showMessage) connectionStatus.textContent = 'Saved';
      }

      // Timer
      function startTimer() {
        if (countdownT) clearInterval(countdownT);
        updateTimer();
        countdownT = setInterval(() => {
          if (session.remaining > 0) {
            session.remaining--;
            updateTimer();
            if (session.remaining % 30 === 0) saveSession(false); // periodic save checkpoint
          } else {
            clearInterval(countdownT);
            // auto-submit
            autoSubmit('Time expired');
          }
        }, 1000);
      }

      function updateTimer() {
        const m = Math.floor(session.remaining / 60).toString().padStart(2,'0');
        const s = Math.floor(session.remaining % 60).toString().padStart(2,'0');
        timerEl.textContent = `${m}:${s}`;
        // change color warnings
        const pct = session.remaining / session.durationSec;
        if (pct < 0.1) timerEl.style.color = 'var(--danger)';
        else if (pct < 0.25) timerEl.style.color = '#d97706';
        else timerEl.style.color = '#0b2a44';
      }

      // Fullscreen toggle
      fullscreenBtn.addEventListener('click', () => {
        const el = document.documentElement;
        if (!document.fullscreenElement) {
          el.requestFullscreen?.();
          fullscreenBtn.textContent = 'Exit full';
        } else {
          document.exitFullscreen?.();
          fullscreenBtn.textContent = 'Full screen';
        }
      });

      // Submission workflow
      submitBtn.addEventListener('click', () => {
        submitModal.style.display = 'flex';
      });
      cancelSubmit.addEventListener('click', ()=> submitModal.style.display = 'none');
      confirmSubmit.addEventListener('click', async () => {
        submitModal.style.display = 'none';
        await doSubmit('User confirmed submit');
      });

      async function doSubmit(reason='Manual submit') {
        if (isSubmitted) return;
        // stop timers
        if (autoSaveTimer) clearInterval(autoSaveTimer);
        if (countdownT) clearInterval(countdownT);

        // prepare payload
        const payload = {
          sessionId: session.sessionId, examId: session.examId, studentId: session.student.id,
          answers: session.answers, flagged: Array.from(session.flagged), reason, timestamp: new Date().toISOString()
        };
        // POST to server (mock)
        try {
          // const res = await fetch(`${API_BASE}/exam/session/submit`, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
          // const r = await res.json();
          await delay(800);
          // mock result
          const r = { ok:true, score: Math.floor(Math.random()*100), trace: 'TRC-' + Math.random().toString(36).slice(2,8).toUpperCase() };
          isSubmitted = true;
          // lock UI
          document.getElementById('questionCard').classList.add('locked');
          endMessage.innerHTML = `Your answers were submitted. Trace: <strong>${r.trace}</strong>. Score will be available after grading.`;
          endModal.style.display = 'flex';
        } catch (err) {
          alert('Submission failed — your data is saved locally and will be retried.');
          saveSession(false);
        }
      }

      endOk.addEventListener('click', ()=> {
        endModal.style.display = 'none';
        // redirect out or show summary
        window.location.href = '/'; // return to portal
      });

      // Visibility tracking (simple focus loss detection)
      function setupVisibilityTracking() {
        let lastHiddenAt = null;
        document.addEventListener('visibilitychange', () => {
          if (document.hidden) {
            // lost focus
            session.focusWarnings++;
            session.infractions.push({ type:'visibility', at: new Date().toISOString() });
            document.getElementById('focusWarnings').textContent = session.focusWarnings;
            if (session.focusWarnings >= FOCUS_WARNING_LIMIT) {
              // warn and optionally notify server
              alert('Multiple focus switches detected. This may be recorded by exam proctors.');
            }
            lastHiddenAt = Date.now();
          } else {
            // regained focus
            const duration = lastHiddenAt ? Math.round((Date.now() - lastHiddenAt)/1000) : 0;
            lastHiddenAt = null;
            // attempt to auto-save on return
            saveSession(false);
          }
        });

        // blur/focus window detection (e.g., alt-tab)
        window.addEventListener('blur', () => {
          session.focusWarnings++;
          session.infractions.push({ type:'blur', at: new Date().toISOString() });
          document.getElementById('focusWarnings').textContent = session.focusWarnings;
        });
      }

      // Reconnect / offline detection
      window.addEventListener('online', () => {
        offline = false; connectionStatus.textContent = 'Online';
      });
      window.addEventListener('offline', () => {
        offline = true; connectionStatus.textContent = 'Offline — your answers are saved locally';
      });

      // Helpers
      function escapeHtml(s) { return String(s || '').replace(/[&<>"']/g, function (m) { return ({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' })[m]; }); }
      function delay(ms) { return new Promise(res => setTimeout(res, ms)); }

      // Initialize in demo mode: if a token is present (e.g., ?auto=1) skip auth for convenience
      (function initDemo() {
        // If query param demo=1 show demo logged in for quick preview
        const p = new URLSearchParams(window.location.search);
        if (p.get('demo') === '1') {
          admNumberEl.value = 'ADM-DEM-001'; examCodeEl.value = 'DEMO';
          authForm.dispatchEvent(new Event('submit', { cancelable:true }));
        }
      })();

      // Keyboard navigation: number keys 1-4 choose answer, arrows change question
      document.addEventListener('keydown', (e) => {
        if (!isAuthenticated || isSubmitted) return;
        if (e.key === 'ArrowRight') renderQuestion(session.currentIndex + 1);
        if (e.key === 'ArrowLeft') renderQuestion(session.currentIndex - 1);
        if (/^[1-4]$/.test(e.key)) {
          const q = session.questions[session.currentIndex];
          if (!q) return;
          const idx = parseInt(e.key,10) - 1;
          session.answers[q.id] = idx;
          renderQuestion(session.currentIndex);
          renderQMap();
          saveSession(false);
        }
        if (e.key.toLowerCase() === 's' && (e.ctrlKey || e.metaKey)) {
          e.preventDefault();
          saveSession(true);
        }
      });

      // Expose for debugging
      window._eg_official_session = session;

    })();
  </script>
</body>
</html>
