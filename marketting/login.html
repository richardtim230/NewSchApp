<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Login — École des Roches</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="description" content="Secure login for applicants and staff. Role-protected, with accessible modals and toast notifications." />

  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Playfair+Display:wght@600&display=swap" rel="stylesheet">

  <style>
    :root{
      --navy: #061728;
      --gold: #f6b83f;
      --bg: #f3f6f8;
      --card: #ffffff;
      --muted: #6b7280;
      --danger: #dc2626;
      --success: #16a34a;
      --radius: 12px;
      --max-width: 980px;
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      min-height:100vh;
      font-family:'Inter',system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial;
      background: linear-gradient(180deg,#edf2f7, #e8eef6);
      color: #071224;
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
    }

    .page {
      max-width: var(--max-width);
      margin: 40px auto;
      padding: 24px;
    }

    .header{
      display:flex;
      align-items:center;
      gap:14px;
      margin-bottom:20px;
    }

    .logo {
      background:var(--gold);
      color:var(--navy);
      font-family:'Playfair Display',serif;
      font-weight:700;
      padding:10px 14px;
      border-radius:8px;
      font-size:20px;
    }

    .brand-meta {
      font-size:14px;
      color:var(--muted);
    }

    .auth-panel {
      display:grid;
      grid-template-columns: 1fr 360px;
      gap: 20px;
      align-items:start;
    }

    @media (max-width: 940px) {
      .auth-panel { grid-template-columns: 1fr; }
    }

    .card {
      background:var(--card);
      border-radius:var(--radius);
      padding:22px;
      box-shadow: 0 12px 40px rgba(2,11,24,0.06);
    }

    .login-card {
      max-width: 720px;
    }

    h1 {
      font-family:'Playfair Display',serif;
      font-size:22px;
      margin:0 0 8px 0;
    }

    p.lead { margin:0 0 18px 0; color:var(--muted); }

    form .grid {
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:12px;
    }

    @media (max-width:640px){ form .grid { grid-template-columns: 1fr; } }

    label { display:block; font-weight:600; font-size:13px; margin-bottom:6px; color:#071224 }
    input, select {
      width:100%; padding:10px 12px; border-radius:8px; border:1px solid #e7ecf3;
      background:#fff; font-size:14px;
    }

    .field { margin-bottom:12px; }

    .controls { display:flex; gap:12px; align-items:center; flex-wrap:wrap; margin-top:6px; }
    .btn { padding:10px 14px; border-radius:8px; border:0; cursor:pointer; font-weight:700; }
    .btn-primary { background:var(--navy); color:#fff; }
    .btn-ghost { background:transparent; border:1px solid rgba(2,11,24,0.06); color:var(--navy); }
    .btn-link { background:transparent; color:var(--navy); text-decoration:underline; padding:6px; border-radius:6px; }

    .muted { color:var(--muted); font-size:13px; }

    .remember { display:flex; align-items:center; gap:8px; font-size:14px; }

    /* helper column (right) */
    .help {
      display:flex; flex-direction:column; gap:12px;
    }
    .help .note { font-size:14px; color:var(--muted) }
    .help .role-card { padding:12px; border-radius:10px; background:#fafcfe; border:1px solid rgba(2,11,24,0.03) }
    .help .role-card strong{display:block;margin-bottom:6px}
    .help .links { display:flex; gap:8px; margin-top:6px; flex-wrap:wrap }

    /* Modal (accessible) */
    .modal-backdrop {
      position:fixed; inset:0; background:rgba(2,11,24,0.48); display:none; align-items:center; justify-content:center; z-index:1200;
    }
    .modal-backdrop.open { display:flex; }

    .modal {
      width:100%; max-width:520px; background:var(--card); border-radius:12px; padding:18px; box-shadow:0 18px 44px rgba(2,11,24,0.26);
    }

    .modal h3 { margin:0 0 8px 0; font-family:'Playfair Display',serif; }
    .modal p.muted { color:var(--muted); margin-bottom:12px }

    .modal .actions { margin-top:14px; display:flex; gap:8px; justify-content:flex-end; }

    /* Toast system */
    .toast-wrap {
      position:fixed;
      right:18px;
      bottom:18px;
      display:flex;
      flex-direction:column;
      gap:10px;
      z-index:1400;
      width:320px;
      max-width: calc(100% - 36px);
    }

    .toast {
      background:#fff;
      border-radius:10px;
      padding:12px 14px;
      box-shadow:0 10px 30px rgba(2,11,24,0.12);
      display:flex;
      gap:12px;
      align-items:flex-start;
      border-left:4px solid #cbd5e1;
      animation:toastIn .18s ease;
    }
    .toast.success { border-left-color: var(--success); }
    .toast.error { border-left-color: var(--danger); }
    .toast .title { font-weight:700; margin-bottom:2px; }
    .toast .desc { color:var(--muted); font-size:13px; }
    .toast .close { margin-left:auto; background:transparent;border:0; cursor:pointer; color:var(--muted); font-weight:700 }

    @keyframes toastIn {
      from { transform: translateY(8px); opacity:0 }
      to { transform: translateY(0); opacity:1 }
    }

    /* small spinner */
    .spinner {
      width:18px;height:18px;border-radius:50%;border:2px solid rgba(0,0,0,0.08);border-top-color:var(--navy);
      animation:spin .9s linear infinite;
    }
    @keyframes spin { to { transform:rotate(360deg) } }

    /* small helpers */
    .sr-only { position:absolute; left:-9999px; top:auto; width:1px; height:1px; overflow:hidden; }
  </style>
</head>

<body>
  <main class="page" id="login-root">
    <header class="header">
      <div class="logo" aria-hidden="true">ER</div>
      <div>
        <div style="font-weight:700">École des Roches</div>
        <div class="brand-meta">Secure access for applicants, staff and administrators</div>
      </div>
    </header>

    <section class="auth-panel">
      <!-- Left: Login form -->
      <div class="card login-card" aria-labelledby="login-title">
        <h1 id="login-title">Sign in</h1>
        <p class="lead">Enter your credentials to continue. Access is role-protected — your role determines the dashboard you reach.</p>

        <form id="login-form" novalidate>
          <div class="grid">
            <div class="field">
              <label for="email">Email</label>
              <input id="email" type="email" name="email" autocomplete="email" required />
            </div>

            <div class="field">
              <label for="role">Role</label>
              <select id="role" name="role" required>
                <option value="applicant">Applicant</option>
                <option value="admissions">Admissions</option>
                <option value="admin">Administrator</option>
              </select>
            </div>

            <div class="field" style="grid-column:1 / -1">
              <label for="password">Password</label>
              <input id="password" type="password" name="password" autocomplete="current-password" required />
            </div>

            <div class="field" style="grid-column:1 / 2">
              <label class="remember"><input id="remember" type="checkbox" /> Remember me</label>
            </div>

            <div class="field" style="grid-column:2 / 3; text-align:right">
              <button type="button" id="forgot-btn" class="btn btn-link" aria-haspopup="dialog">Forgot password?</button>
            </div>
          </div>

          <div class="controls" style="margin-top:12px">
            <button type="submit" class="btn btn-primary" id="login-btn">
              <span id="login-btn-text">Sign in</span>
              <span id="login-spinner" class="spinner" style="display:none;margin-left:8px"></span>
            </button>
            <button type="button" id="demo-btn" class="btn btn-ghost">Demo login</button>
            <div class="muted" style="margin-left:auto">Need an account? <a href="#" id="apply-link">Apply now</a></div>
          </div>
        </form>
      </div>

      <!-- Right: help / guidance -->
      <aside class="help">
        <div class="card role-card" aria-hidden="true">
          <strong>Role guidance</strong>
          <div class="muted">Choose the role your account belongs to. The server must confirm role membership — client-side choice is only for UX.</div>
          <div class="links">
            <a class="pill" href="#">Reset password</a>
            <a class="pill" href="#">Contact support</a>
          </div>
        </div>

        <div class="card">
          <strong>Security notes</strong>
          <div class="muted">This page uses secure server-side authentication. Tokens are stored in sessionStorage by default for better security. For persistent sessions enable 'Remember me'.</div>
        </div>

        <div class="card">
          <strong>Two-step verification</strong>
          <div class="muted">If your account has 2FA enabled you'll be prompted after successful password authentication.</div>
        </div>
      </aside>
    </section>
  </main>

  <!-- Modal: Forgot password -->
  <div id="modal-backdrop" class="modal-backdrop" role="presentation" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modal-title" aria-describedby="modal-desc" tabindex="-1">
      <h3 id="modal-title">Reset password</h3>
      <p id="modal-desc" class="muted">Enter your account email and we'll send password reset instructions.</p>

      <div>
        <label for="reset-email">Email</label>
        <input id="reset-email" type="email" />
      </div>

      <div class="actions">
        <button id="modal-cancel" class="btn btn-ghost">Cancel</button>
        <button id="modal-send" class="btn btn-primary">Send reset email</button>
      </div>
    </div>
  </div>

  <!-- Modal: Role mismatch (example when server says role doesn't match chosen) -->
  <div id="role-modal-backdrop" class="modal-backdrop" role="presentation" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="role-modal-title" tabindex="-1">
      <h3 id="role-modal-title">Role mismatch</h3>
      <p class="muted" id="role-modal-desc">The account you provided is registered with a different role than the one you selected.</p>
      <div class="actions">
        <button id="role-modal-close" class="btn btn-ghost">Choose role</button>
        <button id="role-modal-proceed" class="btn btn-primary">Proceed anyway</button>
      </div>
    </div>
  </div>

  <!-- Toast container (aria-live for screen readers) -->
  <div class="toast-wrap" aria-live="polite" aria-atomic="false" id="toast-wrap"></div>

  <script>
    // Accessible modal helpers and toast system + login flow (vanilla JS)
    (function () {
      // Elements
      const loginForm = document.getElementById('login-form');
      const loginBtn = document.getElementById('login-btn');
      const loginBtnText = document.getElementById('login-btn-text');
      const loginSpinner = document.getElementById('login-spinner');
      const forgotBtn = document.getElementById('forgot-btn');
      const modalBackdrop = document.getElementById('modal-backdrop');
      const modalSend = document.getElementById('modal-send');
      const modalCancel = document.getElementById('modal-cancel');
      const resetEmail = document.getElementById('reset-email');

      const roleModalBackdrop = document.getElementById('role-modal-backdrop');
      const roleModalClose = document.getElementById('role-modal-close');
      const roleModalProceed = document.getElementById('role-modal-proceed');

      const toastWrap = document.getElementById('toast-wrap');

      // Focus trap utilities for modal
      function trapFocus(modal) {
        const focusable = modal.querySelectorAll('a[href], button:not([disabled]), input, select, textarea, [tabindex]:not([tabindex="-1"])');
        if (!focusable.length) return () => {};
        const first = focusable[0];
        const last = focusable[focusable.length - 1];
        function handle(e) {
          if (e.key === 'Tab') {
            if (e.shiftKey && document.activeElement === first) {
              e.preventDefault();
              last.focus();
            } else if (!e.shiftKey && document.activeElement === last) {
              e.preventDefault();
              first.focus();
            }
          } else if (e.key === 'Escape') {
            closeAllModals();
          }
        }
        document.addEventListener('keydown', handle);
        return () => document.removeEventListener('keydown', handle);
      }

      function openModal(backdrop) {
        backdrop.classList.add('open');
        backdrop.setAttribute('aria-hidden', 'false');
        const modal = backdrop.querySelector('.modal');
        if (modal) {
          const previouslyFocused = document.activeElement;
          // focus first interactive element
          setTimeout(() => {
            const focusable = modal.querySelector('input,button,select,textarea,[tabindex]:not([tabindex="-1"])');
            if (focusable) focusable.focus();
          }, 60);
          const release = trapFocus(modal);
          modal._releaseFocus = release;
          modal._previous = previouslyFocused;
        }
      }

      function closeModal(backdrop) {
        backdrop.classList.remove('open');
        backdrop.setAttribute('aria-hidden', 'true');
        const modal = backdrop.querySelector('.modal');
        if (modal && modal._releaseFocus) modal._releaseFocus();
        if (modal && modal._previous) {
          try { modal._previous.focus(); } catch (e) {}
        }
      }

      function closeAllModals() {
        closeModal(modalBackdrop);
        closeModal(roleModalBackdrop);
      }

      // Toast system
      let toastId = 0;
      function showToast({ title = '', message = '', type = 'success', duration = 6000 } = {}) {
        const id = ++toastId;
        const t = document.createElement('div');
        t.className = 'toast ' + (type === 'error' ? 'error' : 'success');
        t.setAttribute('role', 'status');
        t.setAttribute('aria-live', 'polite');

        t.innerHTML = `
          <div style="flex:0 0 8px;"></div>
          <div style="flex:1">
            <div class="title">${escapeHtml(title)}</div>
            <div class="desc">${escapeHtml(message)}</div>
          </div>
          <button class="close" aria-label="Dismiss toast">&times;</button>
        `;

        const closeBtn = t.querySelector('.close');
        closeBtn.addEventListener('click', () => removeToast(t));

        // pause on hover
        let timer = setTimeout(() => removeToast(t), duration);
        t.addEventListener('mouseenter', () => clearTimeout(timer));
        t.addEventListener('mouseleave', () => timer = setTimeout(() => removeToast(t), duration));

        toastWrap.appendChild(t);
        return {
          id,
          dismiss: () => removeToast(t)
        };
      }

      function removeToast(node) {
        if (!node) return;
        node.style.opacity = '0';
        setTimeout(() => {
          try { if (node.parentNode) node.parentNode.removeChild(node); } catch (e) {}
        }, 220);
      }

      // Simple HTML escape for toasts
      function escapeHtml(s) {
        if (!s) return '';
        return String(s).replace(/[&<>"']/g, function (m) {
          return ({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' })[m];
        });
      }

      // Modal interactions
      forgotBtn.addEventListener('click', () => openModal(modalBackdrop));
      modalCancel.addEventListener('click', () => closeModal(modalBackdrop));

      // Example: send reset (fake/send to server)
      modalSend.addEventListener('click', async () => {
        const email = resetEmail.value.trim();
        if (!email) { showToast({ title:'Email required', message:'Please enter your email address.', type:'error' }); resetEmail.focus(); return; }

        modalSend.disabled = true;
        modalSend.textContent = 'Sending...';
        try {
          // Send request to server endpoint to trigger password reset email
          const resp = await fetch('/api/send-password-reset', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ email })
          });

          if (!resp.ok) {
            const txt = await resp.text();
            throw new Error(txt || 'Failed to send reset email');
          }

          showToast({ title:'Email sent', message:'Check your inbox for password reset instructions.', type:'success' });
          closeModal(modalBackdrop);
        } catch (err) {
          console.error(err);
          showToast({ title:'Failed', message: err.message || 'Unable to send email.', type:'error' });
        } finally {
          modalSend.disabled = false;
          modalSend.textContent = 'Send reset email';
        }
      });

      // Role modal actions
      roleModalClose.addEventListener('click', () => closeModal(roleModalBackdrop));
      roleModalProceed.addEventListener('click', async () => {
        // If user chooses to proceed despite mismatch, continue with login flow (this is a UX choice)
        closeModal(roleModalBackdrop);
        // Trigger an artificial click on login button to proceed (or you could continue from cached state)
        // We do nothing here; main login flow handles server response cases.
      });

      // Demo login quick-fill
      document.getElementById('demo-btn').addEventListener('click', () => {
        document.getElementById('email').value = 'applicant@example.com';
        document.getElementById('password').value = 'Password123!';
        document.getElementById('role').value = 'applicant';
        showToast({ title:'Demo', message:'Credentials filled for demo account', type:'success', duration:2500 });
      });

      // Primary login flow
      loginForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const email = document.getElementById('email').value.trim();
        const password = document.getElementById('password').value;
        const selectedRole = document.getElementById('role').value;
        const remember = document.getElementById('remember').checked;

        if (!email || !password) {
          showToast({ title:'Missing fields', message:'Please provide both email and password.', type:'error' });
          return;
        }

        // UI: loading
        loginBtn.disabled = true;
        loginSpinner.style.display = 'inline-block';
        loginBtnText.textContent = 'Signing in';

        try {
          // Send credentials to server
          const resp = await fetch('/api/login', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ email, password })
          });

          const json = await resp.json().catch(() => ({}));

          if (!resp.ok || !json || json.success !== true) {
            // Unsuccessful
            const message = (json && json.message) ? json.message : 'Invalid credentials or server error';
            showToast({ title:'Sign-in failed', message, type:'error' });
            return;
          }

          // At this point server accepted credentials and responded with token and role (server MUST enforce roles)
          // Example expected server response: { success:true, token:"...", role:"applicant", requires2fa: false }
          const serverRole = json.role || 'applicant';
          const token = json.token || '';

          // Role mismatch - UX decision: show modal asking user to confirm
          if (serverRole !== selectedRole) {
            // Show role mismatch modal explaining server role vs selected role
            const desc = document.getElementById('role-modal-desc');
            desc.textContent = `Your account is registered as "${serverRole}" on our system, but you selected "${selectedRole}". Do you want to continue as "${serverRole}"?`;
            openModal(roleModalBackdrop);

            // Wait for user choice - for simplicity, we provide "Proceed anyway" which will continue with serverRole
            // We wire roleModalProceed to finalize login; attach a one-time listener
            const proceedHandler = async () => {
              closeModal(roleModalBackdrop);
              await finalizeLogin({ token, role: serverRole, remember });
              roleModalProceed.removeEventListener('click', proceedHandler);
            };
            roleModalProceed.addEventListener('click', proceedHandler);
            return;
          }

          // Normal flow - finalize login
          await finalizeLogin({ token, role: serverRole, remember, requires2fa: json.requires2fa });

        } catch (err) {
          console.error(err);
          showToast({ title:'Network error', message: 'Could not reach authentication server.', type:'error' });
        } finally {
          loginSpinner.style.display = 'none';
          loginBtnText.textContent = 'Sign in';
          loginBtn.disabled = false;
        }
      });

      // finalizeLogin stores token client-side and navigates user to role dashboard.
      async function finalizeLogin({ token, role, remember = false, requires2fa = false } = {}) {
        if (!token) {
          showToast({ title:'Missing token', message:'Authentication token not returned by server.', type:'error' });
          return;
        }

        try {
          // Storage strategy:
          // - If "remember" is chosen, persist in localStorage (long-lived).
          // - Otherwise keep in sessionStorage (cleared on tab close).
          const storage = remember ? localStorage : sessionStorage;
          storage.setItem('auth_token', token);
          storage.setItem('auth_role', role);
          showToast({ title:'Signed in', message: 'Welcome — redirecting...', type:'success', duration:2000 });

          // If 2FA is required, redirect to 2FA flow
          if (requires2fa) {
            // server should return a 2FA identifier; here we redirect to /2fa where backend expects token in storage
            setTimeout(() => window.location.href = '/auth/2fa', 900);
            return;
          }

          // Redirect according to role - these routes are examples; enforce server-side protection on each route
          const routes = {
            applicant: '/dashboard/applicant',
            admissions: '/dashboard/admissions',
            admin: '/dashboard/admin'
          };
          const dest = routes[role] || '/dashboard';
          setTimeout(() => window.location.href = dest, 900);

        } catch (err) {
          console.error(err);
          showToast({ title:'Storage error', message:'Failed to save session. Try again.', type:'error' });
        }
      }

      // Close modals on backdrop click
      [modalBackdrop, roleModalBackdrop].forEach(backdrop => {
        backdrop.addEventListener('click', (e) => {
          if (e.target === backdrop) closeModal(backdrop);
        });
      });

      // Accessibility: close modals with Escape key (global)
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') closeAllModals();
      });

      // Initial demo toast (optional)
      // showToast({ title:'Notice', message:'This is a client-side demo. Server must enforce authentication and role protection.', type:'success', duration:8000 });

      // NOTE: For security, role protection MUST be implemented server-side.
      // Client-side role selection is for UX only.
    })();
  </script>
</body>
</html>
