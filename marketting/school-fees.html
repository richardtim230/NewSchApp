<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Fees & Payments | ExamGuard</title>
  <meta name="viewport" content="width=device-width,initial-scale=0.701" />
  <link href="https://fonts.googleapis.com/css?family=Inter:400,600,700&display=swap" rel="stylesheet">
  <link rel="icon" href="../logo.png">

  <!-- CRITICAL / above-the-fold CSS only (kept small). Full styles are injected lazily after invoices are fetched. -->
  <style id="critical-styles">
    :root{
      --bg-0:#f6f8ff; --bg-1:#eef2ff; --accent:#0ea5ff; --accent-2:#6366f1; --muted:#6b7280;
      --card-bg:#ffffff; --radius:12px; --sidebar-w:300px;
    }
    html,body{height:100%;margin:0;font-family:Inter,system-ui,Arial;background:linear-gradient(180deg,var(--bg-0),var(--bg-1));-webkit-font-smoothing:antialiased;color:#0b2a44}
    a{color:inherit;text-decoration:none}
    .app{display:flex;min-height:100vh;align-items:stretch}
    .overlay{position:fixed;inset:0;background:rgba(2,6,23,0.45);z-index:50;display:none}
    .overlay.visible{display:block}
    .sidebar{width:var(--sidebar-w);min-width:var(--sidebar-w);background:linear-gradient(180deg,#0f172a,#1e3a8a);color:#fff;padding:20px 16px;position:fixed;left:0;top:0;bottom:0;z-index:100;display:flex;flex-direction:column;gap:14px;}
    .brand img{width:44px;height:44px;border-radius:10px;object-fit:cover}
    .topbar{position:fixed; left:var(--sidebar-w); top:0; width:calc(100vw - var(--sidebar-w)); z-index:90; display:flex;align-items:center;justify-content:space-between;padding:12px 14px; background:rgba(255,255,255,0.86); box-shadow:0 6px 18px rgba(11,42,60,0.04); min-height:64px}
    .main{margin-left:var(--sidebar-w);padding:20px;flex:1;padding-top:90px;min-height:100vh}
    .card{background:var(--card-bg);border-radius:12px;padding:16px;border:1px solid rgba(11,42,60,0.03)}
    /* Skeleton & spinner */
    .loading-overlay { position:relative; }
    .skeleton { background: linear-gradient(90deg,#eef3ff,#f8fbff,#eef3ff); background-size:200% 100%; animation: shimmer 1.4s linear infinite; border-radius:8px; }
    @keyframes shimmer { 0% { background-position:200% 0 } 100% { background-position:-200% 0 } }
    .spinner { width:44px;height:44px;border-radius:50%;border:4px solid rgba(0,0,0,0.06);border-top-color:var(--accent); animation:spin 1s linear infinite; display:inline-block }
    @keyframes spin { to { transform: rotate(360deg) } }
    .center { display:flex;align-items:center;gap:12px }
    /* keep invoice table hidden until full CSS loaded to avoid flash */
    .needs-full-css { visibility:hidden; }
    .needs-full-css.ready { visibility:visible; }
  </style>
</head>
<body>
  <div class="app" id="app">
    <div class="overlay" id="overlay" aria-hidden="true"></div>

    <aside class="sidebar hidden" id="sidebar" aria-label="Main navigation" role="navigation">
      <div class="brand" aria-hidden="false">
        <img src="../logo.png" alt="Logo">
        <div>
          <div class="title">Student Portal</div>
          <div class="subtitle" id="schoolSubtitle" style="font-size:0.95rem;color:rgba(255,255,255,0.88)">Sunrise High ‚Ä¢ Student</div>
        </div>
      </div>

      <nav class="nav" id="nav" aria-label="Primary">
        <a href="student.html" data-section="home">üè† Dashboard</a>
        <a href="courses.html" data-section="courses">üìò My Courses</a>
        <a href="assignments.html" data-section="assignments">üìù Assignments</a>
        <a href="timetable.html" data-section="timetable">‚è∞ Timetable</a>
        <a href="messages.html" data-section="messages">‚úâÔ∏è Messages</a>
        <a href="fees.html" data-section="fees" class="active">üí≥ Fees & Payments</a>
        <a href="resources.html" data-section="resources">üìÇ Resources</a>
        <a href="settings.html" data-section="settings">‚öôÔ∏è Settings</a>
      </nav>

      <div class="spacer" aria-hidden="true"></div>

      <div class="profile" role="region" aria-label="Student profile">
        <img src="../avatar.jpg" alt="Student avatar" id="studentAvatar">
        <div>
          <div class="name" id="studentName">Student</div>
          <div class="muted" id="studentClass">‚Äî</div>
        </div>
      </div>
    </aside>

    <div class="topbar" id="topbar">
      <div style="display:flex;gap:12px;align-items:center;">
        <button class="hamburger" id="hamburger" aria-label="Open menu">‚ò∞</button>
        <div>
          <div class="page-title" id="pageTitle">Fees & Payments</div>
        </div>
      </div>

      <div style="display:flex;gap:12px;align-items:center;">
        <div class="chip" aria-hidden="true" id="sessionChip">Session: ‚Äî</div>
        <img src="../avatar.jpg" alt="You" style="width:44px;height:44px;border-radius:8px;object-fit:cover;border:2px solid #fff;" id="topbarAvatar">
      </div>
    </div>

    <main class="main" id="main" role="main" tabindex="-1">
      <section aria-labelledby="feesHeading">
        <!-- Loading area: spinner + skeleton until invoices fetched and full CSS applied -->
        <div id="loadingArea" class="card loading-overlay" aria-live="polite" role="status">
          <div class="center">
            <div class="spinner" aria-hidden="true"></div>
            <div>
              <div style="font-weight:800">Loading invoices...</div>
              <div class="muted-small" id="loadingMsg">Contacting server to fetch your invoices.</div>
            </div>
          </div>

          <div style="margin-top:14px;display:grid;grid-template-columns:repeat(3,1fr);gap:12px">
            <div style="height:80px" class="skeleton" aria-hidden="true"></div>
            <div style="height:80px" class="skeleton" aria-hidden="true"></div>
            <div style="height:80px" class="skeleton" aria-hidden="true"></div>
          </div>
        </div>

        <!-- Actual content (hidden until full CSS injected and data rendered) -->
        <div id="content" class="needs-full-css" style="margin-top:14px">
          <div class="card fees-hero" style="margin-bottom:14px">
            <div class="balance" aria-hidden="false">
              <div>
                <div class="small muted">Outstanding Balance</div>
                <div class="amount" id="outstanding">‚Ç¶ 0.00</div>
                <div class="muted-small" id="balanceMeta">No unpaid invoices</div>
              </div>
            </div>

            <div class="actions" role="region" aria-label="Actions">
              <button class="btn" id="payNowBtn" aria-haspopup="dialog">Pay Now</button>
              <button class="btn ghost" id="exportCsvBtn">Export CSV</button>
              <button class="btn neutral" id="printBtn">Print</button>
            </div>
          </div>

          <div class="grid" style="margin-bottom:12px;">
            <div class="card col-4" style="min-height:120px;">
              <div style="display:flex;justify-content:space-between;align-items:center;">
                <div style="font-weight:800">Summary</div>
                <div class="small muted">Last 12 months</div>
              </div>
              <div style="margin-top:10px">
                <div class="small muted">Total billed</div>
                <div style="font-weight:900;font-size:1.18rem" id="totalBilled">‚Ç¶ 0.00</div>
                <div style="margin-top:8px" class="small muted">Paid: <strong id="totalPaid">‚Ç¶ 0.00</strong> ‚Ä¢ Remaining: <strong id="totalRem">‚Ç¶ 0.00</strong></div>
              </div>
            </div>

            <div class="card col-4" style="min-height:120px;">
              <div style="font-weight:800">Upcoming</div>
              <div style="margin-top:10px">
                <div id="nextDueTitle" style="font-weight:700">No upcoming payments</div>
                <div class="small muted" id="nextDueMeta">--</div>
                <div style="margin-top:10px" class="muted-small">You will receive reminders via email & SMS.</div>
              </div>
            </div>

            <div class="card col-4" style="min-height:120px;">
              <div style="font-weight:800">Quick Links</div>
              <div style="margin-top:10px;display:flex;gap:8px;flex-wrap:wrap">
                <button class="pm" onclick="openPaymentHistory()">Payment history</button>
                <button class="pm" onclick="openInvoiceUpload()">Upload proof</button>
                <button class="pm" onclick="openSupport()">Contact support</button>
              </div>
            </div>
          </div>

          <div class="card" style="margin-bottom:12px;">
            <div style="display:flex;justify-content:space-between;align-items:center;">
              <div style="font-weight:800">Invoices</div>
              <div class="small muted">Filter & search</div>
            </div>

            <div style="margin-top:12px;display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap">
              <div class="filters" role="search" aria-label="Invoice filters">
                <input type="search" id="invoiceSearch" placeholder="Search by invoice reference, description or amount" aria-label="Search invoices">
                <select id="statusFilter" aria-label="Filter by payment status">
                  <option value="">All statuses</option>
                  <option value="unpaid">Unpaid</option>
                  <option value="partial">Partial</option>
                  <option value="paid">Paid</option>
                </select>
                <select id="yearFilter" aria-label="Filter by year">
                  <option value="">All years</option>
                  <option>2026</option>
                  <option>2025</option>
                  <option>2024</option>
                </select>
              </div>

              <div style="display:flex;gap:8px;align-items:center">
                <button class="btn ghost" id="newInvoiceBtn">Request invoice</button>
                <button class="btn" id="toggleViewBtn" aria-pressed="false">Mobile view</button>
              </div>
            </div>

            <div style="margin-top:12px" class="invoice-table-wrap">
              <table class="table" role="table" aria-label="Invoices table">
                <thead>
                  <tr><th>Ref</th><th>Description</th><th>Due</th><th>Amount</th><th>Status</th><th class="right">Actions</th></tr>
                </thead>
                <tbody id="invoicesTbody" role="rowgroup">
                  <!-- populated by JS -->
                </tbody>
              </table>
            </div>

            <!-- Mobile cards -->
            <div class="invoice-cards" id="invoiceCards" aria-live="polite">
              <!-- populated by JS -->
            </div>

            <div id="emptyInvoices" class="empty" style="display:none">No invoices found.</div>
          </div>

          <div class="card" style="margin-bottom:40px">
            <div style="display:flex;justify-content:space-between;align-items:center">
              <div><div style="font-weight:800">Payment Audit & Compliance</div><div class="small muted">Receipts, unique trace IDs & tamper-evident records</div></div>
              <div class="muted-small">PCI DSS-ready ‚Ä¢ ISO27001-aligned</div>
            </div>

            <div style="margin-top:12px">
              <ul class="muted-small">
                <li>All transactions generate a signed receipt linked to your student account.</li>
                <li>Export transaction logs for audits or scholarship verification.</li>
                <li>Support for multiple currencies and international payment gateways (configure backend).</li>
              </ul>
            </div>
          </div>
        </div>
      </section>
    </main>

    <!-- Invoice modal -->
    <div class="modal" id="invoiceModal" role="dialog" aria-modal="true" aria-hidden="true" aria-labelledby="invoiceModalTitle">
      <div class="panel" role="document">
        <div class="head">
          <div>
            <div id="invoiceModalTitle" style="font-weight:800">Invoice</div>
            <div class="small muted" id="invoiceModalSubtitle">Invoice details</div>
          </div>
          <div>
            <button class="btn ghost" id="downloadInvoiceBtn">Download</button>
            <button class="btn neutral" id="closeInvoiceBtn">Close</button>
          </div>
        </div>
        <div class="body" id="invoiceModalBody" style="display:grid;grid-template-columns:1fr 300px;gap:12px;">
          <div>
            <div style="padding:12px 0">
              <div class="muted-small">Reference</div>
              <div id="modalRef" style="font-weight:900;font-size:1.05rem">--</div>
            </div>
            <div style="padding:12px 0">
              <div class="muted-small">Description</div>
              <div id="modalDesc">--</div>
            </div>
            <div style="padding:12px 0">
              <div class="muted-small">Due date</div>
              <div id="modalDue">--</div>
            </div>
            <div style="padding:12px 0">
              <div class="muted-small">Items</div>
              <table style="width:100%;border-collapse:collapse">
                <thead><tr><th style="text-align:left;padding:8px">Item</th><th style="text-align:right;padding:8px">Amount</th></tr></thead>
                <tbody id="modalItems"></tbody>
                <tfoot><tr><td style="padding:8px;font-weight:800">Total</td><td style="padding:8px;text-align:right;font-weight:900" id="modalTotal">--</td></tr></tfoot>
              </table>
            </div>
          </div>
          <aside style="background:#f8fbff;padding:12px;border-radius:8px">
            <div style="font-weight:800">Status</div>
            <div style="margin-top:8px" id="modalStatus"></div>
            <div style="margin-top:12px">
              <button class="btn" id="modalPayNowBtn">Pay</button>
              <button class="btn ghost" id="modalUploadBtn">Upload Proof</button>
            </div>
            <div style="margin-top:12px" class="muted-small">Trace ID: <span id="modalTrace">--</span></div>
          </aside>
        </div>
      </div>
    </div>

    <!-- Payment modal -->
    <div class="modal" id="paymentModal" role="dialog" aria-modal="true" aria-hidden="true" aria-labelledby="paymentModalTitle">
      <div class="panel" role="document">
        <div class="head">
          <div>
            <div id="paymentModalTitle" style="font-weight:800">Make a Payment</div>
            <div class="small muted">Secure checkout ‚Äî simulated gateway</div>
          </div>
          <div>
            <button class="btn neutral" id="cancelPaymentBtn">Cancel</button>
          </div>
        </div>
        <div class="body" style="display:grid;grid-template-columns:1fr 320px;gap:12px;">
          <form id="paymentForm" style="padding:12px" aria-label="Payment form" novalidate>
            <div class="field">
              <label for="pay_invoice">Invoice</label>
              <select id="pay_invoice" required aria-required="true"></select>
            </div>

            <div class="field">
              <label for="pay_amount">Amount</label>
              <input id="pay_amount" type="number" min="0.01" step="0.01" required aria-required="true">
            </div>

            <div class="field">
              <label>Method</label>
              <div class="payment-methods" role="radiogroup" aria-label="Payment methods">
                <div class="pm active" role="radio" tabindex="0" aria-checked="true" data-method="card">Card</div>
                <div class="pm" role="radio" tabindex="0" aria-checked="false" data-method="bank">Bank Transfer</div>
                <div class="pm" role="radio" tabindex="0" aria-checked="false" data-method="ussd">USSD</div>
              </div>
            </div>

            <div id="cardFields">
              <div class="field">
                <label for="card_name">Cardholder name</label>
                <input id="card_name" type="text" autocomplete="cc-name" />
              </div>
              <div class="field">
                <label for="card_number">Card number</label>
                <input id="card_number" type="text" inputmode="numeric" pattern="[0-9\s]{12,19}" maxlength="19" placeholder="4242 4242 4242 4242" />
              </div>
              <div style="display:flex;gap:8px">
                <div class="field" style="flex:1">
                  <label for="card_exp">Expiry (MM/YY)</label>
                  <input id="card_exp" type="text" placeholder="08/26" />
                </div>
                <div class="field" style="width:120px">
                  <label for="card_cvv">CVV</label>
                  <input id="card_cvv" type="password" inputmode="numeric" maxlength="4" />
                </div>
              </div>
            </div>

            <div style="margin-top:12px;display:flex;gap:8px;align-items:center">
              <button class="btn" id="confirmPayBtn" type="submit">Confirm payment</button>
              <button class="btn ghost" type="button" id="saveForLaterBtn">Save for later</button>
            </div>

            <div id="paymentMessage" class="muted-small" style="margin-top:10px"></div>
          </form>

          <aside style="background:#f8fbff;padding:12px;border-radius:8px">
            <div style="font-weight:800">Receipt preview</div>
            <div style="margin-top:8px" id="receiptPreview">No payment yet</div>
            <div style="margin-top:12px" class="muted-small">All payments are logged with a unique trace ID and timestamp.</div>
          </aside>
        </div>
      </div>
    </div>

  </div>

  <script>
    (function () {
      // Backend config
      const API_BASE = 'https://examguide.onrender.com/api';
      const TOKEN = localStorage.getItem('eg_token') || null;

      // DOM refs
      const sidebar = document.getElementById('sidebar');
      const overlay = document.getElementById('overlay');
      const hamburger = document.getElementById('hamburger');
      const payNowBtn = document.getElementById('payNowBtn');
      const paymentModal = document.getElementById('paymentModal');
      const invoiceModal = document.getElementById('invoiceModal');
      const invoicesTbody = document.getElementById('invoicesTbody');
      const invoiceCards = document.getElementById('invoiceCards');
      const outstandingEl = document.getElementById('outstanding');
      const totalBilledEl = document.getElementById('totalBilled');
      const totalPaidEl = document.getElementById('totalPaid');
      const totalRemEl = document.getElementById('totalRem');
      const balanceMeta = document.getElementById('balanceMeta');
      const invoiceSearch = document.getElementById('invoiceSearch');
      const statusFilter = document.getElementById('statusFilter');
      const yearFilter = document.getElementById('yearFilter');
      const toggleViewBtn = document.getElementById('toggleViewBtn');
      const exportCsvBtn = document.getElementById('exportCsvBtn');
      const printBtn = document.getElementById('printBtn');
      const payInvoiceSelect = document.getElementById('pay_invoice');
      const payAmountInput = document.getElementById('pay_amount');
      const paymentForm = document.getElementById('paymentForm');
      const receiptPreview = document.getElementById('receiptPreview');
      const confirmPayBtn = document.getElementById('confirmPayBtn');
      const modalPayNowBtn = document.getElementById('modalPayNowBtn');

      const loadingArea = document.getElementById('loadingArea');
      const loadingMsg = document.getElementById('loadingMsg');
      const content = document.getElementById('content');
      const sessionChip = document.getElementById('sessionChip');
      const studentNameEl = document.getElementById('studentName');
      const studentClassEl = document.getElementById('studentClass');
      const topbarAvatar = document.getElementById('topbarAvatar');

      // State
      let invoices = []; // will be fetched from backend
      let currentUser = null;

      // helper format
      function formatCurrency(n) {
        if (n == null) return '‚Ç¶ 0.00';
        return '‚Ç¶ ' + Number(n).toLocaleString();
      }

      function statusFor(inv) {
        if ((inv.paid || 0) >= (inv.amount || 0)) return 'paid';
        if ((inv.paid || 0) > 0) return 'partial';
        return 'unpaid';
      }

      // Lazy-load full CSS: original large stylesheet extracted into JS string and injected after invoices are fetched.
      // NOTE: keep this string aligned with your original styles if you prefer a separate file on the server and load it via <link rel="stylesheet">.
      const fullStyles = `
/* START full CSS injected lazily */
:root{
  --bg-0:#f6f8ff; --bg-1:#eef2ff;
  --accent:#0ea5ff; --accent-2:#6366f1; --muted:#6b7280;
  --card-bg:#ffffff; --radius:12px;
  --sidebar-w:300px;
  --success:#10b981; --danger:#ef4444;
  --glass: rgba(255,255,255,0.86);
}
*{box-sizing:border-box}
html,body{height:100%;margin:0;font-family:Inter,system-ui,Arial;background:linear-gradient(180deg,var(--bg-0),var(--bg-1));-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;color:#0b2a44}
a{color:inherit;text-decoration:none}
.app{display:flex;min-height:100vh;align-items:stretch}
.overlay{position:fixed;inset:0;background:rgba(2,6,23,0.45);z-index:50;display:none}
.overlay.visible{display:block}
.sidebar{
  width:var(--sidebar-w);min-width:var(--sidebar-w);
  background:linear-gradient(180deg,#0f172a 0%, #1e3a8a 100%);color:#fff;padding:20px 16px;position:fixed;left:0;top:0;bottom:0;z-index:100;
  box-shadow:4px 0 28px rgba(15,23,42,0.12);display:flex;flex-direction:column;gap:14px;overflow-y:auto;transition:none;
}
@media (max-width:720px){
  .sidebar{transform:translateX(-110%);transition:transform .28s ease;position:fixed;width:86vw;min-width:86vw}
  .sidebar.hidden{transform:translateX(-110%)}
  .sidebar.open{transform:translateX(0);box-shadow:0 24px 48px rgba(2,6,23,0.5)}
}
.brand{display:flex;gap:12px;align-items:center}
.brand img{width:44px;height:44px;border-radius:10px;object-fit:cover;border:3px solid rgba(255,224,102,0.12);background:#fff}
.brand .title{font-weight:800;font-size:1.05rem;color:#ffea7a}
.nav{display:flex;flex-direction:column;gap:8px;margin-top:6px}
.nav a{display:flex;align-items:center;gap:10px;padding:12px;border-radius:10px;font-weight:700;font-size:1rem;color:#e6eefc;background:transparent;transition:background .12s,transform .08s}
.nav a:hover,.nav a.active{background:rgba(255,255,255,0.04);color:#ffea7a;transform:translateX(3px)}
.profile{display:flex;gap:12px;align-items:center;padding-top:10px;border-top:1px solid rgba(255,255,255,0.04)}
.profile img{width:48px;height:48px;border-radius:10px;object-fit:cover;border:2px solid #ffe066}
.spacer{flex:1}
.topbar{
  position:fixed; left:var(--sidebar-w); top:0; width:calc(100vw - var(--sidebar-w)); z-index:90;
  display:flex;align-items:center;justify-content:space-between;gap:12px;padding:12px 14px;
  backdrop-filter: blur(6px); background:var(--glass); border-bottom:1px solid rgba(11,42,60,0.06);
  box-shadow:0 6px 18px rgba(11,42,60,0.04); min-height:64px;
}
.hamburger{display:none;background:var(--accent);color:#fff;border:none;padding:9px 12px;border-radius:10px;cursor:pointer;font-weight:800;font-size:1.05rem}
.page-title{font-weight:800;font-size:1.05rem;color:var(--accent-2)}
.main{margin-left:var(--sidebar-w);padding:20px;flex:1;transition:margin-left .28s;min-height:100vh;overflow-y:auto;padding-top:90px}
@media (max-width:980px){ .hamburger{display:inline-flex} .topbar{left:0;width:100vw;padding:10px 12px} }
@media (max-width:720px){
  :root{--sidebar-w:86vw}
  .sidebar{transform:translateX(-110%);position:fixed;width:var(--sidebar-w);min-width:var(--sidebar-w)}
  .sidebar.open{transform:translateX(0);box-shadow: 0 24px 48px rgba(2,6,23,0.5)}
  .overlay{display:none}
  .overlay.visible{display:block}
  body.no-scroll{overflow:hidden;height:100vh;touch-action:none}
  .main{margin-left:0;padding:14px;padding-top:80px}
  .nav a{padding:14px}
}
.grid{display:grid;grid-template-columns:repeat(12,1fr);gap:14px;align-items:start}
.card{background:var(--card-bg);border-radius:12px;padding:16px;box-shadow:0 8px 20px rgba(11,42,60,0.04);border:1px solid rgba(11,42,60,0.03)}
.col-4{grid-column:span 4}.col-8{grid-column:span 8}.col-6{grid-column:span 6}.col-12{grid-column:1 / -1}
.muted{color:var(--muted)}
.small{font-size:0.92rem;color:var(--muted)}
.fees-hero{display:flex;gap:14px;align-items:center;justify-content:space-between;flex-wrap:wrap}
.balance{display:flex;gap:14px;align-items:center}
.balance .amount{font-weight:900;font-size:1.8rem;color:var(--accent-2)}
.balance .label{color:var(--muted)}
.actions{display:flex;gap:10px;align-items:center}
.btn{padding:10px 14px;border-radius:10px;border:none;cursor:pointer;background:linear-gradient(90deg,var(--accent),var(--accent-2));color:#fff;font-weight:800}
.btn.ghost{background:transparent;border:1px solid rgba(59,130,246,0.08);color:var(--accent-2)}
.btn.neutral{background:#f3f6fb;color:#0b2033}
.chip{padding:8px 10px;border-radius:999px;background:#fff;border:1px solid #eef3ff;font-weight:700}
.table{width:100%;border-collapse:collapse}
.table thead th{background:#f8fbff;padding:10px;text-align:left;font-weight:800;border-bottom:1px solid #eef3ff}
.table tbody td{padding:10px;border-bottom:1px solid #f1f5fb}
.status{padding:6px 8px;border-radius:999px;font-weight:800;font-size:0.85rem}
.status.paid{background:rgba(16,185,129,0.12);color:var(--success);border:1px solid rgba(16,185,129,0.12)}
.status.unpaid{background:rgba(239,68,68,0.08);color:var(--danger);border:1px solid rgba(239,68,68,0.06)}
.status.partial{background:rgba(250,204,21,0.12);color:#b45309;border:1px solid rgba(250,204,21,0.08)}
.invoice-cards{display:none;gap:12px}
@media (max-width:720px){
  .grid{grid-template-columns:1fr}
  .col-4,.col-8,.col-6{grid-column:auto}
  .invoice-table-wrap{display:none}
  .invoice-cards{display:flex;flex-direction:column}
}
.filters{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
.filters input[type="search"], .filters select{padding:8px 10px;border-radius:8px;border:1px solid #e6e9ef;background:#fff}
.modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(2,6,23,0.45);z-index:9999;padding:16px}
.modal.active{display:flex}
.modal .panel{background:#fff;border-radius:12px;max-width:900px;width:100%;overflow:hidden;box-shadow:0 20px 60px rgba(2,6,23,0.25)}
.modal .panel .body{padding:18px}
.modal .panel .head{padding:12px 18px;border-bottom:1px solid #eef3ff;background:#f8fbff;display:flex;align-items:center;justify-content:space-between}
.payment-methods{display:flex;gap:8px;flex-wrap:wrap}
.pm{padding:10px 12px;border-radius:10px;border:1px solid #eef3ff;background:#fff;cursor:pointer}
.pm.active{box-shadow:0 8px 20px rgba(11,42,60,0.06);border-color:var(--accent-2)}
.field{display:flex;flex-direction:column;gap:6px;margin-bottom:8px}
.field input, .field select{padding:10px;border-radius:8px;border:1px solid #e6e9ef}
.right{margin-left:auto}
.muted-small{font-size:0.9rem;color:var(--muted)}
.empty{padding:28px;text-align:center;color:var(--muted);border:1px dashed #eef3ff;border-radius:12px}
@media (max-width:980px){ .grid{grid-template-columns:repeat(6,1fr)} .col-4{grid-column:span 6} .hamburger{display:inline-flex} }
/* END full CSS injected lazily */
`;

      // small sanitizers for safety
      function sanitizeText(s){ return String(s == null ? '' : s); }
      function sanitizeAttr(s){ return String(s == null ? '' : s).replace(/["']/g,''); }

      // Insert full styles into document head
      function injectFullCss() {
        if (document.getElementById('full-styles')) return;
        const style = document.createElement('style');
        style.id = 'full-styles';
        style.textContent = fullStyles;
        document.head.appendChild(style);
        // mark content visible
        content.classList.add('ready');
      }

      // Try multiple backend endpoints to fetch invoices for the logged-in user
      async function fetchInvoicesForCurrentUser() {
        const headers = {};
        if (TOKEN) headers['Authorization'] = 'Bearer ' + TOKEN;

        // attempt to infer student identifier from localStorage eg_application
        let app = null;
        try { app = JSON.parse(localStorage.getItem('eg_application') || 'null') || null; } catch (e) { app = null; }
        if (app) {
          studentNameEl.textContent = (app.firstName || app.name || app.username) + (app.lastName ? (' ' + app.lastName) : '');
          studentClassEl.textContent = app.program || app.class || app.level || studentClassEl.textContent;
          if (app.profilePic) { topbarAvatar.src = app.profilePic; }
          if (app.session) sessionChip.textContent = 'Session: ' + app.session;
        }

        // Candidate endpoints (flexible to match different API shapes)
        const candidates = [
          `${API_BASE}/invoices?studentId=${encodeURIComponent(app && (app._id || app.id || app.studentId || app.username) || '')}`,
          `${API_BASE}/invoices?student=${encodeURIComponent(app && (app._id || app.id || app.studentId || app.username) || '')}`,
          `${API_BASE}/me/invoices`,
          `${API_BASE}/invoices/me`,
          `${API_BASE}/invoices?mine=true`,
          `${API_BASE}/students/invoices` // generic
        ];

        // Try endpoints one-by-one until one returns data
        for (const url of candidates) {
          if (!url) continue;
          try {
            const res = await fetch(url, { headers });
            if (!res.ok) continue;
            const data = await res.json();
            // Accept many shapes: array, { invoices: [...] }, { data: [...] }, { results: [...] }
            if (Array.isArray(data)) return data;
            if (Array.isArray(data.invoices)) return data.invoices;
            if (Array.isArray(data.data)) return data.data;
            if (Array.isArray(data.results)) return data.results;
            if (Array.isArray(data.items)) return data.items;
            // maybe the API returns a single invoice object (wrap it)
            if (data && (data.id || data._id) && data.amount) return [data];
          } catch (err) {
            // continue to next candidate
            console.warn('fetch invoices candidate failed', url, err);
          }
        }

        // If nothing worked, return null to let caller decide (we'll fallback to empty list)
        return null;
      }

      // Render invoices into table and mobile cards
      function renderInvoices() {
        invoicesTbody.innerHTML = '';
        invoiceCards.innerHTML = '';
        const q = (invoiceSearch.value || '').toLowerCase();
        const status = statusFilter.value;
        const year = yearFilter.value;
        const filtered = invoices.filter(inv=>{
          const s = statusFor(inv);
          if (status && s !== status) return false;
          if (year && !(inv.id || inv.reference || '').includes(year)) return false;
          if (!q) return true;
          return ((inv.id||inv.reference||'') + ' ' + (inv.desc||inv.description||'') + ' ' + (inv.amount||'')).toLowerCase().includes(q);
        });

        if (!filtered.length) {
          document.getElementById('emptyInvoices').style.display = '';
        } else {
          document.getElementById('emptyInvoices').style.display = 'none';
        }

        filtered.forEach(inv=>{
          // table row
          const tr = document.createElement('tr');
          const refTd = document.createElement('td'); refTd.textContent = inv.id || inv.reference || '‚Äî';
          const descTd = document.createElement('td'); descTd.textContent = inv.desc || inv.description || '‚Äî';
          const dueTd = document.createElement('td'); dueTd.textContent = inv.due || inv.dueDate || inv.due_at || '‚Äî';
          const amtTd = document.createElement('td'); amtTd.textContent = formatCurrency(inv.amount);
          const statusTd = document.createElement('td'); const s = statusFor(inv);
          const span = document.createElement('span'); span.className = 'status ' + s; span.textContent = s.toUpperCase();
          statusTd.appendChild(span);
          const actionsTd = document.createElement('td'); actionsTd.className = 'right';
          const viewBtn = document.createElement('button'); viewBtn.className='btn ghost'; viewBtn.textContent='View'; viewBtn.addEventListener('click', ()=>openInvoice(inv));
          const payBtn = document.createElement('button'); payBtn.className='btn'; payBtn.style.marginLeft='8px'; payBtn.textContent='Pay'; payBtn.addEventListener('click', ()=>openPayment(inv));
          actionsTd.appendChild(viewBtn); actionsTd.appendChild(payBtn);
          tr.appendChild(refTd); tr.appendChild(descTd); tr.appendChild(dueTd); tr.appendChild(amtTd); tr.appendChild(statusTd); tr.appendChild(actionsTd);
          invoicesTbody.appendChild(tr);

          // mobile card
          const card = document.createElement('article'); card.style.background='#fff'; card.style.padding='12px'; card.style.borderRadius='12px'; card.style.border='1px solid #eef3ff';
          const h = document.createElement('div'); h.style.display='flex'; h.style.justifyContent='space-between'; h.style.alignItems='center';
          const left = document.createElement('div'); left.innerHTML = `<div style="font-weight:800">${inv.id || inv.reference || ''}</div><div class="muted-small">${inv.desc || inv.description || ''}</div>`;
          const right = document.createElement('div'); right.innerHTML = `<div style="font-weight:900">${formatCurrency(inv.amount)}</div><div class="muted-small">${inv.due || inv.dueDate || ''}</div>`;
          h.appendChild(left); h.appendChild(right);
          const foot = document.createElement('div'); foot.style.display='flex'; foot.style.gap='8px'; foot.style.marginTop='10px';
          const vBtn = document.createElement('button'); vBtn.className='btn ghost'; vBtn.textContent='View'; vBtn.addEventListener('click', ()=>openInvoice(inv));
          const pBtn = document.createElement('button'); pBtn.className='btn'; pBtn.textContent='Pay'; pBtn.addEventListener('click', ()=>openPayment(inv));
          const st = document.createElement('div'); st.className='status '+statusFor(inv); st.style.marginLeft='auto'; st.style.alignSelf='center';
          foot.appendChild(vBtn); foot.appendChild(pBtn); foot.appendChild(st);
          card.appendChild(h); card.appendChild(foot);
          invoiceCards.appendChild(card);
        });
      }

      // Compute summary values
      function computeSummary() {
        const total = invoices.reduce((s,i)=>s+(i.amount||0),0);
        const paid = invoices.reduce((s,i)=>s+(i.paid||0),0);
        const rem = total - paid;
        totalBilledEl.textContent = formatCurrency(total);
        totalPaidEl.textContent = formatCurrency(paid);
        totalRemEl.textContent = formatCurrency(rem);
        outstandingEl.textContent = rem > 0 ? formatCurrency(rem) : formatCurrency(0);
        balanceMeta.textContent = rem > 0 ? `${invoices.filter(i=> (i.amount||0) - (i.paid||0) > 0).length} unpaid invoice(s)` : 'You have no outstanding payments';
        // next due
        const unpaid = invoices.filter(i=> (i.amount||0) - (i.paid||0) > 0).sort((a,b)=> new Date(a.due || a.dueDate || 0) - new Date(b.due || b.dueDate || 0));
        if (unpaid.length) {
          document.getElementById('nextDueTitle').textContent = unpaid[0].desc || unpaid[0].description || unpaid[0].id || 'Upcoming payment';
          document.getElementById('nextDueMeta').textContent = unpaid[0].due || unpaid[0].dueDate || '‚Äî';
        } else {
          document.getElementById('nextDueTitle').textContent = 'No upcoming payments';
          document.getElementById('nextDueMeta').textContent = '--';
        }
      }

      // Open / close sidebar (mobile)
      function openSidebar() { sidebar.classList.add('open'); sidebar.classList.remove('hidden'); overlay.classList.add('visible'); document.body.classList.add('no-scroll'); }
      function closeSidebar() { sidebar.classList.remove('open'); sidebar.classList.add('hidden'); overlay.classList.remove('visible'); document.body.classList.remove('no-scroll'); }
      hamburger.addEventListener('click', openSidebar);
      overlay.addEventListener('click', closeSidebar);

      // Open invoice modal (fills modal with invoice data)
      function openInvoice(inv) {
        // inv may be object or ID
        const invoice = (typeof inv === 'string') ? invoices.find(i=>i.id===inv || i.reference===inv) : inv;
        if (!invoice) return;
        document.getElementById('modalRef').textContent = invoice.id || invoice.reference || '--';
        document.getElementById('modalDesc').textContent = invoice.desc || invoice.description || '--';
        document.getElementById('modalDue').textContent = invoice.due || invoice.dueDate || '--';
        const itemsTbody = document.getElementById('modalItems'); itemsTbody.innerHTML='';
        const items = invoice.items || invoice.line_items || invoice.lines || [];
        if (items.length) {
          items.forEach(it=>{
            const r = document.createElement('tr');
            r.innerHTML = `<td style="padding:8px">${it.name || it.description || 'Item'}</td><td style="padding:8px;text-align:right">${formatCurrency(it.amount || it.value || 0)}</td>`;
            itemsTbody.appendChild(r);
          });
        } else {
          const r = document.createElement('tr'); r.innerHTML = `<td style="padding:8px">‚Äî</td><td style="padding:8px;text-align:right">‚Äî</td>`; itemsTbody.appendChild(r);
        }
        document.getElementById('modalTotal').textContent = formatCurrency(invoice.amount || 0);
        document.getElementById('modalStatus').innerHTML = `<span class="status ${statusFor(invoice)}">${statusFor(invoice).toUpperCase()}</span>`;
        document.getElementById('modalTrace').textContent = invoice.trace || invoice.referenceId || '‚Äî';
        invoiceModal.classList.add('active'); invoiceModal.setAttribute('aria-hidden','false');
      }

      // Payment flow (note: this demo still simulates payment client-side; replace with server call as needed)
      function openPayment(inv) {
        populatePayInvoiceSelect();
        const selectedId = (typeof inv === 'object') ? (inv.id || inv.reference) : inv;
        if (selectedId) {
          payInvoiceSelect.value = selectedId;
          const found = invoices.find(i => (i.id || i.reference) === selectedId);
          if (found) payAmountInput.value = ((found.amount || 0) - (found.paid || 0)) || found.amount;
        }
        paymentModal.classList.add('active'); paymentModal.setAttribute('aria-hidden','false');
      }

      function closePayment() {
        paymentModal.classList.remove('active'); paymentModal.setAttribute('aria-hidden','true');
        paymentForm.reset(); receiptPreview.textContent = 'No payment yet';
      }

      // Populate invoice select for payment modal
      function populatePayInvoiceSelect() {
        payInvoiceSelect.innerHTML = '';
        invoices.forEach(inv=>{
          const opt = document.createElement('option');
          opt.value = inv.id || inv.reference || '';
          const rem = (inv.amount || 0) - (inv.paid || 0);
          opt.textContent = `${inv.id || inv.reference || '‚Äî'} ‚Äî ${inv.desc || inv.description || ''} (${formatCurrency(rem)})`;
          payInvoiceSelect.appendChild(opt);
        });
      }

      // Simulate payment submission (replace with real POST to /payments when integrating)
      paymentForm.addEventListener('submit', async (e)=>{
        e.preventDefault();
        const invId = payInvoiceSelect.value;
        const amount = Number(payAmountInput.value);
        if (!invId || !amount || amount <= 0) {
          document.getElementById('paymentMessage').textContent = 'Please select invoice and enter a valid amount';
          return;
        }
        const inv = invoices.find(i=> (i.id || i.reference) === invId);
        if (!inv) { document.getElementById('paymentMessage').textContent = 'Invoice not found'; return; }

        confirmPayBtn.disabled = true; confirmPayBtn.textContent = 'Processing...';

        // Try to POST to backend payments endpoint; fallback to local simulation on failure
        if (TOKEN) {
          try {
            const res = await fetch(`${API_BASE}/payments`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + TOKEN },
              body: JSON.stringify({ invoiceId: invId, amount })
            });
            if (res.ok) {
              const data = await res.json();
              // After successful server payment, re-fetch invoices or update locally from response
              if (data && data.success) {
                // optimistic: mark invoice as updated if returned
                if (data.invoice) {
                  // update local invoice with returned invoice
                  const idx = invoices.findIndex(i => (i.id || i.reference) === (data.invoice.id || data.invoice.reference));
                  if (idx >= 0) invoices[idx] = data.invoice;
                } else {
                  // re-fetch invoices to ensure consistency
                  await initFetchAndRender(false);
                }
                document.getElementById('paymentMessage').textContent = 'Payment successful';
                computeSummary(); renderInvoices(); populatePayInvoiceSelect();
                confirmPayBtn.disabled = false; confirmPayBtn.textContent = 'Confirm payment';
                receiptPreview.innerHTML = `<div style="font-weight:800">Receipt</div><div class="muted-small">Invoice: ${sanitizeText(inv.id||inv.reference)}</div><div style="margin-top:6px;font-weight:900">${formatCurrency(amount)}</div>`;
                return;
              } else {
                const err = (await res.json().catch(()=>({message:'Payment failed'}))).message || 'Payment failed';
                document.getElementById('paymentMessage').textContent = err;
                confirmPayBtn.disabled = false; confirmPayBtn.textContent = 'Confirm payment';
                return;
              }
            } else {
              // server error - fallback to simulation
              console.warn('Payment endpoint returned', res.status);
            }
          } catch (err) {
            console.warn('Payment request failed - falling back to client simulation', err);
          }
        }

        // Client-side simulation if backend not available
        setTimeout(()=>{
          inv.paid = Math.min(inv.amount || 0, (inv.paid || 0) + amount);
          inv.trace = 'TRC-' + Math.random().toString(36).slice(2,10).toUpperCase();
          computeSummary(); renderInvoices(); populatePayInvoiceSelect();
          document.getElementById('paymentMessage').textContent = 'Payment simulated locally (no server integration).';
          confirmPayBtn.disabled = false; confirmPayBtn.textContent = 'Confirm payment';
          receiptPreview.innerHTML = `<div style="font-weight:800">Receipt</div><div class="muted-small">Invoice: ${sanitizeText(inv.id||inv.reference)}</div><div style="margin-top:6px;font-weight:900">${formatCurrency(amount)}</div>`;
        }, 800);
      });

      // modal close handlers
      document.getElementById('closeInvoiceBtn').addEventListener('click', ()=>{
        invoiceModal.classList.remove('active'); invoiceModal.setAttribute('aria-hidden','true');
      });
      document.getElementById('cancelPaymentBtn').addEventListener('click', closePayment);
      document.getElementById('modalPayNowBtn').addEventListener('click', ()=>{
        const ref = document.getElementById('modalRef').textContent;
        invoiceModal.classList.remove('active'); invoiceModal.setAttribute('aria-hidden','true');
        openPayment(ref);
      });

      // Filters & search
      [invoiceSearch, statusFilter, yearFilter].forEach(el=>el.addEventListener('input', renderInvoices));
      toggleViewBtn.addEventListener('click', (e)=>{
        const pressed = e.currentTarget.getAttribute('aria-pressed') === 'true';
        e.currentTarget.setAttribute('aria-pressed', String(!pressed));
        if (!pressed) {
          document.querySelector('.invoice-table-wrap').style.display = 'none';
          document.querySelector('.invoice-cards').style.display = 'flex';
        } else {
          document.querySelector('.invoice-table-wrap').style.display = '';
          document.querySelector('.invoice-cards').style.display = 'none';
        }
      });

      // Export CSV
      exportCsvBtn.addEventListener('click', ()=>{
        const rows = [['Ref','Description','Due','Amount','Paid','Status','Trace']];
        invoices.forEach(i=>rows.push([i.id || i.reference || '', i.desc || i.description || '', i.due || i.dueDate || '', i.amount || 0, i.paid || 0, statusFor(i), i.trace || '']));
        const csv = rows.map(r=>r.map(c=>`"${String(c).replace(/"/g,'""')}"`).join(',')).join('\\n');
        const blob = new Blob([csv], {type: 'text/csv'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a'); a.href = url; a.download = 'invoices.csv'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
      });

      // Print
      printBtn.addEventListener('click', ()=>window.print());

      // Quick link stubs
      window.openPaymentHistory = function(){ alert('Open payment history (implement route)'); }
      window.openInvoiceUpload = function(){ alert('Upload proof flow (implement)'); }
      window.openSupport = function(){ alert('Contact support (implement)'); }

      // Utility sanitizers
      function sanitizeText(s){ return String(s == null ? '' : s); }

      // Fetch + render orchestration:
      // 1) show loading UI
      // 2) fetch invoices for user from backend
      // 3) inject full CSS (so layout looks correct)
      // 4) render invoices and hide loading UI
      async function initFetchAndRender(showLoading = true) {
        if (showLoading) {
          loadingArea.style.display = ''; // keep loading visible
          content.classList.remove('ready');
        }
        loadingMsg.textContent = 'Contacting server to fetch your invoices...';

        const data = await fetchInvoicesForCurrentUser();
        if (Array.isArray(data)) {
          invoices = data.map(inv => normalizeInvoice(inv));
          loadingMsg.textContent = 'Invoices loaded.';
        } else {
          // no data returned by server - fall back to empty list (no mock)
          invoices = [];
          loadingMsg.textContent = 'No invoices found (server returned none).';
        }

        // Inject full CSS after fetch completes (avoids flash of unstyled content)
        try { injectFullCss(); } catch (err) { console.warn('injectFullCss failed', err); }

        // Update UI
        computeSummary();
        renderInvoices();
        populatePayInvoiceSelect();

        // hide loading area after a brief delay to allow styles to settle
        setTimeout(()=> {
          loadingArea.style.display = 'none';
        }, 220);
      }

      // Normalize potential invoice shapes to a minimal expected shape
      function normalizeInvoice(raw) {
        return {
          id: raw.id || raw.reference || raw.ref || raw.invoiceId || raw.invoice_number || '',
          desc: raw.description || raw.desc || raw.title || '',
          due: raw.due || raw.dueDate || raw.due_date || raw.due_at || '',
          amount: Number(raw.amount || raw.total || raw.value || 0),
          paid: Number(raw.paid || raw.amount_paid || raw.paid_amount || 0),
          items: raw.items || raw.line_items || raw.lines || [],
          trace: raw.trace || raw.traceId || raw.referenceId || ''
        };
      }

      // Ensure sidebar state sensible on resize
      function syncSidebarOnResize(){
        if(window.innerWidth <= 980){
          sidebar.classList.remove('open'); // hide by default on mobile
          overlay.classList.remove('visible');
        } else {
          sidebar.classList.remove('open'); // desktop shows sidebar by CSS (no transform)
          overlay.classList.remove('visible');
          document.body.classList.remove('no-scroll');
        }
      }
      window.addEventListener('resize', syncSidebarOnResize);
      syncSidebarOnResize();

      // Init on page load
      (async function init(){
        // prefill profile info from eg_application
        try {
          const app = JSON.parse(localStorage.getItem('eg_application') || 'null') || null;
          if (app) {
            studentNameEl.textContent = (app.firstName || app.name || app.username) + (app.lastName ? (' ' + app.lastName) : '');
            studentClassEl.textContent = app.program || app.class || app.level || studentClassEl.textContent;
            if (app.profilePic) topbarAvatar.src = app.profilePic;
            if (app.session) sessionChip.textContent = 'Session: ' + app.session;
          }
        } catch (e) { /* ignore */ }

        // Start fetch-and-render flow
        await initFetchAndRender(true);

        // Accessibility: close modals with Escape
        document.addEventListener('keydown', (e)=>{
          if (e.key === 'Escape') {
            document.querySelectorAll('.modal.active').forEach(m=>m.classList.remove('active'));
            closePayment();
            invoiceModal.classList.remove('active'); invoiceModal.setAttribute('aria-hidden','true');
          }
        });
      })();

    })();
  </script>
</body>
</html>
