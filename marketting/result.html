<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Results ‚Ä¢ ExamGuard ‚Äî Student</title>
  <meta name="viewport" content="width=device-width,initial-scale=0.901" />
  <link href="https://fonts.googleapis.com/css?family=Inter:400,600,700&display=swap" rel="stylesheet">
  <link rel="icon" href="../logo.png">
  <style>
    :root{
      --bg-0:#f6f8ff; --bg-1:#eef2ff;
      --accent:#3b82f6; --accent-2:#6366f1; --muted:#6b7280;
      --card-bg:#ffffff; --radius:12px;
      --sidebar-w:280px;
      --topbar-h:64px;
      --max-modal-w: 720px;
      --content-max-w: 980px; /* reduced overall container width as requested */
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;font-family:Inter,system-ui,Arial;background:linear-gradient(180deg,var(--bg-0),var(--bg-1));-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;color:#0b2a44}
    a{color:inherit;text-decoration:none}
    img{max-width:100%;height:auto;display:block}

    /* Layout */
    .app{display:flex;min-height:100vh;align-items:stretch}
    .overlay{position:fixed;inset:0;background:rgba(2,6,23,0.45);z-index:95;display:none}
    .overlay.visible{display:block}

    /* Sidebar: fixed on left for desktop, overlayed on mobile */
    .sidebar{
      width:var(--sidebar-w);min-width:var(--sidebar-w);
      background:linear-gradient(180deg,#0f172a 0%, #1e3a8a 100%);color:#fff;padding:20px 16px;position:fixed;left:0;top:0;bottom:0;z-index:100;
      box-shadow:4px 0 28px rgba(15,23,42,0.12);display:flex;flex-direction:column;gap:14px;overflow-y:auto;transition:none;
    }
    @media (max-width:720px){
      .sidebar{transform:translateX(-110%);transition:transform .28s ease;position:fixed;width:86vw;min-width:86vw}
      .sidebar.hidden{transform:translateX(-110%)}
      .sidebar.open{transform:translateX(0);box-shadow:0 24px 48px rgba(2,6,23,0.5)}
    }
    .brand{display:flex;gap:12px;align-items:center}
    .brand img{width:44px;height:44px;border-radius:10px;object-fit:cover;border:2px solid rgba(255,224,102,0.12);background:#fff}
    .brand .title{font-weight:800;color:#ffe066}
    .nav{display:flex;flex-direction:column;gap:8px;margin-top:6px}
    .nav a{display:flex;align-items:center;gap:10px;padding:10px 12px;border-radius:9px;font-weight:700;background:transparent;color:#e6eefc}
    .nav a.active,.nav a:hover{background:rgba(255,255,255,0.04);color:#ffe066;transform:translateX(4px)}
    .profile{display:flex;gap:12px;align-items:center;padding-top:10px;border-top:1px solid rgba(255,255,255,0.04)}
    .profile img{width:44px;height:44px;border-radius:10px;object-fit:cover;border:2px solid #ffe066}

    /* Topbar: full width and centered content container */
/* Replace all .topbar rules with these, and ensure nothing inside <main> is sticky anymore */
.topbar {
  position: fixed;
  left: var(--sidebar-w);
  top: 0;
  width: calc(100vw - var(--sidebar-w));
  z-index: 90; /* higher than sidebar/content */
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 12px;
  margin-bottom: 20px;
  padding: 12px 14px;
  backdrop-filter: blur(6px);
  background: rgba(255, 255, 255, 0.86);
  border-bottom: 1px solid rgba(11, 42, 60, 0.06);
  box-shadow: 0 6px 18px rgba(11, 42, 60, 0.04);
  min-height: 64px;
}

/* On mobile (sidebar overlays, not aside, so bar starts at left 0) */
@media (max-width: 720px) {
  .topbar {
    left: 0;
    width: 100vw;
    padding: 10px 12px;
    min-height: 56px;
  }
}

    .hamburger{display:none;background:var(--accent);color:#fff;border:none;padding:9px 12px;border-radius:10px;cursor:pointer;font-weight:800}
    .page-title{font-weight:800;font-size:1.14rem;color:var(--accent-2)}
    .topbar .actions{display:flex;gap:10px;align-items:center}

    /* Main: centered container, no forced left margin globally */
    .main{padding:24px;flex:1;padding-top:calc(var(--topbar-h) + 30px);min-height:100vh;display:flex;justify-content:center}
    .container{max-width:var(--content-max-w);width:100%;margin:0 auto;overflow:hidden}

    /* Grid & cards */
    .grid{display:grid;grid-template-columns:repeat(12,1fr);gap:16px;align-items:start}
    .card{background:var(--card-bg);border-radius:var(--radius);padding:14px;border:1px solid rgba(11,42,60,0.04);box-shadow:0 10px 30px rgba(11,42,60,0.03)}
    .col-3{grid-column:span 3}.col-4{grid-column:span 4}.col-6{grid-column:span 6}.col-9{grid-column:span 9}.col-12{grid-column:1 / -1}

    /* Filters area */
    .filters{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
    .field{display:flex;flex-direction:column;gap:6px}
    .field label{font-size:0.85rem;font-weight:700;color:var(--muted)}
    .field input,.field select{padding:10px 12px;border-radius:8px;border:1px solid #e6e9ef;font-size:0.95rem;min-width:160px}
    .btn{padding:10px 12px;border-radius:10px;border:0;cursor:pointer;background:linear-gradient(90deg,var(--accent),var(--accent-2));color:#fff;font-weight:700}
    .btn.ghost{background:transparent;color:var(--accent-2);border:1px solid rgba(59,130,246,0.08)}
    .btn.small{padding:8px 10px;font-size:0.95rem}
    .muted{color:var(--muted)}
    .link-primary { color: var(--accent-2); font-weight:800; text-decoration:underline; }

    /* KPI */
    .kpis{display:flex;gap:12px;align-items:stretch}
    .kpi{flex:1;padding:12px;border-radius:10px;background:linear-gradient(180deg,#fff,#fbfdff);display:flex;flex-direction:column;gap:8px;align-items:flex-start}
    .kpi .num{font-size:1.5rem;font-weight:900;color:var(--accent-2)}
    .kpi .label{font-size:0.9rem;color:var(--muted);font-weight:700}

    /* Results table - card style rows (neat on mobile) */
    .results-table{width:100%;border-collapse:collapse;margin-top:12px}
    .results-table thead{display:none}
    .results-table tbody{display:flex;flex-direction:column;gap:10px}
    .results-table tbody tr{
      display:grid;
      grid-template-columns: 2fr 1fr 1fr 1fr;
      gap:12px;
      padding:12px;
      background:#fbfdff;
      border:1px solid #eef3ff;
      border-radius:10px;
      align-items:center;
    }
    .results-table tbody tr td{
      padding:0;
      border:0;
      display:flex;
      align-items:center;
      flex-direction:column;
      gap:4px;
      text-align:center;
    }
    .results-table tbody tr td::before{
      content: attr(data-label);
      display:block;
      font-size:0.75rem;
      font-weight:700;
      color:var(--muted);
      text-transform:uppercase;
      letter-spacing:0.5px;
    }
    .results-table tbody tr td.subject-name span{
      font-weight:900;
      font-size:1rem;
      color:#0b2a44;
    }
    .results-count { font-size:0.9rem; color:var(--muted); margin-top:6px; }

    .grade-pill{display:inline-block;padding:6px 10px;border-radius:999px;font-weight:800;color:#fff;font-size:0.85rem}
    .grade-A{background:linear-gradient(90deg,#10b981,#059669)} .grade-B{background:linear-gradient(90deg,#f59e0b,#f97316)} .grade-C{background:linear-gradient(90deg,#f97316,#ef4444)} .grade-D{background:#9ca3af}

    /* Subject cards */
    .subject-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:12px;margin-top:12px}
    .subject{padding:12px;border-radius:10px;background:#fff;border:1px solid #eef3ff;display:flex;flex-direction:column;gap:6px;cursor:pointer}
    .subject .sub-title{font-weight:800;color:#0b2a44}
    .subject .meta{color:var(--muted);font-size:0.9rem}
    .subject:focus{outline:3px solid rgba(99,102,241,0.12);outline-offset:3px}

    /* Modal */
    .modal { position: fixed; inset: 0; display: none; align-items: center; justify-content: center; z-index: 9999; padding: 20px; background: rgba(2,6,23,0.45); -webkit-overflow-scrolling: touch; }
    .modal.active { display: flex; }
    .modal-dialog { width: 100%; max-width: var(--max-modal-w); max-height: 86vh; background: #fff; border-radius: 14px; overflow: hidden; display: flex; flex-direction: column; box-shadow: 0 30px 80px rgba(2,6,23,0.2); }
    .modal-header { display:flex;justify-content:space-between;align-items:center;padding:14px 16px;background:#fbfdff;border-bottom:1px solid #eef3ff; }
    .modal-title { font-weight:800; font-size:1.05rem; color:var(--accent-2); }
    .modal-close { background:none;border:0;font-weight:800;font-size:1rem;padding:8px 10px;border-radius:8px;cursor:pointer;color:#64748b }
    .modal-body { padding:14px 16px; overflow:auto; }
    .modal-footer { padding:12px 16px; border-top:1px solid #eef3ff; display:flex;justify-content:flex-end; gap:8px; background:#fff; }

    .detail-grid { display:grid; grid-template-columns: 1fr 1fr; gap:12px; }
    .detail-row { background:#fbfdff; padding:10px; border-radius:8px; border:1px solid #eef3ff; }
    .detail-label { font-weight:700; color:var(--muted); font-size:0.86rem; margin-bottom:6px; }
    .detail-value { font-weight:900; color:#0b2a44; font-size:1rem; }

    /* Responsive behavior: sidebar overlay on small screens, visible on large screens */
    @media (max-width:980px){
      .grid{grid-template-columns:repeat(6,1fr)}
      .col-3{grid-column:span 6}
      .col-4{grid-column:span 6}
      .col-6{grid-column:span 6}
      .col-9{grid-column:span 6}
      .hamburger{display:inline-flex}
      .topbar{padding-left:12px;padding-right:12px}
      /* Sidebar hidden by default on mobile (use .open to show) */
      .sidebar{transform:translateX(-110%)}
      .sidebar.open{transform:translateX(0);box-shadow:0 20px 60px rgba(2,6,23,0.5)}
      .overlay{display:none}
      .overlay.visible{display:block}
      .main{padding-top:calc(var(--topbar-h) + 18px)}
    }

    /* Desktop adjustments: keep sidebar fixed but offset main container so sidebar doesn't overlap */
    @media (min-width:981px){
      .sidebar{transform:none}
      /* add left margin to the centered container so it doesn't get overlapped by the fixed sidebar */
      .container { margin-left: calc(var(--sidebar-w) + 16px); } /* add small gap between sidebar and centered container */
      /* push topbar down slightly so it doesn't sit flush to the page top */
      .topbar { margin-left: calc(var(--sidebar-w)); }
      /* keep main top padding consistent with topbar position */
      .main { padding-top: calc(var(--topbar-h) + 38px); }
    }

    @media (max-width:720px){
      :root{--topbar-h:56px}
      .subject-grid{grid-template-columns:repeat(2,1fr)}
      .kpis{flex-direction:column}
      .field input,.field select{min-width:120px}
      .results-table tbody tr{grid-template-columns:1fr}
      .results-table tbody tr td{flex-direction:row;justify-content:space-between;text-align:left}
      .results-table tbody tr td::before{display:block;margin-right:8px}
      .grade-pill{font-size:0.85rem;padding:6px 8px}
      .modal-dialog { max-width: 96vw; max-height: 92vh; border-radius: 12px; }
    }

    /* Print tweaks */
    @media print{
      .sidebar, .topbar, .hamburger, .overlay, .btn, .modal { display: none !important; }
      .main{margin-left:0;padding-top:0}
      .card{box-shadow:none;border:0}
    }

    .table-action-btn { padding:6px 8px; border-radius:8px; font-weight:700; font-size:0.9rem; }
    .table-action-btn.ghost { background:transparent; border:1px solid #eef3ff; color:var(--accent-2); }

    /* small helper for focus outlines */
    :focus { outline: 3px solid rgba(99,102,241,0.12); outline-offset: 3px; }
  </style>
</head>
<body>
  <div class="app" id="app">
    <div class="overlay" id="overlay" aria-hidden="true"></div>

    <!-- Sidebar -->
    <aside class="sidebar" id="sidebar" aria-label="Main navigation">
      <div class="brand" aria-hidden="false">
        <img src="../logo.png" alt="Logo">
        <div>
          <div class="title">ExamGuard</div>
          <div class="muted" style="font-weight:700">Central Result Portal</div>
        </div>
      </div>

      <nav class="nav" aria-label="Primary">
        <a href="student.html">üè† Dashboard</a>
        <a href="#" class="active">üìÑ Results</a>
        <a href="student.html#timetable">‚è∞ Timetable</a>
        <a href="student.html#resources">üìÇ Resources</a>
        <a href="student.html#messages">‚úâÔ∏è Messages</a>
        <a href="student.html#settings">‚öôÔ∏è Settings</a>
      </nav>

      <div style="flex:1"></div>

      <div class="profile" role="region" aria-label="Student profile">
        <img src="../avatar.jpg" alt="Student avatar">
        <div>
          <div class="name" id="sidebarName">Adaobi Chukwu</div>
          <div class="muted" id="sidebarClass">SS2 ‚Äî Biology</div>
        </div>
      </div>
    </aside>

    <!-- Topbar -->
    <div class="topbar" id="topbar">
      <div class="topbar-inner">
        <div style="display:flex;gap:12px;align-items:center">
          <button class="hamburger" id="hamburger" aria-label="Toggle menu">‚ò∞</button>
          <div>
            <div class="page-title" id="pageTitle">Central Result Portal</div>
            <div class="muted" style="font-size:0.92rem">Accessing Academic Performance</div>
          </div>
        </div>

        <div class="actions">
          <div style="display:flex;gap:8px;align-items:center">
            <img src="../avatar.jpg" alt="You" style="width:44px;height:44px;border-radius:8px;object-fit:cover;border:2px solid #fff">
          </div>
        </div>
      </div>
    </div>

    <!-- Main -->
    <main class="main" id="main" role="main" tabindex="-1">
      <div class="container">
        <!-- Filters card -->
        <div class="card col-12" style="display:flex;flex-direction:column;gap:12px;margin-bottom:14px">
          <div style="display:flex;justify-content:space-between;align-items:center;gap:12px;">
            <div style="font-weight:800">Search / Lookup Results</div>
            <div class="muted">Find students by registration, session, term and class</div>
          </div>

          <div class="filters" role="search" aria-label="Search results">
            <div class="field" style="min-width:220px">
              <label for="regNo">Registration No</label>
              <input id="regNo" placeholder="e.g. EXM/2025/001" />
            </div>

            <div class="field">
              <label for="session">Session</label>
              <select id="session">
                <option value="2024/2025">2024/2025</option>
                <option value="2023/2024">2023/2024</option>
                <option value="2022/2023">2022/2023</option>
              </select>
            </div>

            <div class="field">
              <label for="term">Term</label>
              <select id="term">
                <option>First</option>
                <option>Second</option>
                <option>Third</option>
              </select>
            </div>

            <div class="field">
              <label for="classSel">Class</label>
              <select id="classSel">
                <option>SS2</option>
                <option>SS1</option>
                <option>SS3</option>
              </select>
            </div>

            <div style="display:flex;gap:8px;align-items:end;margin-left:auto">
              <button class="btn small" id="searchBtn">Search</button>
              <button class="btn ghost small" id="clearBtn">Clear</button>
            </div>
          </div>
        </div>

        <!-- Results header + KPIs -->
        <div class="grid" style="margin-bottom:12px;align-items:start">
          <div class="card col-9">
            <div style="display:flex;justify-content:space-between;align-items:center;gap:12px;">
              <div>
                <div style="font-weight:900;font-size:1.04rem" id="resultStudentName">--</div>
                <div class="muted" id="resultStudentMeta">Registration ‚Ä¢ Class ‚Ä¢ Session</div>
              </div>
              <div style="text-align:right">
                <div class="muted">Result status</div>
                <div style="font-weight:900;color:var(--accent-2);font-size:1.2rem" id="resultStatus">‚Äî</div>
              </div>
            </div>

            <div style="margin-top:12px" class="kpis">
              <div class="kpi">
                <div class="label">Cumulative Average</div>
                <div class="num" id="kpiAvg">--%</div>
                <div class="muted">Position in class: <strong id="kpiRank">--</strong></div>
              </div>
              <div class="kpi">
                <div class="label">Total Subjects</div>
                <div class="num" id="kpiSubjects">--</div>
                <div class="muted">Passed: <strong id="kpiPassed">--</strong></div>
              </div>
              <div class="kpi">
                <div class="label">Attendance</div>
                <div class="num" id="kpiAtt">--%</div>
                <div class="muted">Days attended: <strong id="kpiDays">--</strong></div>
              </div>
            </div>
          </div>

          <!-- EXPORT card -->
          <div class="card col-3">
            <div style="display:flex;flex-direction:column;gap:10px">
              <div style="font-weight:800">Export / Print</div>
              <div class="muted" style="font-size:0.95rem">Create a printable report or export CSV</div>
              <div style="display:flex;gap:8px;flex-direction:column;margin-top:8px">
                <button class="btn" id="printBtn">Print Report</button>
                <button class="btn ghost" id="exportBtn">Export CSV</button>
                <button class="btn ghost" id="downloadPdfBtn">Download PDF</button>
              </div>
            </div>
          </div>
        </div>

        <!-- Score breakdown and quick snapshot -->
        <div class="grid">
          <div class="card col-9" id="subjectBreakdownCard">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px">
              <div style="font-weight:800">Subject Breakdown</div>
              <div class="muted">Click a row to view subject details</div>
            </div>

            <!-- Small helper: show preview count and link to full report -->
            <div style="display:flex;justify-content:space-between;align-items:center;gap:12px;">
              <div id="subjectsNote" class="muted subjects-count">Showing 0 of 0 subjects</div>
              <div>
                <a id="viewFullReportLink" class="link-primary" href="report.html" target="_blank" rel="noopener">View full report</a>
              </div>
            </div>

            <!-- Clean card-style rows (preview only) -->
            <table class="results-table" id="resultsTable" aria-live="polite">
              <thead>
                <tr>
                  <th>Subject</th>
                  <th>CA</th>
                  <th>Exam</th>
                  <th>Total</th>
                </tr>
              </thead>
              <tbody>
                <!-- rows populated by JS (preview only) -->
              </tbody>
            </table>

            <div style="display:flex;justify-content:space-between;align-items:center;margin-top:16px;gap:12px;flex-wrap:wrap">
              <div class="note" style="flex:1;min-width:200px">
                <div style="font-weight:800">Teacher comment</div>
                <div id="teacherComment" class="muted" style="margin-top:6px">‚Äî</div>
              </div>

              <div style="display:flex;flex-direction:column;gap:6px;align-items:flex-end;min-width:180px">
                <div class="muted">Overall Grade</div>
                <div style="font-weight:900;font-size:1.6rem;color:var(--accent-2)" id="overallGrade">‚Äî</div>
                <div class="muted">CGPA: <strong id="overallGPA">--</strong></div>
              </div>
            </div>
          </div>

          <!-- Quick snapshot card -->
          <div class="card col-3">
            <div style="font-weight:800">Quick Snapshot</div>

            <div style="margin-top:10px;display:flex;flex-direction:column;gap:8px">
              <div style="display:flex;justify-content:space-between"><div class="muted">Highest score</div><div id="snapHigh">--</div></div>
              <div style="display:flex;justify-content:space-between"><div class="muted">Lowest score</div><div id="snapLow">--</div></div>
              <div style="display:flex;justify-content:space-between"><div class="muted">No. of A's</div><div id="snapA">--</div></div>
              <div style="display:flex;justify-content:space-between"><div class="muted">No. of F's</div><div id="snapF">--</div></div>
              <div style="margin-top:8px"><button class="btn small" onclick="scrollToTable()">View full</button></div>
            </div>

            <div style="margin-top:12px">
              <div style="font-weight:800">Previous Semesters</div>
              <div style="display:flex;flex-direction:column;gap:8px;margin-top:8px">
                <button class="btn ghost small">Second Semester</button>
                <button class="btn ghost small">First Semester 2025</button>
                <button class="btn ghost small">Third Term 2024</button>
              </div>
            </div>
          </div>
        </div>

        <!-- Subjects cards (preview only) -->
        <div class="card col-12" style="margin-top:14px">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div style="font-weight:800">Subjects / Quick details (preview)</div>
            <div class="muted">Tap a subject to view details</div>
          </div>

          <div class="subject-grid" id="subjectGrid" style="margin-top:12px">
            <!-- populated via JS (preview only) -->
          </div>

          <div style="margin-top:12px; display:flex; justify-content:center;">
            <a href="report.html" class="btn ghost" style="text-decoration:none" target="_blank" rel="noopener">Open Full Report</a>
          </div>
        </div>

        <div style="height:18px"></div>
      </div>
    </main>
  </div>

  <!-- Detail Modal (unchanged) -->
  <div id="detailModal" class="modal" role="dialog" aria-modal="true" aria-hidden="true" aria-labelledby="modalTitle">
    <div class="modal-dialog" role="document">
      <div class="modal-header">
        <div class="modal-title" id="modalTitle">Subject detail</div>
        <button class="modal-close" id="modalCloseBtn" aria-label="Close detail dialog">&times;</button>
      </div>

      <div class="modal-body" id="modalBody">
        <div style="display:flex;justify-content:space-between;align-items:center;gap:12px;margin-bottom:12px">
          <div>
            <div class="muted" style="font-weight:700">Student</div>
            <div id="modalStudent" style="font-weight:900"></div>
            <div id="modalMeta" class="muted" style="font-size:0.92rem"></div>
          </div>

          <div style="text-align:right">
            <div class="muted" style="font-weight:700">Subject Score</div>
            <div id="modalScore" style="font-weight:900;font-size:1.4rem;color:var(--accent-2)"></div>
            <div id="modalGrade" style="margin-top:6px"></div>
          </div>
        </div>

        <div class="detail-grid" id="modalDetailsGrid"></div>

        <div style="margin-top:12px">
          <div style="font-weight:800">Teacher remarks</div>
          <div id="modalRemark" class="muted" style="margin-top:6px">‚Äî</div>
        </div>
      </div>

      <div class="modal-footer">
        <button class="btn ghost" id="modalClose">Close</button>
        <button class="btn" id="modalPrint">Print subject</button>
      </div>
    </div>
  </div>

  <script>
    (function () {
      const API_BASE = 'https://examguide.onrender.com/api';
      const TOKEN = localStorage.getItem('eg_token') || null;

      // UI elements
      const sidebar = document.getElementById('sidebar');
      const hamburger = document.getElementById('hamburger');
      const overlay = document.getElementById('overlay');

      const regNoEl = document.getElementById('regNo');
      const sessionEl = document.getElementById('session');
      const termEl = document.getElementById('term');
      const classEl = document.getElementById('classSel');
      const searchBtn = document.getElementById('searchBtn');
      const clearBtn = document.getElementById('clearBtn');

      const resultStudentName = document.getElementById('resultStudentName');
      const resultStudentMeta = document.getElementById('resultStudentMeta');
      const resultStatus = document.getElementById('resultStatus');
      const kpiAvg = document.getElementById('kpiAvg');
      const kpiRank = document.getElementById('kpiRank');
      const kpiSubjects = document.getElementById('kpiSubjects');
      const kpiPassed = document.getElementById('kpiPassed');
      const kpiAtt = document.getElementById('kpiAtt');
      const kpiDays = document.getElementById('kpiDays');

      const resultsTableBody = document.querySelector('#resultsTable tbody');
      const overallGradeEl = document.getElementById('overallGrade');
      const overallGPAEl = document.getElementById('overallGPA');
      const teacherComment = document.getElementById('teacherComment');
      const snapHigh = document.getElementById('snapHigh');
      const snapLow = document.getElementById('snapLow');
      const snapA = document.getElementById('snapA');
      const snapF = document.getElementById('snapF');
      const subjectGrid = document.getElementById('subjectGrid');

      const subjectsNote = document.getElementById('subjectsNote');
      const viewFullReportLink = document.getElementById('viewFullReportLink');

      // Modal elements
      const detailModal = document.getElementById('detailModal');
      const modalTitle = document.getElementById('modalTitle');
      const modalStudent = document.getElementById('modalStudent');
      const modalMeta = document.getElementById('modalMeta');
      const modalScore = document.getElementById('modalScore');
      const modalGrade = document.getElementById('modalGrade');
      const modalDetailsGrid = document.getElementById('modalDetailsGrid');
      const modalRemark = document.getElementById('modalRemark');
      const modalCloseBtn = document.getElementById('modalCloseBtn');
      const modalClose = document.getElementById('modalClose');
      const modalPrint = document.getElementById('modalPrint');

      // state
      let currentResult = null;
      const PREVIEW_SUBJECT_COUNT = 4;

      // small sanitizers for text content (prevents naive injection)
      function sanitizeText(s) { return String(s == null ? '' : s); }
      function sanitizeHtmlSafe(s) { return sanitizeText(s).replace(/</g, '&lt;').replace(/>/g, '&gt;'); }
      function sanitizeAttr(s) { return String(s == null ? '' : s).replace(/["']/g, ''); }

      // Sidebar toggle behavior
      hamburger.addEventListener('click', () => {
        const isOpen = sidebar.classList.toggle('open');
        if (isOpen) {
          overlay.classList.add('visible');
          overlay.setAttribute('aria-hidden','false');
          document.body.classList.add('no-scroll');
        } else {
          overlay.classList.remove('visible');
          overlay.setAttribute('aria-hidden','true');
          document.body.classList.remove('no-scroll');
        }
      });
      overlay.addEventListener('click', () => {
        if (sidebar.classList.contains('open')) sidebar.classList.remove('open');
        overlay.classList.remove('visible');
        overlay.setAttribute('aria-hidden','true');
        document.body.classList.remove('no-scroll');
      });

      // grade class helper
      function gradeClass(grade){
        if(grade==='A') return 'grade-A';
        if(grade==='B') return 'grade-B';
        if(grade==='C') return 'grade-C';
        return 'grade-D';
      }

      // modal control
      let lastFocusedElement = null;
      function openModalFor(subject){
        lastFocusedElement = document.activeElement;
        modalTitle.textContent = `${sanitizeText(subject.name)} ‚Äî Breakdown`;
        modalStudent.textContent = sanitizeText(currentResult?.name || '');
        modalMeta.textContent = `${sanitizeText(currentResult?.regNo || '')} ‚Ä¢ ${sanitizeText(currentResult?.class || '')} ‚Ä¢ ${sanitizeText(currentResult?.session || '')} ‚Äî ${sanitizeText(currentResult?.term || '')} term`;
        modalScore.textContent = (subject.total !== undefined ? subject.total : '--') + '%';
        modalGrade.innerHTML = subject.grade ? `<span class="grade-pill ${gradeClass(subject.grade)}">${sanitizeText(subject.grade)}</span>` : '';
        modalRemark.textContent = subject.teacherNote || subject.remark || '‚Äî';

        modalDetailsGrid.innerHTML = '';
        const details = [
          { label: 'CA score', value: subject.ca ?? '--' },
          { label: 'Exam score', value: subject.exam ?? '--' },
          { label: 'Total', value: subject.total ?? '--' },
          { label: 'Grade', value: subject.grade ?? '--' },
          { label: 'Remark', value: subject.remark ?? '--' }
        ];
        details.forEach(d => {
          const el = document.createElement('div');
          el.className = 'detail-row';
          el.innerHTML = `<div class="detail-label">${sanitizeText(d.label)}</div><div class="detail-value">${sanitizeText(d.value)}</div>`;
          modalDetailsGrid.appendChild(el);
        });

        detailModal.classList.add('active');
        detailModal.setAttribute('aria-hidden','false');
        document.body.classList.add('no-scroll');
        modalCloseBtn.focus();
      }
      function closeModal(){
        detailModal.classList.remove('active');
        detailModal.setAttribute('aria-hidden','true');
        document.body.classList.remove('no-scroll');
        if(lastFocusedElement) lastFocusedElement.focus();
      }
      modalCloseBtn.addEventListener('click', closeModal);
      modalClose.addEventListener('click', closeModal);
      modalPrint.addEventListener('click', ()=> {
        const content = document.querySelector('.modal-body').innerHTML;
        const w = window.open('', '_blank', 'width=800,height=900');
        w.document.write('<title>Print subject</title>');
        w.document.write('<style>body{font-family:Inter,system-ui,Arial;padding:20px;color:#0b2a44} .grade-pill{padding:6px 10px;border-radius:999px;color:#fff}.grade-A{background:#059669}.grade-B{background:#f59e0b}.grade-C{background:#f97316}.grade-D{background:#9ca3af}</style>');
        w.document.write(content);
        w.document.close();
        w.focus();
        setTimeout(()=> { w.print(); w.close(); }, 250);
      });

      window.addEventListener('keydown', (e) => {
        if(e.key === 'Escape'){
          if(detailModal.classList.contains('active')) closeModal();
          if(sidebar.classList.contains('open')) {
            sidebar.classList.remove('open');
            overlay.classList.remove('visible');
            document.body.classList.remove('no-scroll');
          }
        }
      });

      // populate UI from result object (defensive)
      function populate(result){
        currentResult = result || null;
        if(!result) {
          // clear UI
          resultStudentName.textContent = '--';
          resultStudentMeta.textContent = 'Registration ‚Ä¢ Class ‚Ä¢ Session';
          resultStatus.textContent = '‚Äî';
          kpiAvg.textContent = '--%'; kpiRank.textContent = '--'; kpiSubjects.textContent = '--';
          kpiPassed.textContent = '--'; kpiAtt.textContent = '--%'; kpiDays.textContent = '--';
          resultsTableBody.innerHTML = '';
          overallGradeEl.textContent = '‚Äî'; overallGPAEl.textContent = '--';
          teacherComment.textContent = '‚Äî'; snapHigh.textContent = '--'; snapLow.textContent = '--'; snapA.textContent = '--'; snapF.textContent = '--';
          subjectGrid.innerHTML = '';
          subjectsNote.textContent = 'Showing 0 of 0 subjects';
          return;
        }

        resultStudentName.textContent = sanitizeText(result.name || result.studentName || '--');
        resultStudentMeta.textContent = `${sanitizeText(result.regNo || result.registration || '')} ‚Ä¢ ${sanitizeText(result.class || result.program || '')} ‚Ä¢ ${sanitizeText(result.session || '')} ‚Äî ${sanitizeText(result.term || '')} term`;
        resultStatus.textContent = sanitizeText(result.status || 'Published');

        kpiAvg.textContent = (result.avgPercent ?? result.avg ?? '--') + '%';
        kpiRank.textContent = result.rank ?? '--';
        const subjects = Array.isArray(result.subjects) ? result.subjects : (Array.isArray(result.scores) ? result.scores : []);
        kpiSubjects.textContent = subjects.length;
        kpiPassed.textContent = subjects.filter(s => (s.total ?? s.score ?? 0) >= 50).length;
        kpiAtt.textContent = (result.attendance ?? '--') + '%';
        kpiDays.textContent = result.days ?? '--';

        // Prepare preview slice and counts
        const totalSubjects = subjects.length;
        const preview = subjects.slice(0, PREVIEW_SUBJECT_COUNT);

        subjectsNote.textContent = `Showing ${preview.length} of ${totalSubjects} subjects.`;
        viewFullReportLink.href = 'report.html';

        // Table rows
        resultsTableBody.innerHTML = '';
        let high = -Infinity, low = Infinity, countA=0, countF=0;
        preview.forEach((s) => {
          const totalVal = (s.total ?? s.score ?? '--');
          const tr = document.createElement('tr');

          const tdSubject = document.createElement('td');
          tdSubject.className = 'subject-name';
          tdSubject.setAttribute('data-label','Subject');
          tdSubject.innerHTML = `<span>${sanitizeHtmlSafe(s.name || s.subject || '')}</span>`;

          const tdCA = document.createElement('td');
          tdCA.setAttribute('data-label','CA');
          tdCA.innerHTML = `<span>${sanitizeText(s.ca ?? '--')}</span>`;

          const tdExam = document.createElement('td');
          tdExam.setAttribute('data-label','Exam');
          tdExam.innerHTML = `<span>${sanitizeText(s.exam ?? '--')}</span>`;

          const tdTotal = document.createElement('td');
          tdTotal.setAttribute('data-label','Total');
          tdTotal.innerHTML = `<span>${sanitizeText(totalVal)}</span>`;

          tr.appendChild(tdSubject);
          tr.appendChild(tdCA);
          tr.appendChild(tdExam);
          tr.appendChild(tdTotal);

          tr.addEventListener('click', () => openModalFor({
            name: s.name || s.subject,
            ca: s.ca,
            exam: s.exam,
            total: totalVal,
            grade: s.grade,
            remark: s.remark,
            teacherNote: s.teacherNote
          }));
          tr.style.cursor = 'pointer';
          resultsTableBody.appendChild(tr);

          const numeric = Number(totalVal);
          if (!isNaN(numeric)) {
            high = Math.max(high, numeric);
            low = Math.min(low, numeric);
            if (s.grade === 'A') countA++;
            if (s.grade === 'F') countF++;
          }
        });

        overallGradeEl.textContent = sanitizeText(result.overallGrade ?? result.grade ?? '‚Äî');
        overallGPAEl.textContent = sanitizeText(result.gpa ?? result.cgpa ?? '--');
        teacherComment.textContent = sanitizeText(result.teacherComment ?? result.comment ?? '‚Äî');
        snapHigh.textContent = high === -Infinity ? '--' : high;
        snapLow.textContent = low === Infinity ? '--' : low;
        snapA.textContent = countA;
        snapF.textContent = countF;

        // Subject cards preview
        subjectGrid.innerHTML = '';
        preview.forEach(s => {
          const div = document.createElement('div');
          div.className = 'subject';
          div.tabIndex = 0;
          div.innerHTML = `
            <div style="display:flex;justify-content:space-between;align-items:center">
              <div class="sub-title">${sanitizeHtmlSafe(s.name || s.subject)}</div>
              <div class="meta">${sanitizeText(s.total ?? s.score ?? '--')}%</div>
            </div>
            <div class="meta">CA: ${sanitizeText(s.ca ?? '--')} ‚Ä¢ Exam: ${sanitizeText(s.exam ?? '--')}</div>
            <div style="display:flex;justify-content:space-between;align-items:center">
              <div><span class="grade-pill ${gradeClass(s.grade ?? '')}">${sanitizeText(s.grade ?? '')}</span></div>
              <div class="muted">${sanitizeText(s.remark ?? '')}</div>
            </div>
            <div style="margin-top:8px; display:flex; gap:8px;">
              <button class="btn ghost small" aria-label="View ${sanitizeAttr(s.name || s.subject)} breakdown">View breakdown</button>
            </div>
          `;
          div.addEventListener('click', () => openModalFor({
            name: s.name || s.subject,
            ca: s.ca,
            exam: s.exam,
            total: s.total ?? s.score,
            grade: s.grade,
            remark: s.remark,
            teacherNote: s.teacherNote
          }));
          const innerBtn = div.querySelector('button');
          innerBtn.addEventListener('click', (ev) => {
            ev.stopPropagation();
            openModalFor({
              name: s.name || s.subject,
              ca: s.ca,
              exam: s.exam,
              total: s.total ?? s.score,
              grade: s.grade,
              remark: s.remark,
              teacherNote: s.teacherNote
            });
          });
          subjectGrid.appendChild(div);
        });
      }

      // Export CSV (exports full report subjects)
      function exportCSV(){
        if(!currentResult) return alert('No result loaded to export.');
        const result = currentResult;
        const subjects = Array.isArray(result.subjects) ? result.subjects : (Array.isArray(result.scores) ? result.scores : []);
        const rows = [
          ['RegNo','Name','Class','Session','Term','Subject','CA','Exam','Total','Grade','Remark']
        ];
        subjects.forEach(s => {
          rows.push([result.regNo || result.registration || '', result.name || result.studentName || '', result.class || '', result.session || '', result.term || '', s.name || s.subject || '', s.ca ?? '', s.exam ?? '', s.total ?? s.score ?? '', s.grade ?? '', s.remark ?? '']);
        });
        const csv = rows.map(r => r.map(c => `"${String(c).replace(/"/g,'""')}"`).join(',')).join('\n');
        const blob = new Blob([csv],{type:'text/csv;charset=utf-8;'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `${result.regNo || 'result'}.csv`;
        a.click();
        URL.revokeObjectURL(url);
      }

      // Print (prints the current page)
      function printReport(){
        window.print();
      }

      document.getElementById('exportBtn').addEventListener('click', exportCSV);
      document.getElementById('printBtn').addEventListener('click', printReport);
      document.getElementById('downloadPdfBtn').addEventListener('click', ()=> { printReport(); });

      function scrollToTable(){ document.querySelector('#resultsTable').scrollIntoView({behavior:'smooth'}); }

      // Fetching results from backend
      async function fetchResult({ regNo, session, term, className } = {}) {
        // Try to fetch a single resource by regNo first if regNo provided,
        // else use query endpoint. Adjust endpoints to match your backend.
        const headers = {};
        if (TOKEN) headers['Authorization'] = 'Bearer ' + TOKEN;

        try {
          if (regNo) {
            // try GET /results/:regNo
            let res = await fetch(`${API_BASE}/results/${encodeURIComponent(regNo)}?session=${encodeURIComponent(session || '')}&term=${encodeURIComponent(term || '')}&class=${encodeURIComponent(className || '')}`, { headers });
            if (res.ok) {
              const data = await res.json();
              // Accept both { result } or direct object
              return data.result || data.data || data || null;
            }
            // fallback to query endpoint
            res = await fetch(`${API_BASE}/results?regNo=${encodeURIComponent(regNo)}${session ? '&session=' + encodeURIComponent(session) : ''}${term ? '&term=' + encodeURIComponent(term) : ''}${className ? '&class=' + encodeURIComponent(className) : ''}`, { headers });
            if (res.ok) {
              const data = await res.json();
              // accept array or { results: [...] } or { data: [...] } or { result }
              if (Array.isArray(data)) return data[0] || null;
              if (Array.isArray(data.results)) return data.results[0] || null;
              if (Array.isArray(data.data)) return data.data[0] || null;
              return data.result || data.data || data.results || data || null;
            }
            // not ok
            console.warn('Result fetch returned status', res.status);
            return null;
          } else {
            // no regNo -> try to fetch for logged in user via /me/results or /results/me
            // try multiple common endpoints
            const candidates = [
              `${API_BASE}/me/result`,
              `${API_BASE}/me/results`,
              `${API_BASE}/results/me`,
              `${API_BASE}/results/my`,
              `${API_BASE}/results/current`
            ];
            for (const url of candidates) {
              try {
                const res = await fetch(url, { headers });
                if (res.ok) {
                  const data = await res.json();
                  return data.result || data.data || data.results || data || null;
                }
              } catch (err) { /* ignore and try next */ }
            }
            // as last resort try query without regNo (server should infer from token)
            try {
              const res = await fetch(`${API_BASE}/results?mine=true`, { headers });
              if (res.ok) {
                const data = await res.json();
                if (Array.isArray(data)) return data[0] || null;
                if (Array.isArray(data.results)) return data.results[0] || null;
                return data.result || data.data || data || null;
              }
            } catch (err) { /* ignore */ }
            return null;
          }
        } catch (err) {
          console.error('Network error fetching result', err);
          return null;
        }
      }

      // Get logged-in user info from localStorage
      function getLoggedInApp() {
        try {
          return JSON.parse(localStorage.getItem('eg_application') || 'null') || null;
        } catch (err) {
          return null;
        }
      }

      // main fetch flow used on init and search
      async function loadResultForCurrentUserOrQuery({ regNo, session, term, className } = {}) {
        // If regNo not supplied, try to determine from logged-in application
        if (!regNo) {
          const app = getLoggedInApp();
          if (app) {
            regNo = regNo || app.regNo || app.registration || app.regNO || app.username || app._id || app.id;
            className = className || app.program || app.class || app.level || app.department || '';
          }
        }

        // fetch
        const result = await fetchResult({ regNo, session, term, className });

        if (!result) {
          // show friendly empty state
          populate(null);
          resultStatus.textContent = 'No result found';
          return null;
        }

        // normalize some fields if backend uses different names
        const normalized = {
          regNo: result.regNo || result.registration || result.reg || result.studentId || '',
          name: result.name || result.studentName || result.fullName || '',
          class: result.class || result.program || result.level || '',
          session: result.session || result.academicSession || '',
          term: result.term || result.semester || '',
          status: result.status || result.state || 'Published',
          attendance: result.attendance,
          days: result.days,
          gpa: result.gpa || result.cgpa,
          overallGrade: result.overallGrade || result.grade,
          avgPercent: result.avgPercent || result.avg,
          rank: result.rank,
          teacherComment: result.teacherComment || result.comment,
          subjects: result.subjects || result.scores || result.data || []
        };

        // populate UI
        populate(normalized);
        return normalized;
      }

      // wire search button to fetch by query/regNo
      searchBtn.addEventListener('click', async (e) => {
        const queryReg = regNoEl.value.trim();
        const session = sessionEl.value;
        const term = termEl.value;
        const className = classEl.value;
        // attempt to fetch the requested result
        resultStatus.textContent = 'Loading...';
        await loadResultForCurrentUserOrQuery({ regNo: queryReg || undefined, session, term, className });
        document.getElementById('main').scrollIntoView({behavior:'smooth'});
      });

      clearBtn.addEventListener('click', ()=> {
        regNoEl.value=''; sessionEl.selectedIndex=0; termEl.selectedIndex=0; classEl.selectedIndex=0;
        populate(null);
      });

      // Ensure sidebar state sensible on resize
      function syncSidebarOnResize(){
        if(window.innerWidth <= 980){
          sidebar.classList.remove('open'); // hide by default on mobile
          overlay.classList.remove('visible');
        } else {
          sidebar.classList.remove('open'); // desktop shows sidebar by CSS (no transform)
          overlay.classList.remove('visible');
          document.body.classList.remove('no-scroll');
        }
      }
      window.addEventListener('resize', syncSidebarOnResize);
      syncSidebarOnResize();

      // On page init: attempt to fetch the logged-in user's result automatically
      (async function init(){
        // Try to set sidebar/profile labels from eg_application if present
        const app = getLoggedInApp();
        if (app) {
          try { document.getElementById('sidebarName').textContent = app.firstName ? (app.firstName + (app.lastName ? (' ' + app.lastName) : '')) : (app.name || app.username || document.getElementById('sidebarName').textContent); } catch {}
          try { document.getElementById('sidebarClass').textContent = app.program || app.class || app.level || document.getElementById('sidebarClass').textContent; } catch {}
        }

        resultStatus.textContent = 'Loading...';
        const loaded = await loadResultForCurrentUserOrQuery({});
        if (!loaded) {
          // If no result for user, keep page interactive so admin/teacher can lookup by regNo
          resultStatus.textContent = 'No result available for your account';
        } else {
          resultStatus.textContent = loaded.status || 'Published';
          // prefill form fields with loaded data
          regNoEl.value = loaded.regNo || '';
          if (loaded.session) for (let i=0;i<sessionEl.options.length;i++){ if(sessionEl.options[i].value===loaded.session){ sessionEl.selectedIndex=i; break; } }
          if (loaded.term) for (let i=0;i<termEl.options.length;i++){ if(termEl.options[i].text === loaded.term || termEl.options[i].value === loaded.term){ termEl.selectedIndex=i; break; } }
          if (loaded.class) for (let i=0;i<classEl.options.length;i++){ if(classEl.options[i].text === loaded.class || classEl.options[i].value === loaded.class){ classEl.selectedIndex=i; break; } }
        }
      })();
    })();
  </script>
</body>
</html>
