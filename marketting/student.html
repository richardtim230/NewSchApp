<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Student Dashboard | ExamGuard (Responsive)</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link href="https://fonts.googleapis.com/css?family=Inter:400,600,700&display=swap" rel="stylesheet">
  <link rel="icon" href="logo.png">
  <style>
    :root{
      --bg-0:#f6f8ff; --bg-1:#eef2ff;
      --accent:#3b82f6; --accent-2:#6366f1; --muted:#6b7280;
      --card-bg:#ffffff; --radius:12px;
      --sidebar-w:300px;
    }
    * { box-sizing: border-box; }
    html,body { height:100%; margin:0; font-family:Inter,system-ui,Arial; -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale; background:linear-gradient(180deg,var(--bg-0),var(--bg-1)); }
    a { color:inherit; text-decoration:none; }

    /* App layout */
    .app { display:flex; min-height:100vh; align-items:stretch; }
    /* Overlay to intercept taps on mobile when sidebar is open */
    .overlay { position:fixed; inset:0; background:rgba(2,6,23,0.45); z-index:50; display:none; }
    .overlay.visible { display:block; }
/* =============================
   PROFESSIONAL TIMETABLE
============================= */

.timetable-wrapper {
  margin-top: 16px;
  overflow-x: auto;
}

.timetable {
  display: grid;
  grid-template-columns: 100px repeat(5, 1fr);
  min-width: 800px;
  border-radius: 12px;
  overflow: hidden;
  border: 1px solid #eef3ff;
}

.timetable div {
  padding: 12px;
  border-bottom: 1px solid #eef3ff;
  border-right: 1px solid #eef3ff;
  font-size: 0.9rem;
}

.timetable div:nth-child(-n+6) {
  font-weight: 700;
  background: #f8faff;
  text-align: center;
}

.time-slot {
  font-weight: 700;
  background: #f1f5ff;
}

.subject {
  border-left: 4px solid var(--accent);
  background: #ffffff;
  font-weight: 600;
  transition: all .15s ease;
}

.subject:hover {
  background: #f9fbff;
  transform: translateY(-2px);
  box-shadow: 0 6px 18px rgba(59,130,246,0.08);
}

/* Mobile version */
@media (max-width: 720px) {
  .timetable {
    grid-template-columns: 80px repeat(5, 140px);
  }
}
    /* Sidebar */
    .sidebar {
      width: var(--sidebar-w);
      min-width: var(--sidebar-w);
      background: linear-gradient(180deg,#0f172a 0%, #1e3a8a 100%);
      color:#fff; padding:20px 16px; position:fixed; left:0; top:0; bottom:0; z-index:100;
      box-shadow: 4px 0 28px rgba(15,23,42,0.12);
      transform: translateX(0); transition: transform .28s ease;
      display:flex; flex-direction:column; gap:14px; overflow-y:auto;
      -webkit-overflow-scrolling: touch;
      will-change: transform;
    }
    /* Hidden (mobile closed) */
    .sidebar.hidden { transform: translateX(-110%); }
    /* Open (mobile) */
    .sidebar.open { transform: translateX(0); }

    /* Brand / larger text */
    .brand { display:flex; gap:12px; align-items:center; }
    .brand img { width:48px; height:48px; border-radius:10px; object-fit:cover; border:3px solid rgba(255,224,102,0.12); background:#fff; }
    .brand .title { font-weight:700; font-size:1.18rem; color:#ffe066; }
    .brand .subtitle { font-size:0.96rem; color:rgba(255,255,255,0.9); }

    /* Nav - increased font size & spacing for tap targets */
    .nav { display:flex; flex-direction:column; gap:8px; margin-top:6px; }
    .nav a {
      display:flex; align-items:center; gap:10px; padding:12px 12px; border-radius:10px;
      font-weight:700; font-size:1.05rem; color:#e6eefc; background:transparent;
      transition: background .12s, transform .08s;
      touch-action: manipulation;
    }
    .nav a.active, .nav a:hover { background: rgba(255,255,255,0.04); color:#ffe066; transform: translateX(3px); }

    .spacer { flex:1; }

    .profile { display:flex; gap:12px; align-items:center; padding-top:10px; border-top:1px solid rgba(255,255,255,0.04); }
    .profile img { width:48px; height:48px; border-radius:10px; object-fit:cover; border:2px solid #ffe066; }

    /* Main area */
    .main { margin-left: var(--sidebar-w); padding:20px; flex:1; transition: margin-left .28s; min-height:100vh; overflow-y:auto; -webkit-overflow-scrolling:touch; }
    .main.full { margin-left:0; }

    .topbar { display:flex; justify-content:space-between; align-items:center; gap:12px; margin-bottom:14px; }
    .hamburger { display:none; background:var(--accent); color:#fff; border:none; padding:9px 12px; border-radius:10px; cursor:pointer; font-weight:800; font-size:1.05rem; }

    .page-title { font-weight:800; font-size:1.18rem; color:var(--accent-2); }
    .small { font-size:0.92rem; color:var(--muted); }

    /* Grid & cards */
    .grid { display:grid; grid-template-columns: repeat(12, 1fr); gap:14px; align-items:start; }
    .card { background:var(--card-bg); border-radius:12px; padding:14px; box-shadow: 0 8px 20px rgba(11,42,60,0.04); border:1px solid rgba(11,42,60,0.03); }
    .col-4 { grid-column: span 4; } .col-8 { grid-column: span 8; } .col-6 { grid-column: span 6; } .col-12 { grid-column: 1 / -1; }

    /* Student widgets */
    .progress { display:flex; gap:14px; align-items:center; }
    .circle { width:96px; height:96px; border-radius:50%; background:conic-gradient(var(--accent) 70%, #eef2ff 0%); display:grid; place-items:center; font-weight:800; font-size:1.05rem; color:var(--accent-2); }
    .kpis { display:flex; gap:10px; }

    /* Assignments list */
    .assignments .item { display:flex; justify-content:space-between; gap:12px; padding:10px; border-radius:8px; background:#fff; border:1px solid #eef3ff; margin-bottom:8px; align-items:center; }

    /* Messages */
    .messages { display:flex; gap:12px; }
    .conversations { width:260px; max-width:36%; min-width:200px; }
    .chat { flex:1; min-height:200px; border-radius:10px; overflow:auto; border:1px solid #eef3ff; background:#fff; padding:10px; }

    /* ------------------------
       FOUR-LINK CARD GRID (SQUARE 2x2 on small screens)
       ------------------------ */
    .link-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 12px;
      margin: 12px 0;
      align-items: stretch;
      grid-auto-rows: 1fr; /* make rows equal height automatically */
    }
    .link-card {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 10px;
      padding: 14px;
      border-radius: 12px;
      background: #fff;
      border: 1px solid #eef3ff;
      text-align: center;
      transition: transform .12s ease, box-shadow .12s ease;
      cursor: pointer;
      min-height: 110px;
      justify-content: center;
      height: 100%;
    }
    .link-card:focus,
    .link-card:hover {
      transform: translateY(-6px);
      box-shadow: 0 12px 32px rgba(59,130,246,0.08);
      outline: none;
    }
    .link-card .icon {
      width:56px;
      height:56px;
      border-radius: 10px;
      display: grid;
      place-items: center;
      color: #fff;
      font-size: 22px;
      background: linear-gradient(90deg, var(--accent), var(--accent-2));
      box-shadow: 0 6px 18px rgba(59,130,246,0.08);
    }
    .link-card .title {
      font-weight:800;
      color:#0b2a44;
      font-size: 0.98rem;
    }
    .link-card .subtitle {
      font-size:0.88rem;
      color:var(--muted);
    }

    /* Responsive rules */
    @media (max-width: 980px) {
      .link-grid { grid-template-columns: repeat(2, 1fr); } /* tablet: 2 columns */
      .grid { grid-template-columns: repeat(6, 1fr); }
      .col-4 { grid-column: span 3; } .col-8 { grid-column: span 6; } .col-6 { grid-column: span 3; }
      .hamburger { display:inline-flex; }
    }
    /* IMPORTANT: fixed 2x2 on all small screens (<=720px) */
    @media (max-width: 720px) {
      :root { --sidebar-w: 86vw; } /* sidebar becomes overlay width */
      .sidebar { transform: translateX(-110%); position:fixed; width:var(--sidebar-w); min-width:var(--sidebar-w); }
      .sidebar.open { transform: translateX(0); box-shadow: 0 24px 48px rgba(2,6,23,0.5); }
      .sidebar.hidden { transform: translateX(-110%); }
      .overlay { display:none; } /* shown via JS only when open */
      .overlay.visible { display:block; }
      /* Prevent page scroll when sidebar modal is open - controlled in JS by adding body.no-scroll */
      body.no-scroll { overflow:hidden; height:100vh; touch-action:none; }
      .main { margin-left: 0; padding:14px; margin-top: 10}
      .nav a { padding:14px 14px; font-size:1.08rem; }
      .conversations { display:none; } /* simplify messages on small screens */
      .grid { grid-template-columns: 1fr; }
      .col-4, .col-8, .col-6, .col-12 { grid-column: auto; }

      /* Fixed 2x2 layout: ALWAYS use 2 columns on small screens */
      .link-grid {
        grid-template-columns: repeat(2, 1fr);
        grid-auto-rows: minmax(100px, 1fr); /* ensure balanced cells, taller if needed */
      }
      /* ensure cards fill their cell */
      .link-card { height: 100%; min-height: 100px; }
    }
/* Replace all .topbar rules with these, and ensure nothing inside <main> is sticky anymore */
.topbar {
  position: fixed;
  left: var(--sidebar-w);
  top: 0;
  width: calc(100vw - var(--sidebar-w));
  z-index: 90; /* higher than sidebar/content */
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 12px;
  margin-bottom: 20px;
  padding: 12px 14px;
  backdrop-filter: blur(6px);
  background: rgba(255, 255, 255, 0.86);
  border-bottom: 1px solid rgba(11, 42, 60, 0.06);
  box-shadow: 0 6px 18px rgba(11, 42, 60, 0.04);
  min-height: 64px;
}

/* On mobile (sidebar overlays, not aside, so bar starts at left 0) */
@media (max-width: 720px) {
  .topbar {
    left: 0;
    width: 100vw;
    padding: 10px 12px;
    min-height: 56px;
  }
}
/* =============================
   PROFESSIONAL RESOURCES
============================= */

.resources-grid {
  margin-top: 16px;
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
  gap: 14px;
}

.resource-card {
  background: #ffffff;
  border: 1px solid #eef3ff;
  border-radius: 12px;
  padding: 14px;
  display: flex;
  flex-direction: column;
  gap: 10px;
  transition: all .15s ease;
}

.resource-card:hover {
  transform: translateY(-4px);
  box-shadow: 0 8px 22px rgba(59,130,246,0.08);
}

.resource-header {
  display: flex;
  align-items: center;
  gap: 10px;
}

.resource-icon {
  width: 42px;
  height: 42px;
  border-radius: 10px;
  display: grid;
  place-items: center;
  font-weight: 800;
  color: #fff;
  font-size: 0.8rem;
}

.icon-pdf { background: #ef4444; }
.icon-doc { background: #2563eb; }
.icon-video { background: #10b981; }
.icon-link { background: #6366f1; }

.resource-title {
  font-weight: 700;
}

.resource-sub {
  font-size: 0.85rem;
  color: var(--muted);
}

.resource-actions {
  margin-top: auto;
  display: flex;
  justify-content: flex-end;
  gap: 8px;
}
/* Add top padding/margin to .main to prevent content hiding under fixed bar */
.main {
  margin-left: var(--sidebar-w);
  padding: 20px;
  flex: 1;
  transition: margin-left .28s;
  min-height: 100vh;
  overflow-y: auto;
  -webkit-overflow-scrolling: touch;
  padding-top: 85px;
}
@media (max-width: 720px) {
  .main {
    margin-left: 0;
    padding: 14px;
    padding-top: 90px;
  }
}
    /* Small helper classes */
    .muted { color:var(--muted); }
    .btn { padding:10px 12px; border-radius:10px; border:none; cursor:pointer; background:linear-gradient(90deg,var(--accent),var(--accent-2)); color:#fff; font-weight:700; }
    .btn.ghost { background:transparent; color:var(--accent-2); border:1px solid rgba(59,130,246,0.08); }

    /* Accessibility focus */
    .nav a:focus { outline: 3px solid rgba(99,102,241,0.18); outline-offset: 3px; border-radius:8px; }
    .link-card:focus { outline: 3px solid rgba(99,102,241,0.12); outline-offset: 3px; }
    /* =============================
   RESOURCE MODAL
============================= */

.resource-modal {
  position: fixed;
  inset: 0;
  background: rgba(15, 23, 42, 0.55);
  backdrop-filter: blur(6px);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 9999;
  padding: 20px;
}

.resource-modal.active {
  display: flex;
  animation: fadeIn .2s ease;
}

@keyframes fadeIn {
  from { opacity: 0; }
  to { opacity: 1; }
}

.resource-modal-content {
  background: #ffffff;
  width: 900px;
  max-width: 95vw;
  height: 80vh;
  border-radius: 16px;
  display: flex;
  flex-direction: column;
  overflow: hidden;
  box-shadow: 0 20px 60px rgba(15, 23, 42, 0.25);
}

.resource-modal-header {
  padding: 14px 18px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  border-bottom: 1px solid #eef3ff;
  background: #f8faff;
}

.modal-close {
  background: none;
  border: none;
  font-size: 1.2rem;
  cursor: pointer;
  font-weight: 700;
  color: #64748b;
}

.modal-close:hover {
  color: #ef4444;
}

.resource-modal-body {
  flex: 1;
  overflow: auto;
  padding: 0;
}

.resource-modal-body iframe,
.resource-modal-body video {
  width: 100%;
  height: 100%;
  border: none;
}
  </style>
</head>
<body>
  <div class="app" id="app">
    <div class="overlay" id="overlay" aria-hidden="true"></div>

    <!-- Sidebar -->
    <aside class="sidebar hidden" id="sidebar" aria-label="Main navigation" role="navigation">
      <div class="brand" aria-hidden="false">
        <img src="../logo.png" alt="Logo">
        <div>
          <div class="title">Student Portal</div>
          <div class="subtitle" id="schoolSubtitle">Sunrise High ‚Ä¢ Student</div>
        </div>
      </div>

      <nav class="nav" id="nav" aria-label="Primary">
        <a href="#" data-section="home" class="active" onclick="nav(event)">üè† Home</a>
        <a href="#" data-section="courses" onclick="nav(event)">üìò My Courses</a>
        <a href="#" data-section="assignments" onclick="nav(event)">üìù Assignments</a>
        <a href="#" data-section="grades" onclick="nav(event)">üìä Grades</a>
        <a href="#" data-section="timetable" onclick="nav(event)">‚è∞ Timetable</a>
        <a href="#" data-section="messages" onclick="nav(event)">‚úâÔ∏è Messages</a>
        <a href="#" data-section="resources" onclick="nav(event)">üìÇ Resources</a>
        <a href="#" data-section="settings" onclick="nav(event)">‚öôÔ∏è Settings</a>
      </nav>

      <div class="spacer" aria-hidden="true"></div>

      <div class="profile" role="region" aria-label="Student profile">
        <img src="../avatar.jpg" alt="Student avatar" id="studentAvatar">
        <div>
          <div class="name" id="studentName">Adaobi Chukwu</div>
          <div class="muted" id="studentClass">SS2 ‚Äî Biology</div>
        </div>
      </div>
    </aside>

    <!-- Main -->
  
  <!-- REMOVE the .topbar from inside <main>; move it out and place here: -->
  <div class="topbar" id="fixedTopbar">
    <div style="display:flex; gap:12px; align-items:center;">
      <button class="hamburger" id="hamburger" aria-label="Open menu">‚ò∞</button>
      <div>
        <div class="page-title" id="pageTitle">Welcome back, Adaobi</div>
      </div>
    </div>

    <div style="display:flex; gap:12px; align-items:center;">
      
      <img src="../avatar.jpg" alt="You" style="width:44px;height:44px;border-radius:8px;object-fit:cover;border:2px solid #fff;" id="topbarAvatar">
    </div>
  </div>
  <main class="main" id="main" role="main" tabindex="-1">



      <!-- Home -->
      <section id="home" class="section">
        <div class="grid" style="margin-bottom:12px;">
          <div class="card col-4">
            <div class="small muted">Overall Progress</div>
            <div style="margin-top:10px" class="progress">
              <div class="circle" id="progCircle">--%</div>
              <div>
                <div class="small muted">Cumulative Average</div>
                <div style="font-weight:900; font-size:1.18rem;" id="cumAvg">--%</div>
                <div class="small muted">-- of cohort</div>
              </div>
            </div>
          </div>

          <div class="card col-4">
            <div class="small muted">This Term</div>
            <div style="margin-top:10px" class="kpis">
              <div style="flex:1">
                <div class="small muted">Assignments Due</div>
                <div class="small" id="dueCount" style="font-weight:900;font-size:1.18rem">--</div>
                <div class="small muted">Due this week</div>
              </div>
              <div style="flex:1">
                <div class="small muted">Attendance</div>
                <div class="small" id="attPct" style="font-weight:900;font-size:1.18rem">--%</div>
                <div class="small muted">This term</div>
              </div>
            </div>
          </div>

          <div class="card col-4">
            <div class="small muted">Upcoming</div>
            <div style="margin-top:10px">
              <div id="upcomingTitle" style="font-weight:800">--</div>
              <div class="small muted" id="upcomingMeta">--</div>
              <div style="margin-top:10px; padding:10px; border-left:4px solid var(--accent); background:linear-gradient(90deg,#fff,#fbfdff); border-radius:8px;" id="upcomingNote">--</div>
            </div>
          </div>
        </div>

        <!-- FOUR-LINK CARD GRID -->
        <div class="link-grid" aria-label="Quick links">
          <a class="link-card" href="/marketting/school-fees.html" aria-label="School fees">
            <div class="icon" aria-hidden="true">
              <svg width="28" height="28" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                <path d="M12 1v22" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/>
                <path d="M17 5H7a4 4 0 000 8h10a4 4 0 010 8H7" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
            </div>
            <div class="title">School Fees</div>
            <div class="subtitle">Payments & invoices</div>
          </a>

          <a class="link-card" href="/marketting/result.html" aria-label="Results">
            <div class="icon" aria-hidden="true">
              <svg width="28" height="28" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                <path d="M3 3v18h18" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/>
                <path d="M7 13v4" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/>
                <path d="M12 9v8" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/>
                <path d="M17 5v12" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
            </div>
            <div class="title">Results</div>
            <div class="subtitle">View report cards</div>
          </a>

          <a class="link-card" href="/marketting/cbt-exam.html" aria-label="CBT exam">
            <div class="icon" aria-hidden="true">
              <svg width="28" height="28" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                <rect x="3" y="4" width="18" height="12" rx="2" stroke="currentColor" stroke-width="1.6" />
                <path d="M8 20h8" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"/>
                <path d="M12 16v4" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"/>
              </svg>
            </div>
            <div class="title">CBT Exam</div>
            <div class="subtitle">Start computer tests</div>
          </a>

          <a class="link-card" href="/marketting/others.html" aria-label="Others">
            <div class="icon" aria-hidden="true">
              <svg width="28" height="28" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                <circle cx="5" cy="12" r="1.6" fill="currentColor"/>
                <circle cx="12" cy="12" r="1.6" fill="currentColor"/>
                <circle cx="19" cy="12" r="1.6" fill="currentColor"/>
              </svg>
            </div>
            <div class="title">Others</div>
            <div class="subtitle">Library, transport & more</div>
          </a>
        </div>
        <!-- /END quick links -->

        <div class="grid">
          <div class="card col-8">
            <div style="display:flex;justify-content:space-between;align-items:center;">
              <div style="font-weight:800">Assignments</div>
              <div class="small muted">Track & submit</div>
            </div>
            <div class="assignments" id="assignmentsList" style="margin-top:10px"></div>
            <div style="margin-top:10px;display:flex;justify-content:flex-end"><button class="btn" onclick="navTo('assignments')">View all</button></div>
          </div>

          <div class="card col-4">
            <div style="font-weight:800">Quick Actions</div>
            <div style="margin-top:10px;display:flex;flex-direction:column;gap:8px;">
              <button class="btn ghost" onclick="navTo('resources')">Open Resources</button>
              <button class="btn ghost" onclick="navTo('timetable')">View Timetable</button>
              <button class="btn" onclick="openSubmit()">Submit Assignment</button>
            </div>
          </div>
        </div>

        <div class="grid" style="margin-top:12px;">
          <div class="card col-6">
            <div style="display:flex;justify-content:space-between;align-items:center;"><div style="font-weight:800">Grades Snapshot</div><div class="small muted">Latest</div></div>
            <div style="margin-top:10px">
              <table style="width:100%;border-collapse:collapse">
                <thead><tr><th style="text-align:left;padding:8px">Subject</th><th style="text-align:left;padding:8px">Latest</th><th style="text-align:left;padding:8px">Term Avg</th></tr></thead>
                <tbody id="gradesTable"></tbody>
              </table>
            </div>
          </div>

          <div class="card col-6">
            <div style="display:flex;justify-content:space-between;align-items:center;"><div style="font-weight:800">Messages</div><div class="small muted">Parent/Teacher</div></div>
            <div style="margin-top:10px" class="messages"><div class="conversations card" id="convos"></div><div class="chat card" id="chatPane">Select a conversation</div></div>
          </div>
        </div>
      </section>

      <!-- Placeholder for other sections (courses, assignments, grades, timetable, messages, resources, settings) -->
      <section id="courses" class="section" style="display:none"><div style="font-weight:800">My Courses</div><div id="coursesGrid"></div></section>
      <section id="assignments" class="section" style="display:none"><div style="font-weight:800">Assignments</div><div id="assignmentsFull"></div></section>
      <section id="grades" class="section" style="display:none"><div style="font-weight:800">Grades</div><div id="gradesFull"></div></section>
      <section id="timetable" class="section" style="display:none">
  <div class="card">
    <div style="display:flex;justify-content:space-between;align-items:center;">
      <div style="font-weight:800;font-size:1.1rem;">Weekly Timetable</div>
      <div class="small muted" id="timetableMeta">SS2 ‚Ä¢ Sunrise High</div>
    </div>

    <div class="timetable-wrapper">
      <div class="timetable" id="timetableGrid"></div>
    </div>
  </div>
</section>
      <section id="messages" class="section" style="display:none"><div style="font-weight:800">Messages</div><div id="messagesFull"></div></section>
      <section id="resources" class="section" style="display:none">
  <div class="card">
    <div style="display:flex;justify-content:space-between;align-items:center;">
      <div style="font-weight:800;font-size:1.1rem;">Learning Resources</div>
      <div class="small muted">SS2 ‚Ä¢ All Subjects</div>
    </div>

    <div style="margin-top:14px;display:flex;gap:10px;flex-wrap:wrap;">
      <input type="text" id="resourceSearch"
        placeholder="Search resources..."
        style="flex:1;padding:10px;border-radius:10px;border:1px solid #e5e7eb;">
      <button class="btn">Upload</button>
    </div>

    <div class="resources-grid" id="resourcesGrid"></div>
  </div>
</section>
<section id="settings" class="section" style="display:none">
  <style>
    /* Scoped settings styles (keeps look consistent with dashboard) */
    #settings .settings-card {
      max-width: 900px;
      margin: 12px auto;
      padding: 20px;
      display: grid;
      grid-template-columns: 1fr 360px;
      gap: 20px;
      align-items: start;
    }

    #settings .settings-card .panel {
      background: var(--card-bg, #fff);
      border-radius: 12px;
      padding: 18px;
      box-shadow: 0 8px 20px rgba(11,42,60,0.04);
      border: 1px solid rgba(11,42,60,0.03);
    }

    #settings h2 { margin: 0 0 10px 0; font-size:1.1rem; font-weight:800; color:var(--accent-2,#6366f1); }
    #settings p.lead { margin:0 0 14px 0; color:var(--muted,#6b7280); font-size:0.95rem; }

    /* Form layout */
    .settings-form { display: grid; grid-template-columns: repeat(2, 1fr); gap:12px; }
    .settings-form .full { grid-column: 1 / -1; }
    .settings-field label { display:block; font-weight:700; margin-bottom:6px; font-size:0.92rem; color:#0b2033; }
    .settings-field input[type="text"],
    .settings-field input[type="email"],
    .settings-field input[type="tel"],
    .settings-field select,
    .settings-field textarea,
    .settings-field input[type="password"] {
      width:100%;
      padding:10px 12px;
      border:1px solid #e6e9ef;
      border-radius:8px;
      background:#fff;
      font-size:0.95rem;
    }

    /* Avatar preview column */
    .profile-col { display:flex; flex-direction:column; gap:12px; align-items:center; text-align:center; }
    .avatar-preview {
      width:128px;
      height:128px;
      border-radius:16px;
      overflow:hidden;
      background:#f3f6fb;
      display:grid;
      place-items:center;
      box-shadow: 0 6px 20px rgba(6,23,40,0.06);
    }
    .avatar-preview img { width:100%; height:100%; object-fit:cover; display:block; }

    .muted-small { font-size:0.9rem; color:var(--muted,#6b7280); }

    .actions-row { display:flex; gap:12px; justify-content:flex-end; align-items:center; margin-top:6px; }
    .btn { padding:10px 14px; border-radius:10px; border:0; cursor:pointer; font-weight:800; background:linear-gradient(90deg,var(--accent,#3b82f6),var(--accent-2,#6366f1)); color:#fff; }
    .btn.ghost { background:transparent; border:1px solid rgba(11,42,60,0.06); color:var(--accent-2,#6366f1); font-weight:700; }
    .btn.danger { background:#ef4444; box-shadow:none; }

    /* Password box */
    .password-panel { display:grid; gap:10px; }
    .small-note { font-size:0.9rem; color:var(--muted,#6b7280); }

    /* toast */
    #settingsToast {
      position: fixed;
      right: 18px;
      bottom: 18px;
      min-width: 220px;
      max-width: 360px;
      background: #111827;
      color: #fff;
      padding: 12px 14px;
      border-radius: 10px;
      box-shadow: 0 12px 32px rgba(2,6,23,0.25);
      display: none;
      z-index: 9999;
      font-weight:700;
    }
    #settingsToast.success { background: linear-gradient(90deg,#10b981,#059669); }
    #settingsToast.error { background: linear-gradient(90deg,#ef4444,#dc2626); }

    @media (max-width: 980px) {
      #settings .settings-card { grid-template-columns: 1fr; }
      .settings-form { grid-template-columns: 1fr; }
      .profile-col { flex-direction:row; gap:12px; align-items:center; justify-content:space-between; padding:0 8px; }
    }
  </style>

  <div class="settings-card">
    <!-- left: profile form -->
    <div class="panel" aria-labelledby="settingsProfileTitle">
      <h2 id="settingsProfileTitle">Profile & Account</h2>
      <p class="lead">Update your personal information and contact details. Changes will be saved to your account and reflected across the dashboard.</p>

      <form id="profileForm" class="settings-form" autocomplete="off" novalidate>
        <div class="settings-field">
          <label for="profile_firstName">First name</label>
          <input id="profile_firstName" name="firstName" type="text" />
        </div>

        <div class="settings-field">
          <label for="profile_lastName">Last name</label>
          <input id="profile_lastName" name="lastName" type="text" />
        </div>

        <div class="settings-field">
          <label for="profile_email">Email</label>
          <input id="profile_email" name="email" type="email" />
        </div>

        <div class="settings-field">
          <label for="profile_phone">Phone</label>
          <input id="profile_phone" name="phone" type="tel" />
        </div>

        <div class="settings-field">
          <label for="profile_program">Program / Class</label>
          <input id="profile_program" name="program" type="text" />
        </div>

        <div class="settings-field">
          <label for="profile_address">Address</label>
          <input id="profile_address" name="address" type="text" />
        </div>

        <div class="settings-field full">
          <label for="profile_bio">Short bio (optional)</label>
          <textarea id="profile_bio" name="bio" rows="3" style="resize:vertical;padding:10px 12px;border-radius:8px;border:1px solid #e6e9ef"></textarea>
        </div>

        <div class="settings-field full" style="display:flex;justify-content:space-between;align-items:center;gap:12px;">
          <div style="display:flex;gap:10px;align-items:center;">
            <label for="profile_profilePic" style="margin:0;font-weight:700">Profile picture</label>
            <span class="muted-small">PNG, JPG ‚Ä¢ max 2MB</span>
          </div>
          <input id="profile_profilePic" name="profilePic" type="file" accept="image/*" style="width:220px" />
        </div>

        <div class="settings-field full actions-row">
          <button type="button" id="profileCancel" class="btn ghost">Reset</button>
          <button type="submit" id="profileSaveBtn" class="btn">Save changes</button>
        </div>
      </form>
    </div>

    <!-- right: avatar + password -->
    <aside class="panel profile-col" aria-labelledby="profilePreviewTitle">
      <div>
        <h2 id="profilePreviewTitle" style="text-align:center">Preview</h2>
        <div class="avatar-preview" aria-hidden="false" id="avatarPreview">
          <img src="../avatar.jpg" alt="Profile preview" id="avatarImg" />
        </div>
        <div class="muted-small" id="previewName">Student Name</div>
        <div class="muted-small" id="previewProgram">Program ‚Ä¢ Class</div>
      </div>

      <div style="width:100%;" aria-labelledby="changePasswordTitle">
        <h2 id="changePasswordTitle" style="margin-top:6px;font-size:1rem">Change password</h2>
        <p class="small-note">Choose a strong password. Passwords must be at least 6 characters.</p>

        <form id="passwordForm" class="password-panel" autocomplete="off" novalidate>
          <div>
            <label for="pass_current">Current password</label>
            <input id="pass_current" name="currentPassword" type="password" />
          </div>

          <div>
            <label for="pass_new">New password</label>
            <input id="pass_new" name="newPassword" type="password" />
          </div>

          <div style="display:flex;gap:8px;margin-top:8px;justify-content:flex-end;">
            <button type="button" id="passCancel" class="btn ghost">Clear</button>
            <button type="submit" id="passSaveBtn" class="btn">Update password</button>
          </div>

          <div id="passResult" class="muted-small" style="margin-top:8px;"></div>
        </form>
      </div>
    </aside>
  </div>

  <div id="settingsToast" role="status" aria-live="polite"></div>

  <script>
    (function () {
      const API_BASE = 'https://examguide.onrender.com/api';
      const TOKEN = localStorage.getItem('eg_token') || null;

      const profileForm = document.getElementById('profileForm');
      const profileSaveBtn = document.getElementById('profileSaveBtn');
      const profileCancel = document.getElementById('profileCancel');
      const avatarInput = document.getElementById('profile_profilePic');
      const avatarImg = document.getElementById('avatarImg');
      const previewName = document.getElementById('previewName');
      const previewProgram = document.getElementById('previewProgram');
      const toastEl = document.getElementById('settingsToast');

      const passwordForm = document.getElementById('passwordForm');
      const passSaveBtn = document.getElementById('passSaveBtn');
      const passCancel = document.getElementById('passCancel');
      const passResult = document.getElementById('passResult');

      // small helpers
      function showToast(text, type = 'default', timeout = 3500) {
        toastEl.textContent = text;
        toastEl.className = type === 'success' ? 'success' : (type === 'error' ? 'error' : '');
        toastEl.style.display = 'block';
        clearTimeout(toastEl._t);
        toastEl._t = setTimeout(() => {
          toastEl.style.display = 'none';
        }, timeout);
      }

      function setLoading(btn, loading = true, label = null) {
        if (!btn) return;
        btn.disabled = loading;
        btn._orig = btn._orig || btn.textContent;
        btn.textContent = loading ? (label || 'Saving...') : (btn._orig || 'Save');
      }

      // Load user into form
      function loadProfile() {
        let user = {};
        try {
          user = JSON.parse(localStorage.getItem('eg_application') || 'null') || {};
        } catch (e) {
          user = {};
        }
        // Map fields
        document.getElementById('profile_firstName').value = user.firstName || '';
        document.getElementById('profile_lastName').value = user.lastName || '';
        document.getElementById('profile_email').value = user.email || '';
        document.getElementById('profile_phone').value = user.phone || '';
        document.getElementById('profile_program').value = user.program || user.level || user.department || '';
        document.getElementById('profile_address').value = user.address || '';
        document.getElementById('profile_bio').value = user.bio || '';

        // Avatar preview
        if (user.profilePic) {
          avatarImg.src = user.profilePic;
        } else {
          avatarImg.src = '../avatar.jpg';
        }
        previewName.textContent = (user.firstName || user.username || 'Student') + (user.lastName ? (' ' + user.lastName) : '');
        previewProgram.textContent = user.program || user.level || user.department || '';
        return user;
      }

      // Reset form to stored profile
      function resetProfileForm() {
        loadProfile();
        profileForm.reset();
        passResult.textContent = '';
      }

      // Image preview
      avatarInput.addEventListener('change', (e) => {
        const f = e.target.files && e.target.files[0];
        if (!f) return;
        if (!f.type.startsWith('image/')) {
          showToast('Please select an image file (jpg, png).', 'error');
          avatarInput.value = '';
          return;
        }
        if (f.size > 2 * 1024 * 1024) {
          showToast('Image is too large (max 2MB).', 'error');
          avatarInput.value = '';
          return;
        }
        const reader = new FileReader();
        reader.onload = () => {
          avatarImg.src = reader.result;
        };
        reader.readAsDataURL(f);
      });

      // Profile submit (multipart for file support)
      profileForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const user = loadProfile();
        const userId = user._id || user.id || user.username;
        if (!userId) {
          showToast('No user session found. Please login.', 'error');
          return;
        }

        // Collect changed fields
        const formData = new FormData();
        const fields = ['firstName','lastName','email','phone','program','address','bio'];
        fields.forEach(f => {
          const el = document.getElementById('profile_' + f);
          if (el && el.value.trim() !== '') formData.append(f, el.value.trim());
        });

        // Profile pic
        const pic = avatarInput.files && avatarInput.files[0];
        if (pic) formData.append('profilePic', pic, pic.name);

        try {
          setLoading(profileSaveBtn, true, 'Saving...');
          const url = `${API_BASE}/application/${encodeURIComponent(userId)}`;
          const headers = {};
          if (TOKEN) headers['Authorization'] = 'Bearer ' + TOKEN;
          const res = await fetch(url, {
            method: 'PUT',
            headers,
            body: formData
          });
          const data = await res.json();
          if (res.ok && data.application) {
            // store new profile
            localStorage.setItem('eg_application', JSON.stringify(data.application));
            loadProfile();
            showToast('Profile updated successfully', 'success');
          } else {
            const msg = data?.message || 'Could not update profile';
            showToast(msg, 'error');
          }
        } catch (err) {
          console.error(err);
          showToast('Network/server error. Try again.', 'error');
        } finally {
          setLoading(profileSaveBtn, false);
        }
      });

      profileCancel.addEventListener('click', (e) => {
        e.preventDefault();
        resetProfileForm();
      });

      // Password change
      passwordForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        passResult.textContent = '';
        const currentPassword = document.getElementById('pass_current').value.trim();
        const newPassword = document.getElementById('pass_new').value.trim();
        if (!currentPassword || !newPassword) {
          passResult.style.color = '#d00';
          passResult.textContent = 'Both current and new passwords are required.';
          return;
        }
        if (newPassword.length < 6) {
          passResult.style.color = '#d00';
          passResult.textContent = 'New password must be at least 6 characters.';
          return;
        }

        try {
          setLoading(passSaveBtn, true, 'Updating...');
          const headers = { 'Content-Type': 'application/json' };
          if (TOKEN) headers['Authorization'] = 'Bearer ' + TOKEN;
          const resp = await fetch(`${API_BASE}/auth/change-password`, {
            method: 'POST',
            headers,
            body: JSON.stringify({ currentPassword, newPassword })
          });
          const body = await resp.json();
          if (resp.ok) {
            passResult.style.color = '#087b40';
            passResult.textContent = body.message || 'Password updated';
            passwordForm.reset();
          } else {
            passResult.style.color = '#d00';
            passResult.textContent = body.message || 'Error updating password';
          }
        } catch (err) {
          console.error(err);
          passResult.style.color = '#d00';
          passResult.textContent = 'Network error. Try again.';
        } finally {
          setLoading(passSaveBtn, false);
        }
      });

      passCancel.addEventListener('click', (e) => {
        e.preventDefault();
        passwordForm.reset();
        passResult.textContent = '';
      });

      // initialize
      loadProfile();
    })();
  </script>
</section>
</section>
    </main>
  </div>
<!-- RESOURCE PREVIEW MODAL -->
<div id="resourceModal" class="resource-modal">
  <div class="resource-modal-content">
    <div class="resource-modal-header">
      <div id="modalTitle" style="font-weight:800;"></div>
      <button id="closeResourceModal" class="modal-close">‚úï</button>
    </div>
    <div id="modalBody" class="resource-modal-body"></div>
  </div>
</div>
  <script>
    // Configuration - update API_BASE if required
    const API_BASE = 'https://examguide.onrender.com/api';
    // Token saved on login (optional). If present, will be used for authenticated API calls.
    const TOKEN = localStorage.getItem('eg_token') || null;

    // Elements
    const sidebar = document.getElementById('sidebar');
    const overlay = document.getElementById('overlay');
    const hamburger = document.getElementById('hamburger');
    const body = document.body;
    const main = document.getElementById('main');

    // Utility to fetch from API with optional auth
    async function apiFetch(path, options = {}) {
      const headers = options.headers || {};
      if (!headers['Content-Type'] && !(options.body instanceof FormData)) {
        headers['Content-Type'] = 'application/json';
      }
      if (TOKEN) headers['Authorization'] = 'Bearer ' + TOKEN;
      try {
        const res = await fetch(path.startsWith('http') ? path : (API_BASE + path), {
          ...options,
          headers
        });
        const contentType = res.headers.get('content-type') || '';
        let data = null;
        if (contentType.includes('application/json')) data = await res.json();
        else data = await res.text();
        return { ok: res.ok, status: res.status, data };
      } catch (e) {
        console.error('API fetch error', e, path);
        return { ok: false, status: 0, data: null, error: e };
      }
    }

    // Mobile: open sidebar as overlay, prevent document scroll and make only sidebar scrollable
    function openSidebar() {
      sidebar.classList.remove('hidden');
      sidebar.classList.add('open');
      overlay.classList.add('visible');
      if (window.innerWidth <= 720) {
        body.classList.add('no-scroll');
        sidebar.style.overflowY = 'auto';
      }
      const firstLink = sidebar.querySelector('.nav a');
      if (firstLink) firstLink.focus();
    }

    function closeSidebar() {
      sidebar.classList.remove('open');
      overlay.classList.remove('visible');
      if (window.innerWidth <= 720) {
        sidebar.classList.add('hidden');
      }
      body.classList.remove('no-scroll');
    }

    // Hamburger toggles mobile sidebar
    hamburger.addEventListener('click', (e) => {
      e.stopPropagation();
      if (sidebar.classList.contains('open')) closeSidebar(); else openSidebar();
    });

    // Clicking overlay or any area outside sidebar closes it (mobile)
    overlay.addEventListener('click', closeSidebar);

    // Close sidebar when any nav link is clicked (on small screens)
    document.querySelectorAll('.nav a').forEach(a => {
      a.addEventListener('click', (e) => {
        if (window.innerWidth <= 720) {
          setTimeout(closeSidebar, 80);
        }
      });
    });

    // Also close when clicking outside sidebar anywhere in the document (mobile)
    document.addEventListener('click', (e) => {
      if (window.innerWidth <= 720) {
        const isInsideSidebar = sidebar.contains(e.target) || hamburger.contains(e.target);
        if (!isInsideSidebar && sidebar.classList.contains('open')) {
          closeSidebar();
        }
      }
    }, { passive: true });

    // Close with Escape key
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && sidebar.classList.contains('open')) closeSidebar();
    });

    // Ensure correct initial visibility on resize
    function handleResize() {
      if (window.innerWidth > 720) {
        sidebar.classList.remove('hidden');
        sidebar.classList.remove('open');
        overlay.classList.remove('visible');
        body.classList.remove('no-scroll');
        main.classList.remove('full');
      } else {
        if (!sidebar.classList.contains('open')) sidebar.classList.add('hidden');
        main.classList.add('full');
      }
    }
    window.addEventListener('resize', handleResize);
    handleResize();

    // Simple navigation handling (show/hide sections)
    function nav(e) {
      e.preventDefault();
      const link = e.currentTarget;
      document.querySelectorAll('.nav a').forEach(n => n.classList.remove('active'));
      link.classList.add('active');
      const id = link.getAttribute('data-section');
      showSection(id);
    }
    function navTo(section) {
      const link = document.querySelector('.nav a[data-section="' + section + '"]');
      if (link) link.click();
      else showSection(section);
    }
    function showSection(id) {
      document.querySelectorAll('main .section').forEach(s => s.style.display = 'none');
      const s = document.getElementById(id);
      if (s) s.style.display = '';
      if (window.innerWidth <= 720) closeSidebar();
      main.scrollTo({ top: 0, behavior: 'smooth' });
      main.focus();
    }

    // Load current user from localStorage (populated at login)
    function loadCurrentUser() {
      let user = null;
      try {
        user = JSON.parse(localStorage.getItem('eg_application') || 'null');
      } catch (e) {
        console.warn('Invalid eg_application in localStorage', e);
        user = null;
      }
      if (!user || !user.username) {
        // Not logged in, go to login
        window.location.href = 'login.html';
        return null;
      }

      // Populate UI with whatever we have
      const name = (user.firstName && user.lastName) ? `${user.firstName} ${user.lastName}` : (user.firstName || user.username);
      const klass = user.program || user.level || user.department || 'Student';
      let avatar = user.profilePic || '../avatar.jpg';
      if (!/^https?:\/\//.test(avatar) && avatar.startsWith('/')) {
        // make relative paths usable
        avatar = avatar;
      }

      document.getElementById('studentName').textContent = name;
      document.getElementById('studentClass').textContent = klass;
      document.getElementById('studentAvatar').src = avatar;
      document.getElementById('topbarAvatar').src = avatar;
      document.getElementById('pageTitle').textContent = 'Welcome back, ' + (name.split(' ')[0] || name);

      // Optionally refresh user details from server if token is present
      async function refresh() {
        if (!TOKEN) return;
        const r = await apiFetch('/auth/me');
        if (r.ok && r.data && r.data.user) {
          const fresh = r.data.user;
          // update localStorage and UI safely
          localStorage.setItem('eg_application', JSON.stringify(fresh));
          const freshName = (fresh.firstName && fresh.lastName) ? `${fresh.firstName} ${fresh.lastName}` : (fresh.firstName || fresh.username);
          document.getElementById('studentName').textContent = freshName;
          document.getElementById('studentClass').textContent = fresh.program || fresh.level || fresh.department || 'Student';
          if (fresh.profilePic) document.getElementById('studentAvatar').src = fresh.profilePic;
          if (fresh.profilePic) document.getElementById('topbarAvatar').src = fresh.profilePic;
        }
      }
      refresh().catch(()=>{/* ignore refresh errors */});

      return user;
    }

    // Data fetching endpoints (assumed - modify later if your API differs)
    // Each function returns array/object or empty default on error
    async function fetchAssignments(studentId) {
      // GET /student/assignments?studentId=...
      const r = await apiFetch(`/application/student/assignments?studentId=${encodeURIComponent(studentId)}`);
      if (r.ok && r.data) return r.data.assignments || r.data || [];
      return [];
    }
    async function fetchGrades(studentId) {
      const r = await apiFetch(`/application/student/grades?studentId=${encodeURIComponent(studentId)}`);
      if (r.ok && r.data) return r.data.grades || r.data || [];
      return [];
    }
    async function fetchConversations(studentId) {
      const r = await apiFetch(`/application/messages/conversations?user=${encodeURIComponent(studentId)}`);
      if (r.ok && r.data) return r.data.conversations || r.data || [];
      return [];
    }
    async function fetchCourses(studentId) {
      const r = await apiFetch(`/application/student/courses?studentId=${encodeURIComponent(studentId)}`);
      if (r.ok && r.data) return r.data.courses || r.data || [];
      return [];
    }
    async function fetchResources(studentId) {
      const r = await apiFetch(`/application/resources?studentId=${encodeURIComponent(studentId)}`);
      if (r.ok && r.data) return r.data.resources || r.data || [];
      return [];
    }
    async function fetchTimetable(studentId) {
      const r = await apiFetch(`/application/student/timetable?studentId=${encodeURIComponent(studentId)}`);
      if (r.ok && r.data) return r.data.timetable || r.data || null;
      return null;
    }
    async function fetchOverview(studentId) {
      const r = await apiFetch(`/application/student/overview?studentId=${encodeURIComponent(studentId)}`);
      if (r.ok && r.data) return r.data || {};
      return {};
    }

    // Render helpers
    function renderAssignments(assignments) {
      const assignmentsList = document.getElementById('assignmentsList');
      const assignmentsFull = document.getElementById('assignmentsFull');
      assignmentsList.innerHTML = '';
      if (assignmentsFull) assignmentsFull.innerHTML = '';

      if (!assignments || assignments.length === 0) {
        assignmentsList.innerHTML = '<div class="small muted">No assignments found.</div>';
        if (assignmentsFull) assignmentsFull.innerHTML = '<div class="small muted">No assignments found.</div>';
        return;
      }

      assignments.slice(0, 6).forEach(a => {
        const due = a.due ? (new Date(a.due)).toLocaleDateString() : '--';
        const el = document.createElement('div');
        el.className = 'item';
        el.style.display = 'flex';
        el.style.justifyContent = 'space-between';
        el.style.alignItems = 'center';
        el.style.gap = '12px';
        el.innerHTML = `<div style="flex:1">
            <div style="font-weight:800">${escapeHtml(a.title || a.name || 'Untitled')}</div>
            <div class="small muted">${escapeHtml(a.class || a.course || '')} ‚Ä¢ Due ${due}</div>
          </div>
          <div style="display:flex;flex-direction:column;gap:6px;align-items:flex-end">
            <div class="small muted">${escapeHtml(a.status || 'Pending')}</div>
            <button class="btn" onclick="openSubmit('${a._id || a.id || ''}')">Submit</button>
          </div>`;
        assignmentsList.appendChild(el);
      });

      if (assignmentsFull) {
        assignments.forEach(a => {
          const node = document.createElement('div');
          node.className = 'card';
          node.style.marginBottom = '10px';
          node.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center">
            <div><div style="font-weight:800">${escapeHtml(a.title || a.name || 'Untitled')}</div><div class="small muted">${escapeHtml(a.class || a.course || '')} ‚Ä¢ Due ${a.due ? (new Date(a.due)).toLocaleDateString() : '--'}</div></div>
            <div><button class="btn" onclick="openSubmit('${a._id || a.id || ''}')">Submit</button></div>
          </div>`;
          assignmentsFull.appendChild(node);
        });
      }
    }

    function renderGrades(grades) {
      const gradesTable = document.getElementById('gradesTable');
      const gradesFull = document.getElementById('gradesFull');
      gradesTable.innerHTML = '';
      if (gradesFull) gradesFull.innerHTML = '';

      if (!grades || grades.length === 0) {
        gradesTable.innerHTML = '<tr><td colspan="3" class="small muted" style="padding:8px">No grades available.</td></tr>';
        if (gradesFull) gradesFull.innerHTML = '<div class="small muted">No grades available.</div>';
        return;
      }

      grades.forEach(g => {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td style="padding:8px">${escapeHtml(g.subject || g.course || '')}</td><td style="padding:8px;font-weight:800">${escapeHtml(g.latest || g.grade || '')}</td><td style="padding:8px" class="muted">${escapeHtml(g.avg || g.termAvg || '')}</td>`;
        gradesTable.appendChild(tr);
      });

      if (gradesFull) {
        gradesFull.innerHTML = '';
        grades.forEach(g => {
          const el = document.createElement('div');
          el.className = 'card';
          el.style.marginBottom = '10px';
          el.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center">
            <div><div style="font-weight:800">${escapeHtml(g.subject || g.course || '')}</div><div class="small muted">Latest: ${escapeHtml(g.latest || g.grade || '')}</div></div>
            <div class="small muted">Term Avg: ${escapeHtml(g.avg || g.termAvg || '')}</div>
          </div>`;
          gradesFull.appendChild(el);
        });
      }
    }

    function renderConversations(convos) {
      const convosEl = document.getElementById('convos');
      convosEl.innerHTML = '';
      if (!convos || convos.length === 0) {
        convosEl.innerHTML = '<div class="small muted">No conversations yet.</div>';
        return;
      }
      convos.forEach((c, idx) => {
        const node = document.createElement('div');
        node.style.padding = '8px'; node.style.borderRadius='8px'; node.style.marginBottom='8px'; node.style.cursor='pointer';
        node.style.background = idx === 0 ? '#fbfdff' : '#fff';
        node.innerHTML = `<div style="font-weight:700">${escapeHtml(c.title || c.name || c.with || 'Conversation')}</div><div class="small muted">${escapeHtml(c.preview || c.lastMessage || '')}</div>`;
        node.addEventListener('click', () => openConversation(c));
        convosEl.appendChild(node);
      });
    }

    function renderCourses(courses) {
      const cg = document.getElementById('coursesGrid');
      if (!cg) return;
      cg.innerHTML = '';
      if (!courses || courses.length === 0) {
        cg.innerHTML = '<div class="small muted">No courses enrolled.</div>';
        return;
      }
      courses.forEach(course => {
        const card = document.createElement('div'); card.className = 'card'; card.style.marginBottom='10px';
        card.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center">
          <div><div style="font-weight:800">${escapeHtml(course.title || course.name || '')}</div><div class="small muted">Teacher: ${escapeHtml(course.teacher || course.instructor || '')}</div></div>
          <div><div class="small muted">Avg: ${escapeHtml(course.avg || course.grade || '--')}</div><button class="btn ghost" style="margin-top:6px" onclick="navTo('grades')">View</button></div>
        </div>`;
        cg.appendChild(card);
      });
    }

    function renderResources(resources) {
      const grid = document.getElementById('resourcesGrid');
      if (!grid) return;
      grid.innerHTML = '';
      if (!resources || resources.length === 0) {
        grid.innerHTML = '<div class="small muted">No resources available.</div>';
        return;
      }
      resources.forEach(res => {
        const card = document.createElement('div');
        card.className = 'resource-card';

        const iconClass =
          res.type === "pdf" ? "icon-pdf" :
          res.type === "doc" ? "icon-doc" :
          res.type === "video" ? "icon-video" :
          "icon-link";

        card.innerHTML = `
          <div class="resource-header">
            <div class="resource-icon ${iconClass}">
              ${escapeHtml((res.type || 'file').toUpperCase())}
            </div>
            <div>
              <div class="resource-title">${escapeHtml(res.title || res.name || 'Resource')}</div>
              <div class="resource-sub">${escapeHtml(res.subject || res.course || '')}</div>
            </div>
          </div>
          <div class="resource-actions">
            <button class="btn ghost preview-btn">Preview</button>
            <button class="btn download-btn">Download</button>
          </div>
        `;

        const previewBtn = card.querySelector(".preview-btn");
        const downloadBtn = card.querySelector(".download-btn");

        previewBtn.addEventListener("click", () => openResourceModal(res));
        downloadBtn.addEventListener("click", () => {
          const link = document.createElement("a");
          link.href = res.file;
          link.download = res.title || 'resource';
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);
        });

        grid.appendChild(card);
      });
    }

    function renderTimetable(timetable) {
      const timetableEl = document.getElementById('timetableGrid');
      if (!timetableEl) return;
      timetableEl.innerHTML = '';
      if (!timetable || !Array.isArray(timetable.rows)) {
        timetableEl.innerHTML = '<div class="small muted" style="padding:12px">No timetable available.</div>';
        return;
      }

      // Expected timetable format: { days: [...], times: [...], rows: { time: [subjects] } } or { rows: [ { time: '8:00 - 9:00', slots: [..] }, ... ] }
      if (timetable.days && timetable.times && timetable.rows) {
        // header
        timetable.days.forEach(day => {
          const cell = document.createElement("div");
          cell.textContent = day;
          timetableEl.appendChild(cell);
        });
        timetable.times.forEach(time => {
          const timeCell = document.createElement("div");
          timeCell.textContent = time;
          timeCell.className = "time-slot";
          timetableEl.appendChild(timeCell);
          const slots = timetable.rows[time] || [];
          for (let i = 0; i < (timetable.days.length - 1); i++) {
            const subCell = document.createElement("div");
            subCell.textContent = slots[i] || '';
            subCell.className = "subject";
            timetableEl.appendChild(subCell);
          }
        });
      } else if (Array.isArray(timetable.rows)) {
        // rows array format
        const days = timetable.days || ["Time", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday"];
        days.forEach(day => {
          const cell = document.createElement("div");
          cell.textContent = day;
          timetableEl.appendChild(cell);
        });
        timetable.rows.forEach(r => {
          const timeCell = document.createElement("div");
          timeCell.textContent = r.time || '';
          timeCell.className = "time-slot";
          timetableEl.appendChild(timeCell);
          (r.slots || []).forEach(slot => {
            const subCell = document.createElement("div");
            subCell.textContent = slot || '';
            subCell.className = "subject";
            timetableEl.appendChild(subCell);
          });
        });
      } else {
        // fallback placeholder
        timetableEl.innerHTML = '<div class="small muted" style="padding:12px">Timetable format not recognised.</div>';
      }
    }

    // Open/close resource modal
    function openResourceModal(res) {
      const modal = document.getElementById("resourceModal");
      const modalTitle = document.getElementById("modalTitle");
      const modalBody = document.getElementById("modalBody");

      modalTitle.textContent = res.title || res.name || 'Resource';
      modalBody.innerHTML = "";

      if (res.type === "pdf" || res.type === "doc") {
        modalBody.innerHTML = `<iframe src="${res.file}" style="width:100%;height:100%"></iframe>`;
      } else if (res.type === "video") {
        modalBody.innerHTML = `<iframe src="${res.file.replace("watch?v=", "embed/")}" allowfullscreen style="width:100%;height:100%"></iframe>`;
      } else {
        modalBody.innerHTML = `<div style="padding:20px;"><p>This is an external resource.</p><a href="${res.file}" target="_blank" class="btn">Open Link</a></div>`;
      }

      modal.classList.add("active");
    }

    function closeResourceModal() {
      const modal = document.getElementById("resourceModal");
      const modalBody = document.getElementById("modalBody");
      modal.classList.remove("active");
      modalBody.innerHTML = "";
    }

    document.getElementById("closeResourceModal").addEventListener("click", closeResourceModal);
    document.getElementById("resourceModal").addEventListener("click", function(e) { if (e.target === this) closeResourceModal(); });

    // Open assignment submit modal
    function openSubmit(id) {
      const modal = document.createElement('div');
      modal.style.position = 'fixed'; modal.style.inset = 0; modal.style.background = 'rgba(2,6,23,0.45)';
      modal.style.display = 'flex'; modal.style.alignItems = 'center'; modal.style.justifyContent = 'center'; modal.style.zIndex = 9999;
      modal.onclick = () => document.body.removeChild(modal);
      modal.innerHTML = `<div class="card" style="width:520px;max-width:92vw" onclick="event.stopPropagation()">
        <div style="font-weight:800">${id ? 'Submit Assignment' : 'Submit Assignment'}</div>
        <div class="small muted" style="margin-top:6px">${id ? ('Assignment ID: ' + id) : ''}</div>
        <div style="margin-top:12px"><input type="file" id="fileUp"></div>
        <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px">
          <button class="btn ghost" onclick="document.body.removeChild(modal)">Cancel</button>
          <button class="btn" onclick="(function(){ alert('Submitted'); document.body.removeChild(modal); })()">Upload & Submit</button>
        </div>
      </div>`;
      document.body.appendChild(modal);
    }

    function openConversation(convo) {
      const chat = document.getElementById('chatPane');
      chat.innerHTML = `<div style="font-weight:700;margin-bottom:8px">${escapeHtml(convo.title || convo.name || 'Conversation')}</div><div class="small muted">${escapeHtml(convo.preview || convo.lastMessage || '')}</div>`;
      if (window.innerWidth <= 720) closeSidebar();
    }

    // Escape HTML utility to avoid XSS when inserting strings
    function escapeHtml(str) {
      if (str === null || str === undefined) return '';
      return String(str).replace(/[&<>"']/g, function (m) {
        return ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' })[m];
      });
    }

    // Load data for dashboard by calling API endpoints
    async function loadDashboardData(user) {
      if (!user) return;
      const studentId = user.studentId || user._id || user.id || user.username;
      // Kick off parallel fetches
      const [
        assignmentsRes,
        gradesRes,
        convosRes,
        coursesRes,
        resourcesRes,
        timetableRes,
        overviewRes
      ] = await Promise.allSettled([
        fetchAssignments(studentId),
        fetchGrades(studentId),
        fetchConversations(studentId),
        fetchCourses(studentId),
        fetchResources(studentId),
        fetchTimetable(studentId),
        fetchOverview(studentId)
      ]);

      // Process results, use empty fallbacks if rejected
      const assignments = assignmentsRes.status === 'fulfilled' ? assignmentsRes.value : [];
      const grades = gradesRes.status === 'fulfilled' ? gradesRes.value : [];
      const convos = convosRes.status === 'fulfilled' ? convosRes.value : [];
      const courses = coursesRes.status === 'fulfilled' ? coursesRes.value : [];
      const resources = resourcesRes.status === 'fulfilled' ? resourcesRes.value : [];
      const timetable = timetableRes.status === 'fulfilled' ? timetableRes.value : null;
      const overview = overviewRes.status === 'fulfilled' ? overviewRes.value : {};

      // Render UI
      renderAssignments(assignments);
      renderGrades(grades);
      renderConversations(convos);
      renderCourses(courses);
      renderResources(resources);
      renderTimetable(timetable);

      // Populate overview KPIs
      const cumAvg = overview.cumulativeAverage || overview.cumAvg || '--';
      const dueCount = overview.assignmentsDue || (assignments.filter(a => a.status !== 'Submitted').length) || 0;
      const attPct = overview.attendancePercentage || '--';
      const upcoming = overview.upcoming || {};

      document.getElementById('progCircle').textContent = cumAvg === '--' ? '--%' : `${cumAvg}%`;
      document.getElementById('cumAvg').textContent = cumAvg === '--' ? '--%' : `${cumAvg}%`;
      document.getElementById('dueCount').textContent = String(dueCount);
      document.getElementById('attPct').textContent = attPct ? `${attPct}%` : '--%';
      document.getElementById('upcomingTitle').textContent = upcoming.title || (assignments[0] && assignments[0].title) || '--';
      document.getElementById('upcomingMeta').textContent = upcoming.meta || (assignments[0] && assignments[0].due ? `Due ${new Date(assignments[0].due).toLocaleDateString()}` : '--');
      document.getElementById('upcomingNote').textContent = upcoming.note || (assignments[0] && assignments[0].note) || 'Check resources for materials.';
    }

    // Entry point on load
    window.addEventListener('load', async () => {
      const currentUser = loadCurrentUser();
      if (!currentUser) return; // loadCurrentUser will redirect if needed

      // Load dashboard data
      try {
        await loadDashboardData(currentUser);
      } catch (e) {
        console.error('Failed to load dashboard data', e);
      }

      // Ensure sidebar initial state for small screens
      if (window.innerWidth <= 720) sidebar.classList.add('hidden');
    });

    // Accessibility: close overlay with Escape
    document.addEventListener('keydown', (e) => { if (e.key === 'Escape') closeSidebar(); });
  </script>
</body>
</html>
