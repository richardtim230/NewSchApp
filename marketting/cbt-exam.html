<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>CBT Exams | ExamGuard</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link href="https://fonts.googleapis.com/css?family=Inter:400,600,700&display=swap" rel="stylesheet">
  <link rel="icon" href="../logo.png">
  <style>
    :root{
      --bg-0:#f6f8ff; --bg-1:#eef2ff;
      --accent:#3b82f6; --accent-2:#6366f1; --muted:#6b7280;
      --card-bg:#ffffff; --radius:12px; --sidebar-w:300px;
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;font-family:Inter,system-ui,Arial; -webkit-font-smoothing:antialiased; background:linear-gradient(180deg,var(--bg-0),var(--bg-1)); color:#0b2a44}
    a{color:inherit;text-decoration:none}

    /* App layout */
    .app{display:flex;min-height:100vh;align-items:stretch}
    .overlay{position:fixed;inset:0;background:rgba(2,6,23,0.45);z-index:50;display:none}
    .overlay.visible{display:block}

    /* Sidebar (desktop shows instantly) */
    .sidebar{
      width:var(--sidebar-w); min-width:var(--sidebar-w);
      background:linear-gradient(180deg,#0f172a 0%, #1e3a8a 100%);
      color:#fff; padding:20px 16px; position:fixed; left:0; top:0; bottom:0; z-index:100;
      box-shadow:4px 0 28px rgba(15,23,42,0.12);
      display:flex; flex-direction:column; gap:14px; overflow-y:auto; transition:none;
    }
    /* Mobile overlay behavior */
    @media (max-width:720px) {
      .sidebar { transform: translateX(-110%); transition: transform .28s ease; position:fixed; width:86vw; min-width:86vw; }
      .sidebar.hidden { transform: translateX(-110%); }
      /* open declared after hidden so it wins */
      .sidebar.open { transform: translateX(0); box-shadow:0 24px 48px rgba(2,6,23,0.5); }
    }

    .brand{display:flex;gap:12px;align-items:center}
    .brand img{width:44px;height:44px;border-radius:10px;object-fit:cover;border:3px solid rgba(255,224,102,0.12);background:#fff}
    .brand .title{font-weight:800;font-size:1.05rem;color:#ffe066}
    .nav{display:flex;flex-direction:column;gap:8px;margin-top:6px}
    .nav a{display:flex;align-items:center;gap:10px;padding:12px;border-radius:10px;font-weight:700;font-size:1rem;color:#e6eefc}
    .nav a.active,.nav a:hover{background:rgba(255,255,255,0.04);color:#ffe066}

    .spacer{flex:1}
    .profile{display:flex;gap:12px;align-items:center;padding-top:10px;border-top:1px solid rgba(255,255,255,0.04)}
    .profile img{width:48px;height:48px;border-radius:10px;object-fit:cover;border:2px solid #ffe066}

    /* Topbar */
    .topbar{
      position:fixed; left:var(--sidebar-w); top:0; width:calc(100vw - var(--sidebar-w));
      z-index:90; display:flex; align-items:center; justify-content:space-between; gap:12px; padding:12px 14px;
      backdrop-filter: blur(6px); background: rgba(255,255,255,0.86);
      border-bottom:1px solid rgba(11,42,60,0.06); box-shadow:0 6px 18px rgba(11,42,60,0.04); min-height:64px;
    }
    @media (max-width:720px) { .topbar { left:0; width:100vw; padding:10px 12px; min-height:56px; } }

    .hamburger{ display:none; background:var(--accent); color:#fff; border:none; padding:9px 12px; border-radius:10px; cursor:pointer; font-weight:800; }
    @media (max-width:980px) { .hamburger{ display:inline-flex } }

    .page-title{ font-weight:800; font-size:1.05rem; color:var(--accent-2) }
    .small{ font-size:0.92rem; color:var(--muted) }

    /* Main content */
    .main{ margin-left:var(--sidebar-w); padding:20px; flex:1; transition: margin-left .28s; min-height:100vh; padding-top:90px; overflow-y:auto }
    @media (max-width:720px){ .main{ margin-left:0; padding:14px; padding-top:80px } }

    /* Layout blocks */
    .grid { display:grid; grid-template-columns: 2fr 1fr; gap:14px; align-items:start; }
    @media (max-width:980px) { .grid { grid-template-columns: 1fr } }

    .card { background:var(--card-bg); border-radius:12px; padding:14px; box-shadow:0 8px 20px rgba(11,42,60,0.04); border:1px solid rgba(11,42,60,0.03); }

    /* scheduled list */
    .exam-grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(220px,1fr)); gap:12px; }
    .exam-card { border-radius:12px; padding:12px; background:#fff; border:1px solid #eef3ff; display:flex; flex-direction:column; gap:8px; min-height:120px; }
    .exam-card h4 { margin:0; font-size:1rem; font-weight:800 }
    .exam-meta { font-size:0.92rem; color:var(--muted) }

    .actions { margin-top:auto; display:flex; gap:8px }

    /* practice & AI */
    .panel-list { display:grid; grid-template-columns:repeat(2,1fr); gap:12px; }
    @media (max-width:720px) { .panel-list { grid-template-columns: 1fr } }

    .practice-card { background:#fff; border-radius:12px; padding:12px; border:1px solid #eef3ff }

    /* modal */
    .modal { position: fixed; inset: 0; background: rgba(2,6,23,0.45); display: none; align-items:center; justify-content:center; z-index:9999; padding:16px; }
    .modal.active { display:flex; }
    .modal .panel { background:#fff; width:900px; max-width:95vw; border-radius:12px; overflow:hidden; box-shadow:0 20px 60px rgba(2,6,23,0.25); }
    .modal .head { padding:12px 16px; border-bottom:1px solid #eef3ff; background:#f8fbff; display:flex; justify-content:space-between; align-items:center; }
    .modal .body { padding:14px; max-height:72vh; overflow:auto }

    /* loading overlay */
    .page-loader {
      position: fixed;
      inset: 0;
      display: none;
      align-items: center;
      justify-content: center;
      gap: 12px;
      z-index: 1200;
      background: rgba(255,255,255,0.9);
      backdrop-filter: blur(3px);
      flex-direction: column;
    }
    .page-loader.active { display:flex; }
    .page-loader .spinner { width:44px;height:44px;border-radius:50%;border:6px solid rgba(0,0,0,0.06);border-top-color:var(--accent);animation:spin 1s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }
    .page-loader .msg { font-weight:800; color:#0b2a44; }
    .page-loader .sub { color:var(--muted); font-size:0.92rem; }

    /* small helpers */
    .muted-small { font-size:0.9rem; color:var(--muted) }
    .btn { padding:9px 12px; border-radius:10px; border:none; cursor:pointer; background:linear-gradient(90deg,var(--accent),var(--accent-2)); color:#fff; font-weight:800; }
    .btn.ghost { background:transparent; color:var(--accent-2); border:1px solid rgba(59,130,246,0.08); }
    .btn.warn { background:linear-gradient(90deg,#f97316,#f59e0b); }
    .empty { padding:28px; text-align:center; color:var(--muted); border:1px dashed #eef3ff; border-radius:12px; }

    /* accessibility */
    :focus { outline: 3px solid rgba(99,102,241,0.18); outline-offset: 2px; border-radius:6px; }

  </style>
</head>
<body>
  <div class="app" id="app">
    <div class="overlay" id="overlay" aria-hidden="true"></div>

    <!-- Page loader -->
    <div id="pageLoader" class="page-loader" role="status" aria-live="polite" aria-hidden="true">
      <div class="spinner" aria-hidden="true"></div>
      <div class="msg" id="loaderMsg">Loading exams...</div>
      <div class="sub" id="loaderSub">Fetching scheduled exams and your profile</div>
    </div>

    <!-- Sidebar -->
    <aside class="sidebar" id="sidebar" aria-label="Main navigation" role="navigation">
      <div class="brand">
        <img src="../logo.png" alt="Logo">
        <div>
          <div class="title">Student Portal</div>
          <div class="small">Exams</div>
        </div>
      </div>

      <nav class="nav" id="nav" aria-label="Primary">
        <a href="student.html">üè† Dashboard</a>
        <a href="marketting/others.html">üîó Others</a>
        <a href="marketting/cbt-exam.html" class="active">üñ•Ô∏è CBT Exam</a>
        <a href="marketting/results.html">üìò Results</a>
      </nav>

      <div class="spacer" aria-hidden="true"></div>

      <div class="profile" role="region" aria-label="Student profile">
        <img src="../avatar.jpg" alt="Student avatar" id="studentAvatar">
        <div>
          <div class="name" id="studentName">Student</div>
          <div class="muted-small" id="studentClass">‚Äî</div>
        </div>
      </div>
    </aside>

    <!-- Topbar -->
    <div class="topbar" id="topbar">
      <div style="display:flex;gap:12px;align-items:center;">
        <button class="hamburger" id="hamburger" aria-label="Open menu">‚ò∞</button>
        <div>
          <div class="page-title">CBT ‚Äî Exams & Practice</div>
          <div class="small muted">Scheduled exams, practice sets & AI quizzes</div>
        </div>
      </div>

      <div style="display:flex;gap:12px;align-items:center;">
        <div class="small muted" id="termInfo">‚Äî</div>
        <img src="../avatar.jpg" alt="You" style="width:44px;height:44px;border-radius:8px;border:2px solid #fff;" id="topbarAvatar">
      </div>
    </div>

    <!-- Main -->
    <main class="main" id="main" role="main" tabindex="-1">
      <div class="grid">
        <!-- Left: scheduled + practice -->
        <div class="card">
          <div style="display:flex;justify-content:space-between;align-items:center;gap:12px">
            <div>
              <div style="font-weight:800;font-size:1.05rem">Scheduled exams</div>
              <div class="muted-small">Exams scheduled by the school for your class</div>
            </div>
            <div style="display:flex;gap:8px;align-items:center">
              <input type="search" id="examSearch" placeholder="Search exams..." style="padding:8px;border-radius:8px;border:1px solid #e6e9ef" />
              <button class="btn ghost" id="refreshBtn">Refresh</button>
              <button class="btn ghost" id="historyBtn">History</button>
            </div>
          </div>

          <div style="margin-top:12px" id="scheduledWrap">
            <div class="exam-grid" id="examGrid" aria-live="polite" aria-label="Scheduled exams"></div>
            <div id="noExams" class="empty" style="display:none;margin-top:12px">No scheduled exams found for your class.</div>
          </div>

          <hr style="margin:14px 0;border:none;border-top:1px solid #eef3ff" />

          <div>
            <div style="display:flex;justify-content:space-between;align-items:center">
              <div style="font-weight:800">Practice & AI quizzes</div>
              <div class="muted-small">Try practice sets or generate AI-based quizzes</div>
            </div>

            <div style="margin-top:12px" class="panel-list">
              <div class="practice-card" aria-label="Practice questions">
                <div style="font-weight:800">Practice Questions</div>
                <div class="muted-small">Choose curated topic-based practice sets</div>
                <label class="muted-small" for="practiceSubject">Subject</label>
                <select id="practiceSubject" style="width:100%;padding:8px;border-radius:8px;border:1px solid #e6e9ef"></select>
                <div style="display:flex;gap:8px;margin-top:8px">
                  <button class="btn" id="startPracticeBtn">Start Practice</button>
                  <button class="btn ghost" id="browsePracticeBtn">Browse Sets</button>
                </div>
                <div class="muted-small" style="margin-top:8px">Practice is untimed by default unless you start a timed session.</div>
              </div>

              <div class="practice-card" aria-label="AI generated quiz">
                <div style="font-weight:800">AI-generated Quiz</div>
                <div class="muted-small">Customize topic, difficulty & length ‚Äî generate instantly</div>

                <label class="muted-small" for="aiTopic">Topic</label>
                <input id="aiTopic" placeholder="e.g. Photosynthesis" style="width:100%;padding:8px;border-radius:8px;border:1px solid #e6e9ef" />

                <div style="display:flex;gap:8px;margin-top:8px">
                  <select id="aiDifficulty" style="flex:1;padding:8px;border-radius:8px;border:1px solid #e6e9ef">
                    <option value="easy">Easy</option><option value="medium" selected>Medium</option><option value="hard">Hard</option>
                  </select>
                  <select id="aiCount" style="width:100px;padding:8px;border-radius:8px;border:1px solid #e6e9ef">
                    <option>5</option><option selected>10</option><option>20</option>
                  </select>
                </div>

                <div style="display:flex;gap:8px;margin-top:8px">
                  <button class="btn" id="genAiBtn">Generate (server)</button>
                  <button class="btn ghost" id="previewAiBtn">Details</button>
                </div>

                <div id="aiStatus" class="muted-small" style="margin-top:8px">No AI quiz generated yet.</div>

                <hr style="margin:10px 0;border:none;border-top:1px solid #eef3ff" />

                <div style="font-weight:700">My AI practice</div>
                <div class="muted-small" style="margin-top:8px">Generated quizzes you can start</div>
                <div id="myAiList" style="margin-top:8px"></div>
              </div>
            </div>
          </div>
        </div>

        <!-- Right: details, map and quick actions -->
        <aside class="card">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div style="font-weight:800">Session & quick actions</div>
            <div class="muted-small">Tools</div>
          </div>

          <div style="margin-top:12px">
            <div style="font-weight:700">Current session</div>
            <div class="muted-small" id="timetableMeta">‚Äî</div>
            <div style="margin-top:10px" id="nextExam">Next: ‚Äî</div>
          </div>

          <div style="margin-top:14px">
            <div style="font-weight:700;margin-bottom:8px">Quick links</div>
            <div style="display:flex;flex-direction:column;gap:8px">
              <button class="btn ghost" onclick="navTo('timetable')">View Timetable</button>
              <button class="btn ghost" onclick="navTo('assignments')">My Assignments</button>
              <button class="btn" id="startManualPractice">Start Timed Practice</button>
            </div>
          </div>

          <div style="margin-top:14px">
            <div style="font-weight:700">Help & rules</div>
            <ul class="muted-small" style="margin-top:8px">
              <li>Ensure a stable connection for timed exams</li>
              <li>Practice quizzes are private and do not affect grades</li>
              <li>AI quizzes are generated by the server; review before starting</li>
            </ul>
          </div>
        </aside>
      </div>
    </main>

    <!-- Exam detail modal: show details ONLY and option to Start (no previewing questions) -->
    <div class="modal" id="examModal" role="dialog" aria-modal="true" aria-hidden="true" aria-labelledby="examModalTitle">
      <div class="panel" role="document">
        <div class="head">
          <div>
            <div id="examModalTitle" style="font-weight:800">Exam details</div>
            <div class="muted-small" id="examModalSub">Exam information</div>
          </div>
          <div>
            <button class="btn ghost" id="closeExamModalBtn">Close</button>
          </div>
        </div>

        <div class="body" id="examModalBody">
          <!-- populated by JS: details + Start button (server-verified start) -->
        </div>
      </div>
    </div>

    <!-- Practice modal (keeps only start option) -->
    <div class="modal" id="practiceModal" role="dialog" aria-modal="true" aria-hidden="true" aria-labelledby="practiceModalTitle">
      <div class="panel" role="document">
        <div class="head">
          <div>
            <div id="practiceModalTitle" style="font-weight:800">Practice set</div>
            <div class="muted-small" id="practiceModalSub">Start untimed or timed practice</div>
          </div>
          <div>
            <button class="btn ghost" id="closePracticeModalBtn">Close</button>
          </div>
        </div>

        <div class="body" id="practiceModalBody"></div>
      </div>
    </div>

    <!-- AI details modal (no question preview) -->
    <div class="modal" id="aiModal" role="dialog" aria-modal="true" aria-hidden="true" aria-labelledby="aiModalTitle">
      <div class="panel" role="document">
        <div class="head">
          <div>
            <div id="aiModalTitle" style="font-weight:800">AI Quiz</div>
            <div class="muted-small" id="aiModalSub">Start generated quiz or regenerate</div>
          </div>
          <div>
            <button class="btn ghost" id="closeAiModalBtn">Close</button>
          </div>
        </div>

        <div class="body" id="aiModalBody"></div>
      </div>
    </div>

    <!-- Loader included at bottom so it's on top -->
  </div>

  <script>
    (function () {
      const API_BASE = 'https://examguide.onrender.com/api';
      const TOKEN = localStorage.getItem('eg_token') || null;

      // DOM
      const pageLoader = document.getElementById('pageLoader');
      const loaderMsg = document.getElementById('loaderMsg');
      const loaderSub = document.getElementById('loaderSub');

      const examGrid = document.getElementById('examGrid');
      const noExams = document.getElementById('noExams');
      const refreshBtn = document.getElementById('refreshBtn');
      const historyBtn = document.getElementById('historyBtn');
      const examSearch = document.getElementById('examSearch');

      const practiceSubject = document.getElementById('practiceSubject');
      const startPracticeBtn = document.getElementById('startPracticeBtn');
      const browsePracticeBtn = document.getElementById('browsePracticeBtn');

      const aiTopic = document.getElementById('aiTopic');
      const aiDifficulty = document.getElementById('aiDifficulty');
      const aiCount = document.getElementById('aiCount');
      const genAiBtn = document.getElementById('genAiBtn');
      const previewAiBtn = document.getElementById('previewAiBtn');
      const aiStatus = document.getElementById('aiStatus');
      const myAiList = document.getElementById('myAiList');

      const examModal = document.getElementById('examModal');
      const examModalBody = document.getElementById('examModalBody');
      const closeExamModalBtn = document.getElementById('closeExamModalBtn');

      const practiceModal = document.getElementById('practiceModal');
      const practiceModalBody = document.getElementById('practiceModalBody');
      const closePracticeModalBtn = document.getElementById('closePracticeModalBtn');

      const aiModal = document.getElementById('aiModal');
      const aiModalBody = document.getElementById('aiModalBody');
      const closeAiModalBtn = document.getElementById('closeAiModalBtn');

      const hamburger = document.getElementById('hamburger');
      const sidebar = document.getElementById('sidebar');
      const overlay = document.getElementById('overlay');

      const studentNameEl = document.getElementById('studentName');
      const studentClassEl = document.getElementById('studentClass');
      const topbarAvatar = document.getElementById('topbarAvatar');
      const termInfo = document.getElementById('termInfo');

      // state
      let scheduledExams = []; // loaded from backend
      let myAiQuizzes = []; // loaded from backend or local
      let subjectsList = []; // for practiceSubject options

      // helpers
      function showLoader(msg, sub) {
        if (msg) loaderMsg.textContent = msg;
        if (sub) loaderSub.textContent = sub;
        pageLoader.classList.add('active');
        pageLoader.setAttribute('aria-hidden', 'false');
      }
      function hideLoader() {
        pageLoader.classList.remove('active');
        pageLoader.setAttribute('aria-hidden', 'true');
      }

      function headers(contentType='application/json') {
        const h = {};
        if (contentType) h['Content-Type'] = contentType;
        if (TOKEN) h['Authorization'] = 'Bearer ' + TOKEN;
        return h;
      }

      async function tryFetchCandidates(candidates, options = {}) {
        for (const url of candidates) {
          if (!url) continue;
          try {
            const res = await fetch(url, options);
            if (!res.ok) continue;
            const data = await res.json();
            // Accept many shapes
            if (Array.isArray(data)) return data;
            if (Array.isArray(data.exams)) return data.exams;
            if (Array.isArray(data.data)) return data.data;
            if (Array.isArray(data.results)) return data.results;
            if (Array.isArray(data.items)) return data.items;
            // single object
            if (data && (data.id || data._id)) return [data];
          } catch (err) {
            console.warn('candidate fetch failed', url, err);
          }
        }
        return null;
      }

      // Load logged in user from localStorage and optionally /me endpoint
      function getLocalApp() {
        try { return JSON.parse(localStorage.getItem('eg_application') || 'null') || null; } catch { return null; }
      }
      async function fetchProfile() {
        const local = getLocalApp();
        if (!TOKEN) {
          // use local if present
          return local;
        }
        const candidates = [
          `${API_BASE}/me`,
          `${API_BASE}/profile`,
          `${API_BASE}/users/me`
        ];
        for (const url of candidates) {
          try {
            const res = await fetch(url, { headers: headers() });
            if (!res.ok) continue;
            const data = await res.json();
            // merge into local object
            return data.user || data || local;
          } catch (err) { /* ignore */ }
        }
        return local;
      }

      // Fetch scheduled exams for student's class
      async function fetchScheduledExams(className) {
        const candidates = [
          `${API_BASE}/exams?class=${encodeURIComponent(className || '')}&status=scheduled`,
          `${API_BASE}/exams/scheduled?class=${encodeURIComponent(className || '')}`,
          `${API_BASE}/exams?status=scheduled`,
          `${API_BASE}/exams`
        ];
        return await tryFetchCandidates(candidates, { headers: headers() });
      }

      // Fetch subjects (for practice selector)
      async function fetchSubjects() {
        const candidates = [
          `${API_BASE}/subjects`,
          `${API_BASE}/programs/subjects`,
          `${API_BASE}/curriculum/subjects`
        ];
        return await tryFetchCandidates(candidates, { headers: headers() });
      }

      // Fetch AI quizzes (server) or fall back to local storage
      async function fetchMyAi() {
        if (TOKEN) {
          const candidates = [
            `${API_BASE}/ai/quizzes?mine=true`,
            `${API_BASE}/me/ai-quizzes`,
            `${API_BASE}/ai/quizzes`
          ];
          const data = await tryFetchCandidates(candidates, { headers: headers() });
          if (Array.isArray(data)) return data;
        }
        // fallback to localStorage
        try { return JSON.parse(localStorage.getItem('eg_ai_quizzes') || '[]'); } catch { return []; }
      }

      function persistLocalAi(list) {
        try { localStorage.setItem('eg_ai_quizzes', JSON.stringify(list || [])); } catch {}
      }

      // AI generate: prefer server endpoint, fallback to client simulation
      async function generateAiQuiz(topic, difficulty, count) {
        // attempt server
        if (TOKEN) {
          const candidates = [
            `${API_BASE}/ai/generate`,
            `${API_BASE}/ai/quizzes`,
            `${API_BASE}/ai/generate-quiz`
          ];
          const payload = { topic, difficulty, count };
          for (const url of candidates) {
            try {
              const res = await fetch(url, { method:'POST', headers: headers(), body: JSON.stringify(payload) });
              if (!res.ok) continue;
              const data = await res.json();
              // expected shape: { ok:true, quizId, quiz (optional) }
              return data;
            } catch (err) { console.warn('ai generation candidate failed', url, err); }
          }
        }

        // fallback simulation
        const simulated = [];
        for (let i=1;i<=count;i++) simulated.push({ id:`AI-SIM-${Date.now()}-${i}`, q:`${topic} ‚Äî AI question ${i} (${difficulty})`, choices:['A','B','C','D'] });
        return { ok:true, quiz: simulated, quizId: 'SIM-' + Math.random().toString(36).slice(2,8).toUpperCase() };
      }

      // Render functions
      function renderExams() {
        const q = (examSearch.value || '').trim().toLowerCase();
        examGrid.innerHTML = '';
        const className = (studentClassEl.textContent || '').split('‚Äî')[0].trim() || '';
        const exams = (scheduledExams || []).filter(e => {
          if (e.status && e.status.toLowerCase() === 'archived') return false;
          if (className && e.class && e.class !== className) return false;
          if (!q) return true;
          return ((e.title||'') + ' ' + (e.subject||'') + ' ' + (e.date||'')).toLowerCase().includes(q);
        });

        if (!exams.length) { noExams.style.display = ''; } else { noExams.style.display = 'none'; }

        exams.forEach(ex => {
          const el = document.createElement('article');
          el.className = 'exam-card';
          el.innerHTML = `
            <div>
              <h4>${escapeHtml(ex.title || ex.name || 'Untitled')}</h4>
              <div class="exam-meta">${escapeHtml(ex.subject || '')} ‚Ä¢ ${formatDate(ex.date)} ‚Ä¢ ${escapeHtml(ex.start || '')} ‚Ä¢ ${escapeHtml(String(ex.durationMinutes || ex.duration || ''))} mins</div>
              <div class="exam-meta" style="margin-top:8px">Venue: ${escapeHtml(ex.venue || ex.location || '‚Äî')}</div>
            </div>
            <div class="actions">
              <button class="btn ghost detailsBtn" data-id="${escapeAttr(ex.id || ex._id || '')}">Details</button>
              <button class="btn startBtn" data-id="${escapeAttr(ex.id || ex._id || '')}">Start Exam</button>
            </div>
          `;
          examGrid.appendChild(el);
        });
      }

      // Render subjects select
      function renderSubjects(list) {
        subjectsList = Array.isArray(list) ? list.map(s => (typeof s === 'string' ? { name: s } : s)) : [];
        practiceSubject.innerHTML = '';
        subjectsList.forEach(s => {
          const opt = document.createElement('option');
          opt.value = s.code || s.name || s.subject || s.title || s.id || s._id || s;
          opt.textContent = s.name || s.title || s.subject || opt.value;
          practiceSubject.appendChild(opt);
        });
        if (!practiceSubject.options.length) {
          const opt = document.createElement('option'); opt.text = 'General'; practiceSubject.appendChild(opt);
        }
      }

      // Render AI list (server-backed)
      function renderMyAi(list) {
        myAiQuizzes = Array.isArray(list) ? list : [];
        myAiList.innerHTML = '';
        if (!myAiQuizzes.length) {
          myAiList.innerHTML = '<div class="muted-small">No AI quizzes yet.</div>';
          return;
        }
        myAiQuizzes.slice(0, 20).forEach(item => {
          const el = document.createElement('div');
          el.style.display='flex'; el.style.justifyContent='space-between'; el.style.alignItems='center'; el.style.gap='8px'; el.style.marginTop='8px';
          const left = document.createElement('div');
          left.innerHTML = `<div style="font-weight:800">${escapeHtml(item.topic || item.title || 'AI Quiz')}</div><div class="muted-small">${escapeHtml(item.difficulty || item.level || '')} ‚Ä¢ ${new Date(item.createdAt || item.created || item.date || Date.now()).toLocaleString()}</div>`;
          const right = document.createElement('div');
          right.style.display='flex'; right.style.gap='8px';
          const detailsBtn = document.createElement('button'); detailsBtn.className = 'btn ghost'; detailsBtn.textContent = 'Details'; detailsBtn.dataset.id = item.id || item.quizId || item._id;
          const startBtn = document.createElement('button'); startBtn.className = 'btn'; startBtn.textContent = 'Start'; startBtn.dataset.id = item.id || item.quizId || item._id;
          right.appendChild(detailsBtn); right.appendChild(startBtn);
          el.appendChild(left); el.appendChild(right);
          myAiList.appendChild(el);

          // handlers
          detailsBtn.addEventListener('click', ()=> openAiDetails(item));
          startBtn.addEventListener('click', ()=> startAi(item));
        });
      }

      // Utils
      function escapeHtml(s) { return String(s == null ? '' : s).replace(/[&<>"']/g, function (m) { return ({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' })[m]; }); }
      function escapeAttr(s) { return String(s == null ? '' : s).replace(/["']/g,''); }
      function formatDate(d) { const dt = new Date(d); if (isNaN(dt)) return d || '‚Äî'; return dt.toLocaleDateString(); }

      // MODALS: exam details (no question preview)
      function openExamModal(id) {
        showLoader('Loading exam details...', 'Contacting server');
        (async () => {
          // attempt to fetch details from server
          let detail = (scheduledExams || []).find(x => (x.id || x._id) === id) || null;
          if (TOKEN) {
            const candidates = [
              `${API_BASE}/exams/${encodeURIComponent(id)}`,
              `${API_BASE}/exams/details/${encodeURIComponent(id)}`
            ];
            for (const url of candidates) {
              try {
                const res = await fetch(url, { headers: headers() });
                if (!res.ok) continue;
                const data = await res.json();
                detail = data.exam || data || detail;
                break;
              } catch (err) { /* continue */ }
            }
          }
          hideLoader();
          if (!detail) {
            examModalBody.innerHTML = `<div class="muted-small">Exam details could not be loaded.</div>`;
          } else {
            examModalBody.innerHTML = `
              <div style="display:grid;grid-template-columns:1fr 220px;gap:12px">
                <div>
                  <div style="font-weight:800;font-size:1.05rem">${escapeHtml(detail.title || detail.name || 'Untitled')}</div>
                  <div class="muted-small" style="margin-top:6px">${escapeHtml(detail.subject || '')} ‚Ä¢ ${escapeHtml(detail.class || detail.forClass || '')}</div>
                  <div style="margin-top:12px"><strong>When:</strong> ${formatDate(detail.date)} ${escapeHtml(detail.start || '')}</div>
                  <div style="margin-top:6px"><strong>Duration:</strong> ${escapeHtml(String(detail.durationMinutes || detail.duration || '‚Äî'))} minutes</div>
                  <div style="margin-top:6px"><strong>Total marks:</strong> ${escapeHtml(String(detail.totalMarks || detail.maxScore || '‚Äî'))}</div>
                  <div style="margin-top:12px" class="muted-small">${escapeHtml(detail.instructions || detail.note || 'Please ensure a stable connection.')}</div>
                </div>
                <aside style="background:#f8fbff;padding:12px;border-radius:8px">
                  <div style="font-weight:800">Actions</div>
                  <div style="margin-top:10px;display:flex;flex-direction:column;gap:8px">
                    <button class="btn startNow" data-id="${escapeAttr(id)}">Start Exam</button>
                    <button class="btn ghost practiceLike" data-subject="${escapeAttr(detail.subject || '')}">Practice similar</button>
                  </div>
                </aside>
              </div>
            `;
            // Attach handlers
            setTimeout(()=> {
              Array.from(examModal.querySelectorAll('.startNow')).forEach(b => b.addEventListener('click', () => {
                examModal.classList.remove('active'); examModal.setAttribute('aria-hidden','true');
                startExam(b.dataset.id);
              }, { once:true }));
              Array.from(examModal.querySelectorAll('.practiceLike')).forEach(b => b.addEventListener('click', ()=> {
                examModal.classList.remove('active'); examModal.setAttribute('aria-hidden','true');
                openPracticeForSubject(b.dataset.subject);
              }, { once:true }));
            }, 10);
          }
          examModal.classList.add('active'); examModal.setAttribute('aria-hidden','false');
        })();
      }

      // AI details modal (no question preview). Offers Start and Regenerate
      function openAiDetails(item) {
        aiModalBody.innerHTML = `<div style="font-weight:800">${escapeHtml(item.topic || item.title || 'AI Quiz')}</div>
          <div class="muted-small" style="margin-top:6px">${escapeHtml(item.difficulty || item.level || '')} ‚Ä¢ ${new Date(item.createdAt || item.created || Date.now()).toLocaleString()}</div>
          <div style="margin-top:12px">${escapeHtml(item.description || '')}</div>
          <div style="display:flex;gap:8px;margin-top:12px">
            <button class="btn" id="aiStartNow" data-id="${escapeAttr(item.id || item.quizId || '')}">Start</button>
            <button class="btn ghost" id="aiRegenerate" data-topic="${escapeAttr(item.topic || '')}" data-diff="${escapeAttr(item.difficulty || item.level || 'medium')}" data-count="${escapeAttr(item.count || 10)}">Regenerate</button>
            <button class="btn ghost" id="aiDelete" data-id="${escapeAttr(item.id || item.quizId || '')}">Delete</button>
          </div>
        `;
        // handlers
        aiModal.querySelector('#aiStartNow').addEventListener('click', (e) => {
          const id = e.currentTarget.dataset.id;
          // start by redirecting to session with ai id
          window.location.href = `marketting/cbt-session.html?ai=${encodeURIComponent(id)}`;
        }, { once:true });

        aiModal.querySelector('#aiRegenerate').addEventListener('click', async (e) => {
          const t = e.currentTarget.dataset.topic;
          const d = e.currentTarget.dataset.diff;
          const c = Number(e.currentTarget.dataset.count) || 10;
          aiModal.classList.remove('active'); aiModal.setAttribute('aria-hidden','true');
          await handleGenerateAi(t, d, c);
        });

        aiModal.querySelector('#aiDelete').addEventListener('click', (e) => {
          const id = e.currentTarget.dataset.id;
          // remove from local/db
          myAiQuizzes = myAiQuizzes.filter(q => (q.id || q.quizId) !== id);
          persistLocalAi(myAiQuizzes);
          renderMyAi(myAiQuizzes);
          aiModal.classList.remove('active'); aiModal.setAttribute('aria-hidden','true');
        }, { once:true });

        aiModal.classList.add('active'); aiModal.setAttribute('aria-hidden','false');
      }

      // Start AI (from list)
      function startAi(itemOrId) {
        const id = typeof itemOrId === 'string' ? itemOrId : (itemOrId.id || itemOrId.quizId);
        // redirect to cbt-session with ai param
        window.location.href = `marketting/cbt-session.html?ai=${encodeURIComponent(id)}`;
      }

      // Start exam: attempt to request server to create session, then redirect to exam-in-session
      async function startExam(id) {
        try {
          showLoader('Starting exam...', 'Requesting server to create session');
          // preferred endpoints
          const candidates = [
            `${API_BASE}/exams/${encodeURIComponent(id)}/start`,
            `${API_BASE}/exams/start`,
            `${API_BASE}/session/start`
          ];
          for (const url of candidates) {
            try {
              const res = await fetch(url, { method:'POST', headers: headers(), body: JSON.stringify({ examId: id }) });
              if (!res.ok) continue;
              const data = await res.json();
              // expect redirect url or session token
              hideLoader();
              if (data && data.sessionUrl) {
                window.location.href = data.sessionUrl;
                return;
              }
              // fallback to exam-in-session page with exam param
              window.location.href = `marketting/exam-in-session.html?exam=${encodeURIComponent(id)}`;
              return;
            } catch (err) { /* continue */ }
          }
          // if all server attempts fail, fallback to immediate redirect
          hideLoader();
          window.location.href = `marketting/exam-in-session.html?exam=${encodeURIComponent(id)}`;
        } catch (err) {
          hideLoader();
          console.error('startExam failed', err);
          alert('Could not start exam. Try again.');
        }
      }

      // Practice: show details + start option
      function openPracticeForSubject(subject) {
        practiceModalBody.innerHTML = `<div style="font-weight:800">${escapeHtml(subject)} ‚Äî Practice</div>
          <div class="muted-small" style="margin-top:8px">Start an untimed practice or a timed practice session.</div>
          <div style="display:flex;gap:8px;margin-top:12px">
            <button class="btn" id="practiceStartNow">Start Untimed</button>
            <button class="btn ghost" id="practiceStartTimed">Start Timed (10min)</button>
          </div>
        `;
        practiceModal.querySelector('#practiceStartNow').addEventListener('click', ()=> {
          window.location.href = `marketting/cbt-session.html?practice=true&subject=${encodeURIComponent(subject)}`;
        }, { once:true });
        practiceModal.querySelector('#practiceStartTimed').addEventListener('click', ()=> {
          window.location.href = `marketting/cbt-session.html?practice=true&subject=${encodeURIComponent(subject)}&timed=10`;
        }, { once:true });
        practiceModal.classList.add('active'); practiceModal.setAttribute('aria-hidden','false');
      }

      // AI generation handler
      async function handleGenerateAi(topic, difficulty, count) {
        showLoader('Generating AI quiz...', 'This runs on the server (may take a few seconds)');
        try {
          const res = await generateAiQuiz(topic, difficulty, count);
          hideLoader();
          if (!res || !res.ok) {
            aiStatus.textContent = 'AI generation failed (server).';
            return;
          }

          const quizId = res.quizId || (res.quiz && (res.quiz.id || ('SIM-' + Math.random().toString(36).slice(2,8).toUpperCase())));
          const entry = {
            id: quizId,
            topic,
            difficulty,
            count,
            createdAt: new Date().toISOString(),
            // server may return metadata
            meta: res.meta || {}
          };

          // store returned questions if provided
          if (res.quiz && Array.isArray(res.quiz)) {
            try { sessionStorage.setItem('eg_ai_quiz_' + entry.id, JSON.stringify(res.quiz)); } catch {}
          }

          // save to server-local list: prefer server's returned list; otherwise persist locally
          try {
            // push to server list if server returned an id and endpoint exists
            if (TOKEN && res.quizId) {
              // try to notify server to persist (best-effort)
              await fetch(`${API_BASE}/ai/quizzes/${encodeURIComponent(res.quizId)}/save`, { method:'POST', headers: headers(), body: JSON.stringify({ topic, difficulty, count }) }).catch(()=>null);
            }
          } catch (err) {}

          // merge into local store and render
          myAiQuizzes.unshift(entry);
          persistLocalAi(myAiQuizzes);
          renderMyAi(myAiQuizzes);
          aiStatus.textContent = `Generated ${count} questions on "${topic}" (${difficulty}).`;
        } catch (err) {
          hideLoader();
          console.error('AI generation failed', err);
          aiStatus.textContent = 'AI generation failed.';
        }
      }

      // generateAiQuiz wrapper to call backend or fallback
      async function generateAiQuiz(topic, difficulty, count) {
        return await (async () => {
          // call server
          return await (async () => {
            if (!TOKEN) return null;
            const candidates = [
              `${API_BASE}/ai/generate`,
              `${API_BASE}/ai/quizzes/generate`,
              `${API_BASE}/ai/generate-quiz`
            ];
            const payload = { topic, difficulty, count };
            for (const url of candidates) {
              try {
                const res = await fetch(url, { method:'POST', headers: headers(), body: JSON.stringify(payload) });
                if (!res.ok) continue;
                const data = await res.json();
                return data;
              } catch (err) { console.warn('ai candidate failed', url, err); }
            }
            return null;
          })();
        })() || { ok:true, quizId: 'SIM-' + Math.random().toString(36).slice(2,8).toUpperCase(), quiz: (()=>{ const arr=[]; for(let i=1;i<=count;i++) arr.push({id:`SIM-${i}`, q:`${topic} ‚Äî AI question ${i}`, choices:['A','B','C','D']}); return arr; })() };
      }

      // INITIALIZATION: fetch profile, exams, AI list, subjects
      async function init() {
        showLoader('Loading...', 'Fetching profile, exams and AI quizzes');
        try {
          // fetch profile
          const profile = await (async () => {
            const local = (function(){ try { return JSON.parse(localStorage.getItem('eg_application')||'null') || null; } catch { return null; } })();
            if (!TOKEN) return local || {};
            const candidates = [`${API_BASE}/me`, `${API_BASE}/profile`, `${API_BASE}/users/me`];
            for (const url of candidates) {
              try {
                const res = await fetch(url, { headers: headers() });
                if (!res.ok) continue;
                const data = await res.json();
                return data.user || data || local || {};
              } catch (err) { /* ignore */ }
            }
            return local || {};
          })();

          // populate profile UI
          if (profile) {
            studentNameEl.textContent = (profile.firstName || profile.name || profile.username || 'Student') + (profile.lastName ? (' ' + profile.lastName) : '');
            studentClassEl.textContent = profile.program || profile.class || profile.level || '';
            if (profile.profilePic) topbarAvatar.src = profile.profilePic;
            if (profile.session) termInfo.textContent = profile.session;
          }

          const studentClass = profile.program || profile.class || profile.level || '';

          // fetch scheduled exams and subjects in parallel
          const [examsData, subjectsData, aiData] = await Promise.all([
            fetchScheduledExams(studentClass).catch(()=>null),
            fetchSubjects().catch(()=>null),
            fetchMyAi().catch(()=>null)
          ]);

          scheduledExams = Array.isArray(examsData) ? examsData : [];
          renderExams();

          renderSubjects(subjectsData || []);
          myAiQuizzes = Array.isArray(aiData) ? aiData : (function(){ try { return JSON.parse(localStorage.getItem('eg_ai_quizzes')||'[]'); } catch { return []; } })();
          renderMyAi(myAiQuizzes);

        } catch (err) {
          console.error('initialization error', err);
        } finally {
          hideLoader();
        }
      }

      // Wire UI handlers
      refreshBtn.addEventListener('click', ()=> init());
      historyBtn.addEventListener('click', ()=> { window.location.href = '/exam-history.html'; });
      examSearch.addEventListener('input', ()=> renderExams());

      // exam grid click delegation
      examGrid.addEventListener('click', (e)=> {
        const t = e.target;
        if (t.matches('.detailsBtn')) {
          const id = t.dataset.id;
          openExamModal(id);
        }
        if (t.matches('.startBtn')) {
          startExam(t.dataset.id);
        }
      });

      // practice handlers
      startPracticeBtn.addEventListener('click', ()=> {
        const subj = practiceSubject.value;
        openPracticeForSubject(subj);
      });
      browsePracticeBtn.addEventListener('click', ()=> { window.location.href = '/practice-library.html'; });

      // AI handlers
      genAiBtn.addEventListener('click', async ()=> {
        const topic = (aiTopic.value || '').trim() || 'General';
        const diff = (aiDifficulty.value || 'medium');
        const count = Number(aiCount.value) || 10;
        genAiBtn.disabled = true;
        aiStatus.textContent = 'Generating...';
        try {
          await handleGenerateAi(topic, diff, count);
        } finally {
          genAiBtn.disabled = false;
        }
      });

      previewAiBtn.addEventListener('click', ()=> {
        // Show list of AI quizzes (no question preview)
        if (!myAiQuizzes.length) return alert('No AI quizzes available. Generate one first.');
        // open modal showing first quiz details (or allow user to select)
        openAiDetails(myAiQuizzes[0]);
      });

      // modal close
      closeExamModalBtn.addEventListener('click', ()=> { examModal.classList.remove('active'); examModal.setAttribute('aria-hidden','true'); });
      closePracticeModalBtn.addEventListener('click', ()=> { practiceModal.classList.remove('active'); practiceModal.setAttribute('aria-hidden','true'); });
      closeAiModalBtn.addEventListener('click', ()=> { aiModal.classList.remove('active'); aiModal.setAttribute('aria-hidden','true'); });

      // sidebar mobile toggles
      hamburger.addEventListener('click', ()=> {
        sidebar.classList.remove('hidden');
        sidebar.classList.add('open');
        sidebar.setAttribute('aria-hidden','false');
        overlay.classList.add('visible');
        overlay.setAttribute('aria-hidden','false');
        document.body.classList.add('no-scroll');
      });
      overlay.addEventListener('click', ()=> {
        sidebar.classList.remove('open');
        sidebar.classList.add('hidden');
        sidebar.setAttribute('aria-hidden','true');
        overlay.classList.remove('visible');
        overlay.setAttribute('aria-hidden','true');
        document.body.classList.remove('no-scroll');
      });

      // escape closes modals
      document.addEventListener('keydown', (e)=> {
        if (e.key === 'Escape') {
          document.querySelectorAll('.modal.active').forEach(m=> { m.classList.remove('active'); m.setAttribute('aria-hidden','true'); });
        }
      });

      // start
      init();

      // expose for debug
      window._eg_cbt = { scheduledExams, fetchScheduledExams, fetchMyAi, generateAiQuiz };

    })();
  </script>
</body>
</html>
