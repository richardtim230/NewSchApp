<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>CBT Exams | ExamGuard</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link href="https://fonts.googleapis.com/css?family=Inter:400,600,700&display=swap" rel="stylesheet">
  <link rel="icon" href="../logo.png">
  <style>
    :root{
      --bg-0:#f6f8ff; --bg-1:#eef2ff;
      --accent:#3b82f6; --accent-2:#6366f1; --muted:#6b7280;
      --card-bg:#ffffff; --radius:12px; --sidebar-w:300px;
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;font-family:Inter,system-ui,Arial; -webkit-font-smoothing:antialiased; background:linear-gradient(180deg,var(--bg-0),var(--bg-1)); color:#0b2a44}
    a{color:inherit;text-decoration:none}

    /* App layout */
    .app{display:flex;min-height:100vh;align-items:stretch}
    .overlay{position:fixed;inset:0;background:rgba(2,6,23,0.45);z-index:50;display:none}
    .overlay.visible{display:block}

    /* Sidebar (desktop shows instantly) */
    .sidebar{
      width:var(--sidebar-w); min-width:var(--sidebar-w);
      background:linear-gradient(180deg,#0f172a 0%, #1e3a8a 100%);
      color:#fff; padding:20px 16px; position:fixed; left:0; top:0; bottom:0; z-index:100;
      box-shadow:4px 0 28px rgba(15,23,42,0.12);
      display:flex; flex-direction:column; gap:14px; overflow-y:auto; transition:none;
    }
    /* Mobile overlay behavior */
    @media (max-width:720px) {
      .sidebar { transform: translateX(-110%); transition: transform .28s ease; position:fixed; width:86vw; min-width:86vw; }
      .sidebar.hidden { transform: translateX(-110%); }
      /* open declared after hidden so it wins */
      .sidebar.open { transform: translateX(0); box-shadow:0 24px 48px rgba(2,6,23,0.5); }
    }

    .brand{display:flex;gap:12px;align-items:center}
    .brand img{width:44px;height:44px;border-radius:10px;object-fit:cover;border:3px solid rgba(255,224,102,0.12);background:#fff}
    .brand .title{font-weight:800;font-size:1.05rem;color:#ffe066}
    .nav{display:flex;flex-direction:column;gap:8px;margin-top:6px}
    .nav a{display:flex;align-items:center;gap:10px;padding:12px;border-radius:10px;font-weight:700;font-size:1rem;color:#e6eefc}
    .nav a.active,.nav a:hover{background:rgba(255,255,255,0.04);color:#ffe066}

    .spacer{flex:1}
    .profile{display:flex;gap:12px;align-items:center;padding-top:10px;border-top:1px solid rgba(255,255,255,0.04)}
    .profile img{width:48px;height:48px;border-radius:10px;object-fit:cover;border:2px solid #ffe066}

    /* Topbar */
    .topbar{
      position:fixed; left:var(--sidebar-w); top:0; width:calc(100vw - var(--sidebar-w));
      z-index:90; display:flex; align-items:center; justify-content:space-between; gap:12px; padding:12px 14px;
      backdrop-filter: blur(6px); background: rgba(255,255,255,0.86);
      border-bottom:1px solid rgba(11,42,60,0.06); box-shadow:0 6px 18px rgba(11,42,60,0.04); min-height:64px;
    }
    @media (max-width:720px) { .topbar { left:0; width:100vw; padding:10px 12px; min-height:56px; } }

    .hamburger{ display:none; background:var(--accent); color:#fff; border:none; padding:9px 12px; border-radius:10px; cursor:pointer; font-weight:800; }
    @media (max-width:980px) { .hamburger{ display:inline-flex } }

    .page-title{ font-weight:800; font-size:1.05rem; color:var(--accent-2) }
    .small{ font-size:0.92rem; color:var(--muted) }

    /* Main content */
    .main{ margin-left:var(--sidebar-w); padding:20px; flex:1; transition: margin-left .28s; min-height:100vh; padding-top:90px; overflow-y:auto }
    @media (max-width:720px){ .main{ margin-left:0; padding:14px; padding-top:80px } }

    /* Layout blocks */
    .grid { display:grid; grid-template-columns: 2fr 1fr; gap:14px; align-items:start; }
    @media (max-width:980px) { .grid { grid-template-columns: 1fr } }

    .card { background:var(--card-bg); border-radius:12px; padding:14px; box-shadow:0 8px 20px rgba(11,42,60,0.04); border:1px solid rgba(11,42,60,0.03); }

    /* scheduled list */
    .exam-grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(220px,1fr)); gap:12px; }
    .exam-card { border-radius:12px; padding:12px; background:#fff; border:1px solid #eef3ff; display:flex; flex-direction:column; gap:8px; min-height:120px; }
    .exam-card h4 { margin:0; font-size:1rem; font-weight:800 }
    .exam-meta { font-size:0.92rem; color:var(--muted) }

    .actions { margin-top:auto; display:flex; gap:8px }

    /* practice & AI */
    .panel-list { display:grid; grid-template-columns:repeat(2,1fr); gap:12px; }
    @media (max-width:720px) { .panel-list { grid-template-columns: 1fr } }

    .practice-card { background:#fff; border-radius:12px; padding:12px; border:1px solid #eef3ff }

    /* modal */
    .modal { position: fixed; inset: 0; background: rgba(2,6,23,0.45); display: none; align-items:center; justify-content:center; z-index:9999; padding:16px; }
    .modal.active { display:flex; }
    .modal .panel { background:#fff; width:900px; max-width:95vw; border-radius:12px; overflow:hidden; box-shadow:0 20px 60px rgba(2,6,23,0.25); }
    .modal .head { padding:12px 16px; border-bottom:1px solid #eef3ff; background:#f8fbff; display:flex; justify-content:space-between; align-items:center; }
    .modal .body { padding:14px; max-height:72vh; overflow:auto }

    /* small helpers */
    .muted-small { font-size:0.9rem; color:var(--muted) }
    .btn { padding:9px 12px; border-radius:10px; border:none; cursor:pointer; background:linear-gradient(90deg,var(--accent),var(--accent-2)); color:#fff; font-weight:800; }
    .btn.ghost { background:transparent; color:var(--accent-2); border:1px solid rgba(59,130,246,0.08); }
    .btn.warn { background:linear-gradient(90deg,#f97316,#f59e0b); }
    .empty { padding:28px; text-align:center; color:var(--muted); border:1px dashed #eef3ff; border-radius:12px; }

    /* accessibility */
    :focus { outline: 3px solid rgba(99,102,241,0.18); outline-offset: 2px; border-radius:6px; }

  </style>
</head>
<body>
  <div class="app" id="app">
    <div class="overlay" id="overlay" aria-hidden="true"></div>

    <!-- Sidebar -->
    <aside class="sidebar" id="sidebar" aria-label="Main navigation" role="navigation">
      <div class="brand">
        <img src="../logo.png" alt="Logo">
        <div>
          <div class="title">Student Portal</div>
          <div class="small">Exams</div>
        </div>
      </div>

      <nav class="nav" id="nav" aria-label="Primary">
        <a href="student.html">üè† Dashboard</a>
        <a href="marketting/others.html">üîó Others</a>
        <a href="marketting/cbt-exam.html" class="active">üñ•Ô∏è CBT Exam</a>
        <a href="marketting/results.html">üìò Results</a>
      </nav>

      <div class="spacer" aria-hidden="true"></div>

      <div class="profile" role="region" aria-label="Student profile">
        <img src="../avatar.jpg" alt="Student avatar" id="studentAvatar">
        <div>
          <div class="name" id="studentName">Adaobi Chukwu</div>
          <div class="muted-small" id="studentClass">SS2 ‚Äî Biology</div>
        </div>
      </div>
    </aside>

    <!-- Topbar -->
    <div class="topbar" id="topbar">
      <div style="display:flex;gap:12px;align-items:center;">
        <button class="hamburger" id="hamburger" aria-label="Open menu">‚ò∞</button>
        <div>
          <div class="page-title">CBT ‚Äî Exams & Practice</div>
          <div class="small muted">Scheduled exams, practice sets & AI quizzes</div>
        </div>
      </div>

      <div style="display:flex;gap:12px;align-items:center;">
        <div class="small muted" id="termInfo">SS2 ‚Ä¢ Current session</div>
        <img src="../avatar.jpg" alt="You" style="width:44px;height:44px;border-radius:8px;border:2px solid #fff;" id="topbarAvatar">
      </div>
    </div>

    <!-- Main -->
    <main class="main" id="main" role="main" tabindex="-1">
      <div class="grid">
        <!-- Left: scheduled + practice -->
        <div class="card">
          <div style="display:flex;justify-content:space-between;align-items:center;gap:12px">
            <div>
              <div style="font-weight:800;font-size:1.05rem">Scheduled exams</div>
              <div class="muted-small">Exams scheduled by the school for your class</div>
            </div>
            <div style="display:flex;gap:8px;align-items:center">
              <input type="search" id="examSearch" placeholder="Search exams..." style="padding:8px;border-radius:8px;border:1px solid #e6e9ef" />
              <button class="btn ghost" id="refreshBtn">Refresh</button>
              <button class="btn ghost" id="historyBtn">History</button>
            </div>
          </div>

          <div style="margin-top:12px" id="scheduledWrap">
            <div class="exam-grid" id="examGrid" aria-live="polite" aria-label="Scheduled exams"></div>
            <div id="noExams" class="empty" style="display:none;margin-top:12px">No scheduled exams found for your class.</div>
          </div>

          <hr style="margin:14px 0;border:none;border-top:1px solid #eef3ff" />

          <div>
            <div style="display:flex;justify-content:space-between;align-items:center">
              <div style="font-weight:800">Practice & AI quizzes</div>
              <div class="muted-small">Try practice sets or generate AI-based quizzes</div>
            </div>

            <div style="margin-top:12px" class="panel-list">
              <div class="practice-card" aria-label="Practice questions">
                <div style="font-weight:800">Practice Questions</div>
                <div class="muted-small">Choose curated topic-based practice sets</div>
                <label class="muted-small" for="practiceSubject">Subject</label>
                <select id="practiceSubject" style="width:100%;padding:8px;border-radius:8px;border:1px solid #e6e9ef">
                  <option>Biology</option><option>Mathematics</option><option>English</option><option>Chemistry</option>
                </select>
                <div style="display:flex;gap:8px;margin-top:8px">
                  <button class="btn" id="startPracticeBtn">Start Practice</button>
                  <button class="btn ghost" id="browsePracticeBtn">Browse Sets</button>
                </div>
                <div class="muted-small" style="margin-top:8px">Practice is untimed by default unless you start a timed session.</div>
              </div>

              <div class="practice-card" aria-label="AI generated quiz">
                <div style="font-weight:800">AI-generated Quiz</div>
                <div class="muted-small">Customize topic, difficulty & length ‚Äî generate instantly</div>

                <label class="muted-small" for="aiTopic">Topic</label>
                <input id="aiTopic" placeholder="e.g. Photosynthesis" style="width:100%;padding:8px;border-radius:8px;border:1px solid #e6e9ef" />

                <div style="display:flex;gap:8px;margin-top:8px">
                  <select id="aiDifficulty" style="flex:1;padding:8px;border-radius:8px;border:1px solid #e6e9ef">
                    <option value="easy">Easy</option><option value="medium" selected>Medium</option><option value="hard">Hard</option>
                  </select>
                  <select id="aiCount" style="width:100px;padding:8px;border-radius:8px;border:1px solid #e6e9ef">
                    <option>5</option><option selected>10</option><option>20</option>
                  </select>
                </div>

                <div style="display:flex;gap:8px;margin-top:8px">
                  <button class="btn" id="genAiBtn">Generate</button>
                  <button class="btn ghost" id="previewAiBtn">Preview</button>
                </div>

                <div id="aiStatus" class="muted-small" style="margin-top:8px">No AI quiz generated yet.</div>

                <hr style="margin:10px 0;border:none;border-top:1px solid #eef3ff" />

                <div style="font-weight:700">My AI practice</div>
                <div class="muted-small" style="margin-top:8px">Generated quizzes you can schedule or start</div>
                <div id="myAiList" style="margin-top:8px"></div>
              </div>
            </div>
          </div>
        </div>

        <!-- Right: details, map and quick actions -->
        <aside class="card">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div style="font-weight:800">Session & quick actions</div>
            <div class="muted-small">Tools</div>
          </div>

          <div style="margin-top:12px">
            <div style="font-weight:700">Current session</div>
            <div class="muted-small" id="timetableMeta">SS2 ‚Ä¢ Sunrise High</div>
            <div style="margin-top:10px" id="nextExam">Next: ‚Äî</div>
          </div>

          <div style="margin-top:14px">
            <div style="font-weight:700;margin-bottom:8px">Quick links</div>
            <div style="display:flex;flex-direction:column;gap:8px">
              <button class="btn ghost" onclick="navTo('timetable')">View Timetable</button>
              <button class="btn ghost" onclick="navTo('assignments')">My Assignments</button>
              <button class="btn" id="startManualPractice">Start Timed Practice</button>
            </div>
          </div>

          <div style="margin-top:14px">
            <div style="font-weight:700">Help & rules</div>
            <ul class="muted-small" style="margin-top:8px">
              <li>Ensure a stable connection for timed exams</li>
              <li>Practice quizzes are private and do not affect grades</li>
              <li>AI quizzes are generated automatically; review carefully</li>
            </ul>
          </div>
        </aside>
      </div>
    </main>

    <!-- Exam detail modal -->
    <div class="modal" id="examModal" role="dialog" aria-modal="true" aria-hidden="true" aria-labelledby="examModalTitle">
      <div class="panel" role="document">
        <div class="head">
          <div>
            <div id="examModalTitle" style="font-weight:800">Exam details</div>
            <div class="muted-small" id="examModalSub">Exam information</div>
          </div>
          <div>
            <button class="btn ghost" id="closeExamModalBtn">Close</button>
          </div>
        </div>

        <div class="body" id="examModalBody">
          <!-- populated by JS -->
        </div>
      </div>
    </div>

    <!-- Practice modal -->
    <div class="modal" id="practiceModal" role="dialog" aria-modal="true" aria-hidden="true" aria-labelledby="practiceModalTitle">
      <div class="panel" role="document">
        <div class="head">
          <div>
            <div id="practiceModalTitle" style="font-weight:800">Practice set</div>
            <div class="muted-small" id="practiceModalSub">Sample practice questions</div>
          </div>
          <div>
            <button class="btn ghost" id="closePracticeModalBtn">Close</button>
          </div>
        </div>

        <div class="body" id="practiceModalBody"></div>
      </div>
    </div>

    <!-- AI preview modal -->
    <div class="modal" id="aiModal" role="dialog" aria-modal="true" aria-hidden="true" aria-labelledby="aiModalTitle">
      <div class="panel" role="document">
        <div class="head">
          <div>
            <div id="aiModalTitle" style="font-weight:800">AI Generated Quiz</div>
            <div class="muted-small" id="aiModalSub">Preview & start</div>
          </div>
          <div>
            <button class="btn ghost" id="closeAiModalBtn">Close</button>
          </div>
        </div>

        <div class="body" id="aiModalBody"></div>
      </div>
    </div>

  </div>

  <script>
    (function () {
      // API base remains same; adjust endpoints below to match backend if different.
      const API_BASE = 'https://examguide.onrender.com/api';
      const TOKEN = localStorage.getItem('eg_token') || null;

      // DOM
      const examGrid = document.getElementById('examGrid');
      const noExams = document.getElementById('noExams');
      const refreshBtn = document.getElementById('refreshBtn');
      const historyBtn = document.getElementById('historyBtn');
      const examSearch = document.getElementById('examSearch');

      const practiceSubject = document.getElementById('practiceSubject');
      const startPracticeBtn = document.getElementById('startPracticeBtn');
      const browsePracticeBtn = document.getElementById('browsePracticeBtn');

      const aiTopic = document.getElementById('aiTopic');
      const aiDifficulty = document.getElementById('aiDifficulty');
      const aiCount = document.getElementById('aiCount');
      const genAiBtn = document.getElementById('genAiBtn');
      const previewAiBtn = document.getElementById('previewAiBtn');
      const aiStatus = document.getElementById('aiStatus');
      const myAiList = document.getElementById('myAiList');

      const examModal = document.getElementById('examModal');
      const examModalBody = document.getElementById('examModalBody');
      const closeExamModalBtn = document.getElementById('closeExamModalBtn');

      const practiceModal = document.getElementById('practiceModal');
      const practiceModalBody = document.getElementById('practiceModalBody');
      const closePracticeModalBtn = document.getElementById('closePracticeModalBtn');

      const aiModal = document.getElementById('aiModal');
      const aiModalBody = document.getElementById('aiModalBody');
      const closeAiModalBtn = document.getElementById('closeAiModalBtn');

      const hamburger = document.getElementById('hamburger');
      const sidebar = document.getElementById('sidebar');
      const overlay = document.getElementById('overlay');

      // Data
      let scheduledExams = []; // will be populated from backend

      // My AI quizzes stored in localStorage under 'eg_ai_quizzes'
      function loadMyAi() {
        try { return JSON.parse(localStorage.getItem('eg_ai_quizzes') || '[]'); } catch { return []; }
      }
      function saveMyAi(list) { localStorage.setItem('eg_ai_quizzes', JSON.stringify(list)); }

      function formatDate(d) {
        const dt = new Date(d);
        if (isNaN(dt)) return d;
        return dt.toLocaleDateString();
      }

      // Fetch scheduled exams from backend
      async function fetchScheduledExams(className) {
        // Default endpoint: /exams?class=SS2&status=scheduled
        // Adjust path/params to match your backend API.
        const endpoint = `${API_BASE}/exams?status=scheduled${className ? ('&class=' + encodeURIComponent(className)) : ''}`;
        const headers = {};
        if (TOKEN) headers['Authorization'] = 'Bearer ' + TOKEN;
        try {
          const res = await fetch(endpoint, { headers });
          if (!res.ok) {
            // Backend returned an error ‚Äî treat as no exams
            console.warn('Failed to fetch exams', res.status);
            scheduledExams = [];
            return;
          }
          const data = await res.json();
          // Accept either { exams: [...] } or direct array
          scheduledExams = Array.isArray(data) ? data : (Array.isArray(data.exams) ? data.exams : []);
        } catch (err) {
          console.error('Network error fetching exams', err);
          scheduledExams = [];
        }
      }

      function renderExams() {
        const q = (examSearch.value || '').trim().toLowerCase();
        examGrid.innerHTML = '';
        const className = (document.getElementById('studentClass')?.textContent || '').split('‚Äî')[0].trim() || '';
        const exams = scheduledExams.filter(e => {
          // If backend provides class field, filter by class; otherwise include all
          const matchesClass = !e.class || !className || e.class === className;
          const notArchived = (e.status || '').toLowerCase() !== 'archived';
          const text = ((e.title || '') + ' ' + (e.subject || '') + ' ' + (e.date || '')).toLowerCase();
          const matchesQuery = !q || text.includes(q);
          return matchesClass && notArchived && matchesQuery;
        });

        if (!exams.length) { noExams.style.display = ''; } else { noExams.style.display = 'none'; }

        exams.forEach(ex => {
          const el = document.createElement('article');
          el.className = 'exam-card';
          el.innerHTML = `
            <div>
              <h4>${sanitize(ex.title || ex.name || 'Untitled exam')}</h4>
              <div class="exam-meta">${sanitize(ex.subject || '')} ‚Ä¢ ${formatDate(ex.date || '')} ‚Ä¢ ${sanitize(ex.start || '')} ‚Ä¢ ${sanitize(String(ex.durationMinutes || ex.duration || ''))} mins</div>
              <div class="exam-meta" style="margin-top:8px">Venue: ${sanitize(ex.venue || ex.location || '‚Äî')}</div>
            </div>
            <div class="actions">
              <button class="btn ghost detailsBtn" data-id="${sanitizeAttr(ex.id || ex._id || '')}">Details</button>
              <button class="btn startBtn" data-id="${sanitizeAttr(ex.id || ex._id || '')}">Start Exam</button>
            </div>
          `;
          examGrid.appendChild(el);
        });
      }

      // sanitize helpers (very small utility to avoid injecting raw HTML)
      function sanitize(str) { return String(str || '').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
      function sanitizeAttr(str) { return String(str || '').replace(/"/g,'').replace(/'/g,''); }

      async function openExamModal(id) {
        const ex = scheduledExams.find(x=> (x.id===id || x._id===id));
        if (!ex) {
          // Fallback: fetch single exam from backend
          try {
            const headers = {};
            if (TOKEN) headers['Authorization'] = 'Bearer ' + TOKEN;
            const res = await fetch(`${API_BASE}/exams/${encodeURIComponent(id)}`, { headers });
            if (res.ok) {
              const data = await res.json();
              // accept data.exam or data
              const examData = data.exam || data;
              if (examData) {
                showExamModal(examData);
                return;
              }
            }
          } catch (err) {
            console.error('Failed to fetch exam detail', err);
          }
          return;
        }
        showExamModal(ex);
      }

      function showExamModal(ex) {
        examModalBody.innerHTML = `
          <div style="display:grid;grid-template-columns:1fr 220px;gap:12px">
            <div>
              <div style="font-weight:800;font-size:1.05rem">${sanitize(ex.title || ex.name)}</div>
              <div class="muted-small" style="margin-top:6px">${sanitize(ex.subject || '')} ‚Ä¢ ${sanitize(ex.class || '')}</div>
              <div style="margin-top:12px"><strong>When:</strong> ${formatDate(ex.date)} at ${sanitize(ex.start || '')}</div>
              <div style="margin-top:6px"><strong>Duration:</strong> ${sanitize(String(ex.durationMinutes || ex.duration || ''))} minutes</div>
              <div style="margin-top:6px"><strong>Total marks:</strong> ${sanitize(String(ex.totalMarks || ex.maxMarks || '‚Äî'))}</div>
              <div style="margin-top:12px" class="muted-small">Please ensure you have a stable internet connection and are in a quiet environment.</div>
            </div>
            <aside style="background:#f8fbff;padding:12px;border-radius:8px">
              <div style="font-weight:800">Actions</div>
              <div style="margin-top:10px;display:flex;flex-direction:column;gap:8px">
                <button class="btn startNow" data-id="${sanitizeAttr(ex.id || ex._id)}">Start Exam</button>
                <button class="btn ghost practiceLike" data-subject="${sanitizeAttr(ex.subject || '')}">Practice similar</button>
              </div>
            </aside>
          </div>
        `;
        examModal.classList.add('active'); examModal.setAttribute('aria-hidden','false');
        setTimeout(()=> {
          document.querySelectorAll('.startNow').forEach(btn => btn.addEventListener('click', ()=> {
            examModal.classList.remove('active'); examModal.setAttribute('aria-hidden','true');
            startExam(btn.dataset.id);
          }, { once:true }));
          document.querySelectorAll('.practiceLike').forEach(btn => btn.addEventListener('click', ()=> {
            examModal.classList.remove('active'); examModal.setAttribute('aria-hidden','true');
            openPracticeForSubject(btn.dataset.subject);
          }, { once:true }));
        }, 30);
      }

      async function startExam(id) {
        if (!confirm('Start exam now? Your time will begin immediately.')) return;
        // Optionally verify with backend before redirecting
        try {
          const headers = { 'Content-Type': 'application/json' };
          if (TOKEN) headers['Authorization'] = 'Bearer ' + TOKEN;
          // Example check endpoint - adjust to match your API
          const checkRes = await fetch(`${API_BASE}/exams/${encodeURIComponent(id)}/start`, { method: 'POST', headers });
          if (checkRes.ok) {
            // server prepared/start exam session, redirect to exam session page
            const body = await checkRes.json();
            const sessionId = body.sessionId || id;
            window.location.href = `/marketting/cbt-session.html?exam=${encodeURIComponent(id)}&session=${encodeURIComponent(sessionId)}`;
            return;
          } else {
            // If server returns 4xx/5xx show message if possible
            const body = await checkRes.json().catch(()=>({ message: 'Could not start exam' }));
            alert(body.message || 'Unable to start exam. Please contact your administrator.');
            return;
          }
        } catch (err) {
          console.error('Network error starting exam', err);
          // fallback to redirect if you want:
          window.location.href = `/marketting/cbt-session.html?exam=${encodeURIComponent(id)}`;
        }
      }

      // Practice flows (kept local/simulated)
      function openPracticeForSubject(subject) {
        const questions = generatePracticeQuestions(subject, 6);
        showPracticeModal({ title: `${subject} ‚Äî Practice`, questions });
      }

      function generatePracticeQuestions(subject, n) {
        const out = [];
        for (let i=1;i<=n;i++){
          out.push({ id: `${subject}-P-${i}`, q: `${subject} ‚Äî Practice ${i}. Brief question text.`, choices:['A','B','C','D'] });
        }
        return out;
      }

      function showPracticeModal({ title, questions }) {
        practiceModalBody.innerHTML = `<div style="font-weight:800">${sanitize(title)}</div><div class="muted-small" style="margin-top:8px">Questions: ${questions.length}</div>`;
        const ol = document.createElement('ol'); ol.style.marginTop='12px';
        questions.forEach(q=>{
          const li = document.createElement('li'); li.style.marginBottom='10px';
          li.innerHTML = `<div style="font-weight:700">${sanitize(q.q)}</div><div class="muted-small">${sanitize(q.choices.join(' ‚Ä¢ '))}</div>`;
          ol.appendChild(li);
        });
        practiceModalBody.appendChild(ol);
        const actions = document.createElement('div'); actions.style.marginTop='12px';
        actions.innerHTML = `<button class="btn" id="practiceStartNow">Start practice session</button> <button class="btn ghost" id="practiceCloseNow">Close</button>`;
        practiceModalBody.appendChild(actions);
        document.getElementById('practiceStartNow').addEventListener('click', ()=> {
          // start untimed practice session -> redirect with practice param
          window.location.href = `/marketting/cbt-session.html?practice=true&subject=${encodeURIComponent(title)}`;
        }, { once:true });
        document.getElementById('practiceCloseNow').addEventListener('click', ()=> {
          practiceModal.classList.remove('active'); practiceModal.setAttribute('aria-hidden','true');
        }, { once:true });
        practiceModal.classList.add('active'); practiceModal.setAttribute('aria-hidden','false');
      }

      // AI generation - simulated client-side, persisted to localStorage
      let lastAiSet = null;
      function simulateAiGenerate(topic, difficulty, count) {
        const q = [];
        for (let i=1;i<=count;i++){
          q.push({ id:`AI-${Date.now()}-${i}`, q:`${topic || 'General'} ‚Äî AI question ${i} (${difficulty})`, choices:['A','B','C','D'] });
        }
        return q;
      }

      genAiBtn.addEventListener('click', ()=> {
        const topic = (aiTopic.value || '').trim() || 'General';
        const difficulty = aiDifficulty.value;
        const count = Number(aiCount.value) || 10;
        aiStatus.textContent = 'Generating...';
        genAiBtn.disabled = true;
        setTimeout(()=> {
          lastAiSet = simulateAiGenerate(topic, difficulty, count);
          aiStatus.textContent = `Generated ${lastAiSet.length} questions on "${topic}" (${difficulty}).`;
          genAiBtn.disabled = false;
          // Save to 'My AI quizzes' (persist)
          const list = loadMyAi();
          const token = Math.random().toString(36).slice(2,9).toUpperCase();
          const entry = { id: 'AI-' + token, topic, difficulty, count: lastAiSet.length, createdAt: new Date().toISOString() };
          list.unshift(entry);
          saveMyAi(list);
          // store the actual questions in sessionStorage keyed by token
          sessionStorage.setItem('eg_ai_quiz_' + entry.id, JSON.stringify(lastAiSet));
          renderMyAi();
        }, 800);
      });

      previewAiBtn.addEventListener('click', ()=> {
        const list = loadMyAi();
        if (!list.length) return alert('No AI quiz generated yet. Click Generate first.');
        const latest = list[0];
        const token = latest.id;
        const data = JSON.parse(sessionStorage.getItem('eg_ai_quiz_' + token) || 'null');
        if (!data) return alert('Preview not available (data expired).');
        aiModalBody.innerHTML = `<div style="font-weight:800">AI Quiz preview ‚Äî ${data.length} questions</div>`;
        const ol = document.createElement('ol'); ol.style.marginTop = '12px';
        data.slice(0,10).forEach(q=>{
          const li = document.createElement('li'); li.style.marginBottom='10px';
          li.innerHTML = `<div style="font-weight:700">${sanitize(q.q)}</div><div class="muted-small">${sanitize(q.choices.join(' ‚Ä¢ '))}</div>`;
          ol.appendChild(li);
        });
        aiModalBody.appendChild(ol);
        const actions = document.createElement('div'); actions.style.marginTop='12px';
        actions.innerHTML = `<button class="btn" id="aiStartBtn">Start AI Quiz</button> <button class="btn ghost" id="aiCloseBtn">Close</button>`;
        aiModalBody.appendChild(actions);

        document.getElementById('aiStartBtn').addEventListener('click', ()=> {
          const tokenParam = latest.id;
          window.location.href = `/marketting/cbt-session.html?ai=${encodeURIComponent(tokenParam)}`;
        }, { once:true });
        document.getElementById('aiCloseBtn').addEventListener('click', ()=> { aiModal.classList.remove('active'); aiModal.setAttribute('aria-hidden','true'); }, { once:true });

        aiModal.classList.add('active'); aiModal.setAttribute('aria-hidden','false');
      });

      // Render my AI list
      function renderMyAi() {
        const list = loadMyAi();
        myAiList.innerHTML = '';
        if (!list.length) { myAiList.innerHTML = '<div class="muted-small">No AI quizzes yet.</div>'; return; }
        list.slice(0,10).forEach(item => {
          const el = document.createElement('div'); el.style.display='flex'; el.style.justifyContent='space-between'; el.style.alignItems='center'; el.style.gap='8px'; el.style.marginTop='8px';
          el.innerHTML = `<div><div style="font-weight:800">${sanitize(item.topic || 'AI Quiz')}</div><div class="muted-small">${sanitize(item.difficulty)} ‚Ä¢ ${new Date(item.createdAt).toLocaleString()}</div></div>
            <div style="display:flex;gap:8px">
              <button class="btn ghost previewAiBtn" data-id="${sanitizeAttr(item.id)}">Preview</button>
              <button class="btn" data-id="${sanitizeAttr(item.id)}" onclick="startAi('${sanitizeAttr(item.id)}')">Start</button>
            </div>`;
          myAiList.appendChild(el);
        });
        // attach handlers for preview buttons
        Array.from(document.querySelectorAll('.previewAiBtn')).forEach(b => b.addEventListener('click', (e)=> {
          const id = e.currentTarget.dataset.id;
          const data = JSON.parse(sessionStorage.getItem('eg_ai_quiz_' + id) || 'null');
          if (!data) return alert('Quiz data not available (session may have expired).');
          aiModalBody.innerHTML = `<div style="font-weight:800">AI Quiz preview ‚Äî ${data.length} questions</div>`;
          const ol = document.createElement('ol'); ol.style.marginTop = '12px';
          data.slice(0,10).forEach(q=>{
            const li = document.createElement('li'); li.style.marginBottom='10px';
            li.innerHTML = `<div style="font-weight:700">${sanitize(q.q)}</div><div class="muted-small">${sanitize(q.choices.join(' ‚Ä¢ '))}</div>`;
            ol.appendChild(li);
          });
          aiModalBody.appendChild(ol);
          const actions = document.createElement('div'); actions.style.marginTop='12px';
          actions.innerHTML = `<button class="btn" id="aiStartNow">Start</button> <button class="btn ghost" id="aiCloseNow">Close</button>`;
          aiModalBody.appendChild(actions);
          document.getElementById('aiStartNow').addEventListener('click', ()=> {
            window.location.href = `/marketting/cbt-session.html?ai=${encodeURIComponent(id)}`;
          }, { once:true });
          document.getElementById('aiCloseNow').addEventListener('click', ()=> { aiModal.classList.remove('active'); aiModal.setAttribute('aria-hidden','true'); }, { once:true });
          aiModal.classList.add('active'); aiModal.setAttribute('aria-hidden','false');
        }));
      }

      // helpers to start AI quiz from inline button (exposed globally)
      window.startAi = function(id) {
        window.location.href = `marketting/cbt-session.html?ai=${encodeURIComponent(id)}`;
      };

      // Buttons
      refreshBtn.addEventListener('click', async ()=> { await fetchAndRender(); });
      historyBtn.addEventListener('click', ()=> { window.location.href = '/exam-history.html'; });

      startPracticeBtn.addEventListener('click', ()=> {
        const subj = practiceSubject.value;
        openPracticeForSubject(subj);
      });
      browsePracticeBtn.addEventListener('click', ()=> { window.location.href = '/practice-library.html'; });

      // Exam details and start handlers
      examGrid.addEventListener('click', (e)=> {
        const t = e.target;
        if (t.matches('.detailsBtn')) openExamModal(t.dataset.id);
        if (t.matches('.startBtn')) startExam(t.dataset.id);
      });

      // Modals close
      closeExamModalBtn.addEventListener('click', ()=> { examModal.classList.remove('active'); examModal.setAttribute('aria-hidden','true'); });
      closePracticeModalBtn.addEventListener('click', ()=> { practiceModal.classList.remove('active'); practiceModal.setAttribute('aria-hidden','true'); });
      closeAiModalBtn.addEventListener('click', ()=> { aiModal.classList.remove('active'); aiModal.setAttribute('aria-hidden','true'); });

      // Search
      examSearch.addEventListener('input', ()=> renderExams());

      // Sidebar mobile toggles (ensure .hidden removed when opening)
      hamburger.addEventListener('click', ()=> {
        sidebar.classList.remove('hidden');
        sidebar.classList.add('open');
        sidebar.setAttribute('aria-hidden','false');
        overlay.classList.add('visible');
        overlay.setAttribute('aria-hidden','false');
        document.body.classList.add('no-scroll');
      });
      overlay.addEventListener('click', ()=> {
        sidebar.classList.remove('open');
        sidebar.classList.add('hidden');
        sidebar.setAttribute('aria-hidden','true');
        overlay.classList.remove('visible');
        overlay.setAttribute('aria-hidden','true');
        document.body.classList.remove('no-scroll');
      });

      // Close modals on Escape
      document.addEventListener('keydown', (e)=> {
        if (e.key === 'Escape') {
          document.querySelectorAll('.modal.active').forEach(m=> { m.classList.remove('active'); m.setAttribute('aria-hidden','true'); });
        }
      });

      // Combined fetch + render
      async function fetchAndRender() {
        const className = (document.getElementById('studentClass')?.textContent || '').split('‚Äî')[0].trim() || '';
        await fetchScheduledExams(className);
        renderExams();
      }

      // Initial render
      (async function init(){
        await fetchAndRender();
        renderMyAi();
        // expose simple diagnostics (optional)
        window._eg_cbt = { scheduledExams, loadMyAi, saveMyAi };
      })();

    })();
  </script>
</body>
</html>
