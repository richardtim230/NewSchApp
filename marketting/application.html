<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Application — New Intake | École des Roches</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="description" content="Stepwise application form for national and international applicants." />

  <!-- Fonts (matches the site) -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Playfair+Display:wght@600&display=swap" rel="stylesheet">

  <style>
    /* Basic reset + variables */
    :root{
      --navy: #061728;
      --gold: #f6b83f;
      --bg: #f7fafc;
      --muted: #6b7280;
      --card: #ffffff;
      --success: #16a34a;
      --danger: #dc2626;
      --radius: 10px;
      --max-width: 1200px;
      --sidebar-width: 320px;
    }

    *{box-sizing:border-box}
    html,body{height:100%;margin:0;font-family:'Inter',system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;background:var(--bg);color:#051125;-webkit-font-smoothing:antialiased}
    a{color:var(--navy);text-decoration:none}
    .container{max-width:var(--max-width);margin:30px auto;padding:24px}

    /* Header */
    .app-header{
      display:flex;align-items:center;gap:16px;padding:18px 24px;border-radius:8px;background:linear-gradient(90deg,var(--navy),#0b2740);color:#fff;margin-bottom:18px;
      box-shadow:0 8px 28px rgba(2,11,24,0.12)
    }
    .app-header .brand{font-family:'Playfair Display',serif;font-size:20px;font-weight:700;color:var(--gold)}
    .app-header p{margin:0;color:rgba(255,255,255,0.9);font-size:14px}

    /* Two-column layout: main + sidebar */
    .layout {
      display: grid;
      grid-template-columns: 1fr var(--sidebar-width);
      gap: 20px;
      align-items: start;
    }

    /* On small screens stack vertically */
    @media (max-width:980px){
      .layout { grid-template-columns: 1fr; }
    }

    /* Card */
    .card{background:var(--card);border-radius:var(--radius);padding:22px;box-shadow:0 10px 30px rgba(2,11,24,0.06)}
    .card + .card{margin-top:18px}

    /* Stepper / progress */
    .stepper{display:flex;align-items:center;gap:12px;margin-bottom:18px}
    .step{
      display:flex;flex-direction:column;align-items:center;gap:8px;color:var(--muted);font-size:13px;width:100%;
    }
    .step .circle{
      width:36px;height:36px;border-radius:50%;display:flex;align-items:center;justify-content:center;background:#f1f5f9;color:var(--muted);font-weight:600;
      box-shadow: inset 0 -4px 0 rgba(0,0,0,0.02);
    }
    .step.active .circle{background:var(--navy);color:#fff}
    .step.completed .circle{background:var(--success);color:#fff}
    .step .label{white-space:nowrap;font-size:12px}

    /* Form columns */
    .grid{display:grid;grid-template-columns:repeat(2,1fr);gap:14px}
    @media (max-width:700px){.grid{grid-template-columns:1fr}}

    label{display:block;font-weight:600;font-size:13px;margin-bottom:6px}
    .hint{font-size:13px;color:var(--muted);margin-bottom:8px}

    input[type="text"],input[type="email"],input[type="tel"],select,textarea,input[type="date"]{
      width:100%;padding:10px 12px;border:1px solid #e6e9ef;border-radius:8px;font-size:14px;background:#fff;
    }
    textarea{min-height:100px;resize:vertical}
    .field{margin-bottom:12px}

    .actions{display:flex;gap:12px;justify-content:flex-end;margin-top:12px}
    .btn{padding:10px 16px;border-radius:8px;border:0;cursor:pointer;font-weight:700}
    .btn-ghost{background:transparent;border:1px solid rgba(2,11,24,0.06)}
    .btn-primary{background:var(--navy);color:#fff}
    .btn-secondary{background:#f1f5f9;color:var(--navy)}
    .btn-danger{background:var(--danger);color:#fff}

    .muted{color:var(--muted);font-size:13px}

    /* small preview / file list */
    .file-list{margin-top:8px;display:flex;flex-direction:column;gap:8px}
    .file-item{display:flex;align-items:center;justify-content:space-between;background:#f8fafc;padding:8px 10px;border-radius:8px;border:1px solid rgba(2,11,24,0.03)}
    .file-item small{color:var(--muted)}

    /* Review table */
    .review{display:flex;flex-direction:column;gap:8px}
    .review-row{display:flex;gap:10px;align-items:flex-start}
    .review-row .k{width:220px;font-weight:700;color:var(--muted)}
    .review-row .v{flex:1;background:#fbfdff;padding:10px;border-radius:8px;border:1px solid rgba(2,11,24,0.03)}

    /* step hidden */
    .step-panel{display:none}
    .step-panel.active{display:block}

    /* small helpers */
    .inline{display:inline-block}
    .required::after{content:" *";color:var(--danger);font-weight:700;margin-left:4px;font-size:12px}
    .notice{background:#fff7e6;border:1px solid rgba(246,184,63,0.18);padding:10px;border-radius:8px;color:#7a5a00;margin-bottom:12px}

    .progress-bar{height:8px;background:#f1f5f9;border-radius:999px;overflow:hidden;margin-bottom:12px}
    .progress-bar > i{display:block;height:100%;background:linear-gradient(90deg,var(--gold),#f7d36a);width:0%}

    /* Sidebar styles */
    .sidebar {
      position: sticky;
      top: 26px;
      align-self: start;
      width: 100%;
    }

    .sidebar .card {
      padding: 18px;
    }

    .side-title {
      font-family: 'Playfair Display', serif;
      font-size: 16px;
      color: var(--navy);
      margin-bottom: 8px;
      font-weight: 700;
    }

    .side-note {
      font-size: 13px;
      color: var(--muted);
      margin-bottom: 12px;
    }

    .checklist {
      list-style: none;
      padding: 0;
      margin: 0;
      display:flex;
      flex-direction:column;
      gap:10px;
    }

    .checklist li {
      display:flex;
      gap:10px;
      align-items:flex-start;
      font-size:14px;
      color:#102037;
    }

    .checklist .dot {
      width:18px;height:18px;border-radius:4px;background:#f1f5f9;color:var(--muted);display:inline-flex;align-items:center;justify-content:center;font-weight:700;font-size:12px;
    }

    .sidebar .progress-summary {
      display:flex;gap:10px;align-items:center;margin-top:12px;
    }

    .sidebar .progress-percent {
      font-size:20px;font-weight:700;color:var(--navy);
    }

    .sidebar .help {
      margin-top:14px;
      display:flex;
      gap:10px;
      align-items:center;
      justify-content:space-between;
    }

    .help .contact {
      font-size:13px;color:var(--muted);
    }

    .help .call {
      background:var(--navy);color:#fff;padding:8px 12px;border-radius:8px;text-decoration:none;font-weight:700;
    }

    .sidebar .step-list {
      margin-top:14px;
      display:flex;
      flex-direction:column;
      gap:10px;
    }

    .sidebar .step-item {
      display:flex;
      gap:10px;
      align-items:center;
      padding:8px;
      border-radius:8px;
      cursor:pointer;
      background:#fff;
      border:1px solid rgba(2,11,24,0.03);
    }

    .sidebar .step-item.active {
      border-color: rgba(6,23,40,0.08);
      box-shadow:0 8px 24px rgba(2,11,24,0.06);
    }

    .sidebar .small {
      font-size:13px;color:var(--muted);
    }

    /* accessibility focus */
    input:focus,select:focus,textarea:focus,button:focus{outline:3px solid rgba(6,23,40,0.08);outline-offset:2px}

    /* small footer */
    .form-footer{margin-top:18px;font-size:13px;color:var(--muted)}
  </style>
</head>

<body>
  <main class="container" id="application-root">
    <header class="app-header" role="banner">
      <div style="display:flex;flex-direction:column">
        <div class="brand">École des Roches</div>
        <div style="font-size:12px;color:rgba(255,255,255,0.9)">New intake application</div>
      </div>

      <div style="margin-left:auto">
        <p style="margin:0 0 0 8px;font-size:13px;color:rgba(255,255,255,0.9)">Please complete all required fields. You can save a draft and return later.</p>
      </div>
    </header>

    <div class="layout" role="main">
      <!-- MAIN CONTENT -->
      <div>
        <section class="card" aria-labelledby="form-title">
          <h1 id="form-title" style="margin:0 0 10px;font-family:'Playfair Display',serif;font-weight:600">Application Form — Stepwise</h1>
          <p class="muted" style="margin-bottom:12px">A single application form for national and international applicants. Estimated time: 10–20 minutes.</p>

          <div class="progress-bar" aria-hidden="true"><i id="progress-indicator" style="width:0%"></i></div>

          <!-- Stepper -->
          <div class="stepper" aria-hidden="false" id="stepper">
            <div class="step active" data-step="1">
              <div class="circle">1</div>
              <div class="label">Applicant</div>
            </div>
            <div class="step" data-step="2">
              <div class="circle">2</div>
              <div class="label">Program & Academics</div>
            </div>
            <div class="step" data-step="3">
              <div class="circle">3</div>
              <div class="label">Documents & Residency</div>
            </div>
            <div class="step" data-step="4">
              <div class="circle">4</div>
              <div class="label">Review & Submit</div>
            </div>
          </div>

          <!-- Form -->
          <form id="app-form" class="application-form" novalidate>
            <!-- STEP 1: Applicant -->
            <section class="step-panel active" data-step="1" aria-hidden="false">
              <div class="grid">
                <div>
                  <div class="field">
                    <label for="applicant-type" class="required">Applicant type</label>
                    <select id="applicant-type" name="applicantType" required>
                      <option value="national">National</option>
                      <option value="international">International</option>
                    </select>
                    <p class="hint">Select whether the applicant is applying from within the country or abroad.</p>
                  </div>

                  <div class="field">
                    <label for="first-name" class="required">First name</label>
                    <input id="first-name" name="firstName" type="text" autocomplete="given-name" required />
                  </div>

                  <div class="field">
                    <label for="last-name" class="required">Last name</label>
                    <input id="last-name" name="lastName" type="text" autocomplete="family-name" required />
                  </div>

                  <div class="field">
                    <label for="dob" class="required">Date of birth</label>
                    <input id="dob" name="dob" type="date" required />
                  </div>
                </div>

                <div>
                  <div class="field">
                    <label for="email" class="required">Email</label>
                    <input id="email" name="email" type="email" autocomplete="email" required />
                  </div>

                  <div class="field">
                    <label for="phone" class="required">Phone</label>
                    <input id="phone" name="phone" type="tel" autocomplete="tel" required />
                    <p class="hint">Include country code for international numbers.</p>
                  </div>

                  <div class="field">
                    <label for="nationality">Nationality</label>
                    <input id="nationality" name="nationality" type="text" autocomplete="country" />
                  </div>

                  <div class="field">
                    <label for="address">Current address</label>
                    <textarea id="address" name="address" placeholder="Street, city, postal code, country"></textarea>
                  </div>
                </div>
              </div>

              <!-- Conditional residency fields for national vs international -->
              <div id="residency-block" style="margin-top:8px">
                <!-- International-specific -->
                <div id="int-block" style="display:none">
                  <div class="notice">International applicant — please ensure passport and residency documentation are uploaded in the next step.</div>
                </div>

                <!-- National-specific -->
                <div id="nat-block" style="display:none">
                  <p class="muted">National applicants: provide national ID in the Documents step.</p>
                </div>
              </div>

              <div class="actions" style="margin-top:18px">
                <button type="button" class="btn btn-ghost" id="save-draft-1">Save draft</button>
                <button type="button" class="btn btn-primary" id="next-1">Next →</button>
              </div>
            </section>

            <!-- STEP 2: Program & Academics -->
            <section class="step-panel" data-step="2" aria-hidden="true">
              <div class="grid">
                <div>
                  <div class="field">
                    <label for="intake-term" class="required">Intake / Term</label>
                    <select id="intake-term" name="intakeTerm" required>
                      <option value="">Select intake</option>
                      <option>September 2026</option>
                      <option>January 2027</option>
                    </select>
                  </div>

                  <div class="field">
                    <label for="program" class="required">Program applied for</label>
                    <select id="program" name="program" required>
                      <option value="">Choose a program</option>
                      <option>International Baccalaureate (IBDP)</option>
                      <option>French Baccalaureate</option>
                      <option>French as a Foreign Language (FLE)</option>
                      <option>Summer Internship / Camp</option>
                    </select>
                  </div>

                  <div class="field">
                    <label for="current-school">Current school / Institution</label>
                    <input id="current-school" name="currentSchool" type="text" />
                  </div>
                </div>

                <div>
                  <div class="field">
                    <label for="current-grade">Current grade / year</label>
                    <input id="current-grade" name="currentGrade" type="text" />
                  </div>

                  <div class="field">
                    <label for="prev-academics">Previous academic record (summary)</label>
                    <textarea id="prev-academics" name="prevAcademics" placeholder="Brief summary of grades, achievements, or attach transcripts below"></textarea>
                  </div>
                </div>
              </div>

              <div class="actions">
                <button type="button" class="btn btn-ghost" id="prev-2">← Back</button>
                <button type="button" class="btn btn-ghost" id="save-draft-2">Save draft</button>
                <button type="button" class="btn btn-primary" id="next-2">Next →</button>
              </div>
            </section>

            <!-- STEP 3: Documents & Residency -->
            <section class="step-panel" data-step="3" aria-hidden="true">
              <div class="grid">
                <div>
                  <div class="field">
                    <label class="required">Primary identity document</label>
                    <div class="hint">Passport for international applicants, national ID for national applicants. PDF/JPG/PNG only (max 8 MB).</div>
                    <input id="id-file" name="idFile" type="file" accept=".pdf,image/*" />
                    <div class="file-list" id="file-list-id" aria-live="polite"></div>
                  </div>

                  <div class="field">
                    <label>Academic transcripts (optional)</label>
                    <input id="transcripts" name="transcripts" type="file" accept=".pdf,image/*" multiple />
                    <div class="file-list" id="file-list-transcripts" aria-live="polite"></div>
                  </div>
                </div>

                <div>
                  <div class="field">
                    <label>Proof of language (if any)</label>
                    <select id="language-proof" name="languageProof">
                      <option value="">None</option>
                      <option>IELTS</option>
                      <option>TOEFL</option>
                      <option>Cambridge</option>
                    </select>
                  </div>

                  <div class="field">
                    <label>Emergency contact</label>
                    <input id="emergency-name" name="emergencyName" type="text" placeholder="Full name" />
                    <input id="emergency-phone" name="emergencyPhone" type="tel" placeholder="Phone" style="margin-top:8px" />
                  </div>
                </div>
              </div>

              <div class="notice" role="note">Accepted document formats: PDF, JPG, PNG. Max file size: 8 MB each. For larger files, provide a secure download link in the transcripts/notes field.</div>

              <div class="actions">
                <button type="button" class="btn btn-ghost" id="prev-3">← Back</button>
                <button type="button" class="btn btn-ghost" id="save-draft-3">Save draft</button>
                <button type="button" class="btn btn-primary" id="next-3">Next →</button>
              </div>
            </section>

            <!-- STEP 4: Review & Submit -->
            <section class="step-panel" data-step="4" aria-hidden="true">
              <h3 style="margin-top:0">Review application</h3>
              <div class="review" id="review-area" aria-live="polite"></div>

              <div style="margin-top:12px">
                <label class="field"><input type="checkbox" id="agree" required /> <span style="margin-left:8px">I confirm that the information provided is accurate and I agree to the <a href="#">terms & privacy policy</a>.</span></label>
              </div>

              <div class="actions">
                <button type="button" class="btn btn-ghost" id="prev-4">← Back</button>
                <button type="button" class="btn btn-secondary" id="save-draft-final">Save draft</button>
                <button type="submit" class="btn btn-primary" id="submit-btn">Submit application</button>
              </div>

              <div class="form-footer">After submission, you will receive a confirmation email with the next steps. Applications are reviewed within 5 working days.</div>
            </section>
          </form>
        </section>
      </div>

      <!-- SIDEBAR -->
      <aside class="sidebar" aria-label="Application help and checklist">
        <div class="card">
          <div class="side-title">Application checklist</div>
          <div class="side-note">Complete these items to finish your application quickly.</div>

          <ul class="checklist" id="checklist">
            <li><span class="dot">1</span> Personal details (name, DOB, contact)</li>
            <li><span class="dot">2</span> Program & intake selection</li>
            <li><span class="dot">3</span> Upload ID & transcripts</li>
            <li><span class="dot">4</span> Review & submit</li>
          </ul>

          <div class="progress-summary" style="margin-top:12px">
            <div style="flex:1">
              <div class="small">Progress</div>
              <div style="display:flex;align-items:center;gap:10px">
                <div class="progress-bar" style="flex:1"><i id="side-progress" style="width:0%"></i></div>
                <div class="progress-percent" id="side-percent">0%</div>
              </div>
            </div>
          </div>

          <div class="side-title" style="margin-top:14px">Steps</div>
          <div class="step-list" id="side-steps" role="list">
            <div class="step-item" data-step="1" tabindex="0" role="button" aria-pressed="false">
              <div style="width:36px;height:36;border-radius:6px;background:#f1f5f9;display:flex;align-items:center;justify-content:center;font-weight:700">1</div>
              <div>
                <div style="font-weight:700">Applicant</div>
                <div class="small">Personal & contact info</div>
              </div>
            </div>

            <div class="step-item" data-step="2" tabindex="0" role="button" aria-pressed="false">
              <div style="width:36px;height:36;border-radius:6px;background:#f1f5f9;display:flex;align-items:center;justify-content:center;font-weight:700">2</div>
              <div>
                <div style="font-weight:700">Program & Academics</div>
                <div class="small">Choose program & add school info</div>
              </div>
            </div>

            <div class="step-item" data-step="3" tabindex="0" role="button" aria-pressed="false">
              <div style="width:36px;height:36;border-radius:6px;background:#f1f5f9;display:flex;align-items:center;justify-content:center;font-weight:700">3</div>
              <div>
                <div style="font-weight:700">Documents</div>
                <div class="small">Upload ID, transcripts</div>
              </div>
            </div>

            <div class="step-item" data-step="4" tabindex="0" role="button" aria-pressed="false">
              <div style="width:36px;height:36;border-radius:6px;background:#f1f5f9;display:flex;align-items:center;justify-content:center;font-weight:700">4</div>
              <div>
                <div style="font-weight:700">Review & Submit</div>
                <div class="small">Finalize application</div>
              </div>
            </div>
          </div>

          <div class="help">
            <div class="contact">
              Need help?<br>
              <div style="font-weight:700;color:var(--navy)">admissions@ecoledesroches.com</div>
            </div>
            <a class="call" href="tel:+02277413351">Call</a>
          </div>

          <div style="margin-top:12px; display:flex;gap:8px;">
            <button class="btn btn-ghost" id="sidebar-save">Save draft</button>
            <button class="btn btn-primary" id="sidebar-next">Continue</button>
          </div>
        </div>
      </aside>
    </div>
  </main>

  <script>
    // Step navigation + validation + simple draft saves (localStorage) + file previews + sidebar sync
    (function(){
      const form = document.getElementById('app-form');
      const panels = Array.from(document.querySelectorAll('.step-panel'));
      const stepEls = Array.from(document.querySelectorAll('.stepper .step'));
      const progress = document.getElementById('progress-indicator');
      const sideProgress = document.getElementById('side-progress');
      const sidePercent = document.getElementById('side-percent');
      const sideStepItems = Array.from(document.querySelectorAll('.sidebar .step-item'));
      const checklist = document.getElementById('checklist');
      let current = 1;

      const updateStepper = () => {
        stepEls.forEach(s => {
          const step = Number(s.getAttribute('data-step'));
          s.classList.toggle('active', step === current);
          s.classList.toggle('completed', step < current);
        });
        // progress percent
        const pct = Math.round(((current - 1) / (panels.length - 1)) * 100);
        progress.style.width = pct + '%';
        sideProgress.style.width = pct + '%';
        sidePercent.textContent = pct + '%';

        // highlight sidebar step
        sideStepItems.forEach(si=>{
          const step = Number(si.getAttribute('data-step'));
          si.classList.toggle('active', step === current);
          si.setAttribute('aria-pressed', String(step === current));
        });

        // checklist visual hint: mark completed items
        const items = Array.from(checklist.querySelectorAll('li'));
        items.forEach((li, idx)=>{
          if(idx < current - 1) li.style.opacity = '0.6';
          else li.style.opacity = '1';
        });
      };

      const showStep = (n) => {
        panels.forEach(p => {
          const step = Number(p.getAttribute('data-step'));
          p.classList.toggle('active', step === n);
          p.setAttribute('aria-hidden', step === n ? 'false' : 'true');
        });
        current = n;
        updateStepper();
        // focus first input for accessibility
        const firstField = panels.find(p => p.classList.contains('active')).querySelector('input,select,textarea,button');
        if(firstField) setTimeout(()=>firstField.focus(),50);
      };

      // move forward with minimal validation for required fields in current panel
      const validatePanel = (panel) => {
        const requireds = Array.from(panel.querySelectorAll('[required]'));
        for(const el of requireds){
          if(el.type === 'checkbox') {
            if(!el.checked) { el.focus(); return `${el.name || el.id} required`; }
          } else if(!el.value) { el.focus(); return `${el.name || el.id} required`; }
        }
        return null;
      };

      // wire up next / prev buttons
      document.getElementById('next-1').addEventListener('click', ()=>{
        const panel = panels.find(p => p.getAttribute('data-step') === '1');
        const err = validatePanel(panel);
        if(err){ alert('Please complete required fields in this step.'); return; }
        showStep(2);
      });

      document.getElementById('next-2').addEventListener('click', ()=>{
        const panel = panels.find(p => p.getAttribute('data-step') === '2');
        const err = validatePanel(panel);
        if(err){ alert('Please complete required fields in this step.'); return; }
        showStep(3);
      });

      document.getElementById('next-3').addEventListener('click', ()=>{
        const panel = panels.find(p => p.getAttribute('data-step') === '3');
        // no strict requireds here, but you can enforce file uploads if you want
        showStep(4);
        fillReview();
      });

      document.getElementById('prev-2').addEventListener('click', ()=>showStep(1));
      document.getElementById('prev-3').addEventListener('click', ()=>showStep(2));
      document.getElementById('prev-4').addEventListener('click', ()=>showStep(3));

      // Sidebar Next / Save controls
      document.getElementById('sidebar-next').addEventListener('click', ()=>{
        // if on last step, scroll to review; otherwise go next
        if(current < panels.length) {
          showStep(current + 1);
          if(current === panels.length) fillReview();
        } else {
          showStep(panels.length);
          fillReview();
        }
      });

      document.getElementById('sidebar-save').addEventListener('click', ()=>saveDraft());

      // Save draft helpers (localStorage)
      const DRAFT_KEY = 'edr-application-draft-v1';
      const saveDraft = (showAlert=true) => {
        // gather simple form values (not files)
        const data = {};
        const elements = form.querySelectorAll('input,select,textarea');
        elements.forEach(el=>{
          if(el.type === 'file') return;
          if(el.type === 'checkbox') data[el.id || el.name] = el.checked;
          else data[el.id || el.name] = el.value;
        });
        localStorage.setItem(DRAFT_KEY, JSON.stringify(data));
        if(showAlert) alert('Draft saved locally. You can return to this device to finish your application.');
      };

      document.getElementById('save-draft-1').addEventListener('click', ()=>saveDraft());
      document.getElementById('save-draft-2').addEventListener('click', ()=>saveDraft());
      document.getElementById('save-draft-3').addEventListener('click', ()=>saveDraft());
      document.getElementById('save-draft-final').addEventListener('click', ()=>saveDraft());

      // load draft on init
      const loadDraft = () => {
        const raw = localStorage.getItem(DRAFT_KEY);
        if(!raw) return;
        try {
          const data = JSON.parse(raw);
          Object.keys(data).forEach(k=>{
            const el = document.getElementById(k) || document.querySelector(`[name="${k}"]`);
            if(!el) return;
            if(el.type === 'checkbox') el.checked = data[k];
            else el.value = data[k];
          });
        } catch(e) { console.warn('Failed to load draft', e) }
      };

      loadDraft();

      // applicant type toggle (show notices)
      const applicantType = document.getElementById('applicant-type');
      const intBlock = document.getElementById('int-block');
      const natBlock = document.getElementById('nat-block');

      const toggleApplicantType = () => {
        const val = applicantType.value;
        intBlock.style.display = val === 'international' ? '' : 'none';
        natBlock.style.display = val === 'national' ? '' : 'none';
      };
      applicantType.addEventListener('change', toggleApplicantType);
      toggleApplicantType();

      // file preview and validation
      const fileInputHandler = (inputEl, listElId) => {
        const list = document.getElementById(listElId);
        list.innerHTML = '';
        const files = Array.from(inputEl.files || []);
        files.forEach(file=>{
          const item = document.createElement('div');
          item.className = 'file-item';
          const left = document.createElement('div');
          left.innerHTML = `<strong>${file.name}</strong><div style="font-size:12px;color:var(--muted)">${Math.round(file.size/1024)} KB</div>`;
          const right = document.createElement('div');
          const remove = document.createElement('button');
          remove.className = 'btn btn-ghost';
          remove.type = 'button';
          remove.style.padding='6px 10px';
          remove.textContent = 'Remove';
          remove.addEventListener('click', ()=>{
            // remove this file from the FileList - not straightforward; clear input and re-add others
            const remaining = inputEl.files ? Array.from(inputEl.files).filter(f=>f !== file) : [];
            const dt = new DataTransfer();
            remaining.forEach(f=>dt.items.add(f));
            inputEl.files = dt.files;
            fileInputHandler(inputEl, listElId);
          });
          right.appendChild(remove);
          item.appendChild(left);
          item.appendChild(right);
          list.appendChild(item);
        });
      };

      const idFile = document.getElementById('id-file');
      const transcripts = document.getElementById('transcripts');
      idFile.addEventListener('change', ()=>{ fileInputHandler(idFile, 'file-list-id'); validateFilesSize(idFile); });
      transcripts.addEventListener('change', ()=>{ fileInputHandler(transcripts, 'file-list-transcripts'); validateFilesSize(transcripts); });

      // Build review area
      const fillReview = () => {
        const area = document.getElementById('review-area');
        area.innerHTML = '';
        const keys = [
          {k:'Applicant type', v: document.getElementById('applicant-type').value},
          {k:'First name', v: document.getElementById('first-name').value},
          {k:'Last name', v: document.getElementById('last-name').value},
          {k:'Date of birth', v: document.getElementById('dob').value},
          {k:'Email', v: document.getElementById('email').value},
          {k:'Phone', v: document.getElementById('phone').value},
          {k:'Nationality', v: document.getElementById('nationality').value},
          {k:'Address', v: document.getElementById('address').value},
          {k:'Intake', v: document.getElementById('intake-term').value},
          {k:'Program', v: document.getElementById('program').value},
          {k:'Current school', v: document.getElementById('current-school').value},
          {k:'Current grade', v: document.getElementById('current-grade').value},
          {k:'Transcripts attached', v: transcripts.files.length || '0'},
          {k:'ID document attached', v: idFile.files.length || '0'},
        ];
        keys.forEach(row=>{
          const r = document.createElement('div');
          r.className = 'review-row';
          r.innerHTML = `<div class="k">${row.k}</div><div class="v">${row.v || '<span class="muted">Not provided</span>'}</div>`;
          area.appendChild(r);
        });
      };

      // final submit (AJAX example)
      form.addEventListener('submit', async (e) => {
        e.preventDefault();
        // Basic confirmation
        const agree = document.getElementById('agree');
        if(!agree.checked){ alert('You must agree to the terms before submitting.'); agree.focus(); return; }

        // Create FormData
        const fd = new FormData();
        const elements = form.querySelectorAll('input,select,textarea');
        elements.forEach(el=>{
          if(!el.name && !el.id) return;
          const key = el.name || el.id;
          if(el.type === 'file'){
            const files = Array.from(el.files || []);
            files.forEach(f => fd.append(key, f, f.name));
          } else if(el.type === 'checkbox'){
            fd.append(key, el.checked ? '1' : '0');
          } else {
            fd.append(key, el.value || '');
          }
        });

        // Example: send to /api/applications
        try {
          const submitBtn = document.getElementById('submit-btn');
          submitBtn.disabled = true;
          submitBtn.textContent = 'Submitting...';

          const resp = await fetch('/api/applications', {
            method: 'POST',
            body: fd
          });

          if(!resp.ok){
            const txt = await resp.text();
            throw new Error(txt || 'Submission failed');
          }

          // success
          localStorage.removeItem(DRAFT_KEY);
          alert('Application submitted. You will receive a confirmation email shortly.');
          // optionally redirect to thank-you page
          window.location.href = '/application/thank-you.html';
        } catch (err) {
          console.error(err);
          alert('Submission failed. Please try again later or contact admissions.');
          document.getElementById('submit-btn').disabled = false;
          document.getElementById('submit-btn').textContent = 'Submit application';
        }
      });

      // initialize UI
      updateStepper();
      showStep(1);

      // accessibility: allow step click to go back to completed steps and sidebar item click to navigate
      stepEls.forEach(s=>{
        s.addEventListener('click', ()=>{
          const target = Number(s.getAttribute('data-step'));
          if(target <= current) showStep(target);
        });
      });

      sideStepItems.forEach(si=>{
        si.addEventListener('click', ()=> {
          const target = Number(si.getAttribute('data-step'));
          // permit navigation to the clicked step if it's <= current (or allow jump back)
          if(target <= current) showStep(target);
          else {
            // If the clicked is ahead, do minimal validation of current panel first
            const panel = panels.find(p => Number(p.getAttribute('data-step')) === current);
            const err = validatePanel(panel);
            if(err){ alert('Please complete required fields in this step before moving forward.'); return; }
            showStep(target);
            if(target === panels.length) fillReview();
          }
        });
        si.addEventListener('keydown', (e)=>{
          if(e.key === 'Enter' || e.key === ' ') { e.preventDefault(); si.click(); }
        });
      });

      // prevent large file uploads client-side
      const MAX_BYTES = 8 * 1024 * 1024; // 8MB
      const validateFilesSize = (input) => {
        for(const f of input.files){
          if(f.size > MAX_BYTES){
            alert(`File ${f.name} is larger than 8 MB. Please compress or provide a link.`);
            // clear the offending file input
            input.value = '';
            fileInputHandler(input, input === idFile ? 'file-list-id' : 'file-list-transcripts');
            return false;
          }
        }
        return true;
      };

      // simple keyboard shortcut: Ctrl+S to save draft
      document.addEventListener('keydown', (e)=>{
        if((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === 's') {
          e.preventDefault();
          saveDraft(true);
        }
      });
    })();
  </script>
</body>
</html>
