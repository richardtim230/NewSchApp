<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Teacher Dashboard | ExamGuard</title>
  <meta name="viewport" content="width=device-width,initial-scale=0.901" />
  <link href="https://fonts.googleapis.com/css?family=Inter:400,600,700&display=swap" rel="stylesheet">
  <link rel="icon" href="../logo.png">
  <style>
    /* Reused styling from others.html with small teacher-focused tweaks */
    :root{
      --bg-0:#f6f8ff; --bg-1:#eef2ff;
      --accent:#3b82f6; --accent-2:#6366f1; --muted:#6b7280;
      --card-bg:#ffffff; --sidebar-w:300px;
      --radius:12px;
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;font-family:Inter,system-ui,Arial;background:linear-gradient(180deg,var(--bg-0),var(--bg-1));-webkit-font-smoothing:antialiased;color:#0b2a44}
    a{color:inherit;text-decoration:none}
    .app{display:flex;min-height:100vh;align-items:stretch}
    .overlay{position:fixed;inset:0;background:rgba(2,6,23,0.45);z-index:50;display:none}
    .overlay.visible{display:block}

    /* Sidebar (desktop instant show) */
    .sidebar{
      width:var(--sidebar-w);min-width:var(--sidebar-w);
      background:linear-gradient(180deg,#0f172a 0%, #1e3a8a 100%);color:#fff;padding:20px 16px;position:fixed;left:0;top:0;bottom:0;z-index:100;
      box-shadow:4px 0 28px rgba(15,23,42,0.12);display:flex;flex-direction:column;gap:14px;overflow-y:auto;transition:none;
    }
    @media (max-width:720px){
      .sidebar{transform:translateX(-110%);transition:transform .28s ease;position:fixed;width:86vw;min-width:86vw}
      .sidebar.hidden{transform:translateX(-110%)}
      .sidebar.open{transform:translateX(0);box-shadow:0 24px 48px rgba(2,6,23,0.5)}
    }

    .brand{display:flex;gap:12px;align-items:center}
    .brand img{width:44px;height:44px;border-radius:10px;object-fit:cover;border:3px solid rgba(255,224,102,0.12);background:#fff}
    .brand .title{font-weight:800;font-size:1.05rem;color:#ffe066}
    .nav{display:flex;flex-direction:column;gap:8px;margin-top:6px}
    .nav a{display:flex;align-items:center;gap:10px;padding:12px;border-radius:10px;font-weight:700;font-size:1rem;color:#e6eefc}
    .nav a.active,.nav a:hover{background:rgba(255,255,255,0.04);color:#ffe066}

    /* teacher submenu inside sidebar */
    .subnav{display:flex;flex-direction:column;gap:6px;margin-top:8px;padding-top:8px;border-top:1px dashed rgba(255,255,255,0.04)}
    .subnav a{padding:10px;border-radius:8px;color:var(--accent-2);font-weight:700;background:transparent}
    .subnav a.active{background:linear-gradient(90deg,var(--accent),var(--accent-2));color:#fff}

    .spacer{flex:1}
    .profile{display:flex;gap:12px;align-items:center;padding-top:10px;border-top:1px solid rgba(255,255,255,0.04)}
    .profile img{width:48px;height:48px;border-radius:10px;object-fit:cover;border:2px solid #ffe066}

    /* Topbar */
    .topbar{position:fixed;left:var(--sidebar-w);top:0;width:calc(100vw - var(--sidebar-w));z-index:90;display:flex;align-items:center;justify-content:space-between;gap:12px;padding:12px 14px;backdrop-filter: blur(6px);background: rgba(255,255,255,0.92);border-bottom:1px solid rgba(11,42,60,0.06);box-shadow:0 6px 18px rgba(11,42,60,0.04)}
    @media (max-width:720px){.topbar{left:0;width:100vw;padding:10px 12px;min-height:56px}}

    .hamburger{display:none;background:var(--accent);color:#fff;border:none;padding:9px 12px;border-radius:10px;cursor:pointer;font-weight:800}
    @media (max-width:980px){.hamburger{display:inline-flex}}

    .page-title{font-weight:800;font-size:1.05rem;color:var(--accent-2)}
    .small{font-size:0.92rem;color:var(--muted)}

    .main{margin-left:var(--sidebar-w);padding:20px;flex:1;transition:margin-left .28s;min-height:100vh;padding-top:90px;overflow-y:auto}
    @media (max-width:720px){.main{margin-left:0;padding:14px;padding-top:80px}}

    /* Content layout */
    .content{display:flex;flex-direction:column;gap:12px}
    .section{background:var(--card-bg);border-radius:12px;padding:16px;border:1px solid #eef3ff}
    .section h2{margin:0 0 8px 0;font-size:1.05rem}
    .grid{display:grid;grid-template-columns:repeat(3,1fr);gap:12px}
    @media (max-width:980px){.grid{grid-template-columns:repeat(2,1fr)}}
    @media (max-width:720px){.grid{grid-template-columns:1fr}}

    .card{background:#fff;border-radius:12px;padding:12px;border:1px solid #eef3ff;display:flex;flex-direction:column;gap:8px}
    .card .title{font-weight:800}
    .card .meta{color:var(--muted);font-size:0.92rem}

    .controls{display:flex;gap:8px;flex-wrap:wrap}
    .btn{padding:9px 12px;border-radius:10px;border:none;cursor:pointer;background:linear-gradient(90deg,var(--accent),var(--accent-2));color:#fff;font-weight:800}
    .btn.ghost{background:transparent;color:var(--accent-2);border:1px solid rgba(59,130,246,0.08)}

    /* forms & tables */
    table{width:100%;border-collapse:collapse}
    table th, table td{padding:8px;border-bottom:1px solid #f1f5fb;text-align:left}
    input[type="text"], input[type="number"], select, textarea{padding:8px;border-radius:8px;border:1px solid #e6e9ef;width:100%}

    /* modals */
    .modal{position:fixed;inset:0;background:rgba(2,6,23,0.45);display:none;align-items:center;justify-content:center;z-index:9999;padding:12px}
    .modal.active{display:flex}
    .modal .panel{background:#fff;border-radius:12px;max-width:980px;width:100%;overflow:hidden;box-shadow:0 20px 60px rgba(2,6,23,0.25)}
    .modal .head{padding:12px 16px;border-bottom:1px solid #eef3ff;background:#f8fbff;display:flex;justify-content:space-between;align-items:center}
    .modal .body{padding:14px;max-height:72vh;overflow:auto}

    .muted-small{font-size:0.9rem;color:var(--muted)}
    .empty{padding:28px;text-align:center;color:var(--muted);border:1px dashed #eef3ff;border-radius:12px}

    :focus{outline:3px solid rgba(99,102,241,0.18);outline-offset:2px;border-radius:6px}

    /* page loader */
    .page-loader { position: fixed; inset: 0; display: none; align-items:center; justify-content:center; z-index:1200; background: rgba(255,255,255,0.92); }
    .page-loader.active { display:flex; }
    .page-loader .spinner { width:44px;height:44px;border-radius:50%;border:6px solid rgba(0,0,0,0.06);border-top-color:var(--accent);animation:spin 1s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }
    .page-loader .msg { font-weight:800; color:#0b2a44; }
    .page-loader .sub { color:var(--muted); font-size:0.92rem; margin-top:6px; }

  </style>
</head>
<body>
  <div class="app" id="app">
    <div class="overlay" id="overlay" aria-hidden="true"></div>

    <!-- loader -->
    <div id="pageLoader" class="page-loader" role="status" aria-live="polite" aria-hidden="true">
      <div class="spinner" aria-hidden="true"></div>
      <div style="text-align:center">
        <div class="msg" id="loaderMsg">Loading teacher dashboard‚Ä¶</div>
        <div class="sub" id="loaderSub">Fetching profile and classroom data</div>
      </div>
    </div>

    <aside class="sidebar" id="sidebar" aria-label="Main navigation" role="navigation" aria-hidden="false">
      <div class="brand">
        <img src="../logo.png" alt="Logo">
        <div>
          <div class="title">Teacher Portal</div>
          <div class="small">ExamGuard ‚Ä¢ Faculty</div>
        </div>
      </div>

      <nav class="nav" aria-label="Primary">
        <a href="teacher-dashboard.html" class="active">üè† Home</a>

        <div class="subnav" role="menu" aria-label="Teacher sections">
          <a href="#overview" data-tab="overview" class="sidebar-tab" role="menuitem">üìä Overview</a>
          <a href="#classes" data-tab="classes" class="sidebar-tab" role="menuitem">üë©‚Äçüè´ Classes</a>
          <a href="#attendance" data-tab="attendance" class="sidebar-tab" role="menuitem">üìù Attendance</a>
          <a href="#assignments" data-tab="assignments" class="sidebar-tab" role="menuitem">üóÇ Assignments</a>
          <a href="#gradebook" data-tab="gradebook" class="sidebar-tab" role="menuitem">üìö Gradebook</a>
          <a href="#exams" data-tab="exams" class="sidebar-tab" role="menuitem">üñ• Exams</a>
          <a href="#resources" data-tab="resources" class="sidebar-tab" role="menuitem">üìÇ Resources</a>
          <a href="#messages" data-tab="messages" class="sidebar-tab" role="menuitem">‚úâÔ∏è Messages</a>
          <a href="#settings" data-tab="settings" class="sidebar-tab" role="menuitem">‚öôÔ∏è Settings</a>
        </div>
      </nav>

      <div class="spacer" aria-hidden="true"></div>

      <div class="profile">
        <img src="../avatar.jpg" alt="Teacher avatar" id="teacherAvatar">
        <div>
          <div style="font-weight:800" id="teacherName">Teacher</div>
          <div class="muted-small" id="teacherDept">‚Äî</div>
        </div>
      </div>
    </aside>

    <div class="topbar">
      <div style="display:flex;gap:12px;align-items:center;">
        <button class="hamburger" id="hamburger" aria-label="Open menu">‚ò∞</button>
        <div>
          <div class="page-title">Teacher Dashboard</div>
          <div class="small muted">Manage classes, assessments & communications</div>
        </div>
      </div>

      <div style="display:flex;gap:12px;align-items:center;">
        <div class="muted-small" id="termInfo">‚Äî</div>
        <img src="../avatar.jpg" alt="you" style="width:44px;height:44px;border-radius:8px;border:2px solid #fff" id="topbarAvatar">
      </div>
    </div>

    <main class="main" id="main" role="main" tabindex="-1">
      <div class="content" id="contentArea">
        <!-- Overview -->
        <section id="overview" class="section tab-section" role="region" aria-labelledby="ovTitle">
          <h2 id="ovTitle">Overview</h2>
          <div class="muted-small">Quick stats and recent activity</div>

          <div style="margin-top:12px" class="grid">
            <div class="card">
              <div class="small muted">Classes</div>
              <div style="font-weight:900;font-size:1.2rem" id="statClasses">--</div>
              <div class="muted-small">Active this term</div>
            </div>

            <div class="card">
              <div class="small muted">Students</div>
              <div style="font-weight:900;font-size:1.2rem" id="statStudents">--</div>
              <div class="muted-small">Total across classes</div>
            </div>

            <div class="card">
              <div class="small muted">Pending submissions</div>
              <div style="font-weight:900;font-size:1.2rem" id="statPending">--</div>
              <div class="muted-small">Awaiting grading</div>
            </div>
          </div>

          <div style="margin-top:12px;">
            <div style="display:flex;justify-content:space-between;align-items:center">
              <div style="font-weight:800">Recent activity</div>
              <div class="muted-small">All actions</div>
            </div>
            <div style="margin-top:8px" id="activityList"></div>
          </div>
        </section>

        <!-- Classes -->
        <section id="classes" class="section tab-section" role="region" aria-labelledby="classesTitle" style="display:none">
          <h2 id="classesTitle">Classes</h2>
          <div class="muted-small">Your classes and rosters</div>

          <div style="margin-top:12px" class="controls">
            <select id="classSelect" aria-label="Select class"></select>
            <button class="btn" id="newClassBtn">Create class</button>
            <button class="btn ghost" id="exportRosterBtn">Export roster</button>
          </div>

          <div style="margin-top:12px" id="rosterWrap">
            <div class="card" id="rosterCard">
              <div style="display:flex;justify-content:space-between;align-items:center">
                <div><strong id="rosterTitle">Class</strong></div>
                <div class="muted-small" id="rosterMeta">-- students</div>
              </div>

              <div style="margin-top:10px">
                <table id="rosterTable" aria-label="Class roster">
                  <thead><tr><th>#</th><th>Name</th><th>Admission</th><th>Contact</th><th>Actions</th></tr></thead>
                  <tbody></tbody>
                </table>
              </div>
            </div>
          </div>
        </section>

        <!-- Attendance -->
        <section id="attendance" class="section tab-section" role="region" aria-labelledby="attTitle" style="display:none">
          <h2 id="attTitle">Attendance</h2>
          <div class="muted-small">Mark attendance quickly</div>

          <div style="margin-top:12px" class="controls">
            <select id="attClassSelect" aria-label="Attendance class"></select>
            <input type="date" id="attDate">
            <button class="btn" id="loadAttendanceBtn">Load</button>
          </div>

          <div style="margin-top:12px" id="attendanceWrap"></div>
        </section>

        <!-- Assignments -->
        <section id="assignments" class="section tab-section" role="region" aria-labelledby="assignTitle" style="display:none">
          <h2 id="assignTitle">Assignments</h2>
          <div class="muted-small">Create assignments, collect submissions & grade</div>

          <div style="margin-top:12px" class="controls">
            <button class="btn" id="newAssignBtn">New assignment</button>
            <button class="btn ghost" id="viewSubmissionsBtn">View submissions</button>
          </div>

          <div style="margin-top:12px" id="assignList"></div>
        </section>

        <!-- Gradebook -->
        <section id="gradebook" class="section tab-section" role="region" aria-labelledby="gradeTitle" style="display:none">
          <h2 id="gradeTitle">Gradebook</h2>
          <div class="muted-small">Enter grades and export reports</div>

          <div style="margin-top:12px" class="controls">
            <select id="gradeClassSelect" aria-label="Grade class"></select>
            <select id="gradeAssessmentSelect"><option>Assessment A</option></select>
            <button class="btn" id="saveGradesBtn">Save grades</button>
            <button class="btn ghost" id="exportGradesBtn">Export CSV</button>
          </div>

          <div style="margin-top:12px" id="gradebookWrap"></div>
        </section>

        <!-- Exams -->
        <section id="exams" class="section tab-section" role="region" aria-labelledby="examTitle" style="display:none">
          <h2 id="examTitle">Exams</h2>
          <div class="muted-small">Schedule CBT exams and view sessions</div>

          <div style="margin-top:12px" class="controls">
            <button class="btn" id="scheduleExamBtn">Schedule exam</button>
            <button class="btn ghost" id="manageSessionsBtn">Manage sessions</button>
          </div>

          <div style="margin-top:12px" id="examList"></div>
        </section>

        <!-- Resources -->
        <section id="resources" class="section tab-section" role="region" aria-labelledby="resTitle" style="display:none">
          <h2 id="resTitle">Resources</h2>
          <div class="muted-small">Upload lesson materials and link to classes</div>

          <div style="margin-top:12px" class="controls">
            <input type="text" id="resSearch" placeholder="Search resources">
            <button class="btn" id="uploadResBtn">Upload</button>
          </div>

          <div style="margin-top:12px" id="resGrid"></div>
        </section>

        <!-- Messages -->
        <section id="messages" class="section tab-section" role="region" aria-labelledby="msgTitle" style="display:none">
          <h2 id="msgTitle">Messages</h2>
          <div class="muted-small">Send announcements to classes or individual students</div>

          <div style="margin-top:12px" class="controls">
            <select id="msgTarget"><option value="class">Class</option><option value="student">Student</option></select>
            <button class="btn" id="newMsgBtn">New message</button>
          </div>

          <div style="margin-top:12px" id="msgList"></div>
        </section>

        <!-- Settings -->
        <section id="settings" class="section tab-section" role="region" aria-labelledby="setTitle" style="display:none">
          <h2 id="setTitle">Settings</h2>
          <div class="muted-small">Manage profile and notification preferences</div>

          <form id="teacherSettings" style="margin-top:12px;display:grid;gap:8px;max-width:720px">
            <label>Display name<input type="text" id="setName"></label>
            <label>Department<input type="text" id="setDept"></label>
            <label>Email<input type="text" id="setEmail"></label>
            <div style="display:flex;gap:8px;justify-content:flex-end">
              <button type="button" class="btn ghost" id="resetSettings">Reset</button>
              <button type="submit" class="btn" id="saveSettings">Save</button>
            </div>
          </form>
        </section>
      </div>
    </main>

    <!-- Shared modals -->
    <div class="modal" id="itemModal" role="dialog" aria-modal="true" aria-hidden="true">
      <div class="panel" role="document">
        <div class="head">
          <div id="itemModalTitle" style="font-weight:800">Details</div>
          <div><button class="btn ghost" id="closeItemModal">Close</button></div>
        </div>
        <div class="body" id="itemModalBody"></div>
      </div>
    </div>

    <div class="modal" id="formModal" role="dialog" aria-modal="true" aria-hidden="true">
      <div class="panel" role="document">
        <div class="head">
          <div id="formModalTitle" style="font-weight:800">Form</div>
          <div><button class="btn ghost" id="closeFormModal">Close</button></div>
        </div>
        <div class="body" id="formModalBody">
          <!-- dynamic content -->
        </div>
      </div>
    </div>

  </div>

  <script>
    (function () {
      const API_BASE = 'https://examguide.onrender.com/api';
      const TOKEN = localStorage.getItem('eg_token') || null;

      // DOM refs
      const pageLoader = document.getElementById('pageLoader');
      const loaderMsg = document.getElementById('loaderMsg');
      const loaderSub = document.getElementById('loaderSub');

      const teacherNameEl = document.getElementById('teacherName');
      const teacherDeptEl = document.getElementById('teacherDept');
      const teacherAvatar = document.getElementById('teacherAvatar');
      const topbarAvatar = document.getElementById('topbarAvatar');
      const termInfo = document.getElementById('termInfo');

      // data containers
      let classes = [];
      let assignments = [];
      let exams = [];
      let resources = [];
      let messages = [];

      function showLoader(msg, sub) {
        if (msg) loaderMsg.textContent = msg;
        if (sub) loaderSub.textContent = sub;
        pageLoader.classList.add('active'); pageLoader.setAttribute('aria-hidden','false');
      }
      function hideLoader() {
        pageLoader.classList.remove('active'); pageLoader.setAttribute('aria-hidden','true');
      }

      function headers(contentType='application/json') {
        const h = {};
        if (contentType) h['Content-Type'] = contentType;
        if (TOKEN) h['Authorization'] = 'Bearer ' + TOKEN;
        return h;
      }

      // generic fetch candidates helper (tries multiple endpoint shapes)
      async function tryFetchCandidates(candidates, options={}) {
        for (const url of candidates) {
          if (!url) continue;
          try {
            const res = await fetch(url, options);
            if (!res.ok) continue;
            const data = await res.json();
            if (Array.isArray(data)) return data;
            if (Array.isArray(data.items)) return data.items;
            if (Array.isArray(data.data)) return data.data;
            if (Array.isArray(data.results)) return data.results;
            if (Array.isArray(data.classes)) return data.classes;
            if (Array.isArray(data.assignments)) return data.assignments;
            // wrap single object
            if (data && (data.id || data._id)) return [data];
          } catch (err) {
            console.warn('candidate fetch failed', url, err);
          }
        }
        return null;
      }

      // fetch profile / me
      async function fetchProfile() {
        const local = (function(){ try { return JSON.parse(localStorage.getItem('eg_application')||'null') || null;} catch { return null; } })();
        if (!TOKEN) return local || {};
        const candidates = [`${API_BASE}/me`, `${API_BASE}/profile`, `${API_BASE}/users/me`];
        for (const url of candidates) {
          try {
            const res = await fetch(url, { headers: headers() });
            if (!res.ok) continue;
            const data = await res.json();
            return data.user || data || local || {};
          } catch (err) {}
        }
        return local || {};
      }

      // fetch resources (classes, assignments, exams, resources, messages)
      async function fetchTeacherData(teacherId) {
        // Students may be returned under teacher's classes; adapt to API shapes
        const [classesData, assignmentsData, examsData, resourcesData, messagesData] = await Promise.all([
          tryFetchCandidates([`${API_BASE}/teachers/${encodeURIComponent(teacherId)}/classes`, `${API_BASE}/classes?teacher=${encodeURIComponent(teacherId)}`, `${API_BASE}/classes`], { headers: headers() }),
          tryFetchCandidates([`${API_BASE}/assignments?teacher=${encodeURIComponent(teacherId)}`, `${API_BASE}/teachers/${encodeURIComponent(teacherId)}/assignments`, `${API_BASE}/assignments`], { headers: headers() }),
          tryFetchCandidates([`${API_BASE}/exams?teacher=${encodeURIComponent(teacherId)}`, `${API_BASE}/teachers/${encodeURIComponent(teacherId)}/exams`, `${API_BASE}/exams`], { headers: headers() }),
          tryFetchCandidates([`${API_BASE}/resources?teacher=${encodeURIComponent(teacherId)}`, `${API_BASE}/teachers/${encodeURIComponent(teacherId)}/resources`, `${API_BASE}/resources`], { headers: headers() }),
          tryFetchCandidates([`${API_BASE}/messages?to=${encodeURIComponent(teacherId)}`, `${API_BASE}/teachers/${encodeURIComponent(teacherId)}/messages`, `${API_BASE}/messages?role=teacher`], { headers: headers() })
        ]);
        return {
          classes: Array.isArray(classesData) ? classesData : [],
          assignments: Array.isArray(assignmentsData) ? assignmentsData : [],
          exams: Array.isArray(examsData) ? examsData : [],
          resources: Array.isArray(resourcesData) ? resourcesData : [],
          messages: Array.isArray(messagesData) ? messagesData : []
        };
      }

      // renderers
      function renderOverview() {
        document.getElementById('statClasses').textContent = classes.length;
        const totalStudents = classes.reduce((s,c)=> s + (Array.isArray(c.students) ? c.students.length : 0), 0);
        document.getElementById('statStudents').textContent = totalStudents;
        const pending = assignments.reduce((s,a)=> s + ((a.submissions && a.submissions.filter(x=>!x.graded).length) || 0), 0);
        document.getElementById('statPending').textContent = pending;
        const act = document.getElementById('activityList'); act.innerHTML = '';
        const ul = document.createElement('ul');
        messages.slice(0,6).forEach(m=> { const li = document.createElement('li'); li.textContent = `${m.subject || m.title} ‚Äî ${m.to || m.target || 'Broadcast'}`; ul.appendChild(li); });
        act.appendChild(ul.length ? ul : document.createTextNode('No recent activity'));
      }

      function renderClassOptions() {
        const classSelect = document.getElementById('classSelect');
        classSelect.innerHTML = '';
        classes.forEach(c => {
          const opt = document.createElement('option'); opt.value = c.id || c._id || c.classId || c.code; opt.textContent = c.name || c.title || opt.value; classSelect.appendChild(opt);
        });
        // attendance & grade selects
        ['attClassSelect','gradeClassSelect'].forEach(id => {
          const el = document.getElementById(id);
          if (!el) return;
          el.innerHTML = '';
          classes.forEach(c => {
            const o = document.createElement('option'); o.value = c.id || c._id || c.classId || c.code; o.textContent = c.name || c.title || o.value; el.appendChild(o);
          });
        });
        // show first roster by default
        if (classes.length) {
          showRoster(classes[0].id || classes[0]._id || classes[0].classId || classes[0].code);
        } else {
          const tbody = document.querySelector('#rosterTable tbody'); tbody.innerHTML = ''; document.getElementById('rosterTitle').textContent = 'No classes';
          document.getElementById('rosterMeta').textContent = '0 students';
        }
      }

      function showRoster(classId) {
        const cls = classes.find(c => (c.id===classId || c._id===classId || c.classId===classId || c.code===classId));
        const tbody = document.querySelector('#rosterTable tbody'); tbody.innerHTML = '';
        if (!cls || !Array.isArray(cls.students) || !cls.students.length) {
          tbody.innerHTML = '<tr><td colspan="5" class="empty">No students found in this class.</td></tr>';
          document.getElementById('rosterTitle').textContent = cls ? (cls.name || cls.title) : 'Class';
          document.getElementById('rosterMeta').textContent = cls ? `${(cls.students || []).length} students` : '0 students';
          return;
        }
        cls.students.forEach((s, idx) => {
          const tr = document.createElement('tr');
          tr.innerHTML = `<td>${idx+1}</td><td>${s.name || s.fullName || '‚Äî'}</td><td>${s.admission || s.regNo || '‚Äî'}</td><td>${s.contact || s.phone || '‚Äî'}</td><td><button class="btn ghost" data-action="profile" data-id="${s.id || s._id || ''}">Profile</button></td>`;
          tbody.appendChild(tr);
        });
        document.getElementById('rosterTitle').textContent = cls.name || cls.title || 'Class';
        document.getElementById('rosterMeta').textContent = `${cls.students.length} students`;
      }

      function renderAssignments() {
        const wrap = document.getElementById('assignList'); wrap.innerHTML = '';
        if (!assignments.length) { wrap.innerHTML = '<div class="empty">No assignments yet</div>'; return; }
        assignments.forEach(a => {
          const c = document.createElement('article'); c.className='card';
          c.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center"><div><div style="font-weight:800">${a.title || a.name}</div><div class="muted-small">${a.className || a.class || a.classId || ''}</div></div><div style="text-align:right">${a.due ? ('Due ' + new Date(a.due).toLocaleDateString()) : ''}</div></div>
            <div style="margin-top:8px;display:flex;gap:8px"><button class="btn" data-action="viewAssign" data-id="${a.id||a._id||''}">View</button><button class="btn ghost" data-action="grade" data-id="${a.id||a._id||''}">Grade</button></div>`;
          wrap.appendChild(c);
        });
      }

      function renderGradebook(classId) {
        const wrap = document.getElementById('gradebookWrap'); wrap.innerHTML = '';
        const cls = classes.find(c => (c.id===classId || c._id===classId || c.classId===classId));
        if (!cls || !Array.isArray(cls.students)) { wrap.innerHTML = '<div class="empty">Select a class</div>'; return; }
        const table = document.createElement('table');
        const thead = document.createElement('thead'); thead.innerHTML = '<tr><th>#</th><th>Student</th><th>Assessment</th><th>Score</th></tr>';
        const tbody = document.createElement('tbody');
        cls.students.forEach((s, i) => {
          const tr = document.createElement('tr');
          tr.innerHTML = `<td>${i+1}</td><td>${s.name||s.fullName}</td><td><input type="text" value="Assessment A" data-student="${s.id||s._id}"></td><td><input type="number" min="0" max="100" data-student="${s.id||s._id}"></td>`;
          tbody.appendChild(tr);
        });
        table.appendChild(thead); table.appendChild(tbody); wrap.appendChild(table);
      }

      function renderExams() {
        const wrap = document.getElementById('examList'); wrap.innerHTML = '';
        if (!exams.length) { wrap.innerHTML = '<div class="empty">No exams scheduled</div>'; return; }
        exams.forEach(ex => {
          const card = document.createElement('article'); card.className='card';
          card.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center"><div><div style="font-weight:800">${ex.title || ex.name}</div><div class="muted-small">${ex.className || ex.class || ''}</div></div><div>${ex.date ? (new Date(ex.date).toLocaleDateString()) : ''}</div></div>
            <div style="margin-top:8px;display:flex;gap:8px"><button class="btn" data-action="openExam" data-id="${ex.id||ex._id||''}">Open</button><button class="btn ghost" data-action="editExam" data-id="${ex.id||ex._id||''}">Edit</button></div>`;
          wrap.appendChild(card);
        });
      }

      function renderResources() {
        const wrap = document.getElementById('resGrid'); wrap.innerHTML = '';
        if (!resources.length) { wrap.innerHTML = '<div class="empty">No resources uploaded</div>'; return; }
        const grid = document.createElement('div'); grid.className='grid';
        resources.forEach(r => {
          const c = document.createElement('article'); c.className='card';
          c.innerHTML = `<div style="font-weight:800">${r.title || r.name}</div><div class="muted-small">${r.type || r.mime || ''} ‚Ä¢ ${r.uploaded || r.createdAt || ''}</div><div style="margin-top:8px;display:flex;gap:8px"><button class="btn" data-action="download" data-id="${r.id||r._id||''}">Download</button><button class="btn ghost" data-action="link" data-id="${r.id||r._id||''}">Link</button></div>`;
          grid.appendChild(c);
        });
        wrap.appendChild(grid);
      }

      function renderMessages() {
        const wrap = document.getElementById('msgList'); wrap.innerHTML = '';
        if (!messages.length) { wrap.innerHTML = '<div class="empty">No messages</div>'; return; }
        messages.forEach(m => {
          const card = document.createElement('article'); card.className='card';
          card.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center"><div><div style="font-weight:800">${m.subject || m.title}</div><div class="muted-small">${m.to || m.target || ''}</div></div><div>${m.time ? new Date(m.time).toLocaleString() : ''}</div></div><div style="margin-top:8px" class="muted-small">${m.body || m.text}</div><div style="margin-top:8px;display:flex;gap:8px"><button class="btn" data-action="reply" data-id="${m.id||m._id||''}">Reply</button><button class="btn ghost" data-action="archive" data-id="${m.id||m._id||''}">Archive</button></div>`;
          wrap.appendChild(card);
        });
      }

      // Actions (POST/PUT to server when possible, otherwise fallback)
      async function postAction(candidates, payload) {
        for (const url of candidates) {
          try {
            const res = await fetch(url, { method:'POST', headers: headers(), body: JSON.stringify(payload) });
            if (!res.ok) continue;
            return await res.json();
          } catch (err) { console.warn('post candidate failed', url, err); }
        }
        throw new Error('No endpoint available');
      }

      // modal helpers
      const itemModal = document.getElementById('itemModal');
      const itemModalBody = document.getElementById('itemModalBody');
      const closeItemModal = document.getElementById('closeItemModal');
      function openItemModal(html) { itemModalBody.innerHTML = html; itemModal.classList.add('active'); itemModal.setAttribute('aria-hidden','false'); setTimeout(()=>closeItemModal.focus(),50); }
      function closeItemModalFn() { itemModal.classList.remove('active'); itemModal.setAttribute('aria-hidden','true'); }
      closeItemModal.addEventListener('click', closeItemModalFn);

      const formModal = document.getElementById('formModal');
      const formModalBody = document.getElementById('formModalBody');
      const closeFormModal = document.getElementById('closeFormModal');
      function openFormModal(title, bodyHtml) { document.getElementById('formModalTitle').textContent = title; formModalBody.innerHTML = bodyHtml || ''; formModal.classList.add('active'); formModal.setAttribute('aria-hidden','false'); }
      function closeFormModalFn() { formModal.classList.remove('active'); formModal.setAttribute('aria-hidden','true'); formModalBody.innerHTML = ''; }
      closeFormModal.addEventListener('click', closeFormModalFn);

      // Delegated UI events
      document.body.addEventListener('click', async (e) => {
        const t = e.target;

        // profile
        if (t.matches('button[data-action="profile"]')) {
          const id = t.dataset.id;
          // try fetch student profile
          showLoader('Loading profile...', 'Contacting server');
          try {
            let student = null;
            if (TOKEN) {
              const candidates = [`${API_BASE}/students/${encodeURIComponent(id)}`, `${API_BASE}/users/${encodeURIComponent(id)}`];
              const data = await tryFetchCandidates(candidates, { headers: headers() });
              if (Array.isArray(data) && data[0]) student = data[0];
            }
            hideLoader();
            if (!student) openItemModal(`<div style="font-weight:800">Student</div><div class="muted-small">Profile not available</div>`);
            else openItemModal(`<div style="font-weight:800">${student.name || student.fullName}</div><div class="muted-small">Admission: ${student.admission || student.regNo || ''}</div><div style="margin-top:8px">Contact: ${student.contact || student.phone || ''}</div>`);
          } catch (err) { hideLoader(); console.error(err); alert('Failed to load profile'); }
        }

        // assignment view/grade
        if (t.matches('button[data-action="viewAssign"]')) {
          const id = t.dataset.id;
          const a = assignments.find(x=> (x.id===id || x._id===id));
          if (a) openItemModal(`<div style="font-weight:800">${a.title}</div><div class="muted-small">Class: ${a.className || a.class || ''}</div><div style="margin-top:8px">Due: ${a.due ? new Date(a.due).toLocaleDateString() : '‚Äî'}</div>`);
        }
        if (t.matches('button[data-action="grade"]')) {
          const id = t.dataset.id;
          openFormModal('Grade submissions', `<div class="muted-small">Opening grading interface for ${id} (server integration required).</div><div style="margin-top:12px;display:flex;justify-content:flex-end"><button id="closeFormInline" class="btn ghost">Close</button></div>`);
          setTimeout(()=> document.getElementById('closeFormInline')?.addEventListener('click', closeFormModalFn), 50);
        }

        // exam actions
        if (t.matches('button[data-action="openExam"]')) {
          const id = t.dataset.id;
          const ex = exams.find(x=> (x.id===id || x._id===id));
          if (!ex) { openItemModal('<div class="muted-small">Exam not found</div>'); return; }
          openItemModal(`<div style="font-weight:800">${ex.title}</div><div class="muted-small">${ex.date ? new Date(ex.date).toLocaleDateString() : ''} ‚Ä¢ ${ex.duration ? ex.duration + ' mins' : ''}</div><div style="margin-top:12px;display:flex;justify-content:flex-end;gap:8px"><button class="btn" id="openSessionBtn">Open session</button><button class="btn ghost" id="closeItemInline">Close</button></div>`);
          setTimeout(()=> {
            document.getElementById('openSessionBtn')?.addEventListener('click', async ()=> {
              // attempt to open/manage session via backend
              try {
                showLoader('Opening session...', 'Contacting server');
                const candidates = [
                  `${API_BASE}/exams/${encodeURIComponent(id)}/sessions`,
                  `${API_BASE}/exams/${encodeURIComponent(id)}/start`,
                  `${API_BASE}/exams/sessions`
                ];
                let created = null;
                for (const url of candidates) {
                  try {
                    const res = await fetch(url, { method:'POST', headers: headers(), body: JSON.stringify({ examId: id }) });
                    if (!res.ok) continue;
                    const data = await res.json();
                    created = data;
                    break;
                  } catch (err) {}
                }
                hideLoader();
                if (created) alert('Session opened (server returned confirmation).'); else alert('Session could not be opened (no endpoint).');
              } catch (err) { hideLoader(); alert('Error opening session'); }
            });
            document.getElementById('closeItemInline')?.addEventListener('click', closeItemModalFn);
          }, 50);
        }

        // resource actions
        if (t.matches('button[data-action="download"]')) {
          const id = t.dataset.id;
          alert('Download request (implement endpoint).');
        }
        if (t.matches('button[data-action="link"]')) {
          const id = t.dataset.id;
          openFormModal('Link resource', `<div class="muted-small">Link resource ${id} to class (server integration needed)</div><div style="margin-top:12px;display:flex;justify-content:flex-end"><button id="closeFormInline" class="btn ghost">Close</button></div>`);
          setTimeout(()=> document.getElementById('closeFormInline')?.addEventListener('click', closeFormModalFn), 50);
        }

        // messages
        if (t.matches('button[data-action="reply"]')) {
          const id = t.dataset.id;
          openFormModal('Reply', `<form id="replyForm"><label>Message<textarea id="replyText" style="width:100%;height:120px;border:1px solid #e6e9ef;border-radius:8px"></textarea></label><div style="display:flex;justify-content:flex-end;gap:8px;margin-top:8px"><button type="button" class="btn ghost" id="closeFormInline">Cancel</button><button type="submit" class="btn">Send</button></div></form>`);
          setTimeout(()=> {
            const f = document.getElementById('replyForm');
            f?.addEventListener('submit', async (ev) => {
              ev.preventDefault();
              const text = document.getElementById('replyText').value.trim();
              if (!text) return alert('Message required');
              // attempt to send via backend
              try {
                const candidate = `${API_BASE}/messages/${encodeURIComponent(id)}/reply`;
                const res = await fetch(candidate, { method:'POST', headers: headers(), body: JSON.stringify({ body: text }) });
                if (res.ok) { alert('Reply sent'); closeFormModalFn(); } else { alert('Failed to send reply'); }
              } catch (err) { alert('Failed to send reply'); }
            });
            document.getElementById('closeFormInline')?.addEventListener('click', closeFormModalFn);
          }, 50);
        }

      });

      // select changes and buttons
      document.getElementById('classSelect').addEventListener('change', (e) => showRoster(e.target.value));
      document.getElementById('loadAttendanceBtn').addEventListener('click', () => {
        const cid = document.getElementById('attClassSelect').value;
        const date = document.getElementById('attDate').value || new Date().toISOString().slice(0,10);
        loadAttendance(cid, date);
      });
      document.getElementById('saveGradesBtn')?.addEventListener('click', async () => {
        // collect values
        const inputs = document.querySelectorAll('#gradebookWrap input[type="number"]');
        const payload = [];
        inputs.forEach(inp => {
          const student = inp.dataset.student;
          payload.push({ studentId: student, score: inp.value });
        });
        // attempt server save
        try {
          const res = await fetch(`${API_BASE}/gradebook/save`, { method:'POST', headers: headers(), body: JSON.stringify({ grades: payload }) });
          if (res.ok) alert('Grades saved'); else alert('Failed to save grades');
        } catch (err) { alert('Save failed'); }
      });

      // attendance load & save
      function loadAttendance(classId, date) {
        const wrap = document.getElementById('attendanceWrap'); wrap.innerHTML = '';
        if (!classId) { wrap.innerHTML = '<div class="empty">Select a class</div>'; return; }
        const cls = classes.find(c => (c.id===classId || c._id===classId || c.classId===classId));
        if (!cls || !Array.isArray(cls.students) || !cls.students.length) { wrap.innerHTML = '<div class="empty">No students</div>'; return; }
        const table = document.createElement('table'); table.innerHTML = '<thead><tr><th>#</th><th>Student</th><th>Present</th><th>Notes</th></tr></thead>';
        const tbody = document.createElement('tbody');
        cls.students.forEach((s, i) => {
          const tr = document.createElement('tr');
          tr.innerHTML = `<td>${i+1}</td><td>${s.name}</td><td><input type="checkbox" data-id="${s.id||s._id}" checked></td><td><input type="text" data-id="${s.id||s._id}" placeholder="notes"></td>`;
          tbody.appendChild(tr);
        });
        table.appendChild(tbody);
        const actions = document.createElement('div'); actions.style.marginTop='8px';
        actions.innerHTML = `<button class="btn" id="saveAttBtn">Save attendance</button> <button class="btn ghost" id="clearAttBtn">Clear</button>`;
        wrap.appendChild(table); wrap.appendChild(actions);

        // save handler
        document.getElementById('saveAttBtn').addEventListener('click', async () => {
          const rows = Array.from(tbody.querySelectorAll('tr'));
          const records = rows.map(r => {
            const id = r.querySelector('input[type="checkbox"]').dataset.id;
            const present = r.querySelector('input[type="checkbox"]').checked;
            const notes = r.querySelector('input[type="text"]').value;
            return { studentId: id, present, notes, date };
          });
          try {
            const res = await fetch(`${API_BASE}/attendance/save`, { method:'POST', headers: headers(), body: JSON.stringify({ classId, date, records }) });
            if (res.ok) alert('Attendance saved'); else alert('Failed to save attendance');
          } catch (err) { alert('Attendance save failed'); }
        });

        document.getElementById('clearAttBtn').addEventListener('click', () => {
          tbody.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = false);
          tbody.querySelectorAll('input[type="text"]').forEach(i => i.value = '');
        });
      }

      // create class form
      document.getElementById('newClassBtn').addEventListener('click', () => {
        openFormModal('Create class', `<form id="createClassForm"><label>Class name<input type="text" id="newClassName" required></label><div style="display:flex;justify-content:flex-end;margin-top:12px"><button type="submit" class="btn">Create</button></div></form>`);
        setTimeout(()=> {
          const f = document.getElementById('createClassForm');
          f?.addEventListener('submit', async (ev) => {
            ev.preventDefault();
            const name = document.getElementById('newClassName').value.trim();
            if (!name) return alert('Enter class name');
            // post to server
            try {
              const res = await fetch(`${API_BASE}/classes`, { method:'POST', headers: headers(), body: JSON.stringify({ name }) });
              if (res.ok) {
                const data = await res.json();
                classes.unshift(data.class || data);
                renderClassOptions();
                closeFormModalFn();
                alert('Class created');
              } else {
                alert('Failed to create class');
              }
            } catch (err) {
              alert('Failed to create class');
            }
          });
        }, 50);
      });

      // schedule exam
      document.getElementById('scheduleExamBtn').addEventListener('click', () => {
        openFormModal('Schedule exam', `<form id="scheduleExamForm" style="display:grid;gap:8px"><label>Title<input id="schTitle"></label><label>Class<select id="schClass">${classes.map(c=>`<option value="${c.id||c._id}">${c.name||c.title}</option>`).join('')}</select></label><label>Date<input type="date" id="schDate"></label><div style="display:flex;justify-content:flex-end"><button class="btn" type="submit">Schedule</button></div></form>`);
        setTimeout(()=> {
          const f = document.getElementById('scheduleExamForm');
          f?.addEventListener('submit', async (ev) => {
            ev.preventDefault();
            const title = document.getElementById('schTitle').value.trim();
            const cls = document.getElementById('schClass').value;
            const date = document.getElementById('schDate').value;
            try {
              const res = await fetch(`${API_BASE}/exams`, { method:'POST', headers: headers(), body: JSON.stringify({ title, classId: cls, date }) });
              if (res.ok) {
                const d = await res.json();
                exams.unshift(d.exam || d);
                renderExams();
                closeFormModalFn();
                alert('Exam scheduled');
              } else alert('Failed to schedule exam');
            } catch (err) { alert('Error scheduling exam'); }
          });
        }, 50);
      });

      // settings save
      document.getElementById('teacherSettings')?.addEventListener('submit', async (e) => {
        e.preventDefault();
        const name = document.getElementById('setName').value.trim();
        const dept = document.getElementById('setDept').value.trim();
        const email = document.getElementById('setEmail').value.trim();
        try {
          const res = await fetch(`${API_BASE}/teachers/me`, { method:'PUT', headers: headers(), body: JSON.stringify({ name, dept, email }) });
          if (res.ok) alert('Settings saved');
          else alert('Failed to save settings');
        } catch (err) { alert('Save failed'); }
      });

      // init: fetch profile and teacher data
      async function init() {
        showLoader('Loading teacher dashboard...', 'Fetching profile and classes');
        try {
          const profile = await (async () => {
            const local = (function(){ try { return JSON.parse(localStorage.getItem('eg_application')||'null')||null } catch { return null; } })();
            if (!TOKEN) return local || {};
            const candidates = [`${API_BASE}/me`, `${API_BASE}/profile`, `${API_BASE}/users/me`];
            for (const url of candidates) {
              try {
                const res = await fetch(url, { headers: headers() });
                if (!res.ok) continue;
                const data = await res.json();
                return data.user || data || local || {};
              } catch (err) {}
            }
            return local || {};
          })();

          if (profile) {
            teacherNameEl.textContent = (profile.firstName || profile.name || profile.username || 'Teacher') + (profile.lastName ? (' ' + profile.lastName) : '');
            teacherDeptEl.textContent = profile.department || profile.dept || profile.subject || '';
            if (profile.profilePic) { teacherAvatar.src = profile.profilePic; topbarAvatar.src = profile.profilePic; }
            if (profile.session) termInfo.textContent = profile.session;
          }

          const teacherId = profile && (profile.id || profile._id || profile.teacherId || profile.username);

          // fetch teacher data
          const fetched = await fetchTeacherData(teacherId);
          classes = Array.isArray(fetched.classes) ? fetched.classes : [];
          assignments = Array.isArray(fetched.assignments) ? fetched.assignments : [];
          exams = Array.isArray(fetched.exams) ? fetched.exams : [];
          resources = Array.isArray(fetched.resources) ? fetched.resources : [];
          messages = Array.isArray(fetched.messages) ? fetched.messages : [];

          // render sections
          renderOverview();
          renderClassOptions();
          renderAssignments();
          renderExams();
          renderResources();
          renderMessages();
          renderGradebook((classes[0] && (classes[0].id||classes[0]._id)) || '');
        } catch (err) {
          console.error('init error', err);
        } finally {
          hideLoader();
        }
      }

      // responsive sidebar
      function handleResize() {
        if (window.innerWidth > 720) {
          sidebar.classList.remove('hidden');
          sidebar.classList.remove('open');
          overlay.classList.remove('visible');
          document.body.classList.remove('no-scroll');
        } else {
          sidebar.classList.add('hidden');
        }
      }
      window.addEventListener('resize', handleResize);
      handleResize();

      // Close modals on Escape
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
          document.querySelectorAll('.modal.active').forEach(m => m.classList.remove('active'));
        }
      });

      // start
      init();

      // expose helper
      window.eg = { init };

    })();
  </script>
</body>
</html>
