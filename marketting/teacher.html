<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Teacher Dashboard | ExamGuard</title>
  <meta name="viewport" content="width=device-width,initial-scale=0.901" />
  <link href="https://fonts.googleapis.com/css?family=Inter:400,600,700&display=swap" rel="stylesheet">
  <link rel="icon" href="../logo.png">
  <style>
    /* Reused styling from others.html with small teacher-focused tweaks */
    :root{
      --bg-0:#f6f8ff; --bg-1:#eef2ff;
      --accent:#3b82f6; --accent-2:#6366f1; --muted:#6b7280;
      --card-bg:#ffffff; --sidebar-w:300px;
      --radius:12px;
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;font-family:Inter,system-ui,Arial;background:linear-gradient(180deg,var(--bg-0),var(--bg-1));-webkit-font-smoothing:antialiased;color:#0b2a44}
    a{color:inherit;text-decoration:none}
    .app{display:flex;min-height:100vh;align-items:stretch}
    .overlay{position:fixed;inset:0;background:rgba(2,6,23,0.45);z-index:50;display:none}
    .overlay.visible{display:block}

    /* Sidebar (desktop instant show) */
    .sidebar{
      width:var(--sidebar-w);min-width:var(--sidebar-w);
      background:linear-gradient(180deg,#0f172a 0%, #1e3a8a 100%);color:#fff;padding:20px 16px;position:fixed;left:0;top:0;bottom:0;z-index:100;
      box-shadow:4px 0 28px rgba(15,23,42,0.12);display:flex;flex-direction:column;gap:14px;overflow-y:auto;transition:none;
    }
    @media (max-width:720px){
      .sidebar{transform:translateX(-110%);transition:transform .28s ease;position:fixed;width:86vw;min-width:86vw}
      .sidebar.hidden{transform:translateX(-110%)}
      .sidebar.open{transform:translateX(0);box-shadow:0 24px 48px rgba(2,6,23,0.5)}
    }

    .brand{display:flex;gap:12px;align-items:center}
    .brand img{width:44px;height:44px;border-radius:10px;object-fit:cover;border:3px solid rgba(255,224,102,0.12);background:#fff}
    .brand .title{font-weight:800;font-size:1.05rem;color:#ffe066}
    .nav{display:flex;flex-direction:column;gap:8px;margin-top:6px}
    .nav a{display:flex;align-items:center;gap:10px;padding:12px;border-radius:10px;font-weight:700;font-size:1rem;color:#e6eefc}
    .nav a.active,.nav a:hover{background:rgba(255,255,255,0.04);color:#ffe066}

    /* teacher submenu inside sidebar */
    .subnav{display:flex;flex-direction:column;gap:6px;margin-top:8px;padding-top:8px;border-top:1px dashed rgba(255,255,255,0.04)}
    .subnav a{padding:10px;border-radius:8px;color:var(--accent-2);font-weight:700;background:transparent}
    .subnav a.active{background:linear-gradient(90deg,var(--accent),var(--accent-2));color:#fff}

    .spacer{flex:1}
    .profile{display:flex;gap:12px;align-items:center;padding-top:10px;border-top:1px solid rgba(255,255,255,0.04)}
    .profile img{width:48px;height:48px;border-radius:10px;object-fit:cover;border:2px solid #ffe066}

    /* Topbar */
    .topbar{position:fixed;left:var(--sidebar-w);top:0;width:calc(100vw - var(--sidebar-w));z-index:90;display:flex;align-items:center;justify-content:space-between;gap:12px;padding:12px 14px;backdrop-filter: blur(6px);background: rgba(255,255,255,0.92);border-bottom:1px solid rgba(11,42,60,0.06);box-shadow:0 6px 18px rgba(11,42,60,0.04);min-height:64px}
    @media (max-width:720px){.topbar{left:0;width:100vw;padding:10px 12px;min-height:56px}}

    .hamburger{display:none;background:var(--accent);color:#fff;border:none;padding:9px 12px;border-radius:10px;cursor:pointer;font-weight:800}
    @media (max-width:980px){.hamburger{display:inline-flex}}

    .page-title{font-weight:800;font-size:1.05rem;color:var(--accent-2)}
    .small{font-size:0.92rem;color:var(--muted)}

    .main{margin-left:var(--sidebar-w);padding:20px;flex:1;transition:margin-left .28s;min-height:100vh;padding-top:90px;overflow-y:auto}
    @media (max-width:720px){.main{margin-left:0;padding:14px;padding-top:80px}}

    /* Content layout */
    .content{display:flex;flex-direction:column;gap:12px}
    .section{background:var(--card-bg);border-radius:12px;padding:16px;border:1px solid #eef3ff}
    .section h2{margin:0 0 8px 0;font-size:1.05rem}
    .grid{display:grid;grid-template-columns:repeat(3,1fr);gap:12px}
    @media (max-width:980px){.grid{grid-template-columns:repeat(2,1fr)}}
    @media (max-width:720px){.grid{grid-template-columns:1fr}}

    .card{background:#fff;border-radius:12px;padding:12px;border:1px solid #eef3ff;display:flex;flex-direction:column;gap:8px}
    .card .title{font-weight:800}
    .card .meta{color:var(--muted);font-size:0.92rem}

    .controls{display:flex;gap:8px;flex-wrap:wrap}
    .btn{padding:9px 12px;border-radius:10px;border:none;cursor:pointer;background:linear-gradient(90deg,var(--accent),var(--accent-2));color:#fff;font-weight:800}
    .btn.ghost{background:transparent;color:var(--accent-2);border:1px solid rgba(59,130,246,0.08)}

    /* forms & tables */
    table{width:100%;border-collapse:collapse}
    table th, table td{padding:8px;border-bottom:1px solid #f1f5fb;text-align:left}
    input[type="text"], input[type="number"], select, textarea{padding:8px;border-radius:8px;border:1px solid #e6e9ef;width:100%}

    /* modals */
    .modal{position:fixed;inset:0;background:rgba(2,6,23,0.45);display:none;align-items:center;justify-content:center;z-index:9999;padding:12px}
    .modal.active{display:flex}
    .modal .panel{background:#fff;border-radius:12px;max-width:980px;width:100%;overflow:hidden;box-shadow:0 20px 60px rgba(2,6,23,0.25)}
    .modal .head{padding:12px 16px;border-bottom:1px solid #eef3ff;background:#f8fbff;display:flex;justify-content:space-between;align-items:center}
    .modal .body{padding:14px;max-height:72vh;overflow:auto}

    .muted-small{font-size:0.9rem;color:var(--muted)}
    .empty{padding:28px;text-align:center;color:var(--muted);border:1px dashed #eef3ff;border-radius:12px}

    :focus{outline:3px solid rgba(99,102,241,0.18);outline-offset:2px;border-radius:6px}

    /* page loader */
    .page-loader {
      position: fixed;
      inset: 0;
      display: none;
      align-items: center;
      justify-content: center;
      gap: 12px;
      z-index: 1200;
      background: rgba(255,255,255,0.9);
      backdrop-filter: blur(3px);
      flex-direction: column;
    }
    .page-loader.active { display:flex; }
    .page-loader .spinner { width:44px;height:44px;border-radius:50%;border:6px solid rgba(0,0,0,0.06);border-top-color:var(--accent);animation:spin 1s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }
    .page-loader .msg { font-weight:800; color:#0b2a44; }
    .page-loader .sub { color:var(--muted); font-size:0.92rem; }
  </style>
</head>
<body>
  <div class="app" id="app">
    <div class="overlay" id="overlay" aria-hidden="true"></div>

    <!-- Page loader -->
    <div id="pageLoader" class="page-loader" role="status" aria-live="polite" aria-hidden="true">
      <div class="spinner" aria-hidden="true"></div>
      <div class="msg" id="loaderMsg">Loading dashboard...</div>
      <div class="sub" id="loaderSub">Fetching your profile and data</div>
    </div>

    <aside class="sidebar" id="sidebar" aria-label="Main navigation" role="navigation" aria-hidden="false">
      <div class="brand">
        <img src="../logo.png" alt="Logo">
        <div>
          <div class="title">Teacher Portal</div>
          <div class="small">ExamGuard ‚Ä¢ Faculty</div>
        </div>
      </div>

      <nav class="nav" aria-label="Primary">
        <a href="teacher-dashboard.html" class="active">üè† Home</a>

        <div class="subnav" role="menu" aria-label="Teacher sections">
          <a href="#overview" data-tab="overview" class="sidebar-tab" role="menuitem">üìä Overview</a>
          <a href="#classes" data-tab="classes" class="sidebar-tab" role="menuitem">üë©‚Äçüè´ Classes</a>
          <a href="#attendance" data-tab="attendance" class="sidebar-tab" role="menuitem">üìù Attendance</a>
          <a href="#assignments" data-tab="assignments" class="sidebar-tab" role="menuitem">üóÇ Assignments</a>
          <a href="#gradebook" data-tab="gradebook" class="sidebar-tab" role="menuitem">üìö Gradebook</a>
          <a href="#exams" data-tab="exams" class="sidebar-tab" role="menuitem">üñ• Exams</a>
          <a href="#resources" data-tab="resources" class="sidebar-tab" role="menuitem">üìÇ Resources</a>
          <a href="#messages" data-tab="messages" class="sidebar-tab" role="menuitem">‚úâÔ∏è Messages</a>
          <a href="#settings" data-tab="settings" class="sidebar-tab" role="menuitem">‚öôÔ∏è Settings</a>
        </div>
      </nav>

      <div class="spacer" aria-hidden="true"></div>

      <div class="profile">
        <img src="../avatar.jpg" alt="Teacher avatar" id="teacherAvatar">
        <div>
          <div style="font-weight:800" id="teacherName">Teacher</div>
          <div class="muted-small" id="teacherDept">‚Äî</div>
        </div>
      </div>
    </aside>

    <div class="topbar">
      <div style="display:flex;gap:12px;align-items:center;">
        <button class="hamburger" id="hamburger" aria-label="Open menu">‚ò∞</button>
        <div>
          <div class="page-title">Teacher Dashboard</div>
          <div class="small muted">Manage classes, assessments & communications</div>
        </div>
      </div>

      <div style="display:flex;gap:12px;align-items:center;">
        <div class="muted-small" id="termInfo">‚Äî</div>
        <img src="../avatar.jpg" alt="you" style="width:44px;height:44px;border-radius:8px;border:2px solid #fff" id="topbarAvatar">
      </div>
    </div>

    <main class="main" id="main" role="main" tabindex="-1">
      <div class="content" id="contentArea">
        <!-- Overview -->
        <section id="overview" class="section tab-section" role="region" aria-labelledby="ovTitle">
          <h2 id="ovTitle">Overview</h2>
          <div class="muted-small">Quick stats and recent activity</div>

          <div style="margin-top:12px" class="grid">
            <div class="card">
              <div class="small muted">Classes</div>
              <div style="font-weight:900;font-size:1.2rem" id="statClasses">--</div>
              <div class="muted-small">Active this term</div>
            </div>

            <div class="card">
              <div class="small muted">Students</div>
              <div style="font-weight:900;font-size:1.2rem" id="statStudents">--</div>
              <div class="muted-small">Total across classes</div>
            </div>

            <div class="card">
              <div class="small muted">Pending submissions</div>
              <div style="font-weight:900;font-size:1.2rem" id="statPending">--</div>
              <div class="muted-small">Awaiting grading</div>
            </div>
          </div>

          <div style="margin-top:12px;">
            <div style="display:flex;justify-content:space-between;align-items:center">
              <div style="font-weight:800">Recent activity</div>
              <div class="muted-small">All actions</div>
            </div>
            <div style="margin-top:8px" id="activityList"></div>
          </div>
        </section>

        <!-- Classes -->
        <section id="classes" class="section tab-section" role="region" aria-labelledby="classesTitle" style="display:none">
          <h2 id="classesTitle">Classes</h2>
          <div class="muted-small">Your classes and rosters</div>

          <div style="margin-top:12px" class="controls">
            <select id="classSelect"></select>
            <button class="btn" id="newClassBtn">Create class</button>
            <button class="btn ghost" id="exportRosterBtn">Export roster</button>
          </div>

          <div style="margin-top:12px" id="rosterWrap">
            <div class="card" id="rosterCard">
              <div style="display:flex;justify-content:space-between;align-items:center">
                <div><strong id="rosterTitle">Class</strong></div>
                <div class="muted-small" id="rosterMeta">-- students</div>
              </div>

              <div style="margin-top:10px">
                <table id="rosterTable" aria-label="Class roster">
                  <thead><tr><th>#</th><th>Name</th><th>Admission</th><th>Contact</th><th>Actions</th></tr></thead>
                  <tbody></tbody>
                </table>
              </div>
            </div>
          </div>
        </section>

        <!-- Attendance -->
        <section id="attendance" class="section tab-section" role="region" aria-labelledby="attTitle" style="display:none">
          <h2 id="attTitle">Attendance</h2>
          <div class="muted-small">Mark attendance quickly</div>

          <div style="margin-top:12px" class="controls">
            <select id="attClassSelect"></select>
            <input type="date" id="attDate">
            <button class="btn" id="loadAttendanceBtn">Load</button>
          </div>

          <div style="margin-top:12px" id="attendanceWrap"></div>
        </section>

        <!-- Assignments -->
        <section id="assignments" class="section tab-section" role="region" aria-labelledby="assignTitle" style="display:none">
          <h2 id="assignTitle">Assignments</h2>
          <div class="muted-small">Create assignments, collect submissions & grade</div>

          <div style="margin-top:12px" class="controls">
            <button class="btn" id="newAssignBtn">New assignment</button>
            <button class="btn ghost" id="viewSubmissionsBtn">View submissions</button>
          </div>

          <div style="margin-top:12px" id="assignList"></div>
        </section>

        <!-- Gradebook -->
        <section id="gradebook" class="section tab-section" role="region" aria-labelledby="gradeTitle" style="display:none">
          <h2 id="gradeTitle">Gradebook</h2>
          <div class="muted-small">Enter grades and export reports</div>

          <div style="margin-top:12px" class="controls">
            <select id="gradeClassSelect"></select>
            <select id="gradeAssessmentSelect"><option>Assessment A</option></select>
            <button class="btn" id="saveGradesBtn">Save grades</button>
            <button class="btn ghost" id="exportGradesBtn">Export CSV</button>
          </div>

          <div style="margin-top:12px" id="gradebookWrap"></div>
        </section>

        <!-- Exams -->
        <section id="exams" class="section tab-section" role="region" aria-labelledby="examTitle" style="display:none">
          <h2 id="examTitle">Exams</h2>
          <div class="muted-small">Schedule CBT exams and view sessions</div>

          <div style="margin-top:12px" class="controls">
            <button class="btn" id="scheduleExamBtn">Schedule exam</button>
            <button class="btn ghost" id="manageSessionsBtn">Manage sessions</button>
          </div>

          <div style="margin-top:12px" id="examList"></div>
        </section>

        <!-- Resources -->
        <section id="resources" class="section tab-section" role="region" aria-labelledby="resTitle" style="display:none">
          <h2 id="resTitle">Resources</h2>
          <div class="muted-small">Upload lesson materials and link to classes</div>

          <div style="margin-top:12px" class="controls">
            <input type="text" id="resSearch" placeholder="Search resources">
            <button class="btn" id="uploadResBtn">Upload</button>
          </div>

          <div style="margin-top:12px" id="resGrid"></div>
        </section>

        <!-- Messages -->
        <section id="messages" class="section tab-section" role="region" aria-labelledby="msgTitle" style="display:none">
          <h2 id="msgTitle">Messages</h2>
          <div class="muted-small">Send announcements to classes or individual students</div>

          <div style="margin-top:12px" class="controls">
            <select id="msgTarget"><option value="class">Class</option><option value="student">Student</option></select>
            <button class="btn" id="newMsgBtn">New message</button>
          </div>

          <div style="margin-top:12px" id="msgList"></div>
        </section>

        <!-- Settings -->
        <section id="settings" class="section tab-section" role="region" aria-labelledby="setTitle" style="display:none">
          <h2 id="setTitle">Settings</h2>
          <div class="muted-small">Manage profile and notification preferences</div>

          <form id="teacherSettings" style="margin-top:12px;display:grid;gap:8px;max-width:720px">
            <label>Display name<input type="text" id="setName"></label>
            <label>Department<input type="text" id="setDept"></label>
            <label>Email<input type="text" id="setEmail"></label>
            <div style="display:flex;gap:8px;justify-content:flex-end">
              <button type="button" class="btn ghost" id="resetSettings">Reset</button>
              <button type="submit" class="btn" id="saveSettings">Save</button>
            </div>
          </form>
        </section>
      </div>
    </main>

    <!-- Shared modals -->
    <div class="modal" id="itemModal" role="dialog" aria-modal="true" aria-hidden="true">
      <div class="panel" role="document">
        <div class="head">
          <div id="itemModalTitle" style="font-weight:800">Details</div>
          <div><button class="btn ghost" id="closeItemModal">Close</button></div>
        </div>
        <div class="body" id="itemModalBody"></div>
      </div>
    </div>

    <div class="modal" id="formModal" role="dialog" aria-modal="true" aria-hidden="true">
      <div class="panel" role="document">
        <div class="head">
          <div id="formModalTitle" style="font-weight:800">Form</div>
          <div><button class="btn ghost" id="closeFormModal">Close</button></div>
        </div>
        <div class="body" id="formModalBody">
          <!-- dynamic content -->
        </div>
      </div>
    </div>

  </div>

  <script>
    (function () {
      const API_BASE = 'https://examguide.onrender.com/api';
      const TOKEN = localStorage.getItem('eg_token') || null;

      // Loader
      const pageLoader = document.getElementById('pageLoader');
      const loaderMsg = document.getElementById('loaderMsg');
      const loaderSub = document.getElementById('loaderSub');
      function showLoader(msg, sub) {
        if (msg) loaderMsg.textContent = msg;
        if (sub) loaderSub.textContent = sub;
        pageLoader.classList.add('active'); pageLoader.setAttribute('aria-hidden','false');
      }
      function hideLoader() { pageLoader.classList.remove('active'); pageLoader.setAttribute('aria-hidden','true'); }

      // DOM refs
      const teacherNameEl = document.getElementById('teacherName');
      const teacherDeptEl = document.getElementById('teacherDept');
      const teacherAvatar = document.getElementById('teacherAvatar');
      const termInfo = document.getElementById('termInfo');
      const classSelect = document.getElementById('classSelect');
      const attClassSelect = document.getElementById('attClassSelect');
      const gradeClassSelect = document.getElementById('gradeClassSelect');

      // sections
      const activityList = document.getElementById('activityList');
      const rosterTableBody = document.querySelector('#rosterTable tbody');
      const rosterTitle = document.getElementById('rosterTitle');
      const rosterMeta = document.getElementById('rosterMeta');
      const attendanceWrap = document.getElementById('attendanceWrap');
      const assignList = document.getElementById('assignList');
      const gradebookWrap = document.getElementById('gradebookWrap');
      const examList = document.getElementById('examList');
      const resGrid = document.getElementById('resGrid');
      const msgList = document.getElementById('msgList');

      // modals
      const itemModal = document.getElementById('itemModal');
      const itemModalBody = document.getElementById('itemModalBody');
      const closeItemModalBtn = document.getElementById('closeItemModal');
      const formModal = document.getElementById('formModal');
      const formModalBody = document.getElementById('formModalBody');
      const closeFormModalBtn = document.getElementById('closeFormModal');

      // data containers (will be fetched)
      let teacherProfile = null;
      let classes = [];
      let assignments = [];
      let exams = [];
      let resources = [];
      let messages = [];

      // utility
      function headers(contentType='application/json') {
        const h = {};
        if (contentType) h['Content-Type'] = contentType;
        if (TOKEN) h['Authorization'] = 'Bearer ' + TOKEN;
        return h;
      }
      function tryFetchCandidates(candidates, opts={}) {
        return (async () => {
          for (const url of candidates) {
            if (!url) continue;
            try {
              const res = await fetch(url, opts);
              if (!res.ok) continue;
              const data = await res.json();
              if (Array.isArray(data)) return data;
              if (Array.isArray(data.items)) return data.items;
              if (Array.isArray(data.data)) return data.data;
              if (Array.isArray(data.results)) return data.results;
              if (Array.isArray(data.classes)) return data.classes;
              // single object wrap
              if (data && (data.id || data._id)) return [data];
            } catch (err) {
              console.warn('candidate fetch failed', url, err);
            }
          }
          return null;
        })();
      }

      // Fetchers
      async function fetchProfile() {
        const local = (function(){ try { return JSON.parse(localStorage.getItem('eg_application')||'null') || null; } catch { return null; } })();
        if (!TOKEN) return local || {};
        const candidates = [`${API_BASE}/me`, `${API_BASE}/profile`, `${API_BASE}/users/me`];
        for (const url of candidates) {
          try {
            const res = await fetch(url, { headers: headers() });
            if (!res.ok) continue;
            const data = await res.json();
            return data.user || data || local || {};
          } catch (err) {}
        }
        return local || {};
      }

      async function fetchClasses(teacherId) {
        const candidates = [
          `${API_BASE}/teachers/${encodeURIComponent(teacherId)}/classes`,
          `${API_BASE}/classes?teacher=${encodeURIComponent(teacherId)}`,
          `${API_BASE}/classes`
        ];
        return await tryFetchCandidates(candidates, { headers: headers() });
      }

      async function fetchAssignments(teacherId) {
        const candidates = [
          `${API_BASE}/assignments?teacher=${encodeURIComponent(teacherId)}`,
          `${API_BASE}/teachers/${encodeURIComponent(teacherId)}/assignments`,
          `${API_BASE}/assignments`
        ];
        return await tryFetchCandidates(candidates, { headers: headers() });
      }

      async function fetchExams(teacherId) {
        const candidates = [
          `${API_BASE}/exams?creator=${encodeURIComponent(teacherId)}`,
          `${API_BASE}/teachers/${encodeURIComponent(teacherId)}/exams`,
          `${API_BASE}/exams`
        ];
        return await tryFetchCandidates(candidates, { headers: headers() });
      }

      async function fetchResources(teacherId) {
        const candidates = [
          `${API_BASE}/resources?owner=${encodeURIComponent(teacherId)}`,
          `${API_BASE}/teachers/${encodeURIComponent(teacherId)}/resources`,
          `${API_BASE}/resources`
        ];
        return await tryFetchCandidates(candidates, { headers: headers() });
      }

      async function fetchMessages(teacherId) {
        const candidates = [
          `${API_BASE}/messages?user=${encodeURIComponent(teacherId)}`,
          `${API_BASE}/teachers/${encodeURIComponent(teacherId)}/messages`,
          `${API_BASE}/messages`
        ];
        return await tryFetchCandidates(candidates, { headers: headers() });
      }

      // Renderers (all tolerate empty arrays)
      function renderOverview() {
        document.getElementById('statClasses').textContent = classes.length || 0;
        const totalStudents = (classes || []).reduce((s,c) => s + (c.students ? c.students.length : 0), 0);
        document.getElementById('statStudents').textContent = totalStudents;
        const pending = (assignments || []).filter(a => a.pendingSubmissions > 0).length || 0;
        document.getElementById('statPending').textContent = pending;
        activityList.innerHTML = '';
        const recent = (messages || []).slice(0,5).map(m => `${m.subject || m.title || 'Message'} ‚Ä¢ ${new Date(m.time || m.createdAt || Date.now()).toLocaleString()}`);
        if (!recent.length) activityList.innerHTML = '<div class="muted-small">No recent activity</div>';
        else {
          const ul = document.createElement('ul');
          recent.forEach(r => { const li = document.createElement('li'); li.textContent = r; ul.appendChild(li); });
          activityList.appendChild(ul);
        }
      }

      function renderClassOptions() {
        classSelect.innerHTML = '';
        attClassSelect.innerHTML = '';
        gradeClassSelect.innerHTML = '';
        (classes || []).forEach(c => {
          const opt = document.createElement('option'); opt.value = c.id || c._id || c.classId; opt.textContent = c.name || c.title || opt.value;
          classSelect.appendChild(opt);
          const opt2 = opt.cloneNode(true); attClassSelect.appendChild(opt2);
          const opt3 = opt.cloneNode(true); gradeClassSelect.appendChild(opt3);
        });
        if (classSelect.options.length) {
          classSelect.selectedIndex = 0;
          showRoster(classSelect.value);
        } else {
          rosterTableBody.innerHTML = '<tr><td colspan="5" class="empty">No classes assigned</td></tr>';
          rosterTitle.textContent = '‚Äî';
          rosterMeta.textContent = '-- students';
        }
      }

      function showRoster(classId) {
        rosterTableBody.innerHTML = '';
        const cls = (classes || []).find(c => (c.id || c._id || c.classId) == classId);
        if (!cls || !Array.isArray(cls.students) || !cls.students.length) {
          rosterTableBody.innerHTML = '<tr><td colspan="5" class="empty">No students found</td></tr>';
          rosterTitle.textContent = cls ? (cls.name || cls.title) : '‚Äî';
          rosterMeta.textContent = '0 students';
          return;
        }
        cls.students.forEach((s, idx) => {
          const tr = document.createElement('tr');
          tr.innerHTML = `<td>${idx+1}</td><td>${s.name}</td><td>${s.admission || s.reg || s.registration || '‚Äî'}</td><td>${s.contact || s.phone || '‚Äî'}</td>
            <td><button class="btn ghost" data-action="profile" data-id="${s.id || s._id || ''}">Profile</button></td>`;
          rosterTableBody.appendChild(tr);
        });
        rosterTitle.textContent = cls.name || cls.title || 'Class';
        rosterMeta.textContent = `${cls.students.length} students`;
      }

      function renderAssignments() {
        assignList.innerHTML = '';
        if (!assignments || !assignments.length) assignList.innerHTML = '<div class="empty">No assignments</div>';
        else assignments.forEach(a => {
          const c = document.createElement('article'); c.className = 'card';
          c.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center"><div><div style="font-weight:800">${a.title}</div><div class="muted-small">${a.className || a.classId || ''} ‚Ä¢ Due ${a.due || a.dueDate || '‚Äî'}</div></div><div style="display:flex;gap:8px"><button class="btn" data-action="viewAssign" data-id="${a.id||a._id||''}">View</button><button class="btn ghost" data-action="grade" data-id="${a.id||a._id||''}">Grade</button></div></div>`;
          assignList.appendChild(c);
        });
      }

      function renderGradebook(classId) {
        gradebookWrap.innerHTML = '';
        const cls = (classes || []).find(c => (c.id || c._id || c.classId) == classId);
        if (!cls) { gradebookWrap.innerHTML = '<div class="empty">Select a class</div>'; return; }
        const table = document.createElement('table');
        const thead = document.createElement('thead');
        thead.innerHTML = '<tr><th>#</th><th>Student</th><th>Assessment</th><th>Score</th></tr>';
        const tbody = document.createElement('tbody');
        (cls.students || []).forEach((s, idx) => {
          const tr = document.createElement('tr');
          tr.innerHTML = `<td>${idx+1}</td><td>${s.name}</td><td>Assessment A</td><td><input type="number" min="0" max="100" data-student="${s.id||s._id||''}" value=""></td>`;
          tbody.appendChild(tr);
        });
        table.appendChild(thead); table.appendChild(tbody);
        gradebookWrap.appendChild(table);
      }

      function renderExams() {
        examList.innerHTML = '';
        if (!exams || !exams.length) examList.innerHTML = '<div class="empty">No scheduled exams</div>';
        else exams.forEach(e => {
          const c = document.createElement('article'); c.className='card';
          c.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center"><div><div style="font-weight:800">${e.title}</div><div class="muted-small">${e.className || e.classId || ''} ‚Ä¢ ${e.date || e.dateScheduled || '‚Äî'}</div></div><div style="display:flex;gap:8px"><button class="btn" data-action="openExam" data-id="${e.id||e._id||''}">Open</button><button class="btn ghost" data-action="editExam" data-id="${e.id||e._id||''}">Edit</button></div></div>`;
          examList.appendChild(c);
        });
      }

      function renderResources() {
        resGrid.innerHTML = '';
        if (!resources || !resources.length) resGrid.innerHTML = '<div class="empty">No resources</div>';
        else {
          const g = document.createElement('div'); g.className = 'grid';
          resources.forEach(r => {
            const card = document.createElement('article'); card.className='card';
            card.innerHTML = `<div style="font-weight:800">${r.title || r.name}</div><div class="muted-small">${r.type || r.mime || ''} ‚Ä¢ ${r.uploadedAt || r.date || '‚Äî'}</div><div style="margin-top:8px;display:flex;gap:8px"><button class="btn" data-action="download" data-id="${r.id||r._id||''}">Download</button><button class="btn ghost" data-action="link" data-id="${r.id||r._id||''}">Link</button></div>`;
            g.appendChild(card);
          });
          resGrid.appendChild(g);
        }
      }

      function renderMessages() {
        msgList.innerHTML = '';
        if (!messages || !messages.length) msgList.innerHTML = '<div class="empty">No messages</div>';
        else messages.forEach(m => {
          const c = document.createElement('article'); c.className='card';
          c.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center"><div><div style="font-weight:800">${m.subject || m.title}</div><div class="muted-small">${m.to || m.target || ''}</div></div><div style="display:flex;gap:8px"><button class="btn" data-action="reply" data-id="${m.id||m._id||''}">Reply</button><button class="btn ghost" data-action="archive" data-id="${m.id||m._id||''}">Archive</button></div></div><div style="margin-top:8px" class="muted-small">${m.body || m.preview || ''}</div>`;
          msgList.appendChild(c);
        });
      }

      // Modal helpers
      function openItemModal(html) {
        itemModalBody.innerHTML = html;
        itemModal.classList.add('active'); itemModal.setAttribute('aria-hidden','false');
      }
      function closeItemModal() { itemModal.classList.remove('active'); itemModal.setAttribute('aria-hidden','true'); }
      closeItemModalBtn.addEventListener('click', closeItemModal);

      function openFormModal(title, bodyHtml) {
        document.getElementById('formModalTitle').textContent = title || 'Form';
        formModalBody.innerHTML = bodyHtml || '';
        formModal.classList.add('active'); formModal.setAttribute('aria-hidden','false');
      }
      function closeFormModal() { formModal.classList.remove('active'); formModal.setAttribute('aria-hidden','true'); formModalBody.innerHTML = ''; }
      closeFormModalBtn.addEventListener('click', closeFormModal);

      // Delegated click handlers
      document.body.addEventListener('click', async (e) => {
        const t = e.target;
        // roster profile
        if (t.matches('button[data-action="profile"]')) {
          const id = t.dataset.id;
          // try to fetch profile
          showLoader('Loading student profile...', '');
          try {
            let student = null;
            if (TOKEN) {
              const candidates = [
                `${API_BASE}/students/${encodeURIComponent(id)}`,
                `${API_BASE}/users/${encodeURIComponent(id)}`
              ];
              for (const url of candidates) {
                try {
                  const res = await fetch(url, { headers: headers() });
                  if (!res.ok) continue;
                  const data = await res.json();
                  student = data.student || data || null;
                  break;
                } catch(err){}
              }
            }
            hideLoader();
            if (student) openItemModal(`<div style="font-weight:800">${student.name}</div><div class="muted-small">Admission: ${student.admission || student.reg || '‚Äî'}</div><div style="margin-top:8px">Contact: ${student.contact || student.phone || '‚Äî'}</div>`);
            else openItemModal('<div class="muted-small">Student profile not available from server.</div>');
          } catch (err) { hideLoader(); console.error(err); openItemModal('<div class="muted-small">Failed to load profile.</div>'); }
        }

        // assignment actions
        if (t.matches('button[data-action="viewAssign"]')) {
          const id = t.dataset.id;
          const a = assignments.find(x => (x.id||x._id) === id);
          openItemModal(`<div style="font-weight:800">${a?.title || 'Assignment'}</div><div class="muted-small">Class: ${a?.className || a?.classId || '‚Äî'}</div><div style="margin-top:8px">Due: ${a?.due || a?.dueDate || '‚Äî'}</div>`);
        }
        if (t.matches('button[data-action="grade"]')) {
          const id = t.dataset.id;
          openFormModal('Grade submissions', `<div class="muted-small">Open grading interface for ${id} (server integration required)</div>`);
        }

        // exam actions
        if (t.matches('button[data-action="openExam"]')) {
          const id = t.dataset.id;
          const e = exams.find(x => (x.id||x._id) === id);
          openItemModal(`<div style="font-weight:800">${e?.title || 'Exam'}</div><div class="muted-small">${e?.date || '‚Äî'} ‚Ä¢ ${e?.duration || '‚Äî'} mins</div><div style="margin-top:8px"><button class="btn" id="manageExam_${id}">Manage</button></div>`);
        }

        // resource actions
        if (t.matches('button[data-action="download"]')) {
          alert('Download resource (implement server endpoint).');
        }
        if (t.matches('button[data-action="link"]')) {
          openFormModal('Link resource', `<div class="muted-small">Link resource to classes (server required)</div>`);
        }

        // messages
        if (t.matches('button[data-action="reply"]')) {
          openFormModal('Reply', `<label>Message<textarea style="width:100%;height:120px;border:1px solid #e6e9ef;border-radius:8px" id="replyBody"></textarea></label><div style="display:flex;justify-content:flex-end;margin-top:8px"><button class="btn" id="sendReplyBtn">Send</button></div>`);
          setTimeout(()=> {
            const send = document.getElementById('sendReplyBtn');
            if (send) send.addEventListener('click', ()=> { alert('Reply sent (mock)'); closeFormModal(); });
          }, 60);
        }

        // create class
        if (t.id === 'newClassBtn') {
          openFormModal('Create class', `<form id="createClassForm"><label>Class name<input type="text" id="newClassName" required></label><div style="display:flex;justify-content:flex-end;margin-top:8px"><button class="btn" type="submit">Create</button></div></form>`);
          setTimeout(()=> {
            const f = document.getElementById('createClassForm');
            if (f) f.addEventListener('submit', async (ev) => {
              ev.preventDefault();
              const name = document.getElementById('newClassName').value.trim();
              if (!name) return alert('Enter class name');
              // POST to server if token available
              if (TOKEN) {
                try {
                  const res = await fetch(`${API_BASE}/classes`, { method:'POST', headers: headers(), body: JSON.stringify({ name, teacher: teacherProfile?.id || teacherProfile?._id }) });
                  if (res.ok) {
                    const created = await res.json();
                    classes.unshift(created);
                    renderClassOptions();
                    closeFormModal();
                    return;
                  }
                } catch (err) { console.warn(err); }
              }
              // fallback: add locally
              const id = 'C' + Math.floor(Math.random()*10000);
              classes.unshift({ id, name, students: [] });
              renderClassOptions();
              closeFormModal();
            });
          }, 60);
        }

        // grading export
        if (t.id === 'exportGradesBtn') {
          const rows = [['Student','Assessment','Score']];
          document.querySelectorAll('#gradebookWrap input[type="number"]').forEach(inp => {
            const tr = inp.closest('tr');
            const name = tr.children[1].textContent;
            const assessment = tr.children[2].textContent;
            rows.push([name, assessment, inp.value || '']);
          });
          const csv = rows.map(r => r.map(c => `"${String(c).replace(/"/g,'""')}"`).join(',')).join('\n');
          const blob = new Blob([csv], { type: 'text/csv' });
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a'); a.href = url; a.download = 'gradebook.csv'; a.click(); URL.revokeObjectURL(url);
        }
      });

      // Select change handlers
      classSelect.addEventListener('change', (e) => showRoster(e.target.value));
      document.getElementById('loadAttendanceBtn').addEventListener('click', () => {
        const cid = document.getElementById('attClassSelect').value;
        const date = document.getElementById('attDate').value || new Date().toISOString().slice(0,10);
        loadAttendance(cid, date);
      });

      document.getElementById('saveGradesBtn').addEventListener('click', async () => {
        // collect inputs and submit to server when possible
        const rows = [];
        document.querySelectorAll('#gradebookWrap input[type="number"]').forEach(inp => {
          const tr = inp.closest('tr');
          const studentId = inp.dataset.student;
          rows.push({ studentId, score: inp.value });
        });
        if (!rows.length) return alert('No grades to save');
        if (TOKEN) {
          try {
            const res = await fetch(`${API_BASE}/grades`, { method:'POST', headers: headers(), body: JSON.stringify({ grades: rows }) });
            if (res.ok) { alert('Grades saved'); return; }
          } catch (err) { console.warn(err); }
        }
        alert('Grades saved locally (server unavailable).');
      });

      // Attendance helper
      function loadAttendance(classId, date) {
        attendanceWrap.innerHTML = '';
        const cls = (classes || []).find(c => (c.id || c._id || c.classId) == classId);
        if (!cls) { attendanceWrap.innerHTML = '<div class="empty">Select a class</div>'; return; }
        const tbl = document.createElement('table');
        tbl.innerHTML = '<thead><tr><th>#</th><th>Student</th><th>Present</th><th>Notes</th></tr></thead>';
        const tb = document.createElement('tbody');
        (cls.students || []).forEach((s, i) => {
          const tr = document.createElement('tr');
          tr.innerHTML = `<td>${i+1}</td><td>${s.name}</td><td><input type="checkbox" data-id="${s.id||s._id||''}" checked></td><td><input type="text" data-id="${s.id||s._id||''}" placeholder="notes"></td>`;
          tb.appendChild(tr);
        });
        tbl.appendChild(tb);
        const submit = document.createElement('div'); submit.style.marginTop='8px';
        submit.innerHTML = `<button class="btn" id="saveAttBtn">Save attendance</button> <button class="btn ghost" id="clearAttBtn">Clear</button>`;
        attendanceWrap.appendChild(tbl); attendanceWrap.appendChild(submit);

        // handlers
        setTimeout(()=> {
          const saveBtn = document.getElementById('saveAttBtn');
          if (saveBtn) saveBtn.addEventListener('click', async () => {
            const payload = [];
            attendanceWrap.querySelectorAll('tbody tr').forEach(tr => {
              const studentId = tr.querySelector('input[type="checkbox"]').dataset.id;
              const present = tr.querySelector('input[type="checkbox"]').checked;
              const notes = tr.querySelector('input[type="text"]').value;
              payload.push({ studentId, present, notes, date });
            });
            if (TOKEN) {
              try {
                const res = await fetch(`${API_BASE}/attendance`, { method:'POST', headers: headers(), body: JSON.stringify({ classId, date, records: payload }) });
                if (res.ok) { alert('Attendance saved'); return; }
              } catch (err) { console.warn(err); }
            }
            alert('Attendance saved locally (server unavailable).');
          });
          const clearBtn = document.getElementById('clearAttBtn');
          if (clearBtn) clearBtn.addEventListener('click', () => { attendanceWrap.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = false); });
        }, 60);
      }

      // Initialization: fetch profile and teacher data
      async function init() {
        showLoader('Loading dashboard...', 'Fetching profile & data');
        try {
          // profile
          teacherProfile = await fetchProfile();
          teacherNameEl.textContent = (teacherProfile?.firstName || teacherProfile?.name || teacherProfile?.username || 'Teacher') + (teacherProfile?.lastName ? (' ' + teacherProfile.lastName) : '');
          teacherDeptEl.textContent = teacherProfile?.department || teacherProfile?.dept || teacherProfile?.program || '';
          if (teacherProfile?.profilePic) teacherAvatar.src = teacherProfile.profilePic;
          if (teacherProfile?.session) termInfo.textContent = teacherProfile.session;

          const teacherId = teacherProfile?.id || teacherProfile?._id || teacherProfile?.teacherId || '';

          // fetch all teacher data in parallel (best-effort)
          const [classesData, assignmentsData, examsData, resourcesData, messagesData] = await Promise.all([
            fetchClasses(teacherId).catch(()=>null),
            fetchAssignments(teacherId).catch(()=>null),
            fetchExams(teacherId).catch(()=>null),
            fetchResources(teacherId).catch(()=>null),
            fetchMessages(teacherId).catch(()=>null)
          ]);

          classes = Array.isArray(classesData) ? classesData : [];
          // normalize student lists if server uses different key
          classes = classes.map(c => ({ id: c.id || c._id || c.classId, name: c.name || c.title || c.class, students: c.students || c.roster || [] }));

          assignments = Array.isArray(assignmentsData) ? assignmentsData : [];
          exams = Array.isArray(examsData) ? examsData : [];
          resources = Array.isArray(resourcesData) ? resourcesData : [];
          messages = Array.isArray(messagesData) ? messagesData : [];

          renderOverview();
          renderClassOptions();
          renderAssignments();
          renderExams();
          renderResources();
          renderMessages();

          // render gradebook for first class
          if (classes.length) renderGradebook(classes[0].id);
        } catch (err) {
          console.error('init error', err);
        } finally {
          hideLoader();
        }
      }

      // sidebar tab system (re-use existing behavior)
      const sidebarTabs = Array.from(document.querySelectorAll('.sidebar-tab'));
      const tabSections = Array.from(document.querySelectorAll('.tab-section'));
      function setActiveTab(name, push=true) {
        sidebarTabs.forEach(t => { const is = t.dataset.tab === name; t.classList.toggle('active', is); t.setAttribute('aria-current', is ? 'true' : 'false'); });
        tabSections.forEach(s => s.style.display = s.id === name ? '' : 'none');
        if (push) history.replaceState(null, '', '#' + name);
        if (window.innerWidth <= 720) {
          sidebar.classList.remove('open'); sidebar.classList.add('hidden'); overlay.classList.remove('visible'); document.body.classList.remove('no-scroll');
        }
      }
      sidebarTabs.forEach(t => t.addEventListener('click', (e)=> { e.preventDefault(); setActiveTab(t.dataset.tab); }));
      const initial = (location.hash || '').replace('#','') || 'overview';
      setActiveTab(initial, false);
      window.addEventListener('hashchange', ()=> setActiveTab((location.hash || '').replace('#','') || 'overview', false));

      // responsive sidebar
      function handleResize() {
        if (window.innerWidth > 720) { sidebar.classList.remove('hidden'); sidebar.classList.remove('open'); overlay.classList.remove('visible'); document.body.classList.remove('no-scroll'); }
        else sidebar.classList.add('hidden');
      }
      window.addEventListener('resize', handleResize);
      handleResize();

      // start
      init();

    })();
  </script>
</body>
</html>
