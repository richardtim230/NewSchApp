<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Question Bank & Exam Scheduler | ExamGuard â€” Staff</title>
  <meta name="viewport" content="width=device-width,initial-scale=0.751" />
  <link href="https://fonts.googleapis.com/css?family=Inter:400,600,700&display=swap" rel="stylesheet">
  <link rel="icon" href="../logo.png">

  <!-- Quill editor CSS -->
  <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">

  <style>
    /* Shared look & feel consistent with other pages */
    :root{
      --bg-0:#f6f8ff; --bg-1:#eef2ff;
      --accent:#3b82f6; --accent-2:#6366f1; --muted:#6b7280;
      --card-bg:#ffffff; --sidebar-w:300px; --danger:#ef4444;
      --radius:12px;
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;font-family:Inter,system-ui,Arial;background:linear-gradient(180deg,var(--bg-0),var(--bg-1));-webkit-font-smoothing:antialiased;color:#0b2a44}
    a{color:inherit;text-decoration:none}
    .app{display:flex;min-height:100vh;align-items:stretch}
    .overlay{position:fixed;inset:0;background:rgba(2,6,23,0.45);z-index:50;display:none}
    .overlay.visible{display:block}

    /* Sidebar (desktop instant show) */
    .sidebar{
      width:var(--sidebar-w);min-width:var(--sidebar-w);
      background:linear-gradient(180deg,#0f172a 0%, #1e3a8a 100%);color:#fff;padding:20px 16px;position:fixed;left:0;top:0;bottom:0;z-index:100;
      box-shadow:4px 0 28px rgba(15,23,42,0.12);display:flex;flex-direction:column;gap:14px;overflow-y:auto;transition:none;
    }
    @media (max-width:720px){
      .sidebar{transform:translateX(-110%);transition:transform .28s ease;position:fixed;width:86vw;min-width:86vw}
      .sidebar.hidden{transform:translateX(-110%)}
      .sidebar.open{transform:translateX(0);box-shadow:0 24px 48px rgba(2,6,23,0.5)}
    }

    .brand{display:flex;gap:12px;align-items:center}
    .brand img{width:44px;height:44px;border-radius:10px;object-fit:cover;border:3px solid rgba(255,224,102,0.12);background:#fff}
    .brand .title{font-weight:800;font-size:1.05rem;color:#ffe066}
    .nav{display:flex;flex-direction:column;gap:8px;margin-top:6px}
    .nav a{display:flex;align-items:center;gap:10px;padding:12px;border-radius:10px;font-weight:700;font-size:1rem;color:#e6eefc}
    .nav a.active,.nav a:hover{background:rgba(255,255,255,0.04);color:#ffe066}

    .spacer{flex:1}
    .profile{display:flex;gap:12px;align-items:center;padding-top:10px;border-top:1px solid rgba(255,255,255,0.04)}
    .profile img{width:48px;height:48px;border-radius:10px;object-fit:cover;border:2px solid #ffe066}

    .topbar{position:fixed;left:var(--sidebar-w);top:0;width:calc(100vw - var(--sidebar-w));z-index:90;display:flex;align-items:center;justify-content:space-between;gap:12px;padding:12px 14px;backdrop-filter:blur(6px);background:rgba(255,255,255,0.86);border-bottom:1px solid rgba(11,42,60,0.06);box-shadow:0 6px 18px rgba(11,42,60,0.04);min-height:64px}
    @media (max-width:720px){.topbar{left:0;width:100vw;padding:10px 12px;min-height:56px}}

    .hamburger{display:none;background:var(--accent);color:#fff;border:none;padding:9px 12px;border-radius:10px;cursor:pointer;font-weight:800}
    @media (max-width:980px){.hamburger{display:inline-flex}}

    .page-title{font-weight:800;font-size:1.05rem;color:var(--accent-2)}
    .small{font-size:0.92rem;color:var(--muted)}

    .main{margin-left:var(--sidebar-w);padding:20px;flex:1;transition:margin-left .28s;min-height:100vh;padding-top:90px;overflow-y:auto}
    @media (max-width:720px){.main{margin-left:0;padding:14px;padding-top:80px}}

    /* two-column content layout with left action column + main area */
    .layout{display:grid;grid-template-columns: 260px 1fr;gap:14px;align-items:start}
    @media (max-width:980px){.layout{grid-template-columns:1fr}}
    .card{background:var(--card-bg);border-radius:12px;padding:14px;border:1px solid #eef3ff;box-shadow:0 8px 20px rgba(11,42,60,0.04)}
    .muted-small{font-size:0.9rem;color:var(--muted)}
    .controls{display:flex;gap:8px;flex-wrap:wrap}
    .btn{padding:9px 12px;border-radius:10px;border:none;cursor:pointer;background:linear-gradient(90deg,var(--accent),var(--accent-2));color:#fff;font-weight:800}
    .btn.ghost{background:transparent;color:var(--accent-2);border:1px solid rgba(59,130,246,0.08)}
    .btn.warn{background:linear-gradient(90deg,#f59e0b,#f97316);}

    /* bank/table */
    .search-row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .search-row input[type="search"], select, input[type="text"], input[type="number"]{padding:8px;border-radius:8px;border:1px solid #e6e9ef}
    table{width:100%;border-collapse:collapse}
    table th{background:#f8fbff;padding:10px;text-align:left;font-weight:800;border-bottom:1px solid #eef3ff}
    table td{padding:10px;border-bottom:1px solid #f1f5fb;vertical-align:top}
    .tag{display:inline-block;padding:6px 8px;border-radius:999px;background:#f3f6fb;color:var(--muted);font-weight:700;font-size:0.85rem}

    /* selection row */
    .selection-bar{display:flex;gap:10px;align-items:center;padding:10px;border-radius:10px;background:linear-gradient(90deg,rgba(99,102,241,0.06),rgba(59,130,246,0.03));margin-bottom:10px}

    /* modals */
    .modal{position:fixed;inset:0;background:rgba(2,6,23,0.45);display:none;align-items:center;justify-content:center;z-index:9999;padding:12px}
    .modal.active{display:flex}
    .modal .panel{background:#fff;border-radius:12px;max-width:960px;width:100%;overflow:hidden;box-shadow:0 20px 60px rgba(2,6,23,0.25)}
    .modal .head{padding:12px 16px;border-bottom:1px solid #eef3ff;background:#f8fbff;display:flex;justify-content:space-between;align-items:center}
    .modal .body{padding:14px;max-height:72vh;overflow:auto}

    .inline-grid{display:grid;grid-template-columns:1fr 320px;gap:12px}
    @media (max-width:920px){.inline-grid{grid-template-columns:1fr}}

    .empty{padding:28px;text-align:center;color:var(--muted);border:1px dashed #eef3ff;border-radius:12px}

    /* small helpers */
    .right{text-align:right}
    :focus{outline:3px solid rgba(99,102,241,0.18);outline-offset:2px;border-radius:6px}

    /* quill container styling */
    .ql-container { min-height: 140px; border-radius: 8px; }
  </style>
</head>
<body>
  <div class="app" id="app">
    <div class="overlay" id="overlay" aria-hidden="true"></div>

    <aside class="sidebar" id="sidebar" aria-label="Main navigation" role="navigation">
      <div class="brand">
        <img src="../logo.png" alt="Logo">
        <div>
          <div class="title">ExamGuard Admin</div>
          <div class="small">Question Bank</div>
        </div>
      </div>

      <!-- Sidebar now hosts tab-links for internal sections only -->
      <nav class="nav" aria-label="Primary">
        <a href="#" class="active sidebar-tab" data-tab="bank">ðŸ§¾ Question Bank</a>

        <div style="margin-top:8px;border-top:1px dashed rgba(255,255,255,0.04);padding-top:8px">
          <div style="font-weight:700;color:#e6eefc;margin-bottom:6px">Manage Exams</div>
          <a href="#" class="sidebar-tab" data-tab="sets">ðŸ“¦ Uploaded Sets</a>
          <a href="#" class="sidebar-tab" data-tab="scheduled">ðŸ“… Scheduled Exams</a>
          <a href="#" class="sidebar-tab" data-tab="taken">ðŸ“‘ Taken Exams</a>
        </div>
      </nav>

      <div class="spacer" aria-hidden="true"></div>

      <div class="profile">
        <img src="../avatar.jpg" alt="Staff avatar">
        <div>
          <div style="font-weight:800" id="staffName">Mrs. Okonkwo</div>
          <div class="muted-small">Assessment Officer</div>
        </div>
      </div>
    </aside>

    <div class="topbar">
      <div style="display:flex;gap:12px;align-items:center;">
        <button class="hamburger" id="hamburger" aria-label="Open menu">â˜°</button>
        <div>
          <div class="page-title">Question Bank & Scheduler</div>
          <div class="small muted">Manage questions, create sets and schedule tests</div>
        </div>
      </div>

      <div style="display:flex;gap:12px;align-items:center;">
        <div class="muted-small">Env: Demo</div>
        <img src="../avatar.jpg" alt="you" style="width:44px;height:44px;border-radius:8px;border:2px solid #fff">
      </div>
    </div>

    <main class="main" id="main" role="main" tabindex="-1">
      <!-- All tab-sections live in main; switching done by sidebar tabs -->
      <!-- Section: Question Bank -->
      <section id="bank" class="tab-section">
        <div class="layout">
          <!-- Left: actions / filters -->
          <aside class="card" aria-labelledby="actionsTitle">
            <div id="actionsTitle" style="font-weight:800">Actions</div>
            <div class="muted-small" style="margin-top:6px">Create, upload or build sets</div>

            <div style="margin-top:12px" class="controls">
              <button class="btn" id="newQuestionBtn">New question</button>
              <button class="btn" id="newSetBtn">Create set</button>
              <button class="btn ghost" id="bulkUploadBtn">Upload CSV</button>
              <button class="btn ghost" id="importBtn">Import JSON</button>
            </div>

            <hr style="border:none;border-top:1px solid #eef3ff;margin:12px 0">

            <div style="font-weight:800;margin-bottom:6px">Filters</div>
            <div class="search-row" style="margin-bottom:8px">
              <select id="filterClass">
                <option value="">All classes</option>
                <option>SS1</option><option>SS2</option><option>SS3</option>
              </select>
              <select id="filterSubject">
                <option value="">All subjects</option>
                <option>Biology</option><option>Mathematics</option><option>English</option><option>Chemistry</option>
              </select>
            </div>

            <div class="search-row" style="margin-bottom:8px">
              <select id="filterDifficulty">
                <option value="">Any difficulty</option>
                <option value="easy">Easy</option><option value="medium">Medium</option><option value="hard">Hard</option>
              </select>
              <input type="search" id="filterText" placeholder="Search text / id">
            </div>
            <div style="margin-top:8px;display:flex;gap:8px;">
              <button class="btn" id="applyFiltersBtn">Apply</button>
              <button class="btn ghost" id="clearFiltersBtn">Clear</button>
            </div>

            <hr style="border:none;border-top:1px solid #eef3ff;margin:12px 0">

            <div style="font-weight:800;margin-bottom:6px">Selected</div>
            <div style="margin-bottom:6px" id="selectedCount">0 questions selected</div>
            <div style="display:flex;gap:8px;margin-bottom:8px">
              <button class="btn" id="addToSetBtn">Add to set</button>
              <button class="btn ghost" id="scheduleBtn">Schedule exam</button>
            </div>

            <div style="font-weight:800;margin-top:12px">Exports</div>
            <div style="display:flex;gap:8px;margin-top:8px">
              <button class="btn ghost" id="exportJsonBtn">Export JSON</button>
              <button class="btn ghost" id="exportCsvBtn">Export CSV</button>
            </div>
          </aside>

          <!-- Right: main content -->
          <section class="card" aria-labelledby="bankTitle">
            <div style="display:flex;justify-content:space-between;align-items:center">
              <div>
                <div id="bankTitle" style="font-weight:800">Question Bank</div>
                <div class="muted-small">Manage and select individual questions or build sets</div>
              </div>

              <div style="display:flex;gap:8px;align-items:center">
                <input type="search" id="globalSearch" placeholder="Search questions by text, tags or id" style="padding:8px;border-radius:8px;border:1px solid #e6e9ef">
                <button class="btn ghost" id="refreshBankBtn">Refresh</button>
              </div>
            </div>

            <div style="margin-top:12px">
              <div class="selection-bar" id="selectionBar" style="display:none">
                <div id="selectionInfo">0 selected</div>
                <div style="margin-left:auto;display:flex;gap:8px">
                  <button class="btn ghost" id="selectAllBtn">Select all</button>
                  <button class="btn" id="clearSelectionBtn">Clear</button>
                </div>
              </div>

              <div style="margin-top:8px;overflow:auto">
                <table role="table" aria-label="Question list">
                  <thead>
                    <tr>
                      <th style="width:46px"><input type="checkbox" id="masterCheck" title="Select visible"></th>
                      <th>ID</th>
                      <th>Question</th>
                      <th>Meta</th>
                      <th class="right">Actions</th>
                    </tr>
                  </thead>
                  <tbody id="questionTbody" role="rowgroup"></tbody>
                </table>
              </div>

              <div style="margin-top:12px;display:flex;justify-content:space-between;align-items:center">
                <div id="pagerInfo" class="muted-small"></div>
                <div style="display:flex;gap:8px">
                  <button class="btn ghost" id="prevPageBtn">Prev</button>
                  <button class="btn ghost" id="nextPageBtn">Next</button>
                </div>
              </div>
            </div>
          </section>
        </div>
      </section>

      <!-- Section: Uploaded Sets -->
      <section id="sets" class="tab-section" style="display:none">
        <div class="card">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div>
              <div style="font-weight:800">Uploaded Sets</div>
              <div class="muted-small">Manage named question sets</div>
            </div>
            <div style="display:flex;gap:8px">
              <button class="btn" id="createSetBtn">Create set from selection</button>
              <button class="btn ghost" id="importSetBtn">Import set</button>
            </div>
          </div>

          <div style="margin-top:12px" id="setsWrap"></div>
        </div>
      </section>

      <!-- Section: Scheduled Exams -->
      <section id="scheduled" class="tab-section" style="display:none">
        <div class="card">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div>
              <div style="font-weight:800">Scheduled Exams</div>
              <div class="muted-small">Upcoming and past schedules</div>
            </div>
            <div style="display:flex;gap:8px">
              <button class="btn" id="newScheduleBtn">New schedule</button>
              <button class="btn ghost" id="exportSchedulesBtn">Export</button>
            </div>
          </div>

          <div style="margin-top:12px" id="schedulesWrap"></div>
        </div>
      </section>

      <!-- Section: Taken Exams -->
      <section id="taken" class="tab-section" style="display:none">
        <div class="card">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div>
              <div style="font-weight:800">Taken Exams</div>
              <div class="muted-small">Completed sessions and results</div>
            </div>
            <div style="display:flex;gap:8px">
              <button class="btn" id="viewReportsBtn">View reports</button>
            </div>
          </div>

          <div style="margin-top:12px" id="takenWrap"></div>
        </div>
      </section>
    </main>

    <!-- Modals: Question preview/editor uses Quill -->
    <div class="modal" id="questionModal" role="dialog" aria-modal="true" aria-hidden="true">
      <div class="panel" role="document">
        <div class="head">
          <div id="questionModalTitle" style="font-weight:800">Question</div>
          <div><button class="btn ghost" id="closeQuestionModal">Close</button></div>
        </div>
        <div class="body" id="questionModalBody">
          <!-- content injected dynamically; editor uses Quill -->
        </div>
      </div>
    </div>

    <div class="modal" id="setModal" role="dialog" aria-modal="true" aria-hidden="true">
      <div class="panel" role="document">
        <div class="head">
          <div id="setModalTitle" style="font-weight:800">Create Question Set</div>
          <div><button class="btn ghost" id="closeSetModal">Close</button></div>
        </div>
        <div class="body" id="setModalBody">
          <form id="setForm" style="display:grid;gap:8px">
            <label>Set name<input id="setName" required></label>
            <label>Class<select id="setClass"><option>SS1</option><option>SS2</option><option>SS3</option></select></label>
            <label>Subject<select id="setSubject"><option>Biology</option><option>Mathematics</option><option>English</option></select></label>
            <label>Difficulty<select id="setDifficulty"><option value="">Mixed</option><option value="easy">Easy</option><option value="medium">Medium</option><option value="hard">Hard</option></select></label>
            <div style="display:flex;gap:8px;justify-content:flex-end">
              <button type="button" class="btn ghost" id="cancelSetBtn">Cancel</button>
              <button type="submit" class="btn" id="saveSetBtn">Save set (selected)</button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <div class="modal" id="scheduleModal" role="dialog" aria-modal="true" aria-hidden="true">
      <div class="panel" role="document">
        <div class="head">
          <div id="scheduleModalTitle" style="font-weight:800">Schedule Exam</div>
          <div><button class="btn ghost" id="closeScheduleModal">Close</button></div>
        </div>
        <div class="body" id="scheduleModalBody">
          <form id="scheduleForm" style="display:grid;gap:8px">
            <label>Title<input id="schTitle" required></label>
            <label>Class<select id="schClass"><option>SS1</option><option>SS2</option><option>SS3</option></select></label>
            <label>Subject<select id="schSubject"><option>Biology</option><option>Mathematics</option></select></label>
            <div style="display:flex;gap:8px">
              <label style="flex:1">Date<input type="date" id="schDate" required></label>
              <label style="width:140px">Start time<input type="time" id="schTime" required></label>
            </div>
            <label>Duration (mins)<input type="number" id="schDuration" min="1" value="60"></label>
            <label>Question source<select id="schSource"><option value="selected">Use selected questions</option><option value="set">Use a named set</option></select></label>
            <div id="schExtra"></div>

            <div style="display:flex;gap:8px;justify-content:flex-end">
              <button type="button" class="btn ghost" id="cancelScheduleBtn">Cancel</button>
              <button type="submit" class="btn" id="confirmScheduleBtn">Schedule</button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- Hidden file inputs -->
    <input type="file" id="csvFile" accept=".csv" style="display:none">
    <input type="file" id="jsonFile" accept="application/json" style="display:none">

  </div>

  <!-- Quill JS -->
  <script src="https://cdn.quilljs.com/1.3.6/quill.min.js"></script>

  <script>
    (function () {
      // Elements & state same as previous implementation with tabs and quill integration
      const sidebarTabs = Array.from(document.querySelectorAll('.sidebar-tab'));
      const tabSections = Array.from(document.querySelectorAll('.tab-section'));

      function setActiveTab(name, push = true) {
        sidebarTabs.forEach(t => {
          const is = t.dataset.tab === name;
          t.classList.toggle('active', is);
          t.setAttribute('aria-current', is ? 'true' : 'false');
        });
        tabSections.forEach(s => {
          s.style.display = s.id === name ? '' : 'none';
        });
        if (push) history.replaceState(null, '', '#' + name);
        if (window.innerWidth <= 720) {
          const sidebar = document.getElementById('sidebar');
          const overlay = document.getElementById('overlay');
          sidebar.classList.remove('open'); sidebar.classList.add('hidden');
          overlay.classList.remove('visible'); document.body.classList.remove('no-scroll');
        }
      }
      sidebarTabs.forEach(t => t.addEventListener('click', (e)=> { e.preventDefault(); setActiveTab(t.dataset.tab); }));

      const initial = (location.hash || '').replace('#','') || 'bank';
      setActiveTab(initial, false);
      window.addEventListener('hashchange', ()=> {
        const h = (location.hash || '').replace('#','') || 'bank';
        setActiveTab(h, false);
      });

      // Bank variables & storage
      const BANK_KEY = 'eg_question_bank_v1';
      const SETS_KEY = 'eg_question_sets_v1';
      const SCHEDULES_KEY = 'eg_exam_schedules_v1';
      let bank = []; let sets = []; let schedules = []; let taken = [];
      let selected = new Set();
      let visibleIds = [];
      let page = 1;
      const PAGE_SIZE = 12;

      // DOM refs
      const questionTbody = document.getElementById('questionTbody');
      const globalSearch = document.getElementById('globalSearch');
      const masterCheck = document.getElementById('masterCheck');
      const selectionBar = document.getElementById('selectionBar');
      const selectionInfo = document.getElementById('selectionInfo');
      const selectedCountEl = document.getElementById('selectedCount');

      const filterClass = document.getElementById('filterClass');
      const filterSubject = document.getElementById('filterSubject');
      const filterDifficulty = document.getElementById('filterDifficulty');
      const filterText = document.getElementById('filterText');

      const csvFile = document.getElementById('csvFile');
      const jsonFile = document.getElementById('jsonFile');

      // Modals + Quill instance holder
      const questionModal = document.getElementById('questionModal');
      const questionModalBody = document.getElementById('questionModalBody');
      const questionModalTitle = document.getElementById('questionModalTitle');
      let quill = null; // current quill instance when editor active

      // utility
      function uid(prefix='') { return prefix + Math.random().toString(36).slice(2,9).toUpperCase(); }
      function saveBank(){ localStorage.setItem(BANK_KEY, JSON.stringify(bank)); }
      function loadBank(){ const s = localStorage.getItem(BANK_KEY); bank = s ? JSON.parse(s) : []; }
      function saveSets(){ localStorage.setItem(SETS_KEY, JSON.stringify(sets)); }
      function loadSets(){ const s = localStorage.getItem(SETS_KEY); sets = s ? JSON.parse(s) : []; }
      function saveSchedules(){ localStorage.setItem(SCHEDULES_KEY, JSON.stringify(schedules)); }
      function loadSchedules(){ const s = localStorage.getItem(SCHEDULES_KEY); schedules = s ? JSON.parse(s) : []; }

      function ensureSeed(){
        if (!bank.length) {
          bank = [
            { id:'Q-'+uid(4), class:'SS2', subject:'Biology', difficulty:'medium', text:'<p>What is the powerhouse of the cell?</p>', choices:['Nucleus','Mitochondria','Ribosome','Golgi'], answer:1, tags:['cells'] },
            { id:'Q-'+uid(4), class:'SS2', subject:'Biology', difficulty:'easy', text:'<p>Which organ pumps blood?</p>', choices:['Liver','Heart','Kidney','Lung'], answer:1, tags:['circulation'] },
            { id:'Q-'+uid(4), class:'SS2', subject:'Mathematics', difficulty:'medium', text:'<p>Solve 2x + 3 = 7. x = ?</p>', choices:['1','2','3','4'], answer:1, tags:['algebra'] },
            { id:'Q-'+uid(4), class:'SS1', subject:'English', difficulty:'easy', text:'<p>Choose the correct plural of "child".</p>', choices:['childs','children','childes','childer'], answer:1, tags:['grammar'] }
          ];
          saveBank();
        }
        if (!sets.length) {
          sets = [
            { id: 'S-'+uid(4), name:'Biology Termly Short', class:'SS2', subject:'Biology', difficulty:'medium', questionIds: bank.filter(q=>q.subject==='Biology').map(q=>q.id) }
          ];
          saveSets();
        }
      }

      // Rendering functions
      function renderList() {
        const cls = filterClass.value || '';
        const subj = filterSubject.value || '';
        const diff = filterDifficulty.value || '';
        const txt = (filterText.value || '').trim().toLowerCase();
        let results = bank.filter(q => {
          if (cls && q.class !== cls) return false;
          if (subj && q.subject !== subj) return false;
          if (diff && q.difficulty !== diff) return false;
          if (txt) {
            const hay = (q.id + ' ' + q.text.replace(/<[^>]*>/g,'') + ' ' + (q.tags||[]).join(' ') ).toLowerCase();
            return hay.includes(txt);
          }
          return true;
        });

        const gq = (globalSearch.value || '').trim().toLowerCase();
        if (gq) results = results.filter(q => (q.id + ' ' + q.text.replace(/<[^>]*>/g,'') + ' ' + (q.tags||[]).join(' ') + ' ' + q.subject + ' ' + (q.class||'')).toLowerCase().includes(gq));

        const total = results.length;
        const pages = Math.max(1, Math.ceil(total / PAGE_SIZE));
        if (page > pages) page = pages;
        const start = (page - 1) * PAGE_SIZE;
        const slice = results.slice(start, start + PAGE_SIZE);
        visibleIds = slice.map(q=>q.id);

        questionTbody.innerHTML = '';
        if (!slice.length) {
          questionTbody.innerHTML = `<tr><td colspan="5"><div class="empty">No questions found.</div></td></tr>`;
        } else {
          slice.forEach(q => {
            const tr = document.createElement('tr');
            const checked = selected.has(q.id) ? 'checked' : '';
            tr.innerHTML = `
              <td><input type="checkbox" class="row-check" data-id="${q.id}" ${checked}></td>
              <td><div style="font-weight:800">${q.id}</div><div class="muted-small">${q.class} â€¢ ${q.subject}</div></td>
              <td><div>${q.text.replace(/<[^>]+>/g,'')}</div></td>
              <td>
                <div class="muted-small">Difficulty: ${q.difficulty || 'â€”'}</div>
                <div style="margin-top:6px">${(q.tags||[]).map(t=>`<span class="tag">${t}</span>`).join(' ')}</div>
              </td>
              <td class="right">
                <button class="btn ghost viewBtn" data-id="${q.id}">View</button>
                <button class="btn" data-id="${q.id}" data-action="select">${selected.has(q.id)?'Deselect':'Select'}</button>
              </td>
            `;
            questionTbody.appendChild(tr);
          });
        }

        updateSelectionBar();
        document.getElementById('pagerInfo').textContent = `Showing ${Math.min(total, start+1)} - ${Math.min(total, start+slice.length)} of ${total} results (page ${page}/${pages})`;
      }

      function updateSelectionBar() {
        const count = selected.size;
        selectedCountEl.textContent = `${count} questions selected`;
        selectionInfo.textContent = `${count} selected`;
        selectionBar.style.display = count ? '' : 'none';
      }

      // Delegated click handling
      document.body.addEventListener('click', (e) => {
        const t = e.target;

        if (t.matches('.row-check')) {
          const id = t.dataset.id;
          if (t.checked) selected.add(id); else selected.delete(id);
          updateSelectionBar(); renderList();
        }
        if (t.id === 'masterCheck') {
          if (t.checked) visibleIds.forEach(id => selected.add(id)); else visibleIds.forEach(id => selected.delete(id));
          updateSelectionBar(); renderList();
        }
        if (t.matches('button[data-action="select"]')) {
          const id = t.dataset.id;
          if (selected.has(id)) selected.delete(id); else selected.add(id);
          updateSelectionBar(); renderList();
        }

        if (t.matches('.viewBtn')) openQuestionModal(t.dataset.id);

        if (t.id === 'newQuestionBtn') openQuestionEditor();
        if (t.id === 'newSetBtn') openSetModal();
        if (t.id === 'bulkUploadBtn') csvFile.click();
        if (t.id === 'importBtn') jsonFile.click();

        if (t.id === 'selectAllBtn') { visibleIds.forEach(id => selected.add(id)); updateSelectionBar(); renderList(); }
        if (t.id === 'clearSelectionBtn') { selected.clear(); updateSelectionBar(); renderList(); }

        if (t.id === 'addToSetBtn') openSetModal(true);
        if (t.id === 'scheduleBtn') openScheduleModal();

        if (t.id === 'exportJsonBtn') exportSelected('json');
        if (t.id === 'exportCsvBtn') exportSelected('csv');

        if (t.id === 'refreshBankBtn') { loadAll(); renderList(); alert('Bank refreshed (local demo).'); }

        if (t.id === 'prevPageBtn') { if (page>1) { page--; renderList(); } }
        if (t.id === 'nextPageBtn') { page++; renderList(); }

        // sets/schedule interactions later (delegated)
      });

      // File inputs
      csvFile.addEventListener('change', (e)=> {
        const f = e.target.files && e.target.files[0]; if (!f) return;
        const reader = new FileReader();
        reader.onload = ()=> { parseCsvToQuestions(reader.result); csvFile.value=''; };
        reader.readAsText(f);
      });
      jsonFile.addEventListener('change', (e)=> {
        const f = e.target.files && e.target.files[0]; if (!f) return;
        const reader = new FileReader();
        reader.onload = ()=> {
          try {
            const j = JSON.parse(reader.result);
            if (!Array.isArray(j)) return alert('JSON must be an array of questions');
            j.forEach(q => {
              q.id = q.id || 'Q-'+uid(4);
              q.choices = q.choices || ['','','',''];
              q.text = q.text || '';
              bank.unshift(q);
            });
            saveBank(); renderList(); alert('Imported ' + j.length + ' questions.');
          } catch (err) { alert('Invalid JSON'); }
          jsonFile.value='';
        };
        reader.readAsText(f);
      });

      // CSV parsing (best-effort)
      function parseCsvToQuestions(csv) {
        const rows = csv.split(/\r?\n/).map(r=>r.trim()).filter(Boolean);
        if (!rows.length) return alert('No rows found');
        const headers = rows[0].split(',').map(h=>h.trim().toLowerCase());
        const mapIdx = headers.reduce((m,h,i)=> (m[h]=i,m), {});
        let created = 0;
        for (let i=1;i<rows.length;i++){
          const cols = rows[i].split(',');
          const q = {
            id: 'Q-'+uid(4),
            class: cols[mapIdx['class']] || 'SS2',
            subject: cols[mapIdx['subject']] || 'General',
            difficulty: cols[mapIdx['difficulty']] || 'medium',
            text: cols[mapIdx['text']] ? `<p>${cols[mapIdx['text']]}</p>` : '<p>Imported question</p>',
            choices: [
              cols[mapIdx['choicea']] || '',
              cols[mapIdx['choiceb']] || '',
              cols[mapIdx['choicec']] || '',
              cols[mapIdx['choiced']] || ''
            ],
            answer: parseInt(cols[mapIdx['answer']]) || 0,
            tags: (cols[mapIdx['tags']] || '').split('|').map(s=>s.trim()).filter(Boolean)
          };
          bank.unshift(q); created++;
        }
        saveBank(); renderList();
        alert('Imported ' + created + ' questions from CSV');
      }

      // Question preview/editor with Quill
      function openQuestionModal(id) {
        const q = bank.find(x=>x.id === id);
        if (!q) return;
        questionModalTitle.textContent = `${q.id} â€” Preview`;
        questionModalBody.innerHTML = `
          <div style="display:flex;justify-content:space-between;gap:8px;align-items:center">
            <div><strong>${q.subject} â€¢ ${q.class}</strong> <div class="muted-small">Difficulty: ${q.difficulty}</div></div>
            <div class="muted-small">Tags: ${(q.tags||[]).map(t=>`<span class="tag">${t}</span>`).join(' ')}</div>
          </div>
          <hr style="border:none;border-top:1px solid #eef3ff;margin:8px 0">
          <div id="previewContent">${q.text}</div>
          <div style="margin-top:12px;display:flex;gap:8px;justify-content:flex-end">
            <button class="btn ghost" id="editQuestionBtn" data-id="${q.id}">Edit</button>
            <button class="btn" id="copyQuestionBtn" data-id="${q.id}">Copy</button>
            <button class="btn warn" id="deleteQuestionBtn" data-id="${q.id}">Delete</button>
          </div>
        `;
        questionModal.classList.add('active'); questionModal.setAttribute('aria-hidden','false');

        setTimeout(()=> {
          document.getElementById('editQuestionBtn').addEventListener('click', ()=> {
            const id = document.getElementById('editQuestionBtn').dataset.id;
            questionModal.classList.remove('active');
            openQuestionEditor(bank.find(x=>x.id===id));
          }, { once:true });

          document.getElementById('copyQuestionBtn').addEventListener('click', ()=> {
            const id = document.getElementById('copyQuestionBtn').dataset.id;
            const q = bank.find(x=>x.id===id);
            if (!q) return;
            const copy = JSON.parse(JSON.stringify(q)); copy.id = 'Q-' + uid(4);
            bank.unshift(copy); saveBank(); renderList();
            alert('Question copied: ' + copy.id);
            questionModal.classList.remove('active');
          }, { once:true });

          document.getElementById('deleteQuestionBtn').addEventListener('click', ()=> {
            const id = document.getElementById('deleteQuestionBtn').dataset.id;
            if (!confirm('Delete question ' + id + '?')) return;
            bank = bank.filter(x=>x.id !== id); saveBank(); renderList(); questionModal.classList.remove('active');
          }, { once:true });
        }, 30);
      }

      document.getElementById('closeQuestionModal').addEventListener('click', ()=> {
        questionModal.classList.remove('active'); questionModal.setAttribute('aria-hidden','true');
        destroyQuill();
      });

      // Create / edit question â€” replace textarea with Quill
      function openQuestionEditor(existing) {
        const isEdit = !!existing;
        const q = existing ? JSON.parse(JSON.stringify(existing)) : { id:'Q-'+uid(4), class:'SS2', subject:'Biology', difficulty:'medium', text:'', choices:['','','',''], answer:0, tags:[] };
        questionModalTitle.textContent = isEdit ? `Edit ${q.id}` : 'Create new question';
        questionModalBody.innerHTML = `
          <form id="qForm" style="display:grid;gap:8px">
            <label>Question ID<input id="qId" value="${q.id}" readonly></label>
            <label>Class<select id="qClass"><option>SS1</option><option ${q.class==='SS2'?'selected':''}>SS2</option><option>SS3</option></select></label>
            <label>Subject<select id="qSubject"><option ${q.subject==='Biology'?'selected':''}>Biology</option><option ${q.subject==='Mathematics'?'selected':''}>Mathematics</option><option ${q.subject==='English'?'selected':''}>English</option><option ${q.subject==='Chemistry'?'selected':''}>Chemistry</option></select></label>
            <label>Difficulty<select id="qDiff"><option value="easy" ${q.difficulty==='easy'?'selected':''}>Easy</option><option value="medium" ${q.difficulty==='medium'?'selected':''}>Medium</option><option value="hard" ${q.difficulty==='hard'?'selected':''}>Hard</option></select></label>
            <label>Question text<div id="qEditor" style="height:160px;background:#fff;border:1px solid #e6e9ef;border-radius:8px"></div></label>
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
              <label>Choice A<input id="c0" value="${escapeHtmlAttr(q.choices[0]||'')}"></label>
              <label>Choice B<input id="c1" value="${escapeHtmlAttr(q.choices[1]||'')}"></label>
              <label>Choice C<input id="c2" value="${escapeHtmlAttr(q.choices[2]||'')}"></label>
              <label>Choice D<input id="c3" value="${escapeHtmlAttr(q.choices[3]||'')}"></label>
            </div>
            <label>Correct answer<select id="qAnswer"><option value="0" ${q.answer===0?'selected':''}>A</option><option value="1" ${q.answer===1?'selected':''}>B</option><option value="2" ${q.answer===2?'selected':''}>C</option><option value="3" ${q.answer===3?'selected':''}>D</option></select></label>
            <label>Tags (comma separated)<input id="qTags" value="${escapeHtmlAttr((q.tags||[]).join(', '))}"></label>
            <div style="display:flex;justify-content:flex-end;gap:8px">
              <button type="button" class="btn ghost" id="cancelQBtn">Cancel</button>
              <button type="submit" class="btn" id="saveQBtn">${isEdit ? 'Save changes' : 'Create question'}</button>
            </div>
          </form>
        `;

        // initialize Quill on #qEditor
        initQuill(q.text || '');

        // handlers
        setTimeout(()=> {
          document.getElementById('cancelQBtn').addEventListener('click', ()=> { questionModal.classList.remove('active'); destroyQuill(); });
          document.getElementById('qForm').addEventListener('submit', (ev)=> {
            ev.preventDefault();
            const newQ = {
              id: document.getElementById('qId').value || ('Q-'+uid(4)),
              class: document.getElementById('qClass').value,
              subject: document.getElementById('qSubject').value,
              difficulty: document.getElementById('qDiff').value,
              text: quill ? quill.root.innerHTML : '',
              choices: [document.getElementById('c0').value, document.getElementById('c1').value, document.getElementById('c2').value, document.getElementById('c3').value],
              answer: parseInt(document.getElementById('qAnswer').value, 10),
              tags: (document.getElementById('qTags').value || '').split(',').map(s=>s.trim()).filter(Boolean)
            };
            if (!newQ.text || newQ.text === '<p><br></p>') return alert('Question text is required');
            if (isEdit) {
              const idx = bank.findIndex(x=>x.id === existing.id);
              if (idx >= 0) bank[idx] = newQ;
            } else bank.unshift(newQ);
            saveBank(); renderList(); questionModal.classList.remove('active'); destroyQuill();
          });
        }, 30);

        questionModal.classList.add('active'); questionModal.setAttribute('aria-hidden','false');
      }

      function initQuill(initialHtml='') {
        destroyQuill();
        quill = new Quill('#qEditor', {
          theme: 'snow',
          modules: {
            toolbar: [
              [{ header: [1,2,3,false] }],
              ['bold','italic','underline','strike'],
              [{ 'list': 'ordered'}, { 'list': 'bullet' }],
              ['link','image'],
              ['clean']
            ]
          }
        });
        // set content safely
        quill.root.innerHTML = initialHtml || '';
      }
      function destroyQuill() {
        if (!quill) return;
        // remove quill DOM and instance
        const editorContainer = document.getElementById('qEditor');
        if (editorContainer) editorContainer.innerHTML = '';
        quill = null;
      }

      // Set modal handlers
      const setModalEl = document.getElementById('setModal');
      const setFormEl = document.getElementById('setForm');
      const setNameInput = document.getElementById('setName');
      const setClassInput = document.getElementById('setClass');
      const setSubjectInput = document.getElementById('setSubject');
      const setDifficultyInput = document.getElementById('setDifficulty');

      function openSetModal() {
        setNameInput.value = '';
        setClassInput.value = filterClass.value || 'SS2';
        setSubjectInput.value = filterSubject.value || 'Biology';
        setDifficultyInput.value = '';
        setModalEl.classList.add('active'); setModalEl.setAttribute('aria-hidden','false');
      }
      document.getElementById('closeSetModal').addEventListener('click', ()=> setModalEl.classList.remove('active'));
      document.getElementById('cancelSetBtn').addEventListener('click', ()=> setModalEl.classList.remove('active'));
      setFormEl.addEventListener('submit', (e) => {
        e.preventDefault();
        const name = setNameInput.value.trim(); if (!name) return alert('Set name required');
        const id = 'S-'+uid(4);
        const qids = Array.from(selected);
        const s = { id, name, class: setClassInput.value, subject: setSubjectInput.value, difficulty: setDifficultyInput.value || '', questionIds: qids };
        sets.push(s); saveSets(); setModalEl.classList.remove('active'); renderSets(); alert('Set created: ' + name + ' (' + qids.length + ' questions)');
      });

      // Schedule modal
      const scheduleModalEl = document.getElementById('scheduleModal');
      const scheduleForm = document.getElementById('scheduleForm');
      const schSource = document.getElementById('schSource');
      const schExtra = document.getElementById('schExtra');

      function openScheduleModal() {
        schExtra.innerHTML = '';
        schSource.value = 'selected';
        scheduleModalEl.classList.add('active'); scheduleModalEl.setAttribute('aria-hidden','false');
        document.getElementById('schDate').value = new Date().toISOString().slice(0,10);
        document.getElementById('schTime').value = '09:00';
      }
      document.getElementById('closeScheduleModal').addEventListener('click', ()=> scheduleModalEl.classList.remove('active'));
      document.getElementById('cancelScheduleBtn').addEventListener('click', ()=> scheduleModalEl.classList.remove('active'));

      schSource.addEventListener('change', ()=> {
        const val = schSource.value;
        if (val === 'set') {
          schExtra.innerHTML = `<label>Choose set<select id="schSet">${sets.map(s => `<option value="${s.id}">${escapeHtml(s.name)} â€¢ ${s.class} â€¢ ${s.subject} (${s.questionIds.length})</option>`).join('')}</select></label>`;
        } else {
          schExtra.innerHTML = `<div class="muted-small">Selected questions will be used (${selected.size})</div>`;
        }
      });

      scheduleForm.addEventListener('submit', (e) => {
        e.preventDefault();
        const title = document.getElementById('schTitle').value.trim() || 'Untitled exam';
        const cls = document.getElementById('schClass').value;
        const subject = document.getElementById('schSubject').value;
        const date = document.getElementById('schDate').value;
        const time = document.getElementById('schTime').value;
        const duration = parseInt(document.getElementById('schDuration').value, 10) || 60;
        let qids = [];
        if (schSource.value === 'set') {
          const setIdEl = document.getElementById('schSet'); if (!setIdEl) return alert('No set selected');
          const s = sets.find(x=>x.id === setIdEl.value); if (!s) return alert('Set not found');
          qids = s.questionIds.slice();
        } else qids = Array.from(selected);
        if (!qids.length) return alert('No questions selected for exam');
        const schedule = { id: 'SCH-'+uid(5), title, class: cls, subject, datetime: date + 'T' + (time || '00:00'), duration, questionIds: qids };
        schedules.push(schedule); saveSchedules(); scheduleModalEl.classList.remove('active'); renderSchedules();
        alert('Exam scheduled: ' + title + ' â€¢ ' + qids.length + ' questions'); selected.clear(); updateSelectionBar(); renderList();
      });

      // Exports
      function exportSelected(format='json') {
        const qids = Array.from(selected);
        if (!qids.length) return alert('No questions selected');
        const data = bank.filter(q => qids.includes(q.id));
        if (format === 'json') {
          const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' }); downloadBlob(blob, `questions_${Date.now()}.json`);
        } else {
          const rows = [['id','class','subject','difficulty','text','choiceA','choiceB','choiceC','choiceD','answer','tags']];
          data.forEach(q => rows.push([q.id,q.class,q.subject,q.difficulty, q.text.replace(/"/g,'""'), q.choices[0]||'', q.choices[1]||'', q.choices[2]||'', q.choices[3]||'', q.answer, (q.tags||[]).join('|')]));
          const csv = rows.map(r=>r.map(c=>`"${String(c).replace(/"/g,'""')}"`).join(',')).join('\n');
          const blob = new Blob([csv], { type: 'text/csv' }); downloadBlob(blob, `questions_${Date.now()}.csv`);
        }
      }
      function downloadBlob(blob, name) { const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = name; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url); }

      // Render sets/schedules/taken
      function renderSets() {
        const wrap = document.getElementById('setsWrap');
        wrap.innerHTML = '';
        if (!sets.length) { wrap.innerHTML = '<div class="empty">No sets created yet.</div>'; return; }
        const g = document.createElement('div'); g.className = 'grid';
        sets.forEach(s => {
          const c = document.createElement('article'); c.className = 'card';
          c.innerHTML = `<div style="font-weight:800">${escapeHtml(s.name)}</div><div class="muted-small">${s.class} â€¢ ${s.subject} â€¢ ${s.questionIds.length} questions</div>
            <div style="margin-top:8px;display:flex;gap:8px">
              <button class="btn" data-action="openSet" data-id="${s.id}">Open</button>
              <button class="btn ghost" data-action="exportSet" data-id="${s.id}">Export</button>
              <button class="btn ghost" data-action="useSet" data-id="${s.id}">Use</button>
            </div>`;
          g.appendChild(c);
        });
        wrap.appendChild(g);
      }

      function renderSchedules() {
        const wrap = document.getElementById('schedulesWrap');
        wrap.innerHTML = '';
        if (!schedules.length) { wrap.innerHTML = '<div class="empty">No scheduled exams</div>'; return; }
        schedules.forEach(s => {
          const c = document.createElement('article'); c.className = 'card';
          c.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center"><div><div style="font-weight:800">${escapeHtml(s.title)}</div><div class="muted-small">${s.class} â€¢ ${s.subject}</div></div><div class="muted-small">${new Date(s.datetime).toLocaleString()}</div></div>
            <div style="margin-top:8px;display:flex;gap:8px"><button class="btn" data-action="openSchedule" data-id="${s.id}">Open</button><button class="btn ghost" data-action="cancelSchedule" data-id="${s.id}">Cancel</button></div>`;
          wrap.appendChild(c);
        });
      }

      function renderTaken() {
        const wrap = document.getElementById('takenWrap');
        wrap.innerHTML = '';
        if (!taken.length) { wrap.innerHTML = '<div class="empty">No taken exams recorded</div>'; return; }
        taken.forEach(t => {
          const c = document.createElement('article'); c.className = 'card';
          c.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center"><div><div style="font-weight:800">${escapeHtml(t.title)}</div><div class="muted-small">${t.class} â€¢ ${t.subject}</div></div><div class="muted-small">${new Date(t.takenAt).toLocaleString()}</div></div>
            <div style="margin-top:8px" class="muted-small">Average: ${t.average}% â€¢ Participants: ${t.count}</div>`;
          wrap.appendChild(c);
        });
      }

      // Helpers on load
      function loadAll() { loadBank(); loadSets(); loadSchedules(); ensureSeed(); }
      loadAll(); ensureSeed(); renderList(); renderSets(); renderSchedules(); renderTaken();

      // update selection state watchers
      const observer = new MutationObserver(()=> updateSelectionBar());
      observer.observe(questionTbody, { childList:true, subtree:true });

      // close modals overlay/escape behavior
      const overlayEl = document.getElementById('overlay');
      overlayEl.addEventListener('click', ()=> {
        [questionModal, setModalEl, scheduleModalEl].forEach(m=>m.classList.remove('active'));
      });
      document.addEventListener('keydown', (e)=> {
        if (e.key === 'Escape') [questionModal, setModalEl, scheduleModalEl].forEach(m=>m.classList.remove('active'));
      });

      // Utility escape helper for attributes
      function escapeHtmlAttr(s){ return String(s||'').replace(/"/g,'&quot;'); }
      function escapeHtml(s){ return String(s||'').replace(/[&<>"']/g, function (m) { return ({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' })[m]; }); }

      // Ensure responsive sidebar works (same pattern used in other pages)
      const sidebarEl = document.getElementById('sidebar');
      const hamburgerEl = document.getElementById('hamburger');
      if (hamburgerEl) {
        hamburgerEl.addEventListener('click', ()=> {
          sidebarEl.classList.remove('hidden'); sidebarEl.classList.add('open');
          overlayEl.classList.add('visible'); document.body.classList.add('no-scroll');
        });
        overlayEl.addEventListener('click', ()=> {
          sidebarEl.classList.remove('open'); sidebarEl.classList.add('hidden');
          overlayEl.classList.remove('visible'); document.body.classList.remove('no-scroll');
        });
      }

      // Expose some constructors for future extension (optional)
      window.egQuestionBank = { bank, sets, schedules, saveBank, saveSets, saveSchedules };
    })();
  </script>
</body>
</html>
