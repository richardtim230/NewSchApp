<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>OAU ExamGuard | Blog Details</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/flowbite/2.2.1/flowbite.min.css" rel="stylesheet"/>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/flowbite/2.2.1/flowbite.min.js"></script>
  <style>
    body { 
    background-color: #f9fafb;
    padding-top: 74px !important;
    padding-bottom: 120px !important; /* ‚Üê increased from 90px to 120px */
  }
  .sticky-footer { 
    position: fixed; 
    z-index: 50; 
    bottom: 0; 
    left: 0; 
    width: 100%; 
    background: #fff; 
    /* Add a fixed height for consistency */
    height: 102px; 
    box-shadow: 0 -2px 12px rgba(0,0,0,0.03);
    display: flex;
    align-items: center;
  }
  @media (max-width: 640px) {
    body { padding-top: 64px !important; padding-bottom: 120px !important; }
  }
    .prose img { border-radius: 0.5rem; width: 100% !important; height: auto !important; object-fit: contain !important; }
    .prose { max-width: 100%; }
    body { background-color: #f9fafb; padding-top: 74px !important; padding-bottom: 90px !important; }
    .comment-bubble {
      background: #fffdfa;
      border-radius: 0.8em;
      padding: 1em 1.2em;
      margin-bottom: 1.5em;
      box-shadow: 0 1px 5px 0 rgb(0 0 0 / 7%);
      border: 1px solid #f3e8ff;
      transition: box-shadow 0.2s;
      position: relative;
    }
    .comment-bubble:hover {
      box-shadow: 0 4px 20px 0 rgb(190 180 255 / 13%);
    }
    .comment-author { font-weight: 600; color: #263159; }
    .comment-date { color: #9ca3af; font-size: 0.92em; }
    .comment-actions { margin-top: 0.4em; display: flex; gap: 1.2em; align-items: center; }
    .like-btn, .reply-btn {
      cursor: pointer;
      transition: color 0.2s, background 0.2s;
      color: #b49b2d;
      border: none;
      background: none;
      font-weight: 500;
      display: inline-flex;
      align-items: center;
      gap: 0.25em;
      font-size: 0.97em;
    }
    .like-btn.liked { color: #facc15; }
    .reply-btn.active { color: #263159; }
    .replies-container { margin-left: 1.5em; border-left: 2px solid #facc15; padding-left: 1em; margin-top: 1em; }
    .reply-form { background: #f9fafb; border-radius: 0.5em; padding: 0.9em 1em 0.7em 1em; border: 1px solid #e0e7ff; margin-top: 0.6em; }
    .reply-form input, .reply-form textarea { margin-bottom: 0.7em; }
    .sticky-header { position: fixed; z-index: 50; top: 0; left: 0; width: 100%; }
    .sticky-footer { position: fixed; z-index: 50; bottom: 0; left: 0; width: 100%; }
    @media (max-width: 640px) {
      .replies-container { margin-left: 0.7em; padding-left: 0.5em; }
      body { padding-top: 64px !important; padding-bottom: 94px !important; }
    }
    .line-clamp-2 { display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
    .line-clamp-3 { display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; overflow: hidden; }
    .related-img { width: 100% !important; object-fit: contain !important; aspect-ratio: 2.7/1 !important; height: 135px !important; }
  </style>
</head>
<body class="text-gray-900 bg-gray-50">

  <!-- Navbar with Hamburger -->
  <nav class="sticky-header w-full bg-white shadow-sm border-b border-blue-900/10 px-4 py-3 flex items-center justify-between">
    <a href="oau-blog.html" class="flex items-center gap-2 font-bold text-xl text-blue-900">
      <img src="logo.png" class="h-8" alt="logo">
      OAU <span class="text-yellow-600">ExamGuard</span> Blog
    </a>
    <button id="hamburger-btn" class="md:hidden p-2 text-blue-900 focus:outline-none" aria-label="Open menu">
      <svg class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
          d="M4 6h16M4 12h16M4 18h16"></path>
      </svg>
    </button>
    <div class="hidden md:flex gap-4 items-center font-semibold">
      <a href="oau-blog.html" class="hover:text-yellow-600 transition">Blog Home</a>
      <a href="index.html" class="hover:text-yellow-600 transition">Home</a>
      <a href="gen-marketplace.html" class="hover:text-yellow-600 transition">Marketplace</a>
      <a href="mock.html" class="bg-yellow-500 text-blue-900 px-5 py-2 rounded-full font-semibold hover:bg-blue-900 hover:text-yellow-400 transition">Login</a>
    </div>
  </nav>
  <!-- Mobile menu -->
  <div id="mobile-menu" class="fixed top-0 left-0 w-full h-full bg-white z-40 flex-col items-center justify-center pt-20 text-center hidden">
    <div class="flex flex-col gap-6 text-xl font-bold">
      <a href="oau-blog.html" class="hover:text-yellow-600" onclick="closeMobileMenu()">Blog Home</a>
      <a href="index.html" class="hover:text-yellow-600" onclick="closeMobileMenu()">Home</a>
      <a href="gen-marketplace.html" class="hover:text-yellow-600" onclick="closeMobileMenu()">Marketplace</a>
      <a href="mock.html" class="bg-yellow-500 text-blue-900 px-5 py-2 rounded-full font-semibold hover:bg-blue-900 hover:text-yellow-400 transition" onclick="closeMobileMenu()">Login</a>
      <button onclick="closeMobileMenu()" class="mt-8 text-blue-900 text-2xl font-bold">Close</button>
    </div>
  </div>

  <main class="max-w-3xl mx-auto px-4 py-8">
    <!-- Blog Main Content -->
    <article id="blogContent" class="bg-white rounded-2xl shadow p-6 mb-12 min-h-[320px] flex flex-col items-stretch">
      <div id="blogLoading" class="flex justify-center items-center py-24">
        <div class="w-12 h-12 border-4 border-yellow-400 border-t-blue-900 rounded-full animate-spin"></div>
      </div>
    </article>

    <!-- Author Profile Card -->
    <aside id="authorCard" class="bg-yellow-50 border-l-4 border-yellow-500 rounded-xl shadow mb-8 p-5 flex items-center gap-5 hidden">
      <img id="authorAvatar" src="" alt="Author" class="h-16 w-16 object-cover rounded-full border-2 border-yellow-400 bg-white">
      <div>
        <div id="authorName" class="font-bold text-blue-900 text-lg"></div>
        <div id="authorDept" class="text-sm text-gray-600"></div>
        <div id="authorBio" class="mt-1 text-sm text-gray-700"></div>
      </div>
    </aside>

    <!-- Comments Section -->
    <section class="mb-12">
      <h2 class="text-xl font-bold text-blue-900 mb-2">Comments</h2>
      <form id="commentForm" class="flex flex-col sm:flex-row gap-2 mb-6">
        <input type="text" id="commentName" placeholder="Your name" required 
               class="sm:w-1/4 px-3 py-2 border rounded focus:ring-2 focus:ring-yellow-400"/>
        <input type="text" id="commentText" placeholder="Add a comment..." required
               class="flex-1 px-3 py-2 border rounded focus:ring-2 focus:ring-yellow-400"/>
        <button type="submit" class="bg-yellow-500 text-blue-900 px-5 py-2 rounded font-bold hover:bg-blue-900 hover:text-yellow-400 transition">Comment</button>
      </form>
      <div id="commentsList"></div>
    </section>

    <!-- Related Posts -->
    <section>
      <h2 class="text-2xl font-bold text-blue-900 mb-4">Related Posts</h2>
      <div id="relatedPosts" class="grid gap-6 md:grid-cols-2"></div>
    </section>
  </main>

  <!-- Footer -->
  <footer class="sticky-footer bg-white border-t pt-6 py-8 mt-8">
    <div class="max-w-7xl mx-auto px-4 flex flex-col md:flex-row items-center justify-between gap-4">
      <div class="flex items-center gap-2 text-blue-900 font-bold text-lg">
        <img src="https://cdn.jsdelivr.net/gh/twitter/twemoji@latest/assets/svg/1f393.svg" class="h-6" alt="logo">
        OAU ExamGuard
      </div>
      <div class="text-yellow-600">&copy; 2025 OAU ExamGuard. All rights reserved.</div>
      <div class="flex gap-3">
        <a href="#" aria-label="Twitter" class="text-yellow-500 hover:text-blue-900"><svg class="w-5 h-5 fill-current" viewBox="0 0 24 24"><path d="M24 4.56a9.93 9.93 0 0 1-2.83.78A4.93 4.93 0 0 0 23.[...]</svg></a>
        <a href="#" aria-label="LinkedIn" class="text-blue-900 hover:text-yellow-600"><svg class="w-5 h-5 fill-current" viewBox="0 0 24 24"><path d="M19 0h-14c-2.761 0-5 2.239-5 5v14c0 2.761 2.239 5 5[...]"</svg></a>
      </div>
    </div>
  </footer>


  <script>
    const API_BASE = "https://examguide.onrender.com/api";
    const DASHBOARD_API = API_BASE + "/blogger-dashboard";

    // Hamburger menu
    document.getElementById('hamburger-btn').addEventListener('click', function() {
      document.getElementById('mobile-menu').classList.remove('hidden');
      document.body.style.overflow = 'hidden';
    });
    function closeMobileMenu() {
      document.getElementById('mobile-menu').classList.add('hidden');
      document.body.style.overflow = '';
    }

    // --- Parse post id from URL
    function getPostIdFromURL() {
      const params = new URLSearchParams(window.location.search);
      return params.get("id");
    }

    // --- Fetch all published posts (for related posts)
    async function fetchAllPosts() {
      const res = await fetch(`${DASHBOARD_API}/allposts`);
      return res.ok ? await res.json() : [];
    }

    // --- Fetch user info (for author card)
    async function fetchUserInfo(userId) {
      if (!userId) return {};
      try {
        const res = await fetch(`${API_BASE}/users/${userId}`);
        if (!res.ok) return {};
        const data = await res.json();
        return data.user || data;
      } catch {
        return {};
      }
    }

    // --- Backend: Like a post
    async function likePost(postId) {
      const res = await fetch(`${DASHBOARD_API}/like/${postId}`, { method: "PATCH" });
      return res.ok ? (await res.json()).likes : null;
    }

    // --- Backend: Like a comment
    async function likeComment(postId, commentId) {
      const res = await fetch(`${DASHBOARD_API}/like-comment/${postId}/${commentId}`, { method: "PATCH" });
      return res.ok ? (await res.json()).likes : null;
    }

    // --- Add a comment or reply to backend
    async function addCommentToBackend(postId, userId, name, text, parentId=null) {
      try {
        const res = await fetch(`${DASHBOARD_API}/add-comment/${postId}`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ name, text, user: userId, parentId })
        });
        if (!res.ok) throw new Error("Failed to add comment");
        return true;
      } catch {
        return false;
      }
    }

    // --- Main: fetch and render the selected post
    let allPostsCache = [];
    let mainPost = null;
    let postId = null;
    let category = null;

    (async function(){
      postId = getPostIdFromURL();
      if (!postId) {
        document.getElementById('blogContent').innerHTML = `<div class="text-center text-gray-500 py-20">Blog post not found.</div>`;
        return;
      }

      // Fetch all posts
      try {
        allPostsCache = await fetchAllPosts();
      } catch {
        document.getElementById('blogContent').innerHTML = `<div class="text-center text-gray-500 py-20">Could not load posts.</div>`;
        return;
      }

      // Find the main post
      mainPost = allPostsCache.find(p => p._id === postId);
      if (!mainPost) {
        document.getElementById('blogContent').innerHTML = `<div class="text-center text-gray-500 py-20">Blog post not found.</div>`;
        return;
      }

      // Format post details
      const author = mainPost.authorName || "Anonymous";
      const date = mainPost.date ? new Date(mainPost.date).toLocaleDateString(undefined, { year: 'numeric', month: 'short', day: 'numeric' }) : "";
      const image = mainPost.imageUrl || "https://images.unsplash.com/photo-1503676382389-4809596d5290?auto=format&fit=crop&w=800&q=80";
      category = mainPost.category || "General";
      const views = mainPost.views ?? 0;
      const likes = mainPost.likes ?? 0;
      const comments = Array.isArray(mainPost.comments) ? mainPost.comments : [];
      const content = mainPost.content || "";
      const title = mainPost.title || "";
      const authorId = mainPost.authorId || mainPost.user;

      // --- Render main post
      document.getElementById('blogContent').innerHTML = `
        <div class="relative">
          <img src="${image}" alt="${title}" class="w-full h-auto object-cover rounded-lg mb-4 shadow" />
          <button id="likePostBtn" class="absolute top-3 right-4 bg-white/90 rounded-full border border-yellow-200 px-3 py-1 flex items-center gap-1 font-semibold like-btn transition hover:bg-yellow-50 ${localStorage.getItem('liked_post_'+postId) ? 'liked' : ''}">
            <svg class="w-5 h-5 ${localStorage.getItem('liked_post_'+postId) ? 'text-yellow-400' : 'text-yellow-500'}" fill="currentColor" viewBox="0 0 20 20"><path d="M3.172 5.172A4 4 0 0 1 9.999 6.586a4 4 0 1 1 6.828-1.414c1.562 1.563 1.562 4.095 0 5.657l-6.657 6.657a1 1 0 0 1-1.414 0l-6.657-6.657c-1.562-1.562-1.562-4.094 0-5.657z"/></svg>
            <span id="likePostCount">${likes}</span>
          </button>
        </div>
        <h1 class="text-3xl font-extrabold text-blue-900 mb-2">${title}</h1>
        <div class="flex flex-wrap gap-2 text-sm text-gray-500 mb-2">
          <span class="bg-yellow-100 text-yellow-700 px-3 py-1 rounded-full font-medium">${category}</span>
          <span>${author}</span>
          <span>‚Ä¢ ${date}</span>
        </div>
        <div class="flex gap-4 text-xs text-gray-400 mb-6">
          <span>üëÅÔ∏è ${views} reads</span>
          <span>‚≠ê <span id="likePostCount2">${likes}</span> likes</span>
          <span>üí¨ ${comments.length} comments</span>
        </div>
        <div class="prose prose-lg max-w-none text-gray-900 mb-6">${content}</div>
        <div class="border-t pt-5 text-green-700 font-bold text-center">You earned 2 points for reading!</div>
      `;

      // Like post button
      document.getElementById('likePostBtn').addEventListener('click', async function() {
        if (localStorage.getItem('liked_post_' + postId)) return;
        this.disabled = true;
        const newLikes = await likePost(postId);
        if (newLikes !== null) {
          localStorage.setItem('liked_post_' + postId, '1');
          document.getElementById('likePostBtn').classList.add('liked');
          document.getElementById('likePostCount').textContent = newLikes;
          document.getElementById('likePostCount2').textContent = newLikes;
        }
        this.disabled = false;
      });

      // --- Author card
      if (authorId) {
        const authorData = await fetchUserInfo(authorId);
        if (authorData && (authorData.fullname || authorData.username)) {
          document.getElementById("authorCard").classList.remove("hidden");
          document.getElementById("authorName").textContent = authorData.fullname || authorData.username || "Anonymous";
          document.getElementById("authorDept").textContent = (authorData.department ? authorData.department + " Dept" : "") + (authorData.faculty ? ", " + authorData.faculty : "");
          document.getElementById("authorBio").textContent = authorData.bio || "";
          document.getElementById("authorAvatar").src = authorData.profilePic
            ? (authorData.profilePic.startsWith("http") ? authorData.profilePic : (authorData.profilePic))
            : `https://ui-avatars.com/api/?name=${encodeURIComponent(authorData.fullname || authorData.username || "Author")}&background=ffda00&color=263159&rounded=true`;
        }
      }

      // --- Render comments
      renderComments(comments);

      // --- Comments submit handler
      document.getElementById("commentForm").onsubmit = async function(e) {
        e.preventDefault();
        const name = document.getElementById("commentName").value.trim() || "Anonymous";
        const text = document.getElementById("commentText").value.trim();
        if (!text) return;

        // Save to backend
        const userId = null;
        const ok = await addCommentToBackend(postId, userId, name, text);
        if (ok) {
          // Reload comments
          allPostsCache = await fetchAllPosts();
          mainPost = allPostsCache.find(p => p._id === postId);
          renderComments(mainPost && Array.isArray(mainPost.comments) ? mainPost.comments : []);
          this.reset();
        } else {
          alert("Failed to add comment. Please try again.");
        }
      };

      // --- Related posts (same category, exclude main post). Fallback: recent other posts.
      let related = allPostsCache.filter(p => p._id !== postId && (p.category === category));
      if (related.length < 2) {
        related = allPostsCache.filter(p => p._id !== postId).slice(0, 4);
      } else {
        related = related.slice(0, 4);
      }

// --- Render related posts
      const relatedGrid = document.getElementById('relatedPosts');
      if (related.length === 0) {
        relatedGrid.innerHTML = `<div class="text-gray-400">No related posts found.</div>`;
      } else {
        relatedGrid.innerHTML = related.map(blog => `
          <a href="blog-details.html?id=${blog._id}" class="block bg-white rounded-xl shadow hover:shadow-xl overflow-hidden transition group">
            <img src="${blog.imageUrl || "https://images.unsplash.com/photo-1503676382389-4809596d5290?auto=format&fit=crop&w=400&q=80"}"
                 alt="${blog.title}" class="h-auto w-full object-cover group-hover:scale-105 transition" />
            <div class="p-4">
              <h3 class="font-bold text-blue-900 text-lg mb-1 line-clamp-2">${blog.title}</h3>
              <div class="flex items-center text-yellow-500 text-base font-bold mb-1">${blog.category || "General"}</div>
              <div class="text-xs text-gray-400 mb-2">${blog.authorName || "Anonymous"} ‚Ä¢ ${blog.date ? new Date(blog.date).toLocaleDateString() : ""}</div>
              <p class="text-gray-600 mb-2 line-clamp-2">${blog.content ? blog.content.substring(0, 80) + "..." : ""}</p>
              <div class="flex gap-2 text-xs text-gray-400">
                <span>üëÅÔ∏è ${blog.views ?? 0}</span>
                <span>‚≠ê ${blog.likes ?? 0}</span>
                <span>üí¨ ${Array.isArray(blog.comments) ? blog.comments.length : 0}</span>
              </div>
            </div>
          </a>
        `).join('');
      }
    })();

    // --- Render comments utility (supports nested replies, likes, reply button, styled)
    function renderComments(comments) {
      const list = document.getElementById("commentsList");
      if (!Array.isArray(comments) || comments.length === 0) {
        list.innerHTML = `<div class="text-gray-400 italic">No comments yet. Be the first to comment!</div>`;
        return;
      }
      // Sort by most recent
      comments = [...comments].sort((a, b) => new Date(b.date) - new Date(a.date));
      list.innerHTML = comments.filter(c => !c.parentId).map(c => renderCommentHTML(c, comments)).join('');
      attachCommentActionListeners();
    }

    // Render one comment (recursively with replies)
    function renderCommentHTML(comment, allComments) {
      const cid = comment._id || '';
      const likedKey = 'liked_comment_' + cid;
      const liked = localStorage.getItem(likedKey);
      // Replies (recursive)
      let repliesHTML = '';
      if (Array.isArray(comment.replies) && comment.replies.length > 0) {
        // Use replies array (backend nested)
        repliesHTML = `<div class="replies-container">${comment.replies.sort((a,b)=>new Date(a.date)-new Date(b.date)).map(r => renderCommentHTML(r, allComments)).join('')}</div>`;
      } else if (Array.isArray(allComments)) {
        // For legacy: find direct children
        const children = allComments.filter(r => r.parentId === cid);
        if (children.length) {
          repliesHTML = `<div class="replies-container">${children.sort((a,b)=>new Date(a.date)-new Date(b.date)).map(r => renderCommentHTML(r, allComments)).join('')}</div>`;
        }
      }
      // Main comment
      return `
        <div class="comment-bubble" data-comment-id="${cid}">
          <div>
            <span class="comment-author">${comment.name || 'Anonymous'}</span>
            <span class="comment-date ml-2">${comment.date ? new Date(comment.date).toLocaleString() : ''}</span>
          </div>
          <div class="mt-1 text-gray-800">${comment.text}</div>
          <div class="comment-actions">
            <button class="like-btn ${liked ? 'liked' : ''}" data-comment-id="${cid}">
              <svg class="w-4 h-4 mr-1 ${liked ? 'text-yellow-400' : 'text-yellow-500'}" fill="currentColor" viewBox="0 0 20 20"><path d="M3.172 5.172A4 4 0 0 1 9.999 6.586a4 4 0 1 1 6.828-1.414c1.562 1.563 1.562 4.095 0 5.657l-6.657 6.657a1 1 0 0 1-1.414 0l-6.657-6.657c-1.562-1.562-1.562-4.094 0-5.657z"/></svg>
              <span class="like-count">${comment.likes || 0}</span>
            </button>
            <button class="reply-btn" data-comment-id="${cid}">Reply</button>
          </div>
          <div class="reply-form-container"></div>
          ${repliesHTML}
        </div>
      `;
    }

    // Attach like/reply button listeners and reply form logic
    function attachCommentActionListeners() {
      // Like buttons
      document.querySelectorAll('.like-btn[data-comment-id]').forEach(btn => {
        btn.onclick = async function(e) {
          e.preventDefault();
          const commentId = this.getAttribute('data-comment-id');
          if (!commentId || localStorage.getItem('liked_comment_' + commentId)) return;
          this.disabled = true;
          const likeCountSpan = this.querySelector('.like-count');
          const newLikes = await likeComment(postId, commentId);
          if (newLikes !== null) {
            localStorage.setItem('liked_comment_' + commentId, '1');
            this.classList.add('liked');
            likeCountSpan.textContent = newLikes;
          }
          this.disabled = false;
        }
      });

      // Reply buttons
      document.querySelectorAll('.reply-btn[data-comment-id]').forEach(btn => {
        btn.onclick = function(e) {
          e.preventDefault();
          const commentId = this.getAttribute('data-comment-id');
          // Remove other open reply forms
          document.querySelectorAll('.reply-form-container').forEach(f => f.innerHTML = '');
          // Insert reply form
          const parentBubble = this.closest('.comment-bubble');
          const container = parentBubble.querySelector('.reply-form-container');
          container.innerHTML = `
            <form class="reply-form" data-parent-id="${commentId}">
              <input type="text" name="name" placeholder="Your name" class="w-full px-2 py-1 mb-1 border rounded focus:ring-2 focus:ring-yellow-400" required />
              <textarea name="text" rows="2" placeholder="Write a reply..." class="w-full px-2 py-1 border rounded focus:ring-2 focus:ring-yellow-400" required></textarea>
              <div class="flex items-center gap-2">
                <button type="submit" class="bg-yellow-500 text-blue-900 px-4 py-1 rounded font-bold hover:bg-blue-900 hover:text-yellow-400 transition">Reply</button>
                <button type="button" class="cancel-reply-btn text-xs text-gray-500 hover:underline">Cancel</button>
              </div>
            </form>
          `;
          // Attach submit/cancel
          container.querySelector('form').onsubmit = async function(ev) {
            ev.preventDefault();
            const name = this.name.value.trim() || "Anonymous";
            const text = this.text.value.trim();
            if (!text) return;
            const ok = await addCommentToBackend(postId, null, name, text, commentId);
            if (ok) {
              allPostsCache = await fetchAllPosts();
              mainPost = allPostsCache.find(p => p._id === postId);
              renderComments(mainPost && Array.isArray(mainPost.comments) ? mainPost.comments : []);
            }
          };
          container.querySelector('.cancel-reply-btn').onclick = function() {
            container.innerHTML = '';
          };
        }
      });
    }
  </script>
</body>
</html>
