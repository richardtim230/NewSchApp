<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>OAU ExamGuard | Blog Details</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/flowbite/2.2.1/flowbite.min.css" rel="stylesheet"/>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/flowbite/2.2.1/flowbite.min.js"></script>
  <style>
    .prose img { border-radius: 0.5rem; }
    .prose { max-width: 100%; }
    body { background-color: #f9fafb; }
    .comment-bubble { background: #f9fafb; border-radius: 0.8em; padding: 1em; }
    .comment-author { font-weight: 600; }
    .comment-date { color: #9ca3af; font-size: 0.92em; }
    .line-clamp-2 { display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
    .line-clamp-3 { display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; overflow: hidden; }
  </style>
</head>
<body class="text-gray-900 bg-gray-50">

  <!-- Navbar with Hamburger -->
  <nav class="w-full bg-white shadow-sm border-b border-blue-900/10 px-4 py-3 flex items-center justify-between">
    <a href="oau-blog.html" class="flex items-center gap-2 font-bold text-xl text-blue-900">
      <img src="logo.png" class="h-8" alt="logo">
      OAU <span class="text-yellow-600">ExamGuard</span> Blog
    </a>
    <button id="hamburger-btn" class="md:hidden p-2 text-blue-900 focus:outline-none" aria-label="Open menu">
      <svg class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
          d="M4 6h16M4 12h16M4 18h16"></path>
      </svg>
    </button>
    <div class="hidden md:flex gap-4 items-center font-semibold">
      <a href="oau-blog.html" class="hover:text-yellow-600 transition">Blog Home</a>
      <a href="index.html" class="hover:text-yellow-600 transition">Home</a>
      <a href="gen-marketplace.html" class="hover:text-yellow-600 transition">Marketplace</a>
      <a href="mock.html" class="bg-yellow-500 text-blue-900 px-5 py-2 rounded-full font-semibold hover:bg-blue-900 hover:text-yellow-400 transition">Login</a>
    </div>
  </nav>
  <!-- Mobile menu -->
  <div id="mobile-menu" class="fixed top-0 left-0 w-full h-full bg-white z-40 flex-col items-center justify-center pt-20 text-center hidden">
    <div class="flex flex-col gap-6 text-xl font-bold">
      <a href="oau-blog.html" class="hover:text-yellow-600" onclick="closeMobileMenu()">Blog Home</a>
      <a href="index.html" class="hover:text-yellow-600" onclick="closeMobileMenu()">Home</a>
      <a href="gen-marketplace.html" class="hover:text-yellow-600" onclick="closeMobileMenu()">Marketplace</a>
      <a href="mock.html" class="bg-yellow-500 text-blue-900 px-5 py-2 rounded-full font-semibold hover:bg-blue-900 hover:text-yellow-400 transition" onclick="closeMobileMenu()">Login</a>
      <button onclick="closeMobileMenu()" class="mt-8 text-blue-900 text-2xl font-bold">Close</button>
    </div>
  </div>

  <main class="max-w-3xl mx-auto px-4 py-8">
    <!-- Blog Main Content -->
    <article id="blogContent" class="bg-white rounded-2xl shadow p-6 mb-12 min-h-[320px] flex flex-col items-stretch">
      <div id="blogLoading" class="flex justify-center items-center py-24">
        <div class="w-12 h-12 border-4 border-yellow-400 border-t-blue-900 rounded-full animate-spin"></div>
      </div>
    </article>

    <!-- Author Profile Card -->
    <aside id="authorCard" class="bg-yellow-50 border-l-4 border-yellow-500 rounded-xl shadow mb-8 p-5 flex items-center gap-5 hidden">
      <img id="authorAvatar" src="" alt="Author" class="h-16 w-16 object-cover rounded-full border-2 border-yellow-400 bg-white">
      <div>
        <div id="authorName" class="font-bold text-blue-900 text-lg"></div>
        <div id="authorDept" class="text-sm text-gray-600"></div>
        <div id="authorBio" class="mt-1 text-sm text-gray-700"></div>
      </div>
    </aside>

    <!-- Comments Section -->
    <section class="mb-12">
      <h2 class="text-xl font-bold text-blue-900 mb-2">Comments</h2>
      <form id="commentForm" class="flex flex-col sm:flex-row gap-2 mb-6">
        <input type="text" id="commentName" placeholder="Your name" required 
               class="sm:w-1/4 px-3 py-2 border rounded focus:ring-2 focus:ring-yellow-400"/>
        <input type="text" id="commentText" placeholder="Add a comment..." required
               class="flex-1 px-3 py-2 border rounded focus:ring-2 focus:ring-yellow-400"/>
        <button type="submit" class="bg-yellow-500 text-blue-900 px-5 py-2 rounded font-bold hover:bg-blue-900 hover:text-yellow-400 transition">Comment</button>
      </form>
      <div id="commentsList"></div>
    </section>

    <!-- Related Posts -->
    <section>
      <h2 class="text-2xl font-bold text-blue-900 mb-4">Related Posts</h2>
      <div id="relatedPosts" class="grid gap-6 md:grid-cols-2"></div>
    </section>
  </main>

  <!-- Footer -->
  <footer class="bg-white border-t py-8 mt-8">
    <div class="max-w-7xl mx-auto px-4 flex flex-col md:flex-row items-center justify-between gap-4">
      <div class="flex items-center gap-2 text-blue-900 font-bold text-lg">
        <img src="https://cdn.jsdelivr.net/gh/twitter/twemoji@latest/assets/svg/1f393.svg" class="h-6" alt="logo">
        OAU ExamGuard
      </div>
      <div class="text-yellow-600">&copy; 2025 OAU ExamGuard. All rights reserved.</div>
      <div class="flex gap-3">
        <a href="#" aria-label="Twitter" class="text-yellow-500 hover:text-blue-900"><svg class="w-5 h-5 fill-current" viewBox="0 0 24 24"><path d="M24 4.56a9.93 9.93 0 0 1-2.83.78A4.93 4.93 0 0 0 23.5 2.5a9.86 9.86 0 0 1-3.13 1.2A4.92 4.92 0 0 0 12 7.7c0 .38.04.76.12 1.12C8.09 8.7 4.29 6.76 1.67 3.95a4.93 4.93 0 0 0-.66 2.48c0 1.71.87 3.22 2.19 4.1A4.93 4.93 0 0 1 .96 9.1v.06a4.92 4.92 0 0 0 3.95 4.82c-.21.06-.43.09-.66.09-.16 0-.32-.02-.47-.04.32 1 1.26 1.73 2.37 1.75A9.87 9.87 0 0 1 0 21.54a13.94 13.94 0 0 0 7.56 2.22c9.05 0 14-7.5 14-14v-.64A9.94 9.94 0 0 0 24 4.56z"/></svg></a>
        <a href="#" aria-label="LinkedIn" class="text-blue-900 hover:text-yellow-600"><svg class="w-5 h-5 fill-current" viewBox="0 0 24 24"><path d="M19 0h-14c-2.761 0-5 2.239-5 5v14c0 2.761 2.239 5 5 5h14c2.761 0 5-2.239 5-5v-14c0-2.761-2.239-5-5-5zm-11 19h-3v-10h3v10zm-1.5-11.268c-.966 0-1.75-.79-1.75-1.76s.784-1.76 1.75-1.76 1.75.79 1.75 1.76-.784 1.76-1.75 1.76zm13.5 11.268h-3v-5.604c0-1.337-.025-3.065-1.867-3.065-1.869 0-2.156 1.459-2.156 2.966v5.703h-3v-10h2.881v1.367h.041c.401-.758 1.379-1.557 2.841-1.557 3.038 0 3.602 2.001 3.602 4.601v5.589z"/></svg></a>
      </div>
    </div>
  </footer>

  <script>
    const API_BASE = "https://examguide.onrender.com/api";
    const DASHBOARD_API = API_BASE + "/blogger-dashboard";
    // Hamburger menu
    document.getElementById('hamburger-btn').addEventListener('click', function() {
      document.getElementById('mobile-menu').classList.remove('hidden');
      document.body.style.overflow = 'hidden';
    });
    function closeMobileMenu() {
      document.getElementById('mobile-menu').classList.add('hidden');
      document.body.style.overflow = '';
    }

    // --- Parse post id from URL
    function getPostIdFromURL() {
      const params = new URLSearchParams(window.location.search);
      return params.get("id");
    }

    // --- Fetch all published posts (for related posts)
    async function fetchAllPosts() {
      const res = await fetch(`${DASHBOARD_API}/allposts`);
      return res.ok ? await res.json() : [];
    }

    // --- Fetch user info (for author card)
    async function fetchUserInfo(userId) {
      if (!userId) return {};
      try {
        const res = await fetch(`${API_BASE}/users/${userId}`);
        if (!res.ok) return {};
        const data = await res.json();
        return data.user || data;
      } catch {
        return {};
      }
    }

    // --- Add a comment to backend
    async function addCommentToBackend(postId, userId, name, text) {
      try {
        const res = await fetch(`${DASHBOARD_API}/add-comment/${postId}`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ name, text, user: userId })
        });
        if (!res.ok) throw new Error("Failed to add comment");
        return true;
      } catch {
        return false;
      }
    }

    // --- Main: fetch and render the selected post
    (async function(){
      const postId = getPostIdFromURL();
      if (!postId) {
        document.getElementById('blogContent').innerHTML = `<div class="text-center text-gray-500 py-20">Blog post not found.</div>`;
        return;
      }

      // Fetch all posts
      let allPosts = [];
      try {
        allPosts = await fetchAllPosts();
      } catch {
        document.getElementById('blogContent').innerHTML = `<div class="text-center text-gray-500 py-20">Could not load posts.</div>`;
        return;
      }

      // Find the main post
      const mainPost = allPosts.find(p => p._id === postId);
      if (!mainPost) {
        document.getElementById('blogContent').innerHTML = `<div class="text-center text-gray-500 py-20">Blog post not found.</div>`;
        return;
      }

      // Format post details
      const author = mainPost.authorName || "Anonymous";
      const date = mainPost.date ? new Date(mainPost.date).toLocaleDateString(undefined, { year: 'numeric', month: 'short', day: 'numeric' }) : "";
      const image = mainPost.imageUrl || "https://images.unsplash.com/photo-1503676382389-4809596d5290?auto=format&fit=crop&w=800&q=80";
      const category = mainPost.category || "General";
      const views = mainPost.views ?? 0;
      const likes = mainPost.likes ?? 0;
      const comments = Array.isArray(mainPost.comments) ? mainPost.comments : [];
      const content = mainPost.content || "";
      const title = mainPost.title || "";
      const authorId = mainPost.authorId || mainPost.user; // Add userId to post in backend
      // Render main post
      document.getElementById('blogContent').innerHTML = `
        <img src="${image}" alt="${title}" class="w-full h-64 object-cover rounded-lg mb-4 shadow" />
        <h1 class="text-3xl font-extrabold text-blue-900 mb-2">${title}</h1>
        <div class="flex flex-wrap gap-2 text-sm text-gray-500 mb-2">
          <span class="bg-yellow-100 text-yellow-700 px-3 py-1 rounded-full font-medium">${category}</span>
          <span>${author}</span>
          <span>• ${date}</span>
        </div>
        <div class="flex gap-4 text-xs text-gray-400 mb-6">
          <span>👁️ ${views} reads</span>
          <span>⭐ ${likes} likes</span>
          <span>💬 ${comments.length} comments</span>
        </div>
        <div class="prose prose-lg max-w-none text-gray-900 mb-6">${content}</div>
        <div class="border-t pt-5 text-green-700 font-bold text-center">You earned 2 points for reading!</div>
      `;

      // --- Author card
      if (authorId) {
        const authorData = await fetchUserInfo(authorId);
        if (authorData && (authorData.fullname || authorData.username)) {
          document.getElementById("authorCard").classList.remove("hidden");
          document.getElementById("authorName").textContent = authorData.fullname || authorData.username || "Anonymous";
          document.getElementById("authorDept").textContent = (authorData.department ? authorData.department + " Dept" : "") + (authorData.faculty ? ", " + authorData.faculty : "");
          document.getElementById("authorBio").textContent = authorData.bio || "";
          document.getElementById("authorAvatar").src = authorData.profilePic
            ? (authorData.profilePic.startsWith("http") ? authorData.profilePic : (authorData.profilePic))
            : `https://ui-avatars.com/api/?name=${encodeURIComponent(authorData.fullname || authorData.username || "Author")}&background=ffda00&color=263159&rounded=true`;
        }
      }

      // --- Render comments
      renderComments(comments);

      // --- Comments submit handler
      document.getElementById("commentForm").onsubmit = async function(e) {
        e.preventDefault();
        const name = document.getElementById("commentName").value.trim() || "Anonymous";
        const text = document.getElementById("commentText").value.trim();
        if (!text) return;

        // Save to backend
        const userId = null; // Optionally get from auth, or leave null for anonymous
        const ok = await addCommentToBackend(postId, userId, name, text);
        if (ok) {
          // Reload comments
          allPosts = await fetchAllPosts();
          const updatedPost = allPosts.find(p => p._id === postId);
          renderComments(updatedPost && Array.isArray(updatedPost.comments) ? updatedPost.comments : []);
          this.reset();
        } else {
          alert("Failed to add comment. Please try again.");
        }
      };

      // --- Related posts (same category, exclude main post). Fallback: recent other posts.
      let related = allPosts.filter(p => p._id !== postId && (p.category === category));
      if (related.length < 2) {
        related = allPosts.filter(p => p._id !== postId).slice(0, 4);
      } else {
        related = related.slice(0, 4);
      }

      // --- Render related posts
      const relatedGrid = document.getElementById('relatedPosts');
      if (related.length === 0) {
        relatedGrid.innerHTML = `<div class="text-gray-400">No related posts found.</div>`;
      } else {
        relatedGrid.innerHTML = related.map(blog => `
          <a href="blog-details.html?id=${blog._id}" class="block bg-white rounded-xl shadow hover:shadow-xl overflow-hidden transition group">
            <img src="${blog.imageUrl || "https://images.unsplash.com/photo-1503676382389-4809596d5290?auto=format&fit=crop&w=400&q=80"}"
                 alt="${blog.title}" class="h-36 w-full object-cover group-hover:scale-105 transition" />
            <div class="p-4">
              <h3 class="font-bold text-blue-900 text-lg mb-1 line-clamp-2">${blog.title}</h3>
              <div class="flex items-center text-yellow-500 text-base font-bold mb-1">${blog.category || "General"}</div>
              <div class="text-xs text-gray-400 mb-2">${blog.authorName || "Anonymous"} • ${blog.date ? new Date(blog.date).toLocaleDateString() : ""}</div>
              <p class="text-gray-600 mb-2 line-clamp-2">${blog.content ? blog.content.substring(0, 80) + "..." : ""}</p>
              <div class="flex gap-2 text-xs text-gray-400">
                <span>👁️ ${blog.views ?? 0}</span>
                <span>⭐ ${blog.likes ?? 0}</span>
                <span>💬 ${Array.isArray(blog.comments) ? blog.comments.length : 0}</span>
              </div>
            </div>
          </a>
        `).join('');
      }
    })();

    // --- Render comments utility
    function renderComments(comments) {
      const list = document.getElementById("commentsList");
      if (!Array.isArray(comments) || comments.length === 0) {
        list.innerHTML = `<div class="text-gray-400 italic">No comments yet. Be the first to comment!</div>`;
        return;
      }
      // Sort by most recent
      comments = [...comments].sort((a, b) => new Date(b.date) - new Date(a.date));
      list.innerHTML = comments.map(comment => `
        <div class="comment-bubble mb-4">
          <div>
            <span class="comment-author">${comment.name || 'Anonymous'}</span>
            <span class="comment-date ml-2">${comment.date ? new Date(comment.date).toLocaleString() : ''}</span>
          </div>
          <div class="mt-1">${comment.text}</div>
        </div>
      `).join('');
    }
  </script>
</body>
</html>
