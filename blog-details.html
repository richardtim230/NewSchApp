<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>OAU ExamGuard | Blog Details</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/flowbite/2.2.1/flowbite.min.css" rel="stylesheet"/>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/flowbite/2.2.1/flowbite.min.js"></script>
  <style>
    .prose img { border-radius: 0.5rem; }
    .prose { max-width: 100%; }
    body { background-color: #f9fafb; }
    .comment-bubble { background: #f9fafb; border-radius: 0.8em; padding: 1em; }
    .comment-author { font-weight: 600; }
    .comment-date { color: #9ca3af; font-size: 0.92em; }
    .line-clamp-2 { display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
    .line-clamp-3 { display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; overflow: hidden; }
    /* Sticky header/footer fix */
    .sticky-header { position: fixed; top: 0; left: 0; right: 0; z-index: 50; }
    .sticky-footer { position: fixed; bottom: 0; left: 0; right: 0; z-index: 50; }
    .content-with-sticky { padding-top: 64px; padding-bottom: 72px; } /* header/footer heights */
    /* Comments section styling */
    .comment-actions { display: flex; gap: 1em; align-items: center; margin-top: 0.5em; }
    .reply-form { margin-top: 0.4em; margin-bottom: 0.8em; }
    .reply-bubble { margin-left: 2em; border-left: 2px solid #fee08a; background: #fffbe6; }
    .like-btn, .reply-btn {
      background: none; border: none; color: #f59e42; font-weight: bold; cursor: pointer; display: flex; align-items: center; gap: 0.3em;
    }
    .like-btn.liked { color: #ea580c; }
    .reply-btn { color: #2563eb; }
    .comment-bubble { transition: box-shadow .15s; }
    .comment-bubble:hover { box-shadow: 0 2px 8px 0 #eab30833; }
    .comment-bubble .reply-bubble { box-shadow: none; }
    @media (max-width: 768px) {
      .content-with-sticky { padding-top: 60px; padding-bottom: 90px; }
    }
  </style>
</head>
<body class="text-gray-900 bg-gray-50">

  <!-- Navbar with Hamburger -->
  <nav class="sticky-header w-full bg-white shadow-sm border-b border-blue-900/10 px-4 py-3 flex items-center justify-between">
    <a href="oau-blog.html" class="flex items-center gap-2 font-bold text-xl text-blue-900">
      <img src="logo.png" class="h-8" alt="logo">
      OAU <span class="text-yellow-600">ExamGuard</span> Blog
    </a>
    <button id="hamburger-btn" class="md:hidden p-2 text-blue-900 focus:outline-none" aria-label="Open menu">
      <svg class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
          d="M4 6h16M4 12h16M4 18h16"></path>
      </svg>
    </button>
    <div class="hidden md:flex gap-4 items-center font-semibold">
      <a href="oau-blog.html" class="hover:text-yellow-600 transition">Blog Home</a>
      <a href="index.html" class="hover:text-yellow-600 transition">Home</a>
      <a href="gen-marketplace.html" class="hover:text-yellow-600 transition">Marketplace</a>
      <a href="mock.html" class="bg-yellow-500 text-blue-900 px-5 py-2 rounded-full font-semibold hover:bg-blue-900 hover:text-yellow-400 transition">Login</a>
    </div>
  </nav>
  <!-- Mobile menu -->
  <div id="mobile-menu" class="fixed top-0 left-0 w-full h-full bg-white z-40 flex-col items-center justify-center pt-20 text-center hidden">
    <div class="flex flex-col gap-6 text-xl font-bold">
      <a href="oau-blog.html" class="hover:text-yellow-600" onclick="closeMobileMenu()">Blog Home</a>
      <a href="index.html" class="hover:text-yellow-600" onclick="closeMobileMenu()">Home</a>
      <a href="gen-marketplace.html" class="hover:text-yellow-600" onclick="closeMobileMenu()">Marketplace</a>
      <a href="mock.html" class="bg-yellow-500 text-blue-900 px-5 py-2 rounded-full font-semibold hover:bg-blue-900 hover:text-yellow-400 transition" onclick="closeMobileMenu()">Login</a>
      <button onclick="closeMobileMenu()" class="mt-8 text-blue-900 text-2xl font-bold">Close</button>
    </div>
  </div>

  <main class="max-w-3xl mx-auto px-4 py-8 content-with-sticky">
    <!-- Blog Main Content -->
    <article id="blogContent" class="bg-white rounded-2xl shadow p-6 mb-12 min-h-[320px] flex flex-col items-stretch">
      <div id="blogLoading" class="flex justify-center items-center py-24">
        <div class="w-12 h-12 border-4 border-yellow-400 border-t-blue-900 rounded-full animate-spin"></div>
      </div>
    </article>

    <!-- Author Profile Card -->
    <aside id="authorCard" class="bg-yellow-50 border-l-4 border-yellow-500 rounded-xl shadow mb-8 p-5 flex items-center gap-5 hidden">
      <img id="authorAvatar" src="" alt="Author" class="h-16 w-16 object-cover rounded-full border-2 border-yellow-400 bg-white">
      <div>
        <div id="authorName" class="font-bold text-blue-900 text-lg"></div>
        <div id="authorDept" class="text-sm text-gray-600"></div>
        <div id="authorBio" class="mt-1 text-sm text-gray-700"></div>
      </div>
    </aside>

    <!-- Comments Section -->
    <section class="mb-12">
      <h2 class="text-xl font-bold text-blue-900 mb-2">Comments</h2>
      <form id="commentForm" class="flex flex-col sm:flex-row gap-2 mb-6">
        <input type="text" id="commentName" placeholder="Your name" required 
               class="sm:w-1/4 px-3 py-2 border rounded focus:ring-2 focus:ring-yellow-400"/>
        <input type="text" id="commentText" placeholder="Add a comment..." required
               class="flex-1 px-3 py-2 border rounded focus:ring-2 focus:ring-yellow-400"/>
        <button type="submit" class="bg-yellow-500 text-blue-900 px-5 py-2 rounded font-bold hover:bg-blue-900 hover:text-yellow-400 transition">Comment</button>
      </form>
      <div id="commentsList"></div>
    </section>

    <!-- Related Posts -->
    <section>
      <h2 class="text-2xl font-bold text-blue-900 mb-4">Related Posts</h2>
      <div id="relatedPosts" class="grid gap-6 md:grid-cols-2"></div>
    </section>
  </main>



  <script>
    const API_BASE = "https://examguide.onrender.com/api";
    const DASHBOARD_API = API_BASE + "/blogger-dashboard";

    document.getElementById('hamburger-btn').addEventListener('click', function() {
      document.getElementById('mobile-menu').classList.remove('hidden');
      document.body.style.overflow = 'hidden';
    });
    function closeMobileMenu() {
      document.getElementById('mobile-menu').classList.add('hidden');
      document.body.style.overflow = '';
    }

    // --- Parse post id from URL
    function getPostIdFromURL() {
      const params = new URLSearchParams(window.location.search);
      return params.get("id");
    }

    // --- Fetch all published posts (for related posts)
    async function fetchAllPosts() {
      const res = await fetch(`${DASHBOARD_API}/allposts`);
      return res.ok ? await res.json() : [];
    }

    // --- Fetch user info (for author card)
    async function fetchUserInfo(userId) {
      if (!userId) return {};
      try {
        const res = await fetch(`${API_BASE}/users/${userId}`);
        if (!res.ok) return {};
        const data = await res.json();
        return data.user || data;
      } catch {
        return {};
      }
    }

    // --- Add a comment or reply to backend
    async function addCommentToBackend(postId, userId, name, text, parentId) {
      try {
        const res = await fetch(`${DASHBOARD_API}/add-comment/${postId}`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ name, text, user: userId, parentId })
        });
        if (!res.ok) throw new Error("Failed to add comment");
        return true;
      } catch {
        return false;
      }
    }

    // --- Like post
    async function likePost(postId) {
      try {
        const res = await fetch(`${DASHBOARD_API}/like/${postId}`, { method: "PATCH" });
        if (!res.ok) return null;
        return await res.json();
      } catch {
        return null;
      }
    }

    // --- Like comment
    async function likeComment(postId, commentId) {
      try {
        const res = await fetch(`${DASHBOARD_API}/like-comment/${postId}/${commentId}`, { method: "PATCH" });
        if (!res.ok) return null;
        return await res.json();
      } catch {
        return null;
      }
    }

    // --- Main: fetch and render the selected post
    let allPosts = [];
    let mainPost = null;
    let postId = null;
    (async function(){
      postId = getPostIdFromURL();
      if (!postId) {
        document.getElementById('blogContent').innerHTML = `<div class="text-center text-gray-500 py-20">Blog post not found.</div>`;
        return;
      }

      // Fetch all posts
      try {
        allPosts = await fetchAllPosts();
      } catch {
        document.getElementById('blogContent').innerHTML = `<div class="text-center text-gray-500 py-20">Could not load posts.</div>`;
        return;
      }

      // Find the main post
      mainPost = allPosts.find(p => p._id === postId);
      if (!mainPost) {
        document.getElementById('blogContent').innerHTML = `<div class="text-center text-gray-500 py-20">Blog post not found.</div>`;
        return;
      }

      // Format post details
      const author = mainPost.authorName || "Anonymous";
      const date = mainPost.date ? new Date(mainPost.date).toLocaleDateString(undefined, { year: 'numeric', month: 'short', day: 'numeric' }) : "";
      const image = mainPost.imageUrl || "https://images.unsplash.com/photo-1503676382389-4809596d5290?auto=format&fit=crop&w=800&q=80";
      const category = mainPost.category || "General";
      const views = mainPost.views ?? 0;
      const likes = mainPost.likes ?? 0;
      const comments = Array.isArray(mainPost.comments) ? mainPost.comments : [];
      const content = mainPost.content || "";
      const title = mainPost.title || "";
      const authorId = mainPost.authorId || mainPost.user;

      // Render main post with featured image full height
      document.getElementById('blogContent').innerHTML = `
        <div class="w-full mb-4 rounded-lg overflow-hidden shadow" style="max-width: 100%;">
          <img src="${image}" alt="${title}" class="w-full h-80 object-cover object-center" style="display:block;"/>
        </div>
        <h1 class="text-3xl font-extrabold text-blue-900 mb-2">${title}</h1>
        <div class="flex flex-wrap gap-2 text-sm text-gray-500 mb-2">
          <span class="bg-yellow-100 text-yellow-700 px-3 py-1 rounded-full font-medium">${category}</span>
          <span>${author}</span>
          <span>‚Ä¢ ${date}</span>
        </div>
        <div class="flex gap-4 text-xs text-gray-400 mb-6 items-center">
          <span>üëÅÔ∏è ${views} reads</span>
          <span id="post-likes"><button class="like-btn" id="like-post-btn" aria-label="Like post"><span id="like-post-icon">‚≠ê</span> <span id="like-post-count">${likes}</span> likes</button></span>
          <span>üí¨ ${comments.length} comments</span>
        </div>
        <div class="prose prose-lg max-w-none text-gray-900 mb-6">${content}</div>
        <div class="border-t pt-5 text-green-700 font-bold text-center">You earned 2 points for reading!</div>
      `;

      // Like post button event
      document.getElementById("like-post-btn").addEventListener("click", async function(e) {
        e.preventDefault();
        if (localStorage.getItem(`liked-post-${postId}`)) return; // Prevent multiple likes
        const result = await likePost(postId);
        if (result && result.success) {
          document.getElementById("like-post-count").textContent = result.likes;
          localStorage.setItem(`liked-post-${postId}`, "1");
          this.classList.add("liked");
        }
      });
      // Mark as liked if user already liked
      if (localStorage.getItem(`liked-post-${postId}`)) {
        document.getElementById("like-post-btn").classList.add("liked");
      }

      // --- Author card
      if (authorId) {
        const authorData = await fetchUserInfo(authorId);
        if (authorData && (authorData.fullname || authorData.username)) {
          document.getElementById("authorCard").classList.remove("hidden");
          document.getElementById("authorName").textContent = authorData.fullname || authorData.username || "Anonymous";
          document.getElementById("authorDept").textContent = (authorData.department ? authorData.department + " Dept" : "") + (authorData.faculty ? ", " + authorData.faculty : "");
          document.getElementById("authorBio").textContent = authorData.bio || "";
          document.getElementById("authorAvatar").src = authorData.profilePic
            ? (authorData.profilePic.startsWith("http") ? authorData.profilePic : (authorData.profilePic))
            : `https://ui-avatars.com/api/?name=${encodeURIComponent(authorData.fullname || authorData.username || "Author")}&background=ffda00&color=263159&rounded=true`;
        }
      }

      // --- Render comments
      renderComments(comments);

      // --- Comments submit handler
      document.getElementById("commentForm").onsubmit = async function(e) {
        e.preventDefault();
        const name = document.getElementById("commentName").value.trim() || "Anonymous";
        const text = document.getElementById("commentText").value.trim();
        if (!text) return;
        const userId = null;
        const ok = await addCommentToBackend(postId, userId, name, text, null);
        if (ok) {
          allPosts = await fetchAllPosts();
          mainPost = allPosts.find(p => p._id === postId);
          renderComments(mainPost && Array.isArray(mainPost.comments) ? mainPost.comments : []);
          this.reset();
        } else {
          alert("Failed to add comment. Please try again.");
        }
      };

      // --- Related posts (same category, exclude main post). Fallback: recent other posts.
      let related = allPosts.filter(p => p._id !== postId && (p.category === category));
      if (related.length < 2) {
        related = allPosts.filter(p => p._id !== postId).slice(0, 4);
      } else {
        related = related.slice(0, 4);
      }

      // --- Render related posts
      const relatedGrid = document.getElementById('relatedPosts');
      if (related.length === 0) {
        relatedGrid.innerHTML = `<div class="text-gray-400">No related posts found.</div>`;
      } else {
        relatedGrid.innerHTML = related.map(blog => `
          <a href="blog-details.html?id=${blog._id}" class="block bg-white rounded-xl shadow hover:shadow-xl overflow-hidden transition group">
            <div class="w-full overflow-hidden" style="max-width: 100%;">
              <img src="${blog.imageUrl || "https://images.unsplash.com/photo-1503676382389-4809596d5290?auto=format&fit=crop&w=400&q=80"}"
                alt="${blog.title}" class="h-36 w-full object-cover object-center group-hover:scale-105 transition" style="display:block;"/>
            </div>
            <div class="p-4">
              <h3 class="font-bold text-blue-900 text-lg mb-1 line-clamp-2">${blog.title}</h3>
              <div class="flex items-center text-yellow-500 text-base font-bold mb-1">${blog.category || "General"}</div>
              <div class="text-xs text-gray-400 mb-2">${blog.authorName || "Anonymous"} ‚Ä¢ ${blog.date ? new Date(blog.date).toLocaleDateString() : ""}</div>
              <p class="text-gray-600 mb-2 line-clamp-2">${blog.content ? blog.content.substring(0, 80) + "..." : ""}</p>
              <div class="flex gap-2 text-xs text-gray-400">
                <span>üëÅÔ∏è ${blog.views ?? 0}</span>
                <span>‚≠ê ${blog.likes ?? 0}</span>
                <span>üí¨ ${Array.isArray(blog.comments) ? blog.comments.length : 0}</span>
              </div>
            </div>
          </a>
        `).join('');
      }
    })();

    // --- Render comments utility with like and reply
    function renderComments(comments) {
      const list = document.getElementById("commentsList");
      if (!Array.isArray(comments) || comments.length === 0) {
        list.innerHTML = `<div class="text-gray-400 italic">No comments yet. Be the first to comment!</div>`;
        return;
      }
      // Sort by most recent
      comments = [...comments].sort((a, b) => new Date(b.date) - new Date(a.date));
      list.innerHTML = comments.map(comment => renderCommentHTML(comment, 0)).join('');
      // Add like and reply event listeners for all comments/replies
      addCommentEvents();
    }

    // Recursive HTML renderer for comments with replies
    function renderCommentHTML(comment, depth) {
      if (!comment) return "";
      const date = comment.date ? new Date(comment.date).toLocaleString() : '';
      const likeKey = `liked-comment-${postId}-${comment._id}`;
      const liked = localStorage.getItem(likeKey) ? "liked" : "";
      let html = `
        <div class="comment-bubble${depth > 0 ? ' reply-bubble' : ''}" data-comment-id="${comment._id}">
          <div>
            <span class="comment-author">${comment.name || 'Anonymous'}</span>
            <span class="comment-date ml-2">${date}</span>
          </div>
          <div class="mt-1 mb-1">${comment.text}</div>
          <div class="comment-actions">
            <button class="like-btn ${liked}" data-like-comment-id="${comment._id}" aria-label="Like comment">
              <span>üëç</span> <span class="like-count">${comment.likes || 0}</span>
            </button>
            <button class="reply-btn" data-reply-comment-id="${comment._id}">Reply</button>
          </div>
          <form class="reply-form hidden" data-reply-form-for="${comment._id}">
            <input type="text" class="reply-name px-2 py-1 border rounded text-sm w-1/4 mb-1" placeholder="Your name" />
            <input type="text" class="reply-text px-2 py-1 border rounded text-sm flex-1 mb-1" placeholder="Write a reply..." required />
            <button type="submit" class="bg-yellow-400 text-blue-900 py-1 px-4 rounded text-sm font-bold hover:bg-blue-900 hover:text-yellow-400 transition">Reply</button>
          </form>
          ${Array.isArray(comment.replies) && comment.replies.length ? 
            comment.replies.sort((a,b) => new Date(b.date)-new Date(a.date)).map(r => renderCommentHTML(r, depth+1)).join('') : ''}
        </div>
      `;
      return html;
    }

    // Setup like/reply events for all comments/replies
    function addCommentEvents() {
      // Like comment
      document.querySelectorAll('.like-btn[data-like-comment-id]').forEach(btn => {
        const commentId = btn.getAttribute('data-like-comment-id');
        const likeKey = `liked-comment-${postId}-${commentId}`;
        btn.onclick = async function(e) {
          e.preventDefault();
          if (localStorage.getItem(likeKey)) return;
          const result = await likeComment(postId, commentId);
          if (result && result.success) {
            btn.querySelector('.like-count').textContent = result.likes;
            btn.classList.add("liked");
            localStorage.setItem(likeKey, "1");
          }
        };
      });
      // Reply button: toggle reply form
      document.querySelectorAll('.reply-btn[data-reply-comment-id]').forEach(btn => {
        const commentId = btn.getAttribute('data-reply-comment-id');
        btn.onclick = function(e) {
          e.preventDefault();
          document.querySelectorAll(`form.reply-form`).forEach(f => f.classList.add('hidden'));
          const form = document.querySelector(`form[data-reply-form-for="${commentId}"]`);
          if (form) form.classList.remove('hidden');
        };
      });
      // Reply form submit
      document.querySelectorAll('form.reply-form').forEach(form => {
        form.onsubmit = async function(e) {
          e.preventDefault();
          const commentId = form.getAttribute('data-reply-form-for');
          const name = form.querySelector('.reply-name').value.trim() || "Anonymous";
          const text = form.querySelector('.reply-text').value.trim();
          if (!text) return;
          const ok = await addCommentToBackend(postId, null, name, text, commentId);
          if (ok) {
            // Refetch and rerender
            allPosts = await fetchAllPosts();
            mainPost = allPosts.find(p => p._id === postId);
            renderComments(mainPost && Array.isArray(mainPost.comments) ? mainPost.comments : []);
          } else {
            alert("Failed to add reply. Please try again.");
          }
        };
      });
      // Hide reply forms on click elsewhere
      document.body.addEventListener("click", function(e){
        if (!e.target.classList.contains("reply-btn")) {
          document.querySelectorAll(`form.reply-form`).forEach(f => f.classList.add('hidden'));
        }
      }, {capture: true});
    }
  </script>
</body>
</html>
