<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=0.80">
    <title>Student Dashboard | EduHub</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- PDF.js for PDF extraction -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.2.67/pdf.min.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
<!-- mammoth.js for DOCX extraction -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.0.0-beta.10/mammoth.browser.min.js"></script>
<!-- Flowbite CDN (if not already present) -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/flowbite/2.3.0/flowbite.min.js"></script>
<!-- Tesseract.js for client-side OCR on images (optional but recommended for image-to-text support) -->
<script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.js"></script>
    <link rel="icon" href="logo.png">
    <style>
    
    .chatbot-fade-in { animation: fadeIn 0.3s ease; }
    @keyframes fadeIn { from { opacity: 0; transform: scale(0.96);} to {opacity:1; transform: scale(1);} }
    .chatbot-message-bot {
      background: linear-gradient(90deg, #dbeafe 60%, #e0e7ff 100%);
      color: #1e3a8a;
      align-self: flex-start;
    }
    .chatbot-message-user {
      background: linear-gradient(90deg, #facc15 60%, #fde68a 100%);
      color: #7c5702;
      align-self: flex-end;
    }
    .chatbot-message-img {
      max-width: 140px;
      max-height: 160px;
      border-radius: 0.7em;
      object-fit: cover;
      margin-top: 0.25rem;
      margin-bottom: 0.25rem;
      box-shadow: 0 2px 8px #0001;
      border: 2px solid #e0e7ff;
    }
    .chatbot-scroll::-webkit-scrollbar {
      width: 5px;
      background: #f3f4f6;
    }
    .chatbot-scroll::-webkit-scrollbar-thumb {
      background: #d1d5db;
      border-radius: 8px;
    }
    .chatbot-scroll { scrollbar-width: thin; scrollbar-color: #d1d5db #f3f4f6; }
    #chatbotFile { display: none; }
    .chatbot-file-label {
      display: flex;
      align-items: center;
      padding: 0.5rem 0.75rem;
      border-radius: 9999px;
      background: #f1f5f9;
      color: #1e3a8a;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      margin-right: 0.5rem;
      transition: background 0.2s;
    }
    .chatbot-file-label:hover { background: #e0e7ff; }
    .chat-link-row {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5em;
      margin-top: 1.1em;
    }
    .chat-link-btn {
      display: inline-block;
      padding: 0.47em 1.2em;
      color: #fff !important;
      background: #2563eb;
      border-radius: 9999px;
      font-weight: 600;
      font-size: 1em;
      text-decoration: none;
      box-shadow: 0 2px 8px #1e40af22;
      transition: background 0.2s, color 0.2s;
      margin: 0;
    }
    .chat-link-btn:hover, .chat-link-btn:focus { background: #facc15; color: #1e3a8a !important; }
    .gemini-typing::after {
      content: '';
      display: inline-block;
      width: 1em;
      height: 1em;
      border-radius: 50%;
      background: #2563eb;
      animation: blink 1s infinite;
      vertical-align: middle;
      margin-left: .35em;
    }
    @keyframes blink { 50% { opacity: 0.3; } }
  
#studyCalendar .fc {
  font-size: 1rem;
}
#studyCalendar .fc-toolbar-title {
  font-size: 1.2rem;
}

.verse-bg {
  background: linear-gradient(135deg, #e0e7ff 0%, #f3f4f6 100%);
  min-height: 120px;
  position: relative;
}
.verse-bg img {
  /* Example image styling */
  filter: blur(1px) brightness(0.85);
}
#verseBox .text-indigo-900, #verseBox .text-indigo-700 {
  /* Ensures text stands out on image */
  text-shadow: 0 2px 6px #fff8, 0 1px 3px #0002;
        }        
#studyCalendar .fc-button {
  padding: 0.3em 0.7em;
  font-size: 0.98em;
  border-radius: 6px;
  background: #6366f1; /* Indigo */
  color: #fff;
  border: none;
}
#studyCalendar .fc-button.fc-button-primary:not(:disabled):hover {
  background: #4338ca;
}
#studyCalendar .fc-button.fc-button-primary:disabled {
  background: #ddd;
  color: #888;
}
#studyCalendar .fc-toolbar {
  flex-wrap: wrap;
  gap: 0.5em;
}
@media (max-width: 600px) {
  #studyCalendar {
    font-size: 0.93rem;
  }
  #studyCalendar .fc-toolbar-title {
    font-size: 1rem;
  }
}
        #quoteBox .zoom-in {
  animation: quoteZoomIn 0.5s;
}
#quoteBox .zoom-out {
  animation: quoteZoomOut 0.5s;
}
@keyframes quoteZoomIn {
  from { transform: scale(0.7); opacity:0; }
  to   { transform: scale(1);   opacity:1; }
}
@keyframes quoteZoomOut {
  from { transform: scale(1);   opacity:1; }
  to   { transform: scale(0.7); opacity:0; }
        }
        .sidebar {
            transition: transform 0.3s ease-in-out, background 0.3s ease;
            background: linear-gradient(180deg, #1e3a8a, #3b82f6);
            z-index: 50;
        }
        .sidebar.open {
            transform: translateX(0);
        }
        .card {
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.15);
        }
        .progress-circle {
            background: conic-gradient(#22c55e 0% var(--progress), #e5e7eb 0% 100%);
            transition: all 0.5s ease;
        }
        .progress-circle:hover {
            transform: scale(1.1);
        }
        .glow-button {
            position: relative;
            overflow: hidden;
        }
        .glow-button::after {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            transition: 0.5s;
        }
        .glow-button:hover::after {
            left: 100%;
        }
        .bg-gradient {
            background: linear-gradient(135deg, #f3f4f6 0%, #e0e7ff 100%);
        }
        .tab-content {
            display: none;
            animation: fadeIn 0.5s ease-in-out;
        }
        .tab-content.active {
            display: block;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .modal {
            transition: opacity 0.3s ease, transform 0.3s ease;
            transform: translateY(-50px);
            opacity: 0;
            pointer-events: none;
        }
        .modal.open {
            transform: translateY(0);
            opacity: 1;
            pointer-events: auto;
        }
        .modal-overlay {
            transition: opacity 0.3s ease;
            opacity: 0;
            pointer-events: none;
        }
        .modal-overlay.open {
            opacity: 1;
            pointer-events: auto;
        }
        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-100%);
            }
            .sidebar.open {
                transform: translateX(0);
            }
        }
        .focus-trap {
            outline: 2px solid #6366f1;
        }
        /* Custom styles for tables and leaderboard */
        .result-table, .test-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            background: #fff;
            border-radius: 14px;
            overflow: hidden;
            box-shadow: 0 2px 16px #3a86ff18;
            margin: 14px 0 22px 0;
            font-size: 1.06rem;
        }
        .result-table thead tr, .test-table thead tr {
            background: indigo;
            color: #fff;
            font-weight: 700;
            letter-spacing: 0.5px;
        }
        @media (min-width: 768px) {
  main {
    margin-left: 18rem; /* Sidebar width */
    padding-left: 16px; /* This is the gap */
  }
}
        .result-table th, .result-table td,
        .test-table th, .test-table td {
            padding: 11px 14px;
            text-align: left;
            border-bottom: 1px solid #e3e8ee;
        }
        .result-table th:last-child, .result-table td:last-child,
        .test-table th:last-child, .test-table td:last-child {
            text-align: center;
        }
        .result-table tbody tr, .test-table tbody tr {
            transition: background 0.18s;
        }
        .result-table tbody tr:nth-child(even),
        .test-table tbody tr:nth-child(even) {
            background: #f7faff;
        }
        .result-table tbody tr:hover,
        .test-table tbody tr:hover {
            background: #e3f0ff;
        }
        .result-table td, .test-table td {
            color: #23366e;
        }
        .result-table th:first-child, .result-table td:first-child,
        .test-table th:first-child, .test-table td:first-child {
            border-top-left-radius: 12px;
        }
        .result-table th:last-child, .result-table td:last-child,
        .test-table th:last-child, .test-table td:last-child {
            border-top-right-radius: 12px;
        }
        .table-pagination {
            text-align: center;
            margin: 12px 0 0 0;
            user-select: none;
        }
        .table-pagination button {
            margin: 0 5px;
            padding: 4px 13px;
            font-size: 1em;
            background: #f7faff;
            color: #3a86ff;
            border: 1px solid #3a86ff44;
            border-radius: 7px;
            cursor: pointer;
            transition: background 0.13s;
        }
        .table-pagination button.active,
        .table-pagination button:hover {
            background: #3a86ff;
            color: #fff;
        }
        .table-pagination button[disabled] {
            opacity: 0.6;
            cursor: not-allowed;
            background: #e3e8ee !important;
            color: #888 !important;
        }
        .scoreboard-container {
            background: #fff;
            border-radius: 18px;
            box-shadow: 0 2px 18px #3a86ff18;
            padding: 24px 0 18px 0;
            margin: 28px auto 18px auto;
            max-width: 440px;
        }
        .scoreboard-title {
            text-align: center;
            font-size: 1.25rem;
            font-weight: bold;
            color: #23366e;
            margin-bottom: 10px;
            letter-spacing: 0.5px;
        }
        .scoreboard-list {
            display: flex;
            justify-content: space-around;
            align-items: flex-end;
            gap: 16px;
        }
        .scoreboard-item {
            background: #f7faff;
            border-radius: 14px;
            padding: 10px 16px;
            text-align: center;
            box-shadow: 0 2px 8px #3a86ff11;
            min-width: 90px;
            position: relative;
        }
        .scoreboard-avatar {
            width: 48px; height: 48px; border-radius: 50%; object-fit: cover; margin-bottom: 4px;
            border: 2px solid #3a86ff33;
        }
        .scoreboard-name { font-size: 1.07em; font-weight: 600; color: #23366e;}
        .scoreboard-score { font-size: 1.01em; color: #455c8a; margin-top: 3px;}
        .scoreboard-badge { display: inline-block; font-size: 1.36em; margin-top: 6px; }
        .badge-rank-1 { color: #f7b500; }
        .badge-rank-2 { color: #a8b0b8; }
        .badge-rank-3 { color: #c47c39; }
        /* Responsive */
        @media (max-width: 800px) {
            .result-table, .test-table {
                font-size: 0.99rem;
                min-width: 390px;
                width: 100%;
                display: block;
                overflow-x: auto;
            }
            .scoreboard-container {
                max-width: 99vw;
                padding: 10px 0 10px 0;
            }
        }
        /* Loader style */
        #preloaderSpinner {
            position:fixed;z-index:99999;top:0;left:0;width:100vw;height:100vh;
            background:rgba(255,255,255,0.97);display:flex;align-items:center;justify-content:center;
            transition:opacity 0.3s;
        }
        #preloaderSpinner .spinner {
            display:inline-block;width:80px;height:80px;border:8px solid #e3e8ee;
            border-top:8px solid #3a86ff;border-radius:50%;animation:spin 1s linear infinite;
        }
        @keyframes spin { 100% { transform: rotate(360deg); } }

        /* Modal Backdrop for new modals */
        .modal-backdrop {
            position: fixed;
            inset: 0;
            z-index: 99999;
            background: rgba(33, 37, 41, 0.29);
            display: none;
            align-items: center;
            justify-content: center;
        }
        .modal-backdrop[style*="display: flex"] {
            display: flex !important;
        }
        
        .close-modal {
            background: none;
            border: none;
            color: #3a86ff;
            font-size: 1.5em;
            cursor: pointer;
            position: absolute;
            right: 0.8em;
            top: 0.65em;
        }
        #verseBox.zoom-in {
  animation: quoteZoomIn 0.5s;
}
#verseBox.zoom-out {
  animation: quoteZoomOut 0.5s;
        }
        .modal-backdrop {
  position: fixed;
  inset: 0;
  z-index: 99999;
  background: rgba(33, 37, 41, 0.29);
  display: none;
  align-items: center;      /* Vertical center */
  justify-content: center;  /* Horizontal center */
}
.modal-backdrop[style*="display: flex"] {
  display: flex !important;
}
.modal {
  background: #fff;
  padding: 2em 1.5em 1.5em 1.5em;
  border-radius: 16px;
  box-shadow: 0 8px 32px #0003;
  min-width: 320px;
  max-width: 95vw;
  max-height: 90vh;
  overflow-y: auto;
  position: relative;
  opacity: 1;
  pointer-events: all;
  display: flex;
  flex-direction: column;
  justify-content: flex-start;
}
@media (max-width: 600px) {
  .modal {
    min-width: unset;
    max-width: 99vw;
    padding: 1em 0.5em;
  }
}
    </style>
</head>
<body class="bg-gradient font-sans min-h-screen">

    <!-- Loader -->
    <div id="preloaderSpinner">
      <div style="text-align:center;">
        <div class="spinner"></div>
        <div style="margin-top:18px;color:#3a86ff;font-weight:700;font-size:1.3em;">Loading dashboard...</div>
      </div>
    </div>
<!-- Welcome Modal -->
<div id="welcomeModal" class="fixed inset-0 z-[12] flex items-center justify-center bg-black bg-opacity-40 transition-opacity" style="display:none;">
  <div class="relative bg-white rounded-3xl shadow-2xl px-7 py-8 max-w-md w-full border-2 border-indigo-100 animate-[fadeIn_0.4s]">
    <!-- SVG Placeholder -->
    <div class="flex justify-center -mt-12 mb-4">
      <img src="image%3A32352" alt="Welcome SVG" class="w-25 h-25 rounded-full object-contain shadow bg-white-50 p-2" />
    </div>
    <div class="text-center mt-2">
      <h2 class="text-2xl font-semibold text-indigo-800 mb-2" style="font-family: 'Segoe Script', cursive;">OAU ExamGuard</h2>
      <div class="text-gray-700 text-base leading-relaxed mb-3">
        Welcome to your official student dashboard.<br>
        All major activities will be carried out here.<br>
        Do well to check out the navigations and familiarize yourself with the dashboard.<br>
        You are expected to update your details by clicking on the menu icon at the top left corner, locate the profile settings tab and update your profile.
      </div>
    </div>
    <button id="closeWelcomeModal" aria-label="Close Welcome Modal"
      class="absolute top-3 right-3 text-indigo-400 hover:text-indigo-700 transition-colors text-2xl font-bold bg-indigo-50 rounded-full w-8 h-8 flex items-center justify-center shadow-sm focus:outline-none">
      &times;
    </button>
  </div>
</div>
<script>
  // Show the modal on dashboard load (or after login)
  window.addEventListener('DOMContentLoaded', function() {
    if (!localStorage.getItem('welcomeModalDismissed')) {
      document.getElementById('welcomeModal').style.display = 'flex';
    }
    document.getElementById('closeWelcomeModal').onclick = function() {
      document.getElementById('welcomeModal').style.display = 'none';
      localStorage.setItem('welcomeModalDismissed', '1');
    };
    // Optional: close modal on outside click
    document.getElementById('welcomeModal').addEventListener('click', function(e) {
      if (e.target === this) {
        this.style.display = 'none';
        localStorage.setItem('welcomeModalDismissed', '1');
      }
    });
  });
</script>
<style>
@keyframes fadeIn {
  from { opacity: 0; transform: translateY(30px);}
  to { opacity: 1; transform: translateY(0);}
}
</style>
    <!-- Mobile Menu Button -->
    <button id="menu-toggle" class="md:hidden fixed top-4 left-4 z-50 p-3 bg-indigo-600 text-white rounded-full shadow-lg hover:bg-indigo-700" aria-label="Open Menu">
        <i class="fas fa-bars text-lg"></i>
    </button>
<div class="flex min-h-screen">
    <!-- Sidebar -->
    <aside
      id="sidebar"
class="sidebar fixed top-0 left-0 h-screen w-72 bg-blue-900 text-white p-8 md:block md:translate-x-0 shadow-2xl z-50"
    aria-label="Sidebar Navigation">
       <div class="mb-10">
            <h1 class="text-3xl font-extrabold tracking-tight">OAU ExamGuard</h1>
            <p class="text-sm text-blue-200">Student Dashboard</p>
        </div>
        <nav>
            <ul class="space-y-6">
                <li><a href="#dashboard" class="nav-link flex items-center space-x-3 text-lg hover:text-blue-200 transition-colors" data-tab="dashboard"><i class="fas fa-home"></i><span>Dashboard</span></a></li>
                <li><a href="#mock-tests" class="nav-link flex items-center space-x-3 text-lg hover:text-blue-200 transition-colors" data-tab="mock-tests"><i class="fas fa-file-alt"></i><span>Mock Tests</span></a></li>
                <li><a href="#past-questions" class="nav-link flex items-center space-x-3 text-lg hover:text-blue-200 transition-colors" data-tab="past-questions"><i class="fas fa-file-alt"></i><span>Past Questions and Answers</span></a></li>
                <!-- Tasks Center Tab in Sidebar Navigation -->
<li>
  <a href="#tasks-center"
     class="nav-link flex items-center space-x-3 text-lg hover:text-blue-200 transition-colors"
     data-tab="tasks-center">
    <i class="fas fa-tasks"></i>
    <span>Tasks Center</span>
  </a>
</li>
                <li><a href="#study-resources" class="nav-link flex items-center space-x-3 text-lg hover:text-blue-200 transition-colors" data-tab="study-resources"><i class="fas fa-book"></i><span>Study Resources</span></a></li>
                <li><a href="#messages" class="nav-link flex items-center space-x-3 text-lg hover:text-blue-200 transition-colors" data-tab="messages"><i class="fas fa-envelope"></i><span>Messages</span></a></li>
                <li><a href="#profile-settings" class="nav-link flex items-center space-x-3 text-lg hover:text-blue-200 transition-colors" data-tab="profile-settings"><i class="fas fa-user"></i><span>Profile Settings</span></a></li>
                <li><a href="#assignments" class="nav-link flex items-center space-x-3 text-lg hover:text-blue-200 transition-colors" data-tab="assignments"><i class="fas fa-file-alt"></i><span>Assignment Submission</span></a></li>
                <li><a href="#studypadi" class="nav-link flex items-center space-x-3 text-lg hover:text-blue-200 transition-colors" data-tab="studypadi"><i class="fas fa-file-alt"></i><span>My StudyPadi</span></a></li>
                
                <li>
                  <a href="#" onclick="openBroadcastModal()" class="nav-link flex items-center space-x-3 text-lg hover:text-blue-200 transition-colors">
                    <i class="fas fa-bullhorn"></i>
                    <span>Broadcasts</span>
                  </a>
                </li>
                <li><a href="#logout" class="nav-link flex items-center space-x-3 text-lg hover:text-blue-200 transition-colors" data-tab="logout"><i class="fas fa-sign-out-alt"></i><span>Logout</span></a></li>
                
            </ul>
        </nav>
    </aside>

    <!-- Sidebar overlay for mobile -->
    <div id="sidebar-overlay" class="fixed inset-0 bg-black bg-opacity-40 z-40 hidden md:hidden"></div>

    <!-- Main Content -->
   
 <main class="main-gap max-w-7xl mx-auto p-4 md:ml-72 md:p-8 lg:p-12 min-h-screen">
        <!-- Dashboard Tab -->
        <section id="dashboard" class="tab-content active">
            <header class="bg-white rounded-2xl shadow-xl p-8 mb-8 card flex items-center justify-between relative">
  <div class="flex items-center gap-6">
    <img id="studentProfilePic" src="" alt="Profile" class="rounded-full border-4 border-indigo-100 shadow" style="width:80px;height:80px;object-fit:cover;">
    <div>
      <h2 id="greetingHeader" class="text-3xl font-bold text-indigo-900 mb-1"></h2>
      <div id="quoteBox" class="mt-2">
        <div id="motivationalQuote" class="text-gray-600 text-lg font-medium transition-transform duration-500"></div>
        <div id="quoteAuthor" class="text-indigo-700 text-base font-semibold mt-1 transition-transform duration-500"></div>
      </div>
    </div>
  </div>
  <div id="greetingTimeIcon" class="absolute top-6 right-8 text-3xl" title="Time of Day"></div>
    </header>
            <!-- Add just below motivational quotes in dashboard section -->
<!-- Religious Verse Placeholder - styled box with image background -->
<div id="verseBox" class="relative flex items-center justify-center rounded-2xl shadow-lg p-6 my-4 overflow-hidden verse-bg">
  <img src="image%3A55534" alt="OAU ExamGuard" class="absolute inset-0 w-full h-full object-cover opacity-40 pointer-events-none rounded-2xl" />
  <div class="relative z-10 w-full text-center flex flex-col items-center justify-center">
    <div id="verseText" class="text-indigo-900 font-bold text-lg md:text-xl lg:text-2xl mb-2" style="text-shadow: 0 2px 8px #fff8;">
      <!-- Verse text goes here -->
    </div>
    <div id="verseRef" class="text-indigo-700 text-base md:text-lg font-medium" style="text-shadow: 0 1px 6px #fff5;">
      <!-- Reference goes here -->
    </div>
  </div>
</div>
   
            <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-4 gap-8">
                <!-- Profile Card -->
                <section class="bg-white rounded-2xl shadow-xl p-6 card">
                    <h3 class="text-xl font-semibold text-indigo-900 mb-4">Student Details</h3>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div class="space-y-2">
                            <p><strong>Name:</strong> <span id="profileName"></span></p>
                            <p><strong>Student ID:</strong> <span id="studentId"></span></p>
                            <p><strong>Department:</strong> <span id="profileDept"></span></p>
                        </div>
                        <div class="space-y-2">
                            <p><strong>Year:</strong> <span id="studentLevel"></span></p>
                            <p><strong>Email:</strong> <span id="profileEmail"></span></p>
                            <p><strong>Phone:</strong> <span id="profilePhone"></span></p>
                        </div>
                    </div>
                </section>
                <!-- Progress Tracker Card -->
                <section class="bg-white rounded-2xl shadow-xl p-6 card">
                    <h3 class="text-xl font-semibold text-indigo-900 mb-4">Progress Tracker</h3>
                    <div id="progress-circles" class="grid grid-cols-2 gap-4"></div>
                </section>
                <!-- Announcements Card -->
                <section class="bg-white rounded-2xl shadow-xl p-6 card">
                    <h3 class="text-xl font-semibold text-indigo-900 mb-4">Announcements</h3>
                    <div id="announcementsPanel" class="space-y-4"></div>
                </section>
                <!-- Quick Access Card -->
                <section class="bg-white rounded-2xl shadow-xl p-6 card">
                    <h3 class="text-xl font-semibold text-indigo-900 mb-4">Quick Access</h3>
                    <div class="space-y-6">
                        <div>
                            <p class="font-medium text-gray-700">Marketplace</p>
                            <p class="text-gray-600 text-sm">Explore study materials and student essentials.</p>
                            <button class="mt-2 px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 glow-button" onclick="window.open('gen-marketplace.html', '_blank')">Visit Marketplace</button>
                        </div>
                        <div>
                            <p class="font-medium text-gray-700">Blog Home</p>
                            <p class="text-gray-600 text-sm">Read tips, tricks, and student stories.</p>
                            <button class="mt-2 px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 glow-button" onclick="window.open('blog-notes-category', '_blank')">Visit Blog</button>
                        </div>
                        <div>
                            <p class="font-medium text-gray-700">Earnings Dashboard</p>
                            <p class="text-gray-600 text-sm">Check out how many points and equivalent you've made so far.</p>
                            <button class="mt-2 px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 glow-button" onclick="window.open('earnings.html', '_blank')">Visit Earnings Page</button>
                        </div>
                    </div>
                    <div>
                            <p class="font-medium text-gray-700">Homepage</p>
                            <p class="text-gray-600 text-sm">Read tips, tricks, and student stories.</p>
                            <button class="mt-2 px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 glow-button" onclick="window.open('/', '_blank')">Visit Homepage</button>
                        </div>
                </section>
                <!-- Achievements (Leaderboard) Card -->
                <section class="bg-white rounded-2xl shadow-xl p-6 card col-span-1 xl:col-span-4">
                    <h3 class="text-xl font-semibold text-indigo-900 mb-4">Achievements & Leaderboard</h3>
                    <div id="leaderboardContainer" class="scoreboard-container"></div>
                </section>
            </div>
            <button id="chatbotToggleBtn"
    class="fixed z-40 bottom-8 right-4 flex items-center gap-2 bg-blue-700 text-white px-5 py-3 rounded-full shadow-lg hover:bg-yellow-400 hover:text-blue-900 transition text-lg font-bold focus:outline-none">
    <svg class="w-7 h-7 mr-1" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" d="M17 8h2a2 2 0 0 1 2 2v10a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V10a2 2 0 0 1 2-2h2"/>
      <path stroke-linecap="round" stroke-linejoin="round" d="M15 3H9a2 2 0 0 0-2 2v2h10V5a2 2 0 0 0-2-2z"/>
    </svg>
    Support
  </button>

  <!-- Chat Modal -->
  <div id="chatbotModal"
    class="hidden fixed inset-0 z-50 flex items-end sm:items-center justify-center bg-black/30">
    <div
      class="chatbot-fade-in bg-white rounded-xl shadow-2xl w-[97vw] max-w-xs sm:max-w-sm md:max-w-sm lg:max-w-xs relative flex flex-col mb-4"
      style="min-width: 320px; max-width: 350px; min-height: 440px; max-height: 590px;">
      <!-- Modal Header -->
      <div class="flex items-center justify-between px-5 py-4 border-b border-blue-100 bg-blue-700 rounded-t-xl">
        <div class="flex items-center gap-2">
          <img src="https://cdn-icons-png.flaticon.com/512/2282/2282759.png" class="w-8 h-8 rounded-full" alt="ExamGuard Support">
          <span class="font-bold text-lg text-white">ExamGuard Support</span>
        </div>
        <button id="chatbotCloseBtn" class="text-white hover:text-yellow-400 focus:outline-none">
          <svg class="w-7 h-7" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"/>
          </svg>
        </button>
      </div>
      <!-- Modal Body: Messages -->
      <div id="chatbotMessages" class="flex-1 p-5 overflow-y-auto chatbot-scroll bg-blue-50" style="min-height:360px; max-height:440px;">
      </div>
      <!-- Modal Footer: Input -->
      <div class="px-4 py-3 border-t border-blue-100 bg-white rounded-b-xl">
        <form id="chatbotForm" class="flex gap-2 items-center">
          <label for="chatbotFile" class="chatbot-file-label" title="Send Image">
            <svg class="w-6 h-6 text-blue-800" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
              <path d="M15.172 7l-6.586 6.586a2 2 0 102.828 2.828l6.586-6.586a2 2 0 10-2.828-2.828z"/>
              <path d="M16 5l3 3"/>
            </svg>
            <input type="file" id="chatbotFile" accept="image/*">
          </label>
          <input id="chatbotInput" type="text" autocomplete="off" placeholder="Type your question..."
            class="flex-1 w-4 px-4 py-2 rounded-full border border-blue-200 focus:ring-2 focus:ring-blue-500 outline-none text-blue-900 bg-blue-50" required />
          <button type="submit"
            class="bg-yellow-400 text-blue-900 font-bold px-4 py-2 rounded-full shadow hover:bg-blue-700 hover:text-white transition">Send</button>
        </form>
      </div>
    </div>
  </div>
        </section>

        <!-- Mock Tests Tab -->
        <section id="mock-tests" class="tab-content">
            <header class="bg-white rounded-2xl shadow-xl p-8 mb-8 card flex justify-between items-center">
                <div>
                  <h2 class="text-3xl font-bold text-indigo-900">Mock Tests</h2>
                  <p class="text-gray-600 mt-2"><b>Kindly update your profile through the Profile Setting Tab if you're unable to see scheduled mocks</b></p>
                </div>
                <button onclick="openScheduledExamModal()" class="ml-4 px-3 py-1 bg-indigo-100 text-indigo-800 rounded hover:bg-indigo-200">View Scheduled Exam</button>
            </header>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div class="bg-white rounded-2xl shadow-xl p-6 card">
                    <h3 class="text-xl font-semibold text-indigo-900 mb-4">Assessment Performance & Reviews</h3>
                    <div class="overflow-x-auto w-full">
                      <table class="result-table w-full" id="historyTable">
                        <thead>
                          <tr>
                            <th>Test</th>
                            <th>Date</th>
                            <th>Score</th>
                            <th>Review</th>
                          </tr>
                        </thead>
                        <tbody></tbody>
                      </table>
                    </div>
                    <div id="historyPagination" class="table-pagination"></div>
                </div>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-2 gap-4">
                <!-- Available Mock Tests Table -->
                <section class="bg-white rounded-2xl shadow-xl p-6 card">
                    <h3 class="text-xl font-semibold text-indigo-900 mb-4">Available Mock Tests</h3>
                    <div id="testSpinner" style="display:none;text-align:center;padding:20px;">
                        <div style="display:inline-block;width:38px;height:38px;border:4px solid #e3e8ee;border-top:4px solid #3a86ff;border-radius:50%;animation:spin 1s linear infinite;"></div>
                    </div>
                    <div class="overflow-x-auto w-full">
                        <table class="test-table w-full" id="availableTable">
                            <thead>
                                <tr>
                                    <th>Test</th>
                                    <th>Description</th>
                                    <th>Start Time</th>
                                    <th>End Time</th>
                                    <th>Status</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                    <div id="availablePagination" class="table-pagination"></div>
                </section>
                <!-- Your Progress -->
                <section class="bg-white rounded-2xl shadow-xl p-6 card">
                    <h3 class="text-xl font-semibold text-indigo-900 mb-4">Your Progress</h3>
                    <div id="progressList" style="max-height:110px;overflow-y:auto;"></div>
                </section>
                <!-- Certificates -->
                <section class="bg-white rounded-2xl shadow-xl p-6 card">
                    <h3 class="text-xl font-semibold text-indigo-900 mb-4">Certificates</h3>
                    <button id="downloadCertBtn" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 glow-button">Download Certificate</button>
                    <div id="badgePanel"></div>
                </section>
                
                <!-- Recommendations -->
                <section class="bg-white rounded-2xl shadow-xl p-6 card">
                    <h3 class="text-xl font-semibold text-indigo-900 mb-4">Personalized Study Recommendations</h3>
                    <ul class="recommend-list" id="recommendations"></ul>
                </section>
            
            <!-- Upcoming Test Countdown -->
            <div class="bg-white rounded-2xl shadow-xl p-6 card mt-8">
                <h3 class="text-xl font-semibold text-indigo-900 mb-4">Upcoming Test</h3>
                <div class="card-value" id="upcomingTest">None</div>
                <div id="testCountdown" style="font-size:1.01rem; color:var(--primary);font-weight:600;"></div>
            </div>
            </div>
        </section>
        <section id="past-questions" class="tab-content">
    <header class="bg-white rounded-2xl shadow-xl p-8 mb-8 card flex justify-between items-center">
        <div>
            <h2 class="text-3xl font-bold text-indigo-900">Past Questions and Answers</h2>
            <p class="text-gray-600 mt-2">Master your exams with tailored past question practice sessions</p>
        </div>
        <button class="ml-4 px-3 py-1 bg-indigo-100 text-indigo-800 rounded hover:bg-indigo-200">Start New Practice</button>
    </header>
<div class="grid grid-cols-1 md:grid-cols-2 gap-4">
  <div class="bg-white rounded-2xl shadow-xl p-6 card">
    <h3 class="text-xl font-semibold text-indigo-900 mb-4">Configure Your Practice Session</h3>
    <form id="practice-config-form" class="practice-form grid grid-cols-1 sm:grid-cols-2 gap-4">
      <div class="form-group">
        <label for="subject" class="text-sm font-medium text-gray-700">Subject</label>
        <select id="subject" name="subject" required class="mt-1 block w-full p-2 border border-gray-300 rounded-lg">
          <option value="">Select Subject</option>
          <option value="Mathematics">Mathematics</option>
          <option value="Physics">Physics</option>
          <option value="Chemistry">Chemistry</option>
          <option value="Biology">Biology</option>
          <option value="Computer Science">Computer Science</option>
        </select>
      </div>
      <div class="form-group">
        <label for="courseCode" class="text-sm font-medium text-gray-700">Course Code</label>
        <select id="courseCode" name="courseCode" required class="mt-1 block w-full p-2 border border-gray-300 rounded-lg">
          <option value="">Select Course Code</option>
        </select>
      </div>
      <div class="form-group">
        <label for="year" class="text-sm font-medium text-gray-700">Year</label>
        <select id="year" name="year" required class="mt-1 block w-full p-2 border border-gray-300 rounded-lg">
          <option value="">Select Year</option>

          <option value="2024-2025">2024-2025</option>
          <option value="2023-2024">2023-2024</option>
          <option value="2022-2023">2022-2023</option>
        <option value="2021-2022">2021-2022</option>
          <option value="2020-2021">2020-2021</option>
          <option value="2019-2020">2019-2020</option>
          <option value="2018-2019">2018-2019</option>
          <option value="2017-2018">2017-2018</option>
        </select>
      </div>
      <div class="form-group">
        <label for="questions" class="text-sm font-medium text-gray-700">Total Questions</label>
        <select id="questions" name="count" required class="mt-1 block w-full p-2 border border-gray-300 rounded-lg">
          <option value="">Select Number of Questions</option>
          <option value="10">10</option>
          <option value="20">20</option>
          <option value="30">30</option>
          <option value="40">40</option>
          <option value="50">50</option>
        </select>
      </div>
      <div class="form-group">
        <label for="time" class="text-sm font-medium text-gray-700">Time (Minutes)</label>
        <select id="time" name="time" required class="mt-1 block w-full p-2 border border-gray-300 rounded-lg">
          <option value="">Select Time</option>
          <option value="30">30</option>
          <option value="40">40</option>
          <option value="60">60</option>
          <option value="90">90</option>
          <option value="120">120</option>
        </select>
      </div>
      <div class="form-group sm:col-span-2">
        <label for="topic" class="text-sm font-medium text-gray-700">Topic (optional)</label>
        <input id="topic" name="topic" type="text" class="mt-1 block w-full p-2 border border-gray-300 rounded-lg" placeholder="e.g., Algebra">
      </div>
      <button type="submit" class="mt-4 px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 glow-button sm:col-span-2">
        Start Practice
      </button>
    </form>
  </div>

        <div class="bg-white rounded-2xl shadow-xl p-6 card">
            <h3 class="text-xl font-semibold text-indigo-900 mb-4">Search Past Questions</h3>
            <input type="text" id="search-questions" class="block w-full p-2 border border-gray-300 rounded-lg" placeholder="Search by topic, subject, or year...">
        </div>
    </div>
    
</section>

<style>
    #past-questions {
        max-width: 100%;
        box-sizing: border-box;
    }

    .practice-form select, .practice-form input {
        max-width: 100%;
        font-size: 0.875rem;
    }

    .practice-form button {
        max-width: 200px;
        margin: 0 auto;
    }


    @media (max-width: 768px) {
        .practice-form {
            grid-template-columns: 1fr;
        }

        .practice-form button {
            max-width: 100%;
        }
    }
</style>

<!-- Tasks Center Section (add after other tab-content sections, before closing </main> or in the appropriate order) -->
<!-- Tasks Center Section (add after other tab-content sections, before closing </main> or in the appropriate order) -->
<section id="tasks-center" class="tab-content">
  <header class="bg-white rounded-2xl shadow-xl p-8 mb-8 card flex items-center justify-between">
    <div>
      <h2 class="text-3xl font-bold text-indigo-900 flex items-center gap-2">
        <i class="fas fa-tasks text-indigo-700"></i>
        Tasks Center
      </h2>
      <p class="text-gray-600 mt-2">Complete tasks to earn credit points and unlock new opportunities!</p>
    </div>
  </header>

  <!-- Dynamic Task Cards Container -->
  <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-8" id="task-cards-container">
    <!-- Task cards will be rendered here by JS -->
  </div>

  <!-- Task History Section -->
  <div class="mt-12">
    <h4 class="text-xl font-semibold mb-4 text-indigo-800">Task History</h4>
    <div class="overflow-x-auto">
      <table class="min-w-full bg-white border border-gray-200 rounded-lg shadow-sm text-sm">
        <thead class="bg-indigo-50">
          <tr>
            <th class="px-4 py-2 text-left font-bold text-indigo-900">Task</th>
            <th class="px-4 py-2 text-left font-bold text-indigo-900">Status</th>
            <th class="px-4 py-2 text-left font-bold text-indigo-900">Points</th>
            <th class="px-4 py-2 text-left font-bold text-indigo-900">Completed On</th>
          </tr>
        </thead>
        <tbody id="task-history-body">
          <!-- Dynamically populated -->
        </tbody>
      </table>
    </div>
  </div>
</section>




<section id="assignments" class="tab-content">
    <header class="bg-white rounded-2xl shadow-xl p-8 mb-8 card flex items-center justify-between">
        <div>
            <h2 class="text-3xl font-bold text-indigo-900">Assignments</h2>
            <p class="text-gray-600 mt-2">Submit your assignments and review submission history</p>
        </div>
    </header>
    <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
        <!-- Submit Assignment Card -->
        <section class="bg-white rounded-2xl shadow-xl p-6 card">
            <h3 class="text-xl font-semibold text-indigo-900 mb-4">Submit Assignment</h3>
            <div class="space-y-4">
                <div>
                    <label for="assignmentWeekDay" class="block text-sm font-medium text-gray-700">Week</label>
                    <select id="assignmentWeekDay" class="mt-1 p-2 border rounded w-full bg-gray-50 text-gray-900" aria-label="Select assignment week and day">
                        <option value="">Select Week & Day</option>
                        <option value="week1-day1">Week 1 (Day 1)</option>
                        <option value="week1-day2">Week 1 (Day 2)</option>
                        <option value="week1-day3">Week 1 (Day 3)</option>
                        <option value="week2-day1">Week 2 (Day 1)</option>
                        <option value="week2-day2">Week 2 (Day 2)</option>
                        <option value="week2-day3">Week 2 (Day 3)</option>
                        <option value="week3-day1">Week 3 (Day 1)</option>
                        <option value="week3-day2">Week 3 (Day 2)</option>
                        <option value="week3-day3">Week 3 (Day 3)</option>
                        <option value="week4-day1">Week 4 (Day 1)</option>
                        <option value="week4-day2">Week 4 (Day 2)</option>
                        <option value="week4-day3">Week 4 (Day 3)</option>
                        <option value="week5-day1">Week 5 (Day 1)</option>
                        <option value="week5-day2">Week 5 (Day 2)</option>
                        <option value="week5-day3">Week 5 (Day 3)</option>
                        <option value="week6-day1">Week 6 (Day 1)</option>
                        <option value="week6-day2">Week 6 (Day 2)</option>
                        <option value="week6-day3">Week 6 (Day 3)</option>
                        <option value="week7-day1">Week 7 (Day 1)</option>
                        <option value="week7-day2">Week 7 (Day 2)</option>
                        <option value="week7-day3">Week 7 (Day 3)</option>
                        <option value="week8-day1">Week 8 (Day 1)</option>
                        <option value="week8-day2">Week 8 (Day 2)</option>
                        <option value="week8-day3">Week 8 (Day 3)</option>
                    </select>
                </div>
                <div>
                    <label for="assignmentText" class="block text-sm font-medium text-gray-700">Assignment Text</label>
                    <textarea id="assignmentText" rows="4" class="mt-1 p-2 border rounded w-full bg-gray-50 text-gray-900" placeholder="Type your assignment or message here..."></textarea>
                </div>
                <div>
                    <label for="assignmentFile" class="block text-sm font-medium text-gray-700">Upload File</label>
                    <div id="dropzone" class="dropzone p-4 border-2 border-dashed rounded w-full text-center bg-indigo-50 cursor-pointer" aria-label="Drag and drop files here" onclick="document.getElementById('assignmentFile').click()">
                        <p>Drag & drop or click to upload</p>
                        <input type="file" id="assignmentFile" class="hidden" multiple>
                    </div>
                    <div id="filePreview" class="mt-2"></div>
                </div>
                <button id="submitAssignmentBtn" class="px-4 py-2 bg-indigo-600 text-white rounded hover:bg-indigo-700 glow-button" aria-label="Submit assignment">Submit</button>
                <p id="submissionError" class="text-red-500 min-h-[20px]"></p>
            </div>
        </section>
        <!-- Ad Modal -->
<div id="adModal" class="fixed inset-0 z-[100] flex items-center justify-center bg-black bg-opacity-60" style="display:none;">
  <div class="relative bg-white rounded-2xl shadow-xl max-w-md w-full p-0 flex flex-col items-center">
    <div class="w-full h-56 sm:h-64 overflow-hidden rounded-t-2xl">
      <iframe id="adIframe" src="" frameborder="0" class="w-full h-full" allowfullscreen></iframe>
    </div>
    <div class="p-6 flex flex-col items-center gap-2 w-full">
      <span id="adCountdown" class="text-lg font-bold text-indigo-700">20</span>
      <button id="adCancelBtn"
        class="mt-2 px-4 py-2 bg-gray-300 text-gray-700 rounded-lg font-semibold shadow hover:bg-gray-400 transition"
        style="display:none;">
        Cancel
      </button>
      <p class="text-xs text-gray-400 mt-2">You will proceed to your task automatically.</p>
    </div>
  </div>
</div>
        <!-- Assignment History Card -->
        <section class="bg-white rounded-2xl shadow-xl p-6 card">
            <h3 class="text-xl font-semibold text-indigo-900 mb-4">Assignment History</h3>
            <div class="mb-4">
                <input type="text" id="searchAssignments" class="p-2 border rounded w-full bg-indigo-50 text-gray-900" placeholder="Search assignments..." aria-label="Search assignments">
            </div>
            <div class="overflow-x-auto w-full">
                <table class="result-table w-full text-left">
                    <thead>
                        <tr class="bg-indigo-600">
                            <th class="p-2 cursor-pointer text-white" data-sort="week">Week</th>
                            <th class="p-2 cursor-pointer text-white" data-sort="title">Title</th>
                            <th class="p-2 cursor-pointer text-white" data-sort="date">Date</th>
                        </tr>
                    </thead>
                    <tbody id="submittedAssignments"></tbody>
                </table>
            </div>
        </section>
    </div>
    </section>

        
        

        <!-- Study Resources Tab -->
        <section id="study-resources" class="tab-content">
            <header class="bg-white rounded-2xl shadow-xl p-8 mb-8 card">
                <h2 class="text-3xl font-bold text-indigo-900">Study Resources</h2>
                <p class="text-gray-600 mt-2">Access essential materials to boost your learning</p>
            </header>
            <!-- AI Study Assistant Card -->
<section class="bg-gradient-to-r from-indigo-50 via-blue-50 to-purple-50 rounded-2xl gap-4 shadow-xl p-6 card border-2 border-indigo-200 relative overflow-hidden" style="box-shadow: 0 4px 24px #a5b4fc25;">
    <div class="absolute -top-10 -right-10 opacity-20 text-indigo-300" style="font-size:7rem;pointer-events:none;">
        <i class="fas fa-brain"></i>
    </div>
    <h3 class="text-2xl font-extrabold text-indigo-800 mb-2 flex items-center gap-2">
        <i class="fas fa-robot"></i>
        AI Study Assistant
    </h3>
    <p class="text-indigo-800 mb-4">Type any topic or concept you want to learn, and get a detailed, AI-generated lecture instantly.</p>
    <form id="aiStudyForm" class="flex flex-col md:flex-row gap-3">
        <input id="aiStudyInput" type="text" class="flex-1 p-3 border border-indigo-200 rounded-lg focus:ring-2 focus:ring-indigo-400 focus:border-transparent text-lg" placeholder="e.g. Quantum Mechanics, Dijkstra's Algorithm, Photosynthesis..." autocomplete="off" required>
        <button type="submit" class="px-6 py-2 bg-gradient-to-r from-blue-500 to-indigo-600 text-white rounded-lg font-bold shadow-lg hover:from-indigo-500 hover:to-blue-600 focus:ring-2 focus:ring-indigo-400 focus:outline-none transition-all text-lg glow-button">
            <i class="fas fa-book-open-reader mr-1"></i> Read Now
        </button>
    </form>
    <div id="aiStudyError" class="text-red-500 mt-2 hidden"></div>
            </section>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
                <section class="bg-white rounded-2xl shadow-xl p-6 card">
                    <h3 class="text-xl font-semibold text-indigo-900 mb-4">Available Resources</h3>
                    <ul class="list-disc list-inside space-y-2 text-sm">
                        <li><a href="#" class="text-indigo-600 hover:underline">Mathematics Formula Sheet</a></li>
                        <li><a href="#" class="text-indigo-600 hover:underline">Physics Concept Notes</a></li>
                        <li><a href="#" class="text-indigo-600 hover:underline">Coding Practice Problems</a></li>
                        <li><a href="#" class="text-indigo-600 hover:underline">Chemistry Lab Guides</a></li>
                    </ul>
                </section>
                <section class="bg-white rounded-2xl shadow-xl p-6 card">
                    <h3 class="text-xl font-semibold text-indigo-900 mb-4">Recommended Resources</h3>
                    <div class="space-y-4">
                        <div>
                            <p class="font-medium text-gray-700">Calculus Textbook</p>
                            <p class="text-gray-600 text-sm">Comprehensive guide for 300-level calculus.</p>
                            <button class="mt-2 px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 glow-button" onclick="window.open('https://example.com/calculus-textbook', '_blank')">Download</button>
                        </div>
                        <div>
                            <p class="font-medium text-gray-700">Physics Video Series</p>
                            <p class="text-gray-600 text-sm">Interactive lectures on mechanics.</p>
                            <button class="mt-2 px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 glow-button" onclick="window.open('https://example.com/physics-videos', '_blank')">Watch</button>
                        
                        </div>
                    </div>
                </section>
                
<section class="bg-white h-auto rounded-2xl shadow-xl p-6 card relative">
  <h3 class="text-xl font-semibold text-indigo-900 mb-4 flex items-center justify-between">
    Study Calendar
    <button id="addPersonalEventBtn" class="px-3 py-1 bg-indigo-100 text-indigo-800 rounded hover:bg-indigo-200 text-sm">+ Add Study Session</button>
  </h3>
  <p class="text-gray-600 text-sm mb-2">Your upcoming exams, mock tests, and personal study sessions.</p>
  <div id="studyCalendar" class="bg-indigo-50 rounded-lg"></div>
</section>
<!-- Add Event Modal -->
<div id="calendarEventModal" class="modal-backdrop" style="display:none;">
  <div class="modal" onclick="event.stopPropagation()" style="max-width:370px;">
    <button class="close-modal" onclick="closeCalendarEventModal()" style="float:right;font-size:1.5em;">&times;</button>
    <h2 class="mb-3 text-lg font-bold">Add Personal Study Session</h2>
    <form id="calendarEventForm" class="space-y-3">
      <div>
        <label class="block text-sm font-medium mb-1">Title</label>
        <input id="eventTitle" type="text" class="w-full p-2 border rounded" required>
      </div>
      <div>
        <label class="block text-sm font-medium mb-1">Date</label>
        <input id="eventDate" type="date" class="w-full p-2 border rounded" required>
      </div>
      <div>
        <label class="block text-sm font-medium mb-1">Time</label>
        <input id="eventTime" type="time" class="w-full p-2 border rounded">
      </div>
      <div>
        <label class="block text-sm font-medium mb-1">Description (optional)</label>
        <textarea id="eventDesc" class="w-full p-2 border rounded" rows="2"></textarea>
      </div>
      <button type="submit" class="w-full px-3 py-2 mt-2 bg-indigo-600 text-white rounded hover:bg-indigo-700 glow-button">Add Event</button>
    </form>
  </div>
</div>
<!-- Event Details Modal -->
<div id="calendarEventDetailsModal" class="modal-backdrop" style="display:none;">
  <div class="modal" onclick="event.stopPropagation()" style="max-width:390px;">
    <button class="close-modal" onclick="closeCalendarEventDetailsModal()" style="float:right;font-size:1.5em;">&times;</button>
    <div id="calendarEventDetailsContent"></div>
  </div>
</div>
                <section class="bg-white rounded-2xl shadow-xl p-6 card">
                    <h3 class="text-xl font-semibold text-indigo-900 mb-4">Become a Marketer or Blogger!</h3>
                    <p class="text-gray-600 text-sm">Share your knowledge, sell study materials, or promote products to earn rewards.</p>
                    <button class="mt-2 px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 glow-button" onclick="window.open('blogger-marketer-registration', '_blank')">Get Started</button>
                </section>
            </div>
        </section>


      
        <!-- Messages Tab -->
        <section id="messages" class="tab-content">
            <header class="bg-white rounded-2xl shadow-xl p-8 mb-8 card">
                <h2 class="text-3xl font-bold text-indigo-900">Messages</h2>
                <p class="text-gray-600 mt-2">Stay connected with instructors and peers</p>
            </header>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                <section class="bg-white rounded-2xl shadow-xl p-6 card">
                    <h3 class="text-xl font-semibold text-indigo-900 mb-4">Inbox</h3>
                    <div id="inboxList" class="space-y-4"></div>
                </section>
                <section class="bg-white rounded-2xl shadow-xl p-6 card">
                    <h3 class="text-xl font-semibold text-indigo-900 mb-4">Send a Message</h3>
                    <div class="space-y-4">
                        <select id="recipientSelect" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent" aria-label="Select Recipient">
                            <option>Select Recipient</option>
                        </select>
                        <textarea id="messageInput" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent" rows="4" placeholder="Type your message..."></textarea>
                        <div class="flex space-x-3">
                            <button id="cancelMessageBtn" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300 glow-button">Cancel</button>
                            <button id="sendMessageBtn" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 glow-button">Send</button>
                        </div>
                    </div>
                </section>
            </div>
        </section>

        <!-- Profile Settings Tab -->
        <section id="profile-settings" class="tab-content">
            <header class="bg-white rounded-2xl shadow-xl p-8 mb-8 card">
                <h2 class="text-3xl font-bold text-indigo-900">Profile Settings</h2>
                <p class="text-gray-600 mt-2">Manage your personal information and preferences</p>
            </header>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                <section class="bg-white rounded-2xl shadow-xl p-6 card">
                    <h3 class="text-xl font-semibold text-indigo-900 mb-4">Personal Information</h3>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Full Name</label>
                            <input id="editName" type="text" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Email</label>
                            <input id="editEmail" type="email" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Phone</label>
                            <input id="editPhone" type="tel" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Faculty</label>
                            <select id="editFaculty" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                                <option value="">Select Faculty</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Department</label>
                            <select id="editDepartment" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                                <option value="">Select Department</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Level/Year</label>
                            <select id="editLevel" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                                <option value="">Select Level</option>
                                <option value="100">100</option>
                                <option value="200">200</option>
                                <option value="300">300</option>
                                <option value="400">400</option>
                                <option value="500">500</option>
                                <option value="600">600</option>
                            </select>
                        </div>
                        <div>
    <label class="block text-sm font-medium text-gray-700">Religion</label>
    <select id="editReligion" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
        <option value="">Select Religion</option>
        <option value="christianity">Christianity</option>
        <option value="islam">Islam</option>
        <option value="other">Other</option>
    </select>
    </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">User ID</label>
                            <input id="editStudentId" type="text" readonly disabled class="w-full p-3 border border-gray-300 rounded-lg bg-gray-100 text-gray-500">
                        </div>
                        <button id="saveProfileBtn" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 glow-button relative">
                            <span id="profileSaveText">Save Changes</span>
                            <span id="profileSaveLoader" style="display:none;position:absolute;right:16px;top:50%;transform:translateY(-50%);">
                                <i class="fas fa-spinner fa-spin"></i>
                            </span>
                        </button>
                    </div>
                </section>
                <section class="bg-white rounded-2xl shadow-xl p-6 card">
                    <h3 class="text-xl font-semibold text-indigo-900 mb-4">Change Password</h3>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Current Password</label>
                            <input id="currentPassword" type="password" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">New Password</label>
                            <input id="newPassword" type="password" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Confirm New Password</label>
                            <input id="confirmNewPassword" type="password" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                        </div>
                        <button id="updatePasswordBtn" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 glow-button">Update Password</button>
                    </div>
                </section>
            </div>
        </section>

        <!-- Logout Tab -->
        <section id="logout" class="tab-content">
            <header class="bg-white rounded-2xl shadow-xl p-8 mb-8 card">
                <h2 class="text-3xl font-bold text-indigo-900">Logout</h2>
                <p class="text-gray-600 mt-2">Safely end your session</p>
            </header>
            <section class="bg-white rounded-2xl shadow-xl p-6 card text-center">
                <h3 class="text-xl font-semibold text-indigo-900 mb-4">Are you sure you want to log out?</h3>
                <p class="text-gray-600 text-sm mb-6">You will be signed out of your account and need to log in again to access your dashboard.</p>
                <button class="px-6 py-3 bg-red-600 text-white rounded-lg hover:bg-red-700 glow-button" id="confirm-logout">Confirm Logout</button>
            </section>
        </section>

        <!-- Modal root for dynamic popups -->
        <div id="modalRoot"></div>

        <!-- Broadcast Messages Modal -->
        <div id="broadcastModal" class="modal-backdrop" style="display:none;">
          <div class="modal" onclick="event.stopPropagation()" style="max-width:500px;min-width:320px;">
            <button class="close-modal" onclick="closeBroadcastModal()" style="float:right;font-size:1.5em;">&times;</button>
            <h2 style="margin-bottom:1em;">📢 Broadcasts</h2>
            <div id="broadcastList"></div>
          </div>
        </div>

        <!-- Scheduled Exam Modal -->
        <div id="scheduledExamModal" class="modal-backdrop" style="display:none;">
          <div class="modal" onclick="event.stopPropagation()" style="max-width:420px;">
            <button class="close-modal" onclick="closeScheduledExamModal()" style="float:right;font-size:1.5em;">&times;</button>
            <h2 style="margin-bottom:1em;">🗓️ Scheduled Exam</h2>
            <div id="scheduledExamContent"></div>
          </div>
        </div>
<!-- Chat Modal for Inbox/DM -->
<div id="chatModal" class="modal-backdrop" style="display:none;">
  <div class="modal" onclick="event.stopPropagation()" style="max-width:430px;">
    <button class="close-modal" onclick="closeChatModal()" style="float:right;font-size:1.5em;">&times;</button>
    <h2 id="chatModalUser" class="text-xl font-bold mb-3"></h2>
    <div id="chatMessages" style="max-height:340px;overflow-y:auto;border:1px solid #eee;background:#f9f9fd;border-radius:10px;padding:12px 8px 12px 8px;margin-bottom:12px;"></div>
    <form id="chatSendForm" class="mt-2 flex flex-col gap-2">
      <textarea id="chatInput" class="border p-2 rounded w-full" rows="2" placeholder="Type a message..."></textarea>
      <input type="file" id="chatImage" accept="image/*" style="margin-bottom:6px;">
      <button type="submit" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 glow-button w-full">Send</button>
    </form>
  </div>
</div>
        <!-- Chat Image Lightbox Modal with Swiping -->
<div id="chatImageLightbox" style="display:none;position:fixed;z-index:9999;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.88);align-items:center;justify-content:center;flex-direction:column;">
  <button id="lightboxPrev" style="position:absolute;left:28px;top:50%;transform:translateY(-50%);font-size:2.2em;background:none;border:none;color:white;cursor:pointer;z-index:2;display:none;">&#8678;</button>
  <img id="lightboxImg" src="" style="max-width:96vw;max-height:90vh;border-radius:10px;box-shadow:0 2px 18px #0008;display:block;margin:auto;">
  <button id="lightboxNext" style="position:absolute;right:28px;top:50%;transform:translateY(-50%);font-size:2.2em;background:none;border:none;color:white;cursor:pointer;z-index:2;display:none;">&#8680;</button>
</div>
        <!-- My StudyPadi Tab -->
<section id="studypadi" class="tab-content">
  <header class="bg-white rounded-2xl shadow-xl p-8 mb-8 card flex items-center justify-between">
    <div>
      <h2 class="text-3xl font-bold text-indigo-900">My StudyPadi (AI Study Materials)</h2>
      <p class="text-gray-600 mt-2">Generate personalized questions and answers from your study materials—powered by AI!</p>
    </div>
  </header>
  <div class="bg-white rounded-2xl shadow-xl p-6 card max-w-3xl mx-auto">
    <form id="studypadiForm" class="space-y-5">
      <div>
        <label class="block font-medium mb-1 text-gray-700">Upload Study Material</label>
        <input type="file" id="studypadiFile" class="w-full p-2 border rounded bg-indigo-50" accept=".pdf,.txt" multiple required>
        <div id="studypadiFilePreview" class="mt-2 text-sm text-gray-600"></div>
      </div>
      <div>
        <label class="block font-medium mb-1 text-gray-700">Question Type</label>
        <select id="studypadiQType" class="w-full p-2 border rounded bg-indigo-50" required>
          <option value="mcq">MCQ (Multiple Choice)</option>
          <option value="theory">Theory Questions</option>
          <option value="fill">Fill in the Gap</option>
          <option value="mixed">Mixture (Randomized)</option>
        </select>
      </div>
      <div id="studypadiMcqOpts" class="transition-all">
        <label class="block font-medium mb-1 text-gray-700">Number of MCQs</label>
        <select id="studypadiNumMcq" class="w-full p-2 border rounded bg-indigo-50">
          <option value="10">10</option>
          <option value="20">20</option>
          <option value="30">30</option>
          <option value="40">40</option>
          <option value="50">50</option>
        </select>
        <label class="block font-medium mb-1 mt-3 text-gray-700">Options per MCQ</label>
        <select id="studypadiNumOpts" class="w-full p-2 border rounded bg-indigo-50">
          <option value="2">2</option>
          <option value="3">3</option>
          <option value="4">4</option>
          <option value="5">5</option>
        </select>
      </div>
      <div>
        <label class="block font-medium mb-1 text-gray-700">Instructions / Focus Area (optional)</label>
        <textarea id="studypadiInstructions" class="w-full p-2 border rounded bg-indigo-50" rows="2" placeholder="e.g. Focus on chapter 3, or cover key definitions..."></textarea>
      </div>
      <button type="submit" id="studypadiSubmit" class="px-5 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 glow-button w-full">Generate Questions</button>
      <div id="studypadiError" class="text-red-500 text-sm mt-2 hidden"></div>
      <div id="studypadiProgress" class="w-full h-2 bg-indigo-100 rounded my-2 hidden"><div id="studypadiProgressBar" class="h-2 bg-indigo-500 rounded" style="width:0%"></div></div>
    </form>
    <div id="studypadiOutput" class="mt-8"></div>
  </div>
    <!-- ExamGuard Chatbot Floating Button & Modal (Place at end of <body> or in dashboard root) -->
<!-- Place your examguard-logo.png in your project root or update the img src -->

<!-- Floating chat button -->

  <!-- PDF.js for PDF text extraction -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.2.67/pdf.min.js"></script>
<script>

    // Gemini API Key (replace with your actual key)
    const GEMINI_API_KEY = "AIzaSyAcHoajEEKUQ48oHVDSgp2njtjVFDqq_j8";

    // Navigation links for buttons
    const NAV_LINKS = {
      "homepage": { text: "Homepage", url: "index.html" },
      "marketplace": { text: "Marketplace", url: "index.html#marketplace" },
      "full marketplace": { text: "Full Marketplace", url: "gen-marketplace.html" },
      "blog": { text: "Blog", url: "index.html#blog" },
      "blog & stories": { text: "Blog & Stories", url: "ngg-blog.html" },
      "login": { text: "Login", url: "index.html#login" },
      "register": { text: "Register", url: "index.html#register" },
      "mock exams": { text: "Mock Exams", url: "mock.html" },
      "contact form": { text: "Contact Form", url: "index.html#contact" }
    };

    
    // Conversation history for Gemini
    let conversation = [
      {
        role: "user",
        parts: [{
          text:
`You are ExamGuard's human support agent. Answer every question as a friendly, helpful team member.
- Never say you are an AI or language model.
- Guide users on how to use ExamGuard: homepage, marketplace, blog, login, registration, mock exams, and contact.
- When you need to reference a link, never include the link directly in your text. Instead, say "The link(s) below should be of help:" and then, in a new line, output [Homepage], [Marketplace], [Full Marketplace], [Blog], [Blog & Stories], [Login], [Register], [Mock Exams], or [Contact Form] in square brackets, each on its own line. 
- Do NOT include the actual URL or hyperlink in your message text.
- Respond in a conversational, human, supportive tone. Greet users, use first person, and be concise and clear.
- If the user uploads an image, thank them and let them know our team will review it.
- If the question is not about ExamGuard or its features, politely steer them back to platform support.
`
        }]
      }
    ];

    // Elements
    const chatbotToggleBtn = document.getElementById('chatbotToggleBtn');
    const chatbotModal = document.getElementById('chatbotModal');
    const chatbotCloseBtn = document.getElementById('chatbotCloseBtn');
    const chatbotForm = document.getElementById('chatbotForm');
    const chatbotInput = document.getElementById('chatbotInput');
    const chatbotMessages = document.getElementById('chatbotMessages');
    const chatbotFile = document.getElementById('chatbotFile');

    // Modal open/close
    function openChatbot() {
      chatbotModal.classList.remove('hidden');
      setTimeout(() => chatbotInput.focus(), 250);
      chatbotMessages.scrollTop = chatbotMessages.scrollHeight;
    }
    function closeChatbot() {
      chatbotModal.classList.add('hidden');
    }
    chatbotToggleBtn.addEventListener('click', openChatbot);
    chatbotCloseBtn.addEventListener('click', closeChatbot);
    chatbotModal.addEventListener('click', function(e){
      if (e.target === chatbotModal) closeChatbot();
    });

    // Message rendering
    function addMessage(msg, type = "bot", imgUrl = null) {
      const msgDiv = document.createElement('div');
      msgDiv.className = `max-w-[88%] px-4 py-3 mb-3 rounded-2xl shadow text-[1rem] ${type === "bot" ? "chatbot-message-bot" : "chatbot-message-user"} flex flex-col`;
      if (imgUrl) {
        msgDiv.innerHTML = `<img src="${imgUrl}" class="chatbot-message-img mb-1" alt="Sent Image">${msg ? `<span>${msg}</span>` : ""}`;
      } else {
        msgDiv.innerHTML = msg;
      }
      chatbotMessages.appendChild(msgDiv);
      chatbotMessages.scrollTop = chatbotMessages.scrollHeight;
    }

    // Group and render all buttons together at the end of message
    function enrichGeminiResponse(text) {
      // Find all [ButtonName] in square brackets, group them, remove from text
      const buttonRegex = /\[([^\]]+)\]/gi;
      let buttons = [];
      let cleanText = text.replace(buttonRegex, (match, btn) => {
        const key = btn.trim().toLowerCase();
        if (NAV_LINKS[key]) {
          buttons.push(`<a href="${NAV_LINKS[key].url}" class="chat-link-btn" target="_blank">${NAV_LINKS[key].text}</a>`);
          return "";
        }
        return match;
      });
      cleanText = cleanText.replace(/\s{2,}/g, ' ').trim();

      let html = `<div>${cleanText}</div>`;
      if (buttons.length) {
        // Add the phrase (if not already in text)
        if (!/the link\(s\) below should be of help/i.test(cleanText)) {
          html = `<div>${cleanText ? cleanText + "<br><br>" : ""}The link(s) below should be of help:</div>`;
        }
        html += `<div class="chat-link-row">${buttons.join('')}</div>`;
      }
      return html;
    }

    // Initial welcome message
    function showWelcome() {
      chatbotMessages.innerHTML = '';
      addMessage("👋 Hi there! How can I help you get around ExamGuard today?");
      // Reset conversation history except for system prompt
      conversation = [conversation[0]];
    }
    showWelcome();

    // Gemini API call: send full conversation history for memory
    async function geminiReply(userMsg, imgBase64) {
      // Add current user turn to conversation
      let userTurn = { role: "user", parts: [{ text: userMsg }] };
      if (imgBase64) {
        userTurn.parts.push({ inline_data: { mime_type: "image/png", data: imgBase64.split(',')[1] } });
      }
      conversation.push(userTurn);

      // Show typing...
      addMessage('<span class="gemini-typing">Typing</span>', "bot");
      const loadingDiv = chatbotMessages.lastChild;

      try {
        const res = await fetch("https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=" + GEMINI_API_KEY, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ contents: conversation })
        });
        const data = await res.json();
        loadingDiv.remove();
        let answer = (data && data.candidates && data.candidates[0]?.content?.parts?.map(p => p.text).join('\n')) ||
                     (data?.candidates?.[0]?.content?.text) || "Sorry, I couldn't process your request. Please try again.";
        // Add Gemini's answer to conversation history
        conversation.push({ role: "model", parts: [{ text: answer }] });
        addMessage(enrichGeminiResponse(answer), "bot");
      } catch (e) {
        loadingDiv.remove();
        addMessage("Sorry, there was an error contacting support agent.", "bot");
      }
    }

    // Chat form submit
    chatbotForm.addEventListener('submit', function(e) {
      e.preventDefault();
      const userMsg = chatbotInput.value.trim();
      const imgFile = chatbotFile.files[0];
      if (!userMsg && !imgFile) return;

      if (imgFile) {
        const reader = new FileReader();
        reader.onload = function(ev) {
          addMessage("", "user", ev.target.result);
          if (userMsg) addMessage(userMsg, "user");
          chatbotInput.value = "";
          chatbotFile.value = "";
          geminiReply(userMsg || "[Image uploaded]", ev.target.result);
        };
        reader.readAsDataURL(imgFile);
      } else {
        addMessage(userMsg, "user");
        chatbotInput.value = "";
        geminiReply(userMsg);
      }
      chatbotFile.value = "";
    });

    // Image upload via input
    chatbotFile.addEventListener('change', function() {
      if (chatbotFile.files.length > 0) {
        chatbotInput.focus();
      }
    });

    // Re-show welcome if closed and reopened
    chatbotToggleBtn.addEventListener('click', showWelcome);

    // Optional: scroll to bottom on open
    chatbotToggleBtn.addEventListener('click', function(){
      setTimeout(()=>{chatbotMessages.scrollTop = chatbotMessages.scrollHeight;}, 400);
    });

// --- PDF.js Loader Utility ---
function ensurePdfjsLibLoaded() {
  return new Promise((resolve, reject) => {
    if (window.pdfjsLib) return resolve(window.pdfjsLib);
    if (window.__pdfjsLibLoading) {
      window.__pdfjsLibLoading.then(resolve).catch(reject);
      return;
    }
    const script = document.createElement("script");
    script.src = "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.2.67/pdf.min.js";
    script.onload = () => { resolve(window.pdfjsLib); };
    script.onerror = reject;
    document.head.appendChild(script);
    window.__pdfjsLibLoading = new Promise((res, rej) => {
      script.onload = () => { res(window.pdfjsLib); resolve(window.pdfjsLib); };
      script.onerror = rej;
    });
  });
}

// --- File Extraction Helpers ---
async function extractTextFromFile(file) {
  if (file.type === "application/pdf") {
    await ensurePdfjsLibLoaded();
    const pdf = await pdfjsLib.getDocument(await file.arrayBuffer()).promise;
    let text = '';
    for (let i = 1; i <= pdf.numPages; i++) {
      const page = await pdf.getPage(i);
      const content = await page.getTextContent();
      text += content.items.map(item => item.str).join(' ') + '\n';
    }
    return text;
  } else if (file.type === "text/plain") {
    return await file.text();
  } else if (file.name.match(/\.(docx)$/i)) {
    if (!window.mammoth) {
      alert("DOCX support requires mammoth.js. Please load mammoth.browser.min.js from CDN.");
      return '';
    }
    const result = await mammoth.extractRawText({arrayBuffer: await file.arrayBuffer()});
    return result.value || '';
  } else if (file.type.startsWith("image/")) {
    const base64 = await fileToBase64(file);
    if (window.Tesseract) {
      const { data: { text } } = await window.Tesseract.recognize(base64, "eng");
      return text || '';
    }
    return '';
  } else {
    return await file.text();
  }
}
function fileToBase64(file) {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.onload = e => resolve(e.target.result);
    reader.onerror = e => reject(e);
    reader.readAsDataURL(file);
  });
}

// --- Prompt Generation ---
function buildGeminiPrompt({qType, numMcq, numOpts, instructions, allTexts, imageBase64s}) {
  let studyContent = allTexts.join('\n\n');
  let cleanInstructions = (instructions || "")
    .replace(/(see attached|from the file|from the image|according to the text|according to the image|the document provided|the uploaded file|the uploaded image|as seen in the image|as shown in the file|according to|from the file|from the image)/gi, "")
    .trim();

  return `
You are an expert instructional designer and exam question generator.
Given ONLY the following study material (see below), generate exam questions as specified.
Your output MUST be a single JSON object, with NO code block markers, NO commentary, and NO references to files, images, or the material source in your questions or answers.
DO NOT use phrases like "According to the text", "From the image provided", "From the document", "As shown above", or any similar reference.

JSON structure:
{
  "questions": [
    // For MCQ: {"type":"mcq", "question":"...", "options":["..."], "answer":"..."}
    // For Theory: {"type":"theory", "question":"...", "answer":"..."}
    // For Fill: {"type":"fill", "question":"...", "answer":"..."}
  ],
  "answerSheet": [
    // List of correct answers in order, with question number: {"number":1,"answer":"Paris"}
  ]
}

Instructions:
- Focus ONLY on the provided content (below), and STRICTLY follow the user instructions.
- For MCQs, generate exactly ${numMcq} questions, each with ${numOpts} options.
- For Theory, generate 10 questions.
- For Fill in the Gap, generate 10 questions.
- For Mixed, generate a mixture of MCQ, Theory, and Fill in the Gap (in random order, total 20).
- All MCQ options must be plausible; only one correct answer.
- Output must be valid JSON. No commentary, no code blocks, no explanations.
- For each question, provide the correct answer.
- DO NOT use any phrase referencing the material, file, or image in your questions or answers. Write the questions as if they are independent and self-contained.

User Instructions:
${cleanInstructions}

Study Material (text and/or OCR from images):
${studyContent}

${imageBase64s && imageBase64s.length ? '\n(If you are Gemini Vision, you may use the following base64 images for OCR or context):\n' + imageBase64s.join('\n') : ''}
`.trim();
}

// --- Improved Spinner Overlay ---
function showSpinner(msg = "Generating StudyPadi...") {
  let spinner = document.getElementById("studypadiSpinnerOverlay");
  if (!spinner) {
    spinner = document.createElement("div");
    spinner.id = "studypadiSpinnerOverlay";
    spinner.style.cssText = `
      position:fixed;top:0;left:0;width:100vw;height:100vh;z-index:9999;
      background:rgba(255,255,255,0.85);display:flex;align-items:center;justify-content:center;flex-direction:column;
    `;
    spinner.innerHTML = `
      <div style="display:flex;flex-direction:column;align-items:center;">
        <div class="spinner" style="width:64px;height:64px;border:8px solid #e0e7ef;border-top:8px solid #6366f1;border-radius:50%;animation:spin 1s linear infinite;"></div>
        <div style="margin-top:20px;font-size:1.2em;color:#3a86ff;font-weight:bold;" id="studypadiSpinnerText">${msg}</div>
      </div>
    `;
    document.body.appendChild(spinner);
  } else {
    document.getElementById('studypadiSpinnerText').textContent = msg;
    spinner.style.display = "flex";
  }
}
function hideSpinner() {
  const spinner = document.getElementById("studypadiSpinnerOverlay");
  if (spinner) spinner.style.display = "none";
}

// --- Progress Bar Helper ---
function updateStudypadiProgress(percent, msg) {
  const progressBar = document.getElementById("studypadiProgress");
  const progressInner = document.getElementById("studypadiProgressBar");
  if (progressBar && progressInner) {
    progressBar.style.display = "block";
    progressInner.style.width = `${percent}%`;
    if (msg) {
      let progressMsg = document.getElementById("studypadiProgressMsg");
      if (!progressMsg) {
        progressMsg = document.createElement("div");
        progressMsg.id = "studypadiProgressMsg";
        progressMsg.style = "margin-top:3px;color:#6366f1;font-size:0.97em;text-align:center;";
        progressBar.parentNode.insertBefore(progressMsg, progressBar.nextSibling);
      }
      progressMsg.textContent = msg;
    }
  }
}

// --- Output Renderer with Summary ---
function renderStudyPadiOutput(data) {
  if (!data || !data.questions || !data.questions.length) {
    return `<div class="text-red-600 font-bold text-lg">No questions generated. Please try again with a different file or instructions.</div>`;
  }
  let summary = `
    <div class="mb-3 text-indigo-900 font-semibold">
      <span>Question Type: ${window.lastQTypeLabel || ''}</span> &nbsp;
      <span>${window.lastNumQuestions ? `| Number: ${window.lastNumQuestions}` : ''}</span>
    </div>
  `;
  let html = summary + `<div class="bg-indigo-50 rounded-xl p-6 mb-6">
    <div class="flex flex-wrap gap-4 mb-7">
      <button id="studypadiDownloadPdf" class="px-4 py-2 bg-indigo-600 text-white rounded shadow hover:bg-indigo-700">Download PDF</button>
      <button id="studypadiShowAnswers" class="px-4 py-2 bg-emerald-500 text-white rounded shadow hover:bg-emerald-700">Show/Hide Answer Sheet</button>
    </div>
    <ol class="space-y-5 text-lg">`;
  data.questions.forEach((q, i) => {
    if (q.type === "mcq") {
      html += `<li><b>Q${i+1} (MCQ):</b> ${q.question}<ul class="ml-6 mt-1 mb-3">`
        + q.options.map(opt=>`<li>${opt}</li>`).join('')
        + `</ul></li>`;
    } else if (q.type === "theory") {
      html += `<li><b>Q${i+1} (Theory):</b> ${q.question}</li>`;
    } else if (q.type === "fill") {
      html += `<li><b>Q${i+1} (Fill):</b> ${q.question}</li>`;
    }
  });
  html += `</ol>
    <div id="studypadiAnswerSheet" class="bg-white rounded-lg shadow p-4 mt-8" style="display:none;">
      <b>Answer Sheet</b><br>
      <ol class="mt-2">${(data.answerSheet||[]).map(ans=>`<li><b>Q${ans.number}:</b> ${ans.answer}</li>`).join('')}</ol>
    </div>
  </div>`;
  return html;
}

// --- Main Submit Handler ---
document.getElementById("studypadiForm").onsubmit = async function(e) {
  e.preventDefault();
  const errorDiv = document.getElementById("studypadiError");
  const progressBar = document.getElementById("studypadiProgress");
  const progressInner = document.getElementById("studypadiProgressBar");
  if (progressBar) progressBar.style.display = "block";
  if (progressInner) progressInner.style.width = "0%";
  if (errorDiv) { errorDiv.classList.add("hidden"); errorDiv.textContent = ""; }

  document.getElementById("studypadiOutput").innerHTML = "";
  showSpinner("Extracting Study Material...");

  // Get user selections
  const files = Array.from(document.getElementById("studypadiFile").files);
  const qType = document.getElementById("studypadiQType").value;
  const numMcq = document.getElementById("studypadiNumMcq").value;
  const numOpts = document.getElementById("studypadiNumOpts").value;
  const instructions = document.getElementById("studypadiInstructions").value.trim();
  if (!files.length) {
    errorDiv.textContent = "Please upload at least one study file.";
    errorDiv.classList.remove("hidden"); hideSpinner(); if (progressBar) progressBar.style.display = "none"; return;
  }
  document.getElementById("studypadiSubmit").disabled = true; document.getElementById("studypadiSubmit").textContent = "Generating...";

  // Store user selection for output summary
  window.lastQTypeLabel = {
    "mcq":"MCQ (Multiple Choice)",
    "theory":"Theory",
    "fill":"Fill in the Gap",
    "mixed":"Mixed"
  }[qType] || qType;
  window.lastNumQuestions =
    (qType === "mcq") ? numMcq
    : (qType === "mixed") ? 20
    : 10;

  // Limits
  const MAX_IMAGES = 3;
  const MAX_CHARS = 10000;
  let allTexts = [];
  let imageBase64s = [];
  let truncated = false;
  try {
    // --- File Extraction with Progress ---
    for (let i = 0; i < files.length; i++) {
      updateStudypadiProgress(Math.floor((i/files.length)*15), `Processing file ${i+1} of ${files.length}...`);
      if (files[i].type.startsWith("image/")) {
        if (imageBase64s.length >= MAX_IMAGES) continue;
        const base64 = await fileToBase64(files[i]);
        imageBase64s.push(base64);
        if (window.Tesseract) {
          updateStudypadiProgress(Math.floor((i/files.length)*20), "Running OCR on image...");
          const { data: { text } } = await window.Tesseract.recognize(base64, "eng");
          if (text && text.trim()) allTexts.push(text.trim());
        }
      } else {
        const txt = await extractTextFromFile(files[i]);
        if (txt && txt.trim()) allTexts.push(txt.trim());
      }
    }
    updateStudypadiProgress(22, "Preparing study content...");

    // Combine and truncate text for Gemini API
    let studyContent = allTexts.join('\n\n');
    if (studyContent.length > MAX_CHARS) {
      studyContent = studyContent.slice(0, MAX_CHARS);
      truncated = true;
    }
    if (!studyContent && !imageBase64s.length) {
      errorDiv.textContent = "No readable text or images could be extracted from your files.";
      errorDiv.classList.remove("hidden");
      hideSpinner(); if (progressBar) progressBar.style.display = "none";
      document.getElementById("studypadiSubmit").disabled = false;
      document.getElementById("studypadiSubmit").textContent = "Generate Questions";
      return;
    }

    // Compose prompt
    const prompt = buildGeminiPrompt({qType, numMcq, numOpts, instructions, allTexts: [studyContent], imageBase64s});
    updateStudypadiProgress(35, "Sending prompt to AI...");

    // Call Gemini API
    
    let url, data;
    if (imageBase64s.length) {
      url = "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=" + GEMINI_API_KEY;
      data = {
        contents: [{
          role: "user",
          parts: [
            { text: prompt },
            ...imageBase64s.map(img => ({
              inlineData: { mimeType: "image/jpeg", data: img.split(',')[1] }
            }))
          ]
        }]
      };
    } else {
      url = "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=" + GEMINI_API_KEY;
      data = {
        contents: [{
          role: "user",
          parts: [{ text: prompt }]
        }]
      };
    }

    let aiTimeout = setTimeout(() => {
      showSpinner("AI is taking longer than usual. Please wait...");
      updateStudypadiProgress(55, "Waiting for AI to generate questions...");
    }, 12000);

    updateStudypadiProgress(50, "Waiting for AI to generate questions...");
    const resp = await fetch(url, {
      method: "POST",
      headers: {"Content-Type": "application/json"},
      body: JSON.stringify(data)
    });
    clearTimeout(aiTimeout);
    updateStudypadiProgress(70, "Parsing AI response...");
    if (!resp.ok) throw new Error("Failed to contact Gemini API");
    const result = await resp.json();
    if (!result.candidates || !result.candidates[0]?.content?.parts[0]?.text)
      throw new Error("No valid response from Gemini API");
    let text = result.candidates[0].content.parts[0].text.trim();
    if (text.startsWith("```json")) text = text.replace(/^```json\s*/,"").replace(/```$/,"");
    let studypadiData;
    try { studypadiData = JSON.parse(text); } catch {
      const jsonMatch = text.match(/\{[\s\S]*\}/);
      if (jsonMatch) studypadiData = JSON.parse(jsonMatch[0]);
      else throw new Error("Could not parse Gemini response as JSON");
    }

    // --- ENFORCE Output to match Selection ---
    if (studypadiData && Array.isArray(studypadiData.questions)) {
      if (qType === "mcq") {
        studypadiData.questions = studypadiData.questions.filter(q => q.type === "mcq").slice(0, parseInt(numMcq));
      } else if (qType === "theory") {
        studypadiData.questions = studypadiData.questions.filter(q => q.type === "theory").slice(0, 10);
      } else if (qType === "fill") {
        studypadiData.questions = studypadiData.questions.filter(q => q.type === "fill").slice(0, 10);
      } else if (qType === "mixed") {
        let mcqs = studypadiData.questions.filter(q => q.type === "mcq");
        let theory = studypadiData.questions.filter(q => q.type === "theory");
        let fill = studypadiData.questions.filter(q => q.type === "fill");
        let mixedQuestions = [];
        while (mixedQuestions.length < 20 && (mcqs.length || theory.length || fill.length)) {
          if (mcqs.length && mixedQuestions.length < 20) mixedQuestions.push(mcqs.shift());
          if (theory.length && mixedQuestions.length < 20) mixedQuestions.push(theory.shift());
          if (fill.length && mixedQuestions.length < 20) mixedQuestions.push(fill.shift());
        }
        studypadiData.questions = mixedQuestions.slice(0, 20);
      }
      // Update answerSheet to only include answers for displayed questions
      if (Array.isArray(studypadiData.answerSheet)) {
        const displayedIndexes = studypadiData.questions.map((_, idx) => idx + 1);
        studypadiData.answerSheet = studypadiData.answerSheet.filter(ans => displayedIndexes.includes(ans.number));
      }
    }

    updateStudypadiProgress(100, "Done!");
    // Hide spinner and progress after a short delay
    setTimeout(()=>{ hideSpinner(); if (progressBar) progressBar.style.display="none"; }, 500);

    // Render output & truncation note
    let truncNote = '';
    if (truncated) truncNote = '<div class="text-yellow-700 font-semibold mb-2">Note: Only the first 10,000 characters of your material were used for speed and reliability.</div>';
    document.getElementById("studypadiOutput").innerHTML =
      truncNote + renderStudyPadiOutput(studypadiData);

    // Download PDF (print)
    document.getElementById("studypadiDownloadPdf").onclick = function() {
      window.print();
    };
    // Show/Hide Answers
    document.getElementById("studypadiShowAnswers").onclick = function() {
      const ans = document.getElementById("studypadiAnswerSheet");
      ans.style.display = ans.style.display === "none" ? "block" : "none";
    };
  } catch (err) {
    hideSpinner();
    errorDiv.textContent = "Failed to generate questions: " + err.message;
    errorDiv.classList.remove("hidden"); if (progressBar) progressBar.style.display = "none";
  } finally {
    document.getElementById("studypadiSubmit").disabled = false;
    document.getElementById("studypadiSubmit").textContent = "Generate Questions";
    updateStudypadiProgress(0, "");
    setTimeout(()=>{
      if (document.getElementById("studypadiProgress")) document.getElementById("studypadiProgress").style.display="none";
      const msg = document.getElementById("studypadiProgressMsg"); if (msg) msg.textContent = "";
    }, 1200);
  }
};

// --- MCQ Options Visibility (show/hide based on type) ---
document.getElementById("studypadiQType").addEventListener("change", function() {
  const isMcq = this.value === "mcq";
  document.getElementById("studypadiMcqOpts").style.display = isMcq ? "block" : "none";
});
document.getElementById("studypadiQType").dispatchEvent(new Event("change"));

// --- File Preview ---
document.getElementById("studypadiFile").addEventListener("change", function() {
  const files = Array.from(this.files);
  const preview = document.getElementById("studypadiFilePreview");
  if (!files.length) { preview.innerHTML=""; return; }
  preview.innerHTML = files.map(f=>`${f.name} (${(f.size/1024).toFixed(1)} KB)`).join('<br>');
});

// --- CSS for Spinner ---
if (!document.getElementById('studypadiSpinnerCSS')) {
  const style = document.createElement('style');
  style.id = 'studypadiSpinnerCSS';
  style.innerHTML = `
@keyframes spin { 100% { transform: rotate(360deg); } }
.spinner { display:inline-block; }
  `;
  document.head.appendChild(style);
}
</script>

    
</section>
    </main>
     </div>
    <script src="student_dashboard.js"></script>
    <script>
        // --- AI Study Assistant: Open Gemini API Lecture Page ---
document.getElementById("aiStudyForm").onsubmit = function(e) {
    e.preventDefault();
    const topic = document.getElementById("aiStudyInput").value.trim();
    const errorDiv = document.getElementById("aiStudyError");
    if (!topic) {
        errorDiv.textContent = "Please enter a topic!";
        errorDiv.classList.remove("hidden");
        return;
    }
    errorDiv.classList.add("hidden");
    // You can replace this URL with your Gemini-powered endpoint/page
    // Example: /ai-lecture.html?topic=...
    const url = '/ai-lecture.html?topic=' + encodeURIComponent(topic);
    window.open(url, '_blank');
};
        

    </script>
</body>
</html>
