<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>KIA Chat - ExamGuard Team</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/flowbite/2.3.0/flowbite.min.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
  <link rel="icon" href="logo.png" />
  <style>
    :root { --msg-max-width: 36em; }
    body { background: #e4e7f1; min-height:100vh; }
    .whatsapp-bg { background: url('https://i.ibb.co/wS0N9Vw/chatbg.jpg') center/cover repeat, #e4e7f1; }
    @media(max-width:700px){ .whatsapp-bg{background-size:contain;} }
    .kia-ai-badge {
      background: linear-gradient(88deg,#6366f1 70%,#22d3ee 100%);
      color: #fff;
      font-size:.9em;
      font-weight: 700;
      border-radius:7px;
      padding: 2px 9px;
      margin-left:7px;
      letter-spacing:.04em;
      box-shadow:0 1px 8px #6366f133;
    }
    .box-shadow-strong {
      box-shadow:0 8px 42px #6366f125;
    }
    .kia-voice-btn[data-recording=true] {
      background: #6366f1 !important; color:#fff !important;
    }
    .kia-image-thumb {
      width:80px;height:80px;object-fit:cover;border-radius:10px;border:2px solid #fff;margin-right:7px;box-shadow:0 1.5px 7px #6366f126;
    }
    .msg-bubble {max-width:var(--msg-max-width); white-space:pre-wrap;}
    .msg-me { background: #DCF8C6; color:#222; align-self:flex-end; border-radius:15px 15px 0 15px; }
    .msg-ai { background: #fff; color:#222; align-self:flex-start; border-radius:15px 15px 15px 0; box-shadow:0 2px 9px #6366f133;}
    .msg-meta{font-size: 0.8em; color:#a3a3a3; margin-top:3px;}
    .msg-voice { background: #e4e7f1; border:2px dashed #6366f1; color:#222; }
    .loading-bounce {animation: bounce 1.1s infinite;}
    @keyframes bounce {
      0%,100% {transform:translateY(0);}
      50%{transform:translateY(-7px);}
    }
    .scrollbar-hide::-webkit-scrollbar {display:none;}
    .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }

    /* Full Height Chat */
    .kia-chat-main {
      min-height: 100vh;
      height: 100vh;
      display: flex;
      flex-direction: column;
      background: transparent;
      position: relative;
    }
    .kia-main-panel {
      flex: 1 1 0%;
      display: flex;
      flex-direction: column;
      height: calc(100vh - 50px);
    }
    .chatListPanel {
      flex: 1 1 0%;
      overflow-y: auto;
      padding-bottom: 6.5em;
      background: transparent;
    }
    /* Narrow fixed input/send @ bottom */
    .kia-chat-footer-fixed {
      position: fixed;
      left: 0; right: 0; bottom: 0;
      margin-left: auto; margin-right: auto;
      z-index: 22;
      background: rgba(255,255,255,0.98);
      border-top: 1.5px solid #e0e7ff;
      box-shadow: 0 -2px 8px #6366f112;
      display: flex; flex-direction: column;
      width: 100%;
      max-width: 420px;
      border-radius: 0 0 24px 24px;
      padding-top: 0.2em;
      padding-bottom: 0.4em;
      transition: max-width 0.22s;
    }
    @media (max-width: 900px) { 
      .kia-chat-footer-fixed { max-width:99vw; border-radius:0; }
      .chatListPanel { padding-bottom:7.5em; }
    }
    .kia-input-form-row {
      display: flex; gap: 6px; align-items: flex-end; width: 100%;
      padding-left: .7em; padding-right: .7em;
    }
    .msg-input-multiline {
      resize: none;
      min-height: 2.6em;
      max-height: 5.8em;
      box-sizing: border-box;
      font-size: 1.08em;
      overflow-y: auto;
      background: #f3f7fd;
      color: #214278;
      border-radius: 11px;
      border: 1.5px solid #e0e7ff;
      padding: 8px 15px;
      font-family: inherit;
      font-weight: 500;
      transition: border .15s, background .13s;
      flex:1;
    }
    .msg-input-multiline:focus {
      border: 1.5px solid #6366f1;
      background: #fff;
      outline: none;
    }
    .msg-input-multiline::-webkit-input-placeholder { color:#b6bad6; }
    .msg-input-multiline:-ms-input-placeholder { color: #b6bad6; }
    .msg-input-multiline::placeholder { color:#b6bad6; }
    .msg-input-actions-btn { padding:7px;width:40px;height:40px;border-radius:50%;display:inline-flex;align-items:center;justify-content:center;border:none;background:#e0e7ff;color:#6366f1; }
    .msg-input-actions-btn:active,.msg-input-actions-btn:focus { background:#6366f1;color:#fff;}
    .msg-send-btn {
      background: linear-gradient(88deg,#22d3ee 60%,#6366f1 100%);
      color: #fff;
      border:none;
      border-radius:50%;
      font-size:1.18em;
      font-weight:700;
      width:44px;height:44px;margin-left:3px;
      display: flex;align-items:center;justify-content:center;
      box-shadow: 0 2px 10px #6366f112;
    }
    .msg-send-btn:active,.msg-send-btn:focus { background:#6366f1; }
    .kia-img-preview-row{display:flex;gap:6px;flex-wrap:wrap;margin-top:3px;margin-bottom:3px;padding-left:13px;}
    .kia-img-thumb{height:38px;width:38px;border-radius:8px;object-fit:cover;}
    .kia-voice-preview-row{display:flex;gap:9px;margin-top:4px;margin-left:13px;}
    .msg-meta {
      font-size: 10.5px;
      color: #388e3c;
      opacity: .5;
      margin-top: 2px;
      text-align:right;
    }
    @media (max-width:700px){
      .kia-chat-main{border-radius:0;}
      .kia-chat-footer-fixed{padding:0.2em 0.1em;}
      .kia-input-form-row{padding-left:0.1em;}
    }
    .msg-bubble.first-message {
      margin-top: 58px !important;
    }
    .msg-bubble.last-message {
      margin-bottom: 58px !important;
    }
    @media(max-width:700px){
      .msg-bubble.first-message { margin-top: 46px !important; }
      .msg-bubble.last-message { margin-bottom: 53px !important; }
    }
  </style>
</head>
<body>
  <div class="kia-chat-main whatsapp-bg">
    <!-- Header -->
    <div class="flex items-center gap-3 bg-gradient-to-r from-indigo-500 to-blue-500 px-5 py-4">
      <img src="logo.png" class="w-11 h-11 rounded-full border-2 border-white box-shadow-strong" alt="KIA" />
      <div class="flex-1 text-base font-bold text-white">KIA <span class="kia-ai-badge">by ExamGuard Team</span></div>
      <button id="editNameBtn" class="text-white bg-blue-600 px-2 rounded font-bold hover:bg-green-400 transition h-8 w-8 text-center flex items-center justify-center" title="Set your name">
        <i class="bi bi-person-lines-fill"></i>
      </button>
    </div>
    <!-- Main full height panel -->
    <div class="kia-main-panel w-full max-w-md mx-auto" style="position:relative;">
      <div id="chatList" class="chatListPanel flex flex-col gap-2 px-3 pb-0 overflow-y-auto whatsapp-bg scrollbar-hide">
        <!-- Messages will be injected here -->
      </div>
      <div class="text-center mt-6 mb-1 text-xs text-blue-700 font-semibold">ExamGuard KIA Chatbot. All messages are private & educational!</div>
    </div>
    <!-- Input/Send actions fixed narrow at bottom -->
    <div class="kia-chat-footer-fixed">
      <form id="chatForm" class="kia-input-form-row">
        <textarea type="text" id="chatInput" class="msg-input-multiline" rows="1" autocomplete="off" placeholder="Type your message..."></textarea>
        <input type="file" id="imageInput" accept="image/*" multiple style="display:none" />
        <button type="button" id="imgBtn" class="msg-input-actions-btn" title="Send image"><i class="bi bi-image" style="font-size:1.17em;"></i></button>
        <button type="button" id="voiceBtn" class="msg-input-actions-btn kia-voice-btn" title="Voice note"><i class="bi bi-mic"></i></button>
        <button type="submit" id="sendBtn" class="msg-send-btn"><i class="bi bi-send"></i></button>
      </form>
      <div id="imgPreviewRow" class="kia-img-preview-row"></div>
      <div id="voicePreviewRow" class="kia-voice-preview-row"></div>
      <div class="text-right text-xs text-blue-400 mr-3 mb-1">Max 3 images per chat, 6 in 3hrs. AI only responds with text.</div>
    </div>
    <!-- Name Modal (Flowbite) -->
    <div id="nameModal" tabindex="-1" class="hidden fixed top-0 left-0 right-0 z-50 bg-black/30 flex items-center justify-center h-screen">
      <div class="bg-white rounded-xl p-7 w-11/12 max-w-sm shadow-lg relative">
        <button type="button" class="absolute top-2 right-3 text-2xl text-indigo-400 hover:text-indigo-700" onclick="hideNameModal()">&times;</button>
        <h3 class="text-lg font-bold text-blue-700 mb-3">Set your name</h3>
        <input id="nameModalInput" type="text" maxlength="24" class="block w-full border border-blue-200 rounded-md p-2 mb-4" placeholder="Enter your name...">
        <button type="button" class="w-full bg-blue-600 text-white font-bold rounded-lg py-2 hover:bg-blue-800" onclick="saveNameModal()">Save</button>
      </div>
    </div>
  </div>
  <script>
    // --- CONFIG: Gemini Backend ---
    const GEMINI_CHAT_API = "https://examguard-jmvj.onrender.com/api/ai-chat";
    const MAX_PER_SEND = 3, MAX_PER_3HR = 6, IMG_WINDOW_MS = 3*60*60*1000;

    // --- Name Modal ---
    function showNameModal() { document.getElementById('nameModal').style.display='flex'; }
    function hideNameModal() { document.getElementById('nameModal').style.display='none'; }
    function saveNameModal() {
      let val = document.getElementById('nameModalInput').value.trim();
      if(!val) return;
      localStorage.kiaUserName = val;
      userName = val;
      hideNameModal();
      systemMsg("Hello, " + val + "! Start your educational chat with KIA.");
    }
    document.getElementById('editNameBtn').onclick = showNameModal;

    // Initialize userName
    let userName = localStorage.kiaUserName || "";
    if(!userName) setTimeout(showNameModal, 700);

    // --- Chat State ---
    let messages = [];
    let selectedImages = []; // {file, base64}
    let imgLimits = JSON.parse(localStorage.getItem("kiaImageLimits")||'{"records":[]}');
    let voiceBlob = null;

    // --- Multiline textarea auto-grow ---
    function autoGrowTextarea(el) {
      el.style.height = "auto";
      el.style.height = (el.scrollHeight) + "px";
    }
    document.getElementById('chatInput').addEventListener('input', function() { autoGrowTextarea(this); });

    // --- Image Upload Logic ---
    document.getElementById('imgBtn').onclick = () => document.getElementById('imageInput').click();
    document.getElementById('imageInput').onchange = function() {
      const files = Array.from(this.files||[]);
      if(files.length + selectedImages.length > MAX_PER_SEND) {
        alert("You can select max " + MAX_PER_SEND + " images per message."); return;
      }
      if(!canUploadImages(files.length + selectedImages.length)) {
        alert("Image sending limit exceeded (max "+MAX_PER_3HR+" in 3hrs). Try again later."); return;
      }
      files.forEach(file => {
        if(selectedImages.length < MAX_PER_SEND) {
          const reader = new FileReader();
          reader.onload = e => {
            selectedImages.push({file, base64:reader.result});
            renderImgPreviews();
          };
          reader.readAsDataURL(file);
        }
      });
      this.value = '';
    };
    function canUploadImages(num) {
      let now = Date.now();
      imgLimits.records = imgLimits.records.filter(ts => now-ts < IMG_WINDOW_MS);
      if(imgLimits.records.length + num > MAX_PER_3HR) return false;
      return true;
    }
    function addImageRecord(num) {
      for(let i=0;i<num;i++) imgLimits.records.push(Date.now());
      localStorage.setItem('kiaImageLimits', JSON.stringify(imgLimits));
    }
    function renderImgPreviews() {
      document.getElementById('imgPreviewRow').innerHTML = selectedImages.map((img,i)=>`
        <span class="relative"><img src="${img.base64}" class="kia-img-thumb"/>
          <button type="button" onclick="removeImg(${i})" class="absolute top-0 right-0 bg-blue-200 rounded-full px-1 py-0 font-bold text-blue-700 text-xs">&times;</button>
        </span>
      `).join('');
    }
    window.removeImg = i => { selectedImages.splice(i,1); renderImgPreviews(); };

    // --- Voice Note ---
    let isRecording = false, mediaRecorder = null, voiceChunks = [];
    document.getElementById('voiceBtn').onclick = async function () {
      if(isRecording&&mediaRecorder){mediaRecorder.stop();return;}
      if(!navigator.mediaDevices?.getUserMedia) return alert("Voice recording not supported.");
      try {
        let stream = await navigator.mediaDevices.getUserMedia({ audio:true });
        mediaRecorder = new MediaRecorder(stream);
        voiceChunks = [];
        mediaRecorder.ondataavailable = e => { if(e.data.size>0) voiceChunks.push(e.data); };
        mediaRecorder.onstop = () => {
          isRecording=false;this.dataset.recording=false;
          voiceBlob = new Blob(voiceChunks, { type:'audio/webm' });
          renderVoicePreview(voiceBlob); stream.getTracks().forEach(t=>t.stop());
        };
        isRecording=true;this.dataset.recording=true; mediaRecorder.start();
      } catch(e){alert("Could not access mic.");}
    };
    function renderVoicePreview(blob) {
      document.getElementById('voicePreviewRow').innerHTML = `
        <div class="flex items-center gap-1"><audio controls src="${URL.createObjectURL(blob)}" class="w-full"></audio>
          <button class="kia-voice-btn px-1 py-0 text-xs" onclick="clearVoice()" style="margin-left:4px;">&times;</button>
        </div>
      `;
    }
    window.clearVoice = function(){ document.getElementById('voicePreviewRow').innerHTML=''; voiceBlob=null; };

    // --- Message Send ---
    document.getElementById('chatForm').onsubmit = async function(e){
      e.preventDefault();
      let text = document.getElementById('chatInput').value.trim();
      let imgs = selectedImages||[];
      if(!text && !imgs.length && !voiceBlob) return;
      addMessage({from:'me',text,images:imgs.map(img=>img.base64),voice:voiceBlob,ts:Date.now()});
      document.getElementById('chatInput').value=''; autoGrowTextarea(document.getElementById('chatInput'));
      selectedImages=[]; renderImgPreviews(); clearVoice();
      addImageRecord(imgs.length);
      showTyping();
      let formData = new FormData();
      formData.append('userName', userName || 'Student');
      formData.append('msg', text || "");
      if(voiceBlob) formData.append('voice',voiceBlob,'voice.webm');
      imgs.forEach((img,i) => formData.append('images',img.base64));
      try {
        let resp = await fetch(GEMINI_CHAT_API, {
          method:'POST', headers:{'Authorization':'Bearer '+(localStorage.token||'')},
          body:formData
        });
        let aiTxt = await resp.text();
        hideTyping();
        addMessage({from:'ai',text:aiTxt,ts:Date.now()});
      } catch {
        hideTyping(); addMessage({from:'ai',text:"Sorry, KIA is offline. Try again later.",ts:Date.now()});
      }
    };

    // --- Message Bubbles/Rendering ---
    function addMessage(msg) { messages.push(msg); renderChat(); }
    function renderChat() {
      let chatEl = document.getElementById('chatList');
      chatEl.innerHTML = messages.map((m, idx) => {
        // Add first/last specific margin classes for message bubbles
        let bubClass = (m.from === 'me' ? "msg-bubble msg-me self-end mb-2" : "msg-bubble msg-ai self-start mb-2");
        if (idx === 0) bubClass += " first-message";
        if (idx === messages.length-1) bubClass += " last-message";
        let meta = `<div class="msg-meta">${formatTime(m.ts)}</div>`;
        let imgs = m.images && m.images.length ? '<div class="flex mt-1">' + m.images.map(img => `<img src="${img}" class="kia-image-thumb" />`).join("") + '</div>' : '';
        let voice = m.voice ? `<audio controls src="${URL.createObjectURL(m.voice)}" class="w-full my-2"></audio>` : '';
        let avatar = m.from === 'ai' ? '<img src="logo.png" alt="KIA" class="w-8 h-8 rounded-full mr-2 inline-block align-bottom"/>' : '';
        return `<div class="flex ${m.from==='ai'? 'flex-row': 'flex-row-reverse'} items-end gap-2">
          ${m.from==='ai'? avatar :''}
          <div class="${bubClass}">${m.text||''}${imgs}${voice}${meta}</div>
        </div>`;
      }).join('');
      chatEl.scrollTop = chatEl.scrollHeight;
    }
    function systemMsg(txt){ addMessage({from:'ai',text:"<span style='color:#6366f1;font-weight:700'>"+txt+"</span>",ts:Date.now()}); }
    function showTyping(){
      addMessage({from:'ai',text:'<span class="loading-bounce">KIA is typing...</span>',ts:Date.now()});
    }
    function hideTyping(){ messages = messages.filter(m => !(m.from==='ai'&&m.text.includes('KIA is typing'))); renderChat(); }
    function formatTime(ts){ let d=new Date(ts); return d.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'}); }

    // --- Name Modal Logic ---
    document.getElementById('nameModalInput').addEventListener('keydown', function(e){
      if(e.key==='Enter'){saveNameModal();}
    });

    // --- INIT: Greet & Chat shows name if set
    window.onload = () => {
      if(userName) systemMsg("Hello, "+userName+"! Start your educational chat with KIA.");
      renderChat();
    };
  </script>
</body>
</html>
