<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>OAU Academic Materials | Departments</title>
  <meta name="description" content="Explore OAU Science departments. Find resources and courses for your department!"/>
  <link rel="icon" type="image/png" href="logo.png" />
  <!-- Tailwind CSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/flowbite/2.2.1/flowbite.min.css" rel="stylesheet"/>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/flowbite/2.2.1/flowbite.min.js"></script>
  <style>
    .dept-card {
      position: relative;
      min-height: 180px;
      background-size: cover;
      background-position: center;
      border-radius: 1.25rem;
      overflow: hidden;
      cursor: pointer;
      transition: box-shadow .15s, transform .13s;
    }
    .dept-card:hover, .dept-card:focus {
      transform: translateY(-3px) scale(1.02);
      box-shadow: 0 8px 24px 0 rgba(24,41,89,.13);
      z-index: 2;
    }
    .dept-overlay {
      background: linear-gradient(120deg, rgba(24,41,89,0.62) 0%, rgba(255,199,44,0.40) 100%);
      backdrop-filter: blur(1px);
      position: absolute;
      inset: 0;
    }
    .dept-title { text-shadow: 0 2px 12px rgba(24,41,89,.13); }
    /* Modal styling: fix center + scrollable content */
    #coursesModal {
      position: fixed !important;
      top: 0; left: 0; right: 0; bottom: 0;
      z-index: 9999;
      display: none; /* show with JS */
      align-items: center;
      justify-content: center;
      background: rgba(0,0,0,0.3);
      backdrop-filter: blur(3px);
    }
    #coursesModal.open {
      display: flex !important;
    }
    #coursesModal .modal-content {
      max-height: 82vh;
      overflow-y: auto;
      width: 100%;
      max-width: 500px;
      background: #fff;
      border-radius: 1.5rem;
      padding: 2rem;
      box-shadow: 0 6px 32px #0003;
      position: relative;
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }
    @media (max-width: 600px) {
      #coursesModal .modal-content {
        padding: 1rem;
        max-width: 98vw;
      }
    }
  </style>
</head>
<body class="bg-gray-50 text-gray-900">

<nav class="fixed w-full z-40 glass shadow-sm border-b border-blue-900/30 bg-white/80 backdrop-blur">
  <div class="max-w-7xl mx-auto px-4 flex justify-between items-center h-16">
    <div class="flex items-center gap-2 font-bold text-lg md:text-xl text-yellow-600">
      <img src="logo.png" class="h-8" alt="logo">
      <span class="text-blue-900">OAU</span> <span class="text-yellow-600">Academics</span>
    </div>
    <div class="hidden md:flex space-x-8 font-medium items-center">
      <a href="faculty-materials.html" class="hover:text-yellow-600 transition">Faculties</a>
      <a href="/" class="hover:text-yellow-600 transition">Home</a>
      <span id="navbar-auth"></span>
    </div>
    <button id="hamburger-btn" type="button" class="md:hidden p-2 text-yellow-700" aria-label="Open menu">
      <svg class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
          d="M4 6h16M4 12h16M4 18h16"></path>
      </svg>
    </button>
  </div>
  <div class="md:hidden" id="mobile-menu" hidden>
    <div class="px-4 pb-3 space-y-1">
      <a href="faculty-materials.html" class="block py-2 hover:text-yellow-600">Faculties</a>
      <a href="/" class="block py-2 hover:text-yellow-600">Home</a>
      <span id="mobile-auth"></span>
    </div>
  </div>
</nav>

<main class="pt-28 pb-12 px-2 min-h-screen bg-gradient-to-br from-blue-900/5 via-yellow-50 to-yellow-100">
  <section class="max-w-5xl mx-auto">
    <h1 id="facultyHeader" class="text-3xl md:text-4xl font-extrabold text-yellow-600 text-center mb-2">Faculty Departments</h1>
    <p class="text-center text-gray-700 mb-8 max-w-xl mx-auto">Select your department to view available courses and materials.</p>
    <div id="departmentsGrid" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-8">
      <!-- Dynamic department cards will be injected here -->
    </div>
  </section>

  <!-- Courses Modal -->
  <div id="coursesModal" tabindex="-1" aria-hidden="true">
    <div class="modal-content">
      <button type="button" class="absolute top-5 right-5 text-2xl text-yellow-600 hover:text-blue-900 transition" onclick="closeCoursesModal()">&times;</button>
      <h3 id="deptModalTitle" class="text-xl font-bold mb-3 text-blue-900"></h3>
      <div id="deptModalSubtitle" class="text-gray-700 mb-3 text-base"></div>
      <ul id="deptCoursesList" class="mb-4 space-y-3"></ul>
      <div id="noCoursesMsg" class="text-red-500 font-semibold text-center mt-6 hidden">No courses available for this department yet.</div>
    </div>
  </div>
</main>

<footer class="bg-gray-900 text-gray-300 py-8">
  <div class="max-w-7xl mx-auto px-6 flex flex-col md:flex-row justify-between items-center gap-6">
    <div>
      <span class="font-bold text-white">OAU ExamGuard Nigeria</span>
      <span class="ml-2 text-sm">Academic Materials Portal</span>
    </div>
    <div class="flex gap-4">
      <a href="#" class="hover:text-white">üåê</a>
      <a href="#" class="hover:text-white">üê¶</a>
      <a href="#" class="hover:text-white">üì∏</a>
    </div>
    <div class="text-sm text-gray-500 md:text-right">¬© 2024-2025 ExamGuard Nigeria. All rights reserved.</div>
  </div>
</footer>

<script>
  // Navbar mobile toggle
  document.getElementById('hamburger-btn').addEventListener('click', function() {
    const menu = document.getElementById('mobile-menu');
    menu.hidden = !menu.hidden;
  });

  // Auth buttons (see previous code)
  function renderAuthButtons() {
    const navbarAuth = document.getElementById('navbar-auth');
    const mobileAuth = document.getElementById('mobile-auth');
    if (!navbarAuth || !mobileAuth) return;
    if (localStorage.getItem('token')) {
      navbarAuth.innerHTML =
        `<a href="loader.html" class="ml-6 bg-blue-900 text-white px-5 py-2 rounded-full font-semibold hover:bg-yellow-600 hover:text-blue-900 transition">Dashboard</a>`;
      mobileAuth.innerHTML =
        `<a href="loader.html" class="block mt-4 w-full text-center bg-blue-900 text-white px-5 py-2 rounded-full font-semibold hover:bg-yellow-600 hover:text-blue-900 transition">Dashboard</a>`;
    } else {
      navbarAuth.innerHTML =
        `<a href="mock.html" class="ml-6 bg-blue-900 text-white px-5 py-2 rounded-full font-semibold hover:bg-yellow-600 hover:text-blue-900 transition">Login</a>
         <a href="mock.html" class="ml-2 bg-yellow-500 text-blue-900 px-5 py-2 rounded-full font-semibold hover:bg-blue-900 hover:text-yellow-400 transition">Sign Up</a>`;
      mobileAuth.innerHTML =
        `<a href="mock.html#loginForm" class="block mt-4 w-full text-center bg-blue-900 text-white px-5 py-2 rounded-full font-semibold hover:bg-yellow-600 hover:text-blue-900 transition">Login</a>
         <a href="mock.html#registerForm" class="block mt-2 w-full text-center bg-yellow-500 text-blue-900 px-5 py-2 rounded-full font-semibold hover:bg-blue-900 hover:text-yellow-400 transition">Sign Up</a>`;
    }
  }
  document.addEventListener('DOMContentLoaded', renderAuthButtons);

  // Get faculty slug from the URL (?faculty=science)
  function getFacultySlug() {
    const params = new URLSearchParams(window.location.search);
    return params.get('faculty') || 'science';
  }

  // Converts slug to display name (Science => Faculty of Science)
  function facultySlugToName(slug) {
    // You can extend this for other faculties
    const map = {
      science: "Faculty of Science",
      arts: "Faculty of Arts",
      law: "Faculty of Law",
      "social-sciences": "Faculty of Social Sciences",
      technology: "Faculty of Technology",
      "health-sciences": "Faculty of Health Sciences"
    };
    if (map[slug.toLowerCase()]) return map[slug.toLowerCase()];
    // Fallback to capitalized slug
    return "Faculty of " + slug.charAt(0).toUpperCase() + slug.slice(1).replace(/-/g, " ");
  }

  // Dynamic department loading for faculty in URL
  async function loadDepartments() {
    const facultySlug = getFacultySlug();
    document.getElementById("facultyHeader").textContent = facultySlugToName(facultySlug) + " Departments";
    // Fetch all faculties, find the matching one
    let facultyId = null;
    try {
      const facultiesRes = await fetch('https://examguard-jmvj.onrender.com/api/faculties');
      const faculties = await facultiesRes.json();
      // Match by slug or name contains
      let faculty = faculties.find(f => {
  // Normalize both values for comparison
  const normalizedName = f.name.trim().toLowerCase().replace(/[\s\-]+/g,'');
  const normalizedSlug = facultySlug.trim().toLowerCase().replace(/[\s\-]+/g,'');

  // Only match if name equals or ends with the slug (not just contains it)
  return normalizedName === normalizedSlug ||
    normalizedName.endsWith(normalizedSlug) ||
    normalizedName === "facultyof" + normalizedSlug;
});

// If not found, try a strict match with spaces
if (!faculty) {
  faculty = faculties.find(f => {
    // e.g. "Faculty of Science" === "Faculty of Science"
    return f.name.trim().toLowerCase() === ("faculty of " + facultySlug.trim().toLowerCase());
  });
}
      if (!faculty) {
        document.getElementById("departmentsGrid").innerHTML = `<div class="col-span-3 text-center text-red-500 font-semibold py-12">Faculty not found.</div>`;
        return;
      }
      facultyId = faculty._id;
    } catch (e) {
      document.getElementById("departmentsGrid").innerHTML = `<div class="col-span-3 text-center text-red-500 font-semibold py-12">Error loading faculties.</div>`;
      return;
    }
    // Fetch only departments for the selected faculty
    try {
      const res = await fetch('https://examguard-jmvj.onrender.com/api/departments?faculty=' + facultyId);
      const departments = await res.json();
      const grid = document.getElementById("departmentsGrid");
      grid.innerHTML = "";
      if (!departments.length) {
        grid.innerHTML = `<div class="col-span-3 text-center text-red-500 font-semibold py-12">No departments found for this faculty.</div>`;
        return;
      }
      departments.forEach(dept => {
        grid.innerHTML += `
          <div class="dept-card" tabindex="0"
            style="background-image:url('${dept.backgroundImage || "https://images.unsplash.com/photo-1465101046530-73398c7f28ca?auto=format&fit=crop&w=600&q=80"}');"
            onclick="showCourses('${dept._id}')">
            <div class="dept-overlay"></div>
            <div class="relative z-10 p-5 text-white text-center">
              <h2 class="dept-title text-xl font-bold mb-1">${dept.name}</h2>
              <p class="text-sm">${dept.subtitle || ""}</p>
            </div>
          </div>
        `;
      });
    } catch (e) {
      document.getElementById("departmentsGrid").innerHTML = `<div class="col-span-3 text-center text-red-500 font-semibold py-12">Error loading departments.</div>`;
    }
  }

  // Show courses modal (fixed: now always loads department courses on click)
  async function showCourses(deptId) {
    try {
      const res = await fetch(`https://examguard-jmvj.onrender.com/api/departments/${deptId}`);
      if (!res.ok) throw new Error("Department not found");
      const dept = await res.json();
      document.getElementById('coursesModal').classList.add('open');
      document.getElementById('deptModalTitle').textContent = dept.name + " Courses";
      document.getElementById('deptModalSubtitle').textContent = dept.subtitle || "";
      const listEl = document.getElementById('deptCoursesList');
      listEl.innerHTML = '';
      document.getElementById('noCoursesMsg').style.display = 'none';
      if (!dept.courses || !dept.courses.length) {
        document.getElementById('noCoursesMsg').style.display = '';
        return;
      }
      dept.courses.forEach(c => {
        // Each course clickable, redirects to course page (e.g. course-materials.html?course=COURSECODE)
        const courseUrl = `course-materials.html?course=${encodeURIComponent(c)}`;
        listEl.innerHTML += `<li>
          <a href="${courseUrl}" class="block bg-blue-50 px-4 py-2 rounded text-blue-900 font-semibold hover:bg-yellow-100 hover:text-blue-700 transition">
            ${c}
          </a>
        </li>`;
      });
    } catch (e) {
      // Show error in modal if needed
      document.getElementById('deptCoursesList').innerHTML = `<div class="text-red-500 font-semibold">Could not load courses for department.</div>`;
      document.getElementById('noCoursesMsg').style.display = 'none';
      document.getElementById('coursesModal').classList.add('open');
    }
  }
  function closeCoursesModal() {
    document.getElementById('coursesModal').classList.remove('open');
  }

  // Close modal on outside click
  document.getElementById('coursesModal').addEventListener('click', function(e){
    if(e.target === this) closeCoursesModal();
  });

  document.addEventListener("DOMContentLoaded", loadDepartments);
</script>
</body>
</html>
