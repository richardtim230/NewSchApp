<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Admin Dashboard | CBT Platform</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Inter:400,500,700&display=swap">
  <link rel="icon" href="logo.png">
  <link rel="stylesheet" href="./admin.css">
  <style>

  .data-table img {
  max-width: 60px;
  max-height: 60px;
  border-radius: 4px;
}
    .section-loader {
  position: absolute;
  top: 0; left: 0; right: 0; bottom: 0;
  z-index: 10;
  background: rgba(255,255,255,0.7);
  display: flex;
  align-items: center;
  justify-content: center;
}
.spinner {
  width: 36px; height: 36px;
  border: 4px solid #ffe066;
  border-top: 4px solid #3a86ff;
  border-radius: 50%;
  animation: spin 0.7s linear infinite;
}
@keyframes spin { 100% { transform: rotate(360deg); } }
.section { position: relative; }
  </style>
</head>
<body>
  <!-- Sidebar -->
  <nav class="sidebar" id="sidebar">
    <div class="sidebar-header">
      <img src="logo.png" alt="CBT Logo">
      <span class="brand">CBT Admin</span>
    </div>
    <div class="sidebar-nav">
      <a href="#dashboard" class="active" onclick="showSection('dashboard', this)"><span>üè†</span> Dashboard</a>
      <a href="#faculty" onclick="showSection('faculty', this)"><span>üè¢</span> Faculties & Departments</a>
      <a href="#sets" onclick="showSection('sets', this)"><span>üìö</span> Question Sets</a>
      <a href="#questions" onclick="showSection('questions', this)"><span>‚úèÔ∏è</span> Questions</a>
      <a href="#results" onclick="showSection('results', this)"><span>üìä</span> Results</a>
      <a href="#schedules" onclick="showSection('schedules', this)"><span>‚è∞</span> Schedules</a>
      <a href="#notifications" onclick="showSection('notifications', this)"><span>‚úâÔ∏è</span> Messaging</a>
      <a href="#students" onclick="showSection('students', this)"><span>üë•</span> Students</a>
      <a href="#uploaders" onclick="showSection('uploaders', this)"><span>üë•</span> Uploaders</a>
      <a href="#forms" onclick="showSection('forms', this)"><span>üìù</span> Forms</a>
    </div>
    <div class="sidebar-footer">
      <span style="font-size:1.05em;">Admin</span><br>
      <a href="#" onclick="logout()" style="color:#ffe066; text-decoration:underline;font-size:0.97em;">Logout</a>
    </div>
  </nav>
  <!-- Main content -->
  <div class="main-content" id="mainContent">
    <!-- Topbar -->
    <div class="topbar">
      <span class="page-title" id="pageTitle">Dashboard</span>
      <div class="admin-avatar">
        <img src="admin.png" alt="Admin">
        <span id="adminName">Admin</span>
      </div>
    </div>
    <!-- Dashboard Cards -->
    <div class="dashboard-cards" id="dashboardCards">
      <div class="dashboard-card">
        <div class="card-label">Question Sets</div>
        <div class="card-value" id="qSetCount">0</div>
        <div class="card-icon">üìö</div>
      </div>
      <div class="dashboard-card">
        <div class="card-label">Questions</div>
        <div class="card-value" id="questionCount">0</div>
        <div class="card-icon">‚úèÔ∏è</div>
      </div>
      <div class="dashboard-card">
        <div class="card-label">Total Results</div>
        <div class="card-value" id="resultCount">0</div>
        <div class="card-icon">üìä</div>
      </div>
      <div class="dashboard-card">
        <div class="card-label">Scheduled Tests</div>
        <div class="card-value" id="scheduleCount">0</div>
        <div class="card-icon">‚è∞</div>
      </div>
    
      <div class="dashboard-card">
        <div class="card-label">Students</div>
        <div class="card-value" id="studentCount">0</div>
        <div class="card-icon">üë•</div>
      </div>
      <!-- Add the following in your dashboard card section: -->
<div class="dashboard-card">
  <div class="card-label">Question Uploaders</div>
  <div class="card-value" id="uploadersCount">0</div>
  <div class="card-icon">üì§</div>
</div>

<!-- ...existing HTML... -->
    </div><!-- ...rest of your HTML above... -->

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<div class="dashboard-analytics" style="margin: 40px 0;">
  <div style="display:flex; gap:40px; flex-wrap:wrap;">
    <!-- Results Analytics -->
    <div style="flex:1; min-width:300px; background:#fff; border-radius:12px; box-shadow:0 2px 10px #0001; padding:24px;">
      <h3 style="margin-bottom:16px;">Results Analytics</h3>
      <canvas id="resultsChart" height="120"></canvas>
    </div>
    <!-- Performance Analytics -->
    <div style="flex:1; min-width:300px; background:#fff; border-radius:12px; box-shadow:0 2px 10px #0001; padding:24px;">
      <h3 style="margin-bottom:16px;">Performance Analytics</h3>
      <canvas id="performanceChart" height="120"></canvas>
    </div>
    <!-- Registration Analytics -->
    <div style="flex:1; min-width:300px; background:#fff; border-radius:12px; box-shadow:0 2px 10px #0001; padding:24px;">
      <h3 style="margin-bottom:16px;">Registration Analytics</h3>
      <canvas id="registrationChart" height="120"></canvas>
    </div>
  </div>
</div>

<div class="section" id="dashboardSection" style="position: relative;">
  <div class="section-loader" style="display:none;"><div class="spinner"></div></div>
  <div class="section-title">Welcome, Admin!</div>
  <p>Use the navigation to manage question sets, upload and edit questions, view results, schedule tests, and communicate with students.</p>
</div>

<div class="section" id="facultySection" style="display:none; position: relative;">
  <div class="section-loader" style="display:none;"><div class="spinner"></div></div>
  <div class="section-title">Faculties & Departments</div>
  <div class="actions">
    <button class="btn" onclick="openModal('addFacultyModal')">+ Add Faculty</button>
    <button class="btn" onclick="openModal('addDepartmentModal')">+ Add Department</button>
  </div>
  <div style="margin-bottom:24px;">
    <b>Faculties:</b>
    <ul id="facultyList"></ul>
  </div>
  <div>
    <b>Departments:</b>
    <ul id="departmentList"></ul>
  </div>
</div>

<div class="section" id="setsSection" style="display:none; position: relative;">
  <div class="section-loader" style="display:none;"><div class="spinner"></div></div>
  <div class="section-title">Question Sets</div>
  <div class="actions">
    <button class="btn" onclick="openModal('addSetModal')">+ New Set</button>
  </div>
  <table class="data-table" id="setsTable">
    <thead>
      <tr>
        <th>Title</th><th>Faculty</th><th>Department</th><th>Status</th><th>Questions</th><th>Actions</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>
<!-- Notification management with Quill rich editor, Cloudinary-backed image upload, and announcement table/list -->
<!-- Place this in your admin dashboard notifications section. -->

<link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
<script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>

<style>
.announcement-form {
  background: #fff;
  border-radius: 14px;
  box-shadow: 0 2px 10px #0001;
  padding: 24px;
  max-width: 540px;
  margin: 0 auto 32px auto;
}
.announcement-form h3 {
  margin-top: 0;
  color: #276EF1;
  font-size: 1.3rem;
}
.announcement-form label {
  font-weight: 600;
  margin-bottom: 6px;
  display: block;
}
.announcement-form input[type="text"] {
  width: 100%;
  padding: .6em .8em;
  border: 1.5px solid #d6e0ef;
  border-radius: 8px;
  font-size: 1rem;
  margin-bottom: 1em;
}
#quillEditor {
  height: 180px;
  margin-bottom: 18px;
}
.announcement-form .img-preview {
  margin: 8px 0 14px 0;
  max-width: 100%;
  max-height: 180px;
  border-radius: 8px;
  box-shadow: 0 2px 10px #0001;
  display: none;
}
.announcement-form .img-preview.active { display: block; }
.announcement-form .upload-progress {
  height: 4px;
  background: #276EF1;
  margin-bottom: 10px;
  border-radius: 2px;
  width: 0;
  transition: width 0.3s;
}
</style>



<div id="modalRoot"></div>

<script>
const API_URL = "https://examguide.onrender.com/api/";
const BACKEND_URL = "https://examguide.onrender.com";
const token = localStorage.getItem("token");

// ====== QUILL EDITOR INIT WITH IMAGE HANDLER ======
const quill = new Quill('#quillEditor', {
  theme: 'snow',
  placeholder: 'Type your announcement message...',
  modules: {
    toolbar: {
      container: [
        [{ header: [1, 2, false] }],
        ['bold', 'italic', 'underline', 'strike'],
        ['blockquote', 'code-block'],
        [{ list: 'ordered' }, { list: 'bullet' }],
        ['link', 'image'],
        ['clean']
      ],
      handlers: {
        'image': async function() {
          const input = document.createElement('input');
          input.setAttribute('type', 'file');
          input.setAttribute('accept', 'image/*');
          input.click();
          input.onchange = async () => {
            const file = input.files[0];
            if (!file) return;
            const fd = new FormData();
            fd.append('image', file);
            try {
              const resp = await fetch(API_URL + "images", {
                method: 'POST',
                body: fd,
                headers: {
                  'Authorization': 'Bearer ' + (token || ''),
                }
              });
              const data = await resp.json();
              if (resp.ok && data.url) {
                const range = quill.getSelection();
                quill.insertEmbed(range.index, 'image', data.url);
              } else {
                alert('Image upload failed: ' + (data.error || data.message));
              }
            } catch (e) {
              alert('Image upload error');
            }
          };
        }
      }
    }
  }
});

// ====== MAIN ANNOUNCEMENT IMAGE (OUTSIDE EDITOR) UPLOAD ======
const announcementImage = document.getElementById('announcementImage');
const imgPreview = document.getElementById('imgPreview');
const imgUploadProgress = document.getElementById('imgUploadProgress');
let uploadedImageUrl = "";

announcementImage.addEventListener('change', async function () {
  imgPreview.style.display = "none";
  imgUploadProgress.style.width = "0";
  uploadedImageUrl = "";

  const file = this.files[0];
  if (!file) return;

  // Show preview
  const reader = new FileReader();
  reader.onload = function(e) {
    imgPreview.src = e.target.result;
    imgPreview.classList.add("active");
    imgPreview.style.display = "block";
  };
  imgPreview.src = "";
  imgPreview.classList.remove("active");
  reader.readAsDataURL(file);

  // Upload to /api/images
  const fd = new FormData();
  fd.append('image', file);

  imgUploadProgress.style.width = "0";
  imgUploadProgress.style.background = "#276EF1";
  imgUploadProgress.style.display = "block";

  const xhr = new XMLHttpRequest();
  xhr.open('POST', API_URL + 'images', true);
  xhr.setRequestHeader('Authorization', 'Bearer ' + (token || ''));

  xhr.upload.onprogress = function(e) {
    if (e.lengthComputable) {
      const percent = Math.round((e.loaded / e.total) * 100);
      imgUploadProgress.style.width = percent + "%";
    }
  };
  xhr.onload = function() {
    if (xhr.status === 200) {
      const res = JSON.parse(xhr.responseText);
      uploadedImageUrl = res.url;
      imgUploadProgress.style.width = "100%";
      imgUploadProgress.style.background = "#27ae60";
    } else {
      imgUploadProgress.style.background = "#e74c3c";
      document.getElementById("announcementStatus").textContent = "Image upload failed!";
      uploadedImageUrl = "";
    }
  };
  xhr.onerror = function() {
    imgUploadProgress.style.background = "#e74c3c";
    document.getElementById("announcementStatus").textContent = "Image upload failed!";
    uploadedImageUrl = "";
  };
  xhr.send(fd);
});

// ====== SEND NEW ANNOUNCEMENT ======
document.getElementById('sendAnnouncementBtn').onclick = async function () {
  const title = document.getElementById('announcementTitle').value.trim();
  const content = quill.root.innerHTML.trim();
  const imageUrl = uploadedImageUrl;

  const statusEl = document.getElementById("announcementStatus");
  statusEl.textContent = "";
  statusEl.style.color = "#222";
  if (!title || !content) {
    statusEl.textContent = "Title and message required!";
    statusEl.style.color = "#e74c3c";
    return;
  }
  if (!imageUrl) {
    statusEl.textContent = "Upload an image before sending.";
    statusEl.style.color = "#e74c3c";
    return;
  }

  this.disabled = true;
  statusEl.textContent = "Sending...";
  statusEl.style.color = "#276EF1";

  try {
    const resp = await fetch(API_URL + "notifications", {
      method: "POST",
      headers: { "Content-Type": "application/json", Authorization: "Bearer " + (token || "") },
      body: JSON.stringify({ title, content, image: imageUrl })
    });
    const data = await resp.json();
    if (resp.ok) {
      statusEl.textContent = "Announcement sent!";
      statusEl.style.color = "#27ae60";
      document.getElementById('announcementTitle').value = "";
      quill.root.innerHTML = "";
      uploadedImageUrl = "";
      imgPreview.style.display = "none";
      imgUploadProgress.style.width = "0";
      fetchNotifications();
    } else {
      statusEl.textContent = data.message || "Failed to send announcement.";
      statusEl.style.color = "#e74c3c";
    }
  } catch (e) {
    statusEl.textContent = "Error sending announcement.";
    statusEl.style.color = "#e74c3c";
  }
  this.disabled = false;
};

// ====== FETCH & DISPLAY ANNOUNCEMENTS ======
async function fetchNotifications() {
  const resp = await fetch(API_URL + "notifications", { headers: { Authorization: "Bearer " + token } });
  const notifs = await resp.json();
  let html = "";
  notifs.forEach(n => {
    html += `<tr>
      <td>${n.title}</td>
      <td>
        <div style="max-width:260px;max-height:80px;overflow:auto;font-size:.97em;">
          ${n.content ? n.content : n.message}
        </div>
      </td>
      <td>${
        n.image || n.imageUrl
          ? `<img src="${(n.image || n.imageUrl).startsWith('http') ? (n.image || n.imageUrl) : BACKEND_URL + (n.image || n.imageUrl)}" alt="img" style="max-width:60px;max-height:60px;border-radius:4px;">`
          : ""
      }</td>
      <td>${n.createdAt ? (new Date(n.createdAt)).toLocaleString() : ""}</td>
      <td>
        <button class="action-btn" onclick="editNotif('${n._id}')">Edit</button>
        <button class="action-btn" onclick="deleteNotif('${n._id}')">Delete</button>
      </td>
    </tr>`;
  });
  document.querySelector("#notificationsTable tbody").innerHTML = html;
}
if (document.querySelector("#notificationsTable")) fetchNotifications();

async function deleteNotif(id) {
  if (!confirm("Delete this message?")) return;
  const resp = await fetch(API_URL + "notifications/" + id, {
    method: "DELETE",
    headers: { Authorization: "Bearer " + token }
  });
  if (!resp.ok) {
    const data = await resp.json();
    alert(data.message || "Failed to delete.");
  }
  fetchNotifications();
}

// ====== EDIT NOTIFICATION (MODAL WITH QUILL & IMAGE UPLOAD) ======
async function editNotif(id) {
  const resp = await fetch(API_URL + "notifications/" + id, { headers: { Authorization: "Bearer " + token } });
  if (!resp.ok) { alert("Could not load message."); return; }
  const n = await resp.json();
  const existingImage = n.image || n.imageUrl || "";
  let html = `
    <div class="modal-backdrop" onclick="closeModal(event)">
      <div class="modal" onclick="event.stopPropagation()" style="max-width:540px;">
        <button class="close-modal" onclick="closeModal(event)">&times;</button>
        <h2>Edit Announcement</h2>
        <label>Title</label>
        <input id="editNotifTitle" type="text" maxlength="100" value="${n.title || ""}">
        <label>Message</label>
        <div id="editNotifQuill" style="height:140px;"></div>
        <label>Image (Leave blank to keep current)</label>
        <input id="editNotifImg" type="file" accept="image/*">
        ${existingImage ? `<img src="${existingImage.startsWith('http') ? existingImage : BACKEND_URL + existingImage}" style="max-width:80px;display:block;margin:5px 0">` : ""}
        <span id="editNotifMsgEl"></span>
        <span class="spinner" id="editNotifSpinner" style="display:none"></span>
        <button class="btn" onclick="submitEditNotif('${n._id}')">Save</button>
      </div>
    </div>`;
  document.getElementById("modalRoot").innerHTML = html;

  // Init Quill for edit modal
  const editQuill = new Quill('#editNotifQuill', {
    theme: 'snow',
    modules: {
      toolbar: [
        [{ header: [1, 2, false] }],
        ['bold', 'italic', 'underline', 'strike'],
        [{ list: 'ordered' }, { list: 'bullet' }],
        ['link', 'image'],
        ['clean']
      ]
    }
  });
  editQuill.root.innerHTML = n.content || n.message || "";

  // Custom image upload handler for Quill in edit modal
  editQuill.getModule('toolbar').addHandler('image', async function() {
    const input = document.createElement('input');
    input.setAttribute('type', 'file');
    input.setAttribute('accept', 'image/*');
    input.click();
    input.onchange = async () => {
      const file = input.files[0];
      if (!file) return;
      const fd = new FormData();
      fd.append('image', file);
      try {
        const resp = await fetch(API_URL + "images", {
          method: 'POST',
          body: fd,
          headers: {
            'Authorization': 'Bearer ' + (token || ''),
          }
        });
        const data = await resp.json();
        if (resp.ok && data.url) {
          const range = editQuill.getSelection();
          editQuill.insertEmbed(range.index, 'image', data.url);
        } else {
          alert('Image upload failed: ' + (data.error || data.message));
        }
      } catch (e) {
        alert('Image upload error');
      }
    };
  });

  // Save handler
  window.submitEditNotif = async function(notifId) {
    const title = document.getElementById("editNotifTitle").value.trim();
    const content = editQuill.root.innerHTML.trim();
    const fileInput = document.getElementById("editNotifImg");
    let imageUrl = existingImage;

    const msgEl = document.getElementById("editNotifMsgEl");
    msgEl.innerText = "";
    msgEl.style.color = "#e74c3c";

    if (!title || !content) {
      msgEl.innerText = "Title and message required!";
      return;
    }

    // If a new image is selected, upload it
    if (fileInput && fileInput.files && fileInput.files[0]) {
      const fd = new FormData();
      fd.append('image', fileInput.files[0]);
      try {
        const imgResp = await fetch(API_URL + "images", {
          method: "POST",
          body: fd,
          headers: {
            'Authorization': 'Bearer ' + (token || ''),
          }
        });
        const imgData = await imgResp.json();
        if (imgResp.ok && imgData.url) {
          imageUrl = imgData.url;
        } else {
          msgEl.innerText = "Image upload failed: " + (imgData.error || imgData.message);
          return;
        }
      } catch (e) {
        msgEl.innerText = "Image upload error";
        return;
      }
    }

    document.getElementById("editNotifSpinner").style.display = "inline-block";
    try {
      const resp = await fetch(API_URL + "notifications/" + notifId, {
        method: "PUT",
        headers: { "Content-Type": "application/json", Authorization: "Bearer " + (token || "") },
        body: JSON.stringify({ title, content, image: imageUrl })
      });
      const data = await resp.json();
      document.getElementById("editNotifSpinner").style.display = "none";
      if (resp.ok) {
        msgEl.innerText = "Saved!";
        msgEl.style.color = "#27ae60";
        setTimeout(() => {
          closeModal();
          fetchNotifications();
        }, 700);
      } else {
        msgEl.innerText = data.message || "Failed to save.";
      }
    } catch (e) {
      document.getElementById("editNotifSpinner").style.display = "none";
      msgEl.innerText = "Error saving.";
    }
  }
}

function closeModal(e) {
  if (!e || e.target.classList.contains('modal-backdrop') || e.target.classList.contains('close-modal')) {
    document.getElementById("modalRoot").innerHTML = "";
  }
}
</script>
<!-- Add the following section for managing uploaders (add after other admin sections): -->
<div class="section" id="uploadersSection" style="display:none;">
  <div class="section-title">Manage Question Uploaders</div>
  <div class="actions">
    <button class="btn" onclick="showUploaderModalWithData()">+ Add Uploader</button>
  </div>
  <table class="data-table" id="uploadersTable">
    <thead>
      <tr>
        <th>Full Name</th>
        <th>Username</th>
        <th>Email</th>
        <th>Faculty</th>
        <th>Department</th>
        <th>Status</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>
<div id="uploaderModalRoot"></div>
<!-- ...existing HTML... -->
<div class="section" id="questionsSection" style="display:none; position: relative;">
  <div class="section-loader" style="display:none;"><div class="spinner"></div></div>
  <div class="section-title">Manage Questions</div>
  <div class="actions">
    <button class="btn" onclick="openModal('addQuestionModal')">+ Add Question</button>
    <button class="btn" onclick="openModal('bulkUploadModal')">Bulk Upload</button>
  </div>
  <div>
    <label for="qSetSelect">Question Set:</label>
    <select id="qSetSelect" onchange="fetchQuestions()"></select>
  </div>
  <table class="data-table" id="questionsTable">
    <thead>
      <tr>
        <th>Question</th><th>Options</th><th>Answer</th><th>Actions</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<div class="section" id="resultsSection" style="display:none; position: relative;">
  <div class="section-loader" style="display:none;"><div class="spinner"></div></div>
  <div class="section-title">Results</div>
  <table class="data-table" id="resultsTable">
    <thead>
      <tr>
        <th>Student</th><th>Set</th><th>Score</th><th>Submitted</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>
<div class="section" id="formsSection" style="display:none; position: relative;">
  <div class="section-loader" style="display:none;"><div class="spinner"></div></div>
  <div class="section-title">Manage Custom Forms</div>
  <div class="actions">
    <button class="btn" onclick="openFormBuilderModal()">+ Create Form</button>
  </div>
  <table class="data-table" id="formsTable">
    <thead>
      <tr>
        <th>Title</th>
        <th>Created</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>
<div id="formModalRoot"></div>

<!-- Schedules Table: updated column header and row rendering to include Levels -->
<div class="section" id="schedulesSection" style="display:none; position: relative;">
  <div class="section-loader" style="display:none;"><div class="spinner"></div></div>
  <div class="section-title">Test Schedules</div>
  <div class="actions">
    <button class="btn" onclick="openModal('addScheduleModal')">+ Schedule Test</button>
  </div>
  <table class="data-table" id="schedulesTable">
    <thead>
      <tr>
        <th>Set</th>
        <th>Faculty</th>
        <th>Departments</th>
        <th>Levels</th> <!-- NEW COLUMN -->
        <th>Start</th>
        <th>End</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>


<div class="section" id="notificationsSection" style="display:none; position: relative;">
<div class="section-loader" style="display:none;"><div class="spinner"></div></div>
<div class="section-title">Announcements / Notifications</div>

<!-- Modern announcement form (see previous replies for full form & script) -->
<div class="announcement-form" id="announcementFormSection">
  <h3>New Announcement</h3>
  <label for="announcementTitle">Title</label>
  <input type="text" id="announcementTitle" maxlength="100" placeholder="Enter announcement title" required>

  <label>Image</label>
  <input type="file" id="announcementImage" accept="image/*">
  <img class="img-preview" id="imgPreview" alt="Announcement Image Preview">
  <div class="upload-progress" id="imgUploadProgress"></div>

  <label>Message</label>
  <div id="quillEditor"></div>

  <button class="btn" id="sendAnnouncementBtn" style="margin-top:16px;">Send Announcement</button>
  <span id="announcementStatus" style="margin-left:16px;font-weight:500;"></span>
</div>

<table class="data-table" id="notificationsTable">
  <thead>
    <tr>
      <th>Title</th>
      <th>Message</th>
      <th>Image</th>
      <th>Sent</th>
      <th>Actions</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>
  <div class="section-title">Broadcasts History</div>
<div class="actions">
  <button class="btn" onclick="openBroadcastModal()">+ Broadcast Message</button>
</div>
<table class="data-table" id="broadcastsTable">
  <thead>
    <tr>
      <th>Title</th>
      <th>Type</th>
      <th>Message</th>
      <th>Image</th>
      <th>Link</th>
      <th>Sent</th>
      <th>Actions</th>
    </tr>
  </thead>
  <tbody></tbody>
          </table>
</div>

<div class="section" id="studentsSection" style="display:none; position: relative;">
  <div class="section-loader" style="display:none;"><div class="spinner"></div></div>
  <div class="section-title">Manage Students</div>
  <table class="data-table" id="studentsTable">
    <thead>
      <tr>
        <th>Name</th><th>Username</th><th>Faculty</th><th>Department</th><th>Status</th><th>Actions</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>
    <!-- Include this modal div near your root (e.g. at the end of <body>) -->
<div id="formBuilderModal" class="modal-backdrop" style="display:none;" onclick="if(event.target===this)closeFormBuilderModal()">
  <div class="modal" onclick="event.stopPropagation()" style="max-width:820px;">
    <button class="close-modal" onclick="closeFormBuilderModal()">&times;</button>
    <div style="margin-bottom:16px;">
      <input id="fbFormTitle" placeholder="Untitled form" style="font-size:2em;font-weight:600;width:99%;border:none;background:transparent;">
      <input id="fbFormDesc" placeholder="Form description" style="font-size:1em;width:99%;border:none;background:transparent;">
    </div>
    <div id="fbQuestions"></div>
    <button class="btn" onclick="addFBQuestion()" style="margin:10px 0;">+ Add Question</button>
    <div style="margin-top:20px;">
      <button class="btn" onclick="saveFBForm()">Save Form</button>
      <span id="fbFormMsg" style="margin-left:12px;font-weight:bold;"></span>
    </div>
  </div>
</div>

<style>
/* Minimal style to match your admin dashboard */
#fbQuestions .fb-q-card { background:#fcfcff; border:2px solid #c3c6ff; border-radius:8px; margin:18px 0; padding:20px 16px 8px 16px; box-shadow:0 1px 3px #0002; position:relative;}
#fbQuestions .fb-q-toolbar { position:absolute; right:16px; top:14px; }
#fbQuestions input.fb-q-label { font-size:1.15em; font-weight:500; width:60%; border:none; background:transparent;}
#fbQuestions select.fb-q-type { font-size:1em; margin-left:14px;}
#fbQuestions .fb-q-options input { margin:2px 6px 2px 0; }
#fbQuestions .fb-q-options .fb-q-opt-row { display:flex; align-items:center; margin:2px 0;}
#fbQuestions .fb-q-options .fb-q-opt-row input { width:70%; }
#fbQuestions .fb-q-options button { margin-left:6px;}
#fbQuestions .fb-q-required { margin-left:18px;}
</style>
  <div id="modalRoot"></div>
    <button class="nav-toggle" id="navToggle" aria-label="Open navigation" onclick="toggleSidebar()">
      <svg width="32" height="32" viewBox="0 0 32 32" fill="none">
        <rect y="6" width="32" height="3.5" rx="1.7" fill="#111"/>
        <rect y="14" width="32" height="3.5" rx="1.7" fill="#111"/>
        <rect y="22" width="32" height="3.5" rx="1.7" fill="#111"/>
      </svg>
    </button>
  <script>
<!-- PATCH: Robust API error handling, correct array checks, and fallback "0" for dashboard counts -->

<!-- Find your existing dashboard count code and replace with the following: -->


    
    // ========== CONFIG ==========
    const API_URL = "https://examguide.onrender.com/api/";
    const token = localStorage.getItem("token");

      // ========== Faculties & Departments ==========
    let faculties = [];
    let departments = [];
    async function fetchFaculties() {
      const resp = await fetch(API_URL + "faculties", { headers: { Authorization: "Bearer " + token } });
      faculties = await resp.json();
      document.getElementById("facultyList").innerHTML = faculties.map(f => 
        `<li>
          ${f.name} 
          <button class="action-btn" onclick="editFaculty('${f._id}')">Edit</button>
          <button class="action-btn" onclick="deleteFaculty('${f._id}')">Delete</button>
        </li>`).join('');
    }
    async function fetchDepartments() {
      const resp = await fetch(API_URL + "departments", { headers: { Authorization: "Bearer " + token } });
      departments = await resp.json();
      document.getElementById("departmentList").innerHTML = departments.map(d => 
        `<li>
          ${d.name} <span style="color:#888">(Faculty: ${getFacultyName(d.faculty)})</span>
          <button class="action-btn" onclick="editDepartment('${d._id}')">Edit</button>
          <button class="action-btn" onclick="deleteDepartment('${d._id}')">Delete</button>
        </li>`).join('');
    }
    function getFacultyName(facultyId) {
      const f = faculties.find(f => f._id === facultyId);
      return f ? f.name : "";
    }
function getDepartmentName(departmentId) {
  const d = departments.find(dep => dep._id === departmentId);
  return d ? d.name : "";
}
/* --- Utility to get department names for array --- */
function getDepartmentsNames(deptIds) {
  if (!Array.isArray(deptIds)) deptIds = deptIds ? [deptIds] : [];
  return deptIds.map(getDepartmentName).join(", ");
    }
    
    // EDIT FACULTY
    function editFaculty(id) {
      const faculty = faculties.find(f => f._id === id);
      if (!faculty) return;
      let html = `
        <div class="modal-backdrop" onclick="closeModal(event)">
          <div class="modal" onclick="event.stopPropagation()" style="max-width:400px;">
            <button class="close-modal" onclick="closeModal(event)">&times;</button>
            <h2>Edit Faculty</h2>
            <label>Faculty Name</label>
            <input id="editFacultyName" type="text" maxlength="64" value="${faculty.name}">
            <span id="editFacultyMsg"></span>
            <span class="spinner" id="editFacultySpinner" style="display:none"></span>
            <button class="btn" onclick="submitEditFaculty('${faculty._id}')">Save</button>
          </div>
        </div>`;
      document.getElementById("modalRoot").innerHTML = html;
    }
    async function submitEditFaculty(id) {
      const name = document.getElementById("editFacultyName").value.trim();
      const msg = document.getElementById("editFacultyMsg");
      const spinner = document.getElementById("editFacultySpinner");
      msg.innerText = "";
      msg.className = "";
      if (!name) { msg.innerText = "Faculty name required!"; msg.className = "error-msg"; return; }
      spinner.style.display = "inline-block";
      const resp = await fetch(API_URL + "faculties/" + id, {
        method: "PUT",
        headers: { "Content-Type": "application/json", Authorization: "Bearer " + token },
        body: JSON.stringify({ name })
      });
      spinner.style.display = "none";
      if (!resp.ok) {
        const data = await resp.json();
        msg.innerText = data.message || "Failed to edit faculty.";
        msg.className = "error-msg";
        return;
      }
      msg.innerText = "Faculty updated!";
      msg.className = "success-msg";
      setTimeout(() => {
        fetchFaculties();
        closeModal();
      }, 900);
    }
    // DELETE FACULTY
    async function deleteFaculty(id) {
      if (!confirm("Delete this faculty?")) return;
      const resp = await fetch(API_URL + "faculties/" + id, {
        method: "DELETE",
        headers: { Authorization: "Bearer " + token }
      });
      if (!resp.ok) {
        const data = await resp.json();
        alert(data.message || "Failed to delete faculty.");
      }
      fetchFaculties();
    }

    // EDIT DEPARTMENT
    function editDepartment(id) {
      const department = departments.find(d => d._id === id);
      if (!department) return;
      let html = `
        <div class="modal-backdrop" onclick="closeModal(event)">
          <div class="modal" onclick="event.stopPropagation()" style="max-width:400px;">
            <button class="close-modal" onclick="closeModal(event)">&times;</button>
            <h2>Edit Department</h2>
            <label>Department Name</label>
            <input id="editDepartmentName" type="text" maxlength="64" value="${department.name}">
            <label>Faculty</label>
            <select id="editDepartmentFaculty">
              ${faculties.map(f => `<option value="${f._id}" ${f._id === department.faculty ? 'selected' : ''}>${f.name}</option>`).join('')}
            </select>
            <span id="editDepartmentMsg"></span>
            <span class="spinner" id="editDepartmentSpinner" style="display:none"></span>
            <button class="btn" onclick="submitEditDepartment('${department._id}')">Save</button>
          </div>
        </div>`;
      document.getElementById("modalRoot").innerHTML = html;
    }
    async function submitEditDepartment(id) {
      const name = document.getElementById("editDepartmentName").value.trim();
      const faculty = document.getElementById("editDepartmentFaculty").value;
      const msg = document.getElementById("editDepartmentMsg");
      const spinner = document.getElementById("editDepartmentSpinner");
      msg.innerText = "";
      msg.className = "";
      if (!name || !faculty) { msg.innerText = "All fields required!"; msg.className = "error-msg"; return; }
      spinner.style.display = "inline-block";
      const resp = await fetch(API_URL + "departments/" + id, {
        method: "PUT",
        headers: { "Content-Type": "application/json", Authorization: "Bearer " + token },
        body: JSON.stringify({ name, faculty })
      });
      spinner.style.display = "none";
      if (!resp.ok) {
        const data = await resp.json();
        msg.innerText = data.message || "Failed to edit department.";
        msg.className = "error-msg";
        return;
      }
      msg.innerText = "Department updated!";
      msg.className = "success-msg";
      setTimeout(() => {
        fetchDepartments();
        closeModal();
      }, 900);
    }
    // DELETE DEPARTMENT
    async function deleteDepartment(id) {
      if (!confirm("Delete this department?")) return;
      const resp = await fetch(API_URL + "departments/" + id, {
        method: "DELETE",
        headers: { Authorization: "Bearer " + token }
      });
      if (!resp.ok) {
        const data = await resp.json();
        alert(data.message || "Failed to delete department.");
      }
      fetchDepartments();
    }

  // ========== Students ==========
async function fetchStudents() {
  let users = [];
  try {
    const resp = await fetch(API_URL + "users?role=student", { headers: { Authorization: "Bearer " + token } });
    users = await resp.json();
    if (!Array.isArray(users)) users = [];
  } catch { users = []; }

  // Group by faculty and department
  const grouped = {};
  users.forEach(u => {
    const faculty = u.faculty || "Unknown Faculty";
    const department = u.department || "Unknown Department";
    if (!grouped[faculty]) grouped[faculty] = {};
    if (!grouped[faculty][department]) grouped[faculty][department] = [];
    grouped[faculty][department].push(u);
  });

  let html = "";
  Object.keys(grouped).forEach(faculty => {
    html += `<tr style="background:#fafaff;font-weight:700"><td colspan="6">${faculty}</td></tr>`;
    Object.keys(grouped[faculty]).forEach(department => {
      html += `<tr style="background:#f1f5ff;font-weight:500"><td colspan="6" style="padding-left:24px">${department}</td></tr>`;
      grouped[faculty][department].forEach(u => {
        html += `<tr>
          <td>
            <a href="#" onclick="viewStudent('${u._id}');return false;" style="color:#3a86ff;font-weight:600;cursor:pointer;text-decoration:underline;">
              ${u.fullname || u.username || '-'}
            </a>
          </td>
          <td>${u.username || '-'}</td>
          <td>${u.faculty || '-'}</td>
          <td>${u.department || '-'}</td>
          <td>
            <span style="color:${u.active === false ? '#ff3b47':'#25d366'};font-weight:700;">
              ${u.active === false ? 'Inactive':'Active'}
            </span>
          </td>
          <td>
            <button class="action-btn" onclick="viewStudent('${u._id}')">View</button>
            <button class="action-btn" onclick="editStudent('${u._id}')">Edit</button>
            <button class="action-btn" onclick="toggleStudentStatus('${u._id}', ${u.active !== false})">
              ${u.active === false ? 'Activate':'Deactivate'}
            </button>
          </td>
        </tr>`;
      });
    });
  });
  document.querySelector("#studentsTable tbody").innerHTML = html;
}


    async function viewStudent(id) {
      const resp = await fetch(API_URL + "users/" + id, { headers: { Authorization: "Bearer " + token } });
      if (!resp.ok) {
        alert("Could not load student: " + resp.statusText);
        return;
      }
      const u = await resp.json();
      let html = `
      <div class="modal-backdrop" onclick="closeModal(event)">
  <div class="modal" onclick="event.stopPropagation()" style="max-width:450px;">
    <button class="close-modal" onclick="closeModal(event)">&times;</button>
    <div style="text-align:center">
      <img src="${u.profilePic ? u.profilePic : 'https://ui-avatars.com/api/?name=' + encodeURIComponent(u.fullname || u.username || 'Student') + '&background=3a86ff&color=fff&rounded=true'}" alt="Profile" style="width:90px;height:90px;border-radius:50%;object-fit:cover;margin:0 auto 16px auto;border:3px solid #3a86ff;">
      <h2 style="margin-bottom:2px;">${u.fullname || '-'}</h2>
      <div style="font-size:1em;color:#3a86ff;">@${u.username || '-'}</div>
      <div style="margin:8px 0 18px 0;">
        <span style="font-size:0.97em;color:#444;">Faculty: <b>${u.faculty || '-'}</b></span><br>
        <span style="font-size:0.97em;color:#444;">Department: <b>${u.department || '-'}</b></span>
      </div>
    </div>
    <div>
      <label>Email</label>
      <input value="${u.email || ''}" disabled>
      <label>Status</label>
      <input value="${u.active === false ? 'Inactive':'Active'}" disabled>
      <label>Bio</label>
      <textarea disabled style="min-height:50px">${u.bio || ''}</textarea>
      <label>Phone</label>
      <input value="${u.phone || ''}" disabled>
      <label>Joined</label>
      <input value="${u.createdAt ? (new Date(u.createdAt)).toLocaleString() : ''}" disabled>
    </div>
    <button class="btn" onclick="editStudent('${u._id}')">Edit</button>
    <button class="btn" onclick="openSendMessageModal('${u._id}','${u.fullname || u.username || '-'}')">Send Message</button>
  </div>
</div>`;
      document.getElementById("modalRoot").innerHTML = html;
    }
// Opens the Send Message modal for a given user
function openSendMessageModal(userId, userName) {
  let html = `
    <div class="modal-backdrop" onclick="closeModal(event)">
      <div class="modal" onclick="event.stopPropagation()" style="max-width:450px;">
        <button class="close-modal" onclick="closeModal(event)">&times;</button>
        <h2>Send Message to ${userName}</h2>
        <textarea id="sendMsgText" rows="4" placeholder="Type your message..."></textarea>
        <span id="sendMsgStatus"></span>
        <span class="spinner" id="sendMsgSpinner" style="display:none"></span>
        <button class="btn" onclick="submitSendMessage('${userId}')">Send</button>
      </div>
    </div>`;
  document.getElementById("modalRoot").innerHTML = html;
}

// Handles message send
async function submitSendMessage(userId) {
  const text = document.getElementById("sendMsgText").value.trim();
  const msg = document.getElementById("sendMsgStatus");
  const spinner = document.getElementById("sendMsgSpinner");
  msg.innerText = "";
  msg.className = "";
  if (!text) { msg.innerText = "Message cannot be empty!"; msg.className = "error-msg"; return; }
  spinner.style.display = "inline-block";
  try {
    const resp = await fetch(API_URL + "messages/" + userId, {
      method: "POST",
      headers: { "Content-Type": "application/json", Authorization: "Bearer " + token },
      body: JSON.stringify({ text })
    });
    spinner.style.display = "none";
    if (!resp.ok) {
      const data = await resp.json();
      msg.innerText = data.message || "Failed to send message.";
      msg.className = "error-msg";
      return;
    }
    msg.innerText = "Message sent!";
    msg.className = "success-msg";
    setTimeout(() => closeModal(), 900);
  } catch (e) {
    spinner.style.display = "none";
    msg.innerText = "Network error.";
    msg.className = "error-msg";
  }
}
    function closeModal(e) {
      if (!e || e.target.classList.contains('modal-backdrop') || e.target.classList.contains('close-modal')) {
        document.getElementById("modalRoot").innerHTML = "";
      }
    }

    // ========== Show Section & Load Data ==========
function showSection(id, el) {
  document.querySelectorAll('.sidebar-nav a').forEach(a => a.classList.remove('active'));
  if (el) el.classList.add('active');
  document.getElementById('pageTitle').innerText = el ? el.textContent.trim() : id.charAt(0).toUpperCase() + id.slice(1);
 ['dashboard', 'uploaders', 'faculty', 'sets', 'questions', 'results', 'schedules', 'notifications', 'students', 'forms'].forEach(sec => {
  document.getElementById(sec+'Section').style.display = (sec===id) ? "" : "none";
});

  
  if (id === "dashboard") {
    fetchDashboardCounts();
    fetchUploadersCount();
  }
  if (id === "faculty") { fetchFaculties(); fetchDepartments(); }
  if (id === "sets") fetchSets();
  if (id === "questions") fetchQuestions();
  if (id === "results") fetchResults();
  if (id === "schedules") fetchSchedules();
  if (id === "forms") fetchForms();
  if (id === "notifications") { fetchNotifications(); fetchBroadcasts(); }
  if (id === "students") fetchStudents();
  if (window.innerWidth <= 950) closeSidebar();
    if (id === "dashboard") {
    fetchDashboardCounts();
    fetchUploadersCount();
  }
  
  if (id === "uploaders") fetchUploaders();
}
    
    function openSidebar() { document.getElementById('sidebar').classList.add('open'); document.getElementById('mainContent').classList.add('shifted'); }
    function closeSidebar() { document.getElementById('sidebar').classList.remove('open'); document.getElementById('mainContent').classList.remove('shifted'); }

// ========== Dashboard Counts ==========
async function fetchDashboardCounts() {
  // Question Sets and Questions
  let sets = [];
  try {
    const resp = await fetch(API_URL + "questionsets", { headers: { Authorization: "Bearer " + token } });
    sets = await resp.json();
    if (!Array.isArray(sets)) sets = [];
  } catch { sets = []; }
  document.getElementById("qSetCount").innerText = sets.length || 0;
  let qCount = 0;
  sets.forEach(s => qCount += (s.questions ? s.questions.length : 0));
  document.getElementById("questionCount").innerText = qCount || 0;

  // Total Results
  let resultCount = 0;
  try {
    const resp2 = await fetch(API_URL + "results?page=1&limit=1", { headers: { Authorization: "Bearer " + token } });
    const data2 = await resp2.json();
    resultCount = typeof data2.total === "number" ? data2.total : 0;
  } catch { resultCount = 0; }
  document.getElementById("resultCount").innerText = resultCount;

  // Scheduled Tests
  let schedules = [];
  try {
    const resp3 = await fetch(API_URL + "schedules", { headers: { Authorization: "Bearer " + token } });
    schedules = await resp3.json();
    if (!Array.isArray(schedules)) schedules = [];
  } catch { schedules = []; }
  document.getElementById("scheduleCount").innerText = schedules.length || 0;

  // Students
  let students = [];
  try {
    const resp4 = await fetch(API_URL + "users?role=student", { headers: { Authorization: "Bearer " + token } });
    students = await resp4.json();
    if (!Array.isArray(students)) students = [];
  } catch { students = []; }
  document.getElementById("studentCount").innerText = students.length || 0;

  // Uploaders
  let uploaders = [];
  try {
    const resp5 = await fetch(API_URL + "users?role=uploader", { headers: { Authorization: "Bearer " + token } });
    uploaders = await resp5.json();
    if (!Array.isArray(uploaders)) uploaders = [];
  } catch { uploaders = []; }
  document.getElementById("uploadersCount").innerText = uploaders.length || 0;
}
    // ========== Question Sets ==========
    async function fetchSets() {
  setSectionLoader("setsSection", true);
  try {
    const resp = await fetch(API_URL + "questionsets", { headers: { Authorization: "Bearer " + token } });
    const sets = await resp.json();
    let html = "";
    sets.forEach(set => {
      html += `<tr>
        <td>${set.title}</td>
        <td>${getFacultyName(set.faculty)}</td>
        <td>${getDepartmentName(set.department)}</td>
        <td>${set.status}</td>
        <td>${set.questions.length}</td>
        <td>
          <button class="action-btn" onclick="editSet('${set._id}')">Edit</button>
          <button class="action-btn" onclick="deleteSet('${set._id}')">Delete</button>
        </td>
      </tr>`;
    });
    document.querySelector("#setsTable tbody").innerHTML = html;
    let setOpts = sets.map(s => `<option value="${s._id}">${s.title}</option>`).join("");
    document.getElementById("qSetSelect").innerHTML = setOpts;

    // Auto-select first set and fetch questions for it
    if (sets.length > 0) {
      document.getElementById("qSetSelect").value = sets[0]._id;
      fetchQuestions();
    }
  } finally {
    setSectionLoader("setsSection", false);
  }
  }

    function editSet(id) {
      fetch(`${API_URL}questionsets/${id}`, {
        headers: { Authorization: "Bearer " + token }
      })
      .then(response => response.json())
      .then(set => {
        let html = `
          <div class="modal-backdrop" onclick="closeModal(event)">
            <div class="modal" onclick="event.stopPropagation()">
              <button class="close-modal" onclick="closeModal(event)">&times;</button>
              <h2>Edit Question Set</h2>
              <label>Title</label>
              <input id="editSetTitle" value="${set.title}" required>
              <label>Faculty</label>
              <select id="editSetFaculty">
                ${faculties.map(f => `<option value="${f._id}" ${f._id === set.faculty ? 'selected' : ''}>${f.name}</option>`).join('')}
              </select>
              <label>Department</label>
              <select id="editSetDepartment">
                ${departments.map(d => `<option value="${d._id}" ${d._id === set.department ? 'selected' : ''}>${d.name}</option>`).join('')}
              </select>
              <label>Status</label>
              <select id="editSetStatus">
                <option value="ACTIVE" ${set.status === "ACTIVE" ? 'selected' : ''}>ACTIVE</option>
                <option value="INACTIVE" ${set.status === "INACTIVE" ? 'selected' : ''}>INACTIVE</option>
              </select>
              <button class="btn" onclick="submitEditSet('${id}')">Save Changes</button>
              <div id="editSetMsg"></div>
            </div>
          </div>`;
        document.getElementById("modalRoot").innerHTML = html;
      })
      .catch(error => {
        console.error('Error fetching question set:', error);
      });
    }

    async function submitEditSet(id) {
      const title = document.getElementById("editSetTitle").value.trim();
      const faculty = document.getElementById("editSetFaculty").value;
      const department = document.getElementById("editSetDepartment").value;
      const status = document.getElementById("editSetStatus").value;
      
      const msg = document.getElementById("editSetMsg");
      msg.innerText = "";
      
      if (!title || !faculty || !department) {
        msg.innerText = "All fields are required!";
        return;
      }

      try {
        const response = await fetch(`${API_URL}questionsets/${id}`, {
          method: "PUT",
          headers: {
            "Content-Type": "application/json",
            Authorization: "Bearer " + token
          },
          body: JSON.stringify({ title, faculty, department, status })
        });

        if (!response.ok) {
          const resJson = await response.json();
          msg.innerText = resJson.message || "Update failed.";
          return;
        }

        msg.innerText = "Question set updated successfully!";
        closeModal();
        fetchSets(); // Refresh the question sets list
      } catch (error) {
        msg.innerText = "Network error.";
        console.error('Error updating question set:', error);
      }
    }

    async function deleteSet(id) {
      if (!confirm("Delete this set?")) return;
      await fetch(API_URL + "questionsets/" + id, { method: "DELETE", headers: { Authorization: "Bearer " + token } });
      fetchSets();
      fetchDashboardCounts();
    }

    // ========== Questions ==========
    let questionsGlobal = [];
    async function fetchQuestions() {
  setSectionLoader("questionsSection", true);
  try {
    const setId = document.getElementById("qSetSelect").value;
    if (!setId) { document.querySelector("#questionsTable tbody").innerHTML = ""; return; }
    const resp = await fetch(API_URL + "questionsets/" + setId, { headers: { Authorization: "Bearer " + token } });
    const set = await resp.json();
    let html = "";
    (set.questions || []).forEach(q => {
      html += `<tr>
        <td>${q.question}</td>
        <td>${q.options.map(o=>o.text).join(", ")}</td>
        <td>${q.answer}</td>
        <td>
          <button class="action-btn" onclick="editQuestion('${setId}',${q.id})">Edit</button>
          <button class="action-btn" onclick="deleteQuestion('${setId}',${q.id})">Delete</button>
        </td>
      </tr>`;
    });
    document.querySelector("#questionsTable tbody").innerHTML = html;
  } finally {
    setSectionLoader("questionsSection", false);
  }
}
      
    async function deleteQuestion(setId, qid) {
      if (!confirm("Delete this question?")) return;
      await fetch(API_URL + `questionsets/${setId}/questions/${qid}`, {
        method: "DELETE", headers: { Authorization: "Bearer " + token }
      });
      fetchQuestions();
      fetchDashboardCounts();
    }
    function editQuestion(setId, qid) {
      alert("Question editing not implemented in this mockup.");
    }

    // ========== Results ==========
    // Add these globals for pagination state
let resultsPage = 1;
let resultsLimit = 20;
let resultsTotalPages = 1;

async function fetchResults(page = 1, limit = 20) {
  setSectionLoader("resultsSection", true);
  try {
    // Call the API with page and limit query params
    const resp = await fetch(`${API_URL}results?page=${page}&limit=${limit}`, { headers: { Authorization: "Bearer " + token } });
    const data = await resp.json();
    const results = data.results || [];
    resultsPage = data.page || 1;
    resultsLimit = data.limit || 20;
    resultsTotalPages = Math.ceil((data.total || results.length) / resultsLimit);

    let html = "";
    results.forEach(r => {
      html += `<tr>
        <td>
          <a href="#" onclick="viewStudentSession('${r._id}');return false;" style="color:#3a86ff;font-weight:600;cursor:pointer;text-decoration:underline;">
            ${r.user?.username || '-'}
          </a>
        </td>
        <td>${r.examSet && r.examSet.title ? r.examSet.title : '-'}</td>
        <td>${r.score ?? '-'}</td>
        <td>${r.submittedAt ? (new Date(r.submittedAt)).toLocaleString() : '-'}</td>
      </tr>`;
    });
    document.querySelector("#resultsTable tbody").innerHTML = html;

    // Render pagination controls
    renderResultsPagination();
  } finally {
    setSectionLoader("resultsSection", false);
  }
}

function renderResultsPagination() {
  let html = `<div style="margin:10px 0; text-align:center;">`;
  html += `<button class="btn" onclick="goToResultsPage(resultsPage-1)" ${resultsPage <= 1 ? "disabled" : ""}>Prev</button>`;
  html += ` <span style="margin:0 12px;">Page ${resultsPage} of ${resultsTotalPages}</span> `;
  html += `<button class="btn" onclick="goToResultsPage(resultsPage+1)" ${resultsPage >= resultsTotalPages ? "disabled" : ""}>Next</button>`;
  html += `</div>`;

  // Insert pagination controls just above the results table
  const table = document.getElementById("resultsTable");
  let pagDiv = document.getElementById("resultsPagination");
  if (!pagDiv) {
    pagDiv = document.createElement("div");
    pagDiv.id = "resultsPagination";
    table.parentNode.insertBefore(pagDiv, table);
  }
  pagDiv.innerHTML = html;
}

function goToResultsPage(page) {
  if (page < 1 || page > resultsTotalPages) return;
  fetchResults(page, resultsLimit);
}
      
async function viewStudentSession(resultId) {
  // Show loader or modal
  const resp = await fetch(API_URL + "results/" + resultId, { headers: { Authorization: "Bearer " + token } });
  if (!resp.ok) {
    alert("Could not load session: " + resp.statusText);
    return;
  }
  const result = await resp.json();

  // Assuming result.questionsAnswered is an array of: { questionText, studentAnswer, correctAnswer, isCorrect }
  let html = `
    <div class="modal-backdrop" onclick="closeModal(event)">
      <div class="modal" onclick="event.stopPropagation()" style="max-width:600px;">
        <button class="close-modal" onclick="closeModal(event)">&times;</button>
        <h2>Session for ${result.user?.fullname || result.user?.username || ''}</h2>
        <div><b>Set:</b> ${result.examSet?.title || '-'}</div>
        <div><b>Score:</b> ${result.score ?? '-'}</div>
        <table class="data-table" style="margin-top:20px;">
          <thead>
  <tr>
    <th>#</th>
    <th>Question</th>
    <th>Your Answer</th>
    <th>Correct Answer</th>
    <th>Status</th>
  </tr>
</thead>
          <tbody>
  `;
 (result.questionsAnswered || []).forEach((q, idx) => {
  html += `<tr>
    <td>${idx + 1}</td>
    <td>${q.questionText}</td>
    <td>${q.studentAnswer}</td>
    <td>${q.correctAnswer}</td>
    <td style="color:${q.isCorrect ? 'green' : 'red'};font-weight:700;">
      ${q.isCorrect ? 'Correct' : 'Wrong'}
    </td>
  </tr>`;
});
  html += `
          </tbody>
        </table>
      </div>
    </div>
  `;
  document.getElementById("modalRoot").innerHTML = html;
}
// =========================
// Reusable Section Loader
// =========================
function setSectionLoader(sectionId, show = true) {
  const section = document.getElementById(sectionId);
  if (!section) return;
  const loader = section.querySelector('.section-loader');
  if (!loader) return;
  loader.style.display = show ? "flex" : "none";
}

// ========== Schedules Section with Loader ==========
// Update this part of your fetchSchedules() function (or wherever you render #schedulesTable)
async function fetchSchedules() {
  setSectionLoader("schedulesSection", true);
  try {
    const resp = await fetch(API_URL + "schedules", { headers: { Authorization: "Bearer " + token } });
    const schedules = await resp.json();
    let html = "";
    schedules.forEach(s => {
      html += `<tr>
        <td>${s.examSet?.title || '-'}</td>
        <td>${getFacultyName(s.faculty)}</td>
        <td>${getDepartmentsNames(s.departments)}</td>
        <td>${(s.levels && s.levels.length) ? s.levels.join(", ") : "-"}</td> <!-- NEW LEVELS COLUMN -->
        <td>${s.start ? (new Date(s.start)).toLocaleString() : '-'}</td>
        <td>${s.end ? (new Date(s.end)).toLocaleString() : '-'}</td>
        <td>
          <button class="action-btn" onclick="editSchedule('${s._id}')">Edit</button>
          <button class="action-btn" onclick="deleteSchedule('${s._id}')">Delete</button>
        </td>
      </tr>`;
    });
    document.querySelector("#schedulesTable tbody").innerHTML = html;
  } finally {
    setSectionLoader("schedulesSection", false);
  }
    }
/* --- Edit Schedule Modal: Multi-department and Levels support --- */
async function editSchedule(id) {
  const resp = await fetch(API_URL + "schedules/" + id, { headers: { Authorization: "Bearer " + token } });
  if (!resp.ok) { alert("Could not load schedule."); return; }
  const s = await resp.json();
  if (!faculties.length) await fetchFaculties();
  if (!departments.length) await fetchDepartments();
  const setsResp = await fetch(API_URL + "questionsets", { headers: { Authorization: "Bearer " + token } });
  const sets = await setsResp.json();

  // Default/preselect levels if present
  const levelsList = ["100", "200", "300", "400", "500", "600"];
  const selectedLevels = Array.isArray(s.levels) ? s.levels : [];

  let html = `
    <div class="modal-backdrop" onclick="closeModal(event)">
      <div class="modal" onclick="event.stopPropagation()" style="max-width:420px;">
        <button class="close-modal" onclick="closeModal(event)">&times;</button>
        <h2>Edit Schedule</h2>
        <label>Exam Set</label>
        <select id="editScheduleSet">
          ${sets.map(set => 
            `<option value="${set._id}" ${set._id === (s.examSet?._id || s.examSet) ? 'selected' : ''}>${set.title}</option>`
          ).join('')}
        </select>
        <label>Faculty</label>
        <select id="editScheduleFaculty" onchange="populateEditDepartmentsDropdownForSchedule()">
          ${faculties.map(f => `<option value="${f._id}" ${f._id === s.faculty ? 'selected' : ''}>${f.name}</option>`).join('')}
        </select>
        <label>Departments <span style="color:#888;font-size:0.95em;">(Ctrl/Cmd to select multiple)</span></label>
        <select id="editScheduleDepartments" multiple size="6" style="height:auto;">
          <!-- Populated below -->
        </select>
        <label>Levels <span style="color:#888;font-size:0.95em;">(Ctrl/Cmd to select multiple)</span></label>
        <select id="editScheduleLevels" multiple size="6" style="height:auto;">
          ${levelsList.map(lvl => `<option value="${lvl}" ${selectedLevels.includes(lvl) ? 'selected' : ''}>${lvl}</option>`).join('')}
        </select>
        <label>Start Date & Time</label>
        <input id="editScheduleStart" type="datetime-local" value="${(new Date(s.start)).toISOString().slice(0,16)}">
        <label>End Date & Time</label>
        <input id="editScheduleEnd" type="datetime-local" value="${(new Date(s.end)).toISOString().slice(0,16)}">
        <span id="editScheduleMsg"></span>
        <span class="spinner" id="editScheduleSpinner" style="display:none"></span>
        <button class="btn" onclick="submitEditSchedule('${s._id}')">Save Changes</button>
      </div>
    </div>`;
  document.getElementById("modalRoot").innerHTML = html;
  populateEditDepartmentsDropdownForSchedule(s.faculty, s.departments || s.department);
}

function populateEditDepartmentsDropdownForSchedule(selectedFaculty, selectedDepartments) {
  // If called by `onchange`, get current value from dropdown
  if (!selectedFaculty) selectedFaculty = document.getElementById('editScheduleFaculty').value;
  if (!selectedDepartments) selectedDepartments = [];
  if (!Array.isArray(selectedDepartments)) selectedDepartments = [selectedDepartments];
  const deptSelect = document.getElementById('editScheduleDepartments');
  if (!deptSelect) return;
  deptSelect.innerHTML = departments
    .filter(d => d.faculty === selectedFaculty)
    .map(d => `<option value="${d._id}" ${selectedDepartments.includes(d._id) ? 'selected' : ''}>${d.name}</option>`).join('');
}

async function submitEditSchedule(id) {
  const examSet = document.getElementById("editScheduleSet").value;
  const faculty = document.getElementById("editScheduleFaculty").value;
  const departmentsSelect = document.getElementById("editScheduleDepartments");
  const departments = Array.from(departmentsSelect.selectedOptions).map(opt => opt.value);
  const levelsSelect = document.getElementById("editScheduleLevels");
  const levels = Array.from(levelsSelect ? levelsSelect.selectedOptions : []).map(opt => opt.value);
  const start = document.getElementById("editScheduleStart").value;
  const end = document.getElementById("editScheduleEnd").value;
  const msg = document.getElementById("editScheduleMsg");
  const spinner = document.getElementById("editScheduleSpinner");
  msg.innerText = "";
  msg.className = "";
  // Updated validation to require levels
  if (!examSet || !faculty || !departments.length || !levels.length || !start || !end) {
    msg.innerText = "All fields required!";
    msg.className = "error-msg";
    return;
  }
  spinner.style.display = "inline-block";
  const resp = await fetch(API_URL + "schedules/" + id, {
    method: "PUT",
    headers: { "Content-Type": "application/json", Authorization: "Bearer " + token },
    body: JSON.stringify({ examSet, faculty, departments, levels, start, end })
  });
  spinner.style.display = "none";
  if (!resp.ok) {
    const data = await resp.json();
    msg.innerText = data.error || data.message || "Failed to update schedule.";
    msg.className = "error-msg";
    return;
  }
  msg.innerText = "Schedule updated!";
  msg.className = "success-msg";
  setTimeout(() => {
    fetchSchedules();
    closeModal();
  }, 900);
}
// Delete Schedule
async function deleteSchedule(id) {
  if (!confirm("Delete this schedule?")) return;
  const resp = await fetch(API_URL + "schedules/" + id, {
    method: "DELETE",
    headers: { Authorization: "Bearer " + token }
  });
  if (!resp.ok) {
    const data = await resp.json();
    alert(data.error || data.message || "Failed to delete schedule.");
  }
  fetchSchedules();
}

    const BACKEND_URL = "https://examguide.onrender.com";

    async function fetchNotifications() {
      const resp = await fetch(API_URL + "notifications", { headers: { Authorization: "Bearer " + token } });
      const notifs = await resp.json();
      let html = "";
      notifs.forEach(n => {
        html += `<tr>
          <td>${n.title}</td>
          <td>${n.message}</td>
          <td>${
            n.imageUrl
              ? `<img src="${n.imageUrl.startsWith('http') ? n.imageUrl : BACKEND_URL + n.imageUrl}" alt="img" style="max-width:60px;max-height:60px;border-radius:4px;">`
              : ""
          }</td>
          <td>${(new Date(n.createdAt)).toLocaleString()}</td>
          <td>
            <button class="action-btn" onclick="editNotif('${n._id}')">Edit</button>
            <button class="action-btn" onclick="deleteNotif('${n._id}')">Delete</button>
          </td>
        </tr>`;
      });
      document.querySelector("#notificationsTable tbody").innerHTML = html;
    }

    async function deleteNotif(id) {
      if (!confirm("Delete this message?")) return;
      const resp = await fetch(API_URL + "notifications/" + id, {
        method: "DELETE",
        headers: { Authorization: "Bearer " + token }
      });
      if (!resp.ok) {
        const data = await resp.json();
        alert(data.message || "Failed to delete.");
      }
      fetchNotifications();
    }
    async function editNotif(id) {
      const resp = await fetch(API_URL + "notifications/" + id, { headers: { Authorization: "Bearer " + token } });
      if (!resp.ok) { alert("Could not load message."); return; }
      const n = await resp.json();
      let html = `
        <div class="modal-backdrop" onclick="closeModal(event)">
          <div class="modal" onclick="event.stopPropagation()">
            <button class="close-modal" onclick="closeModal(event)">&times;</button>
            <h2>Edit Announcement</h2>
            <label>Title</label>
            <input id="editNotifTitle" type="text" maxlength="40" value="${n.title}">
            <label>Message</label>
            <textarea id="editNotifMsg" maxlength="300">${n.message}</textarea>
            <label>Image (Leave blank to keep current)</label>
            <input id="editNotifImg" type="file" accept="image/*">
            ${n.imageUrl ? `<img src="${n.imageUrl}" style="max-width:80px;display:block;margin:5px 0">` : ""}
            <span id="editNotifMsgEl"></span>
            <span class="spinner" id="editNotifSpinner" style="display:none"></span>
            <button class="btn" onclick="submitEditNotif('${n._id}')">Save</button>
          </div>
        </div>`;
      document.getElementById("modalRoot").innerHTML = html;
    }
    
    async function submitEditNotif(id) {
      const title = document.getElementById("editNotifTitle").value.trim();
      const message = document.getElementById("editNotifMsg").value.trim();
      const imageFile = document.getElementById("editNotifImg").files[0];
      const spinner = document.getElementById("editNotifSpinner");
      const msg = document.getElementById("editNotifMsgEl");
      msg.innerText = ""; msg.className = "";
      if (!title || !message) { msg.innerText = "All fields required!"; msg.className = "error-msg"; return; }
      spinner.style.display = "inline-block";
      let body, headers;
      if (imageFile) {
        body = new FormData();
        body.append("title", title);
        body.append("message", message);
        body.append("image", imageFile);
        headers = { Authorization: "Bearer " + token };
      } else {
        body = JSON.stringify({ title, message });
        headers = { "Content-Type": "application/json", Authorization: "Bearer " + token };
      }
      const resp = await fetch(API_URL + "notifications/" + id, {
        method: "PUT",
        headers,
        body
      });
      spinner.style.display = "none";
      if (!resp.ok) {
        const data = await resp.json();
        msg.innerText = data.message || "Failed to edit message.";
        msg.className = "error-msg";
        return;
      }
      msg.innerText = "Edited!";
      msg.className = "success-msg";
      setTimeout(() => {
        fetchNotifications();
        closeModal();
      }, 900);
    }
    

    // ========== MODALS ==========
    function openModal(type) {
      let html = "";
      if (type === "addFacultyModal") {
        html = `
          <div class="modal-backdrop" onclick="closeModal(event)">
            <div class="modal" onclick="event.stopPropagation()">
              <button class="close-modal" onclick="closeModal(event)">&times;</button>
              <h2>Add Faculty</h2>
              <label>Faculty Name</label>
              <input id="facultyName" type="text" maxlength="64">
              <span id="addFacultyMsg"></span>
              <span class="spinner" id="addFacultySpinner" style="display:none"></span>
              <button class="btn" onclick="submitAddFaculty()">Create</button>
            </div>
          </div>`;
      }
      if (type === "addDepartmentModal") {
        html = `
          <div class="modal-backdrop" onclick="closeModal(event)">
            <div class="modal" onclick="event.stopPropagation()">
              <button class="close-modal" onclick="closeModal(event)">&times;</button>
              <h2>Add Department</h2>
              <label>Department Name</label>
              <input id="departmentName" type="text" maxlength="64">
              <label>Faculty</label>
              <select id="departmentFaculty">
                ${faculties.map(f => `<option value="${f._id}">${f.name}</option>`).join('')}
              </select>
              <span id="addDeptMsg"></span>
              <span class="spinner" id="addDeptSpinner" style="display:none"></span>
              <button class="btn" onclick="submitAddDepartment()">Create</button>
            </div>
          </div>`;
      }
      if (type === "addSetModal") {
        html = `
          <div class="modal-backdrop" onclick="closeModal(event)">
            <div class="modal" onclick="event.stopPropagation()">
              <button class="close-modal" onclick="closeModal(event)">&times;</button>
              <h2>New Question Set</h2>
              <label>Title</label>
              <input id="setTitle" type="text" maxlength="48">
              <label>Faculty</label>
              <select id="setFaculty" onchange="populateDepartmentsDropdown()">
                <option value="">Select faculty</option>
                ${faculties.map(f => `<option value="${f._id}">${f.name}</option>`).join('')}
              </select>
              <label>Department</label>
              <select id="setDepartment">
                <option value="">Select department</option>
              </select>
              <label>Status</label>
              <select id="setStatus"><option value="ACTIVE">ACTIVE</option><option value="INACTIVE">INACTIVE</option></select>
              <span id="addSetMsg"></span>
              <span class="spinner" id="addSetSpinner" style="display:none"></span>
              <button class="btn" onclick="submitAddSet()">Create</button>
            </div>
          </div>`;
      }
      if (type === "addQuestionModal") {
        html = `
          <div class="modal-backdrop" onclick="closeModal(event)">
            <div class="modal" onclick="event.stopPropagation()">
              <button class="close-modal" onclick="closeModal(event)">&times;</button>
              <h2>Add Question</h2>
              <label>Set</label>
              <select id="modalSetSelect"></select>
              <label>Question</label>
              <textarea id="questionText"></textarea>
              <label>Option A</label><input id="optionA" type="text">
              <label>Option B</label><input id="optionB" type="text">
              <label>Option C</label><input id="optionC" type="text">
              <label>Option D</label><input id="optionD" type="text">
              <label>Answer</label>
              <select id="answer"><option>A</option><option>B</option><option>C</option><option>D</option></select>
              <label>Explanation</label><textarea id="explanation"></textarea>
              <span id="addQMsg"></span>
              <span class="spinner" id="addQSpinner" style="display:none"></span>
              <button class="btn" onclick="submitAddQuestion()">Add</button>
            </div>
          </div>`;
      }
      if (type === "bulkUploadModal") {
        html = `
          <div class="modal-backdrop" onclick="closeModal(event)">
            <div class="modal" onclick="event.stopPropagation()">
              <button class="close-modal" onclick="closeModal(event)">&times;</button>
              <h2>Bulk Upload Questions</h2>
              <label>Paste Complete JSON Object (title, status, questions[])</label>
              <textarea id="bulkQuestions" rows="12" placeholder='{
  "title": "INTRODUCTORY ZOOLOGY II",
  "status": "ACTIVE",
  "questions": [
    { "id": 131, "question": "...", "options": [...], "answer": "...", "explanation": "", "questionImage": "" }
  ]
}'></textarea>
              <span id="bulkUploadMsg"></span>
              <span class="spinner" id="bulkUploadSpinner" style="display:none"></span>
              <button class="btn" onclick="submitBulkUpload()">Upload</button>
            </div>
          </div>`;
      }
      if (type === "sendNotifModal") {
        html = `
          <div class="modal-backdrop" onclick="closeModal(event)">
            <div class="modal" onclick="event.stopPropagation()">
              <button class="close-modal" onclick="closeModal(event)">&times;</button>
              <h2>Send Announcement</h2>
              <label>Title</label>
              <input id="notifTitle" type="text" maxlength="40">
              <label>Message</label>
              <textarea id="notifMsg" maxlength="300"></textarea>
              <label>Attach Image (optional)</label>
              <input id="notifImg" type="file" accept="image/*">
              <span id="sendNotifMsg"></span>
              <span class="spinner" id="sendNotifSpinner" style="display:none"></span>
              <button class="btn" onclick="submitSendNotif()">Send</button>
            </div>
          </div>`;
      }
        // ... other modals ...
if (type === "addScheduleModal") {
  html = `
    <div class="modal-backdrop" onclick="closeModal(event)">
      <div class="modal" onclick="event.stopPropagation()">
        <button class="close-modal" onclick="closeModal(event)">&times;</button>
        <h2>Schedule Test</h2>
        <label>Exam Set</label>
        <select id="scheduleSet"></select>
        <label>Faculty</label>
        <select id="scheduleFaculty" onchange="populateDepartmentsDropdownForSchedule()"></select>
        <label>Departments <span style="color:#888;font-size:0.95em;">(Ctrl/Cmd to select multiple)</span></label>
        <select id="scheduleDepartments" multiple size="6" style="height:auto;"></select>
        <label>Levels <span style="color:#888;font-size:0.95em;">(Ctrl/Cmd to select multiple)</span></label>
        <select id="scheduleLevels" multiple size="6" style="height:auto;">
          <option value="100">100</option>
          <option value="200">200</option>
          <option value="300">300</option>
          <option value="400">400</option>
          <option value="500">500</option>
          <option value="600">600</option>
        </select>
        <label>Start Date & Time</label>
        <input id="scheduleStart" type="datetime-local">
        <label>End Date & Time</label>
        <input id="scheduleEnd" type="datetime-local">
        <span id="addScheduleMsg"></span>
        <span class="spinner" id="addScheduleSpinner" style="display:none"></span>
        <button class="btn" onclick="submitAddSchedule()">Schedule</button>
      </div>
    </div>`;
  document.getElementById("modalRoot").innerHTML = html;
  populateScheduleModalFields();
  return;
}

      if (html) {
        document.getElementById("modalRoot").innerHTML = html;
      }
      if (type === "addQuestionModal" || type === "bulkUploadModal") {
        fetch(API_URL + "questionsets", { headers: { Authorization: "Bearer " + token } })
          .then(r => r.json())
          .then(sets => {
            document.getElementById("modalSetSelect").innerHTML =
              sets.map(s => `<option value="${s._id}">${s.title}</option>`).join("");
          });
      }
    }

// ========== Modal: Populate Add Schedule Dropdowns ==========
function populateDepartmentsDropdownForSchedule() {
  const facultyId = document.getElementById('scheduleFaculty').value;
  const deptSelect = document.getElementById('scheduleDepartments');
  if (!deptSelect) return;
  deptSelect.innerHTML = departments
    .filter(d => d.faculty === facultyId)
    .map(d => `<option value="${d._id}">${d.name}</option>`).join('');
}
function populateScheduleModalFields() {
  // Sets
  fetch(API_URL + "questionsets", { headers: { Authorization: "Bearer " + token } })
    .then(r => r.json())
    .then(sets => {
      document.getElementById("scheduleSet").innerHTML =
        sets.map(s => `<option value="${s._id}">${s.title}</option>`).join("");
    });
  // Faculties
  document.getElementById("scheduleFaculty").innerHTML =
    faculties.map(f => `<option value="${f._id}">${f.name}</option>`).join("");
  // Departments (filtered by selected faculty)
  populateDepartmentsDropdownForSchedule();
}
    // ========== MODAL SUBMIT HANDLERS ==========
    async function submitAddFaculty() {
      const name = document.getElementById("facultyName").value.trim();
      const msg = document.getElementById("addFacultyMsg");
      const spinner = document.getElementById("addFacultySpinner");
      msg.innerText = "";
      msg.className = "";
      if (!name) { msg.innerText = "Faculty name required!"; msg.className = "error-msg"; return; }
      spinner.style.display = "inline-block";
      const resp = await fetch(API_URL + "faculties", {
        method: "POST",
        headers: { "Content-Type": "application/json", Authorization: "Bearer " + token },
        body: JSON.stringify({ name })
      });
      spinner.style.display = "none";
      if (!resp.ok) {
        const data = await resp.json();
        msg.innerText = data.message || "Failed to add faculty.";
        msg.className = "error-msg";
        return;
      }
      msg.innerText = "Successfully loaded!";
      msg.className = "success-msg";
      setTimeout(() => {
        fetchFaculties();
        closeModal();
      }, 900);
    }

    async function submitAddDepartment() {
      const name = document.getElementById("departmentName").value.trim();
      const faculty = document.getElementById("departmentFaculty").value;
      const msg = document.getElementById("addDeptMsg");
      const spinner = document.getElementById("addDeptSpinner");
      msg.innerText = "";
      msg.className = "";
      if (!name || !faculty) { msg.innerText = "All fields required!"; msg.className = "error-msg"; return; }
      spinner.style.display = "inline-block";
      const resp = await fetch(API_URL + "departments", {
        method: "POST",
        headers: { "Content-Type": "application/json", Authorization: "Bearer " + token },
        body: JSON.stringify({ name, faculty })
      });
      spinner.style.display = "none";
      if (!resp.ok) {
        const data = await resp.json();
        msg.innerText = data.message || "Failed to add department.";
        msg.className = "error-msg";
        return;
      }
      msg.innerText = "Successfully loaded!";
      msg.className = "success-msg";
      setTimeout(() => {
        fetchDepartments();
        closeModal();
      }, 900);
    }

    async function submitAddSet() {
      const title = document.getElementById("setTitle").value.trim();
      const status = document.getElementById("setStatus").value;
      const faculty = document.getElementById("setFaculty").value;
      const department = document.getElementById("setDepartment").value;
      const msg = document.getElementById("addSetMsg");
      const spinner = document.getElementById("addSetSpinner");
      msg.innerText = "";
      msg.className = "";
      if (!title || !faculty || !department) { msg.innerText = "All fields required!"; msg.className = "error-msg"; return; }
      spinner.style.display = "inline-block";
      const resp = await fetch(API_URL + "questionsets", {
        method: "POST",
        headers: { "Content-Type": "application/json", Authorization: "Bearer " + token },
        body: JSON.stringify({ title, status, faculty, department, questions: [] })
      });
      spinner.style.display = "none";
      if (!resp.ok) {
        const data = await resp.json();
        msg.innerText = data.message || "Failed to add set.";
        msg.className = "error-msg";
        return;
      }
      msg.innerText = "Successfully loaded!";
      msg.className = "success-msg";
      setTimeout(() => {
        fetchSets();
        fetchDashboardCounts();
        closeModal();
      }, 900);
    }

    async function submitAddQuestion() {
      const setId = document.getElementById("modalSetSelect").value;
      const question = document.getElementById("questionText").value.trim();
      const options = [
        { text: document.getElementById("optionA").value.trim() },
        { text: document.getElementById("optionB").value.trim() },
        { text: document.getElementById("optionC").value.trim() },
        { text: document.getElementById("optionD").value.trim() }
      ];
      const answerIndex = "ABCD".indexOf(document.getElementById("answer").value);
      const answer = options[answerIndex].text;
      const explanation = document.getElementById("explanation").value.trim();
      const msg = document.getElementById("addQMsg");
      const spinner = document.getElementById("addQSpinner");
      msg.innerText = "";
      msg.className = "";
      if (!question || options.some(o=>!o.text) || !answer) { msg.innerText = "All fields required!"; msg.className = "error-msg"; return; }
      spinner.style.display = "inline-block";
      const resp = await fetch(API_URL + "questionsets/" + setId, { headers: { Authorization: "Bearer " + token } });
      const set = await resp.json();
      const newId = (set.questions && set.questions.length > 0) ? Math.max(...set.questions.map(q=>q.id)) + 1 : 1;
      const postResp = await fetch(API_URL + `questionsets/${setId}/questions`, {
        method: "POST",
        headers: { "Content-Type": "application/json", Authorization: "Bearer " + token },
        body: JSON.stringify({ questions: [{ id: newId, question, options, answer, explanation }] })
      });
      spinner.style.display = "none";
      if (!postResp.ok) {
        const data = await postResp.json();
        msg.innerText = data.message || "Failed to add question.";
        msg.className = "error-msg";
        return;
      }
      msg.innerText = "Successfully loaded!";
      msg.className = "success-msg";
      setTimeout(() => {
        fetchQuestions();
        fetchDashboardCounts();
        closeModal();
      }, 900);
    }

    async function submitBulkUpload() {
      let data;
      const msg = document.getElementById("bulkUploadMsg");
      const spinner = document.getElementById("bulkUploadSpinner");
      msg.innerText = "";
      msg.className = "";
      try { data = JSON.parse(document.getElementById("bulkQuestions").value.trim()); }
      catch { msg.innerText = "Invalid JSON format."; msg.className = "error-msg"; return; }

      if (!data.title || !data.status || !Array.isArray(data.questions)) {
        msg.innerText = "JSON must include title, status, and questions[]";
        msg.className = "error-msg";
        return;
      }

      spinner.style.display = "inline-block";
      const resp = await fetch(API_URL + "questionsets/bulk", {
        method: "POST",
        headers: { "Content-Type": "application/json", Authorization: "Bearer " + token },
        body: JSON.stringify(data)
      });
      spinner.style.display = "none";
      if (!resp.ok) {
        const out = await resp.json();
        msg.innerText = out.error || out.message || "Failed to upload.";
        msg.className = "error-msg";
        return;
      }
      msg.innerText = "Bulk upload successful!";
      msg.className = "success-msg";
      setTimeout(() => {
        fetchSets();
        fetchDashboardCounts();
        closeModal();
      }, 900);
    }

async function submitAddSchedule() {
  const examSet = document.getElementById("scheduleSet").value;
  const faculty = document.getElementById("scheduleFaculty") ? document.getElementById("scheduleFaculty").value : "";
  const departmentsSelect = document.getElementById("scheduleDepartments");
  const departments = Array.from(departmentsSelect.selectedOptions).map(opt => opt.value);
  const levelsSelect = document.getElementById("scheduleLevels");
  const levels = Array.from(levelsSelect ? levelsSelect.selectedOptions : []).map(opt => opt.value);
  const start = document.getElementById("scheduleStart").value;
  const end = document.getElementById("scheduleEnd").value;
  const msg = document.getElementById("addScheduleMsg");
  const spinner = document.getElementById("addScheduleSpinner");
  msg.innerText = "";
  msg.className = "";

  // Updated validation: all fields required, including levels
  if (!examSet || !faculty || !departments.length || !levels.length || !start || !end) {
    msg.innerText = "All fields required!";
    msg.className = "error-msg";
    return;
  }

  spinner.style.display = "inline-block";
  const resp = await fetch(API_URL + "schedules", {
    method: "POST",
    headers: { "Content-Type": "application/json", Authorization: "Bearer " + token },
    body: JSON.stringify({ examSet, faculty, departments, levels, start, end })
  });
  spinner.style.display = "none";
  if (!resp.ok) {
    const data = await resp.json();
    msg.innerText = data.message || data.error || "Failed to schedule.";
    msg.className = "error-msg";
    return;
  }
  msg.innerText = "Successfully loaded!";
  msg.className = "success-msg";
  setTimeout(() => {
    fetchSchedules();
    closeModal();
  }, 900);
}

    async function submitSendNotif() {
      const title = document.getElementById("notifTitle").value.trim();
      const message = document.getElementById("notifMsg").value.trim();
      const imageFile = document.getElementById("notifImg").files[0];
      const spinner = document.getElementById("sendNotifSpinner");
      const msg = document.getElementById("sendNotifMsg");
      msg.innerText = ""; msg.className = "";
      if (!title || !message) { msg.innerText = "All fields required!"; msg.className = "error-msg"; return; }
      spinner.style.display = "inline-block";
      let body, headers;
      if (imageFile) {
        body = new FormData();
        body.append("title", title);
        body.append("message", message);
        body.append("image", imageFile);
        headers = { Authorization: "Bearer " + token };
      } else {
        body = JSON.stringify({ title, message });
        headers = { "Content-Type": "application/json", Authorization: "Bearer " + token };
      }
      const resp = await fetch(API_URL + "notifications", {
        method: "POST",
        headers,
        body
      });
      spinner.style.display = "none";
      if (!resp.ok) {
        const data = await resp.json();
        msg.innerText = data.message || "Failed to send.";
        msg.className = "error-msg";
        return;
      }
      msg.innerText = "Sent!";
      msg.className = "success-msg";
      setTimeout(() => {
        fetchNotifications();
        closeModal();
      }, 900);
    }


function openBroadcastModal() {
  document.getElementById("modalRoot").innerHTML = `
    <div class="modal-backdrop" onclick="closeModal(event)">
      <div class="modal" style="max-width:420px;" onclick="event.stopPropagation()">
        <button class="close-modal" onclick="closeModal(event)">&times;</button>
        <h2>Send Broadcast Message</h2>
        <label>Title</label>
        <input id="broadcastTitle" type="text" maxlength="120">
        <label>Message</label>
        <textarea id="broadcastMsg" maxlength="2000" rows="5"></textarea>
        <label>Type</label>
        <select id="broadcastType">
          <option value="info">Info</option>
          <option value="success">Success</option>
          <option value="warning">Warning</option>
          <option value="danger">Danger</option>
        </select>
        <label>Expiry (optional)</label>
        <input id="broadcastExpiry" type="datetime-local">
        <label>Link (optional)</label>
        <input id="broadcastLink" type="url" maxlength="600">
        <label>Image (optional)</label>
        <input id="broadcastImg" type="file" accept="image/*">
        <span id="broadcastMsgStatus"></span>
        <button class="btn" onclick="submitBroadcast()">Send</button>
      </div>
    </div>`;
}

async function submitBroadcast() {
  const title = document.getElementById("broadcastTitle").value.trim();
  const message = document.getElementById("broadcastMsg").value.trim();
  const type = document.getElementById("broadcastType").value;
  const link = document.getElementById("broadcastLink").value.trim();
  const expiresAt = document.getElementById("broadcastExpiry").value;
  const imageFile = document.getElementById("broadcastImg").files[0];
  const status = document.getElementById("broadcastMsgStatus");
  status.innerText = "";

  if (!title || !message) { status.innerText = "Title and message are required!"; return; }

  const formData = new FormData();
  formData.append('title', title);
  formData.append('message', message);
  formData.append('type', type);
  if (link) formData.append('link', link);
  if (expiresAt) formData.append('expiresAt', expiresAt);
  if (imageFile) formData.append('image', imageFile);

  try {
    const resp = await fetch(API_URL + "broadcasts", {
      method: "POST",
      headers: { Authorization: "Bearer " + token },
      body: formData
    });
    if (!resp.ok) {
      const err = await resp.json();
      status.innerText = err.message || "Failed to send broadcast.";
      return;
    }
    status.innerText = "Broadcast sent!";
    setTimeout(closeModal, 1200);
  } catch (e) {
    status.innerText = "Network error.";
  }
}
async function fetchBroadcasts() {
  const resp = await fetch(API_URL + "broadcasts", { headers: { Authorization: "Bearer " + token } });
  const broadcasts = await resp.json();
  let html = "";
  broadcasts.forEach(b => {
    html += `<tr>
      <td>${b.title}</td>
      <td>${b.type}</td>
      <td>${b.message}</td>
      <td>${b.imageUrl ? `<img src="${b.imageUrl}" style="max-width:60px;max-height:60px;border-radius:4px;">` : ""}</td>
      <td>${b.link ? `<a href="${b.link}" target="_blank">Link</a>` : ""}</td>
      <td>${(new Date(b.createdAt)).toLocaleString()}</td>
      <td>
        <button class="action-btn" onclick="editBroadcast('${b._id}')">Edit</button>
        <button class="action-btn" onclick="deleteBroadcast('${b._id}')">Delete</button>
      </td>
    </tr>`;
  });
  document.querySelector("#broadcastsTable tbody").innerHTML = html;
}

async function deleteBroadcast(id) {
  if (!confirm("Delete this broadcast message?")) return;
  const resp = await fetch(API_URL + "broadcasts/" + id, {
    method: "DELETE",
    headers: { Authorization: "Bearer " + token }
  });
  if (!resp.ok) {
    const data = await resp.json();
    alert(data.message || "Failed to delete.");
  }
  fetchBroadcasts();
}

// Call fetchBroadcasts() when the admin enters the broadcasts section
    // ========== AUTH & LOGOUT ==========
    function logout() {
      localStorage.removeItem("token");
      window.location.href = "mock.html";
    }

    function toggleSidebar() {
      var sidebar = document.querySelector('.sidebar');
      if (sidebar.classList.contains('open')) {
        sidebar.classList.remove('open');
        document.querySelector('.main-content').classList.remove('shifted');
      } else {
        sidebar.classList.add('open');
        document.querySelector('.main-content').classList.add('shifted');
      }
    }

    // Optional: close sidebar when clicking outside on mobile
    window.addEventListener('click', function(e) {
      var sidebar = document.querySelector('.sidebar');
      var navToggle = document.getElementById('navToggle');
      if (!sidebar.contains(e.target) && !navToggle.contains(e.target) && sidebar.classList.contains('open') && window.innerWidth < 950) {
        sidebar.classList.remove('open'); 
        document.querySelector('.main-content').classList.remove('shifted');
      }
    });


function renderBarChart(ctxId, labels, data, label, color) {
  const ctx = document.getElementById(ctxId);
  if (ctx.chartInstance) {
    ctx.chartInstance.destroy();
  }
  ctx.chartInstance = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: labels,
      datasets: [{
        label: label,
        data: data,
        backgroundColor: color,
        borderRadius: 6,
        maxBarThickness: 34
      }]
    },
    options: {
      responsive: true,
      plugins: {
        legend: { display: false }
      },
      scales: {
        y: { beginAtZero:true, ticks: { stepSize: 10 } }
      }
    }
  });
}

// Fetch and render analytics charts
async function fetchAndRenderDashboardAnalytics() {
  // 1. Results Analytics: average score per question set
  let resultsLabels = [], resultsData = [];
  try {
    const resp = await fetch(API_URL + "results", { headers: { Authorization: "Bearer " + token } });
    const results = await resp.json();
    // Group by set title, compute average score
    const setScores = {};
    results.forEach(r => {
      if (!r.examSet?.title) return;
      if (!setScores[r.examSet.title]) setScores[r.examSet.title] = [];
      setScores[r.examSet.title].push(Number(r.score || 0));
    });
    resultsLabels = Object.keys(setScores);
    resultsData = resultsLabels.map(title => {
      const scores = setScores[title];
      return scores.length ? (scores.reduce((a,b)=>a+b,0)/scores.length).toFixed(1) : 0;
    });
  } catch (e) {
    // fallback
    resultsLabels = ["No Data"];
    resultsData = [0];
  }
  renderBarChart("resultsChart", resultsLabels, resultsData, "Avg Score", "#3a86ff");

  // 2. Performance Analytics: number of students in each performance band
  // Example bands: >=80, 70-79, 60-69, 50-59, <50
  let perfLabels = ["80+", "70-79", "60-69", "50-59", "<50"], perfData = [0,0,0,0,0];
  try {
    const resp = await fetch(API_URL + "results", { headers: { Authorization: "Bearer " + token } });
    const results = await resp.json();
    results.forEach(r => {
      const s = Number(r.score || 0);
      if (s >= 80) perfData[0]++;
      else if (s >= 70) perfData[1]++;
      else if (s >= 60) perfData[2]++;
      else if (s >= 50) perfData[3]++;
      else perfData[4]++;
    });
  } catch (e) {}
  renderBarChart("performanceChart", perfLabels, perfData, "Students", "#25d366");

  // 3. Registration Analytics: registration count per month (last 6 months)
  let regLabels = [], regData = [];
  try {
    const resp = await fetch(API_URL + "users?role=student", { headers: { Authorization: "Bearer " + token } });
    const users = await resp.json();
    // Group by month
    const months = {};
    users.forEach(u => {
      if (!u.createdAt) return;
      const date = new Date(u.createdAt);
      const key = `${date.getFullYear()}-${("0"+(date.getMonth()+1)).slice(-2)}`; // e.g. 2025-06
      months[key] = (months[key]||0)+1;
    });
    // Sort keys, take last 6
    const keys = Object.keys(months).sort().slice(-6);
    regLabels = keys.map(k => {
      const [y,m] = k.split("-");
      return new Date(y, m-1).toLocaleString('default', { month:'short', year:'2-digit' });
    });
    regData = keys.map(k => months[k]);
  } catch (e) {
    regLabels = ["No Data"];
    regData = [0];
  }
  renderBarChart("registrationChart", regLabels, regData, "Registrations", "#ffe066");
}

// On DOM ready, render analytics
window.addEventListener("DOMContentLoaded", fetchAndRenderDashboardAnalytics);

/* ---- Count of Uploaders Card ---- */
async function fetchUploadersCount() {
  const resp = await fetch(API_URL + "users?role=uploader", { headers: { Authorization: "Bearer " + token } });
  const uploaders = await resp.json();
  document.getElementById("uploadersCount").innerText = uploaders.length;
}

/* ---- Fetch and List Uploaders ---- */
async function fetchUploaders() {
  const resp = await fetch(API_URL + "users?role=uploader", { headers: { Authorization: "Bearer " + token } });
  const uploaders = await resp.json();
  let html = "";
  for (const u of uploaders) {
    html += `<tr>
      <td>${u.fullname || "-"}</td>
      <td>${u.username}</td>
      <td>${u.email}</td>
      <td>${u.facultyName || "-"}</td>
      <td>${u.departmentName || "-"}</td>
      <td>${u.active ? "Active" : "Inactive"}</td>
      <td>
        <button class="action-btn" onclick="editUploader('${u._id}')">Edit</button>
        <button class="action-btn" onclick="deleteUploader('${u._id}')">Delete</button>
      </td>
    </tr>`;
  }
  document.querySelector("#uploadersTable tbody").innerHTML = html;
}

    
async function showUploaderModalWithData() {
  // Fetch faculties and departments if not already loaded or cache is empty
  if (!window.faculties || !window.faculties.length) {
    const facResp = await fetch(API_URL + "faculties", { headers: { Authorization: "Bearer " + token } });
    window.faculties = await facResp.json();
  }
  if (!window.departments || !window.departments.length) {
    const deptResp = await fetch(API_URL + "departments", { headers: { Authorization: "Bearer " + token } });
    window.departments = await deptResp.json();
  }
  openUploaderModal();
}

function openUploaderModal() {
  // Faculties and departments are arrays of {_id, name}
  let facultyOpts = (window.faculties||[]).map(f=>
    `<option value="${f._id}">${f.name}</option>`).join("");
  let deptOpts = (window.departments||[]).map(d=>
    `<option value="${d._id}">${d.name}</option>`).join("");
  let html = `
    <div class="modal-backdrop" onclick="closeUploaderModal(event)">
      <div class="modal" onclick="event.stopPropagation()">
        <button class="close-modal" onclick="closeUploaderModal(event)">&times;</button>
        <h2>Add Question Uploader</h2>
        <label>Full Name</label>
        <input id="uploaderFullName" type="text" required>
        <label>Username</label>
        <input id="uploaderUsername" type="text" required>
        <label>Email</label>
        <input id="uploaderEmail" type="email" required>
        <label>Password</label>
        <input id="uploaderPassword" type="password" required>
        <label>Faculty</label>
        <select id="uploaderFaculty" onchange="filterDepartmentsByFaculty()">
          <option value="">-- Select Faculty --</option>
          ${facultyOpts}
        </select>
        <label>Department</label>
        <select id="uploaderDepartment">
          <option value="">-- Select Department --</option>
          ${deptOpts}
        </select>
        <span id="uploaderMsg"></span>
        <button class="btn" onclick="submitAddUploader()">Create</button>
      </div>
    </div>`;
  document.getElementById("uploaderModalRoot").innerHTML = html;
}

function closeUploaderModal(e) {
  if (!e || e.target.classList.contains('modal-backdrop') || e.target.classList.contains('close-modal')) {
    document.getElementById("uploaderModalRoot").innerHTML = "";
  }
}

// Filter departments based on selected faculty
function filterDepartmentsByFaculty() {
  const facultyId = document.getElementById('uploaderFaculty').value;
  const deptSelect = document.getElementById('uploaderDepartment');
  const deptOpts = (window.departments||[])
    .filter(d => d.faculty === facultyId)
    .map(d => `<option value="${d._id}">${d.name}</option>`).join('');
  deptSelect.innerHTML = `<option value="">-- Select Department --</option>` + deptOpts;
}

async function submitAddUploader() {
  const fullname = document.getElementById("uploaderFullName").value.trim();
  const username = document.getElementById("uploaderUsername").value.trim();
  const email = document.getElementById("uploaderEmail").value.trim();
  const password = document.getElementById("uploaderPassword").value.trim();
  const faculty = document.getElementById("uploaderFaculty").value;
  const department = document.getElementById("uploaderDepartment").value;
  const msg = document.getElementById("uploaderMsg");
  msg.innerText = "";
  if (!fullname || !username || !email || !password || !faculty || !department) {
    msg.innerText = "All fields are required!";
    return;
  }
  try {
    const resp = await fetch(API_URL + "users", {
      method: "POST",
      headers: { "Content-Type": "application/json", Authorization: "Bearer " + token },
      body: JSON.stringify({
        fullname,
        username,
        email,
        password,
        role: "uploader",
        faculty,      // this is the ObjectId as string
        department    // this is the ObjectId as string
      })
    });
    if (!resp.ok) {
      let errMsg = "Failed to add uploader.";
      try {
        const err = await resp.json();
        errMsg = err.message || errMsg;
      } catch { /* ignore */ }
      msg.innerText = errMsg;
      return;
    }
    msg.innerText = "Uploader added!";
    fetchUploaders(); // Refresh list
    fetchUploadersCount();
    setTimeout(() => { closeUploaderModal(); }, 900);
  } catch (err) {
    msg.innerText = "Network error.";
    console.error(err);
  }
}

// Add this to your admin JS bundle (after your section logic)
let fbQuestions = [];
let fbFormId = null;
const FORMS_API = API_URL + "forms";

function openFormBuilderModal(editForm) {
  fbFormId = editForm?._id || null;
  fbQuestions = (editForm?.fields || []).map(f => ({...f}));
  document.getElementById("fbFormTitle").value = editForm?.title || "";
  document.getElementById("fbFormDesc").value = editForm?.description || "";
  renderFBQuestions();
  document.getElementById("formBuilderModal").style.display = "block";
}
function closeFormBuilderModal() {
  document.getElementById("formBuilderModal").style.display = "none";
  document.getElementById("fbFormMsg").innerText = "";
}
function renderFBQuestions() {
  const container = document.getElementById("fbQuestions");
  if (!container) return;
  container.innerHTML = fbQuestions.map((q, i) => `
    <div class="fb-q-card">
      <div>
        <input class="fb-q-label" value="${q.label || ''}" placeholder="Untitled Question" 
          onchange="fbUpdateQ(${i}, 'label', this.value)">
        <select class="fb-q-type" onchange="fbUpdateQ(${i},'type',this.value)">
          <option value="text" ${q.type==="text"?"selected":""}>Short answer</option>
          <option value="textarea" ${q.type==="textarea"?"selected":""}>Paragraph</option>
          <option value="radio" ${q.type==="radio"?"selected":""}>Multiple choice</option>
          <option value="checkbox" ${q.type==="checkbox"?"selected":""}>Checkboxes</option>
          <option value="select" ${q.type==="select"?"selected":""}>Dropdown</option>
          <option value="date" ${q.type==="date"?"selected":""}>Date</option>
          <option value="file" ${q.type==="file"?"selected":""}>File upload</option>
        </select>
        <label class="fb-q-required">
          <input type="checkbox" ${q.required?"checked":""} 
            onchange="fbUpdateQ(${i},'required',this.checked)"> Required
        </label>
        <span class="fb-q-toolbar">
          <button onclick="fbDuplicateQ(${i})" title="Duplicate">&#128209;</button>
          <button onclick="fbDeleteQ(${i})" title="Delete">&#128465;</button>
          ${i>0?`<button onclick="fbMoveQ(${i},-1)" title="Move up">&#8593;</button>`:""}
          ${i<fbQuestions.length-1?`<button onclick="fbMoveQ(${i},1)" title="Move down">&#8595;</button>`:""}
        </span>
      </div>
      <div class="fb-q-options">
        ${(["radio","checkbox","select"].includes(q.type)) ? 
          (q.options||[]).map((opt,oi)=>`
            <div class="fb-q-opt-row">
              <input value="${opt||''}" placeholder="Option" 
                onchange="fbUpdateQOpt(${i},${oi},this.value)">
              <button onclick="fbDeleteQOpt(${i},${oi})" title="Remove">x</button>
            </div>`).join("") +
            `<button onclick="fbAddQOpt(${i})">Add option</button>`
          : ""}
      </div>
    </div>
  `).join("");
}
function addFBQuestion() {
  fbQuestions.push({ label:"", type:"text", required:false, options:[] });
  renderFBQuestions();
}
function fbUpdateQ(idx, key, val) {
  fbQuestions[idx][key] = val;
  if (["radio","checkbox","select"].includes(fbQuestions[idx].type) && !fbQuestions[idx].options)
    fbQuestions[idx].options = [""];
  renderFBQuestions();
}
function fbAddQOpt(qidx) {
  fbQuestions[qidx].options = fbQuestions[qidx].options || [];
  fbQuestions[qidx].options.push("");
  renderFBQuestions();
}
function fbDeleteQOpt(qidx, oidx) {
  fbQuestions[qidx].options.splice(oidx,1);
  renderFBQuestions();
}
function fbUpdateQOpt(qidx, oidx, val) {
  fbQuestions[qidx].options[oidx] = val;
}
function fbDeleteQ(idx) { fbQuestions.splice(idx,1); renderFBQuestions(); }
function fbDuplicateQ(idx) { fbQuestions.splice(idx+1,0,{...fbQuestions[idx], options:[...(fbQuestions[idx].options||[])]}); renderFBQuestions(); }
function fbMoveQ(idx, dir) { 
  const q = fbQuestions.splice(idx,1)[0]; 
  fbQuestions.splice(idx+dir,0,q); 
  renderFBQuestions();
}
async function saveFBForm() {
  const title = document.getElementById("fbFormTitle").value.trim();
  const description = document.getElementById("fbFormDesc").value.trim();
  const fields = fbQuestions.map(q => ({...q}));
  const msg = document.getElementById("fbFormMsg");
  msg.innerText = "";
  if (!title) { msg.innerText = "Title required!"; return; }
  let ok = false;
  const payload = { title, description, fields };
  if (fbFormId) {
    const resp = await fetch(FORMS_API + "/" + fbFormId, { method:"PUT", headers: { "Content-Type": "application/json", Authorization: "Bearer " + token }, body: JSON.stringify(payload) });
    ok = resp.ok;
  } else {
    const resp = await fetch(FORMS_API, { method:"POST", headers: { "Content-Type": "application/json", Authorization: "Bearer " + token }, body: JSON.stringify(payload) });
    ok = resp.ok;
  }
  if (ok) {
    msg.innerText = "Saved!";
    fetchForms && fetchForms();
    setTimeout(closeFormBuilderModal, 1000);
  } else {
    msg.innerText = "Save failed!";
  }
}
// Fetch and display forms

async function fetchForms() {
  setSectionLoader("formsSection", true);
  try {
    const resp = await fetch(FORMS_API, { headers: { Authorization: "Bearer " + token } });
    const forms = await resp.json();
    window.formsCache = forms; // Store forms globally for Edit access
    let html = "";
    forms.forEach((form, i) => {
      html += `<tr>
        <td>${form.title}</td>
        <td>${new Date(form.createdAt).toLocaleString()}</td>
        <td>
          <button class="action-btn" onclick="openFormBuilderModal(window.formsCache[${i}])">Edit</button>
          <button class="action-btn" onclick="viewFormResponses('${form._id}')">Responses</button>
        </td>
      </tr>`;
    });
    document.querySelector("#formsTable tbody").innerHTML = html;
  } finally {
    setSectionLoader("formsSection", false);
  }
}
// View form responses
async function viewFormResponses(formId) {
  const respForm = await fetch(FORMS_API + "/" + formId, { headers: { Authorization: "Bearer " + token } });
  const form = await respForm.json();
  const respRes = await fetch(FORMS_API + "/" + formId + "/responses", { headers: { Authorization: "Bearer " + token } });
  const responses = await respRes.json();
  let html = `
    <div class="modal-backdrop" onclick="closeFormModal(event)">
      <div class="modal" onclick="event.stopPropagation()" style="max-width:900px;">
        <button class="close-modal" onclick="closeFormModal(event)">&times;</button>
        <h2>Responses for: ${form.title}</h2>
        <table class="data-table">
          <thead>
            <tr>
              ${(form.fields||[]).map(f=>`<th>${f.label}</th>`).join("")}
              <th>Submitted by</th>
              <th>At</th>
            </tr>
          </thead>
          <tbody>
            ${responses.map(resp => `<tr>
              ${(form.fields||[]).map((f,idx) => {
                const ansObj = (resp.answers||[]).find(a => String(a.fieldId) === String(f._id) || a.fieldId == idx);
                return `<td>${Array.isArray(ansObj?.value) ? ansObj.value.join(", ") : (ansObj?.value||"")}</td>`;
              }).join("")}
              <td>${resp.submittedBy?.username || "Anonymous"}</td>
              <td>${new Date(resp.createdAt).toLocaleString()}</td>
            </tr>`).join("")}
          </tbody>
        </table>
      </div>
    </div>
  `;
  document.getElementById("formModalRoot").innerHTML = html;
}
    // ========== INIT ==========
    async function init() {
      if (!token) return window.location.href = "index.html";
      document.getElementById("adminName").innerText = "Admin";
      await fetchFaculties();
      await fetchDepartments();
      await fetchDashboardCounts();
      await fetchSets();
      await fetchQuestions();
      await fetchResults();
      await fetchSchedules();
      await fetchNotifications();
    await fetchUploadersCount();
    }
    window.onload = init;
  </script>
</body>
</html>
