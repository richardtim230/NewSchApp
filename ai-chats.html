<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Academic Tutor Chat</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- MathJax and FontAwesome (keep for rendering) -->
  <script>
    window.MathJax = {
      tex: {
        inlineMath: [['$', '$'], ['\\(', '\\)']],
        displayMath: [['\\[', '\\]'], ['$$', '$$']]
      },
      options: {
        skipHtmlTags: ['script', 'noscript', 'style', 'textarea', 'pre','code'],
      }
    };
  </script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>
  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
  <style>
    :root {
      --primary:#2563eb;
      --secondary:#f1f5f9;
      --user:#dcfce7;
      --bot:#f3f4f6;
      --font:'Segoe UI',Arial,sans-serif;
    }
    body {
      background:var(--secondary);
      font-family:var(--font);
      margin:0;
      min-height:100vh;
    }
    /* Login Screen */
    .login-screen {
      width:100vw; height:100vh;
      display:flex; align-items:center; justify-content:center;
      background:var(--secondary);
      position:fixed; top:0; left:0; z-index:105;
      flex-direction:column;
    }
    .login-card {
      background:#fff;
      padding:38px 24px 32px 24px;
      border-radius:14px;
      box-shadow:0 7px 32px #2563eb21;
      min-width:295px; max-width:340px;
      display:flex; flex-direction:column; align-items:center; gap:12px;
      position:relative;
    }
    .login-header {
      display:flex; flex-direction:column; align-items:center; gap:9px; width:100%;
    }
    .login-logo {
      width:64px; height:64px; border-radius:50%;
      box-shadow:0 2px 8px #2221; object-fit:cover;
      margin-bottom:6px;
    }
    .login-header h2 {
      font-size:1.26rem; font-weight:700; margin:2px 0 6px 0;
      color:var(--primary);
      text-align:center;
    }
    .login-desc {
      font-size:1.03rem;
      color:#555;
      text-align:center; margin:0 0 9px 0;
      font-weight:420;
    }
    .login-card input {
      font-size:.99rem;
      width:100%;
      padding:12px;
      border-radius:10px;
      border:1px solid #e5e7eb;
      outline:none;
      margin-bottom:9px;
      margin-top:2px;
      background:#f7faff;
    }
    .login-card input:focus {
      border-color:var(--primary);
    }
    .login-btn {
      width:100%;
      padding:11px;
      background:var(--primary);
      color:#fff;
      border:none;
      border-radius:8px;
      font-size:1.04rem;
      margin-top:10px;
      cursor:pointer;
      font-weight:500;
      transition:background 0.16s;
    }
    .login-btn:hover {
      background:#193a7a;
    }
    .login-error {
      color:red;
      font-size:.97em;
      min-height:15px;
      text-align:center;
      margin-top:7px;
    }

    /* Main Chat Container */
    .chat-container {
      background:#fff;
      border-radius:16px;
      box-shadow:0 8px 24px rgba(0,0,0,0.09);
      width:100%; max-width:495px; min-width:320px;
      display:flex; flex-direction:column;
      height:100vh; position:relative;
      padding:0;
      margin:0 auto;
      overflow:hidden;
    }
    .chat-header {
      background:var(--primary);
      color:#fff;padding:19px 30px 13px 20px;
      font-size:1.22rem;font-weight:bold;
      text-align:left;display:flex;
      align-items:center;gap:13px;
      letter-spacing:0.2px;justify-content:space-between;
      border-top-left-radius:16px;
      border-top-right-radius:16px;
      min-height:60px;
    }
    .user-info-bar {
      display:flex; align-items:center;gap:10px;
      font-size:.99rem; font-weight:525;
    }
    .new-conversation-btn {
      background:var(--primary);
      color:#fff;
      border:none;
      border-radius:8px;
      font-size:0.99rem;
      font-weight:510;
      padding:8px 13px;
      cursor:pointer;
      margin-left:15px;
      transition:background 0.16s;
      display:flex; align-items:center; gap:6px;
      box-shadow:0 1px 3px #2563eb19;
    }
    .new-conversation-btn:hover {
      background:#1747a7;
    }

    /* Topics Bar */
    .chat-topics-bar {
      background:#f8fafc;
      border-bottom:1px solid #e5e7eb;
      padding:9px 21px;
      display:flex; align-items:center; gap:18px;
      min-height:50px;
      flex-wrap:wrap;
      position:relative;
      overflow-x:auto;
    }
    .topic-btn {
      padding:10px 19px;
      background:none;
      border:none;
      color:var(--primary);
      outline:none;
      font-size:1.05rem;
      font-weight:520;
      cursor:pointer;
      text-align:left;
      border-radius:10px;
      transition:background 0.15s;
      margin-right:8px;
      margin-top:3px;
      box-shadow: 0 1px 2px #e0eafb08;
      display:flex; align-items:center; gap:7px;
    }
    .topic-btn.active, .topic-btn:hover {
      background:#e6edfa; color:#1747a7;
      font-weight:600;
    }
    .new-topic-btn {
      background:#2563eb;
      color:#fff;
      border:none;
      border-radius:8px;
      font-size:0.98rem;
      padding:8px 11px;
      margin-left:10px;
      cursor:pointer;
      display:flex; align-items:center; gap:4px;
    }
    .new-topic-btn:hover {
      background:#1747a7;
    }

    /* Messages */
    .chat-messages {
      flex:1;
      overflow-y:auto;
      padding:14px 18px 2px 18px;
      background:var(--secondary);
      display:flex; flex-direction:column; gap:18px; position:relative;
      margin-bottom:95px; /* for fixed footer */
      min-height:0;
      transition:background 0.2s;
    }
    .typing-indicator {
      font-size:0.98rem;color:#789;margin-left:10px;
      animation:typingBlink 1.2s infinite;
      background:none;margin-top:2px;
    }
    @keyframes typingBlink {0%{opacity:1;}50%{opacity:0.42;}100%{opacity:1;}}

    .message-row {
      display:flex;
      align-items:flex-end; gap:12px;
      position:relative;
      width:100%;
    }
    .message-row.user { justify-content:flex-end; }
    .message-row.prof { justify-content:flex-start; }
    .message-avatar {
      width:27px;height:27px;
      border-radius:50%;object-fit:cover;
      box-shadow:0 2px 8px #2221;
    }
    .message-bubble {
      max-width:95%;
      margin:8px 0;
      padding:15px 18px;
      border-radius:16px 16px 4px 16px;
      font-size:0.99rem;
      background:var(--bot);color:#112;
      line-height:1.54;word-break:break-word;
      min-width:77px;position:relative;
      box-shadow:0 2px 12px #e5e7eb31;
    }
    .message-row.user .message-bubble { background:var(--user);color:#25633e;border-radius:16px 16px 16px 4px; }
    .message-meta {
      font-size:0.81rem;
      color:#777;margin:4px 0 0 0;
      text-align:right;margin-right:8px;
      display:flex;align-items:center;gap:2px;
    }
    .message-row.prof .message-meta { text-align:left;margin-left:8px; }

    /* Message actions */
    .message-actions {
      position:absolute;right:8px;top:8px;
      display:flex;gap:9px;opacity:0;
      transition:opacity 0.15s;
    }
    .message-row:hover .message-actions,
    .message-row:focus-within .message-actions {
      opacity:1;
    }
    .copy-btn, .edit-btn, .delete-btn {
      background:none;border:none;color:#888;
      font-size:1.03rem;cursor:pointer;padding:4px;
      border-radius:4px;
      transition:background 0.12s, color 0.12s;
    }
    .copy-btn:hover, .edit-btn:hover, .delete-btn:hover {
      background:#e7f0fd; color:#2563eb;
    }

    /* Rich markdown; math, lists, images, etc */
    .rich-block {margin:10px 0;padding:0 2vw;font-size:0.95em;}
    .rich-block h1,.rich-block h2,.rich-block h3,.rich-block h4 {margin:0.4em 0 0.1em 0;}
    .rich-block ul,.rich-block ol {margin-bottom:0.12em;padding-left:1em;}
    .rich-block li {margin-bottom:0.18em;line-height:1.37;font-size:0.98em;}
    .rich-block table {border:1px solid #c6c8d0;border-radius:6px;width:99%;margin:0.4em 0;background:#fff;}
    .rich-block th,.rich-block td {border:1px solid #e4e5eb;padding:6px 11px;}
    .math {font-size:1.09em;background:none!important;}

    /* Load more */
    .loadmore-btn {
      margin:2px auto 0 auto;display:block;
      padding:8px 22px;font-size:1.01rem;
      background:#eff2fa;color:#2563eb;
      border:none;border-radius:8px;cursor:pointer;
      box-shadow:1px 3px 8px 0 #a4b2db19;transition:background 0.14s;
    }
    .loadmore-btn:hover { background:#e0e0ee; }

    /* Fixed Footer / Input Bar */
    .fixed-footer {
      position:fixed;bottom:0;left:0;width:100vw;
      background:#fff;
      border-top:1px solid #e5e7eb;
      z-index:99;
      box-shadow:0 -2px 10px #2563eb11;
      padding:0 0 1px 0;
      height:88px;
      display:flex; align-items:center; justify-content:center;
    }
    .chat-input-bar-container {
      width:96vw; max-width:500px; margin:0 auto; position:relative;
    }
    .chat-input-bar {
      display:flex;align-items:center;
      padding:12px 8px 12px 8px;
      background:#fff;
      width:100%;
      gap:7px;min-width:210px;
      border:none;
      position:relative;
    }

    .chat-input {
      padding:11px 12px;
      font-size:1.07rem;
      border-radius:16px;
      border:1px solid #e5e7eb;
      outline:none;flex:1;resize:vertical;
      min-height:30px;max-height:92px;line-height:1.38;
      margin-right:6px;
      background:#f7faff;
    }
    .chat-input:focus { border-color:var(--primary); }

    .send-btn {
      background:var(--primary);
      color:#fff;
      border:none;
      border-radius:50%;
      width:37px;height:37px;
      cursor:pointer;display:flex;justify-content:center;align-items:center;
      font-size:1.22rem;
      margin-left:7px;
      transition:background 0.13s;
    }
    .send-btn:active { background:#1747a7; }

    /* Emoji & Attach */
    .emoji-btn,.attach-btn {
      background:none;
      border:none;
      font-size:1.12rem;
      color:#7d8dae;
      cursor:pointer;
      width:28px;height:38px;
      margin-right:2px;margin-top:2px;
      display:flex;align-items:center;justify-content:center;
      border-radius:8px;
      transition:background 0.12s, color 0.12s;
    }
    .emoji-btn:hover,.attach-btn:hover {
      background:#f4f8fd; color:#2563eb;
    }
    .emoji-picker {
      position:absolute;bottom:54px;left:-5px;
      background:#fff;
      border:1px solid #e5e7eb;
      box-shadow:0 2px 16px rgba(0,0,0,0.08);
      padding:8px 10px;
      border-radius:14px;display:none;
      z-index:101;
    }
    .emoji-picker.active {display:grid;grid-template-columns:repeat(8,1fr);gap:7px;max-width:250px;}
    .emoji-picker span {cursor:pointer;font-size:1.12rem;}
    .emoji-picker span:hover {transform:scale(1.16);background:#f1f5f9;border-radius:3px;}

    .attach-preview {max-width:120px;max-height:60px;border-radius:7px;margin:2px 0 0 0;display:block;}
    .attachment-link {color:#2563eb;font-size:0.87rem;display:flex;align-items:center;text-decoration:none;margin-top:0px;}
    .attachment-link i {margin-right:3px;}

    /* Delete conversation & delete history button */
    .delete-history-btn, .delete-conv-btn {
      background:#f5222d;
      color:#fff;border:none;
      border-radius:7px;
      padding:8px 12px;
      font-size:0.97rem;
      font-weight:520;
      cursor:pointer;
      margin-left:12px;
      transition:background 0.16s;
    }
    .delete-history-btn:hover, .delete-conv-btn:hover {
      background:#c81824;
    }

    @media(max-width:630px) {
      .chat-container {max-width:98vw;}
      .fixed-footer {width:100vw;}
      .chat-input-bar-container {max-width:99vw;}
    }
    @media(max-width:480px) {
      .chat-container {height:100vh;max-width:99vw;border-radius:0;}
      .fixed-footer {width:100vw;}
      .chat-input-bar-container{width:99vw;}
      .message-bubble{max-width:99vw;padding:13px 2vw;font-size:1.07rem;}
      .rich-block{padding:0 .8vw;}
      .chat-header{padding-left:7px;}
    }
  </style>
</head>
<body>
  <!-- LOGIN SCREEN -->
  <div id="loginScreen" class="login-screen" style="display:none;">
    <form class="login-card" id="loginForm">
      <div class="login-header">
        <img src="/logo.png" alt="Academic Tutor" class="login-logo">
        <h2>Welcome to Academic Tutor</h2>
        <p class="login-desc">Your personal academic assistant</p>
      </div>
      <input type="text" id="loginUsername" placeholder="Username" autocomplete="username" required>
      <input type="password" id="loginPassword" placeholder="Password" autocomplete="current-password" required>
      <button type="submit" class="login-btn">Login</button>
      <div id="loginError" class="login-error"></div>
    </form>
  </div>

  <!-- MAIN CHAT CONTAINER -->
  <div class="chat-container" id="chatContainer" style="display:none;">
    <div class="chat-header">
      <span><i class="fas fa-graduation-cap"></i> Academic Tutor</span>
      <button class="new-conversation-btn" id="newConvBtn"><i class="fa fa-plus"></i> New Conversation</button>
      <span class="user-info-bar" id="userInfoBar"></span>
    </div>

    <!-- TOPICS AREA (buttons and new topic) -->
    <div class="chat-topics-bar" id="topicsBar">
      <button class="topic-btn active"><i class="fa fa-book"></i> General</button>
      <button class="topic-btn" id="newTopicBtn"><i class="fa fa-plus"></i> New Topic</button>
    </div>
    <!-- Optionally show delete history for current topic -->
    <button class="delete-history-btn" id="deleteHistoryBtn" style="display:none;"><i class="fa fa-trash"></i> Delete History</button>

    <div class="chat-messages" id="chatMessages">
      <div class="typing-indicator" id="typingIndicator" style="display:none;">Professor is typing...</div>
    </div>
    <button id="loadMoreBtn" class="loadmore-btn" style="display:none;">Load More</button>
    <!-- Fixed Footer for Input -->
    <div class="fixed-footer">
      <div class="chat-input-bar-container">
        <form class="chat-input-bar" id="chatForm" autocomplete="off">
          <button type="button" class="emoji-btn" id="emojiBtn" title="Emoji Picker"><i class="fa-regular fa-face-grin"></i></button>
          <div class="emoji-picker" id="emojiPicker"></div>
          <button type="button" class="attach-btn" id="attachBtn" title="Attach image"><i class="fa-solid fa-paperclip"></i></button>
          <input type="file" style="display:none;" id="attachInput" accept="image/*"/>
          <textarea class="chat-input" id="chatInput" rows="2"
            placeholder="Type your academic question... (Shift+Enter for newline, $math$ or block \[math\])"
            autocomplete="off"></textarea>
          <button type="submit" class="send-btn" title="Send"><i class="fa-solid fa-paper-plane"></i></button>
        </form>
      </div>
    </div>
  </div>
  <script src="ai-chat.js"></script>
</body>
</html>
