<!DOCTYPE html>
<html lang="en" class="h-full bg-gray-50">
<head>
  <meta charset="UTF-8">
  <title>Admin - Create Task | OAU ExamGuard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="icon" href="/favicon.ico">
  <style>
    .form-section { background: #fff; border-radius: 1rem; box-shadow: 0px 4px 24px rgba(40,82,160,0.08); }
    .fade-in { animation: fadein .7s; }
    @keyframes fadein { from { opacity: 0; transform: translateY(14px);} to {opacity:1; transform:none;} }
    input[type="date"]:invalid { color: gray; }
    .input-label {font-weight: 500;}
    .input-error {color: #ef4444;}
  </style>
</head>
<body class="h-full bg-gradient-to-tr from-indigo-100 to-blue-100 min-h-screen flex flex-col">
  <!-- Admin Navigation Bar -->
  <header class="bg-white shadow mb-2 fade-in">
    <div class="max-w-6xl mx-auto flex items-center justify-between py-4 px-4">
      <span class="text-2xl font-bold text-indigo-800 tracking-tight">üõ†Ô∏è Admin Dashboard</span>
	<nav>
	  <a class="text-indigo-500 font-medium px-4 py-1 hover:underline" href="/admin-create-task.html">Create Task</a>
	  <a class="text-gray-700 font-medium px-4 py-1 hover:text-indigo-700" href="/admin-tasks-list.html">All Tasks</a>
	</nav>
    </div>
  </header>

  <!-- Create Task Section -->
  <main class="flex-1 max-w-2xl mx-auto pt-8 p-4 fade-in mb-12">
    <div class="form-section p-8">
      <h1 class="text-2xl font-bold text-indigo-800 mb-6">Create a New Task</h1>
      <form id="taskForm" class="space-y-5">
        <div>
          <label class="block input-label mb-1" for="title">Title <span class="text-red-500">*</span></label>
          <input id="title" name="title" required maxlength="120"
                 class="w-full border rounded-lg p-2 focus:outline-none focus:ring-2 focus:ring-indigo-400 transition"
                 type="text" placeholder="e.g. Watch: 'How to Study Effectively'">
        </div>
        <div>
          <label class="block input-label mb-1" for="description">Description</label>
          <textarea id="description" name="description" rows="2"
            class="w-full border rounded-lg p-2 focus:outline-none focus:ring-2 focus:ring-indigo-400 transition"
            placeholder="Optional details for the user..."></textarea>
        </div>
        <div class="md:flex gap-5">
          <div class="flex-1 mb-3 md:mb-0">
            <label class="block input-label mb-1" for="activityType">Task Type <span class="text-red-500">*</span></label>
            <select id="activityType" name="activityType"
              class="w-full border rounded-lg p-2" required>
              <option value="reading">Reading</option>
              <option value="video">Video</option>
              <option value="mocktest">Mock Test</option>
              <option value="social">Social</option>
              <option value="assignment">Assignment</option>
              <option value="goal">Goal</option>
              <option value="profile">Profile</option>
              <option value="custom">Custom</option>
            </select>
          </div>
          <div class="flex-1">
            <label class="block input-label mb-1" for="points">Points</label>
            <input id="points" name="points" class="w-full border rounded-lg p-2" type="number" min="0" step="1" value="10">
          </div>
        </div>
        <div class="md:flex gap-5">
          <div class="flex-1 mb-3 md:mb-0">
            <label class="block input-label mb-1" for="status">Status</label>
            <select id="status" name="status"
              class="w-full border rounded-lg p-2">
              <option value="active" selected>Active</option>
              <option value="pending">Pending</option>
              <option value="overdue">Overdue</option>
              <option value="done">Done</option>
            </select>
          </div>
          <div class="flex-1">
            <label class="block input-label mb-1" for="dueDate">Due Date</label>
            <input id="dueDate" name="dueDate" class="w-full border rounded-lg p-2" type="date" min="">
          </div>
        </div>
        <!-- Dynamic extra fields (metadata) -->
        <div id="metaFields" class="space-y-4"></div>

        <div>
          <label class="block input-label mb-1" for="user">Assign To User (User ID, optional)</label>
          <input id="user" name="user"
                 class="w-full border rounded-lg p-2" type="text"
                 placeholder="Leave blank for all users or enter User ID">
        </div>
        <div>
          <label class="block input-label mb-1" for="tags">Tags <span class="text-xs text-gray-500">(comma-separated)</span></label>
          <input id="tags" name="tags"
                 class="w-full border rounded-lg p-2" type="text"
                 placeholder="motivation, study, math">
        </div>
        <div>
          <p id="formError" class="input-error mb-2 h-4"></p>
          <button type="submit"
                  class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 rounded-lg transition tracking-wide">Create Task</button>
        </div>
      </form>
      <div id="submitSuccess" class="hidden mt-6 p-4 bg-green-50 border text-green-700 border-green-300 rounded">Task created successfully!</div>
    </div>
  </main>

  <script>
    // Set min date for 'dueDate'
    document.getElementById('dueDate').min = new Date().toISOString().slice(0,10);

    // For demo: show extra metadata fields based on task type
    const metaFieldsDefs = {
      reading: [
        {name: "duration", label: "Duration (e.g. '10 min')", type: "text"},
        {name: "url", label: "Article URL", type: "url"}
      ],
      video: [
        {name: "duration", label: "Duration (e.g. '8 min')", type: "text"},
        {name: "url", label: "YouTube Embed URL", type: "url"}
      ],
      social: [
        {name: "platform", label: "Platform (Facebook, IG, etc.)", type: "text"},
        {name: "url", label: "Social Link URL", type: "url"}
      ],
      mocktest: [
        {name: "url", label: "Test Link/URL", type: "url"},
        {name: "course", label: "Course Info", type: "text"}
      ],
      assignment: [
        {name: "deadline", label: "Assignment Deadline", type: "date"},
        {name: "instructions", label: "Instructions", type: "textarea"}
      ],
      // Add more as desired! Custom = no extra fields
    };

    function showMetaFields(type) {
      const container = document.getElementById("metaFields");
      container.innerHTML = "";
      const fields = metaFieldsDefs[type] || [];
      for (const field of fields) {
        let html = "";
        if (field.type === "textarea") {
          html = `<label class="block input-label mb-1" for="meta_${field.name}">${field.label}</label>
            <textarea id="meta_${field.name}" name="meta_${field.name}" rows="2"
              class="w-full border rounded-lg p-2"></textarea>`;
        } else {
          html = `<label class="block input-label mb-1" for="meta_${field.name}">${field.label}</label>
            <input id="meta_${field.name}" name="meta_${field.name}" type="${field.type}"
              class="w-full border rounded-lg p-2" />`;
        }
        container.insertAdjacentHTML("beforeend", `<div>${html}</div>`);
      }
    }

    // Initial fields
    showMetaFields(document.getElementById('activityType').value);
    document.getElementById('activityType').addEventListener('change', e => {
      showMetaFields(e.target.value);
    });

    // Submission
    document.getElementById('taskForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      document.getElementById('formError').textContent = "";

      const title = this.title.value.trim();
      const activityType = this.activityType.value;
      const description = this.description.value.trim();
      const points = parseInt(this.points.value) || 0;
      const status = this.status.value;
      const dueDate = this.dueDate.value || null;
      const user = this.user.value.trim() || undefined; // Optional
      const tags = this.tags.value.split(',').map(t => t.trim()).filter(Boolean);

      // Meta
      const meta = {};
      const metaFields = metaFieldsDefs[activityType] || [];
      for (const field of metaFields) {
        const val = this[`meta_${field.name}`].value;
        if(val) meta[field.name] = val;
      }

      // Required
      if (!title) {
        document.getElementById('formError').textContent = "Title is required.";
        return;
      }
      if (!activityType) {
        document.getElementById('formError').textContent = "Task type is required.";
        return;
      }

      // Prepare data payload
      const payload = { title, activityType, description, points, meta, status, dueDate, tags };
      if(user) payload.user = user;

      // Optional: Add Bearer token
      let headers = { "Content-Type": "application/json" };
      const token = localStorage.getItem("token");
      if(token) headers.Authorization = "Bearer " + token;

      // Send to backend
      try {
        const res = await fetch("https://examguide.onrender.com/api/tasks", {
          method: "POST",
          headers,
          body: JSON.stringify(payload)
        });
        if (!res.ok) {
          const data = await res.json().catch(() => ({}));
          document.getElementById('formError').textContent = data.error || data.message || "Could not create task.";
          return;
        }
        this.reset();
        showMetaFields(document.getElementById('activityType').value); // reset meta
        document.getElementById('submitSuccess').classList.remove('hidden');
        setTimeout(() => {
          document.getElementById('submitSuccess').classList.add('hidden');
        }, 3000);
      } catch (err) {
        document.getElementById('formError').textContent = "Network error, please retry.";
      }
    });

  </script>
</body>
</html>
