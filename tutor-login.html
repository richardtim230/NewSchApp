<!DOCTYPE html>
<html lang="en" class="h-full bg-slate-50">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>OAU ExamGuard â€” Login</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css"/>
  <style>
    .input-label { font-weight: 600; font-size: 15px; color: #6366f1; }
    .input-base {
      background: #fff; border: 1px solid #e6e6f0; border-radius: 10px;
      font-size: 16px; padding: .85rem 1rem; width: 100%;
      box-sizing: border-box;
    }
    .card {
      background: #fff; border-radius: 14px; box-shadow: 0 8px 36px rgba(15,23,42,0.06);
    }
    .brand { color: #273c75; font-weight: 800; letter-spacing: -0.02em; }
    .muted { color: #6b7280; }
    .link-like { color: #4f46e5; text-decoration: underline; }
    .visually-hidden { position: absolute; left:-10000px; top:auto; width:1px; height:1px; overflow:hidden; }
  </style>
</head>
<body class="h-full font-sans antialiased">

  <header class="bg-white border-b fixed top-0 left-0 right-0 z-30">
    <div class="max-w-5xl mx-auto px-4 py-3 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <img src="https://ui-avatars.com/api/?name=OAU&background=ede9fe&color=3b82f6&size=48" alt="OAU ExamGuard" class="w-10 h-10 rounded-md" />
        <div>
          <div class="brand text-lg">OAU ExamGuard</div>
          <div class="text-xs muted">Tutors & Students platform</div>
        </div>
      </div>
      <nav class="hidden sm:flex gap-4">
        <a href="tutor-reg.html" class="text-sm link-like">Become a Tutor</a>
        <a href="#" class="text-sm muted">Help</a>
      </nav>
    </div>
  </header>

  <main class="min-h-screen pt-24 pb-12">
    <div class="max-w-5xl mx-auto px-4 grid grid-cols-1 lg:grid-cols-2 gap-10 items-center">

      <!-- Marketing / left column -->
      <section class="hidden lg:block">
        <div class="mb-6">
          <h1 class="text-3xl font-extrabold text-indigo-900">Welcome back</h1>
          <p class="mt-2 text-lg muted">Log in to your dashboard to manage sessions, assignments, and earnings.</p>
        </div>

        <div class="card p-6">
          <h3 class="font-bold text-indigo-700 mb-3">Why sign in?</h3>
          <ul class="list-disc ml-5 space-y-2 muted">
            <li>Access your tutor dashboard & assignments</li>
            <li>Accept student requests and schedule sessions</li>
            <li>View earnings and request withdrawals</li>
            <li>Receive messages and notifications</li>
          </ul>
        </div>
      </section>

      <!-- Login form -->
      <section>
        <div class="card p-8">
          <h2 class="text-2xl font-bold text-indigo-800 mb-2">Sign in to ExamGuard</h2>
          <p class="text-sm muted mb-6">Use your username or email and password to log in.</p>

          <form id="loginForm" autocomplete="off" novalidate>
            <div class="mb-4">
              <label for="username" class="input-label block mb-2">Username or Email</label>
              <input id="username" name="username" type="text" class="input-base" placeholder="e.g. jane.doe or jane@example.com" required />
            </div>

            <div class="mb-4 relative">
              <label for="password" class="input-label block mb-2">Password</label>
              <input id="password" name="password" type="password" class="input-base pr-12" placeholder="Your password" required />
              <button type="button" id="togglePassword" aria-label="Show password" class="absolute right-3 top-11 text-slate-400">
                <i class="fa fa-eye"></i>
              </button>
            </div>

            <div class="flex items-center justify-between mb-4">
              <label class="flex items-center gap-2 text-sm muted">
                <input id="remember" type="checkbox" class="h-4 w-4" />
                Remember me
              </label>
              <a id="forgotLink" href="#" class="text-sm link-like">Forgot password?</a>
            </div>

            <div class="mb-4">
              <button id="submitBtn" type="submit" class="w-full bg-indigo-700 hover:bg-indigo-800 text-white font-semibold py-3 rounded-lg">
                <span id="btnText">Sign in</span>
                <svg id="btnSpinner" class="hidden animate-spin w-5 h-5 inline-block ml-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                  <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                  <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v8H4z"></path>
                </svg>
              </button>
            </div>

            <div id="message" class="text-sm text-center h-6"></div>

            <div class="mt-6 text-center text-sm muted">
              Don't have an account? <a href="tutor-reg.html" class="link-like font-medium">Register as a tutor</a>
            </div>

            <!-- Hidden accessible status for screen readers -->
            <p id="srStatus" class="visually-hidden" aria-live="polite"></p>
          </form>
        </div>

        <div class="mt-4 text-xs muted">
          By signing in you agree to our <a class="link-like" href="#">Terms</a> and <a class="link-like" href="#">Privacy</a>.
        </div>
      </section>
    </div>
  </main>

<script>
/*
  Login page JavaScript
  - Sends POST to https://examguide.onrender.com/api/auth/login
  - If successful: stores token (localStorage if Remember checked, else sessionStorage)
    and redirects to /dashboard (customize as needed).
  - Handles common error responses and displays messages.
*/

const API_BASE = 'https://examguide.onrender.com';
const form = document.getElementById('loginForm');
const usernameEl = document.getElementById('username');
const passwordEl = document.getElementById('password');
const rememberEl = document.getElementById('remember');
const submitBtn = document.getElementById('submitBtn');
const btnText = document.getElementById('btnText');
const btnSpinner = document.getElementById('btnSpinner');
const messageEl = document.getElementById('message');
const srStatus = document.getElementById('srStatus');
const togglePassword = document.getElementById('togglePassword');
const forgotLink = document.getElementById('forgotLink');

togglePassword.addEventListener('click', () => {
  if (passwordEl.type === 'password') {
    passwordEl.type = 'text';
    togglePassword.innerHTML = '<i class="fa fa-eye-slash"></i>';
  } else {
    passwordEl.type = 'password';
    togglePassword.innerHTML = '<i class="fa fa-eye"></i>';
  }
});

forgotLink.addEventListener('click', (e) => {
  e.preventDefault();
  const usernameOrEmail = usernameEl.value.trim();
  if (!usernameOrEmail) {
    showMessage('Enter your username or email above, then click "Forgot password" again.', 'amber');
    return;
  }
  // Open password reset flow: this page expects backend route /api/auth/resend-verification or /api/auth/reset
  // We will open a small prompt to ask whether to request reset via email or studentId (depending on backend)
  const proceed = confirm('We will send a password reset / verification email if this account exists. Continue?');
  if (!proceed) return;
  sendResendRequest(usernameOrEmail);
});

async function sendResendRequest(usernameOrEmail) {
  setLoading(true);
  try {
    const res = await fetch(`${API_BASE}/api/auth/resend-verification`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ usernameOrEmail })
    });
    const json = await res.json();
    if (!res.ok) throw new Error(json?.message || 'Request failed');
    showMessage(json.message || 'Email sent if the account exists.', 'green');
  } catch (err) {
    console.error('Resend error', err);
    showMessage(err.message || 'Could not send request', 'red');
  } finally {
    setLoading(false);
  }
}

form.addEventListener('submit', async (e) => {
  e.preventDefault();
  messageEl.textContent = '';
  srStatus.textContent = '';

  const identifier = usernameEl.value.trim();
  const password = passwordEl.value;

  if (!identifier || !password) {
    showMessage('Please provide username/email and password.', 'red');
    return;
  }

  setLoading(true);
  try {
    const resp = await fetch(`${API_BASE}/api/auth/login`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ username: identifier, password })
    });
    const data = await resp.json();

    if (!resp.ok) {
      // Helpful messages for common cases
      const msg = data?.message || data?.error || resp.statusText || 'Login failed';
      if (/not verified|verify/i.test(msg)) {
        showMessage('Account not verified. Check your email for verification link or click "Forgot password" to resend.', 'amber');
      } else if (/not yet activated|forbidden|inactive/i.test(msg)) {
        showMessage(msg, 'amber');
      } else {
        showMessage(msg, 'red');
      }
      return;
    }

    const token = data?.token;
    if (!token) {
      showMessage('Login succeeded but no token received. Contact support.', 'amber');
      return;
    }

    // Store token (remember => localStorage, else sessionStorage)
    if (rememberEl.checked) {
      localStorage.setItem('examguard_token', token);
    } else {
      sessionStorage.setItem('examguard_token', token);
    }

    // Optional: store minimal profile or fetch /api/auth/me (requires auth header)
    // We'll try to fetch the user profile and store it.
    try {
      const userRes = await fetch(`${API_BASE}/api/auth/me`, {
        headers: { Authorization: `Bearer ${token}` }
      });
      if (userRes.ok) {
        const userJson = await userRes.json();
        // backend returns { user } or similar per index.js; handle both shapes
        const userObj = userJson?.user || userJson;
        if (userObj) {
          // Save a small safe copy
          const safe = {
            id: userObj._id || userObj.id,
            username: userObj.username || userObj.email,
            fullname: userObj.fullname || '',
            role: userObj.role || ''
          };
          if (rememberEl.checked) localStorage.setItem('examguard_user', JSON.stringify(safe));
          else sessionStorage.setItem('examguard_user', JSON.stringify(safe));
        }
      }
    } catch (ignore) {
      // ignore profile fetch errors (not critical)
      console.warn('Could not fetch profile after login', ignore);
    }

    showMessage(data?.message || 'Login successful. Redirecting...', 'green');
    // Redirect to dashboard; adjust path as needed
    setTimeout(() => {
      const redirectTo = '/dashboard.html'; // change if your app has a specific dashboard route
      window.location.href = redirectTo;
    }, 900);

  } catch (err) {
    console.error('Login error', err);
    showMessage(err.message || 'Login failed', 'red');
  } finally {
    setLoading(false);
  }
});

function setLoading(on) {
  submitBtn.disabled = on;
  btnSpinner.classList.toggle('hidden', !on);
  btnText.textContent = on ? 'Signing in...' : 'Sign in';
}

function showMessage(msg, level = 'neutral') {
  messageEl.textContent = msg;
  srStatus.textContent = msg;
  switch (level) {
    case 'green':
      messageEl.style.color = '#065f46';
      break;
    case 'amber':
      messageEl.style.color = '#92400e';
      break;
    case 'red':
      messageEl.style.color = '#9b1c1c';
      break;
    default:
      messageEl.style.color = '#374151';
  }
}
</script>
</body>
</html>
