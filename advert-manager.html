<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Ad Management Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .modal-bg { background: rgba(0,0,0,0.35); }
    .spinner {
      border: 2px solid #e5e7eb;
      border-top: 2px solid #2563eb;
      border-radius: 50%;
      width: 1.25em;
      height: 1.25em;
      animation: spin 0.7s linear infinite;
      display: inline-block;
      vertical-align: middle;
    }
    @keyframes spin {
      0% { transform: rotate(0deg);}
      100% { transform: rotate(360deg);}
    }
  </style>
</head>
<body class="bg-gray-100 min-h-screen font-sans">
  <div class="max-w-4xl mx-auto px-2 py-6">
    <div class="flex justify-between items-center mb-6">
      <h1 class="text-2xl font-bold text-blue-800">Advertisement Admin Dashboard</h1>
      <button id="addAdBtn" class="bg-blue-600 text-white px-5 py-2 rounded-lg font-semibold hover:bg-blue-700 transition">+ New Ad</button>
    </div>
    <div id="adsTable" class="bg-white rounded-xl shadow p-4"></div>
  </div>

  <!-- APK Upload Section -->
  <div class="max-w-4xl mx-auto px-2 py-6 mt-10">
    <div class="bg-white rounded-xl shadow p-6">
      <h2 class="text-xl font-semibold text-green-700 mb-3 flex items-center gap-2">
        <svg width="22" height="22" fill="none"><path fill="#22c55e" d="M13.46 4.49c0 .07.02.13.06.19l3.59 6.23c.06.11.05.24-.02.34l-6.84 9.69c-.07.1-.19.16-.31.16h-.01a.36.36 0 0 1-.31-.19l-3.6-6.23a.34.34 0 0 1 0-.34l6.84-9.68a.36.36 0 0 1 .6.17ZM11 2.5c-.46 0-.89.24-1.13.63l-6.84 9.68a1.83 1.83 0 0 0-.04 1.85l3.6 6.23c.22.38.62.61 1.05.61h.01c.43 0 .83-.22 1.05-.61l6.84-9.69c.22-.38.22-.86-.01-1.24l-3.59-6.23A1.32 1.32 0 0 0 11 2.5Zm0 1.5c.08 0 .16.04.21.12l3.59 6.23a.34.34 0 0 1 0 .34l-6.84 9.68a.36.36 0 0 1-.6-.17l-3.6-6.23a.36.36 0 0 1 .02-.34l6.84-9.68A.36.36 0 0 1 11 4Zm.01 4.49c-.29 0-.53.22-.53.5v2.01h-2a.5.5 0 1 0 0 1h2v2.01a.5.5 0 1 0 1 0v-2.01h2a.5.5 0 1 0 0-1h-2v-2a.49.49 0 0 0-.47-.5Z"/></svg>
        APK Uploader
      </h2>
      <form id="apkUploadForm" class="flex flex-col md:flex-row items-center gap-4" enctype="multipart/form-data">
        <input type="file" name="apk" id="apkInput" accept=".apk" required class="flex-1 px-3 py-2 border rounded text-sm" />
        <button type="submit" id="apkUploadBtn" class="bg-green-600 text-white px-6 py-2 rounded font-semibold hover:bg-green-700 flex items-center gap-2">
          <span id="apkUploadSpinner" class="hidden spinner"></span>
          <span>Upload APK</span>
        </button>
      </form>
      <div id="apkUploadMsg" class="mt-4"></div>
      <div id="apkDownloadLink" class="mt-3"></div>
    </div>
  </div>

  <!-- Ad Modal (Create/Edit) -->
  <div id="adModal" class="fixed inset-0 z-50 items-center justify-center hidden modal-bg">
    <div class="bg-white rounded-xl shadow-lg max-w-lg w-full mx-auto p-0 overflow-hidden">
      <div class="flex items-center justify-between px-6 py-4 border-b">
        <div id="modalTitle" class="font-bold text-lg text-blue-700"></div>
        <button onclick="closeAdModal()" class="text-2xl text-gray-400 hover:text-gray-700">&times;</button>
      </div>
      <form id="adForm" class="px-6 py-4 flex flex-col gap-4" autocomplete="off">
        <input type="hidden" name="adId" id="adId" />
        <label class="block">
          <span class="font-medium text-gray-700">Ad Type</span>
          <select name="type" id="adType" required class="w-full mt-1 px-3 py-2 border rounded">
            <option value="">Select type...</option>
            <option value="image">Image</option>
            <option value="url">URL (redirect)</option>
            <option value="video">Video</option>
            <option value="html">HTML</option>
            <option value="text">Text</option>
          </select>
        </label>
        <label class="block" id="contentLabel">
          <span class="font-medium text-gray-700">Content</span>
          <input type="text" name="content" id="adContent" required placeholder="Image/Video URL, Redirect URL, HTML, or Text" class="w-full px-3 py-2 border rounded" />
          <div id="imageUploadSection" class="hidden mt-2">
            <input type="file" accept="image/*" id="imageUploadInput" class="block w-full text-sm text-gray-600" />
            <div id="imagePreview" class="mt-2"></div>
          </div>
        </label>
        <label class="block">
          <span class="font-medium text-gray-700">Meta Title</span>
          <input type="text" name="metaTitle" id="adMetaTitle" placeholder="Optional" class="w-full px-3 py-2 border rounded" />
        </label>
        <label class="block">
          <span class="font-medium text-gray-700">Meta Description</span>
          <input type="text" name="metaDesc" id="adMetaDesc" placeholder="Optional" class="w-full px-3 py-2 border rounded" />
        </label>
        <div>
          <span class="font-medium text-gray-700">Actions</span>
          <div id="actionsList" class="space-y-2 mt-1"></div>
          <button type="button" onclick="addActionRow()" class="mt-2 px-3 py-1 bg-gray-200 rounded text-sm hover:bg-gray-300">+ Add Action</button>
        </div>
        <div class="flex justify-end gap-3 pt-2">
          <button type="button" onclick="closeAdModal()" class="px-5 py-2 bg-gray-300 text-gray-700 rounded hover:bg-gray-400">Cancel</button>
          <button id="saveAdBtn" type="submit" class="px-5 py-2 bg-blue-600 text-white rounded font-semibold hover:bg-blue-700 flex items-center gap-2">
            <span id="saveAdBtnSpinner" class="hidden spinner"></span>
            <span>Save</span>
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Delete Confirm Modal -->
  <div id="deleteModal" class="fixed inset-0 z-50 items-center justify-center hidden modal-bg">
    <div class="bg-white rounded-xl shadow-lg max-w-sm w-full mx-auto mt-40 p-0 overflow-hidden">
      <div class="px-6 py-4">
        <div class="font-bold text-lg text-red-700 mb-2">Delete Advertisement?</div>
        <div class="mb-4 text-gray-700">Are you sure you want to permanently delete this advertisement?</div>
        <div class="flex justify-end gap-3">
          <button onclick="closeDeleteModal()" class="px-4 py-2 bg-gray-300 rounded hover:bg-gray-400 text-gray-800">Cancel</button>
          <button id="confirmDeleteBtn" class="px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700 font-semibold flex items-center gap-2">
            <span id="deleteAdBtnSpinner" class="hidden spinner"></span>
            <span>Delete</span>
          </button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // --- APK Upload Section ---
    document.getElementById('apkUploadForm').onsubmit = async function(e) {
      e.preventDefault();
      const apkInput = document.getElementById('apkInput');
      const file = apkInput.files[0];
      const msgDiv = document.getElementById('apkUploadMsg');
      const linkDiv = document.getElementById('apkDownloadLink');
      const btn = document.getElementById('apkUploadBtn');
      const spinner = document.getElementById('apkUploadSpinner');
      msgDiv.textContent = '';
      linkDiv.textContent = '';
      btn.disabled = true;
      spinner.classList.remove('hidden');
      try {
        const formData = new FormData();
        formData.append('apk', file);
        // Use your backend APK endpoint (adjust if needed)
        const res = await fetch('https://examguard-jmvj.onrender.com/api/apk', {
          method: 'POST',
          body: formData
        });
        const data = await res.json();
        if (data.url) {
          // Guarantee download by adding ?fl_attachment
          // file is the File you uploaded
const fileName = file.name; // e.g., myapp.apk
const downloadUrl = cloudinaryUrl + "?fl_attachment=" + encodeURIComponent(fileName);
          linkDiv.innerHTML = `<a href="${downloadUrl}" target="_blank" rel="noopener" class="text-green-700 underline font-semibold break-all">
            Download APK &darr;
          </a>
          <div class="text-xs text-gray-500 mt-1 break-all">${downloadUrl}</div>`;
          msgDiv.textContent = "APK uploaded successfully!";
          msgDiv.className = "mt-4 text-green-600 font-semibold";
        } else {
          msgDiv.textContent = "Upload failed.";
          msgDiv.className = "mt-4 text-red-600 font-semibold";
        }
      } catch (err) {
        msgDiv.textContent = "Upload error. Try again.";
        msgDiv.className = "mt-4 text-red-600 font-semibold";
      }
      btn.disabled = false;
      spinner.classList.add('hidden');
    };

    // --- State ---
    let ads = [];
    let editingAd = null;
    let deletingAdId = null;

    // --- Helpers ---
    function escapeHTML(s) {
      return (s||"").replace(/[<>&'"]/g, c =>
        ({'<':'&lt;','>':'&gt;','&':'&amp;','\'':'&#39;','"':'&quot;'}[c]));
    }

    // --- Modal Controls ---
    function openAdModal(ad = null) {
      editingAd = ad;
      document.getElementById('adModal').style.display = 'flex';
      document.getElementById('modalTitle').textContent = ad ? "Edit Advertisement" : "New Advertisement";
      document.getElementById('adForm').reset();
      document.getElementById('adId').value = ad? ad._id : "";
      document.getElementById('adType').value = ad? ad.type : "";
      document.getElementById('adContent').value = ad? ad.content : "";
      document.getElementById('adMetaTitle').value = ad?.meta?.title || "";
      document.getElementById('adMetaDesc').value = ad?.meta?.description || "";
      renderActionsList(ad?.actions || []);

      // Set up the image upload area if editing an image ad
      const adType = ad ? ad.type : "";
      const imageSection = document.getElementById('imageUploadSection');
      const contentInput = document.getElementById('adContent');
      const imagePreview = document.getElementById('imagePreview');
      if (adType === "image") {
        imageSection.classList.remove('hidden');
        contentInput.placeholder = "Image URL will appear here after upload";
        contentInput.readOnly = true;
        if (ad && ad.content) {
          imagePreview.innerHTML = `<img src="${escapeHTML(ad.content)}" class="max-h-32 mt-1 rounded border" alt="Ad Image Preview" />`;
        } else {
          imagePreview.innerHTML = "";
        }
      } else {
        imageSection.classList.add('hidden');
        contentInput.placeholder = "Image/Video URL, Redirect URL, HTML, or Text";
        contentInput.readOnly = false;
        imagePreview.innerHTML = "";
      }
    }
    function closeAdModal() {
      document.getElementById('adModal').style.display = 'none';
      editingAd = null;
      renderActionsList([]);
      // Reset spinners
      document.getElementById('saveAdBtnSpinner').classList.add('hidden');
    }
    function openDeleteModal(adId) {
      deletingAdId = adId;
      document.getElementById('deleteModal').style.display = 'flex';
      // Reset spinner
      document.getElementById('deleteAdBtnSpinner').classList.add('hidden');
    }
    function closeDeleteModal() {
      deletingAdId = null;
      document.getElementById('deleteModal').style.display = 'none';
      document.getElementById('deleteAdBtnSpinner').classList.add('hidden');
    }

    // --- Render Actions ---
    function renderActionsList(actions) {
      const container = document.getElementById('actionsList');
      container.innerHTML = '';
      (actions || []).forEach((a, i) => addActionRow(a, i));
    }
    function addActionRow(action = {}, idx) {
      const container = document.getElementById('actionsList');
      const row = document.createElement('div');
      row.className = 'flex gap-2 mb-1 items-center';
      row.innerHTML = `
        <select class="px-2 py-1 border rounded action-type" required>
          <option value="">Type</option>
          <option value="download">Download</option>
          <option value="visit">Visit URL</option>
          <option value="share">Share</option>
        </select>
        <input type="text" class="px-2 py-1 border rounded action-label" placeholder="Label (eg. Download)">
        <input type="text" class="px-2 py-1 border rounded action-url" placeholder="URL (if needed)">
        <button type="button" onclick="this.parentNode.remove()" class="text-red-600 pl-1 hover:text-red-800 text-lg">&times;</button>
      `;
      container.appendChild(row);
      // Fill values
      row.querySelector('.action-type').value = action.type || "";
      row.querySelector('.action-label').value = action.label || "";
      row.querySelector('.action-url').value = action.url || "";
    }

    // --- CRUD ---
    async function fetchAds() {
      try {
        const res = await fetch("https://examguard-jmvj.onrender.com/api/ads");
        if (!res.ok) throw new Error("Could not fetch ads");
        ads = await res.json();
      } catch {
        ads = [];
      }
      renderAdsTable();
    }

    async function saveAd(e) {
      e.preventDefault();
      const form = e.target;
      const ad = {
        type: form.adType.value,
        content: form.adContent.value,
        meta: {
          title: form.adMetaTitle.value,
          description: form.adMetaDesc.value
        },
        actions: Array.from(form.querySelectorAll('.action-type')).map((_,i) => {
          const type = form.querySelectorAll('.action-type')[i].value;
          const label = form.querySelectorAll('.action-label')[i].value;
          const url = form.querySelectorAll('.action-url')[i].value;
          return type ? { type, label, url } : null;
        }).filter(Boolean)
      };
      const adId = form.adId.value;
      let method, url;
      if (adId) {
        method = "PUT";
        url = `https://examguard-jmvj.onrender.com/api/ads/${adId}`;
      } else {
        method = "POST";
        url = "https://examguard-jmvj.onrender.com/api/ads";
      }
      document.getElementById('saveAdBtn').disabled = true;
      document.getElementById('saveAdBtnSpinner').classList.remove('hidden');
      try {
        const res = await fetch(url, {
          method,
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(ad)
        });
        if (!res.ok) throw new Error("Failed to save ad");
        await fetchAds();
        closeAdModal();
      } catch (err) {
        alert("Failed to save ad.");
      }
      document.getElementById('saveAdBtn').disabled = false;
      document.getElementById('saveAdBtnSpinner').classList.add('hidden');
    }

    async function deleteAdConfirmed() {
      if (!deletingAdId) return;
      document.getElementById('confirmDeleteBtn').disabled = true;
      document.getElementById('deleteAdBtnSpinner').classList.remove('hidden');
      try {
        await fetch(`https://examguard-jmvj.onrender.com/api/ads/${deletingAdId}`, { method: "DELETE" });
        await fetchAds();
      } catch {}
      closeDeleteModal();
      document.getElementById('confirmDeleteBtn').disabled = false;
      document.getElementById('deleteAdBtnSpinner').classList.add('hidden');
    }

    // --- UI Render ---
    function renderAdsTable() {
      const tbl = document.getElementById('adsTable');
      if (!ads.length) {
        tbl.innerHTML = `<div class="text-center text-gray-500 py-12">No ads found. Click <b>+ New Ad</b> to add one!</div>`;
        return;
      }
      tbl.innerHTML = `
        <div class="overflow-x-auto">
        <table class="min-w-full text-sm">
          <thead>
            <tr class="bg-blue-50 text-blue-800 font-semibold">
              <th class="p-2 text-left">Type</th>
              <th class="p-2 text-left">Content</th>
              <th class="p-2 text-left">Meta</th>
              <th class="p-2 text-left">Actions</th>
              <th class="p-2"></th>
            </tr>
          </thead>
          <tbody>
            ${ads.map(ad => `
              <tr class="border-t hover:bg-blue-50">
                <td class="p-2 font-bold">${escapeHTML(ad.type)}</td>
                <td class="p-2">
                  ${ad.type === 'image' ? `<img src="${escapeHTML(ad.content)}" alt="ad image" class="max-h-16 rounded border" />` :
                    `${escapeHTML(ad.content).slice(0,90)}${ad.content.length>90?"...":""}`
                  }
                </td>
                <td class="p-2">
                  <div class="font-semibold">${escapeHTML(ad.meta?.title||"")}</div>
                  <div class="text-gray-500">${escapeHTML(ad.meta?.description||"")}</div>
                </td>
                <td class="p-2">
                  <ul class="space-y-1">
                    ${(ad.actions||[]).map(a=>`<li>
                      <span class="inline-block bg-gray-200 text-gray-700 rounded px-2 py-0.5 text-xs">${escapeHTML(a.type)}</span>
                      <span class="ml-1">${escapeHTML(a.label||"")}</span>
                      ${a.url?`<a href="${escapeHTML(a.url)}" class="ml-1 text-blue-500 underline text-xs" target="_blank">url</a>`:""}
                    </li>`).join('')}
                  </ul>
                </td>
                <td class="p-2 flex gap-2">
                  <button onclick='openAdModal(${JSON.stringify(ad)})' class="px-2 py-1 bg-green-600 text-white rounded hover:bg-green-700 text-xs">Edit</button>
                  <button onclick='openDeleteModal("${ad._id}")' class="px-2 py-1 bg-red-600 text-white rounded hover:bg-red-700 text-xs">Delete</button>
                </td>
              </tr>
            `).join('')}
          </tbody>
        </table>
        </div>
      `;
    }

    // --- Events ---
    document.getElementById('addAdBtn').onclick = ()=>openAdModal();
    document.getElementById('adForm').onsubmit = saveAd;
    document.getElementById('confirmDeleteBtn').onclick = deleteAdConfirmed;

    // Modal close on bg click
    document.getElementById('adModal').onclick = function(e) {if(e.target===this) closeAdModal();}
    document.getElementById('deleteModal').onclick = function(e){if(e.target===this) closeDeleteModal();}

    // --- Image Upload for Ad Type ---
    document.getElementById('adType').addEventListener('change', function() {
      const type = this.value;
      const imageSection = document.getElementById('imageUploadSection');
      const contentInput = document.getElementById('adContent');
      const imagePreview = document.getElementById('imagePreview');
      if (type === 'image') {
        imageSection.classList.remove('hidden');
        contentInput.placeholder = "Image URL will appear here after upload";
        contentInput.readOnly = true;
        contentInput.value = "";
        imagePreview.innerHTML = "";
      } else {
        imageSection.classList.add('hidden');
        contentInput.placeholder = "Image/Video URL, Redirect URL, HTML, or Text";
        contentInput.readOnly = false;
        contentInput.value = "";
        imagePreview.innerHTML = "";
      }
    });

    document.getElementById('imageUploadInput').addEventListener('change', async function() {
      const file = this.files[0];
      if (!file) return;
      const formData = new FormData();
      formData.append('image', file);
      const preview = document.getElementById('imagePreview');
      preview.innerHTML = '<span class="spinner"></span> <span class="ml-2 text-gray-700">Uploading...</span>';
      try {
        const res = await fetch('https://examguard-jmvj.onrender.com/api/images', {
          method: 'POST',
          body: formData
        });
        const data = await res.json();
        if (data.url) {
          document.getElementById('adContent').value = data.url;
          preview.innerHTML = `<img src="${data.url}" class="max-h-32 mt-1 rounded border" alt="Ad Image Preview" />`;
        } else {
          preview.innerHTML = `<span class="text-red-600">Upload failed.</span>`;
        }
      } catch (e) {
        preview.innerHTML = '<span class="text-red-600">Upload error. Try again.</span>';
      }
    });

    // --- INIT ---
    fetchAds();
  </script>
</body>
</html>
