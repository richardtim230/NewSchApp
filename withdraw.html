<!doctype html>
<html lang="en" class="h-full bg-gray-100">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>OAU ExamGuard — Request Withdrawal</title>

  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    /* Prevent horizontal overflow and ensure predictable box sizing */
    *, *::before, *::after { box-sizing: border-box; }
    html, body { max-width: 100%; overflow-x: hidden; }
    /* Page utilities */
    .muted { color: #6b7280; }
    .card { background: #fff; border-radius: 12px; box-shadow: 0 6px 18px rgba(15,23,42,0.06); }
    .dot-pending { width:8px;height:8px;border-radius:50%;background:#f59e0b;display:inline-block;margin-right:8px;}
    .dot-success { width:8px;height:8px;border-radius:50%;background:#10b981;display:inline-block;margin-right:8px;}
    .dot-failed  { width:8px;height:8px;border-radius:50%;background:#ef4444;display:inline-block;margin-right:8px;}
    .table-responsive { overflow-x: auto; -webkit-overflow-scrolling: touch; }
    .fit-x { max-width: 100%; overflow-wrap: break-word; }
    .truncate-ellipsis { overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    .min-w-0 { min-width: 0; } /* enables truncation inside flex children */
    input[type="number"]::-webkit-inner-spin-button,
    input[type="number"]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
    select, input, textarea { max-width: 100%; }
    /* Modal responsiveness */
    .modal-panel { max-width: 720px; width: calc(100% - 32px); }
    /* Small adjustments to prevent fixed-width surprises */
    button, select, input, textarea { word-break: break-word; }
  </style>
</head>
<body class="h-full bg-gray-100 text-sm">


  <div id="mobileDrawerOverlay" onclick="toggleMobileDrawer(false)" class="fixed inset-0 bg-black bg-opacity-40 z-40 hidden"></div>
  <!-- MOBILE SIDEBAR -->
  <aside id="mobileSidebar"
    class="fixed z-50 top-0 left-0 bottom-0 w-64 bg-[#2852a0] text-white transform -translate-x-full md:hidden transition-transform duration-300 ease-in-out"
    style="background:linear-gradient(180deg,#2852a0 0%,#467ae6 100%);">
    <div class="h-full flex flex-col py-5">
      <div class="px-7 py-3 mb-2">
        <h2 class="font-bold text-2xl tracking-tight leading-tight mb-1">OAU ExamGuard</h2>
        <div class="text-xs text-white/80">Student Withdrawal</div>
      </div>
      <nav class="mt-6 flex-1">
        <ul class="flex flex-col gap-3 text-base">
          <li><button class="sidebar-btn w-full py-2 px-7 rounded-l-full flex items-center gap-3" onclick="sidebarNav('overview')"><svg class="w-6 h-6" fill="none" stroke="currentColor"><path d="M4 6h16M4 12h16M4 18h16" /></svg>Overview</button></li>
          <li><button class="sidebar-btn w-full py-2 px-7 rounded-l-full flex items-center gap-3" onclick="sidebarNav('mocktests')"><svg class="w-6 h-6" fill="none" stroke="currentColor"><rect x="4" y="4" width="16" height="16" rx="4" /></svg>Mock Tests</button></li>
          <li><button class="sidebar-btn w-full py-2 px-7 rounded-l-full flex items-center gap-3" onclick="sidebarNav('pastquestions')"><svg class="w-6 h-6" fill="none" stroke="currentColor"><path d="M3 7h18M9 21V7"/></svg>Past Questions</button></li>
          <li><button class="sidebar-btn w-full py-2 px-7 rounded-l-full flex items-center gap-3" onclick="sidebarNav('taskscenter')"><svg class="w-6 h-6" fill="none" stroke="currentColor"><path d="M5 5l7 7-7 7"/></svg>Tasks Center</button></li>
          <li><button class="sidebar-btn w-full py-2 px-7 rounded-l-full flex items-center gap-3" onclick="sidebarNav('resources')"><svg class="w-6 h-6" fill="none" stroke="currentColor"><path d="M12 4v16"/></svg>Resources</button></li>
          <li><button class="sidebar-btn w-full py-2 px-7 rounded-l-full flex items-center gap-3" onclick="sidebarNav('messages')"><svg class="w-6 h-6" fill="none" stroke="currentColor"><circle cx="12" cy="12" r="10"/></svg>Messages</button></li>
          <li><button class="sidebar-btn w-full py-2 px-7 rounded-l-full flex items-center gap-3" onclick="sidebarNav('settings')"><svg class="w-6 h-6" fill="none" stroke="currentColor"><rect x="2" y="6" width="20" height="14" rx="3"/></svg>Settings</button></li>
          <li><button class="sidebar-btn w-full py-2 px-7 rounded-l-full flex items-center gap-3" onclick="sidebarNav('assignments')"><svg class="w-6 h-6" fill="none" stroke="currentColor"><path d="M17 9V2H7v7" /></svg>Assignments</button></li>
          <li><button class="sidebar-btn w-full py-2 px-7 rounded-l-full flex items-center gap-3" onclick="sidebarNav('studyPadi')"><svg class="w-6 h-6" fill="none" stroke="currentColor"><rect x="3" y="3" width="18" height="18" /></svg>StudyPadi</button></li>
          <li><button class="sidebar-btn w-full py-2 px-7 rounded-l-full flex items-center gap-3" onclick="sidebarNav('broadcasts')"><svg class="w-6 h-6" fill="none" stroke="currentColor"><circle cx="12" cy="12" r="10"/></svg>Broadcasts</button></li>
          <li><button class="sidebar-btn w-full py-2 px-7 rounded-l-full flex items-center gap-3" onclick="sidebarNav('logout')"><svg class="w-6 h-6" fill="none" stroke="currentColor"><path d="M15 12H3m0 0l4-4m-4 4l4 4m13-9v10a2 2 0 0 1-2 2h-7"/></svg>Logout</button></li>
        </ul>
      </nav>
    </div>
  </aside>
  <!-- DESKTOP SIDEBAR -->
  <aside class="hidden md:flex fixed pt-20 top-0 left-0 h-full w-64 bg-gradient-to-b from-[#2852a0] to-[#467ae6] text-white flex-col border-r z-30" id="desktopSidebar" style="will-change: transform;">
    <div class="h-full flex flex-col overflow-y-auto">
      <div class="px-7 py-6 mb-2 border-b border-white/10">
        <h2 class="font-bold text-2xl tracking-tight leading-tight mb-1">OAU ExamGuard</h2>
        <div class="text-xs text-white/80">Student Withdrawal</div>
      </div>
      <nav class="mt-6 flex-1">
        <ul class="flex flex-col gap-2 text-base">
          <li><button class="sidebar-btn w-full py-2 px-7 rounded-l-full flex items-center gap-3" onclick="sidebarNav('overview')"><svg class="w-6 h-6" fill="none" stroke="currentColor"><path d="M4 6h16M4 12h16M4 18h16" /></svg>Overview</button></li>
          <li><button class="sidebar-btn w-full py-2 px-7 rounded-l-full flex items-center gap-3" onclick="sidebarNav('mocktests')"><svg class="w-6 h-6" fill="none" stroke="currentColor"><rect x="4" y="4" width="16" height="16" rx="4" /></svg>Mock Tests</button></li>
          <li><button class="sidebar-btn w-full py-2 px-7 rounded-l-full flex items-center gap-3" onclick="sidebarNav('pastquestions')"><svg class="w-6 h-6" fill="none" stroke="currentColor"><path d="M3 7h18M9 21V7"/></svg>Past Questions</button></li>
          <li><button class="sidebar-btn w-full py-2 px-7 rounded-l-full flex items-center gap-3" onclick="sidebarNav('taskscenter')"><svg class="w-6 h-6" fill="none" stroke="currentColor"><path d="M5 5l7 7-7 7"/></svg>Tasks Center</button></li>
          <li><button class="sidebar-btn w-full py-2 px-7 rounded-l-full flex items-center gap-3" onclick="sidebarNav('resources')"><svg class="w-6 h-6" fill="none" stroke="currentColor"><path d="M12 4v16"/></svg>Resources</button></li>
          <li><button class="sidebar-btn w-full py-2 px-7 rounded-l-full flex items-center gap-3" onclick="sidebarNav('messages')"><svg class="w-6 h-6" fill="none" stroke="currentColor"><circle cx="12" cy="12" r="10"/></svg>Messages</button></li>
          <li><button class="sidebar-btn w-full py-2 px-7 rounded-l-full flex items-center gap-3" onclick="sidebarNav('settings')"><svg class="w-6 h-6" fill="none" stroke="currentColor"><rect x="2" y="6" width="20" height="14" rx="3"/></svg>Settings</button></li>
          <li><button class="sidebar-btn w-full py-2 px-7 rounded-l-full flex items-center gap-3" onclick="sidebarNav('assignments')"><svg class="w-6 h-6" fill="none" stroke="currentColor"><path d="M17 9V2H7v7" /></svg>Assignments</button></li>
          <li><button class="sidebar-btn w-full py-2 px-7 rounded-l-full flex items-center gap-3" onclick="sidebarNav('studyPadi')"><svg class="w-6 h-6" fill="none" stroke="currentColor"><rect x="3" y="3" width="18" height="18" /></svg>StudyPadi</button></li>
          <li><button class="sidebar-btn w-full py-2 px-7 rounded-l-full flex items-center gap-3" onclick="sidebarNav('broadcasts')"><svg class="w-6 h-6" fill="none" stroke="currentColor"><circle cx="12" cy="12" r="10"/></svg>Broadcasts</button></li>
          <li><button class="sidebar-btn w-full py-2 px-7 rounded-l-full flex items-center gap-3" onclick="sidebarNav('logout')"><svg class="w-6 h-6" fill="none" stroke="currentColor"><path d="M15 12H3m0 0l4-4m-4 4l4 4m13-9v10a2 2 0 0 1-2 2h-7"/></svg>Logout</button></li>
        </ul>
      </nav>
    </div>
  </aside>

  <!-- Responsive layout wrapper -->
  <div class="md:ml-64 flex flex-col min-h-screen bg-gray-100">
  <!-- Header -->
  <header class="fixed top-0 left-0 right-0 bg-white border-b z-40">
    <div class="max-w-screen-xl mx-auto px-4 md:px-6 py-3 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <div>
          <div class="text-indigo-800 font-bold">OAU ExamGuard</div>
          <div class="text-xs muted">Withdraw Funds</div>
        </div>
      </div>
      <div class="flex items-center gap-3">
        <button id="backToEarnings" class="px-3 py-2 rounded bg-gray-100 hover:bg-gray-200 text-xs">Back to Earnings</button>
      </div>
    </div>
  </header>

 

  <main class="pt-20 max-w-screen-xl mx-auto px-4 md:px-6 pb-12 fit-x">

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 fit-x">
      <!-- Left: Withdraw Form -->
      <section class="col-span-2 card p-6 fit-x">
        <h1 class="text-xl font-semibold text-indigo-800 mb-2">Request Withdrawal</h1>
        <p class="text-xs muted mb-4">Withdraw funds from your ExamGuard wallet to your bank or mobile money account. Review fees and estimated payout before confirming.</p>

        <!-- Wallet/Balance -->
        <div class="flex flex-col sm:flex-row items-stretch sm:items-center justify-between bg-indigo-50 rounded p-4 mb-4 fit-x">
          <div class="min-w-0">
            <div class="text-xs muted">Available balance</div>
            <div id="availBalance" class="text-2xl font-bold text-indigo-700">₦0.00</div>
          </div>
          <div class="text-right mt-3 sm:mt-0">
            <div class="text-xs muted">Pending withdrawal</div>
            <div id="pendingBalance" class="font-semibold">₦0.00</div>
          </div>
        </div>

        <!-- Form -->
        <form id="withdrawForm" class="space-y-4 fit-x" onsubmit="return false;">
          <!-- Account selection -->
          <div>
            <label class="block text-xs font-medium text-gray-700 mb-1">Select account</label>
            <div class="flex gap-2 min-w-0">
              <select id="accountSelect" class="flex-1 border rounded px-3 py-2 min-w-0" aria-label="Select withdrawal account">
                <!-- Options populated by JS -->
              </select>
              <button id="addAccountBtn" class="px-3 py-2 bg-white border rounded hover:bg-gray-50 text-sm" type="button">Add</button>
            </div>
            <div id="accountHelp" class="text-xs muted mt-1">Choose the bank or mobile wallet to receive funds.</div>
          </div>

          <!-- Amount -->
          <div>
            <label class="block text-xs font-medium text-gray-700 mb-1">Amount (NGN)</label>
            <input id="amountInput" type="number" step="0.01" min="1" placeholder="0.00" class="w-full border rounded px-3 py-2" required />
            <div class="text-xs muted mt-1" id="amountHelp">Enter the amount you'd like to withdraw.</div>
          </div>

          <!-- Method & Schedule -->
          <div class="grid md:grid-cols-2 gap-3">
            <div>
              <label class="block text-xs font-medium text-gray-700 mb-1">Method</label>
              <select id="methodSelect" class="w-full border rounded px-3 py-2">
                <option value="bank">Bank Transfer</option>
                <option value="mobile">Mobile Money</option>
              </select>
            </div>
            <div>
              <label class="block text-xs font-medium text-gray-700 mb-1">Speed</label>
              <select id="speedSelect" class="w-full border rounded px-3 py-2">
                <option value="standard">Standard (1-3 business days)</option>
                <option value="instant">Instant (higher fee)</option>
              </select>
            </div>
          </div>

          <!-- Fee & Estimated -->
          <div class="grid md:grid-cols-3 gap-3 items-center">
            <div>
              <div class="text-xs muted">Fee</div>
              <div id="feeDisplay" class="font-semibold">₦0.00</div>
            </div>
            <div>
              <div class="text-xs muted">Estimated receive</div>
              <div id="estimatedReceive" class="font-semibold text-indigo-700">₦0.00</div>
            </div>
            <div>
              <div class="text-xs muted">Minimum withdrawal</div>
              <div id="minWithdrawal" class="font-semibold">₦500.00</div>
            </div>
          </div>

          <!-- Supporting document (optional) -->
          <div>
            <label class="block text-xs font-medium text-gray-700 mb-1">Supporting document (optional)</label>
            <input id="supportDoc" type="file" accept=".pdf,.jpg,.jpeg,.png" class="w-full text-xs" />
            <div class="text-xs muted mt-1">Upload ID or proof if required by withdrawal method.</div>
          </div>

          <!-- Note -->
          <div>
            <label class="block text-xs font-medium text-gray-700 mb-1">Note (optional)</label>
            <textarea id="noteInput" rows="2" class="w-full border rounded px-3 py-2 text-sm" placeholder="e.g., Bank transfer reason..."></textarea>
          </div>

          <!-- Button Row -->
          <div class="flex items-center gap-3">
            <button id="previewBtn" class="bg-indigo-600 text-white px-4 py-2 rounded font-semibold" type="button">Preview & Confirm</button>
            <button id="cancelDraftBtn" class="bg-white border px-4 py-2 rounded" type="button">Reset</button>
            <div id="formSpinner" class="hidden ml-auto text-xs text-gray-500">Processing...</div>
          </div>
        </form>
      </section>

      <!-- Right: Quick tips & History summary -->
      <aside class="card p-6 fit-x">
        <div>
          <h3 class="font-semibold text-indigo-800 mb-2">Quick tips</h3>
          <ul class="text-xs muted space-y-2">
            <li>- Minimum withdrawal: <strong id="minTip">₦500</strong></li>
            <li>- Instant withdrawals have higher fees.</li>
            <li>- Keep bank details accurate to avoid delays.</li>
          </ul>
        </div>

        <div class="mt-6">
          <h3 class="font-semibold text-indigo-800 mb-2">Recent Requests</h3>
          <div id="recentRequests" class="space-y-3 text-xs fit-x">
            <!-- populated by JS -->
          </div>
          <div class="mt-4 text-right">
            <button id="viewAllRequestsBtn" class="text-indigo-600 text-sm">View all requests</button>
          </div>
        </div>
      </aside>
    </div>
  </main>

  <!-- Confirm modal -->
  <div id="confirmModal" class="fixed inset-0 z-50 hidden flex items-center justify-center bg-black bg-opacity-50 px-4">
    <div class="bg-white rounded-xl p-6 modal-panel">
      <h3 class="text-lg font-semibold text-indigo-800">Confirm Withdrawal</h3>
      <div id="confirmSummary" class="mt-3 text-sm"></div>
      <div class="mt-4 flex items-center gap-3 justify-end">
        <button id="confirmCancel" class="px-4 py-2 rounded border">Cancel</button>
        <button id="confirmSubmit" class="px-4 py-2 rounded bg-indigo-600 text-white">Confirm & Request</button>
      </div>
    </div>
  </div>

  <!-- Success modal -->
  <div id="successModal" class="fixed inset-0 z-50 hidden flex items-center justify-center bg-black bg-opacity-50 px-4">
    <div class="bg-white rounded-xl p-6 modal-panel text-center">
      <h3 class="text-lg font-semibold text-green-600">Request submitted</h3>
      <p class="text-sm muted mt-2">Your withdrawal request has been submitted. You will be notified when it's processed.</p>
      <div class="mt-4">
        <button id="successClose" class="px-4 py-2 rounded bg-indigo-600 text-white">Close</button>
      </div>
    </div>
  </div>

  <!-- Minimal footer -->
  <footer class="mt-8 text-center text-xs text-gray-400 pb-8">
    © OAU ExamGuard — Withdrawals
  </footer>

<script>
function sidebarNav(section) {
  // Map sidebar item to nng.html anchor or section
  window.location.href = `nng.html#${section}-section`;
}
function toggleMobileDrawer(show) {
  // Show/hide mobile drawer
  var sidebar = document.getElementById('mobileSidebar');
  var overlay = document.getElementById('mobileDrawerOverlay');
  if (show) {
    sidebar.style.transform = 'translateX(0)';
    overlay.classList.remove('hidden');
  } else {
    sidebar.style.transform = 'translateX(-100%)';
    overlay.classList.add('hidden');
  }
}
document.addEventListener("DOMContentLoaded", function() {
  // Optionally, add logic to close mobile sidebar when resizing to desktop
  window.addEventListener("resize", function() {
    if (window.innerWidth >= 768) toggleMobileDrawer(false);
  });
});
/* CONFIG */
const API_BASE = "https://examguide.onrender.com/api/";
const MIN_WITHDRAW = 500;
const INSTANT_FEE = { type: 'percent', percent: 1.5, flat: 50 };   // 1.5% + ₦50
const STANDARD_FEE = { type: 'percent', percent: 0.8, flat: 30 };  // 0.8% + ₦30
const WALLET_ENDPOINT = API_BASE + "finance/wallet";
const WITHDRAW_ENDPOINT = API_BASE + "finance/withdrawals";
const REQUESTS_ENDPOINT = API_BASE + "finance/withdrawals?limit=6";

/* DOM refs */
const availBalanceEl = document.getElementById("availBalance");
const pendingBalanceEl = document.getElementById("pendingBalance");
const accountSelect = document.getElementById("accountSelect");
const addAccountBtn = document.getElementById("addAccountBtn");
const amountInput = document.getElementById("amountInput");
const methodSelect = document.getElementById("methodSelect");
const speedSelect = document.getElementById("speedSelect");
const feeDisplay = document.getElementById("feeDisplay");
const estimatedReceive = document.getElementById("estimatedReceive");
const minWithdrawalEl = document.getElementById("minWithdrawal");
const minTipEl = document.getElementById("minTip");
const supportDoc = document.getElementById("supportDoc");
const noteInput = document.getElementById("noteInput");
const previewBtn = document.getElementById("previewBtn");
const cancelDraftBtn = document.getElementById("cancelDraftBtn");
const confirmModal = document.getElementById("confirmModal");
const confirmSummary = document.getElementById("confirmSummary");
const confirmCancel = document.getElementById("confirmCancel");
const confirmSubmit = document.getElementById("confirmSubmit");
const successModal = document.getElementById("successModal");
const successClose = document.getElementById("successClose");
const recentRequestsEl = document.getElementById("recentRequests");
const viewAllRequestsBtn = document.getElementById("viewAllRequestsBtn");
const backToEarnings = document.getElementById("backToEarnings");

let wallet = null;
let requests = [];

/* Utilities */
function formatCurrency(n) {
  const num = typeof n === "string" ? parseFloat(n) || 0 : (n || 0);
  return new Intl.NumberFormat('en-NG', { style: 'currency', currency: 'NGN', maximumFractionDigits: 2 }).format(num);
}
function calculateFee(amount, speed) {
  amount = Number(amount) || 0;
  const cfg = speed === "instant" ? INSTANT_FEE : STANDARD_FEE;
  const percentPart = (cfg.percent || 0) / 100 * amount;
  const total = percentPart + (cfg.flat || 0);
  return Math.max(0, Math.round((total + Number.EPSILON) * 100) / 100);
}

/* Load initial data (wallet + recent requests). Falls back to mock if API unavailable. */
async function loadInitial() {
  minWithdrawalEl.textContent = formatCurrency(MIN_WITHDRAW);
  minTipEl.textContent = formatCurrency(MIN_WITHDRAW);

  try {
    const token = localStorage.getItem("token");
    const resp = await fetch(WALLET_ENDPOINT, { credentials: 'include', headers: token ? { Authorization: 'Bearer ' + token } : {} });
    if (!resp.ok) throw new Error("wallet fetch failed");
    const data = await resp.json();
    wallet = data.wallet || data;
  } catch (e) {
    // fallback mock wallet
    wallet = {
      balance: 45230.75,
      pending: 4500,
      accounts: [
        { id: 'acc1', name: 'First National Bank', accountNumber: '0123456789', meta: {} },
        { id: 'acc2', name: 'Mobile Money (MTN)', accountNumber: '08012345678', meta: {} }
      ]
    };
  }

  try {
    const token = localStorage.getItem("token");
    const r = await fetch(REQUESTS_ENDPOINT, { credentials: 'include', headers: token ? { Authorization: 'Bearer ' + token } : {} });
    if (!r.ok) throw new Error("requests fetch failed");
    const resData = await r.json();
    requests = Array.isArray(resData) ? resData : (resData.requests || []);
  } catch (e) {
    // fallback mock requests
    requests = [
      { id: 'w1', amount: 15000, date: '2026-01-10T09:20:00Z', status: 'completed', method: 'bank' },
      { id: 'w2', amount: 5000, date: '2026-01-03T11:10:00Z', status: 'pending', method: 'mobile' },
      { id: 'w3', amount: 20000, date: '2025-12-07T08:00:00Z', status: 'failed', method: 'bank' }
    ];
  }

  renderWallet();
  renderRecentRequests();
  recalc();
}

/* Render wallet info & accounts */
function renderWallet() {
  availBalanceEl.textContent = formatCurrency(wallet.balance || 0);
  pendingBalanceEl.textContent = formatCurrency(wallet.pending || 0);

  accountSelect.innerHTML = "";
  const acctList = Array.isArray(wallet.accounts) ? wallet.accounts : [];
  if (!acctList.length) {
    accountSelect.innerHTML = `<option value="">No accounts. Add one.</option>`;
  } else {
    acctList.forEach(a => {
      const opt = document.createElement("option");
      opt.value = a.id || (a.accountNumber || a.name);
      opt.textContent = `${a.name} · ${a.accountNumber || ''}`;
      opt.dataset.json = JSON.stringify(a);
      accountSelect.appendChild(opt);
    });
  }
}

/* Render recent requests */
function renderRecentRequests() {
  recentRequestsEl.innerHTML = "";
  if (!requests.length) {
    recentRequestsEl.innerHTML = `<div class="text-xs muted">No recent withdrawal requests</div>`;
    return;
  }
  requests.slice(0,6).forEach(r => {
    const div = document.createElement("div");
    div.className = "flex items-center justify-between";
    const left = document.createElement("div");
    left.innerHTML = `<div class="text-sm font-medium">${formatCurrency(r.amount)}</div><div class="text-xs muted">${new Date(r.date).toLocaleString()}</div>`;
    const right = document.createElement("div");
    const status = (r.status || '').toLowerCase();
    const dot = status === 'pending' ? '<span class="dot-pending"></span>' : (status === 'completed' ? '<span class="dot-success"></span>' : '<span class="dot-failed"></span>');
    right.innerHTML = `${dot}<span class="text-xs font-semibold">${status}</span>`;
    div.appendChild(left);
    div.appendChild(right);
    recentRequestsEl.appendChild(div);
  });
}

/* Recalculate fee & estimated receive */
function recalc() {
  const amount = Number(amountInput.value) || 0;
  const speed = speedSelect.value;
  const fee = amount >= MIN_WITHDRAW ? calculateFee(amount, speed) : 0;
  const receive = Math.max(0, (amount - fee));
  feeDisplay.textContent = formatCurrency(fee);
  estimatedReceive.textContent = formatCurrency(receive);
}

/* Validate before previewing */
function validateDraft() {
  const amount = Number(amountInput.value) || 0;
  if (!accountSelect.value) return { ok: false, msg: "Please select or add a receiving account." };
  if (isNaN(amount) || amount <= 0) return { ok: false, msg: "Enter a valid amount." };
  if (amount < MIN_WITHDRAW) return { ok: false, msg: `Minimum withdrawal is ${formatCurrency(MIN_WITHDRAW)}.` };
  if (amount > wallet.balance) return { ok: false, msg: "Amount exceeds available balance." };
  return { ok: true };
}

/* Event bindings */
amountInput.addEventListener("input", recalc);
speedSelect.addEventListener("change", recalc);
methodSelect.addEventListener("change", recalc);

previewBtn.addEventListener("click", () => {
  const v = validateDraft();
  if (!v.ok) return alert(v.msg);

  const accText = accountSelect.options[accountSelect.selectedIndex]?.text || "—";
  const amount = Number(amountInput.value) || 0;
  const fee = calculateFee(amount, speedSelect.value);
  const receive = Math.max(0, amount - fee);

  confirmSummary.innerHTML = `
    <div class="text-sm space-y-2">
      <div><strong>Account:</strong> ${escapeHtml(accText)}</div>
      <div><strong>Method:</strong> ${escapeHtml(methodSelect.value)}</div>
      <div><strong>Amount:</strong> ${formatCurrency(amount)}</div>
      <div><strong>Fee:</strong> ${formatCurrency(fee)}</div>
      <div><strong>Estimated to receive:</strong> <span class="text-indigo-700 font-semibold">${formatCurrency(receive)}</span></div>
      <div><strong>Speed:</strong> ${escapeHtml(speedSelect.options[speedSelect.selectedIndex].text)}</div>
      ${noteInput.value ? `<div><strong>Note:</strong> ${escapeHtml(noteInput.value)}</div>` : ''}
    </div>
  `;
  confirmModal.classList.remove("hidden");
});

confirmCancel.addEventListener("click", () => confirmModal.classList.add("hidden"));

confirmSubmit.addEventListener("click", async () => {
  confirmSubmit.disabled = true;
  confirmSubmit.textContent = "Submitting...";
  const amount = Number(amountInput.value) || 0;
  const accId = accountSelect.value;
  const method = methodSelect.value;
  const speed = speedSelect.value;
  const note = noteInput.value || '';
  const file = supportDoc.files && supportDoc.files[0];

  try {
    const token = localStorage.getItem("token");
    let resp;
    if (file) {
      const fd = new FormData();
      fd.append("amount", amount);
      fd.append("accountId", accId);
      fd.append("method", method);
      fd.append("speed", speed);
      fd.append("note", note);
      fd.append("support", file);
      resp = await fetch(WITHDRAW_ENDPOINT, {
        method: "POST",
        credentials: 'include',
        headers: token ? { Authorization: 'Bearer ' + token } : {},
        body: fd
      });
    } else {
      resp = await fetch(WITHDRAW_ENDPOINT, {
        method: "POST",
        credentials: 'include',
        headers: {
          "Content-Type": "application/json",
          ...(token ? { Authorization: 'Bearer ' + token } : {})
        },
        body: JSON.stringify({ amount, accountId: accId, method, speed, note })
      });
    }

    if (!resp.ok) {
      let errText = "Failed to submit request.";
      try { const errJson = await resp.json(); errText = errJson.message || errJson.error || errText; } catch {}
      throw new Error(errText);
    }

    const resData = await resp.json();
    const created = resData.withdrawal || resData || { id: (resData.id || ('w_' + Date.now())), amount, date: new Date().toISOString(), status: 'pending', method };
    requests.unshift(created);
    renderRecentRequests();

    // adjust wallet locally
    wallet.balance = (Number(wallet.balance) || 0) - amount;
    wallet.pending = (Number(wallet.pending) || 0) + amount;
    availBalanceEl.textContent = formatCurrency(wallet.balance);
    pendingBalanceEl.textContent = formatCurrency(wallet.pending);

    confirmModal.classList.add("hidden");
    successModal.classList.remove("hidden");
  } catch (err) {
    alert("Error: " + (err.message || err));
  } finally {
    confirmSubmit.disabled = false;
    confirmSubmit.textContent = "Confirm & Request";
  }
});

cancelDraftBtn.addEventListener("click", () => {
  amountInput.value = "";
  supportDoc.value = "";
  noteInput.value = "";
  methodSelect.value = "bank";
  speedSelect.value = "standard";
  recalc();
});

successClose.addEventListener("click", () => {
  successModal.classList.add("hidden");
  amountInput.value = "";
  supportDoc.value = "";
  noteInput.value = "";
  recalc();
});

addAccountBtn.addEventListener("click", async () => {
  const name = prompt("Enter account name (e.g., 'Access Bank'):");
  if (!name) return;
  const accNo = prompt("Enter account number / mobile number:");
  if (!accNo) return;
  const id = 'acc_' + Date.now();
  const newAcc = { id, name, accountNumber: accNo };
  const opt = document.createElement("option");
  opt.value = id;
  opt.textContent = `${newAcc.name} · ${newAcc.accountNumber}`;
  opt.dataset.json = JSON.stringify(newAcc);
  accountSelect.appendChild(opt);
  accountSelect.value = id;
  // Optionally send to backend to persist
});

viewAllRequestsBtn.addEventListener("click", () => {
  // Adjust to your app's route for all withdrawals
  window.location.href = "/withdrawals.html";
});
backToEarnings.addEventListener("click", () => {
  window.location.href = "/earnings.html";
});

/* Escape HTML for safe insertion */
function escapeHtml(unsafe) {
  return String(unsafe || '').replace(/[&<"']/g, function(m) { return ({'&':'&amp;','<':'&lt;','"':'&quot;',"'":"&#039;"})[m]; });
}

/* Init */
document.addEventListener("DOMContentLoaded", loadInitial);
</script>
</body>
</html>
