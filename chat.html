<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>AI Chat ‚Äì Infinite Scroll</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- MathJax config -->
  <script>
    window.MathJax = {
      tex: {
        inlineMath: [['$', '$'], ['\\(', '\\)']],
        displayMath: [['\\[', '\\]'], ['$$', '$$']]
      },
      options: { skipHtmlTags: ['script','noscript','style','textarea','pre','code'] }
    };
  </script>
  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
  <!-- Marked for rich markdown rendering -->
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    body { background:#20304a; font-family:"Segoe UI","Roboto",Arial,sans-serif; margin:0; min-height:100vh; user-select:none; }
    .chat-app { max-width:440px; margin:34px auto; background:#fff; border-radius:17px; box-shadow:0 8px 32px rgba(44,62,80,0.28); display:flex; flex-direction:column; height:80vh; overflow:hidden; position:relative;}
    .sidebar-backdrop { position:fixed; left:0; top:0; width:100vw; height:100vh; background:rgba(0,0,0,0.15); z-index:97; display:none; opacity:0; transition:opacity 0.22s; }
    .sidebar-backdrop.open { display:block; opacity:1; }
    .sidebar { position:fixed; left:-278px; top:0; width:278px; height:100vh; background:#233b62; color:#f7faff; z-index:98; box-shadow:2px 0 20px rgba(44,62,80,0.18); overflow-y:auto; transition:left 0.18s;}
    .sidebar.open { left:0; }
    .sidebar-header { display:flex; align-items:center; justify-content:space-between; padding:25px 18px 7px 20px; font-size:18px; border-bottom:1px solid #28467a; background:#20304a; }
    .sidebar-header .fa-xmark { font-size:24px; cursor:pointer; padding:8px; }
    .sidebar .sidebar-section { padding:16px 20px 2px 20px; }
    .sidebar .sidebar-section h4 { margin:0 0 9px 0; font-size:15px; font-weight:500; letter-spacing:.02em; color:#AFC8DF; display:flex;align-items:center;gap:10px; }
    .sidebar-list { list-style:none; padding:0; margin:0; }
    .sidebar-list li { margin:0 0 3px 0; font-size:15px; cursor:pointer; padding:7px 12px; border-radius:8px; transition:background 0.13s; display:flex;align-items:center;gap:9px; }
    .sidebar-list li:hover { background:rgba(100,130,170,0.15); }
    .sidebar-btn,.sidebar-btn-logout { width:100%; padding:10px 0; border:none; border-radius:10px; font-weight:500; font-size:16px; cursor:pointer; color:white; background:linear-gradient(120deg,#3b6eeb 80%,#489cfb 100%);}
    .sidebar-btn:hover { background:linear-gradient(110deg,#2b51b8 80%,#176c93 100%)}
    .sidebar-btn-logout { background:linear-gradient(120deg,#d63e3e 80%,#fc857a 100%);}
    .sidebar-btn-logout:hover { background:linear-gradient(110deg,#992a37 80%,#bb433b 100%)}
    .sidebar-list .fa { font-size:16px;}
    .sidebar .new-topic { margin-top:5px;}
    .chat-header { background:#396ae2; color:#fff; display:flex; align-items:center; padding:17px 17px 16px 14px; font-size:19px; border-bottom:1px solid #e0e0e0; gap:14px; position:relative;}
    .chat-header .fa-bars { font-size:25px; cursor:pointer; margin-right:6px; background:none; border:none; color:#fff; padding:8px 8px 8px 0; border-radius:8px; transition:background 0.1s; }
    .chat-header .fa-bars:active { background:rgba(30,40,100,0.16);}
    .chat-header .avatar { border-radius:50%; width:38px; height:38px; margin-right:9px; box-shadow:0 2.2px 8px rgba(0,0,0,0.06);}
    .chat-title { font-weight:500; letter-spacing:0.1px; flex:1; white-space:nowrap; text-overflow:ellipsis; overflow:hidden;}
    .chat-body { flex:1; background:#f7faff; padding:16px 12px; overflow-y:auto; display:flex; flex-direction:column; gap:8px; scrollbar-gutter:stable; scroll-behavior:smooth;}
    .chat-body::-webkit-scrollbar { width:6px; background:rgba(230,246,255,0.08); border-radius:7px; }
    .chat-body::-webkit-scrollbar-thumb { background:#d2e3fa; border-radius:7px;}
    .chat-bubble { max-width:75%; min-width:60px; padding:10px 16px; border-radius:18px; font-size:16px; word-break:break-word; line-height:1.45; box-shadow:0 1.5px 8px rgba(60,90,170,0.07); position:relative;}
    .chat-bubble.user { align-self:flex-end; background:linear-gradient(120deg,#489cfb 40%, #396ae2 100%); color:#fff; border-bottom-right-radius:6px; margin-right:4px; box-shadow:0 4px 17px rgba(57,106,226,0.10);}
    .chat-bubble.ai { align-self:flex-start; background:#e4eaf2; color:#20304a; border-bottom-left-radius:6px; margin-left:3px; box-shadow:0 4px 17px rgba(57,106,226,0.04);}
    .chat-bubble .bubble-meta { display:flex;align-items:center;gap:7px; font-size:12px; color:#829dc3; margin-top:0px; }
    .chat-bubble.user .bubble-meta { justify-content:flex-end; color:#c2d2fa;}
    .chat-bubble.ai .bubble-meta { justify-content:flex-start;}
    .chat-bubble .bubble-avatar { width:22px; height:22px; border-radius:50%; margin-right:4px; vertical-align:middle;}
    .msg-file { font-size:15px; display:flex; align-items:center; gap:7px; margin-top:4px; color:#1755a0; background:#d6e8fa; padding:4px 8px; border-radius:7px; box-shadow:0 2px 8px rgba(80,120,200,0.11);}
    .msg-file img { max-height:60px; max-width:70px; border-radius:7px; box-shadow:0.5px 2px 12px rgba(44,92,160,0.12); margin-right:7px; display:inline-block; vertical-align:middle;}
    .msg-voice { margin-top:6px; background:#e7eefa; padding:7px 9px; border-radius:10px; color:#20304a; display:flex;align-items:center;gap:8px;font-size:14px;}
    .msg-voice audio { width:100%; outline:none;}
    .img-preview-row { display:flex; gap:10px; margin-bottom:7px;}
    .img-preview-thumb { max-width:67px; max-height:67px; border-radius:7px; box-shadow:0 3px 13px rgba(44,62,120,0.10); object-fit:cover; position:relative;}
    .img-remove-btn { position:absolute; right:4px; top:4px; background:rgba(0,0,0,0.5); color:white; border:none; width:19px; height:19px; border-radius:50%; font-size:14px; cursor:pointer; line-height:19px;}
    .chat-input-area { display:flex; flex-direction:column; align-items:stretch; gap:6px; padding:13px 13px 10px 13px; background:#f4f7fb; border-top:1px solid #e0e0e0; box-shadow:0 0.9px 8px rgba(57,106,226,0.08);}
    .input-row { display:flex; align-items:center; gap:8px;}
    #chatInput { flex:1; padding:10px 13px; border-radius:15px; border:1px solid #dbe3ec; font-size:16px; background:#fff; outline:none; transition:border-color 0.2s, box-shadow 0.15s; box-shadow:0 1.5px 8px rgba(57,106,226,0.06);}
    #chatInput:focus { border-color:#396ae2; box-shadow:0 2px 10px rgba(57,106,226,0.10);}
    .input-btn { border:none; color:#4a6be9; background:#e3edfd; font-size:18px; padding:0; width:38px; height:38px; border-radius:50%; cursor:pointer; display:flex; align-items:center; justify-content:center;}
    .input-btn:active { background:#d4dffd;}
    .input-btn.voice.recording { background:linear-gradient(120deg,#d63e3e 60%,#fc857a 100%); color:white;}
    #sendBtn { font-size:22px!important; background:#396ae2; color:white;}
    #sendBtn:active { background:#2c51b8;}
    #attachInput { display:none;}
    .floating-btn { position:fixed; bottom:110px; right:44px; z-index:96; width:60px; height:60px; background:linear-gradient(115deg,#489cfb 53%,#e9ecfb 115%); color:#3264a3; border-radius:50%; display:flex; align-items:center; justify-content:center; box-shadow:0 7px 22px rgba(44,62,80,0.07);}
    .floating-btn:hover, .floating-btn:active { box-shadow:0 15px 38px rgba(57,106,226,0.23); background:linear-gradient(115deg,#668ee8 70%,#e9ecfb 115%);}
    /* CBT Modal styles */
    #cbtModal { display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(31,34,62,0.87); z-index:999; align-items:center; justify-content:center; }
    #cbtCard { background:linear-gradient(120deg,#f4f8fd 60%,#dde5f8 100%); border-radius:24px; max-width:430px; min-width:300px; margin:auto; padding:34px 26px 28px 26px; box-shadow:0 8px 36px rgba(30,40,120,0.13); position:relative;}
    #cbtClose { position:absolute;top:14px;right:16px;font-size:22px;color:#2353a3;cursor:pointer; }
    #cbtContent { min-height:160px; }
    #cbtExamForm button, .cbt-button { display:block;width:100%;margin-top:15px;padding:13px 0px;background:#396ae2;color:#fff;border:none;border-radius:10px;font-size:19px;font-weight:bold;cursor:pointer; }
    @media (max-width:500px) {
      .chat-app{width:100vw;max-width:none;margin:0;min-height:100vh;border-radius:0; height:100vh;}
      .sidebar.open{width:90vw;}
      .floating-btn{bottom:95px; right:17px;}
      #cbtCard { padding:16px 4vw 21px 4vw; max-width:95vw; }
    }
    @media (max-width:400px) {
      .chat-header{font-size:16px;}
      .chat-body{padding-left:2px; padding-right:2px;}
      .sidebar.open{width:100vw;}
    }

/* Enhanced standard CBT modal styling */
#cbtModal {
  display:none;
  position:fixed;
  left:0; top:0;
  width:100vw; height:100vh;
  background:rgba(40,50,70,0.92);
  z-index:999;
  align-items:center; justify-content:center;
  overflow:auto;
}
#cbtCard {
  background:linear-gradient(120deg,#f4f8fd 62%,#e9edf8 100%);
  border-radius:26px;
  box-shadow:0 8px 32px rgba(44,62,80,0.12);
  max-width:490px;
  min-width:280px;
  width:98vw;
  margin:auto;
  padding:30px 17px 24px 17px;
  position:relative;
  display:flex;
  flex-direction:column;
  align-items:center;
}
#cbtClose {
  position:absolute;top:19px;right:21px;
  font-size:27px;color:#2353a3;cursor:pointer;
  z-index:10;
}
#cbtContent {
  max-height:74vh;
  width:100%;
  overflow-y:auto;
  scrollbar-width:thin;
  scrollbar-color:#396ae2 #f7fafc;
}
#cbtContent::-webkit-scrollbar {
  width:7px;
  background:#f7fafc;
  border-radius:10px;
}
#cbtContent::-webkit-scrollbar-thumb {
  background:#396ae2;
  border-radius:10px;
}

.cbt-modal-content {
  width:100%; min-width:220px;
}
.cbt-question-header {
  margin-bottom:18px;
  padding-bottom:4px;
}
.cbt-q-number {
  font-size:22px;
  font-weight:bold;
  color:#24334a;
  letter-spacing:.2px;
  display:block;
  margin-bottom:6px;
}
.cbt-q-text {
  font-size:23px;
  color:#142040;
  font-weight:800;
  line-height:1.35;
  margin-bottom:3px;
  display:block;
}
.cbt-option-form {
  width:100%;
}
.cbt-option-row {
  padding:0;margin-bottom:17px;
}
.cbt-option-label {
  display:flex;
  align-items:center;
  gap:15px;
  background:white;
  border-radius:15px;
  font-size:19px;
  font-weight:500;
  box-shadow:0 1.2px 7px rgba(50,100,170,0.09);
  border:1.5px solid #eaf0f8;
  padding:13px 19px;
  cursor:pointer;
  transition:box-shadow 0.1s, border-color 0.15s;
}
.cbt-option-label:hover, .cbt-option-label:active {
  box-shadow:0 4px 13px rgba(44,92,180,0.09);
  border-color:#396ae2;
}
.cbt-option-label input[type="radio"] {
  accent-color:#396ae2;
  transform:scale(1.35);
  margin-right:1px;
}
.cbt-option-letter {
  font-weight:700;
  font-size:20px;
  margin-right:6px;
  color:#234ab7;
}
.cbt-option-label input[type="radio"]:checked + .cbt-option-letter {
  color:#28a745;
}
.cbt-option-text {
  font-size:18px;
  letter-spacing:.01em;
  color:#24316c;
  font-weight:600;
}

.cbt-modal-nav {
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-top:11px;
  padding-top:11px;
  border-top:1px solid #e5eaf4;
  gap:9px;
}
.cbt-nav-btn {
  background:#edf2fc;
  color:#3768af;
  font-size:19px;
  font-weight:700;
  padding:12px 20px;
  border-radius:11px;
  border:none;
  box-shadow:0 2px 13px rgba(32,64,120,.08);
  transition:background 0.12s;
}
.cbt-nav-btn[disabled] {
  opacity:.49;
  pointer-events:none;
  background:#f4f4fa;
  color:#9daec0;
}
.cbt-nav-info {
  flex:1;
  text-align:center;
  font-size:18px;
  color:#98afd2;
  font-weight:700;
  padding:0 18px;
}
.cbt-submit-btn {
  background:#28a745;
  color:#fff;
  font-size:19px;
  font-weight:700;
  padding:12px 22px;
  border-radius:11px;
  border:none;
  box-shadow:0 2px 13px rgba(32,170,120,.09);
  transition:background 0.12s;
}

@media (max-width:540px){
  #cbtCard {padding:13px 0px 19px 0px;max-width:97vw;}
  .cbt-q-text{font-size:19px;}
  .cbt-option-label{font-size:16px;padding:11px 9px;}
  .cbt-option-letter{font-size:18px;}
  .cbt-nav-btn{font-size:16px;padding:10px 13px;}
  .cbt-submit-btn{font-size:17px;padding:10px 11px;}
}

/* Enhanced CBT modal header styles */
.cbt-modal-topic {
  text-align:center;
  font-size:21px;
  font-weight:800;
  color:#2454b2;
  letter-spacing:.03em;
  margin-bottom:14px;
  margin-top:-5px;
}
/* You may reuse previous CBT styles */
</style>
</head>
<body>
  <!-- SIDEBAR -->
  <div class="sidebar-backdrop" id="sidebarBackdrop"></div>
  <nav class="sidebar" id="sidebar">
    <div class="sidebar-header">
      <span><i class="fa-solid fa-robot"></i> <b>AI Chat</b></span>
      <i class="fa-solid fa-xmark" id="closeSidebar"></i>
    </div>
    <div class="sidebar-section">
      <button class="sidebar-btn" id="newChatBtn" type="button"><i class="fa-solid fa-plus"></i> New Chat</button>
    </div>
    <div class="sidebar-section">
      <h4><i class="fa-solid fa-list"></i> Topics</h4>
      <ul class="sidebar-list" id="topicsList"></ul>
      <button class="sidebar-btn new-topic" id="newTopicBtn" type="button"><i class="fa-solid fa-plus"></i> Create Topic</button>
    </div>
    <div class="sidebar-section">
      <h4><i class="fa-solid fa-clock-rotate-left"></i> History</h4>
      <ul class="sidebar-list" id="historyList"></ul>
    </div>
    <div class="sidebar-section">
  <button class="sidebar-btn" id="generateMcqBtn" type="button">
    <i class="fa-solid fa-brain"></i> Generate MCQ from File
  </button>
</div>
    <div class="sidebar-section">
      <button class="sidebar-btn-logout" id="logoutBtn"><i class="fa-solid fa-right-from-bracket"></i> Log Out</button>
    </div>
  </nav>
  <!-- MAIN CHAT UI -->
  <div class="chat-app">
    <div class="chat-header">
      <i class="fa-solid fa-bars" id="hamburger"></i>
      <img src="https://ui-avatars.com/api/?name=AI" alt="Avatar" class="avatar"/>
      <span class="chat-title" id="chatTitle">AI Chat</span>
    </div>
    <div class="chat-body" id="chatBody"></div>
    <form class="chat-input-area" id="inputForm" autocomplete="off" onsubmit="return false;">
      <div id="previewImageContainer" style="display:none;" class="img-preview-row"></div>
      <div class="input-row">
        <button type="button" class="input-btn" id="attachBtn" title="Attach file"><i class="fa-solid fa-paperclip"></i></button>
        <input type="file" id="attachInput" accept="image/*,audio/*,video/*,.pdf,.doc,.docx,.txt,.csv" multiple />
        <button type="button" class="input-btn voice" id="voiceBtn" title="Record voice"><i id="voiceIcon" class="fa-solid fa-microphone"></i></button>
        <textarea id="chatInput" rows="1" placeholder="Type a message... (Enter for newline, Shift+Enter or Send for submit)" autocomplete="off"></textarea>
        <button type="submit" class="input-btn" id="sendBtn" title="Send"><i class="fa-solid fa-paper-plane"></i></button>
      </div>
    </form>
  </div>
  <!-- --- SIDEBAR ADDITION: "Generate MCQ from File" menu item --- -->


<!-- --- MCQ GENERATOR MODAL (hidden by default, place before main </body>) --- -->
<div id="mcqFileModal" style="display:none;position:fixed;z-index:2000;left:0;top:0;width:100vw;height:100vh;background:rgba(32,34,60,0.90);align-items:center;justify-content:center;">
  <div style="background:#fff;padding:27px 21px 22px 21px;border-radius:21px;max-width:340px;min-width:260px;">
    <h3 style="text-align:center;margin-bottom:19px;color:#20407a;">Generate MCQs from File</h3>
    <form id="mcqFileForm" autocomplete="off">
      <label style="font-weight:bolder;">Choose file (PDF, DOCX, image):</label>
      <input type="file" name="file" id="mcqFileInput" accept="application/pdf,application/vnd.openxmlformats-officedocument.wordprocessingml.document,image/*" required style="margin-bottom:11px;" />
      <label>Difficulty:</label>
      <select name="difficulty" style="margin-bottom:10px;width:100%">
        <option value="easy">Easy</option>
        <option value="medium" selected>Medium</option>
        <option value="hard">Hard</option>
      </select>
      <label>Number of questions:</label>
      <input type="number" name="numQuestions" min="1" max="100" value="20" required style="margin-bottom:10px;width:100%" />
      <label>Any instruction?</label>
      <textarea name="instructions" rows="2" placeholder="E.g. Focus on section 2 only" style="margin-bottom:15px;width:100%"></textarea>
      <button type="submit" class="sidebar-btn" style="margin-bottom:10px;">Generate MCQs</button>
      <button type="button" id="closeMcqFileModal" class="sidebar-btn-logout">Cancel</button>
    </form>
    <div id="mcqFileStatus" style="margin-top:7px;color:#c63b2e;font-size:14px;text-align:center;"></div>
  </div>
</div>

<script>
  // --- OPEN MODAL ---
  document.getElementById("generateMcqBtn").onclick = function() {
    document.getElementById("mcqFileModal").style.display = "flex";
    document.getElementById("mcqFileStatus").textContent = "";
    document.getElementById("mcqFileForm").reset();
  };
  document.getElementById("closeMcqFileModal").onclick = function() {
    document.getElementById("mcqFileModal").style.display = "none";
  };

  // --- SUBMIT FORM (AJAX to /ai-chat/generate-questions) ---
  document.getElementById("mcqFileForm").onsubmit = async function(e) {
    e.preventDefault();
    const form = e.target;
    const fileInput = form.file.files[0];
    if (!fileInput) return;
    document.getElementById("mcqFileStatus").textContent = "Uploading and generating MCQs...";
    const data = new FormData();
    data.append("file", fileInput);
    data.append("difficulty", form.difficulty.value);
    data.append("numQuestions", form.numQuestions.value);
    data.append("instructions", form.instructions.value);

    try {
      const res = await fetch(API_BASE + "/ai-chat/generate-questions", {
        method: "POST",
        headers: { "Authorization": "Bearer " + jwt_token },
        body: data
      });
      const result = await res.json();
      if (result.questions && result.questions.length) {
        document.getElementById("mcqFileModal").style.display = "none";
        // Use exam session name as topic (create/fetch if needed)
        // You may want to add the new session/channel to topics/history
        // This displays the MCQ exam modal directly:
        window._cbtExamId = result.examId;
        renderCBTExam(result.questions);
        document.getElementById("cbtModal").style.display = "flex";
      } else {
        document.getElementById("mcqFileStatus").textContent = "Failed to generate MCQs. " + (result.error || "Try again or use a different file.");
      }
    } catch (err) {
      document.getElementById("mcqFileStatus").textContent = "Error: " + (err.message || "Could not generate MCQs.");
    }
  };
</script>
  <!-- CBT Exam Modal -->
  <div id="cbtModal" style="display:none;">
    <div id="cbtCard">
      <div id="cbtClose">&times;</div>
      <div id="cbtContent"></div>
    </div>
  </div>
  <div class="floating-btn" id="floatingNewChat" title="Start New Chat"><i class="fa-solid fa-plus"></i></div>
  <script>
    // === CONSTANTS ===
    const API_BASE = "https://examguard-jmvj.onrender.com/api";
    const PAGE_SIZE = 10;
    let jwt_token = localStorage.getItem("token");
    let currentTopic = null, topics = [];
    let messages = [];
    let chatOffset = 0;
    let loading = false;
    let previewImages = [], voicePendingBlob = null;

    // SIDEBAR HANDLERS
    const sidebar = document.getElementById("sidebar"), sidebarBackdrop = document.getElementById("sidebarBackdrop"), closeSidebar = document.getElementById("closeSidebar");
    document.getElementById("hamburger").onclick = ()=>{sidebar.classList.add("open");sidebarBackdrop.classList.add("open");renderTopics();renderHistory();};
    closeSidebar.onclick = sidebarBackdrop.onclick = ()=>{sidebar.classList.remove("open");sidebarBackdrop.classList.remove("open");};
    document.getElementById("floatingNewChat").onclick = document.getElementById("newChatBtn").onclick = ()=>{
      startNewChat();
      sidebar.classList.remove("open");
      sidebarBackdrop.classList.remove("open");
    };
    document.getElementById("newTopicBtn").onclick = ()=>{
      createTopicHandler();
      sidebar.classList.remove("open");
      sidebarBackdrop.classList.remove("open");
    };
    document.getElementById("logoutBtn").onclick = function(){localStorage.removeItem("jwt_token");location.reload();};

    function getAvatar(sender="ai"){return sender==="user" ? "https://ui-avatars.com/api/?name=User" : "https://ui-avatars.com/api/?name=AI";}
    function prettyTime(ts){if(!ts)return"";let d=new Date(ts),h=d.getHours(),m=d.getMinutes();return `${h.toString().padStart(2,"0")}:${m.toString().padStart(2,"0")}`;}
    function escapeHtml(text){return text.replace(/[&<>"']/g,t=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"}[t]));}

    // --- USER PROFILE ---
    let userProfile = null;
    async function loadUserProfile(){
      let res = await fetch(`${API_BASE}/auth/me`,{
        headers:{Authorization:"Bearer "+jwt_token}
      });
      let data=await res.json();
      if(data.user){userProfile = data.user;}
    }

    // --- CBT Button Suggestion, Now checks for more phrases
    function maybeShowCBTButton(aiReply) {
      const triggerCBT = /start.*cbt|cbt.*practice|solve.*cbt|ready.*quiz|test.*yourself|quiz.*session|practice.*questions|assessment/i;
      if(triggerCBT.test(aiReply)){
        const oldBtn = document.getElementById("cbtStartBtn");
        if (oldBtn) oldBtn.remove();
        let btn = document.createElement('button');
        btn.textContent = "Start CBT Practice";
        btn.id = "cbtStartBtn";
        btn.className = "cbt-button";
        btn.style = "margin:18px 0; padding:14px 32px; border-radius:14px; background:linear-gradient(120deg,#396ae2 60%,#7db9fb 100%); box-shadow:0 4px 19px rgba(44, 92, 220, 0.07); color:#fff;font-size:18px;border:none;cursor:pointer;";
        btn.onclick = function() {
          btn.remove();
          launchCBT(currentTopic.name);
        };
        document.getElementById("chatBody").appendChild(btn);
        document.getElementById("chatBody").scrollTop = document.getElementById("chatBody").scrollHeight;
      }
    }

    // TOPICS
    async function fetchTopics(){
      let res=await fetch(`${API_BASE}/ai-chat/topics`,{headers:{Authorization:"Bearer "+jwt_token}});
      let data=await res.json();
      topics = (data.topics || []);
      if(!currentTopic && topics.length) currentTopic = topics[0];
      renderTopics();
    }
    function renderTopics(){
      const topicsList=document.getElementById("topicsList"); topicsList.innerHTML="";
      topics.forEach((t,idx)=>{
        const li=document.createElement("li");
        li.innerHTML = `<i class="fa-solid fa-comment-dots"></i> <span>${t.name}</span>`;
        li.onclick = ()=>{switchTopicAndRestore(t); sidebar.classList.remove("open"); sidebarBackdrop.classList.remove("open");};
        if(currentTopic&&currentTopic.id===t.id) li.style.fontWeight="bold";
        topicsList.appendChild(li);
      });
    }
    async function createTopicHandler(){
      const name = prompt("Topic name?");
      if(!name)return;
      let res=await fetch(`${API_BASE}/ai-chat/topics`,{
        method:"POST",
        headers:{"Content-Type":"application/json",Authorization:"Bearer "+jwt_token},
        body:JSON.stringify({name}) }
      );
      await fetchTopics();
      if(topics.length){
        currentTopic = topics.find(t=>t.name===name) || topics[topics.length-1];
        startNewChat();
      }
    }

    function startNewChat(){
      chatOffset = 0;
      messages = [];
      saveChatOffset();
      renderChat(true);
    }
    function renderHistory(){
      const historyList=document.getElementById("historyList"); historyList.innerHTML="";
      if(!topics.length)return;
      topics.forEach(t=>{
        let li=document.createElement("li");
        li.innerHTML = `<i class="fa-regular fa-comments"></i> <span>${t.name}</span>`;
        li.onclick = ()=>{switchTopicAndRestore(t); sidebar.classList.remove("open"); sidebarBackdrop.classList.remove("open");};
        historyList.appendChild(li);
      });
    }
    function switchTopicAndRestore(topic){
      currentTopic = topic;
      chatOffset = 0;
      messages = [];
      saveLastTopic();
      loadMessages(PAGE_SIZE, true);
    }
    function saveLastTopic() {
      if (currentTopic) localStorage.setItem('last_topic_name', currentTopic.name);
    }

    async function resetChat(resetOffset){
      if(resetOffset){ chatOffset = 0; }
      messages = [];
      await loadMessages(PAGE_SIZE, resetOffset);
      saveChatOffset();
    }

    async function loadMessages(n=PAGE_SIZE, initial=false){
      if(!currentTopic || loading) return;
      loading = true;
      let offset = chatOffset;
      let res = await fetch(`${API_BASE}/ai-chat/history?offset=${offset}&limit=${n}&channel=${encodeURIComponent(currentTopic.name)}`,{
        headers:{Authorization:"Bearer "+jwt_token}
      });
      let data = await res.json();
      let newMessages = [];
      if (data.history && data.history.length>0){
        data.history.forEach(msg => {
          (msg.messages||[]).forEach(subMsg=>{
            newMessages.push({
              sender: (subMsg.role==="prof"||subMsg.role==="professor")?"ai":"user",
              text: subMsg.content||"",
              time: msg.date ? new Date(msg.date).getTime() : Date.now()
            });
          });
          if(msg.professorReply){
            newMessages.push({
              sender:"ai", text:msg.professorReply, time:msg.date ? new Date(msg.date).getTime() : Date.now()
            });
          }
        });
        messages = newMessages.concat(messages); // prepend
        chatOffset += data.history.length;
        saveChatOffset();
        renderChat(initial);
      } else if (offset > 0) {
        chatOffset = 0;
        localStorage.setItem('chat_offset_' + currentTopic.id, 0);
        if (!initial) {
          await loadMessages(n, true); // Try one more time from zero
        } else {
          renderChat(initial);
        }
      } else {
        renderChat(initial);
      }
      loading = false;
    }
    function saveChatOffset(){if(currentTopic)localStorage.setItem('chat_offset_' + currentTopic.id, chatOffset);}
    function restoreChatOffset(){
      if(currentTopic) chatOffset = parseInt(localStorage.getItem('chat_offset_' + currentTopic.id)||"0",10);
    }
    function renderChat(scrollToBottom){
      const chatBody=document.getElementById("chatBody"); chatBody.innerHTML="";
      if(!messages.length){appendMessage("Hello! üëã Type your message below.","ai",null,null,true);return;}
      messages.forEach(m=>appendMessage(m.text,m.sender,m.images,m.voice,false,m.time));
      if(window.MathJax) MathJax.typesetPromise([chatBody]);
      if(scrollToBottom) chatBody.scrollTop = chatBody.scrollHeight;
    }
    function appendMessage(text,sender='user',images=null,voice=null,isHello=false,ts=null){
      const chatBody=document.getElementById("chatBody"),bubble=document.createElement("div");
      bubble.className=`chat-bubble ${sender}`;
      let meta=`<img src="${getAvatar(sender)}" class="bubble-avatar" title="${sender==='user'?(userProfile && userProfile.fullname ? userProfile.fullname : 'You'):'AI'}"/>`;
      let html = sender === "ai" ? marked.parse(text || "") : escapeHtml(text || "");
      if(sender === "ai") html = html.replace(/<p>/g, "<p class='rich-block'>");
      bubble.innerHTML = `<div>${html}</div>`;
      if(images && images.length){
        let imgRow=document.createElement('div'); imgRow.className='msg-file';
        images.forEach(img=>{imgRow.innerHTML+=`<img src="${img.url}" alt="${img.name}">`;});
        bubble.appendChild(imgRow);
      }
      if(voice){let voiceDiv=document.createElement('div');voiceDiv.className='msg-voice';voiceDiv.innerHTML=`<i class="fa-solid fa-headphones"></i> <audio controls src="${voice.url}"></audio>`;bubble.appendChild(voiceDiv);}
      let bubbleMeta=document.createElement('div');bubbleMeta.className="bubble-meta";
      bubbleMeta.innerHTML=meta+(ts?`<span title="${new Date(ts).toLocaleString()}">${prettyTime(ts)}</span>`:"");
      bubble.appendChild(bubbleMeta);
      chatBody.appendChild(bubble);
      // After rendering: typeset any math
      if(window.MathJax) MathJax.typesetPromise([bubble]);
    }

    // IMAGE PREVIEW
    const attachInput=document.getElementById("attachInput"),previewImageContainer=document.getElementById("previewImageContainer"),chatInput=document.getElementById("chatInput");
    document.getElementById("attachBtn").onclick=()=>attachInput.click();
    attachInput.onchange=function(){
      const files=Array.from(this.files);
      for(const file of files){
        if(!file.type.startsWith("image/"))continue;
        const reader=new FileReader();
        reader.onload=function(e){
          previewImages.push({url:e.target.result,name:file.name,type:file.type,file:file});
          showPreviewImages();
        };
        reader.readAsDataURL(file);
      }
      attachInput.value="";
    };
    function showPreviewImages(){
      if(!previewImages.length){previewImageContainer.style.display="none";previewImageContainer.innerHTML="";return;}
      previewImageContainer.innerHTML="";
      previewImages.forEach((img,idx)=>{
        let wrapper=document.createElement("div");wrapper.style.position="relative";wrapper.style.display="inline-block";
        let imgEl=document.createElement("img");imgEl.className="img-preview-thumb";imgEl.src=img.url;imgEl.alt=img.name;wrapper.appendChild(imgEl);
        let btn=document.createElement("button");btn.className="img-remove-btn";btn.innerHTML="&times;";
        btn.onclick=function(){previewImages.splice(idx,1);showPreviewImages();};
        wrapper.appendChild(btn);previewImageContainer.appendChild(wrapper);
      });
      previewImageContainer.style.display="flex";
    }
    function clearPreviewImages(){previewImages=[];previewImageContainer.style.display="none";previewImageContainer.innerHTML="";attachInput.value="";}

    // MULTILINE INPUT: Enter=newline, Shift+Enter=send
    chatInput.addEventListener("keydown",function(e){
      if(e.key==="Enter" && !e.shiftKey){
        e.preventDefault();
        const start=chatInput.selectionStart,end=chatInput.selectionEnd;
        chatInput.value=chatInput.value.substring(0,start)+"\n"+chatInput.value.substring(end);
        chatInput.selectionStart=chatInput.selectionEnd=start+1;
      }
    });
    document.getElementById("sendBtn").onclick = onSend;
    document.getElementById("inputForm").onsubmit = function(){onSend();return false;}

    let voiceRecording=false,mediaRecorder=null,voiceChunks=[];
    document.getElementById("voiceBtn").onclick=async function(){
      if(!voiceRecording){
        this.classList.add("recording");
        document.getElementById("voiceIcon").classList.replace("fa-microphone","fa-circle-dot");
        const stream=await navigator.mediaDevices.getUserMedia({audio:true});
        voiceRecording=true;voiceChunks=[];
        mediaRecorder=new MediaRecorder(stream);
        mediaRecorder.ondataavailable=e=>voiceChunks.push(e.data);
        mediaRecorder.onstop=()=>{
          this.classList.remove("recording");
          document.getElementById("voiceIcon").classList.replace("fa-circle-dot","fa-microphone");
          voiceRecording=false;
          const blob=new Blob(voiceChunks,{type:'audio/webm'});
          const url=URL.createObjectURL(blob);
          voicePendingBlob={url,name:"voice_note.webm"};
        }
        mediaRecorder.start();
        setTimeout(()=>{if(voiceRecording)mediaRecorder.stop();},12000);
      } else { mediaRecorder && mediaRecorder.stop(); }
    }
    async function blobToBase64(blob) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onloadend = () => {
          resolve(reader.result.split(',')[1]);
        };
        reader.onerror = reject;
        reader.readAsDataURL(blob);
      });
    }

    // ==== INFINITE UPWARD SCROLL ====
    const chatBody = document.getElementById("chatBody");
    let lastScrollHeight = 0;
    chatBody.addEventListener("scroll", async function(){
      if(chatBody.scrollTop < 70 && !loading && messages.length >= PAGE_SIZE){
        lastScrollHeight = chatBody.scrollHeight;
        await loadMessages(PAGE_SIZE);
        setTimeout(function(){
          chatBody.scrollTop = chatBody.scrollHeight - lastScrollHeight;
        },100);
      }
    });

    // === BOOTSTRAP: load last topic/offset and user profile ===
    (async function(){
      if (!jwt_token) {
        alert("Sign in required! Please log in on the authentication page.");
        return;
      }
      await loadUserProfile();
      await fetchTopics();
      if (topics.length) {
        let lastTopicName = localStorage.getItem('last_topic_name');
        let previousTopic = topics.find(t => t.name === lastTopicName) || topics[0];
        currentTopic = previousTopic;
        restoreChatOffset();
        messages = [];
        await loadMessages(PAGE_SIZE, true);
        setTimeout(() => chatBody.scrollTop = chatBody.scrollHeight, 100);
      }
    })();

    document.getElementById("chatTitle").onclick=function(){
      if(currentTopic){
        saveLastTopic();
        saveChatOffset();
        alert("Current Topic: "+currentTopic.name);
      }
    }


    function launchCBT(topicName) {
      document.getElementById("cbtModal").style.display = "flex";
      document.getElementById("cbtContent").innerHTML = `<div style="text-align:center;"><b>Preparing exam...</b></div>`;
      fetch(`${API_BASE}/ai-chat/schedule-cbt`,{
        method: "POST",
        headers: {"Content-Type":"application/json", "Authorization": "Bearer "+jwt_token},
        body: JSON.stringify({channel: topicName, n: 20})
      })
      .then(res => res.json())
      .then(data => {
        window._cbtExamId = data.examId;
        renderCBTExam(data.questions);
      })
      .catch(()=>{
        document.getElementById("cbtContent").innerHTML = "Could not load exam.";
      });
    }

  
function renderCBTExam(questions, topicTitle) {
  // YOU MUST pass the topicTitle (string, e.g. "Enzyme Kinetics") when calling this function!
  let currentQ = window._cbtExamCurrentQ || 0;
  let answers = window._cbtExamAnswers || Array(questions.length).fill(null);

  window._cbtExamQuestions = questions;
  window._cbtExamAnswers = answers;
  window._cbtExamCurrentQ = currentQ;

  // Helper for answer letter
  const getLetter = idx => String.fromCharCode(65 + idx);

  function updateCBTModal() {
    const qObj = questions[currentQ];
    let qHtml = `
      <div class="cbt-modal-content">
        <div class="cbt-modal-topic" style="text-align:center;font-size:21px;font-weight:800;color:#2454b2;letter-spacing:.03em;margin-bottom:14px;">
          ${topicTitle || "CBT Practice"}
        </div>
        <div class="cbt-question-header" style="margin-bottom:9px;">
          <span class="cbt-q-text" style="font-size:22px;font-weight:700;color:#142040;line-height:1.33;">
            ${qObj.text}
          </span>
        </div>
        <form id="cbtSingleForm" class="cbt-option-form" style="margin-bottom:2px;">
          ${qObj.options.map((opt,idx) => `
            <div class="cbt-option-row">
              <label class="cbt-option-label" style="background:white;border-radius:15px;font-size:19px;font-weight:500;box-shadow:0 1.2px 7px rgba(50,100,170,0.09);border:1.5px solid #eaf0f8;padding:13px 19px;display:flex;align-items:center;gap:15px;">
                <input type="radio" name="cbt_q${currentQ}" value="${idx}" ${answers[currentQ]===idx?"checked":""}/>
                <span class="cbt-option-letter" style="font-weight:700;font-size:20px;margin-right:6px;color:#234ab7;">
                  ${getLetter(idx)}.
                </span>
                <span class="cbt-option-text" style="font-size:18px;letter-spacing:.01em;color:#24316c;font-weight:600;">
                  ${opt}
                </span>
              </label>
            </div>
          `).join('')}
        </form>
      </div>
      <div class="cbt-modal-nav" style="display:flex;justify-content:space-between;align-items:center;margin-top:11px;padding-top:11px;border-top:1px solid #e5eaf4;gap:6px;">
        <button id="cbtPrevBtn" class="cbt-nav-btn" style="background:#edf2fc;color:#3768af;font-size:19px;font-weight:700;padding:12px 20px;border-radius:11px;border:none;box-shadow:0 2px 13px rgba(32,64,120,.08);${currentQ===0?'opacity:.49;pointer-events:none;background:#f4f4fa;color:#9daec0;':''}">‚Üê Prev (P)</button>
        <span class="cbt-nav-info" style="flex:1;text-align:center;font-size:18px;color:#222244;font-weight:700;padding:0 10px;">
          Question ${currentQ+1}/${questions.length}
        </span>
        <button id="cbtNextBtn" class="cbt-nav-btn" style="background:#edf2fc;color:#4a8ad6;font-size:19px;font-weight:700;padding:12px 20px;border-radius:11px;border:none;box-shadow:0 2px 13px rgba(32,64,120,.08);${currentQ===questions.length-1?'opacity:.49;pointer-events:none;background:#f4f4fa;color:#9daec0;':''}">Next (X) ‚Üí</button>
        <button id="cbtSubmitBtn" class="cbt-submit-btn" style="background:#28a745;color:#fff;font-size:19px;font-weight:700;padding:12px 22px;border-radius:11px;border:none;box-shadow:0 2px 13px rgba(32,170,120,.09);${currentQ===questions.length-1?'':'display:none;'}">Submit Exam</button>
      </div>
    `;

    document.getElementById("cbtContent").innerHTML = qHtml;

    // --- HANDLERS ---
    document.getElementById("cbtSingleForm").onchange = function(e) {
      if(e.target.name===`cbt_q${currentQ}`) {
        answers[currentQ] = parseInt(e.target.value);
      }
    };
    document.getElementById("cbtPrevBtn").onclick = function() {
      if(currentQ>0){ currentQ--; window._cbtExamCurrentQ=currentQ; updateCBTModal(); }
    };
    document.getElementById("cbtNextBtn").onclick = function() {
      if(currentQ<questions.length-1){ currentQ++; window._cbtExamCurrentQ=currentQ; updateCBTModal(); }
    };
    if(document.getElementById("cbtSubmitBtn")) {
      document.getElementById("cbtSubmitBtn").onclick = function() {
        gradeCBTExam(window._cbtExamId, answers, questions);
      };
    }
    // Keyboard shortcuts
    document.onkeydown = function(e) {
      if(document.getElementById("cbtModal").style.display==="flex") {
        if (e.key === "ArrowRight" || e.key.toLowerCase()==="x") { if(currentQ < questions.length-1) {currentQ++; window._cbtExamCurrentQ=currentQ; updateCBTModal();} }
        if (e.key === "ArrowLeft" || e.key.toLowerCase()==="p") { if(currentQ > 0) { currentQ--; window._cbtExamCurrentQ=currentQ; updateCBTModal(); } }
      }
    };
    // Math typeset
    if(window.MathJax){ MathJax.typesetPromise([document.getElementById("cbtContent")]); }
  }

  document.getElementById("cbtModal").style.display = "flex";
  updateCBTModal();
}

  // --- CBT MCQ LocalStorage Key ---
  const CBT_LOCAL_KEY = "cbt_pending_mcqs";
  const CBT_TOPIC_KEY = "cbt_pending_title";

  // --- Modified onSend logic to HIDE JSON questions; only shows explanation + button ---
  async function onSend(){
    let text=chatInput.value.trim();
    if(!text && (!previewImages||!previewImages.length) && !voicePendingBlob) return;
    appendMessage(text||"", "user", previewImages.length?previewImages:null, voicePendingBlob?{url:voicePendingBlob.url}:null, false, Date.now());
    let payload = {
      messages: [{role:'user',content:text}],
      channel: currentTopic ? currentTopic.name : "General"
    };
    if(previewImages.length){
      let img = previewImages[0];
      payload.image = {mimeType:img.type, data:img.url.split(",")[1], fileName:img.name};
    }
    if(voicePendingBlob){
      payload.voice = {mimeType:"audio/webm", data:await blobToBase64(await fetch(voicePendingBlob.url).then(r=>r.blob())), fileName:"voice_note.webm"};
    }
    chatInput.value="";clearPreviewImages();voicePendingBlob=null;
    // Show typing AI
    let typingDiv = document.createElement("div");
    typingDiv.className = "chat-bubble ai";
    typingDiv.innerHTML = `<div><i class="fa-solid fa-ellipsis fa-bounce"></i> AI is typing...</div>`;
    document.getElementById("chatBody").appendChild(typingDiv);
    document.getElementById("chatBody").scrollTop = document.getElementById("chatBody").scrollHeight;

    let res = await fetch(`${API_BASE}/ai-chat/send`,{
      method:"POST",
      headers:{"Content-Type":"application/json",Authorization:"Bearer "+jwt_token},
      body:JSON.stringify(payload)
    });
    let data = await res.json();
    typingDiv.remove();

    if (data.reply) {
      // Detect a JSON block for MCQs in the AI reply
      let mcqMatch = data.reply.match(/\[\s*\{[\s\S]*?\}\s*\]/);
      if (mcqMatch) {
        try {
          let questions = JSON.parse(mcqMatch[0]);
          // Only show the explanation in chat, and STORE MCQs LOCALLY
          let explanation = data.reply.split(mcqMatch[0])[0].trim();
          messages.push({sender: "ai", text: explanation, time: Date.now()});
          appendMessage(explanation, "ai", null, null, false, Date.now());

          // Use currentTopic.name for topic, or fallback
          let topicTitle = currentTopic && currentTopic.name ? currentTopic.name : "CBT Practice";
          // Save MCQs and title to localStorage
          localStorage.setItem(CBT_LOCAL_KEY, JSON.stringify(questions));
          localStorage.setItem(CBT_TOPIC_KEY, topicTitle);

          // Show "Start CBT" button if not already present
          showCBTButton(topicTitle);
        } catch (e) {
          messages.push({sender:"ai",text:data.reply, time:Date.now()});
          appendMessage(data.reply,"ai",null,null,false,Date.now());
        }
      } else {
        messages.push({sender:"ai",text:data.reply, time:Date.now()});
        appendMessage(data.reply,"ai",null,null,false,Date.now());
        maybeShowCBTButton(data.reply); // fallback CBT button display logic
      }
      if(window.MathJax) MathJax.typesetPromise([document.getElementById("chatBody")]);
    } else {
      messages.push({sender:"ai",text:"[No response]", time:Date.now()});
      appendMessage("[No response]","ai",null,null,false,Date.now());
    }
    saveChatOffset();
  }

  // --- Show CBT Button below chat when MCQs are in localStorage ---
  function showCBTButton(topicTitle) {
    // Remove existing button if any
    const oldBtn = document.getElementById("cbtStartBtn");
    if (oldBtn) oldBtn.remove();
    let btn = document.createElement('button');
    btn.textContent = "Start CBT Practice";
    btn.id = "cbtStartBtn";
    btn.className = "cbt-button";
    btn.style = "margin:18px 0; padding:14px 32px; border-radius:14px; background:linear-gradient(120deg,#396ae2 60%,#7db9fb 100%); box-shadow:0 4px 19px rgba(44, 92, 220, 0.07); color:#fff;font-size:19px;font-weight:bold;display:block;";
    btn.onclick = function() {
      btn.remove();
      launchCBTFromLocal(topicTitle);
    };
    document.getElementById("chatBody").appendChild(btn);
    document.getElementById("chatBody").scrollTop = document.getElementById("chatBody").scrollHeight;
  }

  // --- CBT Modal from localStorage MCQs ---
  function launchCBTFromLocal(topicTitle) {
    // Fetch MCQs from localStorage
    let raw = localStorage.getItem(CBT_LOCAL_KEY);
    let qArr = [];
    try {
      qArr = JSON.parse(raw);
      if (!Array.isArray(qArr) || qArr.length === 0) throw new Error("No MCQs found in localStorage.");
    } catch (e) {
      alert("CBT questions not found or invalid!");
      return;
    }
    document.getElementById("cbtModal").style.display = "flex";
    renderCBTExam(qArr, topicTitle || localStorage.getItem(CBT_TOPIC_KEY));
  }

  // --- Remove MCQs from localStorage on CBT close/submit ---
  function clearLocalCBT() {
    localStorage.removeItem(CBT_LOCAL_KEY);
    localStorage.removeItem(CBT_TOPIC_KEY);
    window._cbtExamQuestions = null;
    window._cbtExamAnswers = null;
    window._cbtExamCurrentQ = 0;
  }

  // --- CBT Modal logic: Override close to clear local CBT ---
  document.getElementById('cbtClose').onclick = function() {
    closeCBTModal();
    clearLocalCBT();
  };
  function closeCBTModal() {
    document.getElementById("cbtModal").style.display = "none";
    document.getElementById("cbtContent").innerHTML = "";
    clearLocalCBT();
  }

  // --- CBT Modal submission: Override to clear localStorage after grading ---
  function gradeCBTExam(examId, answers, questions) {
    document.getElementById("cbtContent").innerHTML = `<div style="text-align:center;">Scoring...</div>`;
    // Simulate grading locally
    let score = 0;
    let explanations = [];
    for (let i = 0; i < questions.length; i++) {
      const q = questions[i];
      let correct = answers[i] === q.answer;
      if (correct) score++;
      explanations.push({
        correct,
        answer: q.answer,
        yourAnswer: answers[i] ?? null,
        options: q.options,
        explanation: q.explanation || "",
        question: q.text
      });
    }
    let html = `<h2 style="text-align:center;color:#37ab49;">Score: ${score} / ${questions.length}</h2>`;
    html += `<div style="margin-bottom:14px;text-align:center;">You scored ${score}/${questions.length}</div>`;
    explanations.forEach((exp, i) => {
      html += `<div style='margin-bottom:16px; background:#f7faff; border-radius:8px; padding:9px 13px;box-shadow:0 1.5px 8px rgba(57,106,226,0.08);'>
        <div style="font-weight:bold;">Q${i+1}: ${exp.question}</div>
        <div>Your answer: <span style='color:${exp.correct ? "#37ab49":"#d63e3e"}'>${exp.options[exp.yourAnswer]||"No answer"}</span></div>
        <div>Correct answer: <b>${exp.options[exp.answer]}</b></div>
        <div><span style='color:#3264a3'><i>${exp.explanation}</i></span></div>
      </div>`;
    });
    html += `<button onclick="closeCBTModal()" class="cbt-button" style="margin:18px auto 0 auto;">Close</button>`;
    document.getElementById("cbtContent").innerHTML = html;
    // Remove MCQ data from localStorage after grading
    clearLocalCBT();
  }
</script>
</body>
</html>
