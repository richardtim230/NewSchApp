<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Admin Dashboard | OAU ExamGuard</title>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/flowbite/2.3.0/flowbite.min.css" rel="stylesheet" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/flowbite/2.3.0/flowbite.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Poppins', sans-serif; }
    .sidebar {
      min-width: 240px;
      max-width: 260px;
      background: linear-gradient(120deg, #f0f4ff 0%, #e3ecfd 100%);
      border-right: 1px solid #e5e7eb;
    }
    .sidebar-link { transition: background 0.15s, color 0.15s; }
    .sidebar-link:hover, .sidebar-link.active { background: #6366f1; color: #fff; }
    @media (max-width: 900px) {
      .sidebar { position: fixed; left: -260px; top: 0; bottom: 0; z-index: 1000; transition: left 0.2s; }
      .sidebar.open { left: 0; }
    }
  </style>
</head>
<body class="bg-gray-50 min-h-screen flex flex-col">

  <!-- Sidebar (Desktop) / Hamburger (Mobile) -->
  <div class="sidebar fixed top-0 left-0 h-full flex flex-col shadow-lg px-5 py-7 z-50" id="sidebar">
    <div class="flex items-center gap-3 mb-8">
      <img src="logo.png" alt="Logo" class="h-10 w-10 rounded-full border-2 border-indigo-200 shadow" />
      <span class="font-extrabold text-indigo-700 text-xl tracking-wide">ExamGuard Admin</span>
    </div>
    <a href="#" class="sidebar-link flex items-center gap-3 px-4 py-3 rounded-lg text-indigo-700 font-semibold active">Dashboard</a>
    <a href="#" class="sidebar-link flex items-center gap-3 px-4 py-3 rounded-lg text-indigo-700 font-semibold">Students</a>
    <a href="#" class="sidebar-link flex items-center gap-3 px-4 py-3 rounded-lg text-indigo-700 font-semibold">Transactions</a>
    <a href="#" class="sidebar-link flex items-center gap-3 px-4 py-3 rounded-lg text-indigo-700 font-semibold">Withdrawals</a>
    <a href="#" class="sidebar-link flex items-center gap-3 px-4 py-3 rounded-lg text-indigo-700 font-semibold">Settings</a>
    <div class="mt-auto pt-7">
      <button id="logoutBtn" class="w-full px-4 py-2 bg-indigo-600 text-white rounded-lg font-bold shadow hover:bg-indigo-700 transition">Logout</button>
    </div>
  </div>
  <!-- Hamburger for mobile -->
  <button id="hamburgerBtn" class="fixed top-5 left-5 z-50 bg-indigo-600 text-white p-3 rounded-full shadow-lg md:hidden">
    <svg class="w-7 h-7" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" d="M4 8h16M4 16h16"/>
    </svg>
  </button>
  <div id="sidebarOverlay" class="fixed inset-0 bg-black bg-opacity-30 z-40 hidden"></div>

  <!-- Main Content -->
  <main class="flex-1 flex flex-col md:ml-[260px] pt-7 px-4">
    <!-- Top Stats -->
    <section class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-10">
      <div class="bg-white rounded-xl shadow p-6 flex flex-col items-start">
        <span class="text-gray-500 font-medium mb-1">Total Points Assigned</span>
        <span class="text-3xl font-extrabold text-indigo-700" id="totalPoints">0</span>
      </div>
      <div class="bg-white rounded-xl shadow p-6 flex flex-col items-start">
        <span class="text-gray-500 font-medium mb-1">Total Amount (₦)</span>
        <span class="text-3xl font-extrabold text-yellow-600" id="totalAmount">₦0.00</span>
      </div>
      <div class="bg-white rounded-xl shadow p-6 flex flex-col items-start">
        <span class="text-gray-500 font-medium mb-1">Active Students</span>
        <span class="text-3xl font-extrabold text-green-600" id="activeStudents">0</span>
      </div>
      <div class="bg-white rounded-xl shadow p-6 flex flex-col items-start">
        <span class="text-gray-500 font-medium mb-1">Pending Withdrawals</span>
        <span class="text-3xl font-extrabold text-red-500" id="pendingWithdrawals">0</span>
      </div>
    </section>

    <!-- Student Details Table -->
    <section class="bg-white rounded-xl shadow p-8 mb-10 overflow-x-auto">
      <div class="flex items-center justify-between mb-5">
        <h2 class="text-2xl font-bold text-indigo-900">Students Account Details</h2>
        <input type="text" id="searchInput" class="form-input px-4 py-2 rounded-lg border border-gray-200" placeholder="Search by name, username or bank..." style="max-width: 240px;" />
      </div>
      <table class="min-w-full text-sm">
        <thead>
          <tr class="bg-indigo-50 text-indigo-700">
            <th class="font-semibold py-3 px-4 text-left">Name</th>
            <th class="font-semibold py-3 px-4 text-left">Username</th>
            <th class="font-semibold py-3 px-4 text-left">Points</th>
            <th class="font-semibold py-3 px-4 text-left">Amount (₦)</th>
            <th class="font-semibold py-3 px-4 text-left">Bank</th>
            <th class="font-semibold py-3 px-4 text-left">Account Name</th>
            <th class="font-semibold py-3 px-4 text-left">Account Number</th>
            <th class="font-semibold py-3 px-4 text-left">Status</th>
            <th class="font-semibold py-3 px-4 text-left">Actions</th>
          </tr>
        </thead>
        <tbody id="studentsTable">
          <!-- JS will populate rows here -->
        </tbody>
      </table>
      <div id="emptyState" class="text-center text-gray-500 py-6 hidden">
        No students found.
      </div>
    </section>

    <!-- Recent Transactions Table -->
    <section class="bg-white rounded-xl shadow p-8 mb-10 overflow-x-auto">
      <div class="flex items-center justify-between mb-5">
        <h2 class="text-2xl font-bold text-indigo-900">Recent Transactions</h2>
        <button id="exportTx" class="bg-indigo-100 text-indigo-700 px-5 py-2 font-semibold rounded-lg shadow hover:bg-indigo-200">Export CSV</button>
      </div>
      <table class="min-w-full text-sm">
        <thead>
          <tr class="bg-indigo-50 text-indigo-700">
            <th class="font-semibold py-3 px-4 text-left">Date</th>
            <th class="font-semibold py-3 px-4 text-left">Student</th>
            <th class="font-semibold py-3 px-4 text-left">Type</th>
            <th class="font-semibold py-3 px-4 text-left">Points</th>
            <th class="font-semibold py-3 px-4 text-left">Amount (₦)</th>
            <th class="font-semibold py-3 px-4 text-left">Reason/Ref</th>
          </tr>
        </thead>
        <tbody id="transactionsTable">
          <!-- JS will populate rows here -->
        </tbody>
      </table>
      <div id="emptyTxState" class="text-center text-gray-500 py-6 hidden">
        No transactions found.
      </div>
    </section>

    <!-- Withdrawals Table -->
    <section class="bg-white rounded-xl shadow p-8 mb-10 overflow-x-auto">
      <div class="flex items-center justify-between mb-5">
        <h2 class="text-2xl font-bold text-indigo-900">Withdrawals</h2>
        <button id="exportWd" class="bg-yellow-100 text-yellow-700 px-5 py-2 font-semibold rounded-lg shadow hover:bg-yellow-200">Export CSV</button>
      </div>
      <table class="min-w-full text-sm">
        <thead>
          <tr class="bg-yellow-50 text-yellow-700">
            <th class="font-semibold py-3 px-4 text-left">Date</th>
            <th class="font-semibold py-3 px-4 text-left">Student</th>
            <th class="font-semibold py-3 px-4 text-left">Amount (₦)</th>
            <th class="font-semibold py-3 px-4 text-left">Bank</th>
            <th class="font-semibold py-3 px-4 text-left">Account Name</th>
            <th class="font-semibold py-3 px-4 text-left">Account Number</th>
            <th class="font-semibold py-3 px-4 text-left">Status</th>
            <th class="font-semibold py-3 px-4 text-left">Actions</th>
          </tr>
        </thead>
        <tbody id="withdrawalsTable">
          <!-- JS will populate rows here -->
        </tbody>
      </table>
      <div id="emptyWdState" class="text-center text-gray-500 py-6 hidden">
        No withdrawals found.
      </div>
    </section>
  </main>

  <!-- Toast Notification -->
  <div id="toast" class="hidden fixed bottom-7 right-7 z-[9999] bg-emerald-600 text-white px-6 py-3 rounded-lg shadow-lg text-base font-semibold transition-opacity duration-300"></div>

  <script>
    // Sidebar toggling for mobile
    const sidebar = document.getElementById('sidebar');
    const sidebarOverlay = document.getElementById('sidebarOverlay');
    document.getElementById('hamburgerBtn').onclick = function() {
      sidebar.classList.add('open');
      sidebarOverlay.classList.remove('hidden');
    };
    sidebarOverlay.onclick = function() {
      sidebar.classList.remove('open');
      sidebarOverlay.classList.add('hidden');
    };

    // Toast
    function showToast(message, type = "success") {
      var toast = document.getElementById('toast');
      if (!toast) return;
      toast.className = 'fixed bottom-7 right-7 z-[9999] px-6 py-3 rounded-lg shadow-lg text-base font-semibold transition-opacity duration-300';
      toast.classList.add(type === "success" ? 'bg-emerald-600' : 'bg-red-600');
      toast.classList.remove(type === "success" ? 'bg-red-600' : 'bg-emerald-600');
      toast.textContent = message;
      toast.style.opacity = 1;
      toast.classList.remove('hidden');
      setTimeout(() => {
        toast.style.opacity = 0;
        setTimeout(() => { toast.classList.add('hidden'); }, 250);
      }, 2500);
    }

    const API_BASE = "https://examguide.onrender.com";
    const token = localStorage.getItem('adminToken') || "";

    function formatNaira(amount) {
      if (typeof amount !== "number" || isNaN(amount) || amount < 0) return "₦0.00";
      return '₦' + amount.toLocaleString('en-NG', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    }

    async function fetchDashboardData() {
      const headers = { "Authorization": "Bearer " + token };
      // Summary
      const summaryRes = await fetch(`${API_BASE}/api/admin/summary`, { headers });
      if (!summaryRes.ok) throw new Error("Session expired");
      const summary = await summaryRes.json();

      // Students
      const studentsRes = await fetch(`${API_BASE}/api/admin/students?limit=50`, { headers });
      if (!studentsRes.ok) throw new Error("Session expired");
      const studentsData = await studentsRes.json();

      // Transactions
      const txRes = await fetch(`${API_BASE}/api/admin/transactions?limit=30`, { headers });
      if (!txRes.ok) throw new Error("Session expired");
      const txData = await txRes.json();

      // Withdrawals
      const wdRes = await fetch(`${API_BASE}/api/admin/withdrawals?limit=30`, { headers });
      if (!wdRes.ok) throw new Error("Session expired");
      const wdData = await wdRes.json();

      return {
        totalPoints: summary.totalPoints,
        totalAmount: summary.totalAmount,
        activeStudents: summary.activeStudents,
        pendingWithdrawals: summary.pendingWithdrawals,
        students: studentsData.students,
        transactions: txData.transactions,
        withdrawals: wdData.withdrawals
      };
    }

    // Data rendering
    async function renderDashboard() {
      try {
        const data = await fetchDashboardData();
        document.getElementById('totalPoints').textContent = data.totalPoints;
        document.getElementById('totalAmount').textContent = formatNaira(data.totalAmount);
        document.getElementById('activeStudents').textContent = data.activeStudents;
        document.getElementById('pendingWithdrawals').textContent = data.pendingWithdrawals;

        // Students Table
        const studentsTable = document.getElementById('studentsTable');
        studentsTable.innerHTML = "";
        if (!data.students || data.students.length === 0) {
          document.getElementById('emptyState').classList.remove('hidden');
        } else {
          document.getElementById('emptyState').classList.add('hidden');
          data.students.forEach(s => {
            const row = document.createElement('tr');
            row.innerHTML = `
              <td class="py-2 px-4">${s.fullname}</td>
              <td class="py-2 px-4">${s.username}</td>
              <td class="py-2 px-4">${s.points}</td>
              <td class="py-2 px-4">${formatNaira(s.points)}</td>
              <td class="py-2 px-4">${s.bank || "-"}</td>
              <td class="py-2 px-4">${s.accountName || "-"}</td>
              <td class="py-2 px-4">${s.accountNumber || "-"}</td>
              <td class="py-2 px-4">
                <span class="inline-block px-3 py-1 rounded-full font-semibold ${
                  s.status === 'active' ? 'bg-emerald-100 text-emerald-700' :
                  s.status === 'pending' ? 'bg-yellow-100 text-yellow-700' :
                  'bg-red-100 text-red-700'
                }">${s.status}</span>
              </td>
              <td class="py-2 px-4 flex gap-2">
                <button class="bg-indigo-500 text-white font-bold px-3 py-1 rounded shadow hover:bg-indigo-600" onclick="viewProfile('${s._id}')">View</button>
                ${s.status !== 'banned' ? `<button class="bg-red-500 text-white font-bold px-3 py-1 rounded shadow hover:bg-red-600" onclick="banStudent('${s._id}')">Ban</button>` : `<button class="bg-gray-300 text-gray-700 font-bold px-3 py-1 rounded shadow cursor-not-allowed" disabled>Banned</button>`}
              </td>
            `;
            studentsTable.appendChild(row);
          });
        }

        // Transactions Table
        const transactionsTable = document.getElementById('transactionsTable');
        transactionsTable.innerHTML = "";
        if (!data.transactions || data.transactions.length === 0) {
          document.getElementById('emptyTxState').classList.remove('hidden');
        } else {
          document.getElementById('emptyTxState').classList.add('hidden');
          data.transactions.forEach(tx => {
            const row = document.createElement('tr');
            row.innerHTML = `
              <td class="py-2 px-4">${new Date(tx.date).toLocaleDateString()}</td>
              <td class="py-2 px-4">${tx.student}</td>
              <td class="py-2 px-4 capitalize">${tx.type}</td>
              <td class="py-2 px-4">${tx.points}</td>
              <td class="py-2 px-4">${formatNaira(tx.points)}</td>
              <td class="py-2 px-4">${tx.reason || ""}</td>
            `;
            transactionsTable.appendChild(row);
          });
        }

        // Withdrawals Table
        const withdrawalsTable = document.getElementById('withdrawalsTable');
        withdrawalsTable.innerHTML = "";
        if (!data.withdrawals || data.withdrawals.length === 0) {
          document.getElementById('emptyWdState').classList.remove('hidden');
        } else {
          document.getElementById('emptyWdState').classList.add('hidden');
          data.withdrawals.forEach(wd => {
            const row = document.createElement('tr');
            row.innerHTML = `
              <td class="py-2 px-4">${new Date(wd.createdAt).toLocaleDateString()}</td>
              <td class="py-2 px-4">${wd.student || "-"}</td>
              <td class="py-2 px-4">${formatNaira(wd.amount)}</td>
              <td class="py-2 px-4">${wd.bank}</td>
              <td class="py-2 px-4">${wd.accountName}</td>
              <td class="py-2 px-4">${wd.accountNumber}</td>
              <td class="py-2 px-4">
                <span class="inline-block px-3 py-1 rounded-full font-semibold ${
                  wd.status === 'approved' ? 'bg-emerald-100 text-emerald-700' :
                  wd.status === 'pending' ? 'bg-yellow-100 text-yellow-700' :
                  'bg-red-100 text-red-700'
                }">${wd.status}</span>
              </td>
              <td class="py-2 px-4">
                ${wd.status === "pending"
                  ? `<button class="bg-emerald-500 text-white font-bold px-3 py-1 rounded shadow hover:bg-emerald-600" onclick="approveWithdrawal('${wd._id}')">Approve</button>
                     <button class="bg-red-500 text-white font-bold px-3 py-1 rounded shadow hover:bg-red-600" onclick="declineWithdrawal('${wd._id}')">Decline</button>`
                  : `<button class="bg-gray-300 text-gray-700 font-bold px-3 py-1 rounded shadow cursor-not-allowed" disabled>Done</button>`
                }
              </td>
            `;
            withdrawalsTable.appendChild(row);
          });
        }
      } catch (e) {
        showToast("Session expired or network error. Please login again.", "error");
        setTimeout(() => {
          localStorage.removeItem('adminToken');
          window.location.href = "admin-login.html";
        }, 1500);
      }
    }

    // Student search
    document.getElementById('searchInput').addEventListener('input', function() {
      const val = this.value.trim().toLowerCase();
      Array.from(document.querySelectorAll('#studentsTable tr')).forEach(tr => {
        const txt = tr.textContent.toLowerCase();
        tr.style.display = txt.includes(val) ? "" : "none";
      });
    });

    // View Profile
    window.viewProfile = async function(id) {
      try {
        const headers = { "Authorization": "Bearer " + token };
        const res = await fetch(`${API_BASE}/api/admin/student/${id}`, { headers });
        if (!res.ok) throw new Error("Failed to fetch profile");
        const user = await res.json();
        alert(`Name: ${user.fullname}\nUsername: ${user.username}\nPoints: ${user.points}\nBank: ${user.bank}\nAccount Name: ${user.accountName}\nAccount Number: ${user.accountNumber}`);
      } catch {
        showToast("Failed to load profile.", "error");
      }
    };

    // Ban Student
    window.banStudent = async function(id) {
      if (!confirm("Are you sure you want to ban this user?")) return;
      try {
        const headers = { "Authorization": "Bearer " + token, "Content-Type": "application/json" };
        const res = await fetch(`${API_BASE}/api/admin/student/${id}/status`, {
          method: "PUT",
          headers,
          body: JSON.stringify({ status: "banned" })
        });
        if (!res.ok) throw new Error("Failed to ban user");
        showToast("Student banned.", "success");
        renderDashboard();
      } catch {
        showToast("Failed to ban user.", "error");
      }
    };

    // Approve Withdrawal
    window.approveWithdrawal = async function(id) {
      if (!confirm("Approve this withdrawal?")) return;
      try {
        const headers = { "Authorization": "Bearer " + token };
        const res = await fetch(`${API_BASE}/api/admin/withdrawal/${id}/approve`, { method: "PUT", headers });
        if (!res.ok) throw new Error("Failed to approve withdrawal");
        showToast("Withdrawal approved.", "success");
        renderDashboard();
      } catch {
        showToast("Failed to approve withdrawal.", "error");
      }
    };
    // Decline Withdrawal
    window.declineWithdrawal = async function(id) {
      if (!confirm("Decline this withdrawal?")) return;
      try {
        const headers = { "Authorization": "Bearer " + token };
        const res = await fetch(`${API_BASE}/api/admin/withdrawal/${id}/decline`, { method: "PUT", headers });
        if (!res.ok) throw new Error("Failed to decline withdrawal");
        showToast("Withdrawal declined.", "success");
        renderDashboard();
      } catch {
        showToast("Failed to decline withdrawal.", "error");
      }
    };

    // Export CSV (simple version)
    function exportTableToCSV(tableId, filename) {
      const rows = Array.from(document.getElementById(tableId).querySelectorAll('tr'));
      const csv = rows.map(row =>
        Array.from(row.children).map(cell => `"${cell.innerText.replace(/"/g, '""')}"`).join(',')
      ).join('\n');
      const blob = new Blob([csv], { type: 'text/csv' });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = filename;
      a.click();
    }
    document.getElementById('exportTx').onclick = () => exportTableToCSV('transactionsTable', 'transactions.csv');
    document.getElementById('exportWd').onclick = () => exportTableToCSV('withdrawalsTable', 'withdrawals.csv');

    // Logout
    document.getElementById('logoutBtn').onclick = function() {
      localStorage.removeItem('adminToken');
      window.location.href = "admin-login.html";
    };

    document.addEventListener("DOMContentLoaded", renderDashboard);
  </script>
</body>
</html>
