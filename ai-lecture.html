<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=0.75">
  <title>Lecture Note| OAU ExamGuard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="icon" href="logo.png">
    <script type='text/javascript' src='//pl27701590.revenuecpmgate.com/99/f1/63/99f16343d25148366fddf2905bfbfbc0.js'></script>
 
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
  <style>
    /* ...[existing styles unchanged]... */
    .reload-btn {
      background: #6366f1;
      color: #fff;
      border: none;
      border-radius: 0.5em;
      padding: 0.6em 1.2em;
      font-weight: bold;
      cursor: pointer;
      box-shadow: 0 2px 7px #6366f133;
      transition: background .15s;
    }
    .reload-btn:hover {
      background: #4338ca;
    }
    /* ---- OAU ExamGuard Lecture Note Page Styles ---- */

/* Outline Chip (sidebar/nav buttons) */
.outline-chip {
  transition: background 0.2s, color 0.2s, box-shadow 0.2s;
  cursor: pointer;
  user-select: none;
}
.outline-chip:hover, .outline-chip.active {
  background: linear-gradient(90deg,#6366f1,#3b82f6);
  color: #fff;
  box-shadow: 0 2px 8px #6366f133;
}

/* Section Title */
.section-title {
  font-size: 1.15rem;
  font-weight: 700;
  color: #312e81;
  background: linear-gradient(90deg,#e0e7ff 60%,#fff 100%);
  border-left: 5px solid #6366f1;
  border-radius: 0.5rem 0 0 0.5rem;
  padding: 0.6em 1em 0.6em 1.2em;
  margin: 2.2em 0 1.1em 0;
  box-shadow: 0 1px 6px #6366f124;
  letter-spacing: 0.01em;
}

/* Lecture Note Content */
.note-content {
  font-size: 1.0rem;
  line-height: 1.8;
  color: #1e293b;
  background: #f1f5fd;
  border-radius: 0.7em;
  margin-bottom: 1.6em;
  padding: 1.2em 1.5em 1.2em 1.5em;
  box-shadow: 0 1px 7px #6366f111;
}

/* Introduction Section */
.intro-section {
  background: #eef2ff;
  border-left: 4px solid #6366f1;
  border-radius: 0.8em;
  padding: 1.2em 1.5em;
  margin: 1.1em 0 2.2em 0;
  font-size: 1.13rem;
  color: #3730a3;
  box-shadow: 0 1px 6px #6366f133;
}

/* Main Container */
.main-container {
  max-width: 900px;
  margin: 0 auto;
  transition: background 0.4s;
}

/* Fade In Animation */
.fade-in {
  animation: fadeIn 0.7s ease;
}
@keyframes fadeIn {
  from { opacity: 0; transform: translateY(30px);}
  to { opacity: 1; transform: translateY(0);}
}

/* Responsive */
@media (max-width:600px){
  .main-container{padding:0.7em;}
  .note-content,.section-title,.intro-section{padding-left:0.8em;padding-right:0.8em;}
  #outlinesSidebar {display:none;}
  #outlinesNav {flex-direction: row!important; overflow-x: auto;}
}

/* Dark Mode Styles */
.darkmode .main-container, .darkmode body {
  background: #020617 !important;
}
.darkmode .section-title {
  color: #f1f5fd;
  background: linear-gradient(90deg,#3730a3 60%,#020617 100%);
  border-left: 5px solid #818cf8;
  box-shadow: 0 1px 8px #6366f133;
}
.darkmode .note-content {
  background: #181f38;
  color: #e0e7ff;
}
.darkmode .intro-section {
  background: #181f38;
  color: #a5b4fc;
  border-left: 4px solid #818cf8;
}
.darkmode .outline-chip {
  background: #181f38 !important; color: #94a3b8 !important;
}
.darkmode .outline-chip.active, .darkmode .outline-chip:hover {
  background: linear-gradient(90deg,#6366f1,#3b82f6)!important; color:#fff!important;
}
.darkmode .flashcard {
  background: #232956;
  color: #f1f5fd;
}

/* Flashcard Styles */
.flashcard {
  background: #fff;
  border: 1px solid #e0e7ff;
  border-radius: 0.7em;
  padding: 1em 1.2em;
  box-shadow: 0 1px 6px #6366f133;
  font-weight: 600;
  color: #312e81;
  cursor: pointer;
  transition: background 0.15s;
}
.flashcard:hover {
  background: #f1f5fd;
}
.flashcard:focus {
  outline: 2px solid #6366f1;
}

/* Collapsible Section */
.collapsible-content {display:none;}
.collapsible.open .collapsible-content {display:block;}
.collapsible-toggle {
  cursor:pointer; transition: background 0.2s;
}
.collapsible-toggle:hover {background: #e0e7ff;}
.darkmode .collapsible-toggle:hover {background: #232956;}

/* Progress Bar */
.progress-bar-bg {background: #e0e7ff;}
.progress-bar-fg {background: linear-gradient(90deg,#6366f1,#0ea5e9);}
.darkmode .progress-bar-bg {background:#232956;}
.darkmode .progress-bar-fg {background: linear-gradient(90deg,#818cf8,#38bdf8);}

/* Reload Button (Error state) */
.reload-btn {
  background: #6366f1;
  color: #fff;
  border: none;
  border-radius: 0.5em;
  padding: 0.6em 1.2em;
  font-weight: bold;
  cursor: pointer;
  box-shadow: 0 2px 7px #6366f133;
  transition: background .15s;
}
.reload-btn:hover {
  background: #4338ca;
}
  </style>
</head>
<body class="bg-gradient-to-br from-indigo-50 to-white min-h-screen font-sans transition-colors">
  <!-- HERO -->
  <header class="bg-white shadow-lg sticky top-0 z-30 transition-colors">
    <div class="main-container flex items-center gap-6 py-5">
      <a href="student-dashoards.html#study-resources" class="text-indigo-600 text-lg hover:underline flex items-center gap-2 font-semibold">
        <i class="fas fa-arrow-left"></i> Back
      </a>
      <div class="flex-1 text-center">
        <h1 id="topicTitle" class="text-3xl md:text-4xl font-extrabold text-indigo-900 tracking-tight drop-shadow-lg mb-1"></h1>
        <div class="inline-block bg-gradient-to-r from-indigo-100 via-blue-100 to-indigo-50 px-5 py-2 rounded-lg shadow text-indigo-800 font-bold text-base" id="topicLabel"></div>
      </div>
      <button id="darkModeBtn" class="text-indigo-700 border border-indigo-300 rounded-full px-3 py-2 font-bold focus:ring-2 focus:ring-indigo-400 transition hover:bg-indigo-50" title="Dark Mode"><i class="fas fa-moon"></i></button>
    </div>
    <div class="main-container flex justify-between items-center pb-3">
      <div class="hidden md:flex flex-col w-1/5 pr-4" id="outlinesSidebar"></div>
      <div class="flex-1">
        <div class="w-full h-2 rounded-full progress-bar-bg mb-2 overflow-hidden">
          <div id="progressBar" class="progress-bar-fg h-full rounded-full" style="width:0%"></div>
        </div>
      </div>
      <div style="width:2em;"></div>
    </div>
  </header>
  <main class="main-container fade-in py-3 px-2 flex gap-8">
    <!-- Desktop Outlines Sidebar -->
    <nav id="outlinesSidebar" class="hidden md:flex flex-col gap-3 sticky top-32 h-fit min-w-[180px]"></nav>
    <!-- Main Content -->
    <div class="flex-1">
      <!-- Mobile Outlines -->
      <nav id="outlinesNav" class="flex flex-wrap gap-3 mb-8 md:hidden"></nav>
      <!-- Introduction -->
      <section id="introduction" class="intro-section flex items-start gap-4" style="display:none;">
        <div class="flex-shrink-0 text-4xl text-indigo-500"><i class="fas fa-lightbulb"></i></div>
        <div>
          <div id="introductionText"></div>
          <div id="introQuote" class="mt-3 italic text-indigo-800 text-base"></div>
        </div>
      </section>
      <!-- Flashcards Section -->
      <section id="flashcardsSection" class="mb-8" style="display:none;">
        <div class="font-bold text-indigo-900 mb-2">Quick Flashcards</div>
        <div id="flashcards" class="flex flex-wrap gap-3"></div>
      </section>
      <!-- Notes rendered here -->
      <div id="notesContent"></div>
      <!-- Summary, Exam Tips -->
      <section class="border-t pt-5 mt-10" style="display:none;" id="summaryContainer">
        <div class="font-bold text-indigo-900 text-xl mb-2">Summary & Smart Exam Tips</div>
        <div class="note-content mb-3" id="summarySection"></div>
        <div class="bg-indigo-100 border-l-4 border-indigo-400 rounded-lg p-4 text-indigo-900 shadow mb-8" id="examTips"></div>
      </section>
      <!-- Action Bar -->
            <div class="flex flex-wrap gap-3 justify-end items-center mb-10 mt-6">
        <button onclick="window.print()" class="px-5 py-2 bg-indigo-500 text-white rounded shadow hover:bg-indigo-700 font-bold"><i class="fas fa-print mr-2"></i>Print</button>
        <button id="downloadBtn" class="px-5 py-2 bg-emerald-500 text-white rounded shadow hover:bg-emerald-700 font-bold"><i class="fas fa-download mr-2"></i>Download PDF</button>
        <button id="askMoreBtn" class="px-5 py-2 bg-blue-100 text-blue-800 rounded shadow hover:bg-blue-200 font-bold"><i class="fas fa-comments mr-2"></i>Ask More</button>
        <!-- SAVE BUTTON ADDED -->
        <button id="saveLectureBtn" class="px-5 py-2 bg-purple-600 text-white rounded shadow hover:bg-purple-700 font-bold"><i class="fas fa-save mr-2"></i>Save</button>
            </div>
      <div id="loadingState" class="flex flex-col items-center justify-center my-12 text-indigo-600 text-xl font-bold">
        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-600 mb-4"></div>
        Generating your detailed lecture note...
      </div>
      <div id="errorState" class="my-10 text-red-600 text-lg font-bold hidden text-center flex flex-col items-center">
        <!-- Error message displayed here -->
        <span id="errorMessage"></span>
        <button id="reloadBtn" class="reload-btn mt-4" style="display:none;"><i class="fas fa-rotate-right mr-2"></i>Try Again</button>
      </div>
    </div>
  </main>
  <footer class="main-container text-center text-gray-400 py-7 mt-12 text-sm">
    <hr class="mb-4">
    OAU ExamGuard AI Study Assistant &copy; 2025. For University Students.
  </footer>
  <script>
    // -------- GEMINI API SETUP --------
  
    // --------- TOPIC FETCH ---------
    const params = new URLSearchParams(window.location.search);
    const topic = params.get("topic") || "Sample Topic";
    document.getElementById("topicTitle").textContent = topic;
    document.getElementById("topicLabel").textContent = "Lecture Note";

    const SYSTEM_PROMPT = `
You are an expert and professional university lecturer and instructional designer.  
Generate a comprehensive, well-formatted lecture note for the given topic, tailored for university students preparing for standard examination boards worldwide. The note must provide clear explanations, intelligent reasoning, logical breakdowns, and practical, good examples for all key concepts. It should be well-organized, detailed, and universally accessible to students in any country and any level.
You must sound completely humanly and a passionate one, good at teaching and using accurate materials for teaching. 
you are the best at your field.
Your response must be a single valid JSON object, with no code block markers or commentary. Use this structure:
{
  "outlines": [ "Section 1 Title", "Section 2 Title", ... ],
  "introduction": "An engaging, clear introduction (80-150 words) that motivates students and previews the topic.",
  "introQuote": "A relevant, inspiring quote for students, if available.",
  "notes": {
    "Section 1 Title": "<detailed, logically organized content with explanatory paragraphs, breakdowns, sub-lists, and at least one smart, illustrative example per section. Each section must be at least 250 words. Provide notes that could probably not be found on the net and explain clearly to an average student.>",
    ... 
  },
  "flashcards": [
    {"term": "Key Term", "def": "Simple definition"},
    ...
  ] (5-10 items),
  "summary": "A clear, concise summary of the topic (about 80-120 words) highlighting the most important insights.",
  "examTips": [
    "Exam tip 1",
    "Exam tip 2",
    ...
  ] (4-7 items, focused on answering university exam questions effectively),
  "likelyExamQuestions": [
    "Likely exam question 1",
    "Likely exam question 2",
    ...
  ] (5-7 items, covering a range of cognitive levels such as explain, describe, compare, analyze, apply, evaluate)
}
Instructions:
- Structure the outlines to cover the topic logically from foundational concepts to advanced ideas, ensuring each section is detailed and well-explained.
- For each outline section, write a detailed, easy-to-read note in good English so that any university student can understand. Use clear explanations, stepwise breakdowns, and practical examples that are common and relatable.
- Use HTML formatting for subscripts, superscripts, highlights, formulas and others(e.g., headings, <ul>, <ol>, <b>, etc.) where appropriate for readability.
- Avoid using terms that makes sound robotic such as "In conclusion...", "Delve into...", "Understanding...", "Fascinating..." and the likes.
- Try as much as possible to be humanly and use common human terms and not regular AI terms.
- Search widely, use deep thinking and possible online resources to cover every major aspects of the topic and if possible, generate images.
- Do NOT mention that the lecture is AI-generated and ensure to give humanized lectures.
- The introduction and summary must be clear, friendly, and professional.
- At the end, provide 5-7 likely exam questions that test both basic understanding and higher-order thinking skills.
- The response must be valid JSON only. Do not add commentary or code block markers. The only output should be the JSON object.
Topic: ${topic}
`;

    // --------------- GEMINI FUNCTION ---------------
    async function fetchGeminiLecture(topic) {
  const resp = await fetch('https://examguard-jmvj.onrender.com/api/ai-lecture', {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ topic })
  });
  if (!resp.ok) throw new Error("Failed to contact AI backend");
  const data = await resp.json();
  if (!data.response) throw new Error("No valid response from AI backend");
  let text = data.response.trim();
  if (text.startsWith("```json")) text = text.replace(/^```json\s*/,"").replace(/```$/,"");
  if (text.startsWith("{") && text.endsWith("}")) return JSON.parse(text);
  try { return JSON.parse(text); } catch (e) {
    const jsonMatch = text.match(/\{[\s\S]*\}/);
    if (jsonMatch) return JSON.parse(jsonMatch[0]);
    throw new Error("Could not parse AI backend response as JSON");
  }
}

    // --------- RENDERING LOGIC -----------
    function renderLecture(data) {
      window._lastLectureData = data;
      document.getElementById("loadingState").style.display = "none";
      document.getElementById("errorState").classList.add("hidden");
      document.getElementById("reloadBtn").style.display = "none";
      // Outlines Sidebar & Nav
      function renderOutlines() {
        const outlinesSidebar = document.getElementById("outlinesSidebar");
        const outlinesNav = document.getElementById("outlinesNav");
        outlinesSidebar.innerHTML = "";
        outlinesNav.innerHTML = "";
        data.outlines.forEach((outline, idx) => {
          // Sidebar (desktop)
          let sideBtn = document.createElement("button");
          sideBtn.className = "outline-chip w-full px-4 py-3 mb-1 rounded-xl text-indigo-700 bg-indigo-50 font-semibold border-none shadow hover:shadow-lg transition-all text-left";
          sideBtn.innerHTML = `<i class="fas fa-circle-dot text-xs mr-2 text-indigo-400"></i> ${outline}`;
          sideBtn.onclick = () => {
            document.getElementById("section-" + idx).scrollIntoView({behavior:'smooth',block:'start'});
            document.querySelectorAll('#outlinesSidebar .outline-chip').forEach(c=>c.classList.remove('active'));
            sideBtn.classList.add('active');
            setTimeout(()=>sideBtn.classList.remove('active'),1200);
          }
          outlinesSidebar.appendChild(sideBtn);
          // Mobile
          let mobBtn = document.createElement("button");
          mobBtn.className = "outline-chip px-4 py-2 rounded-xl text-indigo-700 bg-indigo-100 font-semibold border-none shadow hover:bg-indigo-50 transition-all";
          mobBtn.innerHTML = `<i class="fas fa-circle-dot text-xs mr-2 text-indigo-400"></i> ${outline}`;
          mobBtn.onclick = () => {
            document.getElementById("section-" + idx).scrollIntoView({behavior:'smooth',block:'start'});
            document.querySelectorAll('#outlinesNav .outline-chip').forEach(c=>c.classList.remove('active'));
            mobBtn.classList.add('active');
            setTimeout(()=>mobBtn.classList.remove('active'),1200);
          }
          outlinesNav.appendChild(mobBtn);
        });
        outlinesSidebar.classList.remove('hidden');
      }
      renderOutlines();

      // Introduction
      document.getElementById("introduction").style.display = "flex";
      document.getElementById("introductionText").textContent = data.introduction;
      document.getElementById("introQuote").textContent = data.introQuote || "";

      // Flashcards
      if (data.flashcards && data.flashcards.length) {
        document.getElementById("flashcardsSection").style.display = "";
        const flashcardsDiv = document.getElementById("flashcards");
        flashcardsDiv.innerHTML = "";
        data.flashcards.forEach(card=>{
          let div = document.createElement("div");
          div.className = "flashcard bg-white border border-indigo-200 rounded-lg px-4 py-3 shadow font-semibold text-indigo-900 cursor-pointer transition hover:bg-indigo-50";
          div.tabIndex = 0;
          div.innerHTML = `<span>${card.term}</span>
            <div class="hidden mt-2 text-indigo-600 text-base">${card.def}</div>`;
          div.onclick = () => {
            let def = div.querySelector("div");
            def.classList.toggle("hidden");
          };
          div.onkeydown = (e) => {
            if(e.key==="Enter"||e.key===" "){div.click();}
          };
          flashcardsDiv.appendChild(div);
        });
      } else {
        document.getElementById("flashcardsSection").style.display = "none";
      }

      // Notes
      const notesDiv = document.getElementById("notesContent");
      notesDiv.innerHTML = "";
      data.outlines.forEach((outline, idx) => {
        // Section Title + Collapsible
        const section = document.createElement("section");
        section.id = "section-" + idx;
        section.className = "mb-9 collapsible";
        let isOpen = idx === 0; // first is open by default
        section.innerHTML = `
          <div class="section-title collapsible-toggle flex items-center justify-between cursor-pointer select-none ${isOpen?'bg-indigo-100':''}">
            <span>${outline}</span>
            <i class="fas fa-chevron-${isOpen?'down':'right'} text-indigo-400 transition"></i>
          </div>
          <div class="collapsible-content note-content"${isOpen?' style="display:block"':''}>${data.notes[outline]}</div>
        `;
        notesDiv.appendChild(section);
      });
      // Collapsible logic
      document.querySelectorAll('.collapsible-toggle').forEach((toggle, idx) => {
        toggle.onclick = () => {
          const section = toggle.parentElement;
          const content = section.querySelector('.collapsible-content');
          const icon = toggle.querySelector('i');
          if (content.style.display === "block") {
            content.style.display = "none";
            icon.classList.replace('fa-chevron-down','fa-chevron-right');
          } else {
            content.style.display = "block";
            icon.classList.replace('fa-chevron-right','fa-chevron-down');
          }
        };
      });

      // Summary & Exam Tips
      if (data.summary || (data.examTips && data.examTips.length)) {
        document.getElementById("summaryContainer").style.display = "";
        document.getElementById("summarySection").textContent = data.summary || "";
        document.getElementById("examTips").innerHTML = (data.examTips||[]).map(tip=>`<li class="mb-1">${tip}</li>`).join('');
      } else {
        document.getElementById("summaryContainer").style.display = "none";
      }
    }

    // ---------- ERROR HANDLER -----------
    function showError(msg) {
      document.getElementById("loadingState").style.display = "none";
      const err = document.getElementById("errorState");
      document.getElementById("errorMessage").textContent = msg;
      err.classList.remove("hidden");
      document.getElementById("reloadBtn").style.display = "inline-block";
    }

    // ----------- INIT -----------
    async function initLecture(isReload=false) {
      // Hide error and reload button
      document.getElementById("errorState").classList.add("hidden");
      document.getElementById("reloadBtn").style.display = "none";
      document.getElementById("loadingState").style.display = "flex";
      // Clear previous notes to prevent confusion
      document.getElementById("notesContent").innerHTML = "";
      document.getElementById("introduction").style.display = "none";
      document.getElementById("flashcardsSection").style.display = "none";
      document.getElementById("summaryContainer").style.display = "none";
      try {
        const data = await fetchGeminiLecture(topic);
        renderLecture(data);
      } catch (e) {
        showError("Sorry, we couldn't generate your lecture at the moment. Please try again by clicking below. If the issue persists, check your internet connection or try later.");
        console.error(e);
      }
    }
    window.addEventListener('DOMContentLoaded', () => initLecture());

    // --- Progress Bar: Track scroll ---
    function updateProgressBar() {
      const main = document.querySelector('main');
      const scrollY = window.scrollY;
      const total = document.body.scrollHeight - window.innerHeight;
      let percent = Math.min(100, Math.round((scrollY / total) * 100));
      document.getElementById("progressBar").style.width = percent + "%";
    }
    window.addEventListener('scroll', updateProgressBar);

    // --- Download PDF (simple, for demo) ---
    document.getElementById("downloadBtn").onclick = function() {
      window.print();
    };

    // --- Ask More (open Google search for now) ---
    document.getElementById("askMoreBtn").onclick = function() {
      const q = encodeURIComponent(topic + " lecture Note");
      window.open("https://www.google.com/search?q=" + q, "_blank");
    };

    // --- Dark Mode Toggle ---
    document.getElementById("darkModeBtn").onclick = function() {
      document.body.classList.toggle("darkmode");
      document.querySelector("header").classList.toggle("bg-gray-900");
      document.querySelector("header").classList.toggle("bg-white");
    };

    // --- Reload Button Logic ---
    document.getElementById("reloadBtn").onclick = function() {
      initLecture(true);
    };

        // --- SAVE BUTTON LOGIC ---
    function getFormattedDateTime() {
      const now = new Date();
      const date = now.toLocaleDateString();
      const time = now.toLocaleTimeString();
      return { date, time };
    }

    document.getElementById("saveLectureBtn").onclick = function() {
      const topic = document.getElementById("topicTitle").textContent || "";
      const { date, time } = getFormattedDateTime();
      let lectureData = window._lastLectureData || null;
      if (!lectureData) {
        alert("No lecture content to save!");
        return;
      }
      const record = {
        topic,
        date,
        time,
        lecture: lectureData
      };
      const key = "savedLectures";
      let saved = [];
      try {
        saved = JSON.parse(localStorage.getItem(key)) || [];
      } catch {
        saved = [];
      }
      saved.push(record);
      localStorage.setItem(key, JSON.stringify(saved));
      alert("Lecture saved successfully!");
    };
  </script>
</body>
</html>
