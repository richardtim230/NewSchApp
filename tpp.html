<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <title>Exam In Session</title>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/flowbite/2.2.1/flowbite.min.css" rel="stylesheet"/>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
  <style>
    body { font-family: 'Poppins', sans-serif; }
    .option-selected { border: 2px solid #2563EB !important; background: #DBEAFE !important; }
    .focus-ring:focus { outline: 2px solid #2563EB; outline-offset: 2px; }
    .floating-footer { box-shadow: 0 6px 32px 0 rgba(30,41,59,0.07), 0 1.5px 4px 0 rgba(0,0,0,0.03); }
    .mathjax { font-size: 1.12em; }
    .card { transition: box-shadow 0.18s; }
    .card:hover { box-shadow: 0 10px 16px rgba(79,70,229,0.14); }
    @media (min-width: 900px) {
      .main-content-flex { flex-direction: row; align-items: flex-start; }
      .sidebar { min-width: 320px; max-width: 350px; margin-right: 2rem; }
      .exam-section { flex: 1 1 0; }
    }
    @media (max-width: 900px) {
      .main-content-flex { flex-direction: column; }
      .sidebar { width: 100%; max-width: 100%; margin-bottom: 2rem; }
      .exam-section { width: 100%; }
    }
    .feedback-outer {
      background: linear-gradient(135deg, #eef2ff 0%, #dbeafe 100%);
      border-radius: 1.5rem;
      box-shadow: 0 4px 32px rgba(79,70,229,0.09);
      padding: 2.5rem 2rem 2rem 2rem;
      max-width: 480px;
      margin: 2rem auto 1.5rem auto;
      display: flex;
      flex-direction: column;
      align-items: center;
      border: 2px solid #c7d2fe;
    }
    .feedback-score {
      font-size: 2.7rem;
      font-weight: 800;
      background: linear-gradient(90deg, #2563eb, #818cf8);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      text-fill-color: transparent;
      margin-bottom: 0.6rem;
    }
    .feedback-badge {
      font-size: 1.18rem;
      font-weight: 600;
      padding: 0.4em 1.2em;
      border-radius: 9999px;
      background: #d1fae5;
      color: #047857;
      margin-bottom: 1.3rem;
      box-shadow: 0 2px 6px rgba(16,185,129,0.08);
    }
    .feedback-list {
      margin-top: 1.2rem;
      margin-bottom: 0.5rem;
      text-align: left;
      color: #374151;
      font-size: 1.05rem;
      padding-left: 1.5rem;
    }
    .feedback-title {
      font-size: 1.25rem;
      font-weight: 700;
      color: #6366f1;
      margin-bottom: 0.36em;
      letter-spacing: 1px;
      text-align: center;
    }
    .feedback-success {
      background: #d1fae5;
      color: #065f46;
    }
    .feedback-fail {
      background: #fef2f2;
      color: #b91c1c;
    }
  </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-white min-h-screen flex flex-col">

  <!-- TOP BAR -->
  <header class="sticky top-0 z-40 w-full bg-white/90 backdrop-blur shadow flex flex-col md:flex-row md:items-center md:justify-between px-4 py-3">
    <div class="flex items-center gap-3">
      <img id="userAvatar" src="https://i.pravatar.cc/56" class="w-12 h-12 rounded-full border-2 border-blue-500 shadow" alt="User profile">
      <div>
        <div id="userFullname" class="font-semibold text-gray-800">Student</div>
        <div id="userMeta" class="text-xs text-gray-500"></div>
      </div>
    </div>
    <div class="flex-1 flex flex-col items-center py-2">
      <div id="examTitle" class="text-lg font-bold text-blue-700">Exam Session</div>
      <div id="examMeta" class="text-xs text-gray-500 mt-1"></div>
    </div>
    <div class="flex flex-col items-end gap-1">
      <div class="flex items-center gap-2">
        <span class="text-xs text-gray-500">Time Left:</span>
        <span id="timer" class="font-mono text-base font-bold text-red-600">--:--:--</span>
        <span class="rounded bg-green-100 text-green-700 text-xs px-2 py-0.5 ml-2" id="autoSave">Auto-saved</span>
      </div>
      <div class="flex items-center gap-2 mt-1">
        <div class="w-36 bg-gray-200 rounded-full h-2" aria-label="progress bar" role="progressbar">
          <div id="progressBar" class="bg-blue-500 h-2 rounded-full" style="width: 0%"></div>
        </div>
        <span class="text-xs text-gray-500 ml-1"><span id="answeredCount">0</span>/<span id="totalQuestions">0</span></span>
      </div>
    </div>
  </header>

  <main class="container mx-auto flex main-content-flex justify-center px-2 py-6 gap-4">

    <!-- SIDEBAR: Configuration -->
    <section class="sidebar card bg-white rounded-2xl shadow-xl p-6 md:p-8 border border-blue-100 mb-6">
      <h3 class="text-xl font-semibold text-indigo-900 mb-2">Configure Your Practice Session</h3>
      <form id="practice-config-form" class="practice-form grid grid-cols-1 gap-3">
        <div>
          <label for="subject" class="text-sm font-medium text-gray-700">Subject</label>
          <select id="subject" name="subject" required class="mt-1 block w-full p-2 border border-gray-300 rounded-lg">
            <option value="">Select Subject</option>
            <option value="Mathematics">Mathematics</option>
            <option value="Physics">Physics</option>
            <option value="Chemistry">Chemistry</option>
            <option value="Biology">Biology</option>
            <option value="Computer Science">Computer Science</option>
          </select>
        </div>
        <div>
          <label for="courseCode" class="text-sm font-medium text-gray-700">Course Code</label>
          <select id="courseCode" name="courseCode" required class="mt-1 block w-full p-2 border border-gray-300 rounded-lg">
            <option value="">Select Course Code</option>
          </select>
        </div>
        <div>
          <label for="year" class="text-sm font-medium text-gray-700">Year</label>
          <select id="year" name="year" required class="mt-1 block w-full p-2 border border-gray-300 rounded-lg">
            <option value="2024-2025">2024-2025</option>
          <option value="2023-2024">2023-2024</option>
          <option value="2022-2023">2022-2023</option>
        <option value="2021-2022">2021-2022</option>
          <option value="2020-2021">2020-2021</option>
          <option value="2019-2020">2019-2020</option>
          <option value="2018-2019">2018-2019</option>
          <option value="2017-2018">2017-2018</option>
        </select>
        </div>
        <div>
          <label for="questions" class="text-sm font-medium text-gray-700">Total Questions</label>
          <select id="questions" name="count" required class="mt-1 block w-full p-2 border border-gray-300 rounded-lg">
            <option value="">Select Number of Questions</option>
            <option value="10">10</option>
            <option value="20">20</option>
            <option value="30">30</option>
            <option value="40">40</option>
            <option value="50">50</option>
          </select>
        </div>
        <div>
          <label for="time" class="text-sm font-medium text-gray-700">Time (Minutes)</label>
          <select id="time" name="time" required class="mt-1 block w-full p-2 border border-gray-300 rounded-lg">
            <option value="">Select Time</option>
            <option value="30">30</option>
            <option value="40">40</option>
            <option value="60">60</option>
            <option value="90">90</option>
            <option value="120">120</option>
          </select>
        </div>
        <div>
          <label for="topic" class="text-sm font-medium text-gray-700">Topic (optional)</label>
          <input id="topic" name="topic" type="text" class="mt-1 block w-full p-2 border border-gray-300 rounded-lg" placeholder="e.g., Algebra">
        </div>
        <button type="submit" class="mt-4 px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 glow-button w-full font-semibold">
          Start Practice
        </button>
      </form>
    </section>

    <!-- EXAM CONTENT -->
    <section class="exam-section w-full flex flex-col items-center">
      <div class="w-full max-w-2xl bg-white rounded-2xl shadow-xl p-6 md:p-8 border border-blue-100" id="examCard" aria-live="polite">

        <div class="flex items-center justify-between mb-4">
          <div class="flex items-center gap-2">
            <span class="text-base font-bold text-blue-600 bg-blue-100 px-3 py-1 rounded-full shadow" id="questionNumberTitle">
              Q --/--
            </span>
            <span id="displayCourseCode" class="ml-2 text-md rounded px-2 py-1 bg-indigo-50 text-indigo-700 font-semibold"></span>
            <button onclick="flagQuestion()" id="flagBtn" aria-pressed="false" aria-label="Flag question"
              class="ml-2 flex items-center gap-1 px-2 py-0.5 rounded text-xs border border-yellow-400 bg-yellow-50 text-yellow-700 hover:bg-yellow-100 focus-ring">
              <svg class="w-4 h-4 inline" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M4 4v16M4 4h16l-2.5 5 2.5 5H4" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
              Flag
            </button>
          </div>
          <span id="statusBadge" class="px-2 py-0.5 text-xs rounded bg-gray-100 text-gray-600">Not Answered</span>
        </div>

        <!-- Question Navigation Grid (inline, accessible) -->
        <nav aria-label="Question navigation" class="mb-4 flex flex-wrap gap-2 justify-center">
          <div id="questionNavGrid" class="flex flex-wrap gap-2"></div>
        </nav>

        <!-- Question Image (if present) -->
        <div id="questionImageContainer" class="mb-2" style="display:none;">
          <img id="questionImage" alt="Question illustration" class="rounded-lg mx-auto max-h-52"/>
        </div>
        <!-- Question Text (supports math) -->
        <h2 id="questionText" class="text-lg font-semibold mb-3 text-gray-900 mathjax"></h2>
        <!-- Options -->
        <form id="optionsForm" class="grid gap-3" aria-labelledby="questionText"></form>

        <!-- Save, Next, Skip -->
        <div class="flex justify-between items-center mt-6 gap-2">
          <button onclick="skipQuestion()" id="skipBtn" class="py-2 px-4 rounded-lg bg-yellow-50 text-yellow-700 border border-yellow-300 hover:bg-yellow-100 font-semibold transition focus-ring" type="button" accesskey="k">Skip (K)</button>
          <button onclick="saveAnswer()" id="saveNextBtn" class="py-2 px-6 rounded-lg bg-blue-600 hover:bg-blue-700 text-white font-semibold shadow transition focus-ring" type="button" accesskey="n">Save &amp; Next (N)</button>
        </div>
      </div>
      <div id="feedbackBox" style="display:none;"></div>
    </section>
  </main>

  <!-- FOOTER NAVIGATION -->
  <footer class="sticky bottom-0 w-full z-50 flex justify-center" aria-label="Exam navigation">
    <div class="floating-footer bg-white/95 border-t border-blue-100 rounded-t-2xl shadow-lg max-w-3xl w-full mx-auto px-3 py-2 flex items-center justify-between gap-2">
      <button onclick="prevQuestion()" id="prevBtn" class="flex flex-col items-center text-gray-600 hover:text-blue-600 transition focus-ring" aria-label="Previous question" accesskey="p">
        <svg class="w-6 h-6 mb-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M15 19l-7-7 7-7" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
        <span class="text-xs">Prev (P)</span>
      </button>
      <button onclick="nextQuestion()" id="nextBtn" class="flex flex-col items-center text-gray-600 hover:text-blue-600 transition focus-ring" aria-label="Next question" accesskey="x">
        <svg class="w-6 h-6 mb-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M9 5l7 7-7 7" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
        <span class="text-xs">Next (X)</span>
      </button>
      <button onclick="submitExam()" id="submitBtn" class="py-2 px-6 rounded-lg bg-green-600 hover:bg-green-700 text-white font-bold shadow-md transition focus-ring" aria-label="Submit exam">Submit</button>
    </div>
  </footer>

  <script>
  // ====== CONFIG ======
  const API_BASE = "https://examguide.onrender.com/api";
  const USER_API = API_BASE + "/auth/me";
  const ANSWER_API = API_BASE + "/past-questions/save-answers";
  const SUBMIT_API = API_BASE + "/past-questions/submit";
  let token = localStorage.getItem("token") || "";

  // ====== COURSE CODES MAP ======
  const courseCodes = {
    "Mathematics": ["MTH101", "MTH102", "MTH105", "MTH201", "MTH202"],
    "Physics": ["PHY101", "PHY102", "PHY201", "PHY202", "PHY205"],
    "Chemistry": ["CHM101", "CHM102", "CHM201", "CHM202"],
    "Biology": ["BIO101", "BIO102", "BIO201", "BIO202"],
    "Computer Science": ["CSC101", "CSC102", "CSC201", "CSC202"]
  };

  // ====== USER/EXAM METADATA ======
  let user = { fullname: "Student", regNo: "", profilePic: "https://i.pravatar.cc/56", class: "" };
  let exam = { subject: "Mathematics", year: "2024", courseCode: "MTH101", title: "Mathematics Practice", duration: 40*60, topic: "" };
  let config = {};

  // ====== STATE ======
  let questions = [];
  let answers = {};
  let flags = {};
  let currentQuestion = 0;
  let timer = exam.duration;
  let timerInterval;
  let autosaveTimeout;
  let startTime = 0;
  let submitted = false;

  // ====== CONFIG FORM LOGIC ======
  document.getElementById("subject").addEventListener("change", function() {
    const subject = this.value;
    const codeSelect = document.getElementById("courseCode");
    codeSelect.innerHTML = `<option value="">Select Course Code</option>`;
    if (subject && courseCodes[subject]) {
      courseCodes[subject].forEach(code => {
        codeSelect.innerHTML += `<option value="${code}">${code}</option>`;
      });
      codeSelect.disabled = false;
    } else {
      codeSelect.disabled = true;
    }
  });

  document.getElementById("practice-config-form").onsubmit = function(e) {
    e.preventDefault();
    const subject = document.getElementById("subject").value;
    const courseCode = document.getElementById("courseCode").value;
    const year = document.getElementById("year").value;
    const count = document.getElementById("questions").value;
    const time = document.getElementById("time").value;
    const topic = document.getElementById("topic").value;
    if (!subject || !courseCode || !year || !count || !time) {
      alert("Please fill out all required fields.");
      return;
    }
    const cfg = { subject, courseCode, year, count, time, topic };
    localStorage.setItem("tppConfig", JSON.stringify(cfg));
    window.location.reload();
  };

  // ====== INIT ======
  let examInSession = false;
  window.onload = async function() {
    parseConfig();
    await fetchUser();
    await fetchQuestions();
    startTime = Date.now();
    updateTimer();
    timerInterval = setInterval(() => {
      if (!examInSession) return;
      timer--;
      updateTimer();
      if (timer <= 0) submitExam();
    }, 1000);
    setFooterState();
  };

  function parseConfig() {
    if (localStorage.getItem('tppConfig')) {
      config = JSON.parse(localStorage.getItem('tppConfig'));
    }
    examInSession = !!(config.subject && config.year && config.courseCode);
    if (!examInSession) {
      document.getElementById('examCard').innerHTML = "<div class='text-gray-500 text-center py-14 text-lg'>No practice session is active.<br>Select your configuration on the left and click <b>Start Practice</b> to begin.</div>";
      document.getElementById('timer').textContent = "--:--:--";
      setFooterState();
      return;
    }
    exam.subject = config.subject;
    exam.year = config.year;
    exam.courseCode = config.courseCode;
    exam.title = `${config.subject} Practice`;
    exam.duration = (parseInt(config.time, 10) || 40) * 60;
    exam.topic = config.topic || "";
    timer = exam.duration;

    document.getElementById("subject").value = config.subject;
    document.getElementById("subject").dispatchEvent(new Event("change"));
    document.getElementById("courseCode").value = config.courseCode;
    document.getElementById("year").value = config.year;
    document.getElementById("questions").value = config.count;
    document.getElementById("time").value = config.time;
    document.getElementById("topic").value = config.topic || "";

    document.getElementById('examTitle').textContent = exam.title;
    document.getElementById('examMeta').textContent = `Subject: ${exam.subject} â€¢ Year: ${exam.year} â€¢ Code: ${exam.courseCode}`;
    document.getElementById("displayCourseCode").textContent = exam.courseCode;
  }

  function setFooterState() {
    const disabled = !examInSession || submitted;
    document.getElementById("prevBtn").disabled = disabled;
    document.getElementById("nextBtn").disabled = disabled;
    document.getElementById("submitBtn").disabled = disabled;
    document.getElementById("saveNextBtn").disabled = disabled;
    document.getElementById("skipBtn").disabled = disabled;
    document.getElementById("questionNavGrid").querySelectorAll?.("button").forEach(btn => btn.disabled = disabled);
    document.getElementById("timer").style.opacity = disabled ? "0.5" : "1";
  }

  async function fetchUser() {
    try {
      if (!token) throw new Error("No token");
      const resp = await fetch(USER_API, { headers: { "Authorization": "Bearer " + token } });
      if (!resp.ok) throw new Error("Failed to fetch user.");
      const data = await resp.json();
      user = {
        fullname: data.user?.fullname || data.user?.username || "Student",
        regNo: data.user?.studentId || "",
        profilePic: data.user?.profilePic || "https://i.pravatar.cc/56",
        class: data.user?.level || ""
      };
    } catch (err) {}
    document.getElementById('userAvatar').src = user.profilePic;
    document.getElementById('userFullname').textContent = user.fullname;
    document.getElementById('userMeta').textContent = `Class: ${user.class} | Reg. No: ${user.regNo}`;
  }

  async function fetchQuestions() {
    if (!examInSession) { setFooterState(); return; }
    try {
      const params = new URLSearchParams({
        subject: exam.subject,
        year: exam.year,
        courseCode: exam.courseCode,
        count: config.count,
        topic: exam.topic
      });
      const resp = await fetch(`${API_BASE}/past-questions?${params.toString()}`, {
        headers: { Authorization: `Bearer ${token}` }
      });
      questions = await resp.json();
      if (!Array.isArray(questions) || questions.length === 0) {
        document.getElementById('examCard').innerHTML = "<div class='text-red-600 text-center py-10 text-lg font-bold'>No questions found for this course code and filter.</div>";
        examInSession = false;
        setFooterState();
        return;
      }
      answers = {};
      flags = {};
      currentQuestion = 0;
      renderQuestion();
      setFooterState();
    } catch (err) {
      document.getElementById('examCard').innerHTML = `<div class='text-red-600'>Failed to load questions: ${err.message}</div>`;
      examInSession = false;
      setFooterState();
    }
  }

  function updateTimer() {
    let h = String(Math.floor(timer / 3600)).padStart(2, '0');
    let m = String(Math.floor((timer % 3600) / 60)).padStart(2, '0');
    let s = String(timer % 60).padStart(2, '0');
    document.getElementById('timer').textContent = `${h}:${m}:${s}`;
    updateProgress();
  }

  function renderQuestion() {
    if (!questions.length) return;
    const q = questions[currentQuestion];
    document.getElementById("questionNumberTitle").textContent = `Q ${currentQuestion+1}/${questions.length}`;
    document.getElementById("statusBadge").textContent = answers[q._id] ? "Answered" : "Not Answered";
    document.getElementById("statusBadge").className = `px-2 py-0.5 text-xs rounded ${answers[q._id] ? "bg-green-100 text-green-700" : "bg-gray-100 text-gray-600"}`;
    document.getElementById("displayCourseCode").textContent = exam.courseCode;
    const imgWrap = document.getElementById("questionImageContainer");
    const imgEl = document.getElementById("questionImage");
    if (q.image) {
      imgWrap.style.display = "block";
      imgEl.src = q.image.startsWith("/") ? q.image : `/uploads/questions/${q.image}`;
    } else {
      imgWrap.style.display = "none";
      imgEl.src = "";
    }
    document.getElementById("questionText").innerHTML = q.text || q.question || "";
    const form = document.getElementById("optionsForm");
    form.innerHTML = "";
    (q.options || q.choices || []).forEach((opt, idx) => {
      const label = document.createElement("label");
      label.className = "flex items-center p-3 rounded-xl border-2 border-gray-200 bg-blue-50/20 hover:border-blue-400 cursor-pointer gap-3 transition focus-ring";
      label.setAttribute("tabindex", "0");
      label.setAttribute("for", `option_${idx}`);
      label.onkeydown = e => { if (e.key === "Enter" || e.key === " ") { selectOption(idx); e.preventDefault(); }};
      if (answers[q._id] === opt) label.classList.add("option-selected");
      const inp = document.createElement("input");
      inp.type = "radio";
      inp.name = "option";
      inp.id = `option_${idx}`;
      inp.value = opt;
      inp.disabled = false;
      inp.checked = answers[q._id] === opt;
      inp.className = "form-radio text-blue-600";
      inp.setAttribute("aria-checked", answers[q._id] === opt ? "true" : "false");
      inp.setAttribute("tabindex", "-1");
      inp.onclick = () => selectOption(idx);
      label.appendChild(inp);
      const spanLetter = document.createElement("span");
      spanLetter.className = "font-medium";
      spanLetter.innerHTML = String.fromCharCode(65 + idx) + ".";
      label.appendChild(spanLetter);
      const optText = document.createElement("span");
      optText.className = "mathjax";
      optText.innerHTML = opt;
      label.appendChild(optText);
      form.appendChild(label);
    });
    const flagBtn = document.getElementById("flagBtn");
    if (flags[q._id]) {
      flagBtn.classList.add("bg-yellow-300","border-yellow-500","text-yellow-900");
      flagBtn.setAttribute("aria-pressed", "true");
      flagBtn.innerHTML = '<svg class="w-4 h-4 inline" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M4 4v16M4 4h16l-2.5 5 2.5 5H4" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg> Flagged';
    } else {
      flagBtn.classList.remove("bg-yellow-300","border-yellow-500","text-yellow-900");
      flagBtn.setAttribute("aria-pressed", "false");
      flagBtn.innerHTML = '<svg class="w-4 h-4 inline" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M4 4v16M4 4h16l-2.5 5 2.5 5H4" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg> Flag';
    }
    updateQuestionNavGrid();
    updateProgress();
    if (window.MathJax) MathJax.typesetPromise();
    clearTimeout(autosaveTimeout);
    autosaveTimeout = setTimeout(saveProgress, 7000);
    setFooterState();
  }

  function updateQuestionNavGrid() {
    const grid = document.getElementById("questionNavGrid");
    grid.innerHTML = "";
    questions.forEach((q, i) => {
      const btn = document.createElement("button");
      btn.type = "button";
      btn.className = "w-9 h-9 rounded-full border-2 text-sm font-bold focus-ring transition";
      btn.textContent = i + 1;
      btn.setAttribute("aria-label", `Go to question ${i + 1}`);
      btn.disabled = !examInSession || submitted;
      btn.onclick = () => goToQuestion(i);
      if (i === currentQuestion) {
        btn.classList.add("bg-blue-600","text-white","border-blue-400");
        btn.setAttribute("aria-current", "true");
      } else if (flags[q._id]) {
        btn.classList.add("bg-yellow-50","text-yellow-700","border-yellow-400");
      } else if (answers[q._id]) {
        btn.classList.add("bg-green-600","text-white","border-green-400");
      } else {
        btn.classList.add("bg-gray-100","text-gray-500","border-gray-300");
      }
      grid.appendChild(btn);
    });
  }

  function updateProgress() {
    let answeredCount = Object.keys(answers).filter(k=>answers[k]).length;
    document.getElementById('answeredCount').textContent = answeredCount;
    document.getElementById('totalQuestions').textContent = questions.length;
    document.getElementById('progressBar').style.width = `${100*answeredCount/questions.length}%`;
  }

  function selectOption(idx) {
    const q = questions[currentQuestion];
    let opts = q.options || q.choices || [];
    answers[q._id] = opts[idx];
    renderQuestion();
    saveProgress();
  }

  function flagQuestion() {
    const q = questions[currentQuestion];
    flags[q._id] = !flags[q._id];
    renderQuestion();
    saveProgress();
  }

  function prevQuestion() {
    if (!examInSession) return;
    if (currentQuestion > 0) {
      currentQuestion--;
      renderQuestion();
    }
  }

  function nextQuestion() {
    if (!examInSession) return;
    if (currentQuestion < questions.length - 1) {
      currentQuestion++;
      renderQuestion();
    }
  }

  function goToQuestion(idx) {
    if (!examInSession) return;
    currentQuestion = idx;
    renderQuestion();
  }

  function skipQuestion() {
    if (!examInSession) return;
    nextQuestion();
  }

  async function saveProgress() {
    if (!examInSession) return;
    document.getElementById('autoSave').textContent = "Saving...";
    try {
      const answersArray = questions.map(q => ({
        questionId: q._id,
        answer: answers[q._id] || null
      }));
      await fetch(ANSWER_API, {
        method: "POST",
        headers: { "Content-Type": "application/json", Authorization: `Bearer ${token}` },
        body: JSON.stringify({
          userId: user.regNo || user._id || "",
          username: user.fullname,
          answers: answersArray,
          correctChoices: {},
          wrongChoices: {},
          totalCorrect: 0,
          totalWrong: 0,
          timeSpent: exam.duration - timer
        })
      });
      document.getElementById('autoSave').textContent = "Auto-saved";
    } catch (e) {
      document.getElementById('autoSave').textContent = "Save failed";
    }
  }

  async function saveAnswer() {
    if (!examInSession) return;
    await saveProgress();
    nextQuestion();
  }

  async function submitExam() {
    if (!examInSession || submitted) return;
    if (!confirm('Submit exam?')) return;
    clearInterval(timerInterval);
    document.getElementById("submitBtn").disabled = true;
    try {
      const answersArray = questions.map(q => ({
        questionId: q._id,
        answer: answers[q._id] || null
      }));
      const payload = {
        userId: user.regNo || user._id || "",
        username: user.fullname,
        answers: answersArray,
        questionIds: questions.map(q=>q._id),
        timeSpent: exam.duration - timer
      };
      const resp = await fetch(SUBMIT_API, {
        method: "POST",
        headers: { "Content-Type": "application/json", Authorization: `Bearer ${token}` },
        body: JSON.stringify(payload)
      });
      const result = await resp.json();
      // Save user answers, correct/wrong choices, time spent to backend for tracking
      await fetch(ANSWER_API, {
        method: 'POST',
        headers: {'Content-Type': 'application/json', 'Authorization': 'Bearer ' + token},
        body: JSON.stringify({
          userId: user.regNo || user._id || "",
          username: user.fullname,
          answers: answersArray,
          correctChoices: result.correctChoices || {},
          wrongChoices: result.wrongChoices || {},
          totalCorrect: result.score,
          totalWrong: (answersArray.length - result.score),
          timeSpent: exam.duration - timer
        })
      });
      submitted = true;
      showFeedback(result);
      setFooterState();
    } catch (e) {
      document.getElementById("examCard").innerHTML = "<div class='text-red-600 text-center py-16 text-xl'>Error submitting exam.</div>";
    }
  }

  function showFeedback(result) {
    // Hide exam card, show feedback section
    document.getElementById("examCard").style.display = "none";
    const box = document.getElementById("feedbackBox");
    box.style.display = "";
    let percent = Math.round((result.score / (result.total || 1)) * 100);
    let badge = percent >= 70
      ? `<span class="feedback-badge feedback-success">Great job! ðŸŽ‰</span>`
      : `<span class="feedback-badge feedback-fail">Keep Practicing!</span>`;
    let feedbackList = (result.feedback||[]).length
      ? `<div class="feedback-title">Review:</div><ul class="feedback-list list-disc">${result.feedback.map(f=>`<li>${f}</li>`).join('')}</ul>`
      : "";
    box.innerHTML = `
      <div class="feedback-outer">
        <div class="feedback-title">Session Completed</div>
        <div class="feedback-score">${result.score} / ${result.total}</div>
        <div class="font-semibold text-indigo-600 mb-2">Your Score</div>
        ${badge}
        ${feedbackList}
        <button onclick="window.location.reload()" class="mt-4 px-6 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 font-semibold">Retake Practice</button>
      </div>
    `;
  }

  // Keyboard navigation
  document.addEventListener('keydown', function(e) {
    if (e.target.matches('input,textarea')) return;
    if (!examInSession) return;
    if (e.key === "p" || e.key === "P") prevQuestion();
    if (e.key === "x" || e.key === "X") nextQuestion();
    if (e.key === "n" || e.key === "N") saveAnswer();
    if (e.key === "k" || e.key === "K") skipQuestion();
  });
  </script>
</body>
</html>
