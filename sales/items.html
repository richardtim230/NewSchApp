<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Product • Marketplace</title>
  <meta name="description" content="Product details, seller info, reviews and related items.">
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/flowbite/2.5.1/flowbite.min.css" rel="stylesheet" />
  <style>
    /* Small utility polishing */
    .thumbnail-ring { transition: transform .15s ease; }
    .thumbnail-ring:hover { transform: translateY(-3px); }
    .sticky-action { top: 96px; } /* below header */
    .clamp-4 { display: -webkit-box; -webkit-line-clamp: 4; -webkit-box-orient: vertical; overflow: hidden; }
  </style>
</head>
<body class="bg-gray-50 text-gray-900 antialiased">
  <!-- Header -->
  <header class="bg-white border-b fixed inset-x-0 top-0 z-40">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="flex items-center justify-between h-16">
        <div class="flex items-center gap-6">
          <a href="/mart.html" class="flex items-center gap-2">
            <div class="h-9 w-9 bg-blue-600 rounded flex items-center justify-center text-white font-bold">M</div>
            <span class="text-lg font-bold text-slate-800">MarketPlace</span>
          </a>
          <nav class="hidden md:flex gap-4 text-sm text-gray-600">
            <a href="/mart.html" class="hover:text-blue-600">Home</a>
            <a href="/mart.html#products-section" class="hover:text-blue-600">Shop</a>
            <a href="/mart.html#popular" class="hover:text-blue-600">Categories</a>
          </nav>
        </div>
        <div class="flex items-center gap-3">
          <button id="shareBtn" class="hidden sm:inline-flex items-center gap-2 px-3 py-1.5 border rounded text-sm text-gray-700 hover:bg-gray-50">
            Share
          </button>
          <a id="account-btn" href="/login" class="px-3 py-1.5 bg-blue-600 text-white rounded text-sm hover:bg-blue-700">Sign In</a>
        </div>
      </div>
    </div>
  </header>

  <main class="pt-24 max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
    <div id="breadcrumb" class="text-sm text-gray-500 mb-4"></div>

    <section id="product-main" class="grid grid-cols-1 lg:grid-cols-12 gap-6 items-start">
      <!-- Gallery + Tabs -->
      <div class="lg:col-span-8 space-y-4">
        <div id="gallery" class="bg-white rounded-lg shadow-sm overflow-hidden">
          <div id="gallery-placeholder" class="h-[420px] md:h-[520px] flex items-center justify-center text-gray-400 bg-gray-100">
            Loading images...
          </div>
        </div>

        <div class="bg-white rounded-lg shadow-sm p-4">
          <div class="flex items-start justify-between gap-6">
            <div class="flex-1">
              <h1 id="product-title" class="text-2xl font-extrabold text-slate-800"></h1>
              <div id="product-submeta" class="mt-2 text-sm text-gray-500"></div>
            </div>
            <div class="hidden sm:flex items-center gap-3">
              <div id="product-rating" class="text-yellow-600 font-semibold"></div>
            </div>
          </div>

          <!-- Tabs -->
          <div class="mt-4">
            <div class="flowbite">
              <ul class="flex flex-wrap text-sm font-medium text-center" data-tabs-toggle="#product-tabs-content" role="tablist">
                <li role="presentation" class="mr-2">
                  <button id="tab-desc" class="inline-block p-2 rounded-t-lg border-b-2 border-transparent hover:text-blue-600" data-tabs-target="#tab-content-desc" type="button" role="tab" aria-controls="tab-content-desc" aria-selected="true">Description</button>
                </li>
                <li role="presentation" class="mr-2">
                  <button id="tab-specs" class="inline-block p-2 rounded-t-lg border-b-2 border-transparent hover:text-blue-600" data-tabs-target="#tab-content-specs" type="button" role="tab" aria-controls="tab-content-specs" aria-selected="false">Specifications</button>
                </li>
                <li role="presentation">
                  <button id="tab-reviews" class="inline-block p-2 rounded-t-lg border-b-2 border-transparent hover:text-blue-600" data-tabs-target="#tab-content-reviews" type="button" role="tab" aria-controls="tab-content-reviews" aria-selected="false">Reviews</button>
                </li>
              </ul>
              <div id="product-tabs-content" class="border-t pt-4">
                <div id="tab-content-desc" class="p-2" role="tabpanel" aria-labelledby="tab-desc">
                  <div id="product-description" class="text-sm text-gray-700"></div>
                </div>
                <div id="tab-content-specs" class="hidden p-2" role="tabpanel" aria-labelledby="tab-specs">
                  <ul id="product-specs" class="text-sm text-gray-700 space-y-2"></ul>
                </div>
                <div id="tab-content-reviews" class="hidden p-2" role="tabpanel" aria-labelledby="tab-reviews">
                  <div id="avg-rating" class="text-sm text-yellow-600 font-semibold mb-2"></div>
                  <div id="reviews-list" class="space-y-4 text-sm text-gray-700">
                    Loading reviews...
                  </div>

                  <div class="mt-4 p-4 bg-gray-50 border rounded">
                    <h4 class="font-semibold mb-2">Write a review</h4>
                    <form id="reviewForm" class="grid grid-cols-1 sm:grid-cols-6 gap-2 items-end">
                      <textarea id="reviewComment" rows="2" class="sm:col-span-4 border rounded px-3 py-2 text-sm" placeholder="Share your experience..."></textarea>
                      <select id="reviewRating" class="sm:col-span-1 border rounded px-2 py-2 text-sm">
                        <option value="5">5 — Excellent</option>
                        <option value="4">4 — Very good</option>
                        <option value="3">3 — Good</option>
                        <option value="2">2 — Fair</option>
                        <option value="1">1 — Poor</option>
                      </select>
                      <button id="submitReview" class="sm:col-span-1 px-3 py-2 bg-blue-600 text-white rounded text-sm">Submit</button>
                    </form>
                    <div id="reviewResponse" class="mt-2 text-sm text-green-600 hidden"></div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Action / Seller Card -->
<aside class="lg:col-span-4">
        <div class="sticky sticky-action top-24">
          <div class="bg-white rounded-lg shadow p-5">
            <div class="flex items-center justify-between">
              <div>
                <div id="product-price" class="text-2xl font-extrabold text-slate-800"></div>
                <div id="product-category" class="text-sm text-gray-500 mt-1"></div>
              </div>
              <div class="text-right">
                <div id="product-stock" class="text-sm"></div>
              </div>
            </div>

            <div class="mt-4 grid gap-2">
              <div class="flex items-center gap-2">
                <input id="cart-qty" type="number" min="1" value="1" class="w-20 border rounded px-3 py-2 text-sm" aria-label="Quantity">
                <button id="add-to-cart" class="flex-1 px-4 py-2 bg-green-600 text-white rounded-lg shadow hover:bg-green-700 transition">Add to Cart</button>
              </div>
              <button id="offer-btn" class="w-full px-4 py-2 bg-yellow-500 text-white rounded-lg hover:bg-yellow-600">Send Offer</button>
              <button id="message-seller" class="w-full px-4 py-2 border rounded-lg hover:bg-gray-50">Message Seller</button>
            </div>

            <div class="mt-4 border-t pt-4">
              <div class="flex items-center gap-3">
                <div id="seller-avatar" class="h-12 w-12 rounded-full bg-gray-100 flex items-center justify-center font-semibold text-gray-600">S</div>
                <div>
                  <div id="seller-name" class="font-semibold text-sm text-slate-800"></div>
                  <div id="seller-badges" class="text-xs text-gray-500 mt-1"></div>
                </div>
              </div>

              <div id="seller-contact" class="mt-3 text-sm text-gray-700"></div>
            </div>

            <div class="mt-4 text-xs text-gray-500">
              <div>Safe payment & verified sellers. Report suspicious listings.</div>
            </div>
          </div>

          <div class="mt-4 bg-white rounded-lg shadow p-4 text-sm">
            <h4 class="font-semibold">Seller Details</h4>
            <div id="seller-details" class="mt-2 text-gray-700 text-sm"></div>
          </div>

        </div>
      </aside>
    </section>

    <!-- Related -->
    <section class="mt-8">
      <h3 class="text-xl font-bold mb-4">Related products</h3>
      <div id="related-grid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
        <!-- related products injected here -->
      </div>
    </section>
  </main>

  <!-- Offer Modal -->
  <div id="offerModal" class="fixed inset-0 z-50 hidden items-center justify-center bg-black/50 p-4">
    <div class="bg-white rounded-lg shadow w-full max-w-lg">
      <div class="flex items-center justify-between px-4 py-3 border-b">
        <h4 class="font-semibold">Send Offer</h4>
        <button onclick="closeOffer()" class="text-gray-500 hover:text-gray-900">&times;</button>
      </div>
      <form id="offerFormModal" class="p-4 space-y-3">
        <input type="hidden" id="offerListingId" />
        <label class="text-xs text-gray-600">Your Offer (₦)</label>
        <input id="offerAmount" type="number" required class="w-full border rounded px-3 py-2 text-sm" />
        <label class="text-xs text-gray-600">Message</label>
        <textarea id="offerNote" rows="3" class="w-full border rounded px-3 py-2 text-sm"></textarea>
        <div id="offerBuyerInfo" class="text-xs text-gray-600"></div>
        <div class="flex gap-2 mt-2">
          <button type="submit" class="flex-1 px-3 py-2 bg-yellow-500 text-white rounded">Send</button>
          <button type="button" onclick="closeOffer()" class="flex-1 px-3 py-2 border rounded">Cancel</button>
        </div>
        <div id="offerResponse" class="text-sm text-green-600 hidden"></div>
      </form>
    </div>
  </div>

  <footer class="mt-12 text-center text-sm text-gray-500 pb-12">© 2025 Marketplace. All rights reserved.</footer>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/flowbite/2.5.1/flowbite.min.js"></script>
  <script>
    // Modern item page client script
// Designed to work with backend routes already present in your API.

(async function () {
  const API_BASE = "https://examguard-jmvj.onrender.com"; // relative to origin: uses same domain + CORS as configured on server

  // DOM helpers
  const $ = sel => document.querySelector(sel);
  const $$ = sel => Array.from(document.querySelectorAll(sel));
  const byId = id => document.getElementById(id);
  const formatDate = d => { try { return new Date(d).toLocaleString(); } catch { return d; } };

  // Parse query id
  const params = new URLSearchParams(window.location.search);
  const listingId = params.get('id');

  // caches
  let facultiesCache = [];
  let departmentsCache = [];
  let buyerProfile = null;

  function safeStr(v){ return v == null ? '' : String(v); }

  // fetch faculties & departments for readable names
  async function fetchFacultiesAndDepartments(){
    try {
      const [fRes, dRes] = await Promise.all([
        fetch(API_BASE + '/api/faculties'),
        fetch(API_BASE + '/api/departments')
      ]);
      if (fRes.ok) facultiesCache = await fRes.json();
      if (dRes.ok) departmentsCache = await dRes.json();
    } catch (e) { facultiesCache = []; departmentsCache = []; }
  }
  function getFacultyName(f){
    if (!f) return '';
    if (typeof f === 'object' && f.name) return f.name;
    const found = facultiesCache.find(x => String(x._id) === String(f));
    return found ? found.name : f;
  }
  function getDepartmentName(d){
    if (!d) return '';
    if (typeof d === 'object' && d.name) return d.name;
    const found = departmentsCache.find(x => String(x._id) === String(d));
    return found ? found.name : d;
  }

  // auth check
  async function checkAuth(){
    try {
      const token = localStorage.getItem('token');
      if (!token) throw new Error('no token');
      const res = await fetch(API_BASE + '/api/auth/me', { headers: { Authorization: 'Bearer ' + token }});
      if (!res.ok) throw new Error('not authed');
      const data = await res.json();
      buyerProfile = data.user || data;
      const btn = byId('account-btn');
      if(btn){ btn.textContent = "My Dashboard"; btn.href = "/dashboard"; }
      return true;
    } catch (e) {
      const btn = byId('account-btn');
      if(btn){ btn.textContent = "Sign In"; btn.href = "/login"; }
      buyerProfile = null;
      return false;
    }
  }

  // Fetch listing (tries a few endpoint shapes)
  async function fetchListingById(id){
    if(!id) return null;
    const tries = [
      `/api/blogger-dashboard/public/listings/${id}`,
      `/api/blogger-dashboard/public/listings?id=${id}`,
      `/api/blogger-dashboard/public/listings`
    ];
    for (const path of tries){
      try {
        const res = await fetch(API_BASE + path);
        if(!res.ok) continue;
        const data = await res.json();
        if (Array.isArray(data)) {
          const found = data.find(x => String(x._id) === String(id) || String(x.id) === String(id));
          if (found) return found;
          continue;
        } else if (data && (data._id || data.id)) {
          if (String(data._id) === String(id) || String(data.id) === String(id)) return data;
          if (data.listing) return data.listing;
        } else if (data && data.listings) {
          const found = data.listings.find(x => String(x._id) === String(id));
          if(found) return found;
        }
      } catch (e) { /* ignore and continue */ }
    }
    return null;
  }
  // --- Cart helpers ---
  
  async function fetchCart() {
    try {
      const res = await fetch(API_BASE + "/api/cart", { headers: { ...authHeader() } });
      if (!res.ok) return null;
      const data = await res.json();
      // backend might return { items: [...] } or an object; handle both
      if (Array.isArray(data)) return { items: data };
      if (data && Array.isArray(data.items)) return data;
      return { items: [] };
    } catch (e) {
      return { items: [] };
    }
  }

  async function updateCartBadge() {
    const badge = byId("cart-badge");
    if (!badge) return;
    const cart = await fetchCart();
    const count = cart?.items?.reduce((s, i) => s + (i.quantity || 0), 0) || 0;
    if (count > 0) {
      badge.textContent = count;
      badge.classList.remove("hidden");
    } else {
      badge.classList.add("hidden");
    }
  }

  async function addToCartAPI(productId, quantity = 1) {
    try {
      const res = await fetch(API_BASE + "/api/cart/add", {
        method: "POST",
        headers: { "Content-Type": "application/json", ...authHeader() },
        body: JSON.stringify({ productId, quantity })
      });
      return res;
    } catch (e) {
      throw e;
    }
  }

  // Fetch reviews
  async function fetchReviews(listingId){
    try {
      let r = await fetch(API_BASE + `/api/reviews?listingId=${listingId}`);
      if (r.ok) return await r.json();
      r = await fetch(API_BASE + `/api/reviews/listing/${listingId}`);
      if (r.ok) return await r.json();
    } catch(e){}
    return [];
  }

  // Render helpers
  function renderBreadcrumb(product){
    const bc = [];
    bc.push(`<a href="/mart.html" class="hover:underline">Home</a>`);
    if (product && product.category) bc.push(`<a href="/mart.html" class="hover:underline">${product.category}</a>`);
    if (product && product.title) bc.push(`<span class="text-gray-500">${product.title}</span>`);
    byId('breadcrumb').innerHTML = bc.join(' / ');
  }

  function renderGallery(images = [], title=''){
    const gallery = byId('gallery');
    if (!images || !images.length){
      gallery.innerHTML = `<div class="h-[420px] md:h-[520px] flex items-center justify-center text-gray-400 bg-gray-100">No images</div>`;
      return;
    }
    // build carousel + thumbnails
    const slides = images.map((src, idx) => `
      <div class="${idx===0 ? 'block' : 'hidden'} duration-700 ease-in-out" data-carousel-item>
        <img src="${src}" alt="${title}" class="w-full h-[420px] md:h-[520px] object-cover">
      </div>
    `).join('');

    const thumbs = images.map((src, idx) => `
      <button data-thumb-index="${idx}" class="thumbnail-ring border rounded overflow-hidden h-14 w-14 md:h-16 md:w-16 ${idx===0 ? 'ring-2 ring-blue-500' : ''}">
        <img src="${src}" alt="thumb ${idx+1}" class="w-full h-full object-cover">
      </button>
    `).join('');

    gallery.innerHTML = `
      <div id="item-carousel" class="relative" data-carousel="slide" data-carousel-interval="6000">
        <div class="relative h-[420px] md:h-[520px] overflow-hidden rounded">
          ${slides}
        </div>
        <div class="absolute z-30 flex -translate-x-1/2 bottom-4 left-1/2 space-x-3">
          ${images.map((_,i)=>`<button type="button" class="w-2 h-2 rounded-full bg-gray-300" data-carousel-slide-to="${i}"></button>`).join('')}
        </div>
        <button type="button" class="absolute top-0 left-0 z-30 flex items-center justify-center h-full px-3 cursor-pointer group" data-carousel-prev>
          <span class="inline-flex items-center justify-center w-10 h-10 rounded-full bg-white/30 group-hover:bg-white/50">
            <svg class="w-4 h-4 text-white" viewBox="0 0 6 10" fill="none" xmlns="http://www.w3.org/2000/svg"><path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 1 1 5l4 4"/></svg>
          </span>
        </button>
        <button type="button" class="absolute top-0 right-0 z-30 flex items-center justify-center h-full px-3 cursor-pointer group" data-carousel-next>
          <span class="inline-flex items-center justify-center w-10 h-10 rounded-full bg-white/30 group-hover:bg-white/50">
            <svg class="w-4 h-4 text-white" viewBox="0 0 6 10" fill="none" xmlns="http://www.w3.org/2000/svg"><path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m1 9 4-4-4-4"/></svg>
          </span>
        </button>
      </div>
      <div class="mt-3 flex gap-2">
        ${thumbs}
      </div>
    `;

    // hook thumbnail clicks to carousel controls (Flowbite handles main carousel; we'll simulate click on nav buttons)
    const thumbButtons = Array.from(thumbs.querySelectorAll("[data-thumb-index]"));
    thumbButtons.forEach((btn, idx) => {
      btn.classList.toggle("thumb-active", idx === 0);
      btn.addEventListener("click", (e) => {
        // swap main image
        mainImage.src = urls[idx];
        // set active style
        thumbButtons.forEach(t => t.classList.remove("thumb-active"));
        btn.classList.add("thumb-active");
      });
      // keyboard accessibility
      btn.addEventListener("keydown", (ev) => {
        if (ev.key === "Enter" || ev.key === " ") {
          ev.preventDefault();
          btn.click();
        }
      });
    });
    let startX = 0;
    mainImage.addEventListener("touchstart", e => startX = e.touches[0].clientX);
    mainImage.addEventListener("touchend", e => {
      const endX = e.changedTouches[0].clientX;
      const diff = endX - startX;
      if (Math.abs(diff) < 40) return;
      // find current index
      const currentIndex = urls.indexOf(mainImage.src);
      if (diff < 0 && currentIndex < urls.length - 1) { // swipe left -> next
        const next = currentIndex + 1;
        mainImage.src = urls[next];
        thumbButtons.forEach(t => t.classList.remove("thumb-active"));
        thumbButtons[next]?.classList.add("thumb-active");
      } else if (diff > 0 && currentIndex > 0) { // swipe right -> prev
        const prev = currentIndex - 1;
        mainImage.src = urls[prev];
        thumbButtons.forEach(t => t.classList.remove("thumb-active"));
        thumbButtons[prev]?.classList.add("thumb-active");
      }
    });
  }

  function renderProductMeta(product) {
    byId("product-title").textContent = safeStr(product.title || product.name || "");
    byId("product-price").textContent = safeStr(product.price != null ? product.price : (product.amount || ""));
    byId("product-category").textContent = safeStr(product.category || "");
    byId("product-stock").textContent = product.stock === 0 ? "Out of stock" : (product.stock && product.stock < 5 ? `Only ${product.stock} left` : "In stock");
    byId("product-rating").textContent = product.rating || (product.likes ? `⭐ ${product.likes}` : "");
    byId("product-submeta").textContent = product.summary || (product.posted ? `Posted: ${product.posted}` : "");
    byId("product-description").innerHTML = product.description ? `<div class="whitespace-pre-line">${product.description}</div>` : (product.summary || "");

    // specs
    const specs = [];
    ["condition","brand","model","sku","location","color","warranty"].forEach(k => {
      if (product[k]) specs.push(`<li><strong class="text-slate-700">${k.charAt(0).toUpperCase()+k.slice(1)}:</strong> ${product[k]}</li>`);
    });
    if (product.createdAt) specs.push(`<li><strong>Posted:</strong> ${formatDate(product.createdAt)}</li>`);
    byId("product-specs").innerHTML = specs.join("") || "<li>No additional specifications provided.</li>";

    // seller
    const seller = product.seller || product.author || product.authorName || {};
    const sellerName = seller.fullname || seller.name || seller.username || product.sellerName || "Seller";
    byId("seller-name").textContent = sellerName;
    byId("seller-avatar").textContent = sellerName.charAt(0).toUpperCase();
    const badges = [];
    if (seller.verified || product.sellerVerified) badges.push('<span class="inline-block bg-green-100 text-green-700 px-2 py-0.5 rounded text-xs">Verified</span>');
    if (product.condition && product.condition.toLowerCase().includes("new")) badges.push('<span class="inline-block bg-blue-100 text-blue-700 px-2 py-0.5 rounded text-xs">New</span>');
    byId("seller-badges").innerHTML = badges.join(" ");
    const contacts = [];
    if (seller.email) contacts.push(`<div><strong>Email:</strong> <a href="mailto:${seller.email}" class="text-blue-600">${seller.email}</a></div>`);
    if (seller.phone) contacts.push(`<div><strong>Phone:</strong> <a href="tel:${seller.phone}" class="text-blue-600">${seller.phone}</a></div>`);
    byId("seller-contact").innerHTML = contacts.join("") || `<div class="text-gray-500">Contact via Marketplace</div>`;

    // seller details panel
    const fac = getFacultyName(product.sellerFaculty || product.faculty || seller.faculty);
    const dept = getDepartmentName(product.sellerDepartment || product.department || seller.department);
    byId("seller-details").innerHTML = `
      <div class="font-medium">${sellerName}</div>
      <div class="text-xs text-gray-500">${fac ? fac + (dept ? ' • ' + dept : '') : ''}</div>
      ${seller.bio ? `<div class="mt-2 text-gray-700 text-sm">${seller.bio}</div>` : ""}
    `;

    // wire actions
    const qtyInput = byId("cart-qty");
    const addBtn = byId("add-to-cart");
    addBtn.onclick = async () => {
      const qty = Math.max(1, Number(qtyInput.value || 1));
      addBtn.disabled = true;
      addBtn.classList.add("opacity-70", "cursor-not-allowed");
      if (!buyerProfile) {
        addBtn.disabled = false;
        addBtn.classList.remove("opacity-70", "cursor-not-allowed");
        if (confirm("You must sign in to add items to cart. Sign in now?")) window.location.href = "/login";
        return;
      }
      try {
        const resp = await addToCartAPI(product._id || product.id || listingId, qty);
        if (resp.ok) {
          addBtn.textContent = "Added ✓";
          setTimeout(() => addBtn.textContent = "Add to Cart", 1400);
          await updateCartBadge();
        } else {
          const j = await resp.json().catch(()=>({}));
          alert(j.message || "Could not add to cart");
        }
      } catch (e) {
        alert("Network error. Try again later.");
      } finally {
        addBtn.disabled = false;
        addBtn.classList.remove("opacity-70", "cursor-not-allowed");
      }
    };

    byId("offerListingId")?.value = product._id || product.id || "";
    byId("offer-btn").onclick = () => openOfferModal(product);
    byId("message-seller").onclick = () => {
      if (seller.email) window.location.href = `mailto:${seller.email}?subject=Question about ${encodeURIComponent(product.title || product.name)}`;
      else alert("Seller contact not available.");
    };

    renderBreadcrumb(product);
  }


  async function renderReviews(listingIdVal){
    const listEl = byId('reviews-list');
    listEl.innerHTML = `<div class="text-gray-500">Loading reviews...</div>`;
    const data = await fetchReviews(listingIdVal);
    let reviews = [];
    if (Array.isArray(data)) reviews = data;
    else if (data && Array.isArray(data.reviews)) reviews = data.reviews;
    else if (data && Array.isArray(data.data)) reviews = data.data;
    else reviews = [];

    if (!reviews.length) {
      listEl.innerHTML = `<div class="text-gray-500">No reviews yet.</div>`;
      byId('avg-rating').textContent = '';
      return;
    }
    const avg = (reviews.reduce((s,r)=>s + (r.rating||0), 0) / reviews.length).toFixed(1);
    byId('avg-rating').textContent = `Avg: ${avg} • ${reviews.length} review(s)`;

    listEl.innerHTML = reviews.map(r => `
      <div class="p-3 border rounded bg-white">
        <div class="flex items-start gap-3">
          <div class="h-9 w-9 bg-gray-100 rounded-full flex items-center justify-center text-sm font-semibold text-gray-700">${(r.reviewerName||r.name||'U')[0]}</div>
          <div>
            <div class="text-sm font-semibold">${r.reviewerName || r.name || 'User'}</div>
            <div class="text-xs text-yellow-600">${'⭐'.repeat(Math.max(1, Math.round(r.rating||0)))} ${r.rating ? '('+r.rating+')' : ''}</div>
            <div class="mt-1 text-xs text-gray-600 whitespace-pre-line">${r.comment || r.message || ''}</div>
            <div class="text-xs text-gray-400 mt-2">${r.createdAt ? formatDate(r.createdAt) : ''}</div>
          </div>
        </div>
      </div>
    `).join('');
  }

  function renderRelated(items = [], currentId){
    const grid = byId('related-grid');
    if(!items || !items.length){
      grid.innerHTML = `<div class="col-span-2 text-gray-500">No related products found.</div>`;
      return;
    }
    grid.innerHTML = items.slice(0,8).map(p => `
      <a href="/sales/items.html?id=${p._id || p.id}" class="block bg-white border rounded-lg overflow-hidden hover:shadow">
        <div class="h-36 w-full overflow-hidden">
          <img src="${(p.imageUrl||p.img||(p.images && p.images[0])||'/assets/placeholder.png')}" class="w-full h-36 object-cover" alt="${p.title||p.name}">
        </div>
        <div class="p-2 text-xs">
          <div class="font-semibold text-sm text-blue-800 truncate">${p.title || p.name}</div>
          <div class="text-yellow-600 font-bold">${p.price || ''}</div>
          <div class="text-gray-500">${p.category || ''}</div>
        </div>
      </a>
    `).join('');
  }

  // Offer modal
  function openOfferModal(product){
    byId('offerListingId').value = product._id || product.id || '';
    byId('offerAmount').value = '';
    byId('offerNote').value = `Hi, I'm interested in "${product.title || product.name}". Is the price negotiable?`;
    const infoEl = byId('offerBuyerInfo');
    if (buyerProfile) {
      const faculty = getFacultyName(buyerProfile.faculty);
      const dept = getDepartmentName(buyerProfile.department);
      infoEl.innerHTML = `<div><strong>${buyerProfile.fullname || buyerProfile.username}</strong></div>
                          <div class="text-xs text-gray-600">${buyerProfile.email || ''}${buyerProfile.phone ? ' • ' + buyerProfile.phone : ''}</div>
                          <div class="text-xs text-gray-600">${faculty || ''}${dept ? ' • ' + dept : ''}</div>`;
    } else {
      infoEl.innerHTML = `<div class="text-xs text-red-600">Sign in to send offers and enable follow-up.</div>`;
    }
    byId('offerResponse').classList.add('hidden');
    document.getElementById('offerModal').classList.remove('hidden');
  }
  function closeOffer(){ document.getElementById('offerModal').classList.add('hidden'); }

  // Submit review
  async function submitReviewHandler(e){
    e.preventDefault();
    if(!listingId) return alert('Missing listing id.');
    const comment = byId('reviewComment').value.trim();
    const rating = Number(byId('reviewRating').value || 5);
    const token = localStorage.getItem('token');
    try {
      const res = await fetch(API_BASE + '/api/reviews', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', ...(token?{Authorization:'Bearer '+token}:{}) },
        body: JSON.stringify({ listingId, rating, comment })
      });
      if (res.ok) {
        byId('reviewResponse').classList.remove('hidden');
        byId('reviewResponse').textContent = 'Review submitted. Thank you!';
        byId('reviewComment').value = '';
        await renderReviews(listingId);
        setTimeout(()=> byId('reviewResponse').classList.add('hidden'), 2000);
      } else {
        const j = await res.json().catch(()=>({}));
        alert(j.message || 'Could not submit review.');
      }
    } catch(e){ alert('Network error'); }
  }

  // Submit offer
  async function submitOfferHandler(e){
    e.preventDefault();
    const listingIdVal = byId('offerListingId').value;
    const amount = byId('offerAmount').value;
    const note = byId('offerNote').value;
    if (!listingIdVal || !amount) return alert('Please provide an amount.');
    const token = localStorage.getItem('token');
    let buyer = null;
    if (buyerProfile) {
      buyer = {
        id: buyerProfile._id || buyerProfile.id,
        name: buyerProfile.fullname || buyerProfile.username,
        email: buyerProfile.email,
        phone: buyerProfile.phone,
        faculty: getFacultyName(buyerProfile.faculty),
        department: getDepartmentName(buyerProfile.department)
      };
    }
    try {
      const res = await fetch(API_BASE + '/api/offers', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', ...(token?{Authorization:'Bearer '+token}:{}) },
        body: JSON.stringify({ productId: listingIdVal, offerPrice: amount, message: note, buyer })
      });
      if (res.ok) {
        byId('offerResponse').classList.remove('hidden');
        byId('offerResponse').textContent = 'Offer sent — seller will be notified.';
        setTimeout(()=>{ closeOffer(); }, 1500);
      } else {
        const j = await res.json().catch(()=>({}));
        byId('offerResponse').classList.remove('hidden');
        byId('offerResponse').textContent = j.message || 'Could not send offer.';
      }
    } catch(e){
      byId('offerResponse').classList.remove('hidden');
      byId('offerResponse').textContent = 'Network error. Try again later.';
    }
  }

  // Initialization
  await fetchFacultiesAndDepartments();
  await checkAuth();

  if (!listingId) {
    const main = document.getElementById('product-main');
    if (main) main.innerHTML = `<div class="p-8 text-center text-gray-600">No product selected. Return to <a href="/mart.html" class="text-blue-600 underline">Marketplace</a>.</div>`;
    return;
  }

  const product = await fetchListingById(listingId);
  if (!product) {
    const main = document.getElementById('product-main');
    if (main) main.innerHTML = `<div class="p-8 text-center text-gray-600">Product not found or removed.</div>`;
    return;
  }

  // Normalize images
  let images = [];
  if (product.images && Array.isArray(product.images)) images = product.images;
  else if (product.imageUrl) images = [product.imageUrl];
  else if (product.img) images = [product.img];
  else images = [];

  renderGallery(images.length ? images : ['/assets/placeholder.png'], product.title || product.name);
  renderProductMeta(product);

  // fetch reviews and related
  renderReviews(listingId);

  // Fetch all listings to compute related items (category)
  try {
    const allRes = await fetch(API_BASE + '/api/blogger-dashboard/public/listings');
    if (allRes.ok) {
      const all = await allRes.json();
      let items = Array.isArray(all) ? all : (all.listings || all.data || []);
      const related = items.filter(x => (x._id || x.id) !== (product._id || product.id) && (product.category ? x.category === product.category : true));
      renderRelated(related, product._id || product.id);
    } else {
      renderRelated([], product._id || product.id);
    }
  } catch (e) {
    renderRelated([], product._id || product.id);
  }

  // Attach form handlers
  const reviewForm = byId('reviewForm');
  if (reviewForm) reviewForm.addEventListener('submit', submitReviewHandler);
  const offerForm = byId('offerFormModal');
  if (offerForm) offerForm.addEventListener('submit', submitOfferHandler);

  // Flowbite tabs initialization: ensure first tab selected on load
  // (Flowbite script included on page; fallback simple select)
  try {
    document.querySelector('[data-tabs-toggle] button').click();
  } catch(e){}
})();
  </script>
</body>
</html>
