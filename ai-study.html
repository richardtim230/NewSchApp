<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>AI Study Assistant | OAU ExamGuard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="icon" href="logo.png">
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
  <style>
    html, body {
      min-height: 100vh;
      background: linear-gradient(130deg, #f3f4f8 0%, #e0e7ff 100%);
    }
    body {
      font-family: 'Inter', Arial, sans-serif;
      color: #1e293b;
      font-size: 1.07rem;
    }
    .ai-card {
      max-width: 540px;
      margin: 38px auto 34px auto;
      background: #fff;
      border-radius: 1.3em;
      box-shadow: 0 6px 40px #2563eb10, 0 1.2px 7px #3b82f110;
      padding: 2.1em 2.2em 2.5em 2.2em;
      position: relative;
    }
    @media (max-width:700px){
      .ai-card {padding: 1.15em 2vw 1.4em 2vw;}
    }
    .ai-h1{
      font-size: 2.3em;
      font-weight: 900;
      color: #1e293b;
      text-align: center;
      letter-spacing: -.02em;
      margin-bottom: 0.38em;
    }
    .ai-subtext{
      color:#6366f1;
      text-align:center;
      font-weight:500;
      font-size:1.1em;
      margin-bottom: 0.7em;
    }
    .ai-section-label {
      color:#312e81;
      font-size:1.13em;
      margin-bottom:5px;
      font-weight: 700;
      letter-spacing:-.01em;
    }
    .ai-form-group { margin-bottom: 1.2em; }
    .ai-form-radio-row {display:flex;gap:1.1em;margin-bottom:15px;}
    .ai-form-radio-row label {
      display: flex; gap: 6px; align-items: center;
      padding: 4.5px 13px 4.5px 7px;
      font-weight: 500;
      border-radius: 8px;
      color:#312e81;
      background: #f4f6fd;
      transition: background 0.2s;
      cursor: pointer;
      font-size:0.86em;
    }
    .ai-form-radio-row input { accent-color: #6366f1; }
    .ai-form-radio-row label.selected, .ai-form-radio-row label:hover {
      background: #e0e7ff;
      color: #3b82f6;
    }
    .ai-inp, .ai-area {
      border: 1.65px solid #e0e7ff;
      border-radius: 0.8em;
      font-size: 1.11em;
      padding: 10px 16px;
      color: #23254a;
      background: #f7f8fc;
      transition: border 0.17s, background 0.14s;
      outline: none;
    }
    .ai-inp:focus, .ai-area:focus { border: 1.65px solid #6366f1; background:#fff; }
    .ai-inp[readonly] { color:#64748b;background:#f4f6fd;}
    .ai-area {
      resize: vertical;
      min-height: 90px;
      max-height: 300px;
      width: 100%;
    }
    .ai-btn, .ai-btn-secondary {
      border: none;
      border-radius: 8px;
      font-size: 1.06em;
      font-weight: 700;
      cursor: pointer;
      transition: background .19s, color .14s, box-shadow .12s;
      padding: 11.5px 32px;
      margin-top: 3px;
    }
    .ai-btn {
      background: linear-gradient(91deg, #4338ca 70%, #22d3ee 100%);
      color: #fff;
      box-shadow: 0 2.5px 10px #6366f125;
    }
    .ai-btn:hover { background: linear-gradient(90deg,#fbbf24 0%,#6366f1 100%); color:#fff; }
    .ai-btn-secondary {
      background: #e0e7ff;
      color: #6366f1;
      margin-left:6px;
    }
    .ai-btn-secondary:hover { background:#6366f1;color:#fff; }
    .ai-btn-link {
      background: #f4f6fd;
      color: #2563eb;
      border: none;
      padding: 11.5px 22px;
      border-radius: 8px;
      font-weight: bold;
      margin-left:auto;
      font-size: 1em;
      display: inline-block;
      transition: background 0.15s,color 0.11s;
    }
    .ai-btn-link:hover {background:#6366f1;color:#fff;}
    .ai-spinner {
      border: 3px solid #e0e7ff;
      border-top: 3px solid #6366f1;
      border-radius: 50%;
      width: 30px;
      height: 30px;
      animation: spin 0.89s linear infinite;
      display: inline-block;
      vertical-align: middle;
      margin-right: 10px;
    }
    @keyframes spin { to { transform: rotate(360deg);} }
    .ai-output-wrap {
      background: #f8fafc;
      border-radius: 1.1em;
      padding: 1.4em 1.2em 1.1em 1.2em;
      margin-bottom:.2em;
      margin-top:1.08em;
      box-shadow: 0 1.5px 10px #6366f110;
    }
    .ai-output-box-label {
      color:#6366f1;
      font-size:.98em;
      margin-bottom:0.5em;
      font-weight:700;
      display:flex;align-items:center;gap:9px;
    }
    .ai-tarea {
      width: 100%;
      border: 1.5px solid #e0e7ff;
      border-radius: 8px;
      background:#f4f6fd;
      color: #312e81;
      padding: 12px 11px;
      font-family: 'Menlo', 'Roboto Mono', 'Consolas', monospace;
      min-height: 88px; max-height: 300px;
      resize: vertical;
    }
    .ai-note-action-row { display:flex;gap:13px;margin-top:14px;}
    .ai-saved-notes-hdr {
      font-size:1.23em;
      color:#374151;
      font-weight: bold;
      display:flex;align-items:center;gap:11px;
      margin-top:2.3em;margin-bottom:.7em;
    }
    .ai-save-clear-btn{
      font-size:.97em;
      color:#ef4444;
      background:#fee2e2;
      border-radius:7px;padding:5.5px 12px;
      border:none;transition:.13s; margin-left:auto;
    }
    .ai-save-clear-btn:hover{background:#fecaca;}
    .ai-note-card{
      border-radius:1.06em;
      background: linear-gradient(105deg, #dcfce7 0%, #f3f4f8 100%);
      box-shadow:0 2.5px 22px #2563eb12;
      margin-bottom:1.22em;
      padding:1.15em 1.3em 1.1em 1.3em;
      border:1.3px solid #e0e7ff;
      color:#065f46;
      position:relative;
    }
    .ai-note-title{font-weight:700;font-size:1.09em;margin-bottom:.35em;}
    .ai-note-date{font-size:.97em;color:#059669;margin-bottom:.6em;}
    .ai-note-content{background:#fff;border-radius:7px;padding:.55em .83em;margin-bottom:.8em;color:#065f46;font-size:1em;}
    .ai-note-actions{display:flex;gap:9px;}
    .ai-note-btn {
      background:#e0e7ff;color:#6366f1;font-weight:700;
      border-radius:6px;padding:7px 15px;font-size:.97em;
      border:none;transition:background .14s,color .14s;
      cursor:pointer;
    }
    .ai-note-btn:hover {background:#6366f1;color:#fff;}
    @media (max-width:600px){.ai-card{padding:8vw 2vw;}.ai-h1{font-size:1.39em;}}
  </style>
</head>
<body>
  <div class="ai-card">
    <div class="flex flex-col items-center mb-5">
      <img src="logo.png" alt="Logo" class="w-14 h-14 rounded-full mb-1 shadow-md">
      <div class="ai-h1">AI Study Assistant</div>
      <div class="ai-subtext">Generate high-quality lecture notes or tricky exam questions!<br><span style="font-size:.96em;">Powered by Gemini AI</span></div>
    </div>
    <form id="aiStudyForm" class="mb-4" autocomplete="off">
      <div class="ai-form-group">
        <div class="ai-section-label mb-1">What would you like to generate?</div>
        <div class="ai-form-radio-row" id="rtype-row">
          <label class="selected">
            <input type="radio" name="outputType" value="lecture" checked>
            Lecture Note
          </label>
          <label>
            <input type="radio" name="outputType" value="questions">
            Exam Questions
          </label>
          <label>
            <input type="radio" name="outputType" value="convert">
            Convert Questions
          </label>
        </div>
      </div>
      <div class="ai-form-group">
        <div class="ai-section-label">Topic <span class="text-red-400">*</span></div>
        <input type="text" id="aiTopic" class="ai-inp w-full" placeholder="e.g. Cell Biology, Taxation, Calculus" required>
      </div>
      <!-- Questions extra config -->
      <div class="ai-form-group" id="questionFields" style="display:none;">
        <div class="mb-1 flex flex-wrap gap-2 items-center">
          <input type="number" id="questionNumber" class="ai-inp w-16" min="1" max="100" value="10" required>
          <span class="font-medium ml-1">Number of Questions</span>
        </div>
        <input type="text" id="faculty" class="ai-inp w-full mb-2" placeholder="Faculty (e.g. Science)" required>
        <input type="text" id="department" class="ai-inp w-full" placeholder="Department (e.g. Zoology)" required>
      </div>
      <!-- Convert config -->
      <div class="ai-form-group" id="convertFields" style="display:none;">
        <div class="ai-section-label">Paste or type questions to convert</div>
        <textarea id="convertText" class="ai-area" placeholder="Paste questions to convert..."></textarea>
      </div>
      <div class="flex flex-wrap gap-3 mt-1 mb-3">
        <button type="submit" class="ai-btn flex items-center"><i class="bi bi-magic"></i><span class="ml-2">Generate</span></button>
        <button type="button" class="ai-btn-secondary" onclick="location.reload();"><i class="bi bi-arrow-clockwise"></i> Reset</button>
        <a href="saved-lectures.html" class="ai-btn-link ml-auto"><i class="fa fa-book mr-2"></i>Saved Lectures</a>
      </div>
      <div id="aiMsg" class="mt-1 font-bold"></div>
      <div id="aiOutputBox" style="display:none;">
        <div class="ai-output-wrap">
          <div class="ai-output-box-label">AI Output
            <button class="ml-2 px-2 py-1 text-xs bg-blue-100 text-blue-700 rounded font-semibold"
              onclick="copyAIOutput()">Copy</button>
          </div>
          <textarea id="aiOutput" class="ai-tarea" rows="12" readonly></textarea>
        </div>
        <div class="ai-note-action-row">
          <button type="button" class="ai-btn" onclick="saveAINote()">Save</button>
          <button type="button" class="ai-btn-secondary" onclick="downloadAINote()">Download</button>
        </div>
      </div>
    </form>
    <div class="ai-saved-notes-hdr"><i class="bi bi-journal-check"></i> Saved AI Notes
      <button class="ai-save-clear-btn" onclick="clearSavedNotes()" title="Delete All">Clear All</button>
    </div>
    <div id="savedNotesList"></div>
    <div id="noNotes" class="text-gray-400 text-center mt-6">No notes saved yet. Generate and <b>Save</b> a note above.</div>
  </div>
  <script>
    // Radio selection highlight
    document.querySelectorAll('.ai-form-radio-row label').forEach(lab=>{
      lab.onclick=()=>{document.querySelectorAll('.ai-form-radio-row label').forEach(l=>l.classList.remove('selected'));lab.classList.add('selected');updateFields();};
    });
    function updateFields() {
      const val = document.querySelector('input[name="outputType"]:checked').value;
      document.getElementById('questionFields').style.display = val==="questions" ? "" : "none";
      document.getElementById('convertFields').style.display = val==="convert" ? "" : "none";
      if(val==="questions") {
        document.getElementById('questionNumber').required = true;
        document.getElementById('faculty').required = true;
        document.getElementById('department').required = true;
      } else {
        document.getElementById('questionNumber').required = false;
        document.getElementById('faculty').required = false;
        document.getElementById('department').required = false;
      }
      if(val==="convert") {
        document.getElementById('convertText').required = true;
      } else {
        document.getElementById('convertText').required = false;
      }
    }
    updateFields();

    // API endpoints
    const BACKEND_BASE = "https://examguard-jmvj.onrender.com";
    const LECTURE_API = BACKEND_BASE + "/api/ai-lecture";
    const Q_API = BACKEND_BASE + "/api/ai-questions";

    // Form submission
    document.getElementById('aiStudyForm').onsubmit = async function(e) {
      e.preventDefault();
      const type = document.querySelector('input[name="outputType"]:checked').value;
      const topic = document.getElementById('aiTopic').value.trim();
      if(type === 'lecture') {
        if(!topic) {
          document.getElementById('aiMsg').innerText = "Topic is required!";
          return;
        }
        window.location.href = "ai-lecture.html?topic=" + encodeURIComponent(topic);
        return;
      }
      document.getElementById('aiMsg').innerHTML = `<span class="ai-spinner"></span>Generating... Please wait...`;
      document.getElementById('aiOutputBox').style.display = 'none';
      let route = Q_API;
      let postData = {};
      if(type === 'questions') {
        postData = {
          type: 'generate',
          topic: topic,
          number: parseInt(document.getElementById('questionNumber').value),
          faculty: (document.getElementById('faculty').value||"").trim(),
          department: (document.getElementById('department').value||"").trim()
        };
        if (!postData.faculty || !postData.department) {
          document.getElementById('aiMsg').innerText = "Faculty and Department are required!";
          return;
        }
      } else if(type === 'convert') {
        postData = {
          type: 'convert',
          text: document.getElementById('convertText').value.trim()
        };
        if (!postData.text) {
          document.getElementById('aiMsg').innerText = "Paste the questions to convert!";
          return;
        }
      }
      try {
        const resp = await fetch(route, {
          method: "POST",
          headers: { "Content-Type": "application/json", "Authorization": "Bearer "+(localStorage.getItem("token")||"") },
          body: JSON.stringify(postData)
        });
        if (!resp.ok) {
          let txt = await resp.text();
          document.getElementById('aiMsg').innerHTML = `<span style="color:#dc2626;font-weight:600;">Failed: ${txt || 'Something went wrong.'}</span>`;
          return;
        }
        const outputText = await resp.text();
        document.getElementById('aiOutput').value = outputText.trim();
        document.getElementById('aiMsg').innerHTML = `<span style="color:#22c55e;font-weight:600;">Done!</span>`;
        document.getElementById('aiOutputBox').style.display = '';
      } catch(e) {
        document.getElementById('aiMsg').innerHTML = `<span style="color:#dc2626;font-weight:600;">Network or server error. Try again.</span>`;
      }
    }

    function copyAIOutput() {
      const output = document.getElementById('aiOutput');
      output.select();
      document.execCommand('copy');
    }

    function saveAINote() {
      const topic = document.getElementById('aiTopic').value.trim();
      const output = document.getElementById('aiOutput').value.trim();
      if(!output) return alert("Nothing to save.");
      let notes = JSON.parse(localStorage.getItem('aiStudyNotes')||'[]');
      const ts = new Date().toISOString();
      notes.unshift({topic, content:output, ts});
      if (notes.length>30) notes = notes.slice(0,30);
      localStorage.setItem('aiStudyNotes',JSON.stringify(notes));
      alert("Saved!");
      renderSavedNotes();
    }
    function renderSavedNotes() {
      let notes = [];
      try { notes = JSON.parse(localStorage.getItem('aiStudyNotes')||'[]'); } catch{ notes=[]; }
      const list = document.getElementById('savedNotesList');
      if (!notes.length) {
        list.innerHTML = "";
        document.getElementById('noNotes').style.display='';
        return;
      }
      document.getElementById('noNotes').style.display='none';
      list.innerHTML = notes.map((n,i)=>`
        <div class="ai-note-card">
          <div class="ai-note-title"><i class="bi bi-clipboard"></i> ${escapeHtml(n.topic||"Untitled")}</div>
          <div class="ai-note-date">${new Date(n.ts).toLocaleString()}</div>
          <textarea class="ai-note-content w-full border-none" readonly rows="5">${escapeHtml(n.content)}</textarea>
          <div class="ai-note-actions">
            <button class="ai-note-btn" onclick="downloadNote(${i})"><i class="bi bi-download"></i> Download</button>
            <button class="ai-note-btn" onclick="deleteNote(${i})" style="background:#fee2e2;color:#d10c0c;"><i class="bi bi-trash"></i> Delete</button>
          </div>
        </div>
      `).join('');
    }
    function deleteNote(idx) {
      let notes = JSON.parse(localStorage.getItem('aiStudyNotes')||'[]');
      notes.splice(idx,1);
      localStorage.setItem('aiStudyNotes',JSON.stringify(notes));
      renderSavedNotes();
    }
    function downloadNote(idx) {
      let notes = JSON.parse(localStorage.getItem('aiStudyNotes')||'[]');
      const n = notes[idx];
      const blob = new Blob([n.content], {type:"application/json"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = escapeFilename((n.topic||'AI-Note')+'.json');
      document.body.appendChild(a);
      a.click(); setTimeout(()=>{URL.revokeObjectURL(url);a.remove();},50);
    }
    function downloadAINote() {
      const topic = document.getElementById('aiTopic').value.trim();
      const output = document.getElementById('aiOutput').value.trim();
      const blob = new Blob([output], {type:"application/json"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = escapeFilename((topic||'AI-Note')+'.json');
      document.body.appendChild(a);
      a.click();
      setTimeout(()=>{URL.revokeObjectURL(url);a.remove();},50);
    }
    function clearSavedNotes() {
      if(confirm("This will delete ALL saved AI notes. Continue?")) {
        localStorage.removeItem('aiStudyNotes');
        renderSavedNotes();
      }
    }
    function escapeHtml(str) {
      return (str||"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g, "&quot;").replace(/'/g,"&#39;");
    }
    function escapeFilename(name) {
      return (name||"").replace(/[\/\\?%*:|"<>]/g,'_');
    }
    // On load
    renderSavedNotes();
  </script>
</body>
</html>
